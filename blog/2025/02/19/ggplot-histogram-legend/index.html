<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Hong T.M. Chu">
<meta name="description" content="Land isn’t unemployed—people are. Here’s how to use R, {ggplot2}, {sf}, and {patchwork} to create a histogram legend in a choropleth map to better see the distribution of values.">
<title>How to use a histogram as a legend in {ggplot2} | Hong T.M. Chu – Hong T.M. Chu</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../../../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../../../">
<link href="../../../../..//files/favicon-512.png" rel="icon" type="image/png">
<script src="../../../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../../../site_libs/quarto-html/quarto-syntax-highlighting-17c909d5fd25ae21b861c0c7a49b2096.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../../../site_libs/bootstrap/bootstrap-5cd0811f461c8271ae6bab49df9501be.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<link href="../../../../../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../../../../../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<script src="../../../../../site_libs/quarto-contrib/iconify-2.0.0/iconify-icon.min.js"></script>
<script src="../../../../../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../../../../../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../../../../../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script type="text/javascript">

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-527449-5', 'auto');

ga('send', {
  hitType: 'pageview',
  'anonymizeIp': true,
});
</script><style>

      .quarto-title-block .quarto-title-banner {
        background: #170C3A;
      }
</style>
<meta property="og:title" content="How to use a histogram as a legend in {ggplot2} | Hong T.M. Chu">
<meta property="og:description" content="Land isn’t unemployed—people are. Here’s how to use R, {ggplot2}, {sf}, and {patchwork} to create a histogram legend in a choropleth map to better see the distribution of values.">
<meta property="og:image" content="https://www.andrewheiss.com/blog/2025/02/19/ggplot-histogram-legend/index_files/figure-html/plot-histogram-legend-1.png">
<meta property="og:site_name" content="Hong T.M. Chu">
<meta property="og:locale" content="en_US">
<meta property="og:image:height" content="1440">
<meta property="og:image:width" content="2016">
<meta name="twitter:title" content="How to use a histogram as a legend in {ggplot2} | Hong T.M. Chu">
<meta name="twitter:description" content="Land isn’t unemployed—people are. Here’s how to use R, {ggplot2}, {sf}, and {patchwork} to create a histogram legend in a choropleth map to better see the distribution of values.">
<meta name="twitter:image" content="https://www.andrewheiss.com/blog/2025/02/19/ggplot-histogram-legend/index_files/figure-html/plot-histogram-legend-1.png">
<meta name="twitter:creator" content="@andrewheiss">
<meta name="twitter:site" content="@andrewheiss">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image-height" content="1440">
<meta name="twitter:image-width" content="2016">
</head>
<body class="floating nav-fixed slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../../../index.html">
    <span class="navbar-title">Hong T.M. Chu</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link" href="../../../../../index.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../cv/index.html"> 
<span class="menu-text">CV</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../research/index.html"> 
<span class="menu-text">Research</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../teaching/index.html"> 
<span class="menu-text">Teaching</span></a>
  </li>  
</ul>
<ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item">
    <a class="nav-link" href="mailto:hong.ctm@vinuni.edu.vn"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:envelope" style="font-size: 1.1em;" aria-label="Icon envelope from bi Iconify.design set." title="E-mail"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/andrewheiss" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:github" style="font-size: 1.1em;" aria-label="Icon github from bi Iconify.design set." title="GitHub"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.linkedin.com/in/hongtmchu" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:linkedin" style="font-size: 1.1em;" aria-label="Icon linkedin from bi Iconify.design set." title="LinkedIn"></iconify-icon></span></a>
  </li>  
</ul>
</div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><header id="title-block-header" class="quarto-title-block default blog-post page-columns page-full"><div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">How to use a histogram as a legend in {ggplot2}</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
                  <div>
        <div class="description">
          Land isn’t unemployed—people are. Here’s how to use R, {ggplot2}, {sf}, and {patchwork} to create a histogram legend in a choropleth map to better see the distribution of values.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">r</div>
                <div class="quarto-category">tidyverse</div>
                <div class="quarto-category">ggplot</div>
                <div class="quarto-category">gis</div>
                <div class="quarto-category">maps</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p><a href="https://www.andrewheiss.com/">Andrew Heiss</a> <a href="https://orcid.org/0000-0002-3948-3914" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">Wednesday, February 19, 2025</p>
      </div>
    </div>
    
      
      <div>
      <div class="quarto-title-meta-heading">Doi</div>
      <div class="quarto-title-meta-contents">
        <p class="doi">
          <a href="https://doi.org/10.59350/gt0nr-wct91">10.59350/gt0nr-wct91</a>
        </p>
      </div>
    </div>
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Contents</h2>
   
  <ul>
<li>
<a href="#clean-and-join-data" id="toc-clean-and-join-data" class="nav-link active" data-scroll-target="#clean-and-join-data">Clean and join data</a>
  <ul class="collapse">
<li><a href="#bls-unemployment-data" id="toc-bls-unemployment-data" class="nav-link" data-scroll-target="#bls-unemployment-data">BLS unemployment data</a></li>
  <li><a href="#census-geographic-data" id="toc-census-geographic-data" class="nav-link" data-scroll-target="#census-geographic-data">Census geographic data</a></li>
  <li><a href="#map-adjustments" id="toc-map-adjustments" class="nav-link" data-scroll-target="#map-adjustments">Map adjustments</a></li>
  <li><a href="#extract-interior-state-borders" id="toc-extract-interior-state-borders" class="nav-link" data-scroll-target="#extract-interior-state-borders">Extract interior state borders</a></li>
  </ul>
</li>
  <li><a href="#map-with-horizontal-gradient-step-legend" id="toc-map-with-horizontal-gradient-step-legend" class="nav-link" data-scroll-target="#map-with-horizontal-gradient-step-legend">Map with horizontal gradient step legend</a></li>
  <li><a href="#map-with-histogram-legend" id="toc-map-with-histogram-legend" class="nav-link" data-scroll-target="#map-with-histogram-legend">Map with histogram legend</a></li>
  <li><a href="#map-with-automatic-histogram-legend-with-legendry" id="toc-map-with-automatic-histogram-legend-with-legendry" class="nav-link" data-scroll-target="#map-with-automatic-histogram-legend-with-legendry">Map with automatic histogram legend with {legendry}</a></li>
  <li><a href="#bonus-use-points-instead-of-choropleths" id="toc-bonus-use-points-instead-of-choropleths" class="nav-link" data-scroll-target="#bonus-use-points-instead-of-choropleths">Bonus! Use points instead of choropleths</a></li>
  <li><a href="#bonus-2-use-a-diverging-color-scheme-nested-legend-circles" id="toc-bonus-2-use-a-diverging-color-scheme-nested-legend-circles" class="nav-link" data-scroll-target="#bonus-2-use-a-diverging-color-scheme-nested-legend-circles">Bonus #2! Use a diverging color scheme + nested legend circles</a></li>
  </ul></nav>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content"><p>On Bluesky the other day, I came across <a href="https://bsky.app/profile/obumbratta.com/post/3lbs67ic5bc2w">this neat post</a> that suggested using a histogram as a plot legend to provide additional context for the data being shown:</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="img/bsky-post.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="Joey Cherdarchuk’s original post"><img src="img/bsky-post.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:70.0%" alt="Joey Cherdarchuk’s original post"></a></p>
</figure>
</div>
<figcaption class="margin-caption">Joey Cherdarchuk’s original post</figcaption></figure>
</div>
<p>Here’s a closer comparison of those two maps (click to zoom):</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="img/map-histogram-legend.jpg" class="lightbox" data-gallery="quarto-lightbox-gallery-2" title="Joey Cherdarchuk’s maps side-by-side"><img src="img/map-histogram-legend.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%" alt="Joey Cherdarchuk’s maps side-by-side"></a></p>
</figure>
</div>
<figcaption class="margin-caption">Joey Cherdarchuk’s maps side-by-side</figcaption></figure>
</div>
<p>This histogram legend is especially useful for choropleth maps where units like counties are sized differently, which can create an illusion of a different distribution. For instance, in that original post, larger dark blue areas stand out a lot visually—like in Alaska, New Mexico, Arizona, and Central California—and make it seem like unemployment is fairly high.</p>
<p>But looking at the histogram that’s not actually the case. Most counties have an unemployment rate around 3–6%. This illusion is happening because <a href="https://storymaps.arcgis.com/stories/0e636a652d44484b9457f953994b212b">land isn’t unemployed—people are</a>.</p>
<p>I thought this was a cool approach, so I figured I’d try to replicate it with R. In the original post, <a href="https://bsky.app/profile/obumbratta.com/post/3lihzar4lc222">the map was created with D3, the bar chart legend was created with Excel, and the two were combined with Figma</a>. That process is a little too manual for me, but with the magic of R, {ggplot2}, and <a href="https://patchwork.data-imaginist.com/">{patchwork}</a>, we can create the same map completely programmatically.</p>
<p>Let’s do it!</p>
<section id="clean-and-join-data" class="level2"><h2 class="anchored" data-anchor-id="clean-and-join-data">Clean and join data</h2>
<p>First, let’s load some packages and tweak some theme settings:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://readxl.tidyverse.org">readxl</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/walkerke/tigris">tigris</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com">patchwork</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add some font settings to theme_void()</span></span>
<span><span class="va">theme_fancy_map</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span>base_family <span class="op">=</span> <span class="st">"IBM Plex Sans"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">theme</span><span class="op">(</span></span>
<span>      plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span>, hjust <span class="op">=</span> <span class="fl">0.13</span>, size <span class="op">=</span> <span class="fu">rel</span><span class="op">(</span><span class="fl">1.4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      plot.subtitle <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.13</span>, size <span class="op">=</span> <span class="fu">rel</span><span class="op">(</span><span class="fl">1.1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      plot.caption <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.13</span>, size <span class="op">=</span> <span class="fu">rel</span><span class="op">(</span><span class="fl">0.8</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"grey50"</span><span class="op">)</span>,</span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="bls-unemployment-data" class="level3"><h3 class="anchored" data-anchor-id="bls-unemployment-data">BLS unemployment data</h3>
<p>Next, we can get 2016 unemployment data from the Bureau of Labor Statistics. BLS offers county-level data on annual average labor force participation <a href="https://www.bls.gov/lau/tables.htm#cntyaa">here</a>, both as plain text and Excel files. The plain text data is structured a little goofily (it’s not comma-separated; it’s a fixed width format where column headings span multiple lines), but the Excel version is in nice columns and is easier to work with. Though even then, we need to skip the first few rows, and the last few rows, and specify column names ourselves.</p>
<p><a href="https://www.bls.gov/lau/tables.htm#cntyaa">Download this first from the BLS</a>:</p>
<ul>
<li><a href="https://www.bls.gov/lau/laucnty16.xlsx">Labor force data by county, 2016 annual averages (XLS)</a></li>
</ul>
<p>For the sake of mapping, we’ll truncate the unemployment rate at 9% and mark any counties with higher than 9% unemployment with 9.1 and modify the legend to show “&gt;9%”:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Load BLS data and clean it up</span></span>
<span><span class="va">bls_2016</span> <span class="op">&lt;-</span> <span class="fu">read_excel</span><span class="op">(</span></span>
<span>  <span class="st">"laucnty16.xlsx"</span>,</span>
<span>  skip <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  col_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"laus_code"</span>, <span class="st">"STATEFP"</span>, <span class="st">"COUNTYFP"</span>, <span class="st">"county_name_state"</span>,</span>
<span>    <span class="st">"year"</span>, <span class="st">"nothing"</span>, <span class="st">"labor_force"</span>, <span class="st">"employed"</span>, <span class="st">"unemployed"</span>, <span class="st">"unemp"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co"># The last few rows in the Excel file aren't actually data, but extra notes,</span></span>
<span>  <span class="co"># so drop those rows here since they don't have a state FIPS code</span></span>
<span>  <span class="fu">drop_na</span><span class="op">(</span><span class="va">STATEFP</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    <span class="co"># Truncate the unemployment rate at 9</span></span>
<span>    unemp_truncated <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">unemp</span> <span class="op">&gt;</span> <span class="fl">9</span>, <span class="fl">9.1</span>, <span class="va">unemp</span><span class="op">)</span>,</span>
<span>    <span class="co"># Find difference from Fed target of 4%</span></span>
<span>    unemp_diff <span class="op">=</span> <span class="va">unemp_truncated</span> <span class="op">-</span> <span class="fl">4</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">bls_2016</span></span>
<span><span class="co">## # A tibble: 3,219 × 12</span></span>
<span><span class="co">##    laus_code       STATEFP COUNTYFP county_name_state   year  nothing labor_force employed unemployed unemp unemp_truncated unemp_diff</span></span>
<span><span class="co">##    &lt;chr&gt;           &lt;chr&gt;   &lt;chr&gt;    &lt;chr&gt;               &lt;chr&gt; &lt;lgl&gt;         &lt;dbl&gt;    &lt;dbl&gt;      &lt;dbl&gt; &lt;dbl&gt;           &lt;dbl&gt;      &lt;dbl&gt;</span></span>
<span><span class="co">##  1 CN0100100000000 01      001      Autauga County, AL  2016  NA            25710    24395       1315   5.1             5.1        1.1</span></span>
<span><span class="co">##  2 CN0100300000000 01      003      Baldwin County, AL  2016  NA            89778    84972       4806   5.4             5.4        1.4</span></span>
<span><span class="co">##  3 CN0100500000000 01      005      Barbour County, AL  2016  NA             8334     7638        696   8.4             8.4        4.4</span></span>
<span><span class="co">##  4 CN0100700000000 01      007      Bibb County, AL     2016  NA             8539     7986        553   6.5             6.5        2.5</span></span>
<span><span class="co">##  5 CN0100900000000 01      009      Blount County, AL   2016  NA            24380    23061       1319   5.4             5.4        1.4</span></span>
<span><span class="co">##  6 CN0101100000000 01      011      Bullock County, AL  2016  NA             4785     4457        328   6.9             6.9        2.9</span></span>
<span><span class="co">##  7 CN0101300000000 01      013      Butler County, AL   2016  NA             9116     8484        632   6.9             6.9        2.9</span></span>
<span><span class="co">##  8 CN0101500000000 01      015      Calhoun County, AL  2016  NA            45450    42470       2980   6.6             6.6        2.6</span></span>
<span><span class="co">##  9 CN0101700000000 01      017      Chambers County, AL 2016  NA            14858    14044        814   5.5             5.5        1.5</span></span>
<span><span class="co">## 10 CN0101900000000 01      019      Cherokee County, AL 2016  NA            11241    10671        570   5.1             5.1        1.1</span></span>
<span><span class="co">## # ℹ 3,209 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="census-geographic-data" class="level3"><h3 class="anchored" data-anchor-id="census-geographic-data">Census geographic data</h3>
<p>Next we’ll get geographic data from the US Census with <a href="https://github.com/walkerke/tigris">{tigris}</a></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Backup data source
</div>
</div>
<div class="callout-body-container callout-body">
<p>At the time of this writing, {tigris} is working. It wasn’t working a couple weeks ago as the wildly illegal Department of Government Efficiency rampaged through different federal agencies—including the US Census—and shut down the Census’s GIS APIs. But it seems to be working for now?</p>
<p>If it’s not working, <a href="https://www.nhgis.org/">IPUMS’s NHGIS project</a> offers the same shapefiles.</p>
</div>
</div>
<p>The BLS data and the Census data each have columns with <a href="https://en.wikipedia.org/wiki/Federal_Information_Processing_Standard_state_code">state and county FIPS codes</a> which we can use to join the two datasets:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Get county and state shapefiles from Tigris</span></span>
<span><span class="va">us_counties</span> <span class="op">&lt;-</span> <span class="fu">counties</span><span class="op">(</span>year <span class="op">=</span> <span class="fl">2016</span>, cb <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">STATEFP</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="fl">56</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">shift_geometry</span><span class="op">(</span><span class="op">)</span>  <span class="co"># Move AK and HI</span></span>
<span></span>
<span><span class="va">us_states</span> <span class="op">&lt;-</span> <span class="fu">states</span><span class="op">(</span>year <span class="op">=</span> <span class="fl">2016</span>, cb <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">STATEFP</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="fl">56</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">shift_geometry</span><span class="op">(</span><span class="op">)</span>  <span class="co"># Move AK and HI</span></span>
<span></span>
<span><span class="co"># Join BLS data to the map</span></span>
<span><span class="va">counties_with_unemp</span> <span class="op">&lt;-</span> <span class="va">us_counties</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">bls_2016</span>, by <span class="op">=</span> <span class="fu">join_by</span><span class="op">(</span><span class="va">STATEFP</span>, <span class="va">COUNTYFP</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check out the joined data</span></span>
<span><span class="va">counties_with_unemp</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">STATEFP</span>, <span class="va">COUNTYFP</span>, <span class="va">county_name_state</span>, <span class="va">unemp_truncated</span>, <span class="va">geometry</span><span class="op">)</span></span>
<span><span class="co">## Simple feature collection with 3142 features and 4 fields</span></span>
<span><span class="co">## Geometry type: GEOMETRY</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: -3112000 ymin: -1698000 xmax: 2258000 ymax: 1566000</span></span>
<span><span class="co">## Projected CRS: USA_Contiguous_Albers_Equal_Area_Conic</span></span>
<span><span class="co">## First 10 features:</span></span>
<span><span class="co">##    STATEFP COUNTYFP    county_name_state unemp_truncated                       geometry</span></span>
<span><span class="co">## 1       19      107    Keokuk County, IA             4.3 MULTIPOLYGON (((297173 4548...</span></span>
<span><span class="co">## 2       19      189 Winnebago County, IA             3.4 MULTIPOLYGON (((163347 6734...</span></span>
<span><span class="co">## 3       20      093    Kearny County, KS             3.1 MULTIPOLYGON (((-482328 605...</span></span>
<span><span class="co">## 4       20      123  Mitchell County, KS             3.3 MULTIPOLYGON (((-212918 197...</span></span>
<span><span class="co">## 5       20      187   Stanton County, KS             2.8 MULTIPOLYGON (((-528445 214...</span></span>
<span><span class="co">## 6       21      005  Anderson County, KY             4.0 MULTIPOLYGON (((940067 1094...</span></span>
<span><span class="co">## 7       21      029   Bullitt County, KY             4.1 MULTIPOLYGON (((873753 1022...</span></span>
<span><span class="co">## 8       21      049     Clark County, KY             4.7 MULTIPOLYGON (((1012432 106...</span></span>
<span><span class="co">## 9       21      059   Daviess County, KY             4.4 MULTIPOLYGON (((749702 5517...</span></span>
<span><span class="co">## 10      21      063   Elliott County, KY             9.1 MULTIPOLYGON (((1102886 138...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The map works!</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">us_states</span>, fill <span class="op">=</span> <span class="st">"#0074D9"</span>, color <span class="op">=</span> <span class="st">"white"</span>, linewidth <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Albers projection</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span>crs <span class="op">=</span> <span class="fu">st_crs</span><span class="op">(</span><span class="st">"ESRI:102003"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="index_files/figure-html/plot-basic map-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="index_files/figure-html/plot-basic map-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></a></p>
</figure>
</div>
</div>
</div>
</section><section id="map-adjustments" class="level3"><h3 class="anchored" data-anchor-id="map-adjustments">Map adjustments</h3>
<p>We need to make a couple little adjustments to the map first. In the original image on Bluesky, there’s extra space on the right side of the map to allow for the legend. We can change the plot window by adding 10% of the width of the map to the right.</p>
<p>Technically we don’t have to work with percents here; the data is currently using the Albers projection, which works in meters, so we could add something like 500,000 meters / 500 km to the left. But this is a more general solution and also works if the map data is in decimal degrees instead of meters.</p>
<p>Also, the far western Aleutian islands mess with the visual balance of the map (and they don’t appear because they’re so small), so we’ll also subtract 10% of the map from the left.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Get x-axis limits of the bounding box for the state data</span></span>
<span><span class="va">xlim_current</span> <span class="op">&lt;-</span> <span class="fu">st_bbox</span><span class="op">(</span><span class="va">us_states</span><span class="op">)</span><span class="op">$</span><span class="va">xlim</span></span>
<span></span>
<span><span class="co"># Add 540ish km (or 10% of the US) to the bounds (thus shifting the window over)</span></span>
<span><span class="va">xlim_expanded</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>  <span class="va">xlim_current</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="op">(</span><span class="fl">0.1</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="va">xlim_current</span><span class="op">)</span><span class="op">)</span>, </span>
<span>  <span class="va">xlim_current</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="op">(</span><span class="fl">0.1</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="va">xlim_current</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">us_states</span>, fill <span class="op">=</span> <span class="st">"#0074D9"</span>, color <span class="op">=</span> <span class="st">"white"</span>, linewidth <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span>crs <span class="op">=</span> <span class="fu">st_crs</span><span class="op">(</span><span class="st">"ESRI:102003"</span><span class="op">)</span>, xlim <span class="op">=</span> <span class="va">xlim_expanded</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="index_files/figure-html/plot-shifted-window-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="index_files/figure-html/plot-shifted-window-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></a></p>
</figure>
</div>
</div>
</div>
</section><section id="extract-interior-state-borders" class="level3"><h3 class="anchored" data-anchor-id="extract-interior-state-borders">Extract interior state borders</h3>
<p>Because we’re using <code>color = "white", linewidth = 0.25</code>, every state gets a thin white border. This causes some issues though. All the states that share borders actually get a thicker border, since a state’s western border joins up with its neighbor’s eastern border. Also, all the coastlines and islands get borders, which diminishes the landmass—especially on a white background.</p>
<p>Like, look at <a href="https://en.wikipedia.org/wiki/Aleutian_Islands">Alaska’s Aleutian Islands</a>, or <a href="https://en.wikipedia.org/wiki/List_of_islands_of_Hawaii#Northwestern_Hawaii_Islands">Hawai’i’s smaller islands</a>, or Michigan’s <a href="https://en.wikipedia.org/wiki/Les_Cheneaux_Islands">Les Cheneaux Islands</a> and <a href="https://en.wikipedia.org/wiki/Isle_Royale_National_Park">Isle Royale</a>, or <a href="https://en.wikipedia.org/wiki/Channel_Islands_(California)">California’s Channel Islands</a>, or the <a href="https://en.wikipedia.org/wiki/Florida_Keys">Florida Keys</a>, or <a href="https://en.wikipedia.org/wiki/Outer_Banks">North Carolina’s Outer Banks</a>—they all basically disappear.</p>
<p>To fix this, we can use <code>st_intersection()</code> to identify the intersections of all the state shapes (see <a href="https://ikashnitsky.phd/2023/map-borders/">this</a> and <a href="https://stackoverflow.com/a/57138069">this</a> for more details)</p>
<p>Now all the islands and coastlines have much better definition and the borders between states are truly sized at 0.25:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">interior_state_borders</span> <span class="op">&lt;-</span> <span class="fu">st_intersection</span><span class="op">(</span><span class="va">us_states</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">n.overlaps</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co"># Remove weird points that st_intersection() adds</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="fu">st_geometry_type</span><span class="op">(</span><span class="va">geometry</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"POINT"</span>, <span class="st">"MULTIPOINT"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">us_states</span>, fill <span class="op">=</span> <span class="st">"#0074D9"</span>, linewidth <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">interior_state_borders</span>, linewidth <span class="op">=</span> <span class="fl">0.25</span>, color <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span>crs <span class="op">=</span> <span class="fu">st_crs</span><span class="op">(</span><span class="st">"ESRI:102003"</span><span class="op">)</span>, xlim <span class="op">=</span> <span class="va">xlim_expanded</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="index_files/figure-html/plot-interior-borders-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="index_files/figure-html/plot-interior-borders-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></a></p>
</figure>
</div>
</div>
</div>
</section></section><section id="map-with-horizontal-gradient-step-legend" class="level2"><h2 class="anchored" data-anchor-id="map-with-horizontal-gradient-step-legend">Map with horizontal gradient step legend</h2>
<p>Now that we have cleaned and adjusted geographic and unemployment data, we can make a fancy map! Instead of building this sequentially, I’ve included all the code all at once, with lots of comments at each step.</p>
<p>A few things to note:</p>
<ul>
<li><p><code>scale_fill_stepsn()</code> lets you use <a href="https://ggplot2.tidyverse.org/reference/scale_steps.html">distinct bins of color</a> instead of a continuous gradient</p></li>
<li>
<p>We position the legend inside the plot with <code>theme(legend.position = "inside", legend.position.inside = c(0.86, 0.32))</code>. Those <code>0.86, 0.32</code> coordinates took a lot of tinkering to get! The units for <code>legend.position.inside</code> are based on percentages of the plot, so the legend appears where x is 86% across and 32% up. <strong>The position changes every time the plot dimensions change.</strong> To make life easier as I played with different values, I used <a href="https://github.com/idmn/ggview">{ggview}</a> to specify and lock in exact dimensions of the plot:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/idmn/ggview">ggview</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p</span> <span class="op">+</span> <span class="fu">canvas</span><span class="op">(</span><span class="fl">7</span>, <span class="fl">5</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>I’m not using <code>ggview::canvas()</code> here in the post because I’m specifying figure dimensions with Quarto chunk options instead (<code>fig-width: 7</code> and <code>fig-height: 5</code>).</p>
</li>
</ul>
<p>Here’s the map!</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Add counties filled with unemployment levels</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">counties_with_unemp</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">unemp_truncated</span><span class="op">)</span>, linewidth <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Add interior state boundaries</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">interior_state_borders</span>, color <span class="op">=</span> <span class="st">"white"</span>, linewidth <span class="op">=</span> <span class="fl">0.25</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Show the unemployment legend as steps instead of a standard gradient</span></span>
<span>  <span class="fu">scale_fill_stepsn</span><span class="op">(</span></span>
<span>    colours <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu">brewer_pal</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"YlGnBu"</span><span class="op">)</span><span class="op">(</span><span class="fl">9</span><span class="op">)</span>,</span>
<span>    breaks <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,</span>
<span>    limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>    <span class="co"># Change the label for &gt;9%</span></span>
<span>    labels <span class="op">=</span> <span class="fu">case_match</span><span class="op">(</span></span>
<span>      <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,</span>
<span>      <span class="fl">1</span> <span class="op">~</span> <span class="st">"1%"</span>,</span>
<span>      <span class="fl">10</span> <span class="op">~</span> <span class="st">"&gt;9%"</span>,</span>
<span>      .default <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Yay labels</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"US unemployment rates"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"2016 annual averages by county"</span>,</span>
<span>    caption <span class="op">=</span> <span class="st">"Source: US Bureau of Labor Statistics"</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"Unemployment rate"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Use Albers projection and new x-axis limits</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span>crs <span class="op">=</span> <span class="fu">st_crs</span><span class="op">(</span><span class="st">"ESRI:102003"</span><span class="op">)</span>, xlim <span class="op">=</span> <span class="va">xlim_expanded</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Theme adjustments</span></span>
<span>  <span class="fu">theme_fancy_map</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">"inside"</span>,</span>
<span>    legend.position.inside <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.86</span>, <span class="fl">0.32</span><span class="op">)</span>,</span>
<span>    legend.direction <span class="op">=</span> <span class="st">"horizontal"</span>,</span>
<span>    legend.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fu">rel</span><span class="op">(</span><span class="fl">0.55</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    legend.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span>, face <span class="op">=</span> <span class="st">"bold"</span>, size <span class="op">=</span> <span class="fu">rel</span><span class="op">(</span><span class="fl">0.7</span><span class="op">)</span>, margin <span class="op">=</span> <span class="fu">margin</span><span class="op">(</span>t <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    legend.title.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>    legend.key.width <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">1.55</span>, <span class="st">"lines"</span><span class="op">)</span>,</span>
<span>    legend.key.height <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0.7</span>, <span class="st">"lines"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="index_files/figure-html/plot-horizontal-legend-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6"><img src="index_files/figure-html/plot-horizontal-legend-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></a></p>
</figure>
</div>
</div>
</div>
</section><section id="map-with-histogram-legend" class="level2"><h2 class="anchored" data-anchor-id="map-with-histogram-legend">Map with histogram legend</h2>
<p>We can replace the step gradient legend with a histogram that is filled using the same colors as the step legend.</p>
<p>The easiest method that gives us the most control over the legend histogram is to create a separate plot object for the histogram and place it inside the map with <a href="https://patchwork.data-imaginist.com/articles/guides/layout.html#insets">{patchwork}’s <code>inset_element()</code></a>.</p>
<p>Here’s the histogram, again with comments at each step. Only one neat trick to note here:</p>
<ul>
<li>
<code>geom_histogram</code> automatically determines the bin width for the variable assigned to the x aesthetic. In order to fill each bar by bin-specific color, we need to access information about those newly created bins. <a href="https://yjunechoe.github.io/posts/2022-03-10-ggplot2-delayed-aes-1/">We can do this with <code>after_stat()</code></a>—here we fill each bar using the already-calculated x bin categories with <code>fill = after_stat(factor(x))</code>
</li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hist_legend</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">bls_2016</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">unemp_truncated</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Fill each histogram bar using the x axis category that ggplot creates</span></span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span></span>
<span>    <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="fu">after_stat</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, </span>
<span>    binwidth <span class="op">=</span> <span class="fl">1</span>, boundary <span class="op">=</span> <span class="fl">0</span>, color <span class="op">=</span> <span class="st">"white"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Fill with the same palette as the map</span></span>
<span>  <span class="fu">scale_fill_brewer</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"YlGnBu"</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Modify the x-axis labels to use &gt;9%</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span></span>
<span>    breaks <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">10</span>, </span>
<span>    labels <span class="op">=</span> <span class="fu">case_match</span><span class="op">(</span></span>
<span>      <span class="fl">2</span><span class="op">:</span><span class="fl">10</span>,</span>
<span>      <span class="fl">2</span> <span class="op">~</span> <span class="st">"2%"</span>,</span>
<span>      <span class="fl">10</span> <span class="op">~</span> <span class="st">"&gt;9%"</span>,</span>
<span>      .default <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Just one label to replicate the legend title</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Unemployment rate"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Theme adjustments</span></span>
<span>  <span class="fu">theme_fancy_map</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    axis.text.x <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fu">rel</span><span class="op">(</span><span class="fl">0.55</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    axis.title.x <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fu">rel</span><span class="op">(</span><span class="fl">0.68</span><span class="op">)</span>, margin <span class="op">=</span> <span class="fu">margin</span><span class="op">(</span>t <span class="op">=</span> <span class="fl">3</span>, b <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">hist_legend</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="index_files/figure-html/plot-histogram-legend-alone-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7"><img src="index_files/figure-html/plot-histogram-legend-alone-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:70.0%"></a></p>
</figure>
</div>
</div>
</div>
<p>Next, we’ll place that <code>hist_legend</code> plot inside a map with <code>inset_element()</code>. Like <code>legend.position.inside = c(0.86, 0.32)</code> in the previous map, the <code>left = 0.75, bottom = 0.26, right = 0.98, top = 0.5</code> values here are percentages of the plot area and they’re fully dependent on the overall dimensions of the plot. Getting these exact numbers took a lot of manual adjusting, and <code>ggview::canvas()</code> was once again indispensable for keeping the plot dimensions constant.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">unemp_map</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Add counties filled with unemployment levels</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">counties_with_unemp</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">unemp_truncated</span><span class="op">)</span>, color <span class="op">=</span> <span class="cn">NA</span>, linewidth <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Add interior state boundaries</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">interior_state_borders</span>, color <span class="op">=</span> <span class="st">"white"</span>, linewidth <span class="op">=</span> <span class="fl">0.25</span>, fill <span class="op">=</span> <span class="cn">NA</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Show the unemployment legend as steps instead of a standard gradient, but</span></span>
<span>  <span class="co"># don't actually show the legend</span></span>
<span>  <span class="fu">scale_fill_stepsn</span><span class="op">(</span></span>
<span>    colours <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu">brewer_pal</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"YlGnBu"</span><span class="op">)</span><span class="op">(</span><span class="fl">9</span><span class="op">)</span>,</span>
<span>    breaks <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, </span>
<span>    guide <span class="op">=</span> <span class="st">"none"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Yay labels</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"US unemployment rates"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"2016 annual averages by county"</span>,</span>
<span>    caption <span class="op">=</span> <span class="st">"Source: US Bureau of Labor Statistics"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Use Albers projection and new x-axis limits</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span>crs <span class="op">=</span> <span class="fu">st_crs</span><span class="op">(</span><span class="st">"ESRI:102003"</span><span class="op">)</span>, xlim <span class="op">=</span> <span class="va">xlim_expanded</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Theme stuff</span></span>
<span>  <span class="fu">theme_fancy_map</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add the histogram to the map</span></span>
<span><span class="va">combined_map_hist</span> <span class="op">&lt;-</span> <span class="va">unemp_map</span> <span class="op">+</span> </span>
<span>  <span class="fu">inset_element</span><span class="op">(</span><span class="va">hist_legend</span>, left <span class="op">=</span> <span class="fl">0.75</span>, bottom <span class="op">=</span> <span class="fl">0.26</span>, right <span class="op">=</span> <span class="fl">0.98</span>, top <span class="op">=</span> <span class="fl">0.45</span><span class="op">)</span></span>
<span><span class="va">combined_map_hist</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="index_files/figure-html/plot-histogram-legend-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8"><img src="index_files/figure-html/plot-histogram-legend-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></a></p>
</figure>
</div>
</div>
</div>
</section><section id="map-with-automatic-histogram-legend-with-legendry" class="level2"><h2 class="anchored" data-anchor-id="map-with-automatic-histogram-legend-with-legendry">Map with automatic histogram legend with {legendry}</h2>
<p>Finally, <a href="https://teunbrand.github.io/legendry/">the new {legendry} package</a> makes it so we can create a custom histogram-based legend without needing to use {patchwork} with a separate histogram plot!</p>
<p>It doesn’t provide as much control over the resulting histogram. The <code>gizmo_histogram()</code> function uses base R’s <code><a href="https://rdrr.io/r/graphics/hist.html">hist()</a></code> behind the scenes, so we have to specify bin widths and other settings in <code>hist.arg</code> as base R arguments, like <code>breaks = 10</code> instead of ggplot’s <code>binwidth = 10</code>.</p>
<p>Not all of <code><a href="https://rdrr.io/r/graphics/hist.html">hist()</a></code>’s options seem to work here. For instance, I get a warning if I use <code>border = "white"</code> to add a white border around each bar (<code>argument ‘border’ is not made use of</code>), since that border option is disabled when using base R’s <code><a href="https://rdrr.io/r/graphics/hist.html">hist()</a></code> with <code>plot = FALSE</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span><span class="va">counties_with_unemp</span><span class="op">$</span><span class="va">unemp_truncated</span>, breaks <span class="op">=</span> <span class="fl">10</span>, border <span class="op">=</span> <span class="st">"white"</span>, plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">## Warning in hist.default(counties_with_unemp$unemp_truncated, breaks = 10, : argument 'border' is not made use of</span></span>
<span><span class="co">## $breaks</span></span>
<span><span class="co">##  [1]  1  2  3  4  5  6  7  8  9 10</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $counts</span></span>
<span><span class="co">## [1]  12 244 589 821 644 410 205  97 119</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $density</span></span>
<span><span class="co">## [1] 0.00382 0.07768 0.18752 0.26138 0.20503 0.13053 0.06527 0.03088 0.03789</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $mids</span></span>
<span><span class="co">## [1] 1.5 2.5 3.5 4.5 5.5 6.5 7.5 8.5 9.5</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $xname</span></span>
<span><span class="co">## [1] "counties_with_unemp$unemp_truncated"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $equidist</span></span>
<span><span class="co">## [1] TRUE</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## attr(,"class")</span></span>
<span><span class="co">## [1] "histogram"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Also, it’s currently filling each histogram bar with the full gradient, not the 9 distinct steps, and I can’t figure out how to define custom colors for each bar—and it might not even be possible since color settings aren’t picked up anyway because of {legendry}’s use of <code>plot = FALSE</code> 🤷‍♂️.</p>
<p>But despite these downsides, this automatic histogram legend with {legendry} is really neat!</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://teunbrand.github.io/legendry/">legendry</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a custom histogram guide</span></span>
<span><span class="va">histogram_guide</span> <span class="op">&lt;-</span> <span class="fu">compose_sandwich</span><span class="op">(</span></span>
<span>  middle <span class="op">=</span> <span class="fu">gizmo_histogram</span><span class="op">(</span>just <span class="op">=</span> <span class="fl">0</span>, hist.arg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  text <span class="op">=</span> <span class="st">"axis_base"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Add counties filled with unemployment levels</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">counties_with_unemp</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">unemp_truncated</span><span class="op">)</span>, color <span class="op">=</span> <span class="cn">NA</span>, linewidth <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Add interior state boundaries</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">interior_state_borders</span>, color <span class="op">=</span> <span class="st">"white"</span>, linewidth <span class="op">=</span> <span class="fl">0.25</span>, fill <span class="op">=</span> <span class="cn">NA</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Show the unemployment legend with a custom histogram guide</span></span>
<span>  <span class="fu">scale_fill_stepsn</span><span class="op">(</span></span>
<span>    colours <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu">brewer_pal</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"YlGnBu"</span><span class="op">)</span><span class="op">(</span><span class="fl">9</span><span class="op">)</span>,</span>
<span>    breaks <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,</span>
<span>    limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>    guide <span class="op">=</span> <span class="va">histogram_guide</span>,</span>
<span>    <span class="co"># Change the label for &gt;9%</span></span>
<span>    labels <span class="op">=</span> <span class="fu">case_match</span><span class="op">(</span></span>
<span>      <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,</span>
<span>      <span class="fl">1</span> <span class="op">~</span> <span class="st">"1%"</span>,</span>
<span>      <span class="fl">10</span> <span class="op">~</span> <span class="st">"&gt;9%"</span>,</span>
<span>      .default <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Yay labels</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"US unemployment rates"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"2016 annual averages by county"</span>,</span>
<span>    caption <span class="op">=</span> <span class="st">"Source: US Bureau of Labor Statistics"</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"Unemployment rate"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Use Albers projection and new x-axis limits</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span>crs <span class="op">=</span> <span class="fu">st_crs</span><span class="op">(</span><span class="st">"ESRI:102003"</span><span class="op">)</span>, xlim <span class="op">=</span> <span class="va">xlim_expanded</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Theme stuff</span></span>
<span>  <span class="fu">theme_fancy_map</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">"inside"</span>,</span>
<span>    legend.position.inside <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.86</span>, <span class="fl">0.32</span><span class="op">)</span>,</span>
<span>    legend.direction <span class="op">=</span> <span class="st">"horizontal"</span>,</span>
<span>    legend.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fu">rel</span><span class="op">(</span><span class="fl">0.55</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    legend.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span>, face <span class="op">=</span> <span class="st">"bold"</span>, size <span class="op">=</span> <span class="fu">rel</span><span class="op">(</span><span class="fl">0.7</span><span class="op">)</span>, margin <span class="op">=</span> <span class="fu">margin</span><span class="op">(</span>t <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    legend.title.position <span class="op">=</span> <span class="st">"bottom"</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="index_files/figure-html/plot-histogram-legend-legendry-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-9"><img src="index_files/figure-html/plot-histogram-legend-legendry-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></a></p>
</figure>
</div>
</div>
</div>
</section><section id="bonus-use-points-instead-of-choropleths" class="level2"><h2 class="anchored" data-anchor-id="bonus-use-points-instead-of-choropleths">Bonus! Use points instead of choropleths</h2>
<p>We’re still using choropleth maps here, which still isn’t ideal for showing the idea that “land isn’t unemployed”. One solution is to plot points that are sized by population. This is pretty straightforward with {sf}—we need to convert the county polygons into single points, which we can do with <code>st_point_on_surface()</code>. Then, after a bunch of tinkering with legend options, we’ll have this gorgeous map:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Convert the county polygons into single points</span></span>
<span><span class="va">counties_with_unemp_points</span> <span class="op">&lt;-</span> <span class="va">counties_with_unemp</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">st_point_on_surface</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">unemp_map_points</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Use a gray background</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">us_states</span>, fill <span class="op">=</span> <span class="st">"gray90"</span>, linewidth <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">interior_state_borders</span>, linewidth <span class="op">=</span> <span class="fl">0.25</span>, color <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Include semi-transparent points with shape 21 (so there's a border)</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">counties_with_unemp_points</span>, </span>
<span>    <span class="fu">aes</span><span class="op">(</span>size <span class="op">=</span> <span class="va">labor_force</span>, fill <span class="op">=</span> <span class="va">unemp_truncated</span><span class="op">)</span>, </span>
<span>    pch <span class="op">=</span> <span class="fl">21</span>, color <span class="op">=</span> <span class="st">"white"</span>, stroke <span class="op">=</span> <span class="fl">0.25</span>, alpha <span class="op">=</span> <span class="fl">0.8</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Control the size of the points in the legend</span></span>
<span>  <span class="fu">scale_size_continuous</span><span class="op">(</span></span>
<span>    range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">9</span><span class="op">)</span>, labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu">label_comma</span><span class="op">(</span><span class="op">)</span>, </span>
<span>    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">10000</span>, <span class="fl">100000</span>, <span class="fl">1000000</span><span class="op">)</span>,</span>
<span>    <span class="co"># Make the points black and not have a border</span></span>
<span>    guide <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>pch <span class="op">=</span> <span class="fl">19</span>, color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Show the unemployment legend as steps instead of a standard gradient, but</span></span>
<span>  <span class="co"># don't actually show the legend</span></span>
<span>  <span class="fu">scale_fill_stepsn</span><span class="op">(</span></span>
<span>    colours <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu">brewer_pal</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"YlGnBu"</span><span class="op">)</span><span class="op">(</span><span class="fl">9</span><span class="op">)</span>,</span>
<span>    breaks <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, </span>
<span>    guide <span class="op">=</span> <span class="st">"none"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Labels</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"US unemployment rates"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"2016 annual averages by county"</span>,</span>
<span>    caption <span class="op">=</span> <span class="st">"Source: US Bureau of Labor Statistics"</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"Unemployment rate"</span>,</span>
<span>    size <span class="op">=</span> <span class="st">"Labor force"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Albers</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span>crs <span class="op">=</span> <span class="fu">st_crs</span><span class="op">(</span><span class="st">"ESRI:102003"</span><span class="op">)</span>, xlim <span class="op">=</span> <span class="va">xlim_expanded</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Theme stuff</span></span>
<span>  <span class="fu">theme_fancy_map</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">"inside"</span>,</span>
<span>    legend.position.inside <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.837</span>, <span class="fl">0.13</span><span class="op">)</span>,</span>
<span>    legend.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fu">rel</span><span class="op">(</span><span class="fl">0.55</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    legend.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span>, face <span class="op">=</span> <span class="st">"bold"</span>, size <span class="op">=</span> <span class="fu">rel</span><span class="op">(</span><span class="fl">0.7</span><span class="op">)</span>, margin <span class="op">=</span> <span class="fu">margin</span><span class="op">(</span>t <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    legend.title.position <span class="op">=</span> <span class="st">"bottom"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Add the histogram to the map</span></span>
<span><span class="va">combined_map_hist_points</span> <span class="op">&lt;-</span> <span class="va">unemp_map_points</span> <span class="op">+</span> </span>
<span>  <span class="fu">inset_element</span><span class="op">(</span><span class="va">hist_legend</span>, left <span class="op">=</span> <span class="fl">0.75</span>, bottom <span class="op">=</span> <span class="fl">0.26</span>, right <span class="op">=</span> <span class="fl">0.98</span>, top <span class="op">=</span> <span class="fl">0.45</span><span class="op">)</span></span>
<span><span class="va">combined_map_hist_points</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="index_files/figure-html/plot-histogram-points-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-10"><img src="index_files/figure-html/plot-histogram-points-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></a></p>
</figure>
</div>
</div>
</div>
</section><section id="bonus-2-use-a-diverging-color-scheme-nested-legend-circles" class="level2"><h2 class="anchored" data-anchor-id="bonus-2-use-a-diverging-color-scheme-nested-legend-circles">Bonus #2! Use a diverging color scheme + nested legend circles</h2>
<p>But wait, there’s more! Based on discussions with really smart dataviz people on Bluesky in the wake of <a href="https://bsky.app/profile/andrew.heiss.phd/post/3like2os2d22c">me posting about this blog post there</a>, we can make two additional tweaks:</p>
<ul>
<li>
<p>While the different sizes for the points are neat, I’m not a fan of how big the vertical spacing is between the 10,000; 100,000; and 1,000,000. Unfortunately there’s no way to change it. Technically we can use <code>legend.key.spacing.y</code> in <code>theme()</code> to adjust it, but that doesn’t work as expected here because each of those legend entries is sized to match the largest point—i.e., the point for 1,000,000 is the biggest, so the legend entries for all the other values match its height, even if they don’t need all that space.</p>
<p>To fix this, we can use <code>guide_circles()</code> from {legendry} to show the different point sizes as coencentric circles, which is more compact (and just looks neat).</p>
</li>
<li>
<p>Instead of showing a range of low → high values, <a href="https://bsky.app/profile/abmakulec.bsky.social/post/3limfykl2i22n">we can color these counties based on a meaningful midpoint</a> to help highlight which counties are doing great (low unemployment! good!) and which aren’t (high unemployment! bad!). That might not always necessarily be the best approach—showing the full range of actual values like in the original map is a way of just describing the range and doesn’t inherently imply good or bad. But in other plots where data might be more actionable, divergences from some central value would be much more helpful.</p>
<p>In the United States, the Federal Reserve has a <a href="https://www.stlouisfed.org/in-plain-english/the-fed-and-the-dual-mandate">unique dual mandate</a> to use macroeconomic policies to target both inflation and unemployment (most other countries’ central banks only target inflation). The Fed typically aims for an inflation rate of 2% and an unemployment rate of <a href="https://www.marketplace.org/2024/07/29/what-is-maximum-employment-target/">4ish%</a>. So in this new map, we’ll center each county’s unemployment rate around 4% and show the percentage point deviations from that Fed target. Counties colored in darker red have higher unemployment rates than the target; counties colored in blue have lower rates than the target.</p>
<p>We can then imagine that we’re a policymaker interested in unemployment trends—we can look at the map and quickly identify areas that are doing poorly and doing well.</p>
</li>
</ul>
<p>Up at the beginning of the document where we loaded and cleaned the <code>bls_2016</code> dataset, I’ve added a new variable that centers the unemployment rate at 4:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">mutate</span><span class="op">(</span>unemp_diff <span class="op">=</span> <span class="va">unemp_truncated</span> <span class="op">-</span> <span class="fl">4</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We can then use this to create a new histogram and new map colored with the “vik” palette from <a href="https://github.com/thomasp85/scico">the {scico} package</a>, which has lots of <a href="https://www.fabiocrameri.ch/colourmaps/">neat diverging palettes</a>. We’ll also create a fancy circle-based legend with {legendry}. Here’s the fully annotated code and final map:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://wilkelab.org/ggtext/">ggtext</a></span><span class="op">)</span>  <span class="co"># For Markdown-based text in ggplot</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/thomasp85/scico">scico</a></span><span class="op">)</span>   <span class="co"># For perceptually uniform colors</span></span>
<span></span>
<span><span class="co"># Make new histogram legend</span></span>
<span><span class="va">hist_legend_diffs</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">bls_2016</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">unemp_diff</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Fill each histogram bar using the x axis category that ggplot creates</span></span>
<span>  <span class="co"># Use boundary = 0.5 to shift the bin ranges from things like 1-2 to 1.5-2.5</span></span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span></span>
<span>    <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="fu">after_stat</span><span class="op">(</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, </span>
<span>    binwidth <span class="op">=</span> <span class="fl">1</span>, boundary <span class="op">=</span> <span class="fl">0.5</span>, color <span class="op">=</span> <span class="st">"white"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Fill with the same palette as the map</span></span>
<span>  <span class="co"># scale_fill_brewer(palette = "YlGnBu", guide = "none") +</span></span>
<span>  <span class="fu">scale_fill_scico</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"vik"</span>, midpoint <span class="op">=</span> <span class="fl">0</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Modify the x-axis labels to show perentage point values and format them with</span></span>
<span>  <span class="co"># markdown to get original unemployment values on separate lines</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span></span>
<span>    breaks <span class="op">=</span> <span class="op">-</span><span class="fl">2</span><span class="op">:</span><span class="fl">5</span>, </span>
<span>    labels <span class="op">=</span> <span class="fu">case_match</span><span class="op">(</span></span>
<span>      <span class="op">-</span><span class="fl">2</span><span class="op">:</span><span class="fl">5</span>,</span>
<span>      <span class="op">-</span><span class="fl">2</span> <span class="op">~</span> <span class="st">"**−2 pp.**&lt;br&gt;(2%)"</span>,</span>
<span>      <span class="fl">0</span> <span class="op">~</span> <span class="st">"**0**&lt;br&gt;(4% ±&lt;br&gt;0.5 pp.)"</span>,</span>
<span>      <span class="fl">5</span> <span class="op">~</span> <span class="st">"**&gt;+4 pp.**&lt;br&gt;(&gt;9%)"</span>,</span>
<span>      .default <span class="op">=</span> <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span></span>
<span>        <span class="st">"**{x}**"</span>, </span>
<span>        x <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu">label_comma</span><span class="op">(</span></span>
<span>          style_positive <span class="op">=</span> <span class="st">"plus"</span>, style_negative <span class="op">=</span> <span class="st">"minus"</span></span>
<span>        <span class="op">)</span><span class="op">(</span><span class="op">-</span><span class="fl">2</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Just one label to replicate the legend title</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Difference from Fed target"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Theme adjustments</span></span>
<span>  <span class="fu">theme_fancy_map</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    axis.text.x <span class="op">=</span> <span class="fu">element_markdown</span><span class="op">(</span>size <span class="op">=</span> <span class="fu">rel</span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span>, vjust <span class="op">=</span> <span class="fl">1</span>, lineheight <span class="op">=</span> <span class="fl">1.3</span><span class="op">)</span>,</span>
<span>    axis.title.x <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fu">rel</span><span class="op">(</span><span class="fl">0.68</span><span class="op">)</span>, margin <span class="op">=</span> <span class="fu">margin</span><span class="op">(</span>t <span class="op">=</span> <span class="fl">3</span>, b <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">unemp_map_points_diffs</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Use a lighter gray background</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">us_states</span>, fill <span class="op">=</span> <span class="st">"gray95"</span>, linewidth <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Use slightly darker state borders</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">interior_state_borders</span>, linewidth <span class="op">=</span> <span class="fl">0.25</span>, color <span class="op">=</span> <span class="st">"grey60"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Include semi-transparent points with shape 21 (so there's a border)</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">counties_with_unemp_points</span>, </span>
<span>    <span class="fu">aes</span><span class="op">(</span>size <span class="op">=</span> <span class="va">labor_force</span>, fill <span class="op">=</span> <span class="va">unemp_diff</span><span class="op">)</span>, </span>
<span>    shape <span class="op">=</span> <span class="fl">21</span>, color <span class="op">=</span> <span class="st">"white"</span>, stroke <span class="op">=</span> <span class="fl">0.25</span>, alpha <span class="op">=</span> <span class="fl">0.8</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Control the size of the points in the legend</span></span>
<span>  <span class="fu">scale_size_continuous</span><span class="op">(</span></span>
<span>    range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">11</span><span class="op">)</span>, labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu">label_comma</span><span class="op">(</span><span class="op">)</span>, </span>
<span>    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">100000</span>, <span class="fl">1000000</span>, <span class="fl">5000000</span><span class="op">)</span>,</span>
<span>    <span class="co"># Make the points black and not have a border</span></span>
<span>    guide <span class="op">=</span> <span class="fu">guide_circles</span><span class="op">(</span></span>
<span>      text_position <span class="op">=</span> <span class="st">"right"</span>,</span>
<span>      override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>        fill <span class="op">=</span> <span class="st">"grey30"</span>, alpha <span class="op">=</span> <span class="fl">0.8</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># This is tricky! We want to use the diverging vik palette but have it </span></span>
<span>  <span class="co"># centered at 0. With scale_fill_scico(), there's a midpoint argument, like we </span></span>
<span>  <span class="co"># used for the histogram. For generating regular lists of colors with scico(), </span></span>
<span>  <span class="co"># though, there's no midpoint argument. Instead, we need to make a few </span></span>
<span>  <span class="co"># specific adjustments: </span></span>
<span>  <span class="co">#</span></span>
<span>  <span class="co"># 1. Generate 11 possible colors, since there are 5 colors above the 0 </span></span>
<span>  <span class="co">#    midpoint in the histogram and we need 5 parallel negative colors below 0 </span></span>
<span>  <span class="co">#    (even though we're only using 2)</span></span>
<span>  <span class="co"># 2. Set the limits of the legend to the symmetrical -5 to 5 range so that </span></span>
<span>  <span class="co">#    it's centered at 0</span></span>
<span>  <span class="co"># 3. Set the breaks to go asymmetrically from -2:5. But actually set them </span></span>
<span>  <span class="co">#    from -2.5 to 4.5 since that matches the shifted histogram, which uses a </span></span>
<span>  <span class="co">#    boundary of 0.5 instead of 0 (so the histogram bins cover ranges like </span></span>
<span>  <span class="co">#    0.5 to 1.5 instead of 0 to 1)</span></span>
<span>  <span class="fu">scale_fill_stepsn</span><span class="op">(</span></span>
<span>    colours <span class="op">=</span> <span class="fu">scico</span><span class="fu">::</span><span class="fu">scico</span><span class="op">(</span><span class="fl">11</span>, palette <span class="op">=</span> <span class="st">"vik"</span><span class="op">)</span>,</span>
<span>    limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">5</span>, <span class="fl">5</span><span class="op">)</span>,</span>
<span>    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2.5</span>, <span class="fl">4.5</span>, by <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>    guide <span class="op">=</span> <span class="st">"none"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Labels</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"US unemployment (2016)"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"Differences from the Federal Reserve's 4% target"</span>,</span>
<span>    caption <span class="op">=</span> <span class="st">"Source: US Bureau of Labor Statistics"</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"Unemployment rate"</span>,</span>
<span>    size <span class="op">=</span> <span class="st">"County labor force"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Albers</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span>crs <span class="op">=</span> <span class="fu">st_crs</span><span class="op">(</span><span class="st">"ESRI:102003"</span><span class="op">)</span>, xlim <span class="op">=</span> <span class="va">xlim_expanded</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Theme adjustments</span></span>
<span>  <span class="fu">theme_fancy_map</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    <span class="co"># {legendry} complains if there's no legend.margin setting; using </span></span>
<span>    <span class="co"># theme_void() removes that setting and breaks the plot, so we specify </span></span>
<span>    <span class="co"># some 0 values here</span></span>
<span>    legend.margin <span class="op">=</span> <span class="fu">margin</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="st">"pt"</span><span class="op">)</span>,</span>
<span>    legendry.legend.key.margin <span class="op">=</span> <span class="fu">margin</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">5</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="st">"pt"</span><span class="op">)</span>,</span>
<span>    legend.ticks <span class="op">=</span> <span class="fu">element_line</span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"black"</span>, linetype <span class="op">=</span> <span class="st">"22"</span><span class="op">)</span>,</span>
<span>    legend.position <span class="op">=</span> <span class="st">"inside"</span>,</span>
<span>    legend.position.inside <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.87</span>, <span class="fl">0.17</span><span class="op">)</span>,</span>
<span>    legend.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fu">rel</span><span class="op">(</span><span class="fl">0.55</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    legend.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span>, face <span class="op">=</span> <span class="st">"bold"</span>, size <span class="op">=</span> <span class="fu">rel</span><span class="op">(</span><span class="fl">0.7</span><span class="op">)</span>, margin <span class="op">=</span> <span class="fu">margin</span><span class="op">(</span>t <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    plot.subtitle <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.18</span><span class="op">)</span>,</span>
<span>    legend.title.position <span class="op">=</span> <span class="st">"bottom"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Add the histogram to the map</span></span>
<span><span class="va">combined_map_hist_points_diffs</span> <span class="op">&lt;-</span> <span class="va">unemp_map_points_diffs</span> <span class="op">+</span> </span>
<span>  <span class="fu">inset_element</span><span class="op">(</span><span class="va">hist_legend_diffs</span>, left <span class="op">=</span> <span class="fl">0.75</span>, bottom <span class="op">=</span> <span class="fl">0.26</span>, right <span class="op">=</span> <span class="fl">0.98</span>, top <span class="op">=</span> <span class="fl">0.45</span><span class="op">)</span></span>
<span><span class="va">combined_map_hist_points_diffs</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="index_files/figure-html/plot-histogram-points-diffs-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-11"><img src="index_files/figure-html/plot-histogram-points-diffs-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></a></p>
</figure>
</div>
</div>
</div>


<!-- -->

</section><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{heiss2025,
  author = {Heiss, Andrew},
  title = {How to Use a Histogram as a Legend in \{Ggplot2\}},
  date = {2025-02-19},
  url = {https://www.andrewheiss.com/blog/2025/02/19/ggplot-histogram-legend/},
  doi = {10.59350/gt0nr-wct91},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-heiss2025" class="csl-entry quarto-appendix-citeas" role="listitem">
Heiss, Andrew. 2025. <span>“How to Use a Histogram as a Legend in
{Ggplot2}.”</span> February 19, 2025. <a href="https://doi.org/10.59350/gt0nr-wct91">https://doi.org/10.59350/gt0nr-wct91</a>.
</div></div></section></div></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/www\.andrewheiss\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><script src="https://giscus.app/client.js" data-repo="andrewheiss/ath-quarto" data-repo-id="R_kgDOIg6EJQ" data-category="Blog comments" data-category-id="DIC_kwDOIg6EJc4CSz92" data-mapping="pathname" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script><input type="hidden" id="giscus-base-theme" value="light"><input type="hidden" id="giscus-alt-theme" value="dark"><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb16" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "How to use a histogram as a legend in {ggplot2}"</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> 2025-02-19</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="an">description:</span><span class="co"> "Land isn't unemployed—people are. Here's how to use R, {ggplot2}, {sf}, and {patchwork} to create a histogram legend in a choropleth map to better see the distribution of values."</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="an">image:</span><span class="co"> index_files/figure-html/plot-histogram-legend-1.png</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="an">twitter-card:</span><span class="co"> </span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="co">    image: "index_files/figure-html/plot-histogram-legend-1.png"</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="an">open-graph:</span><span class="co"> </span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="co">    image: "index_files/figure-html/plot-histogram-legend-1.png"</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="co">  - r</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="co">  - tidyverse</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="co">  - ggplot</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="co">  - gis</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="co">  - maps</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a><span class="co">    shift-heading-level-by: 1</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a><span class="co">    lightbox: true</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a><span class="an">doi:</span><span class="co"> 10.59350/gt0nr-wct91</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a><span class="an">citation:</span><span class="co"> true</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">fig.width =</span> <span class="dv">6</span>,</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">fig.height =</span> <span class="dv">6</span> <span class="sc">*</span> <span class="fl">0.618</span>,</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">fig.retina =</span> <span class="dv">3</span>,</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>  <span class="at">dev =</span> <span class="st">"ragg_png"</span>,</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>  <span class="at">fig.align =</span> <span class="st">"center"</span>,</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>  <span class="at">out.width =</span> <span class="st">"90%"</span>,</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>  <span class="at">collapse =</span> <span class="cn">TRUE</span>,</span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>  <span class="at">cache.extra =</span> <span class="dv">1234</span>  <span class="co"># Change number to invalidate cache</span></span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(</span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>  <span class="at">digits =</span> <span class="dv">4</span>,</span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>  <span class="at">width =</span> <span class="dv">300</span>,</span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>  <span class="at">dplyr.summarise.inform =</span> <span class="cn">FALSE</span></span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">tigris_use_cache =</span> <span class="cn">TRUE</span>)</span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.setenv</span>(<span class="at">TIGRIS_CACHE_DIR =</span> <span class="st">"maps"</span>)</span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>On Bluesky the other day, I came across <span class="co">[</span><span class="ot">this neat post</span><span class="co">](https://bsky.app/profile/obumbratta.com/post/3lbs67ic5bc2w)</span> that suggested using a histogram as a plot legend to provide additional context for the data being shown:</span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a><span class="al">![Joey Cherdarchuk's original post](img/bsky-post.png)</span>{width="70%" fig-align="center" .lightbox}</span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>Here's a closer comparison of those two maps (click to zoom):</span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a><span class="al">![Joey Cherdarchuk's maps side-by-side](img/map-histogram-legend.jpg)</span>{width="100%" fig-align="center" .lightbox}</span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a>This histogram legend is especially useful for choropleth maps where units like counties are sized differently, which can create an illusion of a different distribution. For instance, in that original post, larger dark blue areas stand out a lot visually—like in Alaska, New Mexico, Arizona, and Central California—and make it seem like unemployment is fairly high.</span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a>But looking at the histogram that's not actually the case. Most counties have an unemployment rate around 3–6%. This illusion is happening because <span class="co">[</span><span class="ot">land isn't unemployed—people are</span><span class="co">](https://storymaps.arcgis.com/stories/0e636a652d44484b9457f953994b212b)</span>.</span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a>I thought this was a cool approach, so I figured I'd try to replicate it with R. In the original post, <span class="co">[</span><span class="ot">the map was created with D3, the bar chart legend was created with Excel, and the two were combined with Figma</span><span class="co">](https://bsky.app/profile/obumbratta.com/post/3lihzar4lc222)</span>. That process is a little too manual for me, but with the magic of R, {ggplot2}, and <span class="co">[</span><span class="ot">{patchwork}</span><span class="co">](https://patchwork.data-imaginist.com/)</span>, we can create the same map completely programmatically. </span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-69"><a href="#cb16-69" aria-hidden="true" tabindex="-1"></a>Let's do it!</span>
<span id="cb16-70"><a href="#cb16-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-71"><a href="#cb16-71" aria-hidden="true" tabindex="-1"></a><span class="fu"># Clean and join data</span></span>
<span id="cb16-72"><a href="#cb16-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-73"><a href="#cb16-73" aria-hidden="true" tabindex="-1"></a>First, let's load some packages and tweak some theme settings:</span>
<span id="cb16-74"><a href="#cb16-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-77"><a href="#cb16-77" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb16-78"><a href="#cb16-78" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: packages-settings</span></span>
<span id="cb16-79"><a href="#cb16-79" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb16-80"><a href="#cb16-80" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb16-81"><a href="#cb16-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-82"><a href="#cb16-82" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb16-83"><a href="#cb16-83" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl)</span>
<span id="cb16-84"><a href="#cb16-84" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb16-85"><a href="#cb16-85" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tigris)</span>
<span id="cb16-86"><a href="#cb16-86" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb16-87"><a href="#cb16-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-88"><a href="#cb16-88" aria-hidden="true" tabindex="-1"></a><span class="co"># Add some font settings to theme_void()</span></span>
<span id="cb16-89"><a href="#cb16-89" aria-hidden="true" tabindex="-1"></a>theme_fancy_map <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb16-90"><a href="#cb16-90" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>(<span class="at">base_family =</span> <span class="st">"IBM Plex Sans"</span>) <span class="sc">+</span></span>
<span id="cb16-91"><a href="#cb16-91" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb16-92"><a href="#cb16-92" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">hjust =</span> <span class="fl">0.13</span>, <span class="at">size =</span> <span class="fu">rel</span>(<span class="fl">1.4</span>)),</span>
<span id="cb16-93"><a href="#cb16-93" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.13</span>, <span class="at">size =</span> <span class="fu">rel</span>(<span class="fl">1.1</span>)),</span>
<span id="cb16-94"><a href="#cb16-94" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.caption =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.13</span>, <span class="at">size =</span> <span class="fu">rel</span>(<span class="fl">0.8</span>), <span class="at">color =</span> <span class="st">"grey50"</span>),</span>
<span id="cb16-95"><a href="#cb16-95" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-96"><a href="#cb16-96" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-97"><a href="#cb16-97" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-98"><a href="#cb16-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-99"><a href="#cb16-99" aria-hidden="true" tabindex="-1"></a><span class="fu">## BLS unemployment data</span></span>
<span id="cb16-100"><a href="#cb16-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-101"><a href="#cb16-101" aria-hidden="true" tabindex="-1"></a>Next, we can get 2016 unemployment data from the Bureau of Labor Statistics. BLS offers county-level data on annual average labor force participation <span class="co">[</span><span class="ot">here</span><span class="co">](https://www.bls.gov/lau/tables.htm#cntyaa)</span>, both as plain text and Excel files. The plain text data is structured a little goofily (it's not comma-separated; it's a fixed width format where column headings span multiple lines), but the Excel version is in nice columns and is easier to work with. Though even then, we need to skip the first few rows, and the last few rows, and specify column names ourselves.</span>
<span id="cb16-102"><a href="#cb16-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-103"><a href="#cb16-103" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">Download this first from the BLS</span><span class="co">](https://www.bls.gov/lau/tables.htm#cntyaa)</span>:</span>
<span id="cb16-104"><a href="#cb16-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-105"><a href="#cb16-105" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Labor force data by county, 2016 annual averages (XLS)</span><span class="co">](https://www.bls.gov/lau/laucnty16.xlsx)</span></span>
<span id="cb16-106"><a href="#cb16-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-107"><a href="#cb16-107" aria-hidden="true" tabindex="-1"></a>For the sake of mapping, we'll truncate the unemployment rate at 9% and mark any counties with higher than 9% unemployment with 9.1 and modify the legend to show "&gt;9%":</span>
<span id="cb16-108"><a href="#cb16-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-111"><a href="#cb16-111" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb16-112"><a href="#cb16-112" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: load-clean-bls</span></span>
<span id="cb16-113"><a href="#cb16-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-114"><a href="#cb16-114" aria-hidden="true" tabindex="-1"></a><span class="co"># Load BLS data and clean it up</span></span>
<span id="cb16-115"><a href="#cb16-115" aria-hidden="true" tabindex="-1"></a>bls_2016 <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(</span>
<span id="cb16-116"><a href="#cb16-116" aria-hidden="true" tabindex="-1"></a>  <span class="st">"laucnty16.xlsx"</span>,</span>
<span id="cb16-117"><a href="#cb16-117" aria-hidden="true" tabindex="-1"></a>  <span class="at">skip =</span> <span class="dv">5</span>,</span>
<span id="cb16-118"><a href="#cb16-118" aria-hidden="true" tabindex="-1"></a>  <span class="at">col_names =</span> <span class="fu">c</span>(</span>
<span id="cb16-119"><a href="#cb16-119" aria-hidden="true" tabindex="-1"></a>    <span class="st">"laus_code"</span>, <span class="st">"STATEFP"</span>, <span class="st">"COUNTYFP"</span>, <span class="st">"county_name_state"</span>,</span>
<span id="cb16-120"><a href="#cb16-120" aria-hidden="true" tabindex="-1"></a>    <span class="st">"year"</span>, <span class="st">"nothing"</span>, <span class="st">"labor_force"</span>, <span class="st">"employed"</span>, <span class="st">"unemployed"</span>, <span class="st">"unemp"</span></span>
<span id="cb16-121"><a href="#cb16-121" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-122"><a href="#cb16-122" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb16-123"><a href="#cb16-123" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The last few rows in the Excel file aren't actually data, but extra notes,</span></span>
<span id="cb16-124"><a href="#cb16-124" aria-hidden="true" tabindex="-1"></a>  <span class="co"># so drop those rows here since they don't have a state FIPS code</span></span>
<span id="cb16-125"><a href="#cb16-125" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(STATEFP) <span class="sc">|&gt;</span> </span>
<span id="cb16-126"><a href="#cb16-126" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb16-127"><a href="#cb16-127" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Truncate the unemployment rate at 9</span></span>
<span id="cb16-128"><a href="#cb16-128" aria-hidden="true" tabindex="-1"></a>    <span class="at">unemp_truncated =</span> <span class="fu">ifelse</span>(unemp <span class="sc">&gt;</span> <span class="dv">9</span>, <span class="fl">9.1</span>, unemp),</span>
<span id="cb16-129"><a href="#cb16-129" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Find difference from Fed target of 4%</span></span>
<span id="cb16-130"><a href="#cb16-130" aria-hidden="true" tabindex="-1"></a>    <span class="at">unemp_diff =</span> unemp_truncated <span class="sc">-</span> <span class="dv">4</span></span>
<span id="cb16-131"><a href="#cb16-131" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-132"><a href="#cb16-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-133"><a href="#cb16-133" aria-hidden="true" tabindex="-1"></a>bls_2016</span>
<span id="cb16-134"><a href="#cb16-134" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-135"><a href="#cb16-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-136"><a href="#cb16-136" aria-hidden="true" tabindex="-1"></a><span class="fu">## Census geographic data</span></span>
<span id="cb16-137"><a href="#cb16-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-138"><a href="#cb16-138" aria-hidden="true" tabindex="-1"></a>Next we'll get geographic data from the US Census with <span class="co">[</span><span class="ot">{tigris}</span><span class="co">](https://github.com/walkerke/tigris)</span></span>
<span id="cb16-139"><a href="#cb16-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-140"><a href="#cb16-140" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb16-141"><a href="#cb16-141" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Backup data source</span></span>
<span id="cb16-142"><a href="#cb16-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-143"><a href="#cb16-143" aria-hidden="true" tabindex="-1"></a>At the time of this writing, {tigris} is working. It wasn't working a couple weeks ago as the wildly illegal Department of Government Efficiency rampaged through different federal agencies—including the US Census—and shut down the Census's GIS APIs. But it seems to be working for now?</span>
<span id="cb16-144"><a href="#cb16-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-145"><a href="#cb16-145" aria-hidden="true" tabindex="-1"></a>If it's not working, <span class="co">[</span><span class="ot">IPUMS's NHGIS project</span><span class="co">](https://www.nhgis.org/)</span> offers the same shapefiles.</span>
<span id="cb16-146"><a href="#cb16-146" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb16-147"><a href="#cb16-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-148"><a href="#cb16-148" aria-hidden="true" tabindex="-1"></a>The BLS data and the Census data each have columns with <span class="co">[</span><span class="ot">state and county FIPS codes</span><span class="co">](https://en.wikipedia.org/wiki/Federal_Information_Processing_Standard_state_code)</span> which we can use to join the two datasets:</span>
<span id="cb16-149"><a href="#cb16-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-152"><a href="#cb16-152" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb16-153"><a href="#cb16-153" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: load-census-gis</span></span>
<span id="cb16-154"><a href="#cb16-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-155"><a href="#cb16-155" aria-hidden="true" tabindex="-1"></a><span class="co"># Get county and state shapefiles from Tigris</span></span>
<span id="cb16-156"><a href="#cb16-156" aria-hidden="true" tabindex="-1"></a>us_counties <span class="ot">&lt;-</span> <span class="fu">counties</span>(<span class="at">year =</span> <span class="dv">2016</span>, <span class="at">cb =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb16-157"><a href="#cb16-157" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">as.numeric</span>(STATEFP) <span class="sc">&lt;=</span> <span class="dv">56</span>) <span class="sc">|&gt;</span> </span>
<span id="cb16-158"><a href="#cb16-158" aria-hidden="true" tabindex="-1"></a>  <span class="fu">shift_geometry</span>()  <span class="co"># Move AK and HI</span></span>
<span id="cb16-159"><a href="#cb16-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-160"><a href="#cb16-160" aria-hidden="true" tabindex="-1"></a>us_states <span class="ot">&lt;-</span> <span class="fu">states</span>(<span class="at">year =</span> <span class="dv">2016</span>, <span class="at">cb =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb16-161"><a href="#cb16-161" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">as.numeric</span>(STATEFP) <span class="sc">&lt;=</span> <span class="dv">56</span>) <span class="sc">|&gt;</span> </span>
<span id="cb16-162"><a href="#cb16-162" aria-hidden="true" tabindex="-1"></a>  <span class="fu">shift_geometry</span>()  <span class="co"># Move AK and HI</span></span>
<span id="cb16-163"><a href="#cb16-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-164"><a href="#cb16-164" aria-hidden="true" tabindex="-1"></a><span class="co"># Join BLS data to the map</span></span>
<span id="cb16-165"><a href="#cb16-165" aria-hidden="true" tabindex="-1"></a>counties_with_unemp <span class="ot">&lt;-</span> us_counties <span class="sc">|&gt;</span></span>
<span id="cb16-166"><a href="#cb16-166" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(bls_2016, <span class="at">by =</span> <span class="fu">join_by</span>(STATEFP, COUNTYFP))</span>
<span id="cb16-167"><a href="#cb16-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-168"><a href="#cb16-168" aria-hidden="true" tabindex="-1"></a><span class="co"># Check out the joined data</span></span>
<span id="cb16-169"><a href="#cb16-169" aria-hidden="true" tabindex="-1"></a>counties_with_unemp <span class="sc">|&gt;</span> </span>
<span id="cb16-170"><a href="#cb16-170" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(STATEFP, COUNTYFP, county_name_state, unemp_truncated, geometry)</span>
<span id="cb16-171"><a href="#cb16-171" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-172"><a href="#cb16-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-173"><a href="#cb16-173" aria-hidden="true" tabindex="-1"></a>The map works!</span>
<span id="cb16-174"><a href="#cb16-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-177"><a href="#cb16-177" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb16-178"><a href="#cb16-178" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: plot-basic map</span></span>
<span id="cb16-179"><a href="#cb16-179" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 7</span></span>
<span id="cb16-180"><a href="#cb16-180" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 5</span></span>
<span id="cb16-181"><a href="#cb16-181" aria-hidden="true" tabindex="-1"></a><span class="co">#| out-width: 100%</span></span>
<span id="cb16-182"><a href="#cb16-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-183"><a href="#cb16-183" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb16-184"><a href="#cb16-184" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> us_states, <span class="at">fill =</span> <span class="st">"#0074D9"</span>, <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">linewidth =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb16-185"><a href="#cb16-185" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Albers projection</span></span>
<span id="cb16-186"><a href="#cb16-186" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">crs =</span> <span class="fu">st_crs</span>(<span class="st">"ESRI:102003"</span>))</span>
<span id="cb16-187"><a href="#cb16-187" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-188"><a href="#cb16-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-189"><a href="#cb16-189" aria-hidden="true" tabindex="-1"></a><span class="fu">## Map adjustments</span></span>
<span id="cb16-190"><a href="#cb16-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-191"><a href="#cb16-191" aria-hidden="true" tabindex="-1"></a>We need to make a couple little adjustments to the map first. In the original image on Bluesky, there's extra space on the right side of the map to allow for the legend. We can change the plot window by adding 10% of the width of the map to the right. </span>
<span id="cb16-192"><a href="#cb16-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-193"><a href="#cb16-193" aria-hidden="true" tabindex="-1"></a>Technically we don't have to work with percents here; the data is currently using the Albers projection, which works in meters, so we could add something like 500,000 meters / 500 km to the left. But this is a more general solution and also works if the map data is in decimal degrees instead of meters.</span>
<span id="cb16-194"><a href="#cb16-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-195"><a href="#cb16-195" aria-hidden="true" tabindex="-1"></a>Also, the far western Aleutian islands mess with the visual balance of the map (and they don't appear because they're so small), so we'll also subtract 10% of the map from the left.</span>
<span id="cb16-196"><a href="#cb16-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-199"><a href="#cb16-199" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb16-200"><a href="#cb16-200" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: plot-shifted-window</span></span>
<span id="cb16-201"><a href="#cb16-201" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 7</span></span>
<span id="cb16-202"><a href="#cb16-202" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 5</span></span>
<span id="cb16-203"><a href="#cb16-203" aria-hidden="true" tabindex="-1"></a><span class="co">#| out-width: 100%</span></span>
<span id="cb16-204"><a href="#cb16-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-205"><a href="#cb16-205" aria-hidden="true" tabindex="-1"></a><span class="co"># Get x-axis limits of the bounding box for the state data</span></span>
<span id="cb16-206"><a href="#cb16-206" aria-hidden="true" tabindex="-1"></a>xlim_current <span class="ot">&lt;-</span> <span class="fu">st_bbox</span>(us_states)<span class="sc">$</span>xlim</span>
<span id="cb16-207"><a href="#cb16-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-208"><a href="#cb16-208" aria-hidden="true" tabindex="-1"></a><span class="co"># Add 540ish km (or 10% of the US) to the bounds (thus shifting the window over)</span></span>
<span id="cb16-209"><a href="#cb16-209" aria-hidden="true" tabindex="-1"></a>xlim_expanded <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb16-210"><a href="#cb16-210" aria-hidden="true" tabindex="-1"></a>  xlim_current[<span class="dv">1</span>] <span class="sc">+</span> (<span class="fl">0.1</span> <span class="sc">*</span> <span class="fu">diff</span>(xlim_current)), </span>
<span id="cb16-211"><a href="#cb16-211" aria-hidden="true" tabindex="-1"></a>  xlim_current[<span class="dv">2</span>] <span class="sc">+</span> (<span class="fl">0.1</span> <span class="sc">*</span> <span class="fu">diff</span>(xlim_current))</span>
<span id="cb16-212"><a href="#cb16-212" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-213"><a href="#cb16-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-214"><a href="#cb16-214" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb16-215"><a href="#cb16-215" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> us_states, <span class="at">fill =</span> <span class="st">"#0074D9"</span>, <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">linewidth =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb16-216"><a href="#cb16-216" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">crs =</span> <span class="fu">st_crs</span>(<span class="st">"ESRI:102003"</span>), <span class="at">xlim =</span> xlim_expanded)</span>
<span id="cb16-217"><a href="#cb16-217" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-218"><a href="#cb16-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-219"><a href="#cb16-219" aria-hidden="true" tabindex="-1"></a><span class="fu">## Extract interior state borders</span></span>
<span id="cb16-220"><a href="#cb16-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-221"><a href="#cb16-221" aria-hidden="true" tabindex="-1"></a>Because we're using <span class="in">`color = "white", linewidth = 0.25`</span>, every state gets a thin white border. This causes some issues though. All the states that share borders actually get a thicker border, since a state's western border joins up with its neighbor's eastern border. Also, all the coastlines and islands get borders, which diminishes the landmass—especially on a white background.</span>
<span id="cb16-222"><a href="#cb16-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-223"><a href="#cb16-223" aria-hidden="true" tabindex="-1"></a>Like, look at <span class="co">[</span><span class="ot">Alaska's Aleutian Islands</span><span class="co">](https://en.wikipedia.org/wiki/Aleutian_Islands)</span>, or <span class="co">[</span><span class="ot">Hawai'i's smaller islands</span><span class="co">](https://en.wikipedia.org/wiki/List_of_islands_of_Hawaii#Northwestern_Hawaii_Islands)</span>, or Michigan's <span class="co">[</span><span class="ot">Les Cheneaux Islands</span><span class="co">](https://en.wikipedia.org/wiki/Les_Cheneaux_Islands)</span> and <span class="co">[</span><span class="ot">Isle Royale</span><span class="co">](https://en.wikipedia.org/wiki/Isle_Royale_National_Park)</span>, or <span class="co">[</span><span class="ot">California's Channel Islands</span><span class="co">]</span>(https://en.wikipedia.org/wiki/Channel_Islands_(California)), or the <span class="co">[</span><span class="ot">Florida Keys</span><span class="co">](https://en.wikipedia.org/wiki/Florida_Keys)</span>, or <span class="co">[</span><span class="ot">North Carolina's Outer Banks</span><span class="co">](https://en.wikipedia.org/wiki/Outer_Banks)</span>—they all basically disappear.</span>
<span id="cb16-224"><a href="#cb16-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-225"><a href="#cb16-225" aria-hidden="true" tabindex="-1"></a>To fix this, we can use <span class="in">`st_intersection()`</span> to identify the intersections of all the state shapes (see <span class="co">[</span><span class="ot">this</span><span class="co">](https://ikashnitsky.phd/2023/map-borders/)</span> and <span class="co">[</span><span class="ot">this</span><span class="co">](https://stackoverflow.com/a/57138069)</span> for more details)</span>
<span id="cb16-226"><a href="#cb16-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-227"><a href="#cb16-227" aria-hidden="true" tabindex="-1"></a>Now all the islands and coastlines have much better definition and the borders between states are truly sized at 0.25:</span>
<span id="cb16-228"><a href="#cb16-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-231"><a href="#cb16-231" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb16-232"><a href="#cb16-232" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: plot-interior-borders</span></span>
<span id="cb16-233"><a href="#cb16-233" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 7</span></span>
<span id="cb16-234"><a href="#cb16-234" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 5</span></span>
<span id="cb16-235"><a href="#cb16-235" aria-hidden="true" tabindex="-1"></a><span class="co">#| out-width: 100%</span></span>
<span id="cb16-236"><a href="#cb16-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-237"><a href="#cb16-237" aria-hidden="true" tabindex="-1"></a>interior_state_borders <span class="ot">&lt;-</span> <span class="fu">st_intersection</span>(us_states) <span class="sc">|&gt;</span></span>
<span id="cb16-238"><a href="#cb16-238" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n.overlaps <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb16-239"><a href="#cb16-239" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove weird points that st_intersection() adds</span></span>
<span id="cb16-240"><a href="#cb16-240" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>(<span class="fu">st_geometry_type</span>(geometry) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"POINT"</span>, <span class="st">"MULTIPOINT"</span>)))</span>
<span id="cb16-241"><a href="#cb16-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-242"><a href="#cb16-242" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb16-243"><a href="#cb16-243" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> us_states, <span class="at">fill =</span> <span class="st">"#0074D9"</span>, <span class="at">linewidth =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb16-244"><a href="#cb16-244" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> interior_state_borders, <span class="at">linewidth =</span> <span class="fl">0.25</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb16-245"><a href="#cb16-245" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">crs =</span> <span class="fu">st_crs</span>(<span class="st">"ESRI:102003"</span>), <span class="at">xlim =</span> xlim_expanded)</span>
<span id="cb16-246"><a href="#cb16-246" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-247"><a href="#cb16-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-248"><a href="#cb16-248" aria-hidden="true" tabindex="-1"></a><span class="fu"># Map with horizontal gradient step legend</span></span>
<span id="cb16-249"><a href="#cb16-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-250"><a href="#cb16-250" aria-hidden="true" tabindex="-1"></a>Now that we have cleaned and adjusted geographic and unemployment data, we can make a fancy map! Instead of building this sequentially, I've included all the code all at once, with lots of comments at each step.</span>
<span id="cb16-251"><a href="#cb16-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-252"><a href="#cb16-252" aria-hidden="true" tabindex="-1"></a>A few things to note:</span>
<span id="cb16-253"><a href="#cb16-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-254"><a href="#cb16-254" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`scale_fill_stepsn()`</span> lets you use <span class="co">[</span><span class="ot">distinct bins of color</span><span class="co">](https://ggplot2.tidyverse.org/reference/scale_steps.html)</span> instead of a continuous gradient</span>
<span id="cb16-255"><a href="#cb16-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-256"><a href="#cb16-256" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>We position the legend inside the plot with <span class="in">`theme(legend.position = "inside", legend.position.inside = c(0.86, 0.32))`</span>. Those <span class="in">`0.86, 0.32`</span> coordinates took a lot of tinkering to get! The units for <span class="in">`legend.position.inside`</span> are based on percentages of the plot, so the legend appears where x is 86% across and 32% up. **The position changes every time the plot dimensions change.** To make life easier as I played with different values, I used <span class="co">[</span><span class="ot">{ggview}</span><span class="co">](https://github.com/idmn/ggview)</span> to specify and lock in exact dimensions of the plot:</span>
<span id="cb16-257"><a href="#cb16-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-258"><a href="#cb16-258" aria-hidden="true" tabindex="-1"></a>  <span class="in">```{.r}</span></span>
<span id="cb16-259"><a href="#cb16-259" aria-hidden="true" tabindex="-1"></a><span class="in">  library(ggview)</span></span>
<span id="cb16-260"><a href="#cb16-260" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb16-261"><a href="#cb16-261" aria-hidden="true" tabindex="-1"></a><span class="in">  p &lt;- ggplot(...) +</span></span>
<span id="cb16-262"><a href="#cb16-262" aria-hidden="true" tabindex="-1"></a><span class="in">    geom_sf(...)</span></span>
<span id="cb16-263"><a href="#cb16-263" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb16-264"><a href="#cb16-264" aria-hidden="true" tabindex="-1"></a><span class="in">  p + canvas(7, 5)</span></span>
<span id="cb16-265"><a href="#cb16-265" aria-hidden="true" tabindex="-1"></a><span class="in">  ```</span></span>
<span id="cb16-266"><a href="#cb16-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-267"><a href="#cb16-267" aria-hidden="true" tabindex="-1"></a>  I'm not using <span class="in">`ggview::canvas()`</span> here in the post because I'm specifying figure dimensions with Quarto chunk options instead (<span class="in">`fig-width: 7`</span> and <span class="in">`fig-height: 5`</span>).</span>
<span id="cb16-268"><a href="#cb16-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-269"><a href="#cb16-269" aria-hidden="true" tabindex="-1"></a>Here's the map!</span>
<span id="cb16-270"><a href="#cb16-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-273"><a href="#cb16-273" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb16-274"><a href="#cb16-274" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: plot-horizontal-legend</span></span>
<span id="cb16-275"><a href="#cb16-275" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 7</span></span>
<span id="cb16-276"><a href="#cb16-276" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 5</span></span>
<span id="cb16-277"><a href="#cb16-277" aria-hidden="true" tabindex="-1"></a><span class="co">#| out-width: 100%</span></span>
<span id="cb16-278"><a href="#cb16-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-279"><a href="#cb16-279" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb16-280"><a href="#cb16-280" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add counties filled with unemployment levels</span></span>
<span id="cb16-281"><a href="#cb16-281" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb16-282"><a href="#cb16-282" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> counties_with_unemp, <span class="fu">aes</span>(<span class="at">fill =</span> unemp_truncated), <span class="at">linewidth =</span> <span class="dv">0</span></span>
<span id="cb16-283"><a href="#cb16-283" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb16-284"><a href="#cb16-284" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add interior state boundaries</span></span>
<span id="cb16-285"><a href="#cb16-285" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb16-286"><a href="#cb16-286" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> interior_state_borders, <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">linewidth =</span> <span class="fl">0.25</span></span>
<span id="cb16-287"><a href="#cb16-287" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb16-288"><a href="#cb16-288" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Show the unemployment legend as steps instead of a standard gradient</span></span>
<span id="cb16-289"><a href="#cb16-289" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_stepsn</span>(</span>
<span id="cb16-290"><a href="#cb16-290" aria-hidden="true" tabindex="-1"></a>    <span class="at">colours =</span> scales<span class="sc">::</span><span class="fu">brewer_pal</span>(<span class="at">palette =</span> <span class="st">"YlGnBu"</span>)(<span class="dv">9</span>),</span>
<span id="cb16-291"><a href="#cb16-291" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,</span>
<span id="cb16-292"><a href="#cb16-292" aria-hidden="true" tabindex="-1"></a>    <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">10</span>),</span>
<span id="cb16-293"><a href="#cb16-293" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Change the label for &gt;9%</span></span>
<span id="cb16-294"><a href="#cb16-294" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">case_match</span>(</span>
<span id="cb16-295"><a href="#cb16-295" aria-hidden="true" tabindex="-1"></a>      <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,</span>
<span id="cb16-296"><a href="#cb16-296" aria-hidden="true" tabindex="-1"></a>      <span class="dv">1</span> <span class="sc">~</span> <span class="st">"1%"</span>,</span>
<span id="cb16-297"><a href="#cb16-297" aria-hidden="true" tabindex="-1"></a>      <span class="dv">10</span> <span class="sc">~</span> <span class="st">"&gt;9%"</span>,</span>
<span id="cb16-298"><a href="#cb16-298" aria-hidden="true" tabindex="-1"></a>      <span class="at">.default =</span> <span class="fu">as.character</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb16-299"><a href="#cb16-299" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-300"><a href="#cb16-300" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb16-301"><a href="#cb16-301" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Yay labels</span></span>
<span id="cb16-302"><a href="#cb16-302" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb16-303"><a href="#cb16-303" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"US unemployment rates"</span>,</span>
<span id="cb16-304"><a href="#cb16-304" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"2016 annual averages by county"</span>,</span>
<span id="cb16-305"><a href="#cb16-305" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Source: US Bureau of Labor Statistics"</span>,</span>
<span id="cb16-306"><a href="#cb16-306" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Unemployment rate"</span></span>
<span id="cb16-307"><a href="#cb16-307" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb16-308"><a href="#cb16-308" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use Albers projection and new x-axis limits</span></span>
<span id="cb16-309"><a href="#cb16-309" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">crs =</span> <span class="fu">st_crs</span>(<span class="st">"ESRI:102003"</span>), <span class="at">xlim =</span> xlim_expanded) <span class="sc">+</span></span>
<span id="cb16-310"><a href="#cb16-310" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Theme adjustments</span></span>
<span id="cb16-311"><a href="#cb16-311" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_fancy_map</span>() <span class="sc">+</span></span>
<span id="cb16-312"><a href="#cb16-312" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb16-313"><a href="#cb16-313" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"inside"</span>,</span>
<span id="cb16-314"><a href="#cb16-314" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position.inside =</span> <span class="fu">c</span>(<span class="fl">0.86</span>, <span class="fl">0.32</span>),</span>
<span id="cb16-315"><a href="#cb16-315" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.direction =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb16-316"><a href="#cb16-316" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="fu">rel</span>(<span class="fl">0.55</span>)),</span>
<span id="cb16-317"><a href="#cb16-317" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="fu">rel</span>(<span class="fl">0.7</span>), <span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">t =</span> <span class="dv">3</span>)),</span>
<span id="cb16-318"><a href="#cb16-318" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb16-319"><a href="#cb16-319" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.key.width =</span> <span class="fu">unit</span>(<span class="fl">1.55</span>, <span class="st">"lines"</span>),</span>
<span id="cb16-320"><a href="#cb16-320" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.key.height =</span> <span class="fu">unit</span>(<span class="fl">0.7</span>, <span class="st">"lines"</span>)</span>
<span id="cb16-321"><a href="#cb16-321" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-322"><a href="#cb16-322" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-323"><a href="#cb16-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-324"><a href="#cb16-324" aria-hidden="true" tabindex="-1"></a><span class="fu"># Map with histogram legend</span></span>
<span id="cb16-325"><a href="#cb16-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-326"><a href="#cb16-326" aria-hidden="true" tabindex="-1"></a>We can replace the step gradient legend with a histogram that is filled using the same colors as the step legend. </span>
<span id="cb16-327"><a href="#cb16-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-328"><a href="#cb16-328" aria-hidden="true" tabindex="-1"></a>The easiest method that gives us the most control over the legend histogram is to create a separate plot object for the histogram and place it inside the map with <span class="co">[</span><span class="ot">{patchwork}'s `inset_element()`</span><span class="co">](https://patchwork.data-imaginist.com/articles/guides/layout.html#insets)</span>. </span>
<span id="cb16-329"><a href="#cb16-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-330"><a href="#cb16-330" aria-hidden="true" tabindex="-1"></a>Here's the histogram, again with comments at each step. Only one neat trick to note here:</span>
<span id="cb16-331"><a href="#cb16-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-332"><a href="#cb16-332" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`geom_histogram`</span> automatically determines the bin width for the variable assigned to the x aesthetic. In order to fill each bar by bin-specific color, we need to access information about those newly created bins. <span class="co">[</span><span class="ot">We can do this with `after_stat()`</span><span class="co">](https://yjunechoe.github.io/posts/2022-03-10-ggplot2-delayed-aes-1/)</span>—here we fill each bar using the already-calculated x bin categories with <span class="in">`fill = after_stat(factor(x))`</span></span>
<span id="cb16-333"><a href="#cb16-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-336"><a href="#cb16-336" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb16-337"><a href="#cb16-337" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: plot-histogram-legend-alone</span></span>
<span id="cb16-338"><a href="#cb16-338" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 3</span></span>
<span id="cb16-339"><a href="#cb16-339" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 1.4</span></span>
<span id="cb16-340"><a href="#cb16-340" aria-hidden="true" tabindex="-1"></a><span class="co">#| out-width: 70%</span></span>
<span id="cb16-341"><a href="#cb16-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-342"><a href="#cb16-342" aria-hidden="true" tabindex="-1"></a>hist_legend <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(bls_2016, <span class="fu">aes</span>(<span class="at">x =</span> unemp_truncated)) <span class="sc">+</span></span>
<span id="cb16-343"><a href="#cb16-343" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fill each histogram bar using the x axis category that ggplot creates</span></span>
<span id="cb16-344"><a href="#cb16-344" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(</span>
<span id="cb16-345"><a href="#cb16-345" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">fill =</span> <span class="fu">after_stat</span>(<span class="fu">factor</span>(x))), </span>
<span id="cb16-346"><a href="#cb16-346" aria-hidden="true" tabindex="-1"></a>    <span class="at">binwidth =</span> <span class="dv">1</span>, <span class="at">boundary =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"white"</span></span>
<span id="cb16-347"><a href="#cb16-347" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb16-348"><a href="#cb16-348" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fill with the same palette as the map</span></span>
<span id="cb16-349"><a href="#cb16-349" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"YlGnBu"</span>, <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb16-350"><a href="#cb16-350" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Modify the x-axis labels to use &gt;9%</span></span>
<span id="cb16-351"><a href="#cb16-351" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(</span>
<span id="cb16-352"><a href="#cb16-352" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">10</span>, </span>
<span id="cb16-353"><a href="#cb16-353" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">case_match</span>(</span>
<span id="cb16-354"><a href="#cb16-354" aria-hidden="true" tabindex="-1"></a>      <span class="dv">2</span><span class="sc">:</span><span class="dv">10</span>,</span>
<span id="cb16-355"><a href="#cb16-355" aria-hidden="true" tabindex="-1"></a>      <span class="dv">2</span> <span class="sc">~</span> <span class="st">"2%"</span>,</span>
<span id="cb16-356"><a href="#cb16-356" aria-hidden="true" tabindex="-1"></a>      <span class="dv">10</span> <span class="sc">~</span> <span class="st">"&gt;9%"</span>,</span>
<span id="cb16-357"><a href="#cb16-357" aria-hidden="true" tabindex="-1"></a>      <span class="at">.default =</span> <span class="fu">as.character</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb16-358"><a href="#cb16-358" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-359"><a href="#cb16-359" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb16-360"><a href="#cb16-360" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Just one label to replicate the legend title</span></span>
<span id="cb16-361"><a href="#cb16-361" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Unemployment rate"</span>) <span class="sc">+</span></span>
<span id="cb16-362"><a href="#cb16-362" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Theme adjustments</span></span>
<span id="cb16-363"><a href="#cb16-363" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_fancy_map</span>() <span class="sc">+</span></span>
<span id="cb16-364"><a href="#cb16-364" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb16-365"><a href="#cb16-365" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="fu">rel</span>(<span class="fl">0.55</span>)),</span>
<span id="cb16-366"><a href="#cb16-366" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="fu">rel</span>(<span class="fl">0.68</span>), <span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">t =</span> <span class="dv">3</span>, <span class="at">b =</span> <span class="dv">3</span>), <span class="at">face =</span> <span class="st">"bold"</span>)</span>
<span id="cb16-367"><a href="#cb16-367" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-368"><a href="#cb16-368" aria-hidden="true" tabindex="-1"></a>hist_legend</span>
<span id="cb16-369"><a href="#cb16-369" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-370"><a href="#cb16-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-371"><a href="#cb16-371" aria-hidden="true" tabindex="-1"></a>Next, we'll place that <span class="in">`hist_legend`</span> plot inside a map with <span class="in">`inset_element()`</span>. Like <span class="in">`legend.position.inside = c(0.86, 0.32)`</span> in the previous map, the <span class="in">`left = 0.75, bottom = 0.26, right = 0.98, top = 0.5`</span> values here are percentages of the plot area and they're fully dependent on the overall dimensions of the plot. Getting these exact numbers took a lot of manual adjusting, and <span class="in">`ggview::canvas()`</span> was once again indispensable for keeping the plot dimensions constant.</span>
<span id="cb16-372"><a href="#cb16-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-375"><a href="#cb16-375" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb16-376"><a href="#cb16-376" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: plot-histogram-legend</span></span>
<span id="cb16-377"><a href="#cb16-377" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 7</span></span>
<span id="cb16-378"><a href="#cb16-378" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 5</span></span>
<span id="cb16-379"><a href="#cb16-379" aria-hidden="true" tabindex="-1"></a><span class="co">#| out-width: 100%</span></span>
<span id="cb16-380"><a href="#cb16-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-381"><a href="#cb16-381" aria-hidden="true" tabindex="-1"></a>unemp_map <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb16-382"><a href="#cb16-382" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add counties filled with unemployment levels</span></span>
<span id="cb16-383"><a href="#cb16-383" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb16-384"><a href="#cb16-384" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> counties_with_unemp, <span class="fu">aes</span>(<span class="at">fill =</span> unemp_truncated), <span class="at">color =</span> <span class="cn">NA</span>, <span class="at">linewidth =</span> <span class="dv">0</span></span>
<span id="cb16-385"><a href="#cb16-385" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb16-386"><a href="#cb16-386" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add interior state boundaries</span></span>
<span id="cb16-387"><a href="#cb16-387" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb16-388"><a href="#cb16-388" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> interior_state_borders, <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">linewidth =</span> <span class="fl">0.25</span>, <span class="at">fill =</span> <span class="cn">NA</span></span>
<span id="cb16-389"><a href="#cb16-389" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb16-390"><a href="#cb16-390" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Show the unemployment legend as steps instead of a standard gradient, but</span></span>
<span id="cb16-391"><a href="#cb16-391" aria-hidden="true" tabindex="-1"></a>  <span class="co"># don't actually show the legend</span></span>
<span id="cb16-392"><a href="#cb16-392" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_stepsn</span>(</span>
<span id="cb16-393"><a href="#cb16-393" aria-hidden="true" tabindex="-1"></a>    <span class="at">colours =</span> scales<span class="sc">::</span><span class="fu">brewer_pal</span>(<span class="at">palette =</span> <span class="st">"YlGnBu"</span>)(<span class="dv">9</span>),</span>
<span id="cb16-394"><a href="#cb16-394" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, </span>
<span id="cb16-395"><a href="#cb16-395" aria-hidden="true" tabindex="-1"></a>    <span class="at">guide =</span> <span class="st">"none"</span></span>
<span id="cb16-396"><a href="#cb16-396" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb16-397"><a href="#cb16-397" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Yay labels</span></span>
<span id="cb16-398"><a href="#cb16-398" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb16-399"><a href="#cb16-399" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"US unemployment rates"</span>,</span>
<span id="cb16-400"><a href="#cb16-400" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"2016 annual averages by county"</span>,</span>
<span id="cb16-401"><a href="#cb16-401" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Source: US Bureau of Labor Statistics"</span></span>
<span id="cb16-402"><a href="#cb16-402" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb16-403"><a href="#cb16-403" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use Albers projection and new x-axis limits</span></span>
<span id="cb16-404"><a href="#cb16-404" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">crs =</span> <span class="fu">st_crs</span>(<span class="st">"ESRI:102003"</span>), <span class="at">xlim =</span> xlim_expanded) <span class="sc">+</span></span>
<span id="cb16-405"><a href="#cb16-405" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Theme stuff</span></span>
<span id="cb16-406"><a href="#cb16-406" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_fancy_map</span>()</span>
<span id="cb16-407"><a href="#cb16-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-408"><a href="#cb16-408" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the histogram to the map</span></span>
<span id="cb16-409"><a href="#cb16-409" aria-hidden="true" tabindex="-1"></a>combined_map_hist <span class="ot">&lt;-</span> unemp_map <span class="sc">+</span> </span>
<span id="cb16-410"><a href="#cb16-410" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inset_element</span>(hist_legend, <span class="at">left =</span> <span class="fl">0.75</span>, <span class="at">bottom =</span> <span class="fl">0.26</span>, <span class="at">right =</span> <span class="fl">0.98</span>, <span class="at">top =</span> <span class="fl">0.45</span>)</span>
<span id="cb16-411"><a href="#cb16-411" aria-hidden="true" tabindex="-1"></a>combined_map_hist</span>
<span id="cb16-412"><a href="#cb16-412" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-413"><a href="#cb16-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-414"><a href="#cb16-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-415"><a href="#cb16-415" aria-hidden="true" tabindex="-1"></a><span class="fu"># Map with automatic histogram legend with {legendry}</span></span>
<span id="cb16-416"><a href="#cb16-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-417"><a href="#cb16-417" aria-hidden="true" tabindex="-1"></a>Finally, <span class="co">[</span><span class="ot">the new {legendry} package</span><span class="co">](https://teunbrand.github.io/legendry/)</span> makes it so we can create a custom histogram-based legend without needing to use {patchwork} with a separate histogram plot!</span>
<span id="cb16-418"><a href="#cb16-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-419"><a href="#cb16-419" aria-hidden="true" tabindex="-1"></a>It doesn't provide as much control over the resulting histogram. The <span class="in">`gizmo_histogram()`</span> function uses base R's <span class="in">`hist()`</span> behind the scenes, so we have to specify bin widths and other settings in <span class="in">`hist.arg`</span> as base R arguments, like <span class="in">`breaks = 10`</span> instead of ggplot's <span class="in">`binwidth = 10`</span>. </span>
<span id="cb16-420"><a href="#cb16-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-421"><a href="#cb16-421" aria-hidden="true" tabindex="-1"></a>Not all of <span class="in">`hist()`</span>'s options seem to work here. For instance, I get a warning if I use <span class="in">`border = "white"`</span> to add a white border around each bar (<span class="in">`argument ‘border’ is not made use of`</span>), since that border option is disabled when using base R's <span class="in">`hist()`</span> with <span class="in">`plot = FALSE`</span>:</span>
<span id="cb16-422"><a href="#cb16-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-425"><a href="#cb16-425" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb16-426"><a href="#cb16-426" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: hist-warning</span></span>
<span id="cb16-427"><a href="#cb16-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-428"><a href="#cb16-428" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(counties_with_unemp<span class="sc">$</span>unemp_truncated, <span class="at">breaks =</span> <span class="dv">10</span>, <span class="at">border =</span> <span class="st">"white"</span>, <span class="at">plot =</span> <span class="cn">FALSE</span>)</span>
<span id="cb16-429"><a href="#cb16-429" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-430"><a href="#cb16-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-431"><a href="#cb16-431" aria-hidden="true" tabindex="-1"></a>Also, it's currently filling each histogram bar with the full gradient, not the 9 distinct steps, and I can't figure out how to define custom colors for each bar—and it might not even be possible since color settings aren't picked up anyway because of {legendry}'s use of <span class="in">`plot = FALSE`</span> 🤷‍♂️.</span>
<span id="cb16-432"><a href="#cb16-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-433"><a href="#cb16-433" aria-hidden="true" tabindex="-1"></a>But despite these downsides, this automatic histogram legend with {legendry} is really neat!</span>
<span id="cb16-434"><a href="#cb16-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-437"><a href="#cb16-437" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb16-438"><a href="#cb16-438" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: plot-histogram-legend-legendry</span></span>
<span id="cb16-439"><a href="#cb16-439" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 7</span></span>
<span id="cb16-440"><a href="#cb16-440" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 5</span></span>
<span id="cb16-441"><a href="#cb16-441" aria-hidden="true" tabindex="-1"></a><span class="co">#| out-width: 100%</span></span>
<span id="cb16-442"><a href="#cb16-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-443"><a href="#cb16-443" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(legendry)</span>
<span id="cb16-444"><a href="#cb16-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-445"><a href="#cb16-445" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a custom histogram guide</span></span>
<span id="cb16-446"><a href="#cb16-446" aria-hidden="true" tabindex="-1"></a>histogram_guide <span class="ot">&lt;-</span> <span class="fu">compose_sandwich</span>(</span>
<span id="cb16-447"><a href="#cb16-447" aria-hidden="true" tabindex="-1"></a>  <span class="at">middle =</span> <span class="fu">gizmo_histogram</span>(<span class="at">just =</span> <span class="dv">0</span>, <span class="at">hist.arg =</span> <span class="fu">list</span>(<span class="at">breaks =</span> <span class="dv">10</span>)),</span>
<span id="cb16-448"><a href="#cb16-448" aria-hidden="true" tabindex="-1"></a>  <span class="at">text =</span> <span class="st">"axis_base"</span></span>
<span id="cb16-449"><a href="#cb16-449" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-450"><a href="#cb16-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-451"><a href="#cb16-451" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb16-452"><a href="#cb16-452" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add counties filled with unemployment levels</span></span>
<span id="cb16-453"><a href="#cb16-453" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb16-454"><a href="#cb16-454" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> counties_with_unemp, <span class="fu">aes</span>(<span class="at">fill =</span> unemp_truncated), <span class="at">color =</span> <span class="cn">NA</span>, <span class="at">linewidth =</span> <span class="dv">0</span></span>
<span id="cb16-455"><a href="#cb16-455" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb16-456"><a href="#cb16-456" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add interior state boundaries</span></span>
<span id="cb16-457"><a href="#cb16-457" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb16-458"><a href="#cb16-458" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> interior_state_borders, <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">linewidth =</span> <span class="fl">0.25</span>, <span class="at">fill =</span> <span class="cn">NA</span></span>
<span id="cb16-459"><a href="#cb16-459" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb16-460"><a href="#cb16-460" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Show the unemployment legend with a custom histogram guide</span></span>
<span id="cb16-461"><a href="#cb16-461" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_stepsn</span>(</span>
<span id="cb16-462"><a href="#cb16-462" aria-hidden="true" tabindex="-1"></a>    <span class="at">colours =</span> scales<span class="sc">::</span><span class="fu">brewer_pal</span>(<span class="at">palette =</span> <span class="st">"YlGnBu"</span>)(<span class="dv">9</span>),</span>
<span id="cb16-463"><a href="#cb16-463" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,</span>
<span id="cb16-464"><a href="#cb16-464" aria-hidden="true" tabindex="-1"></a>    <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">10</span>),</span>
<span id="cb16-465"><a href="#cb16-465" aria-hidden="true" tabindex="-1"></a>    <span class="at">guide =</span> histogram_guide,</span>
<span id="cb16-466"><a href="#cb16-466" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Change the label for &gt;9%</span></span>
<span id="cb16-467"><a href="#cb16-467" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">case_match</span>(</span>
<span id="cb16-468"><a href="#cb16-468" aria-hidden="true" tabindex="-1"></a>      <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,</span>
<span id="cb16-469"><a href="#cb16-469" aria-hidden="true" tabindex="-1"></a>      <span class="dv">1</span> <span class="sc">~</span> <span class="st">"1%"</span>,</span>
<span id="cb16-470"><a href="#cb16-470" aria-hidden="true" tabindex="-1"></a>      <span class="dv">10</span> <span class="sc">~</span> <span class="st">"&gt;9%"</span>,</span>
<span id="cb16-471"><a href="#cb16-471" aria-hidden="true" tabindex="-1"></a>      <span class="at">.default =</span> <span class="fu">as.character</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb16-472"><a href="#cb16-472" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-473"><a href="#cb16-473" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb16-474"><a href="#cb16-474" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Yay labels</span></span>
<span id="cb16-475"><a href="#cb16-475" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb16-476"><a href="#cb16-476" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"US unemployment rates"</span>,</span>
<span id="cb16-477"><a href="#cb16-477" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"2016 annual averages by county"</span>,</span>
<span id="cb16-478"><a href="#cb16-478" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Source: US Bureau of Labor Statistics"</span>,</span>
<span id="cb16-479"><a href="#cb16-479" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Unemployment rate"</span></span>
<span id="cb16-480"><a href="#cb16-480" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb16-481"><a href="#cb16-481" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use Albers projection and new x-axis limits</span></span>
<span id="cb16-482"><a href="#cb16-482" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">crs =</span> <span class="fu">st_crs</span>(<span class="st">"ESRI:102003"</span>), <span class="at">xlim =</span> xlim_expanded) <span class="sc">+</span></span>
<span id="cb16-483"><a href="#cb16-483" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Theme stuff</span></span>
<span id="cb16-484"><a href="#cb16-484" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_fancy_map</span>() <span class="sc">+</span></span>
<span id="cb16-485"><a href="#cb16-485" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb16-486"><a href="#cb16-486" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"inside"</span>,</span>
<span id="cb16-487"><a href="#cb16-487" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position.inside =</span> <span class="fu">c</span>(<span class="fl">0.86</span>, <span class="fl">0.32</span>),</span>
<span id="cb16-488"><a href="#cb16-488" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.direction =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb16-489"><a href="#cb16-489" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="fu">rel</span>(<span class="fl">0.55</span>)),</span>
<span id="cb16-490"><a href="#cb16-490" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="fu">rel</span>(<span class="fl">0.7</span>), <span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">t =</span> <span class="dv">3</span>)),</span>
<span id="cb16-491"><a href="#cb16-491" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title.position =</span> <span class="st">"bottom"</span></span>
<span id="cb16-492"><a href="#cb16-492" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-493"><a href="#cb16-493" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-494"><a href="#cb16-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-495"><a href="#cb16-495" aria-hidden="true" tabindex="-1"></a><span class="fu"># Bonus! Use points instead of choropleths</span></span>
<span id="cb16-496"><a href="#cb16-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-497"><a href="#cb16-497" aria-hidden="true" tabindex="-1"></a>We're still using choropleth maps here, which still isn't ideal for showing the idea that "land isn't unemployed". One solution is to plot points that are sized by population. This is pretty straightforward with {sf}—we need to convert the county polygons into single points, which we can do with <span class="in">`st_point_on_surface()`</span>. Then, after a bunch of tinkering with legend options, we'll have this gorgeous map:</span>
<span id="cb16-498"><a href="#cb16-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-501"><a href="#cb16-501" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb16-502"><a href="#cb16-502" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: plot-histogram-points</span></span>
<span id="cb16-503"><a href="#cb16-503" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 7</span></span>
<span id="cb16-504"><a href="#cb16-504" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 5</span></span>
<span id="cb16-505"><a href="#cb16-505" aria-hidden="true" tabindex="-1"></a><span class="co">#| out-width: 100%</span></span>
<span id="cb16-506"><a href="#cb16-506" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb16-507"><a href="#cb16-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-508"><a href="#cb16-508" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the county polygons into single points</span></span>
<span id="cb16-509"><a href="#cb16-509" aria-hidden="true" tabindex="-1"></a>counties_with_unemp_points <span class="ot">&lt;-</span> counties_with_unemp <span class="sc">|&gt;</span> </span>
<span id="cb16-510"><a href="#cb16-510" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_point_on_surface</span>()</span>
<span id="cb16-511"><a href="#cb16-511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-512"><a href="#cb16-512" aria-hidden="true" tabindex="-1"></a>unemp_map_points <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb16-513"><a href="#cb16-513" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use a gray background</span></span>
<span id="cb16-514"><a href="#cb16-514" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> us_states, <span class="at">fill =</span> <span class="st">"gray90"</span>, <span class="at">linewidth =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb16-515"><a href="#cb16-515" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> interior_state_borders, <span class="at">linewidth =</span> <span class="fl">0.25</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb16-516"><a href="#cb16-516" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Include semi-transparent points with shape 21 (so there's a border)</span></span>
<span id="cb16-517"><a href="#cb16-517" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb16-518"><a href="#cb16-518" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> counties_with_unemp_points, </span>
<span id="cb16-519"><a href="#cb16-519" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">size =</span> labor_force, <span class="at">fill =</span> unemp_truncated), </span>
<span id="cb16-520"><a href="#cb16-520" aria-hidden="true" tabindex="-1"></a>    <span class="at">pch =</span> <span class="dv">21</span>, <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">stroke =</span> <span class="fl">0.25</span>, <span class="at">alpha =</span> <span class="fl">0.8</span></span>
<span id="cb16-521"><a href="#cb16-521" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb16-522"><a href="#cb16-522" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Control the size of the points in the legend</span></span>
<span id="cb16-523"><a href="#cb16-523" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size_continuous</span>(</span>
<span id="cb16-524"><a href="#cb16-524" aria-hidden="true" tabindex="-1"></a>    <span class="at">range =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">9</span>), <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_comma</span>(), </span>
<span id="cb16-525"><a href="#cb16-525" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">10000</span>, <span class="dv">100000</span>, <span class="dv">1000000</span>),</span>
<span id="cb16-526"><a href="#cb16-526" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Make the points black and not have a border</span></span>
<span id="cb16-527"><a href="#cb16-527" aria-hidden="true" tabindex="-1"></a>    <span class="at">guide =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">pch =</span> <span class="dv">19</span>, <span class="at">color =</span> <span class="st">"black"</span>))</span>
<span id="cb16-528"><a href="#cb16-528" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb16-529"><a href="#cb16-529" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Show the unemployment legend as steps instead of a standard gradient, but</span></span>
<span id="cb16-530"><a href="#cb16-530" aria-hidden="true" tabindex="-1"></a>  <span class="co"># don't actually show the legend</span></span>
<span id="cb16-531"><a href="#cb16-531" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_stepsn</span>(</span>
<span id="cb16-532"><a href="#cb16-532" aria-hidden="true" tabindex="-1"></a>    <span class="at">colours =</span> scales<span class="sc">::</span><span class="fu">brewer_pal</span>(<span class="at">palette =</span> <span class="st">"YlGnBu"</span>)(<span class="dv">9</span>),</span>
<span id="cb16-533"><a href="#cb16-533" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, </span>
<span id="cb16-534"><a href="#cb16-534" aria-hidden="true" tabindex="-1"></a>    <span class="at">guide =</span> <span class="st">"none"</span></span>
<span id="cb16-535"><a href="#cb16-535" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb16-536"><a href="#cb16-536" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Labels</span></span>
<span id="cb16-537"><a href="#cb16-537" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb16-538"><a href="#cb16-538" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"US unemployment rates"</span>,</span>
<span id="cb16-539"><a href="#cb16-539" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"2016 annual averages by county"</span>,</span>
<span id="cb16-540"><a href="#cb16-540" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Source: US Bureau of Labor Statistics"</span>,</span>
<span id="cb16-541"><a href="#cb16-541" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Unemployment rate"</span>,</span>
<span id="cb16-542"><a href="#cb16-542" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="st">"Labor force"</span></span>
<span id="cb16-543"><a href="#cb16-543" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb16-544"><a href="#cb16-544" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Albers</span></span>
<span id="cb16-545"><a href="#cb16-545" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">crs =</span> <span class="fu">st_crs</span>(<span class="st">"ESRI:102003"</span>), <span class="at">xlim =</span> xlim_expanded) <span class="sc">+</span></span>
<span id="cb16-546"><a href="#cb16-546" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Theme stuff</span></span>
<span id="cb16-547"><a href="#cb16-547" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_fancy_map</span>() <span class="sc">+</span></span>
<span id="cb16-548"><a href="#cb16-548" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb16-549"><a href="#cb16-549" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"inside"</span>,</span>
<span id="cb16-550"><a href="#cb16-550" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position.inside =</span> <span class="fu">c</span>(<span class="fl">0.837</span>, <span class="fl">0.13</span>),</span>
<span id="cb16-551"><a href="#cb16-551" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="fu">rel</span>(<span class="fl">0.55</span>)),</span>
<span id="cb16-552"><a href="#cb16-552" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="fu">rel</span>(<span class="fl">0.7</span>), <span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">t =</span> <span class="dv">3</span>)),</span>
<span id="cb16-553"><a href="#cb16-553" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title.position =</span> <span class="st">"bottom"</span></span>
<span id="cb16-554"><a href="#cb16-554" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-555"><a href="#cb16-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-556"><a href="#cb16-556" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the histogram to the map</span></span>
<span id="cb16-557"><a href="#cb16-557" aria-hidden="true" tabindex="-1"></a>combined_map_hist_points <span class="ot">&lt;-</span> unemp_map_points <span class="sc">+</span> </span>
<span id="cb16-558"><a href="#cb16-558" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inset_element</span>(hist_legend, <span class="at">left =</span> <span class="fl">0.75</span>, <span class="at">bottom =</span> <span class="fl">0.26</span>, <span class="at">right =</span> <span class="fl">0.98</span>, <span class="at">top =</span> <span class="fl">0.45</span>)</span>
<span id="cb16-559"><a href="#cb16-559" aria-hidden="true" tabindex="-1"></a>combined_map_hist_points</span>
<span id="cb16-560"><a href="#cb16-560" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-561"><a href="#cb16-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-562"><a href="#cb16-562" aria-hidden="true" tabindex="-1"></a><span class="fu"># Bonus #2! Use a diverging color scheme + nested legend circles</span></span>
<span id="cb16-563"><a href="#cb16-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-564"><a href="#cb16-564" aria-hidden="true" tabindex="-1"></a>But wait, there's more! Based on discussions with really smart dataviz people on Bluesky in the wake of <span class="co">[</span><span class="ot">me posting about this blog post there</span><span class="co">](https://bsky.app/profile/andrew.heiss.phd/post/3like2os2d22c)</span>, we can make two additional tweaks:</span>
<span id="cb16-565"><a href="#cb16-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-566"><a href="#cb16-566" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>While the different sizes for the points are neat, I'm not a fan of how big the vertical spacing is between the 10,000; 100,000; and 1,000,000. Unfortunately there's no way to change it. Technically we can use <span class="in">`legend.key.spacing.y`</span> in <span class="in">`theme()`</span> to adjust it, but that doesn't work as expected here because each of those legend entries is sized to match the largest point—i.e., the point for 1,000,000 is the biggest, so the legend entries for all the other values match its height, even if they don't need all that space.</span>
<span id="cb16-567"><a href="#cb16-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-568"><a href="#cb16-568" aria-hidden="true" tabindex="-1"></a>  To fix this, we can use <span class="in">`guide_circles()`</span> from {legendry} to show the different point sizes as coencentric circles, which is more compact (and just looks neat).</span>
<span id="cb16-569"><a href="#cb16-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-570"><a href="#cb16-570" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Instead of showing a range of low → high values, <span class="co">[</span><span class="ot">we can color these counties based on a meaningful midpoint</span><span class="co">](https://bsky.app/profile/abmakulec.bsky.social/post/3limfykl2i22n)</span> to help highlight which counties are doing great (low unemployment! good!) and which aren't (high unemployment! bad!). That might not always necessarily be the best approach—showing the full range of actual values like in the original map is a way of just describing the range and doesn't inherently imply good or bad. But in other plots where data might be more actionable, divergences from some central value would be much more helpful.</span>
<span id="cb16-571"><a href="#cb16-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-572"><a href="#cb16-572" aria-hidden="true" tabindex="-1"></a>  In the United States, the Federal Reserve has a <span class="co">[</span><span class="ot">unique dual mandate</span><span class="co">](https://www.stlouisfed.org/in-plain-english/the-fed-and-the-dual-mandate)</span> to use macroeconomic policies to target both inflation and unemployment (most other countries' central banks only target inflation). The Fed typically aims for an inflation rate of 2% and an unemployment rate of <span class="co">[</span><span class="ot">4ish%</span><span class="co">](https://www.marketplace.org/2024/07/29/what-is-maximum-employment-target/)</span>. So in this new map, we'll center each county's unemployment rate around 4% and show the percentage point deviations from that Fed target. Counties colored in darker red have higher unemployment rates than the target; counties colored in blue have lower rates than the target.</span>
<span id="cb16-573"><a href="#cb16-573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-574"><a href="#cb16-574" aria-hidden="true" tabindex="-1"></a>  We can then imagine that we're a policymaker interested in unemployment trends—we can look at the map and quickly identify areas that are doing poorly and doing well.</span>
<span id="cb16-575"><a href="#cb16-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-576"><a href="#cb16-576" aria-hidden="true" tabindex="-1"></a>Up at the beginning of the document where we loaded and cleaned the <span class="in">`bls_2016`</span> dataset, I've added a new variable that centers the unemployment rate at 4:</span>
<span id="cb16-577"><a href="#cb16-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-578"><a href="#cb16-578" aria-hidden="true" tabindex="-1"></a><span class="in">```{.r}</span></span>
<span id="cb16-579"><a href="#cb16-579" aria-hidden="true" tabindex="-1"></a><span class="in">mutate(unemp_diff = unemp_truncated - 4)</span></span>
<span id="cb16-580"><a href="#cb16-580" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-581"><a href="#cb16-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-582"><a href="#cb16-582" aria-hidden="true" tabindex="-1"></a>We can then use this to create a new histogram and new map colored with the "vik" palette from <span class="co">[</span><span class="ot">the {scico} package</span><span class="co">](https://github.com/thomasp85/scico)</span>, which has lots of <span class="co">[</span><span class="ot">neat diverging palettes</span><span class="co">](https://www.fabiocrameri.ch/colourmaps/)</span>. We'll also create a fancy circle-based legend with {legendry}. Here's the fully annotated code and final map:</span>
<span id="cb16-583"><a href="#cb16-583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-586"><a href="#cb16-586" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb16-587"><a href="#cb16-587" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: plot-histogram-points-diffs</span></span>
<span id="cb16-588"><a href="#cb16-588" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 7</span></span>
<span id="cb16-589"><a href="#cb16-589" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 5</span></span>
<span id="cb16-590"><a href="#cb16-590" aria-hidden="true" tabindex="-1"></a><span class="co">#| out-width: 100%</span></span>
<span id="cb16-591"><a href="#cb16-591" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb16-592"><a href="#cb16-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-593"><a href="#cb16-593" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggtext)  <span class="co"># For Markdown-based text in ggplot</span></span>
<span id="cb16-594"><a href="#cb16-594" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scico)   <span class="co"># For perceptually uniform colors</span></span>
<span id="cb16-595"><a href="#cb16-595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-596"><a href="#cb16-596" aria-hidden="true" tabindex="-1"></a><span class="co"># Make new histogram legend</span></span>
<span id="cb16-597"><a href="#cb16-597" aria-hidden="true" tabindex="-1"></a>hist_legend_diffs <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(bls_2016, <span class="fu">aes</span>(<span class="at">x =</span> unemp_diff)) <span class="sc">+</span></span>
<span id="cb16-598"><a href="#cb16-598" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fill each histogram bar using the x axis category that ggplot creates</span></span>
<span id="cb16-599"><a href="#cb16-599" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use boundary = 0.5 to shift the bin ranges from things like 1-2 to 1.5-2.5</span></span>
<span id="cb16-600"><a href="#cb16-600" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(</span>
<span id="cb16-601"><a href="#cb16-601" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">fill =</span> <span class="fu">after_stat</span>((x))), </span>
<span id="cb16-602"><a href="#cb16-602" aria-hidden="true" tabindex="-1"></a>    <span class="at">binwidth =</span> <span class="dv">1</span>, <span class="at">boundary =</span> <span class="fl">0.5</span>, <span class="at">color =</span> <span class="st">"white"</span></span>
<span id="cb16-603"><a href="#cb16-603" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb16-604"><a href="#cb16-604" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fill with the same palette as the map</span></span>
<span id="cb16-605"><a href="#cb16-605" aria-hidden="true" tabindex="-1"></a>  <span class="co"># scale_fill_brewer(palette = "YlGnBu", guide = "none") +</span></span>
<span id="cb16-606"><a href="#cb16-606" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_scico</span>(<span class="at">palette =</span> <span class="st">"vik"</span>, <span class="at">midpoint =</span> <span class="dv">0</span>, <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb16-607"><a href="#cb16-607" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Modify the x-axis labels to show perentage point values and format them with</span></span>
<span id="cb16-608"><a href="#cb16-608" aria-hidden="true" tabindex="-1"></a>  <span class="co"># markdown to get original unemployment values on separate lines</span></span>
<span id="cb16-609"><a href="#cb16-609" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(</span>
<span id="cb16-610"><a href="#cb16-610" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="sc">-</span><span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>, </span>
<span id="cb16-611"><a href="#cb16-611" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">case_match</span>(</span>
<span id="cb16-612"><a href="#cb16-612" aria-hidden="true" tabindex="-1"></a>      <span class="sc">-</span><span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>,</span>
<span id="cb16-613"><a href="#cb16-613" aria-hidden="true" tabindex="-1"></a>      <span class="sc">-</span><span class="dv">2</span> <span class="sc">~</span> <span class="st">"**−2 pp.**&lt;br&gt;(2%)"</span>,</span>
<span id="cb16-614"><a href="#cb16-614" aria-hidden="true" tabindex="-1"></a>      <span class="dv">0</span> <span class="sc">~</span> <span class="st">"**0**&lt;br&gt;(4% ±&lt;br&gt;0.5 pp.)"</span>,</span>
<span id="cb16-615"><a href="#cb16-615" aria-hidden="true" tabindex="-1"></a>      <span class="dv">5</span> <span class="sc">~</span> <span class="st">"**&gt;+4 pp.**&lt;br&gt;(&gt;9%)"</span>,</span>
<span id="cb16-616"><a href="#cb16-616" aria-hidden="true" tabindex="-1"></a>      <span class="at">.default =</span> glue<span class="sc">::</span><span class="fu">glue</span>(</span>
<span id="cb16-617"><a href="#cb16-617" aria-hidden="true" tabindex="-1"></a>        <span class="st">"**{x}**"</span>, </span>
<span id="cb16-618"><a href="#cb16-618" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> scales<span class="sc">::</span><span class="fu">label_comma</span>(</span>
<span id="cb16-619"><a href="#cb16-619" aria-hidden="true" tabindex="-1"></a>          <span class="at">style_positive =</span> <span class="st">"plus"</span>, <span class="at">style_negative =</span> <span class="st">"minus"</span></span>
<span id="cb16-620"><a href="#cb16-620" aria-hidden="true" tabindex="-1"></a>        )(<span class="sc">-</span><span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>))</span>
<span id="cb16-621"><a href="#cb16-621" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-622"><a href="#cb16-622" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb16-623"><a href="#cb16-623" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Just one label to replicate the legend title</span></span>
<span id="cb16-624"><a href="#cb16-624" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Difference from Fed target"</span>) <span class="sc">+</span></span>
<span id="cb16-625"><a href="#cb16-625" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Theme adjustments</span></span>
<span id="cb16-626"><a href="#cb16-626" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_fancy_map</span>() <span class="sc">+</span></span>
<span id="cb16-627"><a href="#cb16-627" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb16-628"><a href="#cb16-628" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_markdown</span>(<span class="at">size =</span> <span class="fu">rel</span>(<span class="fl">0.5</span>), <span class="at">vjust =</span> <span class="dv">1</span>, <span class="at">lineheight =</span> <span class="fl">1.3</span>),</span>
<span id="cb16-629"><a href="#cb16-629" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="fu">rel</span>(<span class="fl">0.68</span>), <span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">t =</span> <span class="dv">3</span>, <span class="at">b =</span> <span class="dv">3</span>), <span class="at">face =</span> <span class="st">"bold"</span>)</span>
<span id="cb16-630"><a href="#cb16-630" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-631"><a href="#cb16-631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-632"><a href="#cb16-632" aria-hidden="true" tabindex="-1"></a>unemp_map_points_diffs <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb16-633"><a href="#cb16-633" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use a lighter gray background</span></span>
<span id="cb16-634"><a href="#cb16-634" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> us_states, <span class="at">fill =</span> <span class="st">"gray95"</span>, <span class="at">linewidth =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb16-635"><a href="#cb16-635" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use slightly darker state borders</span></span>
<span id="cb16-636"><a href="#cb16-636" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> interior_state_borders, <span class="at">linewidth =</span> <span class="fl">0.25</span>, <span class="at">color =</span> <span class="st">"grey60"</span>) <span class="sc">+</span></span>
<span id="cb16-637"><a href="#cb16-637" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Include semi-transparent points with shape 21 (so there's a border)</span></span>
<span id="cb16-638"><a href="#cb16-638" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb16-639"><a href="#cb16-639" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> counties_with_unemp_points, </span>
<span id="cb16-640"><a href="#cb16-640" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">size =</span> labor_force, <span class="at">fill =</span> unemp_diff), </span>
<span id="cb16-641"><a href="#cb16-641" aria-hidden="true" tabindex="-1"></a>    <span class="at">shape =</span> <span class="dv">21</span>, <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">stroke =</span> <span class="fl">0.25</span>, <span class="at">alpha =</span> <span class="fl">0.8</span></span>
<span id="cb16-642"><a href="#cb16-642" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb16-643"><a href="#cb16-643" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Control the size of the points in the legend</span></span>
<span id="cb16-644"><a href="#cb16-644" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size_continuous</span>(</span>
<span id="cb16-645"><a href="#cb16-645" aria-hidden="true" tabindex="-1"></a>    <span class="at">range =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">11</span>), <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_comma</span>(), </span>
<span id="cb16-646"><a href="#cb16-646" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">100000</span>, <span class="dv">1000000</span>, <span class="dv">5000000</span>),</span>
<span id="cb16-647"><a href="#cb16-647" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Make the points black and not have a border</span></span>
<span id="cb16-648"><a href="#cb16-648" aria-hidden="true" tabindex="-1"></a>    <span class="at">guide =</span> <span class="fu">guide_circles</span>(</span>
<span id="cb16-649"><a href="#cb16-649" aria-hidden="true" tabindex="-1"></a>      <span class="at">text_position =</span> <span class="st">"right"</span>,</span>
<span id="cb16-650"><a href="#cb16-650" aria-hidden="true" tabindex="-1"></a>      <span class="at">override.aes =</span> <span class="fu">list</span>(</span>
<span id="cb16-651"><a href="#cb16-651" aria-hidden="true" tabindex="-1"></a>        <span class="at">fill =</span> <span class="st">"grey30"</span>, <span class="at">alpha =</span> <span class="fl">0.8</span></span>
<span id="cb16-652"><a href="#cb16-652" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb16-653"><a href="#cb16-653" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-654"><a href="#cb16-654" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb16-655"><a href="#cb16-655" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This is tricky! We want to use the diverging vik palette but have it </span></span>
<span id="cb16-656"><a href="#cb16-656" aria-hidden="true" tabindex="-1"></a>  <span class="co"># centered at 0. With scale_fill_scico(), there's a midpoint argument, like we </span></span>
<span id="cb16-657"><a href="#cb16-657" aria-hidden="true" tabindex="-1"></a>  <span class="co"># used for the histogram. For generating regular lists of colors with scico(), </span></span>
<span id="cb16-658"><a href="#cb16-658" aria-hidden="true" tabindex="-1"></a>  <span class="co"># though, there's no midpoint argument. Instead, we need to make a few </span></span>
<span id="cb16-659"><a href="#cb16-659" aria-hidden="true" tabindex="-1"></a>  <span class="co"># specific adjustments: </span></span>
<span id="cb16-660"><a href="#cb16-660" aria-hidden="true" tabindex="-1"></a>  <span class="co">#</span></span>
<span id="cb16-661"><a href="#cb16-661" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 1. Generate 11 possible colors, since there are 5 colors above the 0 </span></span>
<span id="cb16-662"><a href="#cb16-662" aria-hidden="true" tabindex="-1"></a>  <span class="co">#    midpoint in the histogram and we need 5 parallel negative colors below 0 </span></span>
<span id="cb16-663"><a href="#cb16-663" aria-hidden="true" tabindex="-1"></a>  <span class="co">#    (even though we're only using 2)</span></span>
<span id="cb16-664"><a href="#cb16-664" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2. Set the limits of the legend to the symmetrical -5 to 5 range so that </span></span>
<span id="cb16-665"><a href="#cb16-665" aria-hidden="true" tabindex="-1"></a>  <span class="co">#    it's centered at 0</span></span>
<span id="cb16-666"><a href="#cb16-666" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 3. Set the breaks to go asymmetrically from -2:5. But actually set them </span></span>
<span id="cb16-667"><a href="#cb16-667" aria-hidden="true" tabindex="-1"></a>  <span class="co">#    from -2.5 to 4.5 since that matches the shifted histogram, which uses a </span></span>
<span id="cb16-668"><a href="#cb16-668" aria-hidden="true" tabindex="-1"></a>  <span class="co">#    boundary of 0.5 instead of 0 (so the histogram bins cover ranges like </span></span>
<span id="cb16-669"><a href="#cb16-669" aria-hidden="true" tabindex="-1"></a>  <span class="co">#    0.5 to 1.5 instead of 0 to 1)</span></span>
<span id="cb16-670"><a href="#cb16-670" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_stepsn</span>(</span>
<span id="cb16-671"><a href="#cb16-671" aria-hidden="true" tabindex="-1"></a>    <span class="at">colours =</span> scico<span class="sc">::</span><span class="fu">scico</span>(<span class="dv">11</span>, <span class="at">palette =</span> <span class="st">"vik"</span>),</span>
<span id="cb16-672"><a href="#cb16-672" aria-hidden="true" tabindex="-1"></a>    <span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span>, <span class="dv">5</span>),</span>
<span id="cb16-673"><a href="#cb16-673" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">2.5</span>, <span class="fl">4.5</span>, <span class="at">by =</span> <span class="dv">1</span>),</span>
<span id="cb16-674"><a href="#cb16-674" aria-hidden="true" tabindex="-1"></a>    <span class="at">guide =</span> <span class="st">"none"</span></span>
<span id="cb16-675"><a href="#cb16-675" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb16-676"><a href="#cb16-676" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Labels</span></span>
<span id="cb16-677"><a href="#cb16-677" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb16-678"><a href="#cb16-678" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"US unemployment (2016)"</span>,</span>
<span id="cb16-679"><a href="#cb16-679" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Differences from the Federal Reserve's 4% target"</span>,</span>
<span id="cb16-680"><a href="#cb16-680" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Source: US Bureau of Labor Statistics"</span>,</span>
<span id="cb16-681"><a href="#cb16-681" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Unemployment rate"</span>,</span>
<span id="cb16-682"><a href="#cb16-682" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="st">"County labor force"</span></span>
<span id="cb16-683"><a href="#cb16-683" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb16-684"><a href="#cb16-684" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Albers</span></span>
<span id="cb16-685"><a href="#cb16-685" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">crs =</span> <span class="fu">st_crs</span>(<span class="st">"ESRI:102003"</span>), <span class="at">xlim =</span> xlim_expanded) <span class="sc">+</span></span>
<span id="cb16-686"><a href="#cb16-686" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Theme adjustments</span></span>
<span id="cb16-687"><a href="#cb16-687" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_fancy_map</span>() <span class="sc">+</span></span>
<span id="cb16-688"><a href="#cb16-688" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb16-689"><a href="#cb16-689" aria-hidden="true" tabindex="-1"></a>    <span class="co"># {legendry} complains if there's no legend.margin setting; using </span></span>
<span id="cb16-690"><a href="#cb16-690" aria-hidden="true" tabindex="-1"></a>    <span class="co"># theme_void() removes that setting and breaks the plot, so we specify </span></span>
<span id="cb16-691"><a href="#cb16-691" aria-hidden="true" tabindex="-1"></a>    <span class="co"># some 0 values here</span></span>
<span id="cb16-692"><a href="#cb16-692" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.margin =</span> <span class="fu">margin</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="st">"pt"</span>),</span>
<span id="cb16-693"><a href="#cb16-693" aria-hidden="true" tabindex="-1"></a>    <span class="at">legendry.legend.key.margin =</span> <span class="fu">margin</span>(<span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="st">"pt"</span>),</span>
<span id="cb16-694"><a href="#cb16-694" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.ticks =</span> <span class="fu">element_line</span>(<span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">linetype =</span> <span class="st">"22"</span>),</span>
<span id="cb16-695"><a href="#cb16-695" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"inside"</span>,</span>
<span id="cb16-696"><a href="#cb16-696" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position.inside =</span> <span class="fu">c</span>(<span class="fl">0.87</span>, <span class="fl">0.17</span>),</span>
<span id="cb16-697"><a href="#cb16-697" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="fu">rel</span>(<span class="fl">0.55</span>)),</span>
<span id="cb16-698"><a href="#cb16-698" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="fu">rel</span>(<span class="fl">0.7</span>), <span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">t =</span> <span class="dv">3</span>)),</span>
<span id="cb16-699"><a href="#cb16-699" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.18</span>),</span>
<span id="cb16-700"><a href="#cb16-700" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title.position =</span> <span class="st">"bottom"</span></span>
<span id="cb16-701"><a href="#cb16-701" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-702"><a href="#cb16-702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-703"><a href="#cb16-703" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the histogram to the map</span></span>
<span id="cb16-704"><a href="#cb16-704" aria-hidden="true" tabindex="-1"></a>combined_map_hist_points_diffs <span class="ot">&lt;-</span> unemp_map_points_diffs <span class="sc">+</span> </span>
<span id="cb16-705"><a href="#cb16-705" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inset_element</span>(hist_legend_diffs, <span class="at">left =</span> <span class="fl">0.75</span>, <span class="at">bottom =</span> <span class="fl">0.26</span>, <span class="at">right =</span> <span class="fl">0.98</span>, <span class="at">top =</span> <span class="fl">0.45</span>)</span>
<span id="cb16-706"><a href="#cb16-706" aria-hidden="true" tabindex="-1"></a>combined_map_hist_points_diffs</span>
<span id="cb16-707"><a href="#cb16-707" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p><span class="faux-block">Forked from <a href="https://www.andrewheiss.com/">Andrew Heiss</a></span> # <span class="faux-block"><a href="https://github.com/andrewheiss/ath-quarto">View the source at <i class="fa-brands fa-github" aria-label="github"></i> GitHub</a></span></p>
</div>
  </div>
</footer><script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>


</body></html>