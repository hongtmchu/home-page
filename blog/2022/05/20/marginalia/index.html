<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Hong T.M. Chu">
<meta name="description" content="Define what marginal effects even are, and then explore the subtle differences between average marginal effects, marginal effects at the mean, and marginal effects at representative values with the marginaleffects and emmeans R packages">
<title>Marginalia: A guide to figuring out what the heck marginal effects, marginal slopes, average marginal effects, marginal effects at the mean, and all these other marginal things are | Hong T.M. Chu – Hong T.M. Chu</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../../../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../../../">
<link href="../../../../..//files/favicon-512.png" rel="icon" type="image/png">
<script src="../../../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../../../site_libs/quarto-html/quarto-syntax-highlighting-17c909d5fd25ae21b861c0c7a49b2096.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../../../site_libs/bootstrap/bootstrap-5cd0811f461c8271ae6bab49df9501be.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<link href="../../../../../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../../../../../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<script src="../../../../../site_libs/quarto-contrib/iconify-2.0.0/iconify-icon.min.js"></script><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script type="text/javascript">

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-527449-5', 'auto');

ga('send', {
  hitType: 'pageview',
  'anonymizeIp': true,
});
</script><style>

      .quarto-title-block .quarto-title-banner {
        background: #170C3A;
      }
</style>
<script src="../../../../../site_libs/kePrint-0.0.1/kePrint.js"></script><link href="../../../../../site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
<meta property="og:title" content="Marginalia: A guide to figuring out what the heck marginal effects, marginal slopes, average marginal effects, marginal effects at the mean, and all these other marginal things are | Hong T.M. Chu">
<meta property="og:description" content="Define what marginal effects even are, and then explore the subtle differences between average marginal effects, marginal effects at the mean, and marginal effects at representative values with the marginaleffects and emmeans R packages">
<meta property="og:image" content="https://www.andrewheiss.com/blog/2022/05/20/marginalia/images/twitter-cover@3x.png">
<meta property="og:site_name" content="Hong T.M. Chu">
<meta property="og:locale" content="en_US">
<meta property="og:image:height" content="1255">
<meta property="og:image:width" content="2401">
<meta name="twitter:title" content="Marginalia: A guide to figuring out what the heck marginal effects, marginal slopes, average marginal effects, marginal effects at the mean, and all these other marginal things are | Hong T.M. Chu">
<meta name="twitter:description" content="Define what marginal effects even are, and then explore the subtle differences between average marginal effects, marginal effects at the mean, and marginal effects at representative values with the marginaleffects and emmeans R packages">
<meta name="twitter:image" content="https://www.andrewheiss.com/blog/2022/05/20/marginalia/images/twitter-cover@3x.png">
<meta name="twitter:creator" content="@andrewheiss">
<meta name="twitter:site" content="@andrewheiss">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image-height" content="1255">
<meta name="twitter:image-width" content="2401">
</head>
<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../../../index.html">
    <span class="navbar-title">Hong T.M. Chu</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link" href="../../../../../index.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../cv/index.html"> 
<span class="menu-text">CV</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../research/index.html"> 
<span class="menu-text">Research</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../teaching/index.html"> 
<span class="menu-text">Teaching</span></a>
  </li>  
</ul>
<ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item">
    <a class="nav-link" href="mailto:hong.ctm@vinuni.edu.vn"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:envelope" style="font-size: 1.1em;" aria-label="Icon envelope from bi Iconify.design set." title="E-mail"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/andrewheiss" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:github" style="font-size: 1.1em;" aria-label="Icon github from bi Iconify.design set." title="GitHub"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.linkedin.com/in/hongtmchu" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:linkedin" style="font-size: 1.1em;" aria-label="Icon linkedin from bi Iconify.design set." title="LinkedIn"></iconify-icon></span></a>
  </li>  
</ul>
</div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><header id="title-block-header" class="quarto-title-block default blog-post page-columns page-full"><div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">Marginalia: A guide to figuring out what the heck marginal effects, marginal slopes, average marginal effects, marginal effects at the mean, and all these other marginal things are</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
                  <div>
        <div class="description">
          Define what marginal effects even are, and then explore the subtle differences between average marginal effects, marginal effects at the mean, and marginal effects at representative values with the marginaleffects and emmeans R packages
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">r</div>
                <div class="quarto-category">tidyverse</div>
                <div class="quarto-category">regression</div>
                <div class="quarto-category">statistics</div>
                <div class="quarto-category">data visualization</div>
                <div class="quarto-category">marginal effects</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p><a href="https://www.andrewheiss.com/">Andrew Heiss</a> <a href="https://orcid.org/0000-0002-3948-3914" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">Friday, May 20, 2022</p>
      </div>
    </div>
    
      
      <div>
      <div class="quarto-title-meta-heading">Doi</div>
      <div class="quarto-title-meta-contents">
        <p class="doi">
          <a href="https://doi.org/10.59350/40xaj-4e562">10.59350/40xaj-4e562</a>
        </p>
      </div>
    </div>
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Contents</h2>
   
  <ul>
<li>
<a href="#what-does-marginal-even-mean-in-the-first-place" id="toc-what-does-marginal-even-mean-in-the-first-place" class="nav-link active" data-scroll-target="#what-does-marginal-even-mean-in-the-first-place">What does “marginal” even mean in the first place?</a>
  <ul>
<li><a href="#super-quick-crash-course-in-differential-calculus-its-not-scary-i-promise" id="toc-super-quick-crash-course-in-differential-calculus-its-not-scary-i-promise" class="nav-link" data-scroll-target="#super-quick-crash-course-in-differential-calculus-its-not-scary-i-promise">Super quick crash course in differential calculus (it’s not scary, I promise!)</a></li>
  <li><a href="#marginal-things-in-economics" id="toc-marginal-things-in-economics" class="nav-link" data-scroll-target="#marginal-things-in-economics">Marginal things in economics</a></li>
  </ul>
</li>
  <li>
<a href="#what-about-marginal-things-in-statistics" id="toc-what-about-marginal-things-in-statistics" class="nav-link" data-scroll-target="#what-about-marginal-things-in-statistics">What about marginal things in statistics?</a>
  <ul>
<li><a href="#regression-sliders-switches-and-mixing-boards" id="toc-regression-sliders-switches-and-mixing-boards" class="nav-link" data-scroll-target="#regression-sliders-switches-and-mixing-boards">Regression, sliders, switches, and mixing boards</a></li>
  </ul>
</li>
  <li><a href="#what-are-marginal-effects" id="toc-what-are-marginal-effects" class="nav-link" data-scroll-target="#what-are-marginal-effects">What are marginal effects?</a></li>
  <li><a href="#slopes-and-marginal-effects" id="toc-slopes-and-marginal-effects" class="nav-link" data-scroll-target="#slopes-and-marginal-effects">Slopes and marginal effects</a></li>
  <li>
<a href="#marginaleffectss-and-emmeanss-philosophies-of-averaging" id="toc-marginaleffectss-and-emmeanss-philosophies-of-averaging" class="nav-link" data-scroll-target="#marginaleffectss-and-emmeanss-philosophies-of-averaging"><strong>marginaleffects</strong>’s and <strong>emmeans</strong>’s philosophies of averaging</a>
  <ul>
<li><a href="#average-marginal-effects-the-default-in-marginaleffects" id="toc-average-marginal-effects-the-default-in-marginaleffects" class="nav-link" data-scroll-target="#average-marginal-effects-the-default-in-marginaleffects">Average marginal effects (the default in <strong>marginaleffects</strong>)</a></li>
  <li><a href="#marginal-effects-at-the-mean-the-default-in-emmeans" id="toc-marginal-effects-at-the-mean-the-default-in-emmeans" class="nav-link" data-scroll-target="#marginal-effects-at-the-mean-the-default-in-emmeans">Marginal effects at the mean (the default in <strong>emmeans</strong>)</a></li>
  </ul>
</li>
  <li><a href="#where-this-subtle-difference-really-matters" id="toc-where-this-subtle-difference-really-matters" class="nav-link" data-scroll-target="#where-this-subtle-difference-really-matters">Where this subtle difference really matters</a></li>
  <li>
<a href="#other-marginal-slope-things" id="toc-other-marginal-slope-things" class="nav-link" data-scroll-target="#other-marginal-slope-things">Other marginal slope things</a>
  <ul>
<li><a href="#group-average-marginal-effects" id="toc-group-average-marginal-effects" class="nav-link" data-scroll-target="#group-average-marginal-effects">Group average marginal effects</a></li>
  <li>
<a href="#marginal-effects-at-user-specified-or-representative-values" id="toc-marginal-effects-at-user-specified-or-representative-values" class="nav-link" data-scroll-target="#marginal-effects-at-user-specified-or-representative-values">Marginal effects at user-specified or representative values</a>
  <ul class="collapse">
<li><a href="#creating-representative-values" id="toc-creating-representative-values" class="nav-link" data-scroll-target="#creating-representative-values">Creating representative values</a></li>
  <li><a href="#working-with-representative-values" id="toc-working-with-representative-values" class="nav-link" data-scroll-target="#working-with-representative-values">Working with representative values</a></li>
  </ul>
</li>
  <li><a href="#average-marginal-effects-at-counterfactual-user-specified-values" id="toc-average-marginal-effects-at-counterfactual-user-specified-values" class="nav-link" data-scroll-target="#average-marginal-effects-at-counterfactual-user-specified-values">Average marginal effects at counterfactual user-specified values</a></li>
  </ul>
</li>
  <li><a href="#categorical-contrasts-as-statisticalmarginal-effects" id="toc-categorical-contrasts-as-statisticalmarginal-effects" class="nav-link" data-scroll-target="#categorical-contrasts-as-statisticalmarginal-effects">Categorical contrasts as statistical/marginal effects</a></li>
  <li><a href="#tldr-overall-summary-of-all-these-marginal-effects-approaches" id="toc-tldr-overall-summary-of-all-these-marginal-effects-approaches" class="nav-link" data-scroll-target="#tldr-overall-summary-of-all-these-marginal-effects-approaches">tl;dr: Overall summary of all these marginal effects approaches</a></li>
  <li><a href="#which-approach-is-best" id="toc-which-approach-is-best" class="nav-link" data-scroll-target="#which-approach-is-best">Which approach is best?</a></li>
  </ul></nav>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content"><div class="cell" data-layout-align="center">
<style type="text/css">
.smaller {
  font-size: 85%;
}
</style>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Diagrams!
</div>
</div>
<div class="callout-body-container callout-body">
<p>You can download PDF, SVG, and PNG versions of the marginal effects diagrams in this guide, as well as the original Adobe Illustrator file, here:</p>
<ul>
<li><a href="http://files.andrewheiss.com/marginal-effects-diagrams/marginal-effects-output.zip">PDFs, SVGs, and PNGs</a></li>
<li><a href="http://files.andrewheiss.com/marginal-effects-diagrams/marginal-effects.ai">Illustrator .ai file</a></li>
</ul>
<p>Do whatever you want with them! They’re licensed under <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike (BY-SA 4.0)</a>.</p>
</div>
</div>
<p>I’m a huge fan of doing research and analysis in public. I try to make <a href="https://www.andrewheiss.com/research/">my research public and freely accessible</a>, but ever since watching <a href="https://www.rstudio.com/resources/rstudioconf-2019/the-unreasonable-effectiveness-of-public-work/">David Robinson’s “The unreasonable effectiveness of public work” keynote from rstudio::conf 2019</a>, I’ve tried to make my research <em>process</em> open and accessible too.</p>
<p>According to David, researchers typically view their work like this:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="images/normal-work.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>People work towards a final published product, which is the most valuable output of the whole process. The intermediate steps like the code, data, preliminary results, and so on, are less valuable and often hidden from the public. People only see the final published thing.</p>
<p>David argues that we should instead see our work like this:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="images/public-work.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>In this paradigm, anything on your computer and only accessible by you isn’t that valuable. Anything you make accessible to the public online—including all the intermediate stuff like code, data, and preliminary results, in addition to the final product—is incredibly valuable. The world can benefit from neat code tricks you stumble on while making graphs; the world can benefit from new data sources you find or your way of processing data; the world can benefit from a toy example of a new method you read about in some paper, even if the actual code you write to play around with the method never makes it into any published paper. It’s all useful to the broader community of researchers.</p>
<p>Public work also builds community norms—if more people share their behind-the-scenes work, it encourages others to do the same and engage with it and improve it (see <a href="https://github.com/andrewheiss/ath-hugo/commit/70197c7389c87b46db6cd61fc1ef8ce7b5c94616#commitcomment-73816081">this super detailed and helpful comment</a> with corrections to my previous post, for example!).</p>
<p>Public work is also valuable for another more selfish reason. Building an online presence with a wide readership is hard, and my little blog post contributions aren’t famous or anything—they’re just sitting out here in a tiny corner of the internet. But these guides have been indispensable for me. They’ve allowed me to work through and understand tricky statistical and programming concepts, <em>and then</em> have allowed me to come back to them months later and remember how they work. This whole blog is primarily a resource for future me.</p>
<p>So here’s yet another blog post that is hopefully potentially useful for the general public, but that is definitely useful for future me.</p>
<p>In a few of my ongoing research projects, I’m working with non-linear regression models, and I’ve been struggling to interpret their results. In my past few posts (like <a href="https://www.andrewheiss.com/blog/2022/05/09/hurdle-lognormal-gaussian-brms/">this one on hurdle models</a>, or <a href="https://www.andrewheiss.com/blog/2021/12/01/multilevel-models-panel-data-guide/">this one on multilevel panel data</a>, or <a href="https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/">this one on beta and zero-inflated models</a>), I’ve explored a bunch of different ways to work with and interpret these more complex models and calculate their marginal effects. I even wrote <a href="https://www.andrewheiss.com/blog/2021/11/10/ame-bayes-re-guide/">a guide to calculating average marginal effects for multilevel models</a>. TURNS OUT™, though, that I’ve actually been a bit wrong about my terminology for all the marginal effects I’ve talked about in those posts.</p>
<p>Part of the reason for this wrongness is because there are so many quasi-synonyms for the idea of “marginal effects” and people seem to be pretty <a href="https://www.youtube.com/watch?v=iNukPHje4Fs">loosey goosey</a> about what exactly they’re referring to. There are statistical effects, marginal effects, marginal means, marginal slopes, conditional effects, conditional marginal effects, marginal effects at the mean, and many other similarly-named ideas. There are also regression coefficients and estimates, which have marginal effects vibes, but may or may not actually be marginal effects depending on the complexity of the model.</p>
<p>The question of what the heck “marginal effects” are has plagued me for a while. In October 2021 <a href="https://twitter.com/andrewheiss/status/1448719033306648586">I publicly announced</a> that I would finally buckle down and figure out their definitions and nuances:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="images/original-tweet.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>And then I didn’t.</p>
<p>So here I am, 7 months later, publicly figuring out the differences between regression coefficients, regression predictions, <a href="https://marginaleffects.com/"><strong>marginaleffects</strong></a>, <a href="https://cran.r-project.org/web/packages/emmeans/index.html"><strong>emmeans</strong></a>, marginal slopes, average marginal effects, marginal effects at the mean, and all these other “marginal” things that researchers and data scientists use.</p>
<p>This guide is highly didactic and slowly builds up the concept of marginal effects as slopes and partial derivatives. <a href="#tldr-overall-summary-of-all-these-marginal-effects-approaches">The tl;dr section at the end</a> has a useful summary of everything here, with a table showing all the different approaches to marginal effects with corresponding <strong>marginaleffects</strong> and <strong>emmeans</strong> code, as well as some diagrams outlining the two packages’ different approaches to averaging. Hopefully it’s useful—it is for me!</p>
<p>Let’s get started by looking at some lines and slopes (after loading a bunch of packages and creating some useful little functions).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Load packages</span></span>
<span><span class="co"># ---------------</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>        <span class="co"># dplyr, ggplot2, and friends</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://broom.tidymodels.org/">broom</a></span><span class="op">)</span>            <span class="co"># Convert models to data frames</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://marginaleffects.com/">marginaleffects</a></span><span class="op">)</span>  <span class="co"># Marginal effects stuff</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rvlenth.github.io/emmeans/">emmeans</a></span><span class="op">)</span>          <span class="co"># Marginal effects stuff</span></span>
<span></span>
<span><span class="co"># Visualization-related packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://wilkelab.org/ggtext/">ggtext</a></span><span class="op">)</span>           <span class="co"># Add markdown/HTML support to text in plots</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://glue.tidyverse.org/">glue</a></span><span class="op">)</span>             <span class="co"># Python-esque string interpolation</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://scales.r-lib.org">scales</a></span><span class="op">)</span>           <span class="co"># Functions to format numbers nicely</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://gganimate.com">gganimate</a></span><span class="op">)</span>        <span class="co"># Make animated plots</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com">patchwork</a></span><span class="op">)</span>        <span class="co"># Combine ggplots</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggrepel.slowkow.com/">ggrepel</a></span><span class="op">)</span>          <span class="co"># Make labels that don't overlap</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">MetBrewer</span><span class="op">)</span>        <span class="co"># Artsy color palettes</span></span>
<span></span>
<span><span class="co"># Data-related packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://allisonhorst.github.io/palmerpenguins/">palmerpenguins</a></span><span class="op">)</span>   <span class="co"># Penguin data</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://vincentarelbundock.github.io/WDI/">WDI</a></span><span class="op">)</span>              <span class="co"># Get data from the World Bank's API</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://vincentarelbundock.github.io/countrycode/">countrycode</a></span><span class="op">)</span>      <span class="co"># Map country codes to different systems</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">vdemdata</span><span class="op">)</span>         <span class="co"># Use data from the Varieties of Democracy (V-Dem) project</span></span>
<span><span class="co"># Install vdemdata from GitHub, not CRAN</span></span>
<span><span class="co"># devtools::install_github("vdeminstitute/vdemdata")</span></span>
<span></span>
<span></span>
<span><span class="co"># Helpful functions</span></span>
<span><span class="co"># -------------------</span></span>
<span><span class="co"># Format numbers in pretty ways</span></span>
<span><span class="va">nice_number</span> <span class="op">&lt;-</span> <span class="fu">label_number</span><span class="op">(</span>style_negative <span class="op">=</span> <span class="st">"minus"</span>, accuracy <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="va">nice_p</span> <span class="op">&lt;-</span> <span class="fu">label_pvalue</span><span class="op">(</span>prefix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"p &lt; "</span>, <span class="st">"p = "</span>, <span class="st">"p &gt; "</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Point-slope formula: (y - y1) = m(x - x1)</span></span>
<span><span class="va">find_intercept</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x1</span>, <span class="va">y1</span>, <span class="va">slope</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">intercept</span> <span class="op">&lt;-</span> <span class="va">slope</span> <span class="op">*</span> <span class="op">(</span><span class="op">-</span><span class="va">x1</span><span class="op">)</span> <span class="op">+</span> <span class="va">y1</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">intercept</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Visualization settings</span></span>
<span><span class="co"># ------------------------</span></span>
<span></span>
<span><span class="co"># Custom ggplot theme to make pretty plots</span></span>
<span><span class="co"># Get IBM Plex Sans Condensed at https://fonts.google.com/specimen/IBM+Plex+Sans+Condensed</span></span>
<span><span class="va">theme_mfx</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span>base_family <span class="op">=</span> <span class="st">"IBM Plex Sans Condensed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">theme</span><span class="op">(</span>panel.grid.minor <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>          plot.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"white"</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>,</span>
<span>          plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>          axis.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>          strip.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>          strip.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"grey80"</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>,</span>
<span>          legend.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Make labels use IBM Plex Sans by default</span></span>
<span><span class="fu">update_geom_defaults</span><span class="op">(</span><span class="st">"label"</span>, </span>
<span>                     <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>family <span class="op">=</span> <span class="st">"IBM Plex Sans Condensed"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">update_geom_defaults</span><span class="op">(</span><span class="fu">ggtext</span><span class="fu">::</span><span class="va">GeomRichText</span>, </span>
<span>                     <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>family <span class="op">=</span> <span class="st">"IBM Plex Sans Condensed"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">update_geom_defaults</span><span class="op">(</span><span class="st">"label_repel"</span>, </span>
<span>                     <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>family <span class="op">=</span> <span class="st">"IBM Plex Sans Condensed"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Use the Johnson color palette</span></span>
<span><span class="va">clrs</span> <span class="op">&lt;-</span> <span class="fu">met.brewer</span><span class="op">(</span><span class="st">"Johnson"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="what-does-marginal-even-mean-in-the-first-place" class="level2"><h2 class="anchored" data-anchor-id="what-does-marginal-even-mean-in-the-first-place">What does “marginal” even mean in the first place?</h2>
<p>Put as simply as possible, in the world of statistics, “marginal” means “additional,” or what happens to outcome variable <span class="math inline">\(y\)</span> when explanatory variable <span class="math inline">\(x\)</span> changes a little.</p>
<p>To find out precisely how much things change, we need to use calculus.</p>
<p>Oh no.</p>
<section id="super-quick-crash-course-in-differential-calculus-its-not-scary-i-promise" class="level3"><h3 class="anchored" data-anchor-id="super-quick-crash-course-in-differential-calculus-its-not-scary-i-promise">Super quick crash course in differential calculus (it’s not scary, I promise!)</h3>
<p>I haven’t taken a formal calculus class since my senior year of high school in 2002. I enjoyed it a ton and got the highest score on the <a href="https://apstudents.collegeboard.org/courses/ap-calculus-bc">AP Calculus BC test</a>, which gave me enough college credits to not need it as an undergraduate, given that I majored in Middle East Studies, Arabic, and Italian. I figured I’d never need to think about calculus every again. lol.</p>
<p>In my first PhD-level stats class in 2012, the professor cancelled class for the first month and assigned us all to go relearn calculus with Khan Academy, since I wasn’t alone in my unlearning of calculus. Even after that crash course refresher, I don’t really ever use it in my own research. When I do, I only use it to think about derivatives and slopes, since those are central to statistics.</p>
<p>Calculus can be boiled down to two forms: (1) <strong>differential calculus</strong> is all about finding rates of changes by calculating derivatives, or slopes, while (2) <strong>integral calculus</strong> is all about finding total amounts, or areas, by adding infinitesimally small things together. According to <a href="https://en.wikipedia.org/wiki/Fundamental_theorem_of_calculus">the fundamental theorem of calculus</a>, these two types are actually the inverse of each other—you can find the total area under a curve based on its slope, for instance. Super neat stuff. If you want a cool accessible refresher / history of all this, check out Steven Strogatz’s <a href="https://www.amazon.com/Infinite-Powers-Calculus-Reveals-Universe/dp/1328879984"><em>Infinite Powers: How Calculus Reveals the Secrets of the Universe</em></a>—it’s great.</p>
<p>In the world of statistics and marginal effects all we care about are slopes, which are solely a differential calculus idea.</p>
<p>Let’s pretend we have a line that shows the relationship between <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> that’s defined with an equation using the form <span class="math inline">\(y = mx + b\)</span>, where <span class="math inline">\(m\)</span> is the slope and <span class="math inline">\(b\)</span> is the y-intercept. We can plot it with ggplot using the helpful <code>geom_function()</code> function:</p>
<p><span class="math display">\[
y = 2x - 1
\]</span></p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># y = 2x - 1</span></span>
<span><span class="va">a_line</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">x</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, color <span class="op">=</span> <span class="st">"grey50"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, color <span class="op">=</span> <span class="st">"grey50"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_function</span><span class="op">(</span>fun <span class="op">=</span> <span class="va">a_line</span>, linewidth <span class="op">=</span> <span class="fl">1</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="op">-</span><span class="fl">2</span><span class="op">:</span><span class="fl">5</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="op">-</span><span class="fl">3</span><span class="op">:</span><span class="fl">9</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">annotate</span><span class="op">(</span>geom <span class="op">=</span> <span class="st">"segment"</span>, x <span class="op">=</span> <span class="fl">1</span>, y <span class="op">=</span> <span class="fl">1.3</span>, xend <span class="op">=</span> <span class="fl">1</span>, yend <span class="op">=</span> <span class="fl">3</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">annotate</span><span class="op">(</span>geom <span class="op">=</span> <span class="st">"segment"</span>, x <span class="op">=</span> <span class="fl">1</span>, y <span class="op">=</span> <span class="fl">3</span>, xend <span class="op">=</span> <span class="fl">1.8</span>, yend <span class="op">=</span> <span class="fl">3</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">annotate</span><span class="op">(</span>geom <span class="op">=</span> <span class="st">"richtext"</span>, x <span class="op">=</span> <span class="fl">1.4</span>, y <span class="op">=</span> <span class="fl">3.1</span>, label <span class="op">=</span> <span class="st">"Slope: **2**"</span>, vjust <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"x"</span>, y <span class="op">=</span> <span class="st">"y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_equal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_mfx</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-line-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>The line crosses the y-axis at -1, and its slope, or its <span class="math inline">\(\frac{\text{rise}}{\text{run}}\)</span> is 2, or <span class="math inline">\(\frac{2}{1}\)</span>, meaning that we go up two units and to the right one unit.</p>
<p>Importantly, the slope shows the relationship between <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span>. If <span class="math inline">\(x\)</span> increases by 1 unit, <span class="math inline">\(y\)</span> increases by 2: when <span class="math inline">\(x\)</span> is 1, <span class="math inline">\(y\)</span> is 1; when <span class="math inline">\(x\)</span> is 2, <span class="math inline">\(y\)</span> is 3, and so on. We can call this the <em>marginal effect</em>, or the change in <span class="math inline">\(y\)</span> that results from one additional <span class="math inline">\(x\)</span>.</p>
<p>We can think about this slope using calculus language too. In differential calculus, slopes are called <em>derivatives</em> and they represent the change in <span class="math inline">\(y\)</span> that results from changes in <span class="math inline">\(x\)</span>, or <span class="math inline">\(\frac{dy}{dx}\)</span>. The <span class="math inline">\(d\)</span> here refers to an infinitesimal change in the values of <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span>, rather than a one-unit change like we think of when looking at the slope as <span class="math inline">\(\frac{\text{rise}}{\text{run}}\)</span>. Even more technically, the <span class="math inline">\(d\)</span> indicates that we’re working with the total derivative, since there’s only one variable (<span class="math inline">\(x\)</span>) to consider. If we had more variables (like <span class="math inline">\(y = 2x + 3z -1\)</span>), we would need to find the partial derivative for <span class="math inline">\(x\)</span>, holding <span class="math inline">\(z\)</span> constant, and we’d write the derivative with a <span class="math inline">\(\partial\)</span> symbol instead: <span class="math inline">\(\frac{\partial y}{\partial x}\)</span>. More on that in a bit.</p>
<p>By plotting this line, we can figure out <span class="math inline">\(\frac{dy}{dx}\)</span> visually—the slope is 2. But we can figure it out mathematically too. Differential calculus is full of <a href="https://en.wikipedia.org/wiki/Differentiation_rules">fancy tricks and rules of thumb</a> for figuring out derivatives, like the <a href="https://en.wikipedia.org/wiki/Power_rule">power rule</a>, the <a href="https://en.wikipedia.org/wiki/Chain_rule">chain rule</a>, and so on. The easiest one for me to remember is the power rule, which says you can find the slope of a variable like <span class="math inline">\(x\)</span> by decreasing its exponent by 1 and multiplying that exponent by the variable’s coefficient. All constants (terms without <span class="math inline">\(x\)</span>) disappear.</p>
<p><span class="math display">\[
\begin{aligned}
y &amp;= 2x - 1 \\
&amp;= 2x^1 - 1 \\
\frac{dy}{dx}&amp;= (1 \times 2) x^0 \\
&amp;=  2
\end{aligned}
\]</span></p>
<p>(My secret is that I only know the power rule and so I avoid calculus at all costs and either <a href="https://www.andrewheiss.com/blog/2018/02/15/derivatives-r-fun/">use R</a> or use Wolfram Alpha—go to <a href="https://www.wolframalpha.com">Wolfram Alpha</a>, type in <code>derivative y = 2x - 1</code> and you’ll <a href="https://www.wolframalpha.com/input?i=derivative+y+%3D+2x+-+1">see some magic</a>.)</p>
<p>We thus know that the derivative of <span class="math inline">\(y = 2x - 1\)</span> is <span class="math inline">\(\frac{dy}{dx} = 2\)</span>. At every point on this line, the slope is 2—it never changes.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">slope_annotations</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.25</span>, <span class="fl">1.2</span>, <span class="fl">2.4</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>y <span class="op">=</span> <span class="fu">a_line</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>nice_y <span class="op">=</span> <span class="va">y</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>nice_label <span class="op">=</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"x: {x}; y: {y}&lt;br&gt;"</span>,</span>
<span>                           <span class="st">"Slope (dy/dx): **{2}**"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, color <span class="op">=</span> <span class="st">"grey50"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, color <span class="op">=</span> <span class="st">"grey50"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_function</span><span class="op">(</span>fun <span class="op">=</span> <span class="va">a_line</span>, linewidth <span class="op">=</span> <span class="fl">1</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>data <span class="op">=</span> <span class="va">slope_annotations</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_richtext</span><span class="op">(</span>data <span class="op">=</span> <span class="va">slope_annotations</span>, </span>
<span>                <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, label <span class="op">=</span> <span class="va">nice_label</span><span class="op">)</span>,</span>
<span>                nudge_y <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="op">-</span><span class="fl">2</span><span class="op">:</span><span class="fl">5</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="op">-</span><span class="fl">3</span><span class="op">:</span><span class="fl">9</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"x"</span>, y <span class="op">=</span> <span class="st">"y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_equal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_mfx</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-line-slope-labels-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>The power rule seems super basic for equations with non-exponentiated <span class="math inline">\(x\)</span>s, but it’s really helpful with more complex equations, like this parabola <span class="math inline">\(y = -0.5x^2 + 5x + 5\)</span>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># y = -0.5x^2 + 5x + 5</span></span>
<span><span class="va">a_parabola</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">(</span><span class="op">-</span><span class="fl">0.5</span> <span class="op">*</span> <span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">5</span> <span class="op">*</span> <span class="va">x</span><span class="op">)</span> <span class="op">+</span> <span class="fl">5</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, color <span class="op">=</span> <span class="st">"grey50"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, color <span class="op">=</span> <span class="st">"grey50"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_function</span><span class="op">(</span>fun <span class="op">=</span> <span class="va">a_parabola</span>, linewidth <span class="op">=</span> <span class="fl">1</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlim</span><span class="op">(</span><span class="op">-</span><span class="fl">5</span>, <span class="fl">15</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"x"</span>, y <span class="op">=</span> <span class="st">"y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">5</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_mfx</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-parabola-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>What’s interesting here is that there’s no longer a single slope for the whole function. The steepness of the slope across a range of <span class="math inline">\(x\)</span>s depends on whatever <span class="math inline">\(x\)</span> currently is. The curve is steeper at really low and really high values of <span class="math inline">\(x\)</span> and it is shallower around 5 (and it is completely flat when <span class="math inline">\(x\)</span> is 5).</p>
<p>If we apply the power rule to the parabola formula we can find the exact slope:</p>
<p><span class="math display">\[
\begin{aligned}
y &amp;= -0.5x^2 + 5x^1 + 5 \\
\frac{dy}{dx} &amp;= (2 \times -0.5) x + (1 \times 5) x^0 \\
&amp;= -x + 5
\end{aligned}
\]</span></p>
<p>When <span class="math inline">\(x\)</span> is 0, the slope is 5 (<span class="math inline">\(-0 + 5\)</span>); when <span class="math inline">\(x\)</span> is 8, the slope is −3 (<span class="math inline">\(-8 + 5\)</span>), and so on. We can visualize this if we draw some lines tangent to some different points on the equation. The slope of each of these tangent lines represents the instantaneous slope of the parabola at each <span class="math inline">\(x\)</span> value.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># dy/dx = -x + 5</span></span>
<span><span class="va">parabola_slope</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">(</span><span class="op">-</span><span class="va">x</span><span class="op">)</span> <span class="op">+</span> <span class="fl">5</span></span>
<span></span>
<span><span class="va">slope_annotations</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span>, <span class="fl">8</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>y <span class="op">=</span> <span class="fu">a_parabola</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,</span>
<span>         slope <span class="op">=</span> <span class="fu">parabola_slope</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,</span>
<span>         intercept <span class="op">=</span> <span class="fu">find_intercept</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">slope</span><span class="op">)</span>,</span>
<span>         nice_slope <span class="op">=</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"Slope (dy/dx)&lt;br&gt;&lt;span style='font-size:12pt;color:{clrs[4]}'&gt;**{slope}**&lt;/span&gt;"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, color <span class="op">=</span> <span class="st">"grey50"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, color <span class="op">=</span> <span class="st">"grey50"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_function</span><span class="op">(</span>fun <span class="op">=</span> <span class="va">a_parabola</span>, linewidth <span class="op">=</span> <span class="fl">1</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_abline</span><span class="op">(</span>data <span class="op">=</span> <span class="va">slope_annotations</span>,</span>
<span>              <span class="fu">aes</span><span class="op">(</span>slope <span class="op">=</span> <span class="va">slope</span>, intercept <span class="op">=</span> <span class="va">intercept</span><span class="op">)</span>,</span>
<span>              linewidth <span class="op">=</span> <span class="fl">0.5</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, linetype <span class="op">=</span> <span class="st">"21"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>data <span class="op">=</span> <span class="va">slope_annotations</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span>,</span>
<span>             size <span class="op">=</span> <span class="fl">3</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_richtext</span><span class="op">(</span>data <span class="op">=</span> <span class="va">slope_annotations</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, label <span class="op">=</span> <span class="va">nice_slope</span><span class="op">)</span>,</span>
<span>                nudge_y <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlim</span><span class="op">(</span><span class="op">-</span><span class="fl">5</span>, <span class="fl">15</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"x"</span>, y <span class="op">=</span> <span class="st">"y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">5</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_mfx</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-parabola-labels-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>And here’s an animation of what the slope looks like across a whole range of <span class="math inline">\(x\)</span>s. Neat!</p>
<video controls="" width="90%" style="display: block; margin: auto;"><source src="video/parabola_slope.mp4" type="video/mp4"></video><div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>For the sake of space, I didn’t include the code for this here, but you can see how I made this animation with <a href="https://gganimate.com/">gganimate</a> at <a href="https://github.com/andrewheiss/ath-hugo/blob/main/content/blog/2022-05-20_marginalia/index.Rmarkdown#L317">the R Markdown file for this post at GitHub</a>.</p>
</div>
</div>
</section><section id="marginal-things-in-economics" class="level3"><h3 class="anchored" data-anchor-id="marginal-things-in-economics">Marginal things in economics</h3>
<p>In the calculus world, the term “marginal” isn’t used all that often. Instead they talk about derivatives. But in the end, all these marginal/derivative things are just slopes.</p>
<p>Before looking at how this applies to the world of statistics, let’s look at a quick example from economics, since economists also use the word “marginal” to refer to slopes. My first exposure to the word “marginal” meaning “changes in things” wasn’t actually in the world of statistics, but in economics. I took my first microeconomics class as a first-year MPA student in 2010 (and hated it; ironically <a href="https://econs21.classes.andrewheiss.com/">I teach it now</a> 🤷).</p>
<p>One common question in microeconomics relates to how people maximize their happiness, or utility, under budget constraints (<a href="https://www.andrewheiss.com/blog/2019/02/16/algebra-calculus-r-yacas/">see here for an R-based example</a>). Economists imagine that people have utility functions in their heads that take inputs and convert them to utility (or happiness points). For instance, let’s pretend that the happiness/utility (<span class="math inline">\(u\)</span>) you get from the number of cookies you eat (<span class="math inline">\(x\)</span>) is defined like this:</p>
<p><span class="math display">\[
u = -0.5x^2 + 5x
\]</span></p>
<p>Here’s what that looks like:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># u = -0.5x^2 + 5x</span></span>
<span><span class="va">u_cookies</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">(</span><span class="op">-</span><span class="fl">0.5</span> <span class="op">*</span> <span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">5</span> <span class="op">*</span> <span class="va">x</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, color <span class="op">=</span> <span class="st">"grey50"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, color <span class="op">=</span> <span class="st">"grey50"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_function</span><span class="op">(</span>fun <span class="op">=</span> <span class="va">u_cookies</span>, linewidth <span class="op">=</span> <span class="fl">1</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">12</span>, <span class="fl">2</span><span class="op">)</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">12</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Cookies"</span>, y <span class="op">=</span> <span class="st">"Utility (happiness points)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_mfx</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-cookies-utility-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>This parabola represents your <em>total</em> utility from cookies. Eat 1 cookie, get 4.5 happiness points; eat 3 cookies, get 10.5 points; eat 6, get 12 points; and so on.</p>
<p>The <em>marginal</em> utility, on the other hand, tells how how much more happiness you’d get from eating one more cookie. If you’re currently eating 1, how many more happiness points would you get by moving to 2? If if you’re eating 7, what would happen to your happiness if you moved to 8? We can figure this out by looking at the slope of the parabola, which will show us the instantaneous rate of change, or marginal utility, for any number of cookies.</p>
<p>Power rule time! <small>(or type <a href="https://www.wolframalpha.com/input?i=derivative+-0.5x%5E2+%2B+5x"><code>derivative -0.5x^2 + 5x</code></a> at Wolfram Alpha)</small></p>
<p><span class="math display">\[
\begin{aligned}
u &amp;= -0.5x^2 + 5x \\
\frac{du}{dx} &amp;= (2 \times -0.5) x^1 + 5x^0 \\
&amp;= -x + 5
\end{aligned}
\]</span></p>
<p>Let’s plot this really quick too:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># du/dx = -x + 5</span></span>
<span><span class="va">mu_cookies</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">-</span><span class="va">x</span> <span class="op">+</span> <span class="fl">5</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, color <span class="op">=</span> <span class="st">"grey50"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, color <span class="op">=</span> <span class="st">"grey50"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">5</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, </span>
<span>             linetype <span class="op">=</span> <span class="st">"21"</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_function</span><span class="op">(</span>fun <span class="op">=</span> <span class="va">mu_cookies</span>, linewidth <span class="op">=</span> <span class="fl">1</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">12</span>, <span class="fl">2</span><span class="op">)</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">12</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Cookies"</span>, y <span class="op">=</span> <span class="st">"Marginal utility (additional happiness points)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_mfx</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-cookies-marginal-utility-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>If you’re currently eating 1 cookie and you grab another one, you’ll gain 4 <em>extra</em> or <em>marginal</em> happiness points. If you’re eating 6 and you grab another one, you’ll actually <em>lose</em> some happiness—the marginal utility at 6 is -1. If you’re an economist who wants to maximize your happiness, you should eat the number of cookies where the extra happiness you’d get is 0, or where marginal utility is 0:</p>
<p><span class="math display">\[
\begin{aligned}
\frac{du}{dx} &amp;= -x + 5 \\
0 &amp;= -x + 5 \\
x &amp;= 5
\end{aligned}
\]</span></p>
<p>Eat 5 cookies, maximize your happiness. Eat any more and you’ll start getting disutility (like a stomachache). This is apparent in the marginal utility plot too. All the values of marginal utility to the left of 5 are positive; all the values to the right of 5 are negative. Economists call this <em>decreasing marginal utility</em>.</p>
<p>This relationship between total utility and marginal utility is even more apparent if we look at both simultaneously (for fun I included the second derivative (<span class="math inline">\(\frac{d^2u}{dx^2}\)</span>), or the slope of the first derivative, in the marginal utility panel):</p>
<video controls="" width="90%" style="display: block; margin: auto;"><source src="video/cookie_mfx.mp4" type="video/mp4"></video><div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Again, I omitted the code for this here, but <a href="https://github.com/andrewheiss/ath-hugo/blob/main/content/blog/2022-05-20_marginalia/index.Rmarkdown#L397">you can see it at GitHub</a>.</p>
</div>
</div>
</section></section><section id="what-about-marginal-things-in-statistics" class="level2"><h2 class="anchored" data-anchor-id="what-about-marginal-things-in-statistics">What about marginal things in statistics?</h2>
<p>Marginal utility, marginal revenue, marginal costs, and all those other marginal things are great for economists, but how does this “marginal” concept relate to statistics? Is it the same?</p>
<p>Yep! Basically!</p>
<p>At its core, regression modeling in statistics is all about fancy ways of finding averages and fancy ways of drawing lines. Even if you’re doing non-regression things like t-tests, <a href="https://lindeloev.github.io/tests-as-linear/">those are technically still just regression behind the scenes</a>.</p>
<p>Statistics is all about lines, and lines have slopes, or derivatives. These slopes represent the marginal changes in an outcome. As you move an independent/explanatory variable <span class="math inline">\(x\)</span>, what happens to the dependent/outcome variable <span class="math inline">\(y\)</span>?</p>
<section id="regression-sliders-switches-and-mixing-boards" class="level3"><h3 class="anchored" data-anchor-id="regression-sliders-switches-and-mixing-boards">Regression, sliders, switches, and mixing boards</h3>
<p>Before getting into the mechanics of statistical marginal effects, it’s helpful to review what exactly regression coefficients are doing in statistical models, especially when dealing with both continuous and categorical explanatory variables.</p>
<p>When I teach statistics to my students, my favorite analogy for regression is to think of sliders and switches. Sliders represent continuous variables: as you move them up and down, something gradual happens to the resulting light. Switches represent categorical variables: as you turn them on and off, there are larger overall changes to the resulting light.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="images/slider-switch-annotated-80.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Let’s look at some super tiny quick models to illustrate this, using data from <a href="https://allisonhorst.github.io/palmerpenguins/"><strong>palmerpenguins</strong></a>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">penguins</span> <span class="op">&lt;-</span> <span class="va">penguins</span> <span class="op">|&gt;</span> <span class="fu">drop_na</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_slider</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">body_mass_g</span> <span class="op">~</span> <span class="va">flipper_length_mm</span>, data <span class="op">=</span> <span class="va">penguins</span><span class="op">)</span></span>
<span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_slider</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 2 × 5</span></span>
<span><span class="co">##   term              estimate std.error statistic   p.value</span></span>
<span><span class="co">##   &lt;chr&gt;                &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 (Intercept)        -5872.     310.       -18.9 1.18e- 54</span></span>
<span><span class="co">## 2 flipper_length_mm     50.2      1.54      32.6 3.13e-105</span></span>
<span></span>
<span><span class="va">model_switch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">body_mass_g</span> <span class="op">~</span> <span class="va">species</span>, data <span class="op">=</span> <span class="va">penguins</span><span class="op">)</span></span>
<span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_switch</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 3 × 5</span></span>
<span><span class="co">##   term             estimate std.error statistic   p.value</span></span>
<span><span class="co">##   &lt;chr&gt;               &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 (Intercept)        3706.       38.1    97.2   6.88e-245</span></span>
<span><span class="co">## 2 speciesChinstrap     26.9      67.7     0.398 6.91e-  1</span></span>
<span><span class="co">## 3 speciesGentoo      1386.       56.9    24.4   1.01e- 75</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Disregard the intercept for now and just look at the coefficients for <code>flipper_length_mm</code> and <code>species*</code>. Flipper length is a continuous variable, so it’s a slider—as flipper length increases by 1 mm, penguin body mass increases by 50 grams. Slide it up more and you’ll see a bigger increase: if flipper length increases by 10 mm, body mass should increase by 500 grams. Slide it down for fun too! If flipper length decreases by 1 mm, body mass decreases by 50 grams. Imagine it like a sliding light switch.</p>
<p>Species, on the other hand, is a switch. There are three possible values here: Adelie, Chinstrap, and Gentoo. The base case in the results here is Adelie since it comes fist alphabetically. The coefficients for <code>speciesChinstrap</code> and <code>speciesGentoo</code> aren’t sliders—you can’t talk about one-unit increases in Gentoo-ness or Chinstrap-ness. Instead, the values show what happens in relation to the average weight of Adelie penguins if you flip the Chinstrap or Gentoo switch. Chinstrap penguins are 29 grams heavier than Adelie penguins on average, while the chonky Gentoo penguins are 1.4 kg heavier than Adellie penguins. With these categorical coefficients, we’re flipping a switch on and off: Adelie vs.&nbsp;Chinstrap and Adelie vs.&nbsp;Gentoo.</p>
<p>This slider and switch analogy holds when thinking about multiple regression too, though we need to think of lots of sliders and switches, like in an audio mixer board:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="images/mixer-board-annotated-80.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>With a mixer board, we can move many different sliders up and down and use different combinations of switches, all of which ultimately influence the audio output.</p>
<p>Let’s make a more complex mixer-board-esque regression model with multiple continuous (slider) and categorical (switch) explanatory variables:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_mixer</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">body_mass_g</span> <span class="op">~</span> <span class="va">flipper_length_mm</span> <span class="op">+</span> <span class="va">bill_depth_mm</span> <span class="op">+</span> <span class="va">species</span> <span class="op">+</span> <span class="va">sex</span>,</span>
<span>                  data <span class="op">=</span> <span class="va">penguins</span><span class="op">)</span></span>
<span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_mixer</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 6 × 5</span></span>
<span><span class="co">##   term              estimate std.error statistic  p.value</span></span>
<span><span class="co">##   &lt;chr&gt;                &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">## 1 (Intercept)        -1212.     568.       -2.13 3.36e- 2</span></span>
<span><span class="co">## 2 flipper_length_mm     17.5      2.87      6.12 2.66e- 9</span></span>
<span><span class="co">## 3 bill_depth_mm         74.4     19.7       3.77 1.91e- 4</span></span>
<span><span class="co">## 4 speciesChinstrap     -78.9     45.5      -1.73 8.38e- 2</span></span>
<span><span class="co">## 5 speciesGentoo       1154.     119.        9.73 8.02e-20</span></span>
<span><span class="co">## 6 sexmale              435.      44.8       9.72 8.79e-20</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Interpreting these coefficients is a little different now, since we’re working with multiple moving parts. In regular stats class, you’ve probably learned to say something like “Holding all other variables constant, a 1 mm increase in flipper length is associated with a 17.5 gram increase in body mass, on average” (slider) or “Holding all other variables constant, Chinstrap penguins are 79 grams lighter than Adelie penguins, on average” (switch).</p>
<p>This idea of “holding everything constant” though can be tricky to wrap your head around. Imagining this model like a mixer board can help, though. Pretend that you set the bill depth slider to some value (0, the average, whatever), you flip the Chinstrap and Gentoo switches off, you flip the male switch off, and then you slide only the flipper length switch up and down. You’d be looking at the marginal effect of flipper length for female Adelie penguins with an average (or 0 or whatever) length of bill depth. Stop moving the flipper length slider and start moving the bill depth slider and you’ll see the marginal effect of bill depth for female Adelie penguins. Flip on the male switch and you’ll see the marginal effect of bill depth for male Adelie penguins. Flip on the Gentoo switch and you’ll see the marginal effect of bill depth for male Gentoo penguins. And so on.</p>
<p>In calculus, if you have a model like <code>model_slider</code> with just one continuous variable, the slope or derivative of that variable is the <em>total</em> derivative, or <span class="math inline">\(\frac{dy}{dx}\)</span>. If you have a model like <code>model_mixer</code> with lots of other variables, the slope or derivative of any of the individual explanatory variables is the <em>partial</em> derivative, or <span class="math inline">\(\frac{\partial y}{\partial x}\)</span>, where all other variables are held constant.</p>
</section></section><section id="what-are-marginal-effects" class="level2"><h2 class="anchored" data-anchor-id="what-are-marginal-effects">What are marginal effects?</h2>
<p>Oops. When talking about these penguin regression results up there ↑ I used the term “marginal effect,” but we haven’t officially defined it in the statistics world yet. It’s tricky to do that, though, because there are so many synonyms and near synonyms for the idea of a statistical effect, like marginal effect, marginal mean, marginal slope, conditional effect, conditional marginal effect, and so on.</p>
<p>Formally defined, a marginal effect is a partial derivative from a regression equation. It’s the instantaneous slope of one of the explanatory variables in a model, with all the other variables held constant. If we continue with the mixing board analogy, it represents what would happen to the resulting audio levels if we set all sliders and switches to some stationary level and we moved just one slider up a tiny amount.</p>
<p>However, in practice, people use the term “marginal effect” to mean a lot more than just a partial derivative. For instance, in a randomized controlled trial, the difference in group means between the treatment and control groups is often called a marginal effect (and sometimes called a conditional effect, or even a conditional marginal effect). The term is also often used to talk about other group differences, like differences in penguin weights across species.</p>
<p>In my mind, all these quasi-synonymous terms represent the same idea of a <em>statistical effect</em>, or what would happen to an outcome <span class="math inline">\(y\)</span> if one of the explanatory variables <span class="math inline">\(x\)</span> (be it continuous, categorical, or whatever) were different. The more precise terms like marginal effect, conditional effect, marginal mean, and so on, are variations on this theme. This is similar to how a square is a rectangle, but a rectangle is not a square—they’re all super similar, but with minor subtle differences depending on the type of <span class="math inline">\(x\)</span> we’re working with:</p>
<ul>
<li>
<strong>Marginal effect</strong>: the statistical effect for continuous explanatory variables; the partial derivative of a variable in a regression model; the effect of a single slider</li>
<li>
<strong>Conditional effect</strong> or <strong>group contrast</strong>: the statistical effect for categorical explanatory variables; the difference in means when a condition is on vs.&nbsp;when it is off; the effect of a single switch</li>
</ul></section><section id="slopes-and-marginal-effects" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="slopes-and-marginal-effects">Slopes and marginal effects</h2>
<p>Let’s look at true marginal effects, or the partial derivatives of continuous variables in a model (or sliders, in our slider/switch analogy). For the rest of this post, we’ll move away from penguins and instead look at some cross-national data about the relationship between public sector corruption, the legal requirement to disclose donations to political campaigns, and respect for human rights, since that’s all more related to what I do in my own research (I know nothing about penguins). We’ll explore two different political science/policy questions:</p>
<ol type="1">
<li>What is the relationship between a country’s respect for civil liberties and its level of public sector corruption? Do countries that respect individual human rights tend to have less corruption too?</li>
<li>Does a country’s level of public sector corruption influence whether it has laws that require campaign finance disclosure? How does corruption influence a country’s choice to be electorally transparent?</li>
</ol>
<p>We’ll use data from the <a href="https://data.worldbank.org/">World Bank</a> and from the <a href="https://www.v-dem.net/">Varieties of Democracy project</a> and just look at one year of data (2020) so we don’t have to worry about panel data. There’s <a href="https://github.com/vdeminstitute/vdemdata">a great R package for accessing V-Dem data</a> without needing to download it manually from their website, but it’s not on CRAN—it has to be installed from GitHub.</p>
<p>V-Dem and the World Bank have hundreds of different variables, but we only need a few, and we’ll make a few adjustments to the ones we do need. Here’s what we’ll do:</p>
<ul>
<li>
<p><strong>Main continuous outcome</strong> and <strong>continuous explanatory variable</strong>: Public sector corruption index (<code>v2x_pubcorr</code> in V-Dem). This is a 0–1 scale that measures…</p>
<blockquote class="blockquote">
<p>To what extent do public sector employees grant favors in exchange for bribes, kickbacks, or other material inducements, and how often do they steal, embezzle, or misappropriate public funds or other state resources for personal or family use?</p>
</blockquote>
<p>Higher values represent <em>worse</em> corruption.</p>
</li>
<li>
<p><strong>Main binary outcome</strong>: Disclosure of campaign donations (<code>v2eldonate_ord</code> in V-Dem). This is an ordinal variable with these possible values:</p>
<blockquote class="blockquote">
<ul>
<li>0: No.&nbsp;There are no disclosure requirements.</li>
<li>1: Not really. There are some, possibly partial, disclosure requirements in place but they are not observed or enforced most of the time.</li>
<li>2: Ambiguous. There are disclosure requirements in place, but it is unclear to what extent they are observed or enforced.</li>
<li>3: Mostly. The disclosure requirements may not be fully comprehensive (some donations not covered), but most existing arrangements are observed and enforced.</li>
<li>4: Yes. There are comprehensive requirements and they are observed and enforced almost all the time.</li>
</ul>
</blockquote>
<p>For the sake of simplicity, we’ll collapse this into a binary variable. Countries have disclosure laws if they score a 3 or a 4; they don’t if they score a 0, 1, or 2.</p>
</li>
<li>
<p><strong>Other continuous explanatory variables</strong>:</p>
<ul>
<li>Electoral democracy index, or polyarchy (<code>v2x_polyarchy</code> in V-Dem): a continuous variable measured from 0–1 with higher values representing greater achievement of democratic ideals</li>
<li>Civil liberties index (<code>v2x_civlib</code> in V-Dem): a continuous variable measured from 0–1 with higher values representing better respect for human rights and civil liberties</li>
<li>Log GDP per capita (<a href="https://data.worldbank.org/indicator/NY.GDP.PCAP.KD"><code>NY.GDP.PCAP.KD</code></a> at the World Bank): GDP per capita in constant 2015 USD</li>
</ul>
</li>
<li>
<p><strong>Region</strong>: V-Dem provides multiple regional variables with varying specificity (19 different regions, 10 different regions, and 6 different regions). We’ll use the 6-region version (<code>e_regionpol_6C</code>) for simplicity here:</p>
<blockquote class="blockquote">
<ul>
<li>1: Eastern Europe and Central Asia (including Mongolia)</li>
<li>2: Latin America and the Caribbean</li>
<li>3: The Middle East and North Africa (including Israel and Turkey, excluding Cyprus)</li>
<li>4: Sub-Saharan Africa</li>
<li>5: Western Europe and North America (including Cyprus, Australia and New Zealand)</li>
<li>6: Asia and Pacific (excluding Australia and New Zealand)</li>
</ul>
</blockquote>
</li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Get data from the World Bank's API</span></span>
<span><span class="va">wdi_raw</span> <span class="op">&lt;-</span> <span class="fu">WDI</span><span class="op">(</span>country <span class="op">=</span> <span class="st">"all"</span>, </span>
<span>               indicator <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>population <span class="op">=</span> <span class="st">"SP.POP.TOTL"</span>,</span>
<span>                             gdp_percapita <span class="op">=</span> <span class="st">"NY.GDP.PCAP.KD"</span><span class="op">)</span>, </span>
<span>               start <span class="op">=</span> <span class="fl">2000</span>, end <span class="op">=</span> <span class="fl">2020</span>, extra <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Clean up the World Bank data</span></span>
<span><span class="va">wdi_2020</span> <span class="op">&lt;-</span> <span class="va">wdi_raw</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">region</span> <span class="op">!=</span> <span class="st">"Aggregates"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">year</span> <span class="op">==</span> <span class="fl">2020</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>log_gdp_percapita <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">gdp_percapita</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">region</span>, <span class="op">-</span><span class="va">status</span>, <span class="op">-</span><span class="va">year</span>, <span class="op">-</span><span class="va">country</span>, <span class="op">-</span><span class="va">lastupdated</span>, <span class="op">-</span><span class="va">lending</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get data from V-Dem and clean it up</span></span>
<span><span class="va">vdem_2020</span> <span class="op">&lt;-</span> <span class="va">vdem</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">country_name</span>, <span class="va">country_text_id</span>, <span class="va">year</span>, region <span class="op">=</span> <span class="va">e_regionpol_6C</span>,</span>
<span>         disclose_donations_ord <span class="op">=</span> <span class="va">v2eldonate_ord</span>, </span>
<span>         public_sector_corruption <span class="op">=</span> <span class="va">v2x_pubcorr</span>,</span>
<span>         polyarchy <span class="op">=</span> <span class="va">v2x_polyarchy</span>, civil_liberties <span class="op">=</span> <span class="va">v2x_civlib</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">year</span> <span class="op">==</span> <span class="fl">2020</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>disclose_donations <span class="op">=</span> <span class="va">disclose_donations_ord</span> <span class="op">&gt;=</span> <span class="fl">3</span>,</span>
<span>         disclose_donations <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">disclose_donations</span><span class="op">)</span>, <span class="cn">FALSE</span>, <span class="va">disclose_donations</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Scale these up so it's easier to talk about 1-unit changes</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">public_sector_corruption</span>, <span class="va">polyarchy</span>, <span class="va">civil_liberties</span><span class="op">)</span>, <span class="op">~</span> <span class="va">.</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>region <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">region</span>, </span>
<span>                         labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Eastern Europe and Central Asia"</span>,</span>
<span>                                    <span class="st">"Latin America and the Caribbean"</span>,</span>
<span>                                    <span class="st">"Middle East and North Africa"</span>,</span>
<span>                                    <span class="st">"Sub-Saharan Africa"</span>,</span>
<span>                                    <span class="st">"Western Europe and North America"</span>,</span>
<span>                                    <span class="st">"Asia and Pacific"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Combine World Bank and V-Dem data into a single dataset</span></span>
<span><span class="va">corruption</span> <span class="op">&lt;-</span> <span class="va">vdem_2020</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">wdi_2020</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"country_text_id"</span> <span class="op">=</span> <span class="st">"iso3c"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">drop_na</span><span class="op">(</span><span class="va">gdp_percapita</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">glimpse</span><span class="op">(</span><span class="va">corruption</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Static data!
</div>
</div>
<div class="callout-body-container callout-body">
<p>When I wrote this in May 2022, I based it on the data that both the World Bank and V-Dem had available at that time. In the months since then, they’ve revised their data. If you run all this code now (I’m writing this in February 2024), you’ll get slightly different results because of these revisions. For instance, when this ran in 2022, the World Bank reported that Mexico’s log GDP per capita in 2020 was 9.10; when running this in 2024, it reports that it was 9.13. This is a minor difference, but all these minor differences change the results slightly. The code in this chunk above still runs just fine, you’ll just get slightly different data, and thus slightly different results.</p>
<p>So, in the interest of reproducibility, you should download and load this <code>.RData</code> file that contains <code>wdi_raw</code>, <code>wdi_2020</code>, <code>vdem_2020</code>, and <code>corruption</code> from when I wrote this in 2022.</p>
<ul>
<li><a href="data_2022.Rdata"><code>data_2022.RData</code></a></li>
</ul>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"data_2022.RData"</span><span class="op">)</span></span>
<span><span class="fu">glimpse</span><span class="op">(</span><span class="va">corruption</span><span class="op">)</span></span>
<span><span class="co">## Rows: 168</span></span>
<span><span class="co">## Columns: 17</span></span>
<span><span class="co">## $ country_name             &lt;chr&gt; "Mexico", "Suriname", "Sweden", "Switzerland", "Ghana",…</span></span>
<span><span class="co">## $ country_text_id          &lt;chr&gt; "MEX", "SUR", "SWE", "CHE", "GHA", "ZAF", "JPN", "MMR",…</span></span>
<span><span class="co">## $ year                     &lt;dbl&gt; 2020, 2020, 2020, 2020, 2020, 2020, 2020, 2020, 2020, 2…</span></span>
<span><span class="co">## $ region                   &lt;fct&gt; Latin America and the Caribbean, Latin America and the …</span></span>
<span><span class="co">## $ disclose_donations_ord   &lt;dbl&gt; 3, 1, 2, 0, 2, 1, 3, 2, 3, 2, 2, 0, 3, 3, 4, 3, 4, 2, 1…</span></span>
<span><span class="co">## $ public_sector_corruption &lt;dbl&gt; 48.8, 24.8, 1.3, 1.4, 65.2, 57.1, 3.7, 36.8, 70.6, 71.2…</span></span>
<span><span class="co">## $ polyarchy                &lt;dbl&gt; 64.7, 76.1, 90.8, 89.4, 72.0, 70.3, 83.2, 43.6, 26.2, 4…</span></span>
<span><span class="co">## $ civil_liberties          &lt;dbl&gt; 71.2, 87.7, 96.9, 94.8, 90.4, 82.2, 92.8, 56.9, 43.0, 8…</span></span>
<span><span class="co">## $ disclose_donations       &lt;lgl&gt; TRUE, FALSE, FALSE, FALSE, FALSE, FALSE, TRUE, FALSE, T…</span></span>
<span><span class="co">## $ iso2c                    &lt;chr&gt; "MX", "SR", "SE", "CH", "GH", "ZA", "JP", "MM", "RU", "…</span></span>
<span><span class="co">## $ population               &lt;dbl&gt; 1.29e+08, 5.87e+05, 1.04e+07, 8.64e+06, 3.11e+07, 5.93e…</span></span>
<span><span class="co">## $ gdp_percapita            &lt;dbl&gt; 8923, 7530, 51542, 85685, 2021, 5659, 34556, 1587, 9711…</span></span>
<span><span class="co">## $ capital                  &lt;chr&gt; "Mexico City", "Paramaribo", "Stockholm", "Bern", "Accr…</span></span>
<span><span class="co">## $ longitude                &lt;chr&gt; "-99.1276", "-55.1679", "18.0645", "7.44821", "-0.20795…</span></span>
<span><span class="co">## $ latitude                 &lt;chr&gt; "19.427", "5.8232", "59.3327", "46.948", "5.57045", "-2…</span></span>
<span><span class="co">## $ income                   &lt;chr&gt; "Upper middle income", "Upper middle income", "High inc…</span></span>
<span><span class="co">## $ log_gdp_percapita        &lt;dbl&gt; 9.10, 8.93, 10.85, 11.36, 7.61, 8.64, 10.45, 7.37, 9.18…</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s start off by looking at the effect of civil liberties on public sector corruption by using a really simple model with one explanatory variable:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">plot_corruption</span> <span class="op">&lt;-</span> <span class="va">corruption</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>highlight <span class="op">=</span> <span class="va">civil_liberties</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">civil_liberties</span><span class="op">)</span> <span class="op">|</span> </span>
<span>           <span class="va">civil_liberties</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">civil_liberties</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">plot_corruption</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">civil_liberties</span>, y <span class="op">=</span> <span class="va">public_sector_corruption</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">highlight</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_smooth</span><span class="op">(</span>method <span class="op">=</span> <span class="st">"lm"</span>, formula <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="va">x</span>, linewidth <span class="op">=</span> <span class="fl">1</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_label_repel</span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">plot_corruption</span>, <span class="va">highlight</span> <span class="op">==</span> <span class="cn">TRUE</span><span class="op">)</span>, </span>
<span>                   <span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">country_name</span><span class="op">)</span>, seed <span class="op">=</span> <span class="fl">1234</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"grey30"</span>, <span class="va">clrs</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Civil liberties index"</span>, y <span class="op">=</span> <span class="st">"Public sector corruption index"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_mfx</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-civlib-corruption-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_simple</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">public_sector_corruption</span> <span class="op">~</span> <span class="va">civil_liberties</span>,</span>
<span>                   data <span class="op">=</span> <span class="va">corruption</span><span class="op">)</span></span>
<span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_simple</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 2 × 5</span></span>
<span><span class="co">##   term            estimate std.error statistic  p.value</span></span>
<span><span class="co">##   &lt;chr&gt;              &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">## 1 (Intercept)      102.       5.72        17.8 2.21e-40</span></span>
<span><span class="co">## 2 civil_liberties   -0.805    0.0779     -10.3 1.27e-19</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We have a nice fitted OLS line here with uncertainty around it. What’s the marginal effect of civil liberties on public sector corruption? What kind of calculus and math do we need to do to find it? Not much, happily!</p>
<p>In general, we have a regression formula here that looks a lot like the <span class="math inline">\(y = mx + b\)</span> stuff we were using before, only now the intercept <span class="math inline">\(b\)</span> is <span class="math inline">\(\beta_0\)</span> and the slope <span class="math inline">\(m\)</span> is <span class="math inline">\(\beta_1\)</span>. If we use the power rule to find the first derivative of this equation, we’ll see that the slope of the entire line is <span class="math inline">\(\beta_1\)</span>:</p>
<p><span class="math display">\[
\begin{aligned}
\operatorname{E}[y \mid x] &amp;= \beta_0 + \beta_1 x \\[4pt]
\frac{\partial \operatorname{E}[y \mid x]}{\partial x} &amp;= \beta_1
\end{aligned}
\]</span></p>
<p>If we add actual coefficients from the model into the formula we can see that the <span class="math inline">\(\beta_1\)</span> coefficient for <code>civil_liberties</code> (−0.80) is indeed the marginal effect:</p>
<p><span class="math display">\[
\begin{aligned}
\operatorname{E}[\text{Corruption} \mid \text{Civil liberties}] &amp;= 101.89 + (−0.80 \times \text{Civil liberties}) \\[6pt]
\frac{\partial \operatorname{E}[\text{Corruption} \mid \text{Civil liberties}]}{\partial\ \text{Civil liberties}} &amp;= −0.80
\end{aligned}
\]</span></p>
<p>The <span class="math inline">\(\beta_1\)</span> coefficient by itself is thus enough to tell us what the effect of moving civil liberties around is—it is <em>the</em> marginal effect of civil liberties on public sector corruption. Slide the civil liberties index up by 1 point and public sector corruption will be −0.80 points lower, on average.</p>
<p>Importantly, this is only the case because we’re using simple linear regression without any curvy parts. If your model is completely linear without any polynomials or logs or interaction terms or doesn’t use curvy regression families like logistic or beta regression, you can use individual coefficients as marginal effects.</p>
<p>Let’s see what happens when we add curves. We’ll add a polynomial term, including both <code>civil_liberties</code> and <code>civil_liberties^2</code> so that we can capture the parabolic shape of the relationship between civil liberties and corruption:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">plot_corruption</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">civil_liberties</span>, y <span class="op">=</span> <span class="va">public_sector_corruption</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">highlight</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_smooth</span><span class="op">(</span>method <span class="op">=</span> <span class="st">"lm"</span>, formula <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="va">x</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>, linewidth <span class="op">=</span> <span class="fl">1</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_label_repel</span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">plot_corruption</span>, <span class="va">highlight</span> <span class="op">==</span> <span class="cn">TRUE</span><span class="op">)</span>, </span>
<span>                   <span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">country_name</span><span class="op">)</span>, seed <span class="op">=</span> <span class="fl">1234</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"grey30"</span>, <span class="va">clrs</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Civil liberties index"</span>, y <span class="op">=</span> <span class="st">"Public sector corruption index"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_mfx</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-civlib-corruption-sq-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>This is most likely not a great model fit in real life, but using the quadratic term here makes a neat curved line, so we’ll go with it for the sake of the example. But don’t, like, make any policy decisions based on this line.</p>
<p>When working with polynomials in regression, the coefficients appear and work a little differently:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_sq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">public_sector_corruption</span> <span class="op">~</span> <span class="va">civil_liberties</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="va">civil_liberties</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>               data <span class="op">=</span> <span class="va">corruption</span><span class="op">)</span></span>
<span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_sq</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 3 × 5</span></span>
<span><span class="co">##   term                 estimate std.error statistic      p.value</span></span>
<span><span class="co">##   &lt;chr&gt;                   &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;        &lt;dbl&gt;</span></span>
<span><span class="co">## 1 (Intercept)           41.9     11.6          3.60 0.000427    </span></span>
<span><span class="co">## 2 civil_liberties        1.58     0.419        3.77 0.000230    </span></span>
<span><span class="co">## 3 I(civil_liberties^2)  -0.0197   0.00341     -5.77 0.0000000382</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We now have two coefficients for civil liberties: <span class="math inline">\(\beta_1\)</span> and <span class="math inline">\(\beta_2\)</span>. Importantly, we cannot use just one of these to talk about the marginal effect of changing civil liberties. A one-point increase in the civil liberties index is <em>not</em> associated with a 1.58 increase or a −0.02 decrease in corruption. The slope of the fitted line now comprises multiple moving parts: (1) the coefficient for the non-squared term, (2) the coefficient for the squared term, and (3) some value of civil liberties, since the slope isn’t the same across the whole line. The math shows us why and how.</p>
<p>We have terms for both <span class="math inline">\(x\)</span> and <span class="math inline">\(x^2\)</span> in our model. To find the derivative, we can use the power rule to get rid of the <span class="math inline">\(x\)</span> term (<span class="math inline">\(\beta x^1 \rightarrow (1 \times \beta x^0) \rightarrow \beta\)</span>), but the <span class="math inline">\(x\)</span> in the <span class="math inline">\(x^2\)</span> term doesn’t disappear (<span class="math inline">\(\beta x^2 \rightarrow (2 \times \beta \times x^1) \rightarrow 2 \beta x\)</span>). The slope of the line thus depends on both the βs and the <span class="math inline">\(x\)</span>:</p>
<p><span class="math display">\[
\begin{aligned}
\operatorname{E}[y \mid x] &amp;= \beta_0 + \beta_1 x + \beta_2 x^2 \\[4pt]
\frac{\partial \operatorname{E}[y \mid x]}{\partial x} &amp;= \beta_1 + 2 \beta_2 x
\end{aligned}
\]</span></p>
<p>Here’s what that looks like with the results of our civil liberties and corruption model:</p>
<p><span class="math display">\[
\begin{aligned}
\operatorname{E}[\text{Corruption} \mid \text{Civil liberties}] &amp;= 41.86 + (1.58 \times \text{Civil liberties}) + (−0.02 \times \text{Civil liberties}^2) \\[6pt]
\frac{\partial \operatorname{E}[\text{Corruption} \mid \text{Civil liberties}]}{\partial\ \text{Civil liberties}} &amp;= 1.58 + (2\times −0.02 \times \text{Civil liberties})
\end{aligned}
\]</span></p>
<p>Because the actual slope depends on the value of civil liberties, we need to plug in different values to get the instantaneous slopes at each value. Let’s plug in 25, 55, and 80, for fun:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Extract the two civil_liberties coefficients</span></span>
<span><span class="va">civ_lib1</span> <span class="op">&lt;-</span> <span class="fu">tidy</span><span class="op">(</span><span class="va">model_sq</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">term</span> <span class="op">==</span> <span class="st">"civil_liberties"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">pull</span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span></span>
<span><span class="va">civ_lib2</span> <span class="op">&lt;-</span> <span class="fu">tidy</span><span class="op">(</span><span class="va">model_sq</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">term</span> <span class="op">==</span> <span class="st">"I(civil_liberties^2)"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">pull</span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Make a little function to do the math</span></span>
<span><span class="va">civ_lib_slope</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">civ_lib1</span> <span class="op">+</span> <span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">civ_lib2</span> <span class="op">*</span> <span class="va">x</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">civ_lib_slope</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">25</span>, <span class="fl">55</span>, <span class="fl">80</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## [1]  0.594 -0.587 -1.572</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We have three different slopes now: 0.59, −0.59, and −1.57 for civil liberties of 25, 55, and 80, respectively. We can plot these as tangent lines:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tangents</span> <span class="op">&lt;-</span> <span class="va">model_sq</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">augment</span><span class="op">(</span>newdata <span class="op">=</span> <span class="fu">tibble</span><span class="op">(</span>civil_liberties <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">25</span>, <span class="fl">55</span>, <span class="fl">80</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>slope <span class="op">=</span> <span class="fu">civ_lib_slope</span><span class="op">(</span><span class="va">civil_liberties</span><span class="op">)</span>,</span>
<span>         intercept <span class="op">=</span> <span class="fu">find_intercept</span><span class="op">(</span><span class="va">civil_liberties</span>, <span class="va">.fitted</span>, <span class="va">slope</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>nice_label <span class="op">=</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"Civil liberties: {civil_liberties}&lt;br&gt;"</span>,</span>
<span>                           <span class="st">"Fitted corruption: {nice_number(.fitted)}&lt;br&gt;"</span>,</span>
<span>                           <span class="st">"Slope: **{nice_number(slope)}**"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">corruption</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">civil_liberties</span>, y <span class="op">=</span> <span class="va">public_sector_corruption</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"grey30"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_smooth</span><span class="op">(</span>method <span class="op">=</span> <span class="st">"lm"</span>, formula <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="va">x</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>, linewidth <span class="op">=</span> <span class="fl">1</span>, se <span class="op">=</span> <span class="cn">FALSE</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_abline</span><span class="op">(</span>data <span class="op">=</span> <span class="va">tangents</span>, <span class="fu">aes</span><span class="op">(</span>slope <span class="op">=</span> <span class="va">slope</span>, intercept <span class="op">=</span> <span class="va">intercept</span><span class="op">)</span>, </span>
<span>              linewidth <span class="op">=</span> <span class="fl">0.5</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, linetype <span class="op">=</span> <span class="st">"21"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>data <span class="op">=</span> <span class="va">tangents</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">civil_liberties</span>, y <span class="op">=</span> <span class="va">.fitted</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">4</span>, shape <span class="op">=</span> <span class="fl">18</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_richtext</span><span class="op">(</span>data <span class="op">=</span> <span class="va">tangents</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">civil_liberties</span>, y <span class="op">=</span> <span class="va">.fitted</span>, label <span class="op">=</span> <span class="va">nice_label</span><span class="op">)</span>, nudge_y <span class="op">=</span> <span class="op">-</span><span class="fl">7</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Civil liberties index"</span>, y <span class="op">=</span> <span class="st">"Public sector corruption index"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_mfx</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-civlib-slopes-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Doing the calculus by hand here is tedious though, especially once we start working with even more covariates in a model. Plus we don’t have any information about uncertainty, like standard errors and confidence intervals. There are official mathy ways to figure those out by hand, but who even wants to do that. Fortunately there are two different packages that let us find marginal slopes automatically, with important differences in their procedures, which we’ll explore in detail below. But before looking at their differences, let’s first see how they work.</p>
<p>First, we can use the <code>slopes()</code> function from <strong>marginaleffects</strong> to see the slope (the <code>estimate</code> column here) at various levels of civil liberties. We’ll look at the mechanics of this function in more detail in the next section—for now we’ll just plug in our three values of civil liberties and see what happens. We’ll also set the <code>eps</code> argument: behind the scenes, <code>slopes()</code> doesn’t actually do the by-hand calculus of piecing together first derivatives—instead, it calculates the fitted value of corruption when civil liberties is a value, calculates the fitted value of corruption when civil liberties is that same value plus a tiny bit more, and then subtracts them. The <code>eps</code> value controls that tiny amount. In this case, it’ll calculate the predictions for <code>civil_liberties = 25</code> and <code>civil_liberties = 25.001</code> and then find the slope of the tiny tangent line between those two points. It’s a neat little mathy trick to avoid calculus.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_sq</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">slopes</span><span class="op">(</span>newdata <span class="op">=</span> <span class="fu">datagrid</span><span class="op">(</span>civil_liberties <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">25</span>, <span class="fl">55</span>, <span class="fl">80</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         eps <span class="op">=</span> <span class="fl">0.001</span><span class="op">)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##             Term Estimate Std. Error      z Pr(&gt;|z|)   2.5 % 97.5 % civil_liberties</span></span>
<span><span class="co">##  civil_liberties    0.594     0.2528   2.35   0.0187  0.0989  1.090              25</span></span>
<span><span class="co">##  civil_liberties   -0.587     0.0806  -7.28   &lt;0.001 -0.7452 -0.429              55</span></span>
<span><span class="co">##  civil_liberties   -1.572     0.1509 -10.42   &lt;0.001 -1.8676 -1.276              80</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Columns: rowid, term, estimate, std.error, statistic, p.value, conf.low, conf.high, predicted, predicted_hi, predicted_lo, public_sector_corruption, civil_liberties</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Second, we can use the <code>emtrends()</code> function from <strong>emmeans</strong> to also see the slope (the <code>civil_liberties.trend</code> column here) at various levels of civil liberties. The syntax is different (note the <code>delta.var</code> argument instead of <code>eps</code>), but the results are essentially the same:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_sq</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">emtrends</span><span class="op">(</span><span class="op">~</span> <span class="va">civil_liberties</span>, var <span class="op">=</span> <span class="st">"civil_liberties"</span>,</span>
<span>           at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>civil_liberties <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">25</span>, <span class="fl">55</span>, <span class="fl">80</span><span class="op">)</span><span class="op">)</span>,</span>
<span>           delta.var <span class="op">=</span> <span class="fl">0.001</span><span class="op">)</span></span>
<span><span class="co">##  civil_liberties civil_liberties.trend     SE  df lower.CL upper.CL</span></span>
<span><span class="co">##               25                 0.594 0.2527 165    0.095    1.093</span></span>
<span><span class="co">##               55                -0.587 0.0806 165   -0.746   -0.428</span></span>
<span><span class="co">##               80                -1.572 0.1509 165   -1.870   -1.274</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Confidence level used: 0.95</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Both <code>slopes()</code> and <code>emtrends()</code> also helpfully provide uncertainty, with standard errors and confidence intervals, with a lot of super fancy math behind the scenes to make it all work. <code>slopes()</code> provides p-values automatically; if you want p-values from <code>emtrends()</code> you need to wrap it in <code>test()</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_sq</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">emtrends</span><span class="op">(</span><span class="op">~</span> <span class="va">civil_liberties</span>, var <span class="op">=</span> <span class="st">"civil_liberties"</span>,</span>
<span>           at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>civil_liberties <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">25</span>, <span class="fl">55</span>, <span class="fl">80</span><span class="op">)</span><span class="op">)</span>,</span>
<span>           delta.var <span class="op">=</span> <span class="fl">0.001</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">test</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">##  civil_liberties civil_liberties.trend     SE  df t.ratio p.value</span></span>
<span><span class="co">##               25                 0.594 0.2527 165   2.350  0.0198</span></span>
<span><span class="co">##               55                -0.587 0.0806 165  -7.280  &lt;.0001</span></span>
<span><span class="co">##               80                -1.572 0.1509 165 -10.420  &lt;.0001</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Another neat thing about these more automatic functions is that we can use them to create a marginal effects plot, placing the value of the slope on the y-axis rather than the fitted value of public corruption. <strong>marginaleffects</strong> helpfully has <code>plot_slopes()</code> that will plot the values of <code>estimate</code> across the whole range of civil liberties automatically. Alternatively, if we want full control over the plot, we can use either <code>slopes()</code> or <code>emtrends()</code> to create a data frame that we can plot ourselves with ggplot:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Automatic plot from marginaleffects::plot_slopes()</span></span>
<span><span class="va">mfx_marginaleffects_auto</span> <span class="op">&lt;-</span> <span class="fu">plot_slopes</span><span class="op">(</span><span class="va">model_sq</span>, </span>
<span>                                        variables <span class="op">=</span> <span class="st">"civil_liberties"</span>, </span>
<span>                                        condition <span class="op">=</span> <span class="st">"civil_liberties"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Civil liberties"</span>, y <span class="op">=</span> <span class="st">"Marginal effect of civil liberties on public sector corruption"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Created automatically with marginaleffects::plot_slopes()"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_mfx</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Piece all the geoms together manually with results from marginaleffects::slopes()</span></span>
<span><span class="va">mfx_marginaleffects</span> <span class="op">&lt;-</span> <span class="va">model_sq</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">slopes</span><span class="op">(</span>newdata <span class="op">=</span> <span class="fu">datagrid</span><span class="op">(</span>civil_liberties <span class="op">=</span> </span>
<span>                              <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">corruption</span><span class="op">$</span><span class="va">civil_liberties</span><span class="op">)</span>, </span>
<span>                                 <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">corruption</span><span class="op">$</span><span class="va">civil_liberties</span><span class="op">)</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                  eps <span class="op">=</span> <span class="fl">0.001</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">civil_liberties</span>, y <span class="op">=</span> <span class="va">estimate</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">42</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, linetype <span class="op">=</span> <span class="st">"24"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_ribbon</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">conf.low</span>, ymax <span class="op">=</span> <span class="va">conf.high</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.1</span>, fill <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span>linewidth <span class="op">=</span> <span class="fl">1</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Civil liberties"</span>, y <span class="op">=</span> <span class="st">"Marginal effect of civil liberties on public sector corruption"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Calculated with slopes()"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_mfx</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Piece all the geoms together manually with results from emmeans::emtrends()</span></span>
<span><span class="va">mfx_emtrends</span> <span class="op">&lt;-</span> <span class="va">model_sq</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">emtrends</span><span class="op">(</span><span class="op">~</span> <span class="va">civil_liberties</span>, var <span class="op">=</span> <span class="st">"civil_liberties"</span>,</span>
<span>           at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>civil_liberties <span class="op">=</span> </span>
<span>                       <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">corruption</span><span class="op">$</span><span class="va">civil_liberties</span><span class="op">)</span>, </span>
<span>                           <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">corruption</span><span class="op">$</span><span class="va">civil_liberties</span><span class="op">)</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>           delta.var <span class="op">=</span> <span class="fl">0.001</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">civil_liberties</span>, y <span class="op">=</span> <span class="va">civil_liberties.trend</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">42</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, linetype <span class="op">=</span> <span class="st">"24"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_ribbon</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lower.CL</span>, ymax <span class="op">=</span> <span class="va">upper.CL</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.1</span>, fill <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span>linewidth <span class="op">=</span> <span class="fl">1</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Civil liberties"</span>, y <span class="op">=</span> <span class="st">"Marginal effect of civil liberties on public sector corruption"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Calculated with emtrends()"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_mfx</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mfx_marginaleffects_auto</span> <span class="op">|</span> <span class="va">mfx_marginaleffects</span> <span class="op">|</span> <span class="va">mfx_emtrends</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/plot-cmes-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page-inset-right" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>This kind of plot is useful since it shows precisely how the effect changes across civil liberties. The slope is 0 at around 42, positive before that, and negative after that, which—assuming this is a good model and who even knows if that’s true—implies that countries with low levels of respect for civil liberties will see an increase in corruption as civil liberties increases, while countries with high respect for civil liberties will see a decrease in corruption as they improve their respect for human rights.</p>
</section><section id="marginaleffectss-and-emmeanss-philosophies-of-averaging" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="marginaleffectss-and-emmeanss-philosophies-of-averaging">
<strong>marginaleffects</strong>’s and <strong>emmeans</strong>’s philosophies of averaging</h2>
<p>Finding marginal effects for lines like <span class="math inline">\(y = 2x - 1\)</span> and <span class="math inline">\(y = -0.5x^2 + 5x + 5\)</span> with calculus is fairly easy since there’s no uncertainty involved. Finding marginal effects for fitted lines from a regression model, on the other hand, is more complicated because uncertainty abounds. The estimated partial slopes all have standard errors and measures of statistical significance attached to them. The slope of civil liberties at 55 is −0.59, but it could be higher and it could be lower. Could it even possibly be zero? Maybe! (But most likely not; the p-value that we saw above is less than 0.001, so there’s only a sliver of a chance of seeing a slope like −0.59 in a world where it is actually 0ish).</p>
<p>We deal with the uncertainty of these marginal effects by taking averages, which is why we talk about “average marginal effects” when interpreting these effects. So far, <code>marginaleffects::slopes()</code> and <code>emmeans::emtrends()</code> have given identical results. But behind the scenes, these packages take two different approaches to calculating these marginal averages. The difference is very subtle, but incredibly important.</p>
<p>Let’s look at how these two packages calculate their marginal effects by default.</p>
<section id="average-marginal-effects-the-default-in-marginaleffects" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="average-marginal-effects-the-default-in-marginaleffects">Average marginal effects (the default in <strong>marginaleffects</strong>)</h3>
<p>By default, <strong>marginaleffects</strong> calculates the <em>average marginal effect</em> (AME) for its partial slopes/coefficients. To do this, it follows a specific process of averaging:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="images/flow-ame@3x.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page-inset-right" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>It first plugs each row of the original dataset into the model and generates predictions for each row. It then uses fancy math (i.e.&nbsp;adding 0.001) to calculate the instantaneous slope for each row and stores each individual slope in the <code>estimate</code> column here:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mfx_sq</span> <span class="op">&lt;-</span> <span class="fu">slopes</span><span class="op">(</span><span class="va">model_sq</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">mfx_sq</span><span class="op">)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##             Term Estimate Std. Error      z Pr(&gt;|z|) 2.5 % 97.5 %</span></span>
<span><span class="co">##  civil_liberties    -1.23      0.102 -12.02   &lt;0.001 -1.43  -1.03</span></span>
<span><span class="co">##  civil_liberties    -1.88      0.199  -9.43   &lt;0.001 -2.26  -1.49</span></span>
<span><span class="co">##  civil_liberties    -2.24      0.258  -8.66   &lt;0.001 -2.74  -1.73</span></span>
<span><span class="co">##  civil_liberties    -2.16      0.245  -8.81   &lt;0.001 -2.63  -1.68</span></span>
<span><span class="co">##  civil_liberties    -1.98      0.216  -9.17   &lt;0.001 -2.41  -1.56</span></span>
<span><span class="co">##  civil_liberties    -1.66      0.164 -10.10   &lt;0.001 -1.98  -1.34</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Columns: rowid, term, estimate, std.error, statistic, p.value, conf.low, conf.high, predicted, predicted_hi, predicted_lo, public_sector_corruption, civil_liberties</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It finally calculates the average of the <code>estimate</code> column. We can do that ourselves:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mfx_sq</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">term</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>avg_slope <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 1 × 2</span></span>
<span><span class="co">##   term            avg_slope</span></span>
<span><span class="co">##   &lt;chr&gt;               &lt;dbl&gt;</span></span>
<span><span class="co">## 1 civil_liberties     -1.17</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Or we can feed a <code>marginaleffects</code> object to <code><a href="https://rdrr.io/r/base/summary.html">summary()</a></code>, which will calculate the correct uncertainty statistics, like the standard errors:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">mfx_sq</span><span class="op">)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##             Term    Contrast Estimate Std. Error     z Pr(&gt;|z|) 2.5 % 97.5 %</span></span>
<span><span class="co">##  civil_liberties mean(dY/dX)    -1.17     0.0948 -12.3   &lt;0.001 -1.35  -0.98</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Columns: term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Alternatively, we can use <code>avg_slopes()</code> instead of <code>slopes(...) |&gt; summary()</code> to do the averaging automatically:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">avg_slopes</span><span class="op">(</span><span class="va">model_sq</span><span class="op">)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##             Term Estimate Std. Error     z Pr(&gt;|z|) 2.5 % 97.5 %</span></span>
<span><span class="co">##  civil_liberties    -1.17     0.0948 -12.3   &lt;0.001 -1.35  -0.98</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Columns: term, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that the average marginal effect here isn’t the same as what we saw before when we set civil liberties to different values. In this case, the effect is averaged across the whole range of civil liberties—one single grand average mean. It shows that in general, the overall average slope of the fitted line is −1.17.</p>
<p>Don’t worry about the number too much here—we’re just exploring the underlying process of calculating this average marginal effect. In general, as the image shows above, for average marginal effects, we take the full original data, feed it to the model, generate fitted values for each original row, and then collapse the results into a single value.</p>
<p>The main advantage of doing this is that each <code>estimate</code> prediction uses values that exist in the actual data. The first <code>estimate</code> slope estimate is for Mexico in 2020 and is based on Mexico’s actual value of <code>civil_liberties</code> (and any other covariates if we had included any others in the model). It’s thus more reflective of reality.</p>
</section><section id="marginal-effects-at-the-mean-the-default-in-emmeans" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="marginal-effects-at-the-mean-the-default-in-emmeans">Marginal effects at the mean (the default in <strong>emmeans</strong>)</h3>
<p>A different approach for this averaging is to calculate the <em>marginal effect at the mean</em>, or MEM. This is what the <strong>emmeans</strong> package does by default. (The <strong>emmeans</strong> package actually calculates two average things: “marginal effects at the means” (MEM), or average <em>slopes</em> using <code>emtrends()</code>, and “estimated marginal means” (EMM), or average <em>predictions</em> using <code>emmeans()</code>. It’s named after the second of these, hence the name <strong><em>emm</em>eans</strong>).</p>
<p>To do this, we follow a slightly different process of averaging:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="images/flow-mem@3x.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page-inset-right" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>First, we calculate the average value of each of the covariates in the model (in this case, just <code>civil_liberties</code>):</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">avg_civ_lib</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">corruption</span><span class="op">$</span><span class="va">civil_liberties</span><span class="op">)</span></span>
<span><span class="va">avg_civ_lib</span></span>
<span><span class="co">## [1] 69.7</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We then plug that average (and that average plus 0.001) into the model and generate fitted values:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">civ_lib_fitted</span> <span class="op">&lt;-</span> <span class="va">model_sq</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">augment</span><span class="op">(</span>newdata <span class="op">=</span> <span class="fu">tibble</span><span class="op">(</span>civil_liberties <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">avg_civ_lib</span>, <span class="va">avg_civ_lib</span> <span class="op">+</span> <span class="fl">0.001</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">civ_lib_fitted</span></span>
<span><span class="co">## # A tibble: 2 × 2</span></span>
<span><span class="co">##   civil_liberties .fitted</span></span>
<span><span class="co">##             &lt;dbl&gt;   &lt;dbl&gt;</span></span>
<span><span class="co">## 1            69.7    56.3</span></span>
<span><span class="co">## 2            69.7    56.3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Because of rounding (and because the values are so tiny), this looks like the two rows are identical, but they’re not—the second one really is 0.001 more than 69.682.</p>
<p>We then subtract the two and divide by 0.001 to get the final marginal effect at the mean:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span><span class="va">civ_lib_fitted</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="va">civ_lib_fitted</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="fl">0.001</span></span>
<span><span class="co">##   .fitted</span></span>
<span><span class="co">## 1   -1.17</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>That doesn’t give us any standard errors or uncertainty or anything, so it’s better to use <code>emtrends()</code> or <code>slopes()</code>. <code>emtrends()</code> calculates this MEM automatically:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_sq</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">emtrends</span><span class="op">(</span><span class="op">~</span> <span class="va">civil_liberties</span>, var <span class="op">=</span> <span class="st">"civil_liberties"</span>, delta.var <span class="op">=</span> <span class="fl">0.001</span><span class="op">)</span></span>
<span><span class="co">##  civil_liberties civil_liberties.trend     SE  df lower.CL upper.CL</span></span>
<span><span class="co">##             69.7                 -1.17 0.0948 165    -1.35   -0.978</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Confidence level used: 0.95</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can also calculate the MEM with <code>avg_slopes()</code> if we include the <code>newdata = "mean"</code> argument, which will automatically shrink the original data down into average or typical values:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_sq</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">avg_slopes</span><span class="op">(</span>newdata <span class="op">=</span> <span class="st">"mean"</span><span class="op">)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##             Term Estimate Std. Error     z Pr(&gt;|z|) 2.5 % 97.5 %</span></span>
<span><span class="co">##  civil_liberties    -1.17     0.0948 -12.3   &lt;0.001 -1.35  -0.98</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Columns: rowid, term, estimate, std.error, statistic, p.value, conf.low, conf.high, predicted, predicted_hi, predicted_lo</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The disadvantage of this approach is that no actual country has a <code>civil_liberties</code> score of exactly 69.682. If we had other covariates in the model, no country would have exactly the average of every variable. The marginal effect is thus calculated based on a hypothetical country that might not possibly exist in real life.</p>
</section></section><section id="where-this-subtle-difference-really-matters" class="level2"><h2 class="anchored" data-anchor-id="where-this-subtle-difference-really-matters">Where this subtle difference really matters</h2>
<p>So far, comparing average marginal effects (AME) with marginal effects at the mean (MEM) hasn’t been that useful, since both <code>slopes()</code> and <code>emtrends()</code> provided nearly identical results with our simple model with civil liberties squared. That’s because nothing that strange is going on in the model—there are no additional explanatory variables, no interactions or logs, and we’re using OLS and not anything fancy like logistic regression or beta regression.</p>
<p>Things change once we leave the land of OLS.</p>
<p>Let’s make a new model that predicts if a country has campaign finance disclosure laws based on public sector corruption. Disclosure laws is a binary outcome, so we’ll use logistic regression to constrain the fitted values and predictions to between 0 and 1.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">plot_corruption_logit</span> <span class="op">&lt;-</span> <span class="va">corruption</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>highlight <span class="op">=</span> <span class="va">public_sector_corruption</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">public_sector_corruption</span><span class="op">)</span> <span class="op">|</span> </span>
<span>           <span class="va">public_sector_corruption</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">public_sector_corruption</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">plot_corruption_logit</span>, </span>
<span>       <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">public_sector_corruption</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">disclose_donations</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">highlight</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_smooth</span><span class="op">(</span>method <span class="op">=</span> <span class="st">"glm"</span>, method.args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">binomial</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"logit"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>              color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_label</span><span class="op">(</span>data <span class="op">=</span> <span class="fu">slice</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">plot_corruption_logit</span>, <span class="va">highlight</span> <span class="op">==</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>, </span>
<span>             <span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">country_name</span><span class="op">)</span>, nudge_y <span class="op">=</span> <span class="fl">0.06</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_label</span><span class="op">(</span>data <span class="op">=</span> <span class="fu">slice</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">plot_corruption_logit</span>, <span class="va">highlight</span> <span class="op">==</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>, </span>
<span>             <span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">country_name</span><span class="op">)</span>, nudge_y <span class="op">=</span> <span class="op">-</span><span class="fl">0.06</span>, hjust <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"grey30"</span>, <span class="va">clrs</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Public sector corruption"</span>, </span>
<span>       y <span class="op">=</span> <span class="st">"Presence or absence of\ncampaign finance disclosure laws\n(Line shows predicted probability)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_mfx</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-logit-corruption-donations-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>Even without any squared terms, we’re already in non-linear land. We can build a model and explore this relationship:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_logit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span></span>
<span>  <span class="va">disclose_donations</span> <span class="op">~</span> <span class="va">public_sector_corruption</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">binomial</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"logit"</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">corruption</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_logit</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 2 × 5</span></span>
<span><span class="co">##   term                     estimate std.error statistic  p.value</span></span>
<span><span class="co">##   &lt;chr&gt;                       &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">## 1 (Intercept)                1.98     0.388        5.09 3.51e- 7</span></span>
<span><span class="co">## 2 public_sector_corruption  -0.0678   0.00991     -6.84 7.85e-12</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The coefficients here are on a different scale and are measured in log odds units (or logits), not probabilities or percentage points. That means we can’t use those coefficients directly. We can’t say things like “a one-unit increase in public sector corruption is associated with a −0.068 percentage point decrease in the probability of having a disclosure law.” That’s wrong! We have to convert those logit scale coefficients to a probability scale instead. We can do this mathematically by combining both the intercept and the coefficient using <code>plogis(intercept + coefficient) - plogis(intercept)</code>, but that’s generally not recommended, especially when there are other coefficients (see <a href="https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/#2-fractional-logistic-regression">this section on logistic regression for more details</a>). Additionally, manually combining intercepts and coefficients won’t give us standard errors or any other kind of uncertainty.</p>
<p>Instead, we can calculate the average slope of the logistic regression fit using either <code>slopes()</code> or <code>emtrends()</code>.</p>
<p>First we’ll use <code>avg_slopes()</code>. Remember that it calculates the <em>average marginal effect</em> (AME) by plugging each row of the original data into the model, generating predictions and instantaneous slopes for each row, and then averaging the <code>estimate</code> column. Each row contains actual observed data, so the predictions arguably reflect variation in reality. <code>avg_slopes()</code> helpfully converts the AME into percentage points, so we can interpret the value directly.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_logit</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">avg_slopes</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##                      Term Estimate Std. Error     z Pr(&gt;|z|)    2.5 %   97.5 %</span></span>
<span><span class="co">##  public_sector_corruption -0.00846   0.000261 -32.4   &lt;0.001 -0.00897 -0.00795</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Columns: term, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The average marginal effect for public sector corruption is −0.0085, which means that on average, a one-point increase in the public sector corruption index (i.e.&nbsp;as corruption gets worse) is associated with a −0.85 percentage point decrease in the probability of a country having a disclosure law.</p>
<p>Next we’ll use <code>emtrends()</code>, which calculates the <em>marginal effect at the mean</em> (MEM) by averaging all the model covariates first, plugging those averages into the model, and generating a single instantaneous slope. The values that get plugged into the model won’t necessarily reflect reality—especially once more covariates are involved, which we’ll see later. By default <code>emtrends()</code> returns the results on the logit scale, but we can convert them to the response/percentage point scale by adding the <code>regrid = "response"</code> argument:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_logit</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">emtrends</span><span class="op">(</span><span class="op">~</span> <span class="va">public_sector_corruption</span>, </span>
<span>           var <span class="op">=</span> <span class="st">"public_sector_corruption"</span>, </span>
<span>           regrid <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span></span>
<span><span class="co">##  public_sector_corruption public_sector_corruption.trend     SE  df asymp.LCL asymp.UCL</span></span>
<span><span class="co">##                      45.8                        -0.0125 0.0017 Inf   -0.0158  -0.00916</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Confidence level used: 0.95</span></span>
<span></span>
<span><span class="co"># avg_slopes() will show the same MEM result with `newdata = "mean"`</span></span>
<span><span class="co"># avg_slopes(model_logit, newdata = "mean")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>When we plug the average public sector corruption (45.82) into the model, we get an MEM of −0.0125, which means that on average, a one-point increase in the public sector corruption index is associated with a −1.25 percentage point decrease in the probability of a country having a disclosure law. That’s different (and bigger!) than the AME we found with <code>slopes()</code>!</p>
<p>Let’s plot these marginal effects and their uncertainty to see how much they differ:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Get tidied results from slopes()</span></span>
<span><span class="va">plot_ame</span> <span class="op">&lt;-</span> <span class="va">model_logit</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">avg_slopes</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get tidied results from emtrends()</span></span>
<span><span class="va">plot_mem</span> <span class="op">&lt;-</span> <span class="va">model_logit</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">emtrends</span><span class="op">(</span><span class="op">~</span> <span class="va">public_sector_corruption</span>, </span>
<span>           var <span class="op">=</span> <span class="st">"public_sector_corruption"</span>, </span>
<span>           regrid <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tidy</span><span class="op">(</span>conf.int <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">rename</span><span class="op">(</span>estimate <span class="op">=</span> <span class="va">public_sector_corruption.trend</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Combine the two tidy data frames for plotting</span></span>
<span><span class="va">plot_effects</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span><span class="st">"AME"</span> <span class="op">=</span> <span class="va">plot_ame</span>, <span class="st">"MEM"</span> <span class="op">=</span> <span class="va">plot_mem</span>, .id <span class="op">=</span> <span class="st">"type"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>nice_slope <span class="op">=</span> <span class="fu">nice_number</span><span class="op">(</span><span class="va">estimate</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">plot_effects</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">estimate</span> <span class="op">*</span> <span class="fl">100</span>, y <span class="op">=</span> <span class="fu">fct_rev</span><span class="op">(</span><span class="va">type</span><span class="op">)</span>, color <span class="op">=</span> <span class="va">type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, linetype <span class="op">=</span> <span class="st">"24"</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_pointrange</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xmin <span class="op">=</span> <span class="va">conf.low</span> <span class="op">*</span> <span class="fl">100</span>, xmax <span class="op">=</span> <span class="va">conf.high</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_label</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">nice_slope</span><span class="op">)</span>, nudge_y <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Marginal effect (percentage points)"</span>, y <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">clrs</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">clrs</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_mfx</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-mfx-ame-mem-basic-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>That’s fascinating! The confidence interval around the AME is really small compared to the MEM, likely because the AME estimate comes from the average of 168 values, while the MEM is the prediction of a single value. Additionally, while both estimates hover around a 1 percentage point decrease, the AME is larger than −1 while the MEM is smaller.</p>
<p>For fun, let’s make a super fancy logistic regression model with a quadratic term and an interaction. We’ll compare the AME and MEM for public sector corruption again. This is where either <code>slopes()</code> or <code>emtrends()</code> is incredibly helpful—correctly combining all the necessary coefficients, given that corruption is both squared and interacted, and given that there are other variables to worry about, would be really hard.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_logit_fancy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span></span>
<span>  <span class="va">disclose_donations</span> <span class="op">~</span> <span class="va">public_sector_corruption</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="va">public_sector_corruption</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="va">polyarchy</span> <span class="op">+</span> <span class="va">log_gdp_percapita</span> <span class="op">+</span> <span class="va">public_sector_corruption</span> <span class="op">*</span> <span class="va">region</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">binomial</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"logit"</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">corruption</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here are the average marginal effects (AME) (again, each original row is plugged into the model, a slope is calculated for each, and then they’re all averaged together):</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_logit_fancy</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">avg_slopes</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##                      Term                                                           Contrast Estimate Std. Error      z Pr(&gt;|z|)   2.5 %   97.5 %</span></span>
<span><span class="co">##  log_gdp_percapita        dY/dX                                                               0.00960    0.03784  0.254  0.79977 -0.0646  0.08377</span></span>
<span><span class="co">##  polyarchy                dY/dX                                                               0.00226    0.00172  1.318  0.18757 -0.0011  0.00563</span></span>
<span><span class="co">##  public_sector_corruption dY/dX                                                              -0.00653    0.00198 -3.303  &lt; 0.001 -0.0104 -0.00266</span></span>
<span><span class="co">##  region                   Asia and Pacific - Eastern Europe and Central Asia                 -0.20418    0.09156 -2.230  0.02575 -0.3836 -0.02473</span></span>
<span><span class="co">##  region                   Latin America and the Caribbean - Eastern Europe and Central Asia  -0.26174    0.10447 -2.505  0.01223 -0.4665 -0.05699</span></span>
<span><span class="co">##  region                   Middle East and North Africa - Eastern Europe and Central Asia     -0.20647    0.10545 -1.958  0.05023 -0.4132  0.00021</span></span>
<span><span class="co">##  region                   Sub-Saharan Africa - Eastern Europe and Central Asia               -0.24986    0.11238 -2.223  0.02619 -0.4701 -0.02960</span></span>
<span><span class="co">##  region                   Western Europe and North America - Eastern Europe and Central Asia -0.29109    0.09378 -3.104  0.00191 -0.4749 -0.10728</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Columns: term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And here are the marginal effects at the mean (MEM) (again, the average values for each covariate are plugged into the model). Using <code>emtrends()</code> results in a note about interactions, so we’ll use <code>avg_slopes(..., newdata = "mean")</code> instead:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_logit_fancy</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">emtrends</span><span class="op">(</span><span class="op">~</span> <span class="va">public_sector_corruption</span>, </span>
<span>           var <span class="op">=</span> <span class="st">"public_sector_corruption"</span>, </span>
<span>           regrid <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span></span>
<span><span class="co">## NOTE: Results may be misleading due to involvement in interactions</span></span>
<span><span class="co">##  public_sector_corruption public_sector_corruption.trend      SE  df asymp.LCL asymp.UCL</span></span>
<span><span class="co">##                      45.8                       -0.00955 0.00301 Inf   -0.0155  -0.00366</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Results are averaged over the levels of: region </span></span>
<span><span class="co">## Confidence level used: 0.95</span></span>
<span></span>
<span><span class="co"># This uses avg_slopes() to find the MEM instead</span></span>
<span><span class="va">model_logit_fancy</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">avg_slopes</span><span class="op">(</span>newdata <span class="op">=</span> <span class="st">"mean"</span><span class="op">)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##                      Term                                                           Contrast Estimate Std. Error      z Pr(&gt;|z|)    2.5 %   97.5 %</span></span>
<span><span class="co">##  log_gdp_percapita        dY/dX                                                               0.00919    0.03944  0.233  0.81579 -0.06811  0.08649</span></span>
<span><span class="co">##  polyarchy                dY/dX                                                               0.00217    0.00222  0.976  0.32915 -0.00219  0.00652</span></span>
<span><span class="co">##  public_sector_corruption dY/dX                                                              -0.01004    0.00607 -1.654  0.09816 -0.02194  0.00186</span></span>
<span><span class="co">##  region                   Asia and Pacific - Eastern Europe and Central Asia                 -0.53122    0.19300 -2.752  0.00592 -0.90950 -0.15294</span></span>
<span><span class="co">##  region                   Latin America and the Caribbean - Eastern Europe and Central Asia  -0.37448    0.16569 -2.260  0.02381 -0.69921 -0.04974</span></span>
<span><span class="co">##  region                   Middle East and North Africa - Eastern Europe and Central Asia     -0.57907    0.20653 -2.804  0.00505 -0.98387 -0.17427</span></span>
<span><span class="co">##  region                   Sub-Saharan Africa - Eastern Europe and Central Asia               -0.56591    0.16579 -3.413  &lt; 0.001 -0.89086 -0.24097</span></span>
<span><span class="co">##  region                   Western Europe and North America - Eastern Europe and Central Asia -0.65700    0.16341 -4.021  &lt; 0.001 -0.97728 -0.33672</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Columns: term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now that we’re working with multiple covariates, we have instantaneous marginal effects for each regression term, which is neat. We only care about corruption here, so let’s extract the slopes and plot them:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">plot_ame_fancy</span> <span class="op">&lt;-</span> <span class="va">model_logit_fancy</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">avg_slopes</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_mem_fancy</span> <span class="op">&lt;-</span> <span class="va">model_logit_fancy</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">avg_slopes</span><span class="op">(</span>newdata <span class="op">=</span> <span class="st">"mean"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Combine the two tidy data frames for plotting</span></span>
<span><span class="va">plot_effects</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span><span class="st">"AME"</span> <span class="op">=</span> <span class="va">plot_ame_fancy</span>, <span class="st">"MEM"</span> <span class="op">=</span> <span class="va">plot_mem_fancy</span>, .id <span class="op">=</span> <span class="st">"type"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">term</span> <span class="op">==</span> <span class="st">"public_sector_corruption"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>nice_slope <span class="op">=</span> <span class="fu">nice_number</span><span class="op">(</span><span class="va">estimate</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">plot_effects</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">estimate</span> <span class="op">*</span> <span class="fl">100</span>, y <span class="op">=</span> <span class="fu">fct_rev</span><span class="op">(</span><span class="va">type</span><span class="op">)</span>, color <span class="op">=</span> <span class="va">type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, linetype <span class="op">=</span> <span class="st">"24"</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_pointrange</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xmin <span class="op">=</span> <span class="va">conf.low</span> <span class="op">*</span> <span class="fl">100</span>, xmax <span class="op">=</span> <span class="va">conf.high</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_label</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">nice_slope</span><span class="op">)</span>, nudge_y <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Marginal effect (percentage points)"</span>, y <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">clrs</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">clrs</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_mfx</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-mfx-ame-mem-fancy-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>Yikes! The AME is statistically significant (p &lt; 0.001) with a narrower confidence interval, but the MEM includes zero in its confidence interval and isn’t significant (p = 0.098).</p>
<p>The choice of marginal effect averaging thus matters a lot!</p>
</section><section id="other-marginal-slope-things" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="other-marginal-slope-things">Other marginal slope things</h2>
<p>To make life even more exciting, we’re not limited to just average marginal effects (AMEs) or marginal effects at the mean (MEMs). Additionally, if we think back to the slider/switch/mixing board analogy, all we’ve really done so far with our logistic regression model is move one slider (<code>public_sector_corruption</code>) up and down. What happens if we move other switches and sliders at the same time? (i.e.&nbsp;the marginal effect of corruption at specific values of corruption, or across different regions, or at different levels of GDP per capita and polyarchy)</p>
<p>We can use both <code>slopes()</code> and <code>emtrends()</code>/<code>emmeans()</code> to play with our model’s full mixing board. We’ll continue to use the logistic regression model as an example since it’s sensitive to the order of averaging.</p>
<section id="group-average-marginal-effects" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="group-average-marginal-effects">Group average marginal effects</h3>
<p>If we have categorical covariates in our model like <code>region</code>, we can find the average marginal effect (AME) of continuous predictors across those different groups. This is fairly straightforward when working with <code>slopes()</code> because of its approach to averaging. Remember that with the AME, each original row gets its own fitted value and each individual slope, which we can then average and collapse into a single row. Group characteristics like region are maintained after calculating predictions, so we can calculate group averages of the individual slopes. This outlines the process:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="images/flow-game@3x.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page-inset-right" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Because we’re working with the AME, we have an <code>estimate</code> column with instantaneous slopes for each row in the original data:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># We'll specify variables = "public_sector_corruption" here to filter the</span></span>
<span><span class="co"># marginal effects results. If we don't we'll get dozens of separate marginal</span></span>
<span><span class="co"># effects later when using summary() for each of the coefficients, interactions,</span></span>
<span><span class="co"># and cross-region contrasts</span></span>
<span><span class="va">mfx_logit_fancy</span> <span class="op">&lt;-</span> <span class="va">model_logit_fancy</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">slopes</span><span class="op">(</span>variables <span class="op">=</span> <span class="st">"public_sector_corruption"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Original data frame + estimated slope for each row</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">mfx_logit_fancy</span><span class="op">)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##                      Term  Estimate Std. Error      z Pr(&gt;|z|)    2.5 %  97.5 %</span></span>
<span><span class="co">##  public_sector_corruption -0.008825    0.00653 -1.352    0.176 -0.02162 0.00397</span></span>
<span><span class="co">##  public_sector_corruption -0.000897    0.00788 -0.114    0.909 -0.01634 0.01454</span></span>
<span><span class="co">##  public_sector_corruption -0.006759    0.00511 -1.324    0.186 -0.01677 0.00325</span></span>
<span><span class="co">##  public_sector_corruption -0.006727    0.00546 -1.231    0.218 -0.01744 0.00398</span></span>
<span><span class="co">##  public_sector_corruption -0.002460    0.00307 -0.802    0.423 -0.00847 0.00355</span></span>
<span><span class="co">##  public_sector_corruption -0.005864    0.00557 -1.052    0.293 -0.01679 0.00506</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Columns: rowid, term, estimate, std.error, statistic, p.value, conf.low, conf.high, predicted, predicted_hi, predicted_lo, disclose_donations, public_sector_corruption, polyarchy, log_gdp_percapita, region</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>All the original columns are still there, which means we can collapse the results however we want. For instance, here’s the average marginal effect across each region:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mfx_logit_fancy</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">region</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>region_ame <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 6 × 2</span></span>
<span><span class="co">##   region                           region_ame</span></span>
<span><span class="co">##   &lt;fct&gt;                                 &lt;dbl&gt;</span></span>
<span><span class="co">## 1 Eastern Europe and Central Asia    -0.00751</span></span>
<span><span class="co">## 2 Latin America and the Caribbean    -0.00326</span></span>
<span><span class="co">## 3 Middle East and North Africa       -0.00629</span></span>
<span><span class="co">## 4 Sub-Saharan Africa                 -0.00435</span></span>
<span><span class="co">## 5 Western Europe and North America   -0.0112 </span></span>
<span><span class="co">## 6 Asia and Pacific                   -0.00830</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can also use summarizing methods built in to <strong>marginaleffects</strong> by using the <code>by</code> argument in <code>slopes()</code>. This is the better option, since it does some tricky standard error calculations behind the scenes:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_logit_fancy</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">slopes</span><span class="op">(</span>variables <span class="op">=</span> <span class="st">"public_sector_corruption"</span>,</span>
<span>         by <span class="op">=</span> <span class="st">"region"</span><span class="op">)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##                      Term    Contrast                           region Estimate Std. Error      z Pr(&gt;|z|)   2.5 %   97.5 %</span></span>
<span><span class="co">##  public_sector_corruption mean(dY/dX) Eastern Europe and Central Asia  -0.00751    0.00222 -3.376  &lt; 0.001 -0.0119 -0.00315</span></span>
<span><span class="co">##  public_sector_corruption mean(dY/dX) Latin America and the Caribbean  -0.00326    0.00395 -0.825  0.40957 -0.0110  0.00448</span></span>
<span><span class="co">##  public_sector_corruption mean(dY/dX) Middle East and North Africa     -0.00629    0.00193 -3.264  0.00110 -0.0101 -0.00251</span></span>
<span><span class="co">##  public_sector_corruption mean(dY/dX) Sub-Saharan Africa               -0.00435    0.00156 -2.788  0.00530 -0.0074 -0.00129</span></span>
<span><span class="co">##  public_sector_corruption mean(dY/dX) Western Europe and North America -0.01123    0.00911 -1.233  0.21749 -0.0291  0.00662</span></span>
<span><span class="co">##  public_sector_corruption mean(dY/dX) Asia and Pacific                 -0.00830    0.00285 -2.916  0.00354 -0.0139 -0.00272</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Columns: term, contrast, region, estimate, std.error, statistic, p.value, conf.low, conf.high, predicted, predicted_hi, predicted_lo</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>These are on the percentage point scale, not the logit scale, so we can interpret them directly. In Western Europe, the AME of corruption is −0.0033, so a one-point increase in the public sector corruption index there is associated with a −0.33 percentage point decrease in the probability of having a campaign finance disclosure law, on average (though it’s not actually significant (p = 0.410)). In the Middle East, on the other hand, corruption seems to matter less for disclosure laws—an increase in the corruption index there is associated with a −0.83 percentage point decrease in the probability of having a laws, on average (and that <em>is</em> significant (p = 0.004)).</p>
<p>We can use <code>emtrends()</code> to get region-specific slopes, but we’ll get different results because of the order of averaging. <strong>emmeans</strong> creates averages and then plugs them in; <strong>marginaleffects</strong> plugs all the values in and then creates averages:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_logit_fancy</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">emtrends</span><span class="op">(</span><span class="op">~</span> <span class="va">public_sector_corruption</span> <span class="op">+</span> <span class="va">region</span>,</span>
<span>           var <span class="op">=</span> <span class="st">"public_sector_corruption"</span>, regrid <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span></span>
<span><span class="co">##  public_sector_corruption region                           public_sector_corruption.trend      SE  df asymp.LCL asymp.UCL</span></span>
<span><span class="co">##                      45.8 Eastern Europe and Central Asia                        -0.01119 0.00554 Inf   -0.0221  -0.00033</span></span>
<span><span class="co">##                      45.8 Latin America and the Caribbean                        -0.00734 0.00611 Inf   -0.0193   0.00463</span></span>
<span><span class="co">##                      45.8 Middle East and North Africa                           -0.01172 0.01105 Inf   -0.0334   0.00993</span></span>
<span><span class="co">##                      45.8 Sub-Saharan Africa                                     -0.01001 0.00607 Inf   -0.0219   0.00188</span></span>
<span><span class="co">##                      45.8 Western Europe and North America                       -0.00335 0.00769 Inf   -0.0184   0.01172</span></span>
<span><span class="co">##                      45.8 Asia and Pacific                                       -0.01371 0.00667 Inf   -0.0268  -0.00063</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Confidence level used: 0.95</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can replicate the results from <code>emtrends()</code> with <code>avg_slopes()</code> if we plug in average or representative values (more on that in the next section), since that follows the same averaging order as <strong>emmeans</strong> (i.e.&nbsp;plugging averages into the model)</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_logit_fancy</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">avg_slopes</span><span class="op">(</span>variables <span class="op">=</span> <span class="st">"public_sector_corruption"</span>,</span>
<span>             newdata <span class="op">=</span> <span class="fu">datagrid</span><span class="op">(</span>region <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">corruption</span><span class="op">$</span><span class="va">region</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             by <span class="op">=</span> <span class="st">"region"</span><span class="op">)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##                      Term    Contrast                           region Estimate Std. Error      z Pr(&gt;|z|)   2.5 %    97.5 %</span></span>
<span><span class="co">##  public_sector_corruption mean(dY/dX) Eastern Europe and Central Asia  -0.01117    0.00554 -2.016   0.0437 -0.0220 -0.000313</span></span>
<span><span class="co">##  public_sector_corruption mean(dY/dX) Latin America and the Caribbean  -0.00733    0.00611 -1.200   0.2301 -0.0193  0.004641</span></span>
<span><span class="co">##  public_sector_corruption mean(dY/dX) Middle East and North Africa     -0.01177    0.01106 -1.064   0.2873 -0.0334  0.009907</span></span>
<span><span class="co">##  public_sector_corruption mean(dY/dX) Sub-Saharan Africa               -0.01004    0.00607 -1.654   0.0982 -0.0219  0.001859</span></span>
<span><span class="co">##  public_sector_corruption mean(dY/dX) Western Europe and North America -0.00336    0.00771 -0.436   0.6627 -0.0185  0.011756</span></span>
<span><span class="co">##  public_sector_corruption mean(dY/dX) Asia and Pacific                 -0.01375    0.00667 -2.059   0.0395 -0.0268 -0.000664</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Columns: rowid, term, contrast, region, estimate, std.error, statistic, p.value, conf.low, conf.high, predicted, predicted_hi, predicted_lo</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="marginal-effects-at-user-specified-or-representative-values" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="marginal-effects-at-user-specified-or-representative-values">Marginal effects at user-specified or representative values</h3>
<p>If we want to unlock the full potential of our regression mixing board, we can feed the model any values we want. In general, we’ll (1) make a little dataset with covariate values set to either specific values that we care about, or typical or average values, (2) plug that little dataset into the the model and get fitted values, and (3) work with the results. There are a bunch of different names for this little fake dataset like “data grid” and “reference grid”, but they’re all the same idea. Here’s an overview of the approach:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="images/flow-mer@3x.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page-inset-right" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<section id="creating-representative-values" class="level4"><h4 class="anchored" data-anchor-id="creating-representative-values">Creating representative values</h4>
<p>Before plugging anything in, it’s helpful to look at different ways of creating data grids with R. For all these examples, we’ll make a dataset with public sector corruption set to 20 and 80 across Western Europe, Latin America, and the Middle East, with all other variables in the model set to their means. We’ll make a little list of these regions to save typing time:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">regions_to_use</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Western Europe and North America"</span>, </span>
<span>                    <span class="st">"Latin America and the Caribbean"</span>,</span>
<span>                    <span class="st">"Middle East and North Africa"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>First, we can do it all manually with the <code>expand_grid()</code> function from <strong>tidyr</strong> (or <code><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid()</a></code> from base R). This creates a data frame from all combinations of the vectors and single values we feed it.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">expand_grid</span><span class="op">(</span>public_sector_corruption <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">80</span><span class="op">)</span>,</span>
<span>            region <span class="op">=</span> <span class="va">regions_to_use</span>,</span>
<span>            polyarchy <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">corruption</span><span class="op">$</span><span class="va">polyarchy</span><span class="op">)</span>,</span>
<span>            log_gdp_percapita <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">corruption</span><span class="op">$</span><span class="va">log_gdp_percapita</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 6 × 4</span></span>
<span><span class="co">##   public_sector_corruption region                           polyarchy log_gdp_percapita</span></span>
<span><span class="co">##                      &lt;dbl&gt; &lt;chr&gt;                                &lt;dbl&gt;             &lt;dbl&gt;</span></span>
<span><span class="co">## 1                       20 Western Europe and North America      52.8              8.57</span></span>
<span><span class="co">## 2                       20 Latin America and the Caribbean       52.8              8.57</span></span>
<span><span class="co">## 3                       20 Middle East and North Africa          52.8              8.57</span></span>
<span><span class="co">## 4                       80 Western Europe and North America      52.8              8.57</span></span>
<span><span class="co">## 5                       80 Latin America and the Caribbean       52.8              8.57</span></span>
<span><span class="co">## 6                       80 Middle East and North Africa          52.8              8.57</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A disadvantage of using <code>expand_grid()</code> like this is that the averages we calculated aren’t necessarily the same averages of the data that gets used in the model. If any rows are dropped in the model because of missing values, that won’t be reflected here. We could get around that by doing <code>model.frame(model_logit_fancy)$polyarchy</code>, but that’s starting to get unwieldy. Instead, we can use a function that takes information about the model into account.</p>
<p>Second, we can use <a href="https://modelr.tidyverse.org/reference/data_grid.html"><code>data_grid()</code></a> from <a href="https://modelr.tidyverse.org/"><strong>modelr</strong></a>, which is part of the really neat <a href="https://www.tidymodels.org/"><strong>tidymodels</strong> ecosystem</a>. An advantage of doing this is that it will handle the typical value part automatically—it will calculate the mean for continuous predictors and the mode for categorical predictors.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">modelr</span><span class="fu">::</span><span class="fu">data_grid</span><span class="op">(</span><span class="va">corruption</span>,</span>
<span>                  public_sector_corruption <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">80</span><span class="op">)</span>,</span>
<span>                  region <span class="op">=</span> <span class="va">regions_to_use</span>,</span>
<span>                  .model <span class="op">=</span> <span class="va">model_logit_fancy</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 6 × 4</span></span>
<span><span class="co">##   public_sector_corruption region                           polyarchy log_gdp_percapita</span></span>
<span><span class="co">##                      &lt;dbl&gt; &lt;chr&gt;                                &lt;dbl&gt;             &lt;dbl&gt;</span></span>
<span><span class="co">## 1                       20 Latin America and the Caribbean       54.2              8.52</span></span>
<span><span class="co">## 2                       20 Middle East and North Africa          54.2              8.52</span></span>
<span><span class="co">## 3                       20 Western Europe and North America      54.2              8.52</span></span>
<span><span class="co">## 4                       80 Latin America and the Caribbean       54.2              8.52</span></span>
<span><span class="co">## 5                       80 Middle East and North Africa          54.2              8.52</span></span>
<span><span class="co">## 6                       80 Western Europe and North America      54.2              8.52</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Third, we can use <strong>marginaleffects</strong>’s <code>datagrid()</code>, which will also calculate typical values for any covariates we don’t specify:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">datagrid</span><span class="op">(</span>model <span class="op">=</span> <span class="va">model_logit_fancy</span>,</span>
<span>         public_sector_corruption <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">80</span><span class="op">)</span>,</span>
<span>         region <span class="op">=</span> <span class="va">regions_to_use</span><span class="op">)</span></span>
<span><span class="co">##   disclose_donations polyarchy log_gdp_percapita public_sector_corruption                           region</span></span>
<span><span class="co">## 1              FALSE      52.8              8.57                       20 Western Europe and North America</span></span>
<span><span class="co">## 2              FALSE      52.8              8.57                       20  Latin America and the Caribbean</span></span>
<span><span class="co">## 3              FALSE      52.8              8.57                       20     Middle East and North Africa</span></span>
<span><span class="co">## 4              FALSE      52.8              8.57                       80 Western Europe and North America</span></span>
<span><span class="co">## 5              FALSE      52.8              8.57                       80  Latin America and the Caribbean</span></span>
<span><span class="co">## 6              FALSE      52.8              8.57                       80     Middle East and North Africa</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And finally, we can use <strong>emmeans</strong>’s <code>ref_grid()</code>, which will <em>also</em> automatically create typical values. This doesn’t return a data frame—it’s some sort of special <code>ref_grid</code> object, but all the important information is still there:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ref_grid</span><span class="op">(</span><span class="va">model_logit_fancy</span>,</span>
<span>         at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>public_sector_corruption <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">80</span><span class="op">)</span>,</span>
<span>                   region <span class="op">=</span> <span class="va">regions_to_use</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## 'emmGrid' object with variables:</span></span>
<span><span class="co">##     public_sector_corruption = 20, 80</span></span>
<span><span class="co">##     polyarchy = 52.79</span></span>
<span><span class="co">##     log_gdp_percapita = 8.5674</span></span>
<span><span class="co">##     region = Western Europe and North America, Latin America and the Caribbean, Middle East and North Africa</span></span>
<span><span class="co">## Transformation: "logit"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="working-with-representative-values" class="level4 page-columns page-full"><h4 class="anchored" data-anchor-id="working-with-representative-values">Working with representative values</h4>
<p>Now that we have a hypothetical data grid of sliders and switches set to specific values, we can plug it into the model and generate fitted values. Importantly, doing this provides us with results that are analogous to the marginal effects at the mean (MEM) that we found earlier, and <em>not</em> the average marginal effect (AME), since we’re not feeding the entire original dataset to the model. None of these hypothetical rows exist in real life—there is no country with any of these exact combinations of corruption, polyarchy/democracy, GDP per capita, or region.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_logit_fancy</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">slopes</span><span class="op">(</span>variables <span class="op">=</span> <span class="st">"public_sector_corruption"</span>,</span>
<span>         newdata <span class="op">=</span> <span class="fu">datagrid</span><span class="op">(</span>public_sector_corruption <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">80</span><span class="op">)</span>,</span>
<span>                            region <span class="op">=</span> <span class="va">regions_to_use</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##                      Term  Estimate Std. Error       z Pr(&gt;|z|)     2.5 %   97.5 % polyarchy log_gdp_percapita public_sector_corruption                           region</span></span>
<span><span class="co">##  public_sector_corruption -2.49e-02   1.56e-02 -1.5982    0.110 -0.055495 0.005643      52.8              8.57                       20 Western Europe and North America</span></span>
<span><span class="co">##  public_sector_corruption  8.27e-04   8.59e-03  0.0962    0.923 -0.016018 0.017672      52.8              8.57                       20 Latin America and the Caribbean </span></span>
<span><span class="co">##  public_sector_corruption -2.04e-02   1.43e-02 -1.4240    0.154 -0.048490 0.007680      52.8              8.57                       20 Middle East and North Africa    </span></span>
<span><span class="co">##  public_sector_corruption -1.49e-05   8.59e-05 -0.1734    0.862 -0.000183 0.000153      52.8              8.57                       80 Western Europe and North America</span></span>
<span><span class="co">##  public_sector_corruption -4.36e-03   3.53e-03 -1.2356    0.217 -0.011289 0.002559      52.8              8.57                       80 Latin America and the Caribbean </span></span>
<span><span class="co">##  public_sector_corruption -1.06e-04   3.83e-04 -0.2762    0.782 -0.000857 0.000646      52.8              8.57                       80 Middle East and North Africa    </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Columns: rowid, term, estimate, std.error, statistic, p.value, conf.low, conf.high, predicted, predicted_hi, predicted_lo, disclose_donations, polyarchy, log_gdp_percapita, public_sector_corruption, region</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_logit_fancy</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">emtrends</span><span class="op">(</span><span class="op">~</span> <span class="va">public_sector_corruption</span> <span class="op">+</span> <span class="va">region</span>, var <span class="op">=</span> <span class="st">"public_sector_corruption"</span>,</span>
<span>           at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>public_sector_corruption <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">80</span><span class="op">)</span>,</span>
<span>                     region <span class="op">=</span> <span class="va">regions_to_use</span><span class="op">)</span>,</span>
<span>           regrid <span class="op">=</span> <span class="st">"response"</span>, delta.var <span class="op">=</span> <span class="fl">0.001</span><span class="op">)</span> </span>
<span><span class="co">##  public_sector_corruption region                           public_sector_corruption.trend      SE  df asymp.LCL asymp.UCL</span></span>
<span><span class="co">##                        20 Western Europe and North America                       -0.02493 0.01560 Inf   -0.0555   0.00565</span></span>
<span><span class="co">##                        80 Western Europe and North America                       -0.00001 0.00009 Inf   -0.0002   0.00015</span></span>
<span><span class="co">##                        20 Latin America and the Caribbean                         0.00083 0.00860 Inf   -0.0160   0.01768</span></span>
<span><span class="co">##                        80 Latin America and the Caribbean                        -0.00437 0.00353 Inf   -0.0113   0.00256</span></span>
<span><span class="co">##                        20 Middle East and North Africa                           -0.02040 0.01433 Inf   -0.0485   0.00768</span></span>
<span><span class="co">##                        80 Middle East and North Africa                           -0.00011 0.00038 Inf   -0.0009   0.00065</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Confidence level used: 0.95</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We have a ton of marginal effects here, but this is all starting to get really complicated. These are slopes, but slopes for which lines? What do these marginal effects actually look like?</p>
<p>Plotting these regression lines is tricky because we’re no longer working with a single variable on the x-axis. Instead, we need to generate predicted values of the regression outcome across a range of one <span class="math inline">\(x\)</span> while holding all the other variables constant. This is exactly what we’ve been doing to get marginal effects, only now instead of getting slopes as the output, we want fitted values. Both <strong>marginaleffects</strong> and <strong>emmeans</strong> make this easy.</p>
<p>In the <strong>marginaleffects</strong> world, we can use <code>predictions()</code>. The <code>estimate</code> column now shows the fitted value instead of the slope:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_logit_fancy</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">predictions</span><span class="op">(</span>newdata <span class="op">=</span> <span class="fu">datagrid</span><span class="op">(</span>public_sector_corruption <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">80</span><span class="op">)</span>,</span>
<span>                                 region <span class="op">=</span> <span class="va">regions_to_use</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##  Estimate Pr(&gt;|z|)    2.5 % 97.5 % polyarchy log_gdp_percapita public_sector_corruption                           region</span></span>
<span><span class="co">##  3.81e-01   0.7001 4.93e-02  0.879      52.8              8.57                       20 Western Europe and North America</span></span>
<span><span class="co">##  3.97e-01   0.5855 1.29e-01  0.746      52.8              8.57                       20 Latin America and the Caribbean </span></span>
<span><span class="co">##  6.58e-01   0.5566 1.78e-01  0.945      52.8              8.57                       20 Middle East and North Africa    </span></span>
<span><span class="co">##  7.69e-05   0.1363 2.98e-10  0.952      52.8              8.57                       80 Western Europe and North America</span></span>
<span><span class="co">##  5.45e-02   0.0579 3.01e-03  0.524      52.8              8.57                       80 Latin America and the Caribbean </span></span>
<span><span class="co">##  5.93e-04   0.0708 1.87e-07  0.653      52.8              8.57                       80 Middle East and North Africa    </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Columns: rowid, estimate, p.value, conf.low, conf.high, disclose_donations, polyarchy, log_gdp_percapita, public_sector_corruption, region</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the <strong>emmeans</strong> world, we can use <code>emmeans()</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_logit_fancy</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">emmeans</span><span class="op">(</span><span class="op">~</span> <span class="va">public_sector_corruption</span> <span class="op">+</span> <span class="va">region</span>, var <span class="op">=</span> <span class="st">"public_sector_corruption"</span>,</span>
<span>          at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>public_sector_corruption <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">80</span><span class="op">)</span>,</span>
<span>                    region <span class="op">=</span> <span class="va">regions_to_use</span><span class="op">)</span>,</span>
<span>          regrid <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span> </span>
<span><span class="co">##  public_sector_corruption region                            prob     SE  df asymp.LCL asymp.UCL</span></span>
<span><span class="co">##                        20 Western Europe and North America 0.381 0.2975 Inf   -0.2021     0.964</span></span>
<span><span class="co">##                        80 Western Europe and North America 0.000 0.0005 Inf   -0.0009     0.001</span></span>
<span><span class="co">##                        20 Latin America and the Caribbean  0.397 0.1827 Inf    0.0395     0.755</span></span>
<span><span class="co">##                        80 Latin America and the Caribbean  0.055 0.0776 Inf   -0.0975     0.207</span></span>
<span><span class="co">##                        20 Middle East and North Africa     0.658 0.2505 Inf    0.1671     1.149</span></span>
<span><span class="co">##                        80 Middle East and North Africa     0.001 0.0024 Inf   -0.0042     0.005</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Confidence level used: 0.95</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The results from the two packages are identical because we’re using a data grid—in both cases we’re averaging <em>before</em> plugging stuff into the model.</p>
<p>Instead of setting corruption to 20 and 80, we’ll use a whole range of values so we can plot it.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">logit_predictions</span> <span class="op">&lt;-</span> <span class="va">model_logit_fancy</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">emmeans</span><span class="op">(</span><span class="op">~</span> <span class="va">public_sector_corruption</span> <span class="op">+</span> <span class="va">region</span>, var <span class="op">=</span> <span class="st">"public_sector_corruption"</span>,</span>
<span>          at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>public_sector_corruption <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">90</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>          regrid <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">logit_predictions</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">public_sector_corruption</span>, y <span class="op">=</span> <span class="va">prob</span>, color <span class="op">=</span> <span class="va">region</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span>linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Public sector corruption"</span>, y <span class="op">=</span> <span class="st">"Predicted probability of having\na campaign finance disclosure law"</span>, color <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">percent_format</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">clrs</span>, <span class="st">"grey30"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_mfx</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-logit-predictions-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>(Alternatively, you can use <strong>marginaleffects</strong>’s built-in <code>plot_predictions()</code> to make this plot with one line of code):</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">plot_predictions</span><span class="op">(</span><span class="va">model_logit_fancy</span>, condition <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"public_sector_corruption"</span>, <span class="st">"region"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>That’s such a cool plot! Each region has a different shape of predicted probabilities across public sector corruption.</p>
<p>Earlier we calculated a bunch of instantaneous slopes when corruption was set to 20 and 80 in a few different regions, so let’s put those slopes and their tangent lines on the plot:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">logit_slopes</span> <span class="op">&lt;-</span> <span class="va">model_logit_fancy</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">emtrends</span><span class="op">(</span><span class="op">~</span> <span class="va">public_sector_corruption</span> <span class="op">+</span> <span class="va">region</span>, var <span class="op">=</span> <span class="st">"public_sector_corruption"</span>,</span>
<span>           at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>public_sector_corruption <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">80</span><span class="op">)</span>,</span>
<span>                     region <span class="op">=</span> <span class="va">regions_to_use</span><span class="op">)</span>,</span>
<span>           regrid <span class="op">=</span> <span class="st">"response"</span>, delta.var <span class="op">=</span> <span class="fl">0.001</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>panel <span class="op">=</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"Corruption set to {public_sector_corruption}"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">slopes_to_plot</span> <span class="op">&lt;-</span> <span class="va">logit_predictions</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">public_sector_corruption</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">80</span><span class="op">)</span>,</span>
<span>         <span class="va">region</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">regions_to_use</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="fu">select</span><span class="op">(</span><span class="va">logit_slopes</span>, <span class="va">public_sector_corruption</span>, <span class="va">region</span>, <span class="va">public_sector_corruption.trend</span>, <span class="va">panel</span><span class="op">)</span>,</span>
<span>            by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"public_sector_corruption"</span>, <span class="st">"region"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>intercept <span class="op">=</span> <span class="fu">find_intercept</span><span class="op">(</span><span class="va">public_sector_corruption</span>, <span class="va">prob</span>, <span class="va">public_sector_corruption.trend</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>round_slope <span class="op">=</span> <span class="fu">label_number</span><span class="op">(</span>accuracy <span class="op">=</span> <span class="fl">0.001</span>, style_negative <span class="op">=</span> <span class="st">"minus"</span><span class="op">)</span><span class="op">(</span><span class="va">public_sector_corruption.trend</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span>,</span>
<span>         nice_slope <span class="op">=</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"Slope: {round_slope} pct pts"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">logit_predictions</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">public_sector_corruption</span>, y <span class="op">=</span> <span class="va">prob</span>, color <span class="op">=</span> <span class="va">region</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span>linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>data <span class="op">=</span> <span class="va">slopes_to_plot</span>, size <span class="op">=</span> <span class="fl">2</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_abline</span><span class="op">(</span>data <span class="op">=</span> <span class="va">slopes_to_plot</span>, </span>
<span>              <span class="fu">aes</span><span class="op">(</span>slope <span class="op">=</span> <span class="va">public_sector_corruption.trend</span>, intercept <span class="op">=</span> <span class="va">intercept</span>, color <span class="op">=</span> <span class="va">region</span><span class="op">)</span>, </span>
<span>              linewidth <span class="op">=</span> <span class="fl">0.5</span>, linetype <span class="op">=</span> <span class="st">"21"</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_label_repel</span><span class="op">(</span>data <span class="op">=</span> <span class="va">slopes_to_plot</span>, <span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">nice_slope</span><span class="op">)</span>,</span>
<span>                   fontface <span class="op">=</span> <span class="st">"bold"</span>, seed <span class="op">=</span> <span class="fl">123</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                   size <span class="op">=</span> <span class="fl">3</span>, direction <span class="op">=</span> <span class="st">"y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Public sector corruption"</span>, </span>
<span>       y <span class="op">=</span> <span class="st">"Predicted probability of having\na campaign finance disclosure law"</span>, </span>
<span>       color <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">percent_format</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"grey30"</span>, <span class="va">clrs</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">panel</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_mfx</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/plot-logit-predictions-slopes-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page-inset-right" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>AHH this is delightful! This helps us understand and visualize all these marginal effects. Let’s interpret them:</p>
<ul>
<li>In both the Middle East and Western Europe/North America, an increase in public sector corruption in countries with low levels of corruption (20) is associated with a −2.040 and −2.493 percentage point decrease in the probability of seeing a disclosure law, while in low-corruption countries in Latin America, an increase in public sector corruption doesn’t do much to the probability (it <em>increases</em> it slightly by 0.083 percentage points)</li>
<li>In countries with high levels of corruption (80), on the other hand, a small increase in corruption doesn’t do much to the probability of having a disclosure law in the Middle East (−0.011 percentage point decrease) or Western Europe (−0.001 percentage point decrease). In Latin America, though, a small increase in corruption is associated with a −0.437 percentage point decrease in the probability of having a disclosure law.</li>
</ul>
<p><strong>MAJOR CAVEAT</strong>: None of these marginal effects are statistically significant, so there’s a good chance that they’re possibly zero, or positive, or more negative, or whatever. We can plot just these marginal slopes to show this:</p>
<div class="cell" data-layout-align="center" height="3.5">
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">logit_slopes</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">public_sector_corruption.trend</span> <span class="op">*</span> <span class="fl">100</span>, y <span class="op">=</span> <span class="va">region</span>, color <span class="op">=</span> <span class="va">region</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, linetype <span class="op">=</span> <span class="st">"24"</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_pointrange</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xmin <span class="op">=</span> <span class="va">asymp.LCL</span> <span class="op">*</span> <span class="fl">100</span>, xmax <span class="op">=</span> <span class="va">asymp.UCL</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">clrs</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">clrs</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Marginal effect (percentage points)"</span>, y <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">panel</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_mfx</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-logit-mfx-coef-plot-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
</section></section><section id="average-marginal-effects-at-counterfactual-user-specified-values" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="average-marginal-effects-at-counterfactual-user-specified-values">Average marginal effects at counterfactual user-specified values</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Counterfactual grids in emmeans
</div>
</div>
<div class="callout-body-container callout-body">
<p>When I first wrote this in 2022, <strong>emmeans</strong> did not have support for counterfactual grids, but <strong>marginaleffects</strong> did, so here I only show this example with <strong>marginaleffects</strong>. Later in 2022, however, <a href="https://cran.r-project.org/web/packages/emmeans/vignettes/messy-data.html#counterfact"><strong>emmeans</strong> added a <code>counterfactuals</code> argument to <code>ref_grid()</code></a>, so you can actually calculate these same average marginal effects at counterfactual user-specified values with both <strong>marginaleffects</strong> and <strong>emmeans</strong> now.</p>
</div>
</div>
<p>Calculating marginal effects at representative values is useful and widespread—plugging different values into the model while holding others constant is the best way to see how all the different moving parts of a model work, especially when there interactions, exponents, or non-linear outcomes. We’re using the full mixing panel here!</p>
<p>However, creating a hypothetical data or reference grid creates hypothetical observations that might never exist in real life. This was the main difference behind the average marginal effect (AME) and the marginal effect at the mean (MEM) that we looked at earlier. Passing average covariate values into a model creates average predictions, but those averages might not reflect reality.</p>
<p>For example, we used this data grid to look at the effect of corruption on the probability of having a campaign finance disclosure law across different regions:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">datagrid</span><span class="op">(</span>model <span class="op">=</span> <span class="va">model_logit_fancy</span>,</span>
<span>         public_sector_corruption <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">80</span><span class="op">)</span>,</span>
<span>         region <span class="op">=</span> <span class="va">regions_to_use</span><span class="op">)</span></span>
<span><span class="co">##   disclose_donations polyarchy log_gdp_percapita public_sector_corruption                           region</span></span>
<span><span class="co">## 1              FALSE      52.8              8.57                       20 Western Europe and North America</span></span>
<span><span class="co">## 2              FALSE      52.8              8.57                       20  Latin America and the Caribbean</span></span>
<span><span class="co">## 3              FALSE      52.8              8.57                       20     Middle East and North Africa</span></span>
<span><span class="co">## 4              FALSE      52.8              8.57                       80 Western Europe and North America</span></span>
<span><span class="co">## 5              FALSE      52.8              8.57                       80  Latin America and the Caribbean</span></span>
<span><span class="co">## 6              FALSE      52.8              8.57                       80     Middle East and North Africa</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Polyarchy (democracy) and GDP per capita here are set at their dataset-level means, but that’s not how the world actually works. Levels of democracy and personal wealth vary <em>a lot</em> by region:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">corruption</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">region</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">regions_to_use</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">region</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>avg_polyarchy <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">polyarchy</span><span class="op">)</span>,</span>
<span>            avg_log_gdp_percapita <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">log_gdp_percapita</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 3 × 3</span></span>
<span><span class="co">##   region                           avg_polyarchy avg_log_gdp_percapita</span></span>
<span><span class="co">##   &lt;fct&gt;                                    &lt;dbl&gt;                 &lt;dbl&gt;</span></span>
<span><span class="co">## 1 Latin America and the Caribbean           62.9                  8.77</span></span>
<span><span class="co">## 2 Middle East and North Africa              27.4                  9.01</span></span>
<span><span class="co">## 3 Western Europe and North America          86.5                 10.7</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Western Europe is far more democratic (average polyarchy = 86.50) than the Middle East (average polyarchy = 27.44). But in our calculations for finding region-specific marginal effects, we’ve been using a polyarchy value of 52.79 for all the regions.</p>
<p>Fortunately we can do something neat to work with observed covariate values and thus create an AME-flavored marginal effect at representative values instead of the current MEM-flavored marginal effect at representative values. Here’s the general process:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="images/flow-counterfactual@3x.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page-inset-right" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Instead of creating a data or reference grid, we create multiple copies of our original dataset. In each copy we change the columns that we want to set to specific values and we leave all the other columns at their original values. We then feed all the copies of the dataset into the model and generate a ton of fitted values, which we <em>then</em> collapse into average effects.</p>
<p>That sounds really complex, but it’s only a matter of adding one argument to <code>marginaleffects::datagrid()</code>. We’ll take <code>region</code> out of <code>datagrid</code> here so that we keep all the original regions—we’ll take the average across those regions after the fact.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">cfct_data</span> <span class="op">&lt;-</span> <span class="fu">datagrid</span><span class="op">(</span>model <span class="op">=</span> <span class="va">model_logit_fancy</span>,</span>
<span>                      public_sector_corruption <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">80</span><span class="op">)</span>,</span>
<span>                      grid_type <span class="op">=</span> <span class="st">"counterfactual"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This new data grid has twice the number of rows that we have in the original data, since there are now two copies of the data stacked together:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">corruption</span><span class="op">)</span></span>
<span><span class="co">## [1] 168</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">cfct_data</span><span class="op">)</span></span>
<span><span class="co">## [1] 336</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To verify, lets look at the first 5 rows in each of the copies:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">cfct_data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">corruption</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="co">##     rowidcf disclose_donations polyarchy log_gdp_percapita                           region public_sector_corruption</span></span>
<span><span class="co">## 1         1               TRUE      64.7              9.10  Latin America and the Caribbean                       20</span></span>
<span><span class="co">## 2         2              FALSE      76.1              8.93  Latin America and the Caribbean                       20</span></span>
<span><span class="co">## 3         3              FALSE      90.8             10.85 Western Europe and North America                       20</span></span>
<span><span class="co">## 4         4              FALSE      89.4             11.36 Western Europe and North America                       20</span></span>
<span><span class="co">## 5         5              FALSE      72.0              7.61               Sub-Saharan Africa                       20</span></span>
<span><span class="co">## 169       1               TRUE      64.7              9.10  Latin America and the Caribbean                       80</span></span>
<span><span class="co">## 170       2              FALSE      76.1              8.93  Latin America and the Caribbean                       80</span></span>
<span><span class="co">## 171       3              FALSE      90.8             10.85 Western Europe and North America                       80</span></span>
<span><span class="co">## 172       4              FALSE      89.4             11.36 Western Europe and North America                       80</span></span>
<span><span class="co">## 173       5              FALSE      72.0              7.61               Sub-Saharan Africa                       80</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>That’s neat! These 5 countries all have their original values of polyarchy, GDP per capita, and region, but have their public sector corruption indexes set to 20 (in the first copy) and 80 (in the second copy).</p>
<p>We can feed this stacked data to <code>slopes()</code> to get an instantaneous slope (<code>estimate</code>) for each row:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Specify variables = "public_sector_corruption" so that it doesn't calculate</span></span>
<span><span class="co"># slopes and contrasts for all the other covariates</span></span>
<span><span class="va">mfx_cfct</span> <span class="op">&lt;-</span> <span class="va">model_logit_fancy</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">slopes</span><span class="op">(</span>newdata <span class="op">=</span> <span class="fu">datagrid</span><span class="op">(</span>public_sector_corruption <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">80</span><span class="op">)</span>,</span>
<span>                            grid_type <span class="op">=</span> <span class="st">"counterfactual"</span><span class="op">)</span>,</span>
<span>         variables <span class="op">=</span> <span class="st">"public_sector_corruption"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">mfx_cfct</span><span class="op">)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##  rowidcf                     Term  Estimate Std. Error       z Pr(&gt;|z|)   2.5 %  97.5 % polyarchy log_gdp_percapita                           region public_sector_corruption</span></span>
<span><span class="co">##        1 public_sector_corruption  0.000860    0.00898  0.0958    0.924 -0.0167 0.01846      64.7              9.10 Latin America and the Caribbean                        20</span></span>
<span><span class="co">##        2 public_sector_corruption  0.000861    0.00900  0.0956    0.924 -0.0168 0.01851      76.1              8.93 Latin America and the Caribbean                        20</span></span>
<span><span class="co">##        3 public_sector_corruption -0.024669    0.02425 -1.0174    0.309 -0.0722 0.02285      90.8             10.85 Western Europe and North America                       20</span></span>
<span><span class="co">##        4 public_sector_corruption -0.024566    0.02460 -0.9986    0.318 -0.0728 0.02365      89.4             11.36 Western Europe and North America                       20</span></span>
<span><span class="co">##        5 public_sector_corruption -0.014743    0.01034 -1.4264    0.154 -0.0350 0.00551      72.0              7.61 Sub-Saharan Africa                                     20</span></span>
<span><span class="co">##        6 public_sector_corruption -0.014592    0.01034 -1.4107    0.158 -0.0349 0.00568      70.3              8.64 Sub-Saharan Africa                                     20</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Columns: rowid, rowidcf, term, estimate, std.error, statistic, p.value, conf.low, conf.high, predicted, predicted_hi, predicted_lo, disclose_donations, polyarchy, log_gdp_percapita, region, public_sector_corruption</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally we can calculate group averages for each of the levels of <code>public_sector_corruption</code> to get AME-flavored effects:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mfx_cfct</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">public_sector_corruption</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>avg_slope <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 2 × 2</span></span>
<span><span class="co">##   public_sector_corruption avg_slope</span></span>
<span><span class="co">##                      &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1                       20  -0.0128 </span></span>
<span><span class="co">## 2                       80  -0.00307</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Or we can let <strong>marginaleffects</strong> deal with the averaging so that we can get standard errors and confidence intervals:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_logit_fancy</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">avg_slopes</span><span class="op">(</span>newdata <span class="op">=</span> <span class="fu">datagrid</span><span class="op">(</span>public_sector_corruption <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">80</span><span class="op">)</span>,</span>
<span>                                grid_type <span class="op">=</span> <span class="st">"counterfactual"</span><span class="op">)</span>,</span>
<span>             variables <span class="op">=</span> <span class="st">"public_sector_corruption"</span>,</span>
<span>             by <span class="op">=</span> <span class="st">"public_sector_corruption"</span><span class="op">)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##                      Term    Contrast public_sector_corruption Estimate Std. Error     z Pr(&gt;|z|)    2.5 %    97.5 %</span></span>
<span><span class="co">##  public_sector_corruption mean(dY/dX)                       20 -0.01277    0.00659 -1.94   0.0527 -0.02568  0.000149</span></span>
<span><span class="co">##  public_sector_corruption mean(dY/dX)                       80 -0.00307    0.00123 -2.50   0.0125 -0.00547 -0.000661</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Columns: term, contrast, public_sector_corruption, estimate, std.error, statistic, p.value, conf.low, conf.high, predicted, predicted_hi, predicted_lo</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can also calculate group averages across each region to get region-specific AME-flavored effects:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mfx_cfct</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">region</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">regions_to_use</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">public_sector_corruption</span>, <span class="va">region</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>avg_slope <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## `summarise()` has grouped output by 'public_sector_corruption'. You can override using the `.groups` argument.</span></span>
<span><span class="co">## # A tibble: 6 × 3</span></span>
<span><span class="co">## # Groups:   public_sector_corruption [2]</span></span>
<span><span class="co">##   public_sector_corruption region                            avg_slope</span></span>
<span><span class="co">##                      &lt;dbl&gt; &lt;fct&gt;                                 &lt;dbl&gt;</span></span>
<span><span class="co">## 1                       20 Latin America and the Caribbean   0.000816 </span></span>
<span><span class="co">## 2                       20 Middle East and North Africa     -0.0218   </span></span>
<span><span class="co">## 3                       20 Western Europe and North America -0.0252   </span></span>
<span><span class="co">## 4                       80 Latin America and the Caribbean  -0.00570  </span></span>
<span><span class="co">## 5                       80 Middle East and North Africa     -0.0000711</span></span>
<span><span class="co">## 6                       80 Western Europe and North America -0.0000370</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Or again, we can get standard errors and confidence intervals:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_logit_fancy</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">avg_slopes</span><span class="op">(</span>newdata <span class="op">=</span> <span class="fu">datagrid</span><span class="op">(</span>public_sector_corruption <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">80</span><span class="op">)</span>,</span>
<span>                                grid_type <span class="op">=</span> <span class="st">"counterfactual"</span><span class="op">)</span>,</span>
<span>             variables <span class="op">=</span> <span class="st">"public_sector_corruption"</span>,</span>
<span>             by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"public_sector_corruption"</span>, <span class="st">"region"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##                      Term    Contrast public_sector_corruption                           region  Estimate Std. Error      z Pr(&gt;|z|)     2.5 %    97.5 %</span></span>
<span><span class="co">##  public_sector_corruption mean(dY/dX)                       20 Eastern Europe and Central Asia  -1.84e-03   0.005413 -0.340   0.7337 -0.012452  0.008769</span></span>
<span><span class="co">##  public_sector_corruption mean(dY/dX)                       20 Latin America and the Caribbean   8.16e-04   0.008500  0.096   0.9235 -0.015844  0.017477</span></span>
<span><span class="co">##  public_sector_corruption mean(dY/dX)                       20 Middle East and North Africa     -2.18e-02   0.016457 -1.323   0.1860 -0.054021  0.010490</span></span>
<span><span class="co">##  public_sector_corruption mean(dY/dX)                       20 Sub-Saharan Africa               -1.43e-02   0.011347 -1.262   0.2071 -0.036554  0.007925</span></span>
<span><span class="co">##  public_sector_corruption mean(dY/dX)                       20 Western Europe and North America -2.52e-02   0.023444 -1.077   0.2815 -0.071197  0.020703</span></span>
<span><span class="co">##  public_sector_corruption mean(dY/dX)                       20 Asia and Pacific                 -1.62e-02   0.010530 -1.536   0.1246 -0.036811  0.004467</span></span>
<span><span class="co">##  public_sector_corruption mean(dY/dX)                       80 Eastern Europe and Central Asia  -1.28e-02   0.006090 -2.104   0.0353 -0.024751 -0.000879</span></span>
<span><span class="co">##  public_sector_corruption mean(dY/dX)                       80 Latin America and the Caribbean  -5.70e-03   0.004395 -1.296   0.1951 -0.014309  0.002919</span></span>
<span><span class="co">##  public_sector_corruption mean(dY/dX)                       80 Middle East and North Africa     -7.11e-05   0.000254 -0.279   0.7799 -0.000570  0.000427</span></span>
<span><span class="co">##  public_sector_corruption mean(dY/dX)                       80 Sub-Saharan Africa               -2.21e-04   0.000454 -0.487   0.6261 -0.001112  0.000669</span></span>
<span><span class="co">##  public_sector_corruption mean(dY/dX)                       80 Western Europe and North America -3.70e-05   0.000217 -0.171   0.8646 -0.000463  0.000389</span></span>
<span><span class="co">##  public_sector_corruption mean(dY/dX)                       80 Asia and Pacific                 -2.73e-04   0.000682 -0.401   0.6884 -0.001610  0.001063</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Columns: term, contrast, public_sector_corruption, region, estimate, std.error, statistic, p.value, conf.low, conf.high, predicted, predicted_hi, predicted_lo</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s compare these counterfactual marginal effects with the region-specific marginal effects at representative values that we calculated earlier:</p>
<div class="cell" data-layout-align="center" height="3.5">
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ame_flavored</span> <span class="op">&lt;-</span> <span class="va">model_logit_fancy</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">slopes</span><span class="op">(</span>newdata <span class="op">=</span> <span class="fu">datagrid</span><span class="op">(</span>public_sector_corruption <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">80</span><span class="op">)</span>,</span>
<span>                            grid_type <span class="op">=</span> <span class="st">"counterfactual"</span><span class="op">)</span>,</span>
<span>         variables <span class="op">=</span> <span class="st">"public_sector_corruption"</span>,</span>
<span>         by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"public_sector_corruption"</span>, <span class="st">"region"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">region</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">regions_to_use</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mem_flavored</span> <span class="op">&lt;-</span> <span class="va">model_logit_fancy</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">slopes</span><span class="op">(</span>newdata <span class="op">=</span> <span class="fu">datagrid</span><span class="op">(</span>public_sector_corruption <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">80</span><span class="op">)</span>,</span>
<span>                            region <span class="op">=</span> <span class="va">regions_to_use</span><span class="op">)</span>,</span>
<span>         variables <span class="op">=</span> <span class="st">"public_sector_corruption"</span>,</span>
<span>         by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"public_sector_corruption"</span>, <span class="st">"region"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mfx_to_plot</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span>`Counterfactual stacked data` <span class="op">=</span> <span class="va">ame_flavored</span>, </span>
<span>                         `Average values` <span class="op">=</span> <span class="va">mem_flavored</span>, </span>
<span>                         .id <span class="op">=</span> <span class="st">"approach"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>panel <span class="op">=</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"Corruption set to {public_sector_corruption}"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">mfx_to_plot</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">estimate</span> <span class="op">*</span> <span class="fl">100</span>, y <span class="op">=</span> <span class="va">region</span>, color <span class="op">=</span> <span class="va">region</span>, </span>
<span>                        linetype <span class="op">=</span> <span class="va">approach</span>, shape <span class="op">=</span> <span class="va">approach</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, linetype <span class="op">=</span> <span class="st">"24"</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_pointrange</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xmin <span class="op">=</span> <span class="va">conf.low</span> <span class="op">*</span> <span class="fl">100</span>, xmax <span class="op">=</span> <span class="va">conf.high</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span>,</span>
<span>                  position <span class="op">=</span> <span class="fu">position_dodge</span><span class="op">(</span>width <span class="op">=</span> <span class="op">-</span><span class="fl">0.6</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">clrs</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">clrs</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Marginal effect (percentage points)"</span>, y <span class="op">=</span> <span class="cn">NULL</span>, linetype <span class="op">=</span> <span class="cn">NULL</span>, shape <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">panel</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_mfx</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-cfx-coef-plot-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>In this case there are no huge differences 🤷. BUT STILL this is really neat!</p>
</section></section><section id="categorical-contrasts-as-statisticalmarginal-effects" class="level2"><h2 class="anchored" data-anchor-id="categorical-contrasts-as-statisticalmarginal-effects">Categorical contrasts as statistical/marginal effects</h2>
<p>Confusingly, people sometimes also use the term “marginal effect” to talk about group averages or predicted values (<a href="https://datavizs21.classes.andrewheiss.com/example/07-example/#marginal-effects-plots">I myself am guilty of this!</a>). Technically speaking, a marginal effect is only a partial derivative, or a slope—not a predicted value or a difference in group means.</p>
<p>But regression lends itself well to group means, and predictions and fitted values are fundamental to calculating instantaneous slopes, so both <strong>marginaleffects</strong> and <strong>emmeans</strong> are used for adjusted predictions and marginal means and contrasts. They also use different approaches for calculating these averages, either averaging before putting values in the model (<strong>emmeans</strong>) or averaging after (<strong>marginaleffects</strong>’s default setting).</p>
<p>We’ve already seen two different functions for generating predictions when we plotted the predicted probabilities of having a disclosure law for each region: <code>marginaleffects::predictions()</code> and <code>emmeans::emmeans()</code>.</p>
<p>I won’t go into a ton of detail here about the differences between the two approaches to predictions and contrasts, mostly because pretty much everything we’ve looked at so far applies to both. Instead, you should look at Vincent’s excellent vignettes for <strong>marginaleffects</strong>:</p>
<ul>
<li><a href="https://marginaleffects.com/articles/predictions.html">Predictions</a></li>
<li><a href="https://marginaleffects.com/articles/comparisons.html">Comparisons</a></li>
</ul>
<p>And the equally excellent vignettes for <strong>emmeans</strong>:</p>
<ul>
<li><a href="https://cran.r-project.org/web/packages/emmeans/vignettes/predictions.html">Prediction in emmeans</a></li>
<li><a href="https://cran.r-project.org/web/packages/emmeans/vignettes/comparisons.html">Comparisons and contrasts in emmeans</a></li>
</ul>
<p>You should also check out <a href="https://twitter.com/alexpghayes/status/1282869973006909441">this Twitter thread tutorial</a> by <a href="https://www.alexpghayes.com/">Alex Hayes</a> on categorical contrasts and means—it’s a fantastic illustration of this same process.</p>
<p>In general, the two packages follow the same overall approach that we’ve seen with <code>slopes()</code> and <code>emtrends()</code>:</p>
<ul>
<li>Prediction and comparison functions in <strong>marginaleffects</strong> try to calculate predictions and averages for each row, then collapses them to single average values (either globally or for specific groups). This approach is AME-flavored (though <strong>marginaleffects</strong> can also do MEM-flavored operations and average first).</li>
<li>Prediction and contrast functions in <strong>emmeans</strong> collapse values into averages first, then feeds those average values into the model to generate average predictions and means (either globally or for specific groups). This approach is MEM-flavored.</li>
</ul></section><section id="tldr-overall-summary-of-all-these-marginal-effects-approaches" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="tldr-overall-summary-of-all-these-marginal-effects-approaches">tl;dr: Overall summary of all these marginal effects approaches</h2>
<p><strong><em>PHEW</em></strong> we just did a lot of marginal work. This is important stuff. Unless you’re working with a linear OLS model without any fancy extra things like interactions, polynomials, logs, and so on, <strong>don’t try to talk about marginal effects based on just the output of a regression table—it’s not possible unless you do a lot of manual math!</strong></p>
<p>Both <strong>marginaleffects</strong> and <strong>emmeans</strong> provide all sorts of neat and powerful ways to calculate marginal effects without needing to resort to calculus, but as we’ve seen here, there are some subtle and extremely important differences in how they calculate their different effects.</p>
<p>The main takeaway from this whole post is this: <strong>If you take the average <em>before</em> plugging values into the model, you compute average marginal effects for a combination of covariates that might not actually exist in reality. If you take the average <em>after</em> plugging values into the model, each original observation reflects combinations of covariates that definitely exist in reality, so the average marginal effect reflects that reality.</strong></p>
<p>To remember all these differences, here’s a table summarizing all their different approaches:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="cell-output-display column-page-inset-right">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<colgroup>
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Type</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Process</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">marginaleffects</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">emmeans</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left; width: 15%;">Average marginal effects (AME)</td>
<td style="text-align: left; width: 25%;">Generate predictions for each row of the original data, then collapse to averages</td>
<td style="text-align: left; width: 30%;"><div class="sourceCode" id="cb69"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">avg_slopes</span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></td>
<td style="text-align: left; width: 30%;">Not supported</td>
</tr>
<tr class="even">
<td style="text-align: left; width: 15%;">Group average marginal effects (G-AME)</td>
<td style="text-align: left; width: 25%;">Generate predictions for each row of the original data, then collapse to grouped averages</td>
<td style="text-align: left; width: 30%;"><div class="sourceCode" id="cb70"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">avg_slopes</span><span class="op">(</span><span class="va">model</span>, by <span class="op">=</span> <span class="st">"some_group"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></td>
<td style="text-align: left; width: 30%;">Not supported</td>
</tr>
<tr class="odd">
<td style="text-align: left; width: 15%;">Marginal effects at the mean (MEM)</td>
<td style="text-align: left; width: 25%;">Collapse data to averages, then generate predictions using those averages</td>
<td style="text-align: left; width: 30%;"><div class="sourceCode" id="cb71"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">avg_slopes</span><span class="op">(</span><span class="va">model</span>, newdata <span class="op">=</span> <span class="st">"mean"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></td>
<td style="text-align: left; width: 30%;"><div class="sourceCode" id="cb72"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">emtrends</span><span class="op">(</span><span class="va">model</span>, <span class="va">...</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></td>
</tr>
<tr class="even">
<td style="text-align: left; width: 15%;">Marginal effects at user-specified or representative values (MER)</td>
<td style="text-align: left; width: 25%;">Create a grid of specific and average or typical values, then generate predictions</td>
<td style="text-align: left; width: 30%;"><div class="sourceCode" id="cb73"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">slopes</span><span class="op">(</span></span>
<span>  <span class="va">model</span>,</span>
<span>  newdata <span class="op">=</span> <span class="fu">datagrid</span><span class="op">(</span>some_x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></td>
<td style="text-align: left; width: 30%;"><div class="sourceCode" id="cb74"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">emtrends</span><span class="op">(</span></span>
<span>  <span class="va">model</span>, <span class="va">...</span>,</span>
<span>  at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>some_x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></td>
</tr>
<tr class="odd">
<td style="text-align: left; width: 15%;">Average marginal effects at counterfactual user-specified values</td>
<td style="text-align: left; width: 25%;">Create multiple copies of the original data with some columns set to specific values, then generate predictions for each row of each copy of the original data, then collapse to averages</td>
<td style="text-align: left; width: 30%;"><div class="sourceCode" id="cb75"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">slopes</span><span class="op">(</span></span>
<span>  <span class="va">model</span>,</span>
<span>  newdata <span class="op">=</span> <span class="fu">datagrid</span><span class="op">(</span></span>
<span>    some_x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">20</span><span class="op">)</span>,</span>
<span>    grid_type <span class="op">=</span> <span class="st">"counterfactual"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></td>
<td style="text-align: left; width: 30%;"><div class="sourceCode" id="cb76"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">emtrends</span><span class="op">(</span></span>
<span>  <span class="va">model</span>, <span class="st">"some_x"</span>,</span>
<span>  counterfactuals <span class="op">=</span> <span class="st">"some_x"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></td>
</tr>
</tbody>
</table>
</div>
</div>
<p>And here’s an image with all five of the diagrams at the same time:</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Diagrams!
</div>
</div>
<div class="callout-body-container callout-body">
<p>You can download PDF, SVG, and PNG versions of the marginal effects diagrams in this guide, as well as the original Adobe Illustrator file, here:</p>
<ul>
<li><a href="http://files.andrewheiss.com/marginal-effects-diagrams/marginal-effects-output.zip">PDFs, SVGs, and PNGs</a></li>
<li><a href="http://files.andrewheiss.com/marginal-effects-diagrams/marginal-effects.ai">Illustrator .ai file</a></li>
</ul>
<p>Do whatever you want with them! They’re licensed under <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike (BY-SA 4.0)</a>.</p>
</div>
</div>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="images/flow-everything@3x.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page-inset-right" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section><section id="which-approach-is-best" class="level2"><h2 class="anchored" data-anchor-id="which-approach-is-best">Which approach is best?</h2>
<p>Who even knows.</p>
<p>Both kinds of averaging approaches are pretty widespread. The <a href="https://www.tidymodels.org/"><strong>tidymodels</strong> ecosystem</a> encourages the use of <code>modelr::data_grid()</code> and plugging various combinations of specific and typical variables into models to look at slopes and group contrasts. That’s marginal effects at the mean (MEM) and marginal effects at representative values (MER), which both use average values before putting them in model. And it’s fine—<strong>tidymodels</strong> is used in data science production pipelines around the world.</p>
<p><strong>emmeans</strong> is also incredibly popular in data science and academia. I use it in a few of my blog post guides (<a href="https://www.andrewheiss.com/blog/2021/11/10/ame-bayes-re-guide/">like this one</a> where I talk about average marginal effects the whole time even though technically <em>none</em> of the effects there are true AMEs—they’re all MEMs!). <strong>emmeans</strong> just calculates MEMs and MERs.</p>
<p>The idea of average marginal effects (AMEs)—calculating averages <em>after</em> plugging values into models—is incredibly popular in the social sciences. <strong>marginaleffects</strong>, its predecessor <a href="https://github.com/leeper/margins"><strong>margins</strong></a>, and <a href="https://www.stata.com/features/overview/marginal-analysis/">its Stata counterpart <strong>margins</strong></a> are all used in research in political science, public policy, economics, and other fields.</p>
<p>I’m sure there are super smart people in the world who know when AMEs or MEMs are most appropriate (<a href="https://doi.org/10.1111/j.1540-5907.2012.00602.x">like this article here!</a>), and people who have even better and robust ways to account for the typicalness and/or uncertainty of the original data (<a href="https://arelbundock.com/bayesian_bootstrap.html">see here for an averaging approach using a Bayesian bootstrap</a>, for instance), but I’m not one of those super smart people.</p>


<!-- -->

</section><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{heiss2022,
  author = {Heiss, Andrew},
  title = {Marginalia: {A} Guide to Figuring Out What the Heck Marginal
    Effects, Marginal Slopes, Average Marginal Effects, Marginal Effects
    at the Mean, and All These Other Marginal Things Are},
  date = {2022-05-20},
  url = {https://www.andrewheiss.com/blog/2022/05/20/marginalia/},
  doi = {10.59350/40xaj-4e562},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-heiss2022" class="csl-entry quarto-appendix-citeas" role="listitem">
Heiss, Andrew. 2022. <span>“Marginalia: A Guide to Figuring Out What the
Heck Marginal Effects, Marginal Slopes, Average Marginal Effects,
Marginal Effects at the Mean, and All These Other Marginal Things
Are.”</span> May 20, 2022. <a href="https://doi.org/10.59350/40xaj-4e562">https://doi.org/10.59350/40xaj-4e562</a>.
</div></div></section></div></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/www\.andrewheiss\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><script src="https://giscus.app/client.js" data-repo="andrewheiss/ath-quarto" data-repo-id="R_kgDOIg6EJQ" data-category="Blog comments" data-category-id="DIC_kwDOIg6EJc4CSz92" data-mapping="pathname" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script><input type="hidden" id="giscus-base-theme" value="light"><input type="hidden" id="giscus-alt-theme" value="dark"><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb77" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Marginalia: A guide to figuring out what the heck marginal effects, marginal slopes, average marginal effects, marginal effects at the mean, and all these other marginal things are"</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> 2022-05-20</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a><span class="an">description:</span><span class="co"> "Define what marginal effects even are, and then explore the subtle differences between average marginal effects, marginal effects at the mean, and marginal effects at representative values with the marginaleffects and emmeans R packages"</span></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a><span class="an">image:</span><span class="co"> images/twitter-cover@3x.png</span></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span></span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a><span class="co">  - r</span></span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a><span class="co">  - tidyverse</span></span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a><span class="co">  - regression</span></span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a><span class="co">  - statistics</span></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a><span class="co">  - data visualization</span></span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a><span class="co">  - marginal effects</span></span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span><span class="co"> </span></span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a><span class="co">  html: </span></span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-depth: 4</span></span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a><span class="an">resources:</span></span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a><span class="co">  - video/*</span></span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a><span class="an">doi:</span><span class="co"> 10.59350/40xaj-4e562</span></span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true" tabindex="-1"></a><span class="an">citation:</span><span class="co"> true</span></span>
<span id="cb77-20"><a href="#cb77-20" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb77-21"><a href="#cb77-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-22"><a href="#cb77-22" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setup, include=FALSE}</span></span>
<span id="cb77-23"><a href="#cb77-23" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::opts_chunk$set(fig.align = "center", fig.retina = 3,</span></span>
<span id="cb77-24"><a href="#cb77-24" aria-hidden="true" tabindex="-1"></a><span class="in">                      fig.width = 6, fig.height = (6 * 0.618),</span></span>
<span id="cb77-25"><a href="#cb77-25" aria-hidden="true" tabindex="-1"></a><span class="in">                      out.width = "90%", collapse = TRUE)</span></span>
<span id="cb77-26"><a href="#cb77-26" aria-hidden="true" tabindex="-1"></a><span class="in">options(digits = 3, width = 300)</span></span>
<span id="cb77-27"><a href="#cb77-27" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-28"><a href="#cb77-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-29"><a href="#cb77-29" aria-hidden="true" tabindex="-1"></a><span class="in">```{css custom-css, echo=FALSE}</span></span>
<span id="cb77-30"><a href="#cb77-30" aria-hidden="true" tabindex="-1"></a><span class="in">.smaller {</span></span>
<span id="cb77-31"><a href="#cb77-31" aria-hidden="true" tabindex="-1"></a><span class="in">  font-size: 85%;</span></span>
<span id="cb77-32"><a href="#cb77-32" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb77-33"><a href="#cb77-33" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-34"><a href="#cb77-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-35"><a href="#cb77-35" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb77-36"><a href="#cb77-36" aria-hidden="true" tabindex="-1"></a><span class="fu">### Diagrams!</span></span>
<span id="cb77-37"><a href="#cb77-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-38"><a href="#cb77-38" aria-hidden="true" tabindex="-1"></a>You can download PDF, SVG, and PNG versions of the marginal effects diagrams in this guide, as well as the original Adobe Illustrator file, here:</span>
<span id="cb77-39"><a href="#cb77-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-40"><a href="#cb77-40" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">PDFs, SVGs, and PNGs</span><span class="co">](http://files.andrewheiss.com/marginal-effects-diagrams/marginal-effects-output.zip)</span></span>
<span id="cb77-41"><a href="#cb77-41" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Illustrator .ai file</span><span class="co">](http://files.andrewheiss.com/marginal-effects-diagrams/marginal-effects.ai)</span></span>
<span id="cb77-42"><a href="#cb77-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-43"><a href="#cb77-43" aria-hidden="true" tabindex="-1"></a>Do whatever you want with them! They're licensed under <span class="co">[</span><span class="ot">Creative Commons Attribution-ShareAlike (BY-SA 4.0)</span><span class="co">](http://creativecommons.org/licenses/by-sa/4.0/)</span>.</span>
<span id="cb77-44"><a href="#cb77-44" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb77-45"><a href="#cb77-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-46"><a href="#cb77-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-47"><a href="#cb77-47" aria-hidden="true" tabindex="-1"></a>I'm a huge fan of doing research and analysis in public. I try to make <span class="co">[</span><span class="ot">my research public and freely accessible</span><span class="co">](https://www.andrewheiss.com/research/)</span>, but ever since watching <span class="co">[</span><span class="ot">David Robinson's "The unreasonable effectiveness of public work" keynote from rstudio::conf 2019</span><span class="co">](https://www.rstudio.com/resources/rstudioconf-2019/the-unreasonable-effectiveness-of-public-work/)</span>, I've tried to make my research *process* open and accessible too.</span>
<span id="cb77-48"><a href="#cb77-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-49"><a href="#cb77-49" aria-hidden="true" tabindex="-1"></a>According to David, researchers typically view their work like this:</span>
<span id="cb77-50"><a href="#cb77-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-51"><a href="#cb77-51" aria-hidden="true" tabindex="-1"></a><span class="in">```{r normal-work, echo=FALSE, out.width="90%", fig.align="center"}</span></span>
<span id="cb77-52"><a href="#cb77-52" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::include_graphics("images/normal-work.png")</span></span>
<span id="cb77-53"><a href="#cb77-53" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-54"><a href="#cb77-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-55"><a href="#cb77-55" aria-hidden="true" tabindex="-1"></a>People work towards a final published product, which is the most valuable output of the whole process. The intermediate steps like the code, data, preliminary results, and so on, are less valuable and often hidden from the public. People only see the final published thing.</span>
<span id="cb77-56"><a href="#cb77-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-57"><a href="#cb77-57" aria-hidden="true" tabindex="-1"></a>David argues that we should instead see our work like this:</span>
<span id="cb77-58"><a href="#cb77-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-59"><a href="#cb77-59" aria-hidden="true" tabindex="-1"></a><span class="in">```{r public-work, echo=FALSE, out.width="90%", fig.align="center"}</span></span>
<span id="cb77-60"><a href="#cb77-60" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::include_graphics("images/public-work.png")</span></span>
<span id="cb77-61"><a href="#cb77-61" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-62"><a href="#cb77-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-63"><a href="#cb77-63" aria-hidden="true" tabindex="-1"></a>In this paradigm, anything on your computer and only accessible by you isn't that valuable. Anything you make accessible to the public online—including all the intermediate stuff like code, data, and preliminary results, in addition to the final product—is incredibly valuable. The world can benefit from neat code tricks you stumble on while making graphs; the world can benefit from new data sources you find or your way of processing data; the world can benefit from a toy example of a new method you read about in some paper, even if the actual code you write to play around with the method never makes it into any published paper. It's all useful to the broader community of researchers. </span>
<span id="cb77-64"><a href="#cb77-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-65"><a href="#cb77-65" aria-hidden="true" tabindex="-1"></a>Public work also builds community norms—if more people share their behind-the-scenes work, it encourages others to do the same and engage with it and improve it (see <span class="co">[</span><span class="ot">this super detailed and helpful comment</span><span class="co">](https://github.com/andrewheiss/ath-hugo/commit/70197c7389c87b46db6cd61fc1ef8ce7b5c94616#commitcomment-73816081)</span> with corrections to my previous post, for example!).</span>
<span id="cb77-66"><a href="#cb77-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-67"><a href="#cb77-67" aria-hidden="true" tabindex="-1"></a>Public work is also valuable for another more selfish reason. Building an online presence with a wide readership is hard, and my little blog post contributions aren't famous or anything—they're just sitting out here in a tiny corner of the internet. But these guides have been indispensable for me. They've allowed me to work through and understand tricky statistical and programming concepts, *and then* have allowed me to come back to them months later and remember how they work. This whole blog is primarily a resource for future me.</span>
<span id="cb77-68"><a href="#cb77-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-69"><a href="#cb77-69" aria-hidden="true" tabindex="-1"></a>So here's yet another blog post that is hopefully potentially useful for the general public, but that is definitely useful for future me.</span>
<span id="cb77-70"><a href="#cb77-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-71"><a href="#cb77-71" aria-hidden="true" tabindex="-1"></a>In a few of my ongoing research projects, I'm working with non-linear regression models, and I've been struggling to interpret their results. In my past few posts (like <span class="co">[</span><span class="ot">this one on hurdle models</span><span class="co">](https://www.andrewheiss.com/blog/2022/05/09/hurdle-lognormal-gaussian-brms/)</span>, or <span class="co">[</span><span class="ot">this one on multilevel panel data</span><span class="co">](https://www.andrewheiss.com/blog/2021/12/01/multilevel-models-panel-data-guide/)</span>, or <span class="co">[</span><span class="ot">this one on beta and zero-inflated models</span><span class="co">](https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/)</span>), I've explored a bunch of different ways to work with and interpret these more complex models and calculate their marginal effects. I even wrote <span class="co">[</span><span class="ot">a guide to calculating average marginal effects for multilevel models</span><span class="co">](https://www.andrewheiss.com/blog/2021/11/10/ame-bayes-re-guide/)</span>. TURNS OUT™, though, that I've actually been a bit wrong about my terminology for all the marginal effects I've talked about in those posts.</span>
<span id="cb77-72"><a href="#cb77-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-73"><a href="#cb77-73" aria-hidden="true" tabindex="-1"></a>Part of the reason for this wrongness is because there are so many quasi-synonyms for the idea of "marginal effects" and people seem to be pretty <span class="co">[</span><span class="ot">loosey goosey</span><span class="co">](https://www.youtube.com/watch?v=iNukPHje4Fs)</span> about what exactly they're referring to. There are statistical effects, marginal effects, marginal means, marginal slopes, conditional effects, conditional marginal effects, marginal effects at the mean, and many other similarly-named ideas. There are also regression coefficients and estimates, which have marginal effects vibes, but may or may not actually be marginal effects depending on the complexity of the model.</span>
<span id="cb77-74"><a href="#cb77-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-75"><a href="#cb77-75" aria-hidden="true" tabindex="-1"></a>The question of what the heck "marginal effects" are has plagued me for a while. In October 2021 <span class="co">[</span><span class="ot">I publicly announced</span><span class="co">](https://twitter.com/andrewheiss/status/1448719033306648586)</span> that I would finally buckle down and figure out their definitions and nuances:</span>
<span id="cb77-76"><a href="#cb77-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-77"><a href="#cb77-77" aria-hidden="true" tabindex="-1"></a><span class="in">```{r original-tweet, echo=FALSE, out.width="90%", fig.align="center"}</span></span>
<span id="cb77-78"><a href="#cb77-78" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::include_graphics("images/original-tweet.png")</span></span>
<span id="cb77-79"><a href="#cb77-79" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-80"><a href="#cb77-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-81"><a href="#cb77-81" aria-hidden="true" tabindex="-1"></a>And then I didn't.</span>
<span id="cb77-82"><a href="#cb77-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-83"><a href="#cb77-83" aria-hidden="true" tabindex="-1"></a>So here I am, 7 months later, publicly figuring out the differences between regression coefficients, regression predictions, <span class="co">[</span><span class="ot">**marginaleffects**</span><span class="co">](https://marginaleffects.com/)</span>, <span class="co">[</span><span class="ot">**emmeans**</span><span class="co">](https://cran.r-project.org/web/packages/emmeans/index.html)</span>, marginal slopes, average marginal effects, marginal effects at the mean, and all these other "marginal" things that researchers and data scientists use.</span>
<span id="cb77-84"><a href="#cb77-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-85"><a href="#cb77-85" aria-hidden="true" tabindex="-1"></a>This guide is highly didactic and slowly builds up the concept of marginal effects as slopes and partial derivatives. <span class="co">[</span><span class="ot">The tl;dr section at the end</span><span class="co">](#tldr-overall-summary-of-all-these-marginal-effects-approaches)</span> has a useful summary of everything here, with a table showing all the different approaches to marginal effects with corresponding **marginaleffects** and **emmeans** code, as well as some diagrams outlining the two packages' different approaches to averaging. Hopefully it's useful—it is for me!</span>
<span id="cb77-86"><a href="#cb77-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-87"><a href="#cb77-87" aria-hidden="true" tabindex="-1"></a>Let's get started by looking at some lines and slopes (after loading a bunch of packages and creating some useful little functions).</span>
<span id="cb77-88"><a href="#cb77-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-89"><a href="#cb77-89" aria-hidden="true" tabindex="-1"></a><span class="in">```{r libraries-functions, warning=FALSE, message=FALSE}</span></span>
<span id="cb77-90"><a href="#cb77-90" aria-hidden="true" tabindex="-1"></a><span class="in"># Load packages</span></span>
<span id="cb77-91"><a href="#cb77-91" aria-hidden="true" tabindex="-1"></a><span class="in"># ---------------</span></span>
<span id="cb77-92"><a href="#cb77-92" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidyverse)        # dplyr, ggplot2, and friends</span></span>
<span id="cb77-93"><a href="#cb77-93" aria-hidden="true" tabindex="-1"></a><span class="in">library(broom)            # Convert models to data frames</span></span>
<span id="cb77-94"><a href="#cb77-94" aria-hidden="true" tabindex="-1"></a><span class="in">library(marginaleffects)  # Marginal effects stuff</span></span>
<span id="cb77-95"><a href="#cb77-95" aria-hidden="true" tabindex="-1"></a><span class="in">library(emmeans)          # Marginal effects stuff</span></span>
<span id="cb77-96"><a href="#cb77-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-97"><a href="#cb77-97" aria-hidden="true" tabindex="-1"></a><span class="in"># Visualization-related packages</span></span>
<span id="cb77-98"><a href="#cb77-98" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggtext)           # Add markdown/HTML support to text in plots</span></span>
<span id="cb77-99"><a href="#cb77-99" aria-hidden="true" tabindex="-1"></a><span class="in">library(glue)             # Python-esque string interpolation</span></span>
<span id="cb77-100"><a href="#cb77-100" aria-hidden="true" tabindex="-1"></a><span class="in">library(scales)           # Functions to format numbers nicely</span></span>
<span id="cb77-101"><a href="#cb77-101" aria-hidden="true" tabindex="-1"></a><span class="in">library(gganimate)        # Make animated plots</span></span>
<span id="cb77-102"><a href="#cb77-102" aria-hidden="true" tabindex="-1"></a><span class="in">library(patchwork)        # Combine ggplots</span></span>
<span id="cb77-103"><a href="#cb77-103" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggrepel)          # Make labels that don't overlap</span></span>
<span id="cb77-104"><a href="#cb77-104" aria-hidden="true" tabindex="-1"></a><span class="in">library(MetBrewer)        # Artsy color palettes</span></span>
<span id="cb77-105"><a href="#cb77-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-106"><a href="#cb77-106" aria-hidden="true" tabindex="-1"></a><span class="in"># Data-related packages</span></span>
<span id="cb77-107"><a href="#cb77-107" aria-hidden="true" tabindex="-1"></a><span class="in">library(palmerpenguins)   # Penguin data</span></span>
<span id="cb77-108"><a href="#cb77-108" aria-hidden="true" tabindex="-1"></a><span class="in">library(WDI)              # Get data from the World Bank's API</span></span>
<span id="cb77-109"><a href="#cb77-109" aria-hidden="true" tabindex="-1"></a><span class="in">library(countrycode)      # Map country codes to different systems</span></span>
<span id="cb77-110"><a href="#cb77-110" aria-hidden="true" tabindex="-1"></a><span class="in">library(vdemdata)         # Use data from the Varieties of Democracy (V-Dem) project</span></span>
<span id="cb77-111"><a href="#cb77-111" aria-hidden="true" tabindex="-1"></a><span class="in"># Install vdemdata from GitHub, not CRAN</span></span>
<span id="cb77-112"><a href="#cb77-112" aria-hidden="true" tabindex="-1"></a><span class="in"># devtools::install_github("vdeminstitute/vdemdata")</span></span>
<span id="cb77-113"><a href="#cb77-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-114"><a href="#cb77-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-115"><a href="#cb77-115" aria-hidden="true" tabindex="-1"></a><span class="in"># Helpful functions</span></span>
<span id="cb77-116"><a href="#cb77-116" aria-hidden="true" tabindex="-1"></a><span class="in"># -------------------</span></span>
<span id="cb77-117"><a href="#cb77-117" aria-hidden="true" tabindex="-1"></a><span class="in"># Format numbers in pretty ways</span></span>
<span id="cb77-118"><a href="#cb77-118" aria-hidden="true" tabindex="-1"></a><span class="in">nice_number &lt;- label_number(style_negative = "minus", accuracy = 0.01)</span></span>
<span id="cb77-119"><a href="#cb77-119" aria-hidden="true" tabindex="-1"></a><span class="in">nice_p &lt;- label_pvalue(prefix = c("p &lt; ", "p = ", "p &gt; "))</span></span>
<span id="cb77-120"><a href="#cb77-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-121"><a href="#cb77-121" aria-hidden="true" tabindex="-1"></a><span class="in"># Point-slope formula: (y - y1) = m(x - x1)</span></span>
<span id="cb77-122"><a href="#cb77-122" aria-hidden="true" tabindex="-1"></a><span class="in">find_intercept &lt;- function(x1, y1, slope) {</span></span>
<span id="cb77-123"><a href="#cb77-123" aria-hidden="true" tabindex="-1"></a><span class="in">  intercept &lt;- slope * (-x1) + y1</span></span>
<span id="cb77-124"><a href="#cb77-124" aria-hidden="true" tabindex="-1"></a><span class="in">  return(intercept)</span></span>
<span id="cb77-125"><a href="#cb77-125" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb77-126"><a href="#cb77-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-127"><a href="#cb77-127" aria-hidden="true" tabindex="-1"></a><span class="in"># Visualization settings</span></span>
<span id="cb77-128"><a href="#cb77-128" aria-hidden="true" tabindex="-1"></a><span class="in"># ------------------------</span></span>
<span id="cb77-129"><a href="#cb77-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-130"><a href="#cb77-130" aria-hidden="true" tabindex="-1"></a><span class="in"># Custom ggplot theme to make pretty plots</span></span>
<span id="cb77-131"><a href="#cb77-131" aria-hidden="true" tabindex="-1"></a><span class="in"># Get IBM Plex Sans Condensed at https://fonts.google.com/specimen/IBM+Plex+Sans+Condensed</span></span>
<span id="cb77-132"><a href="#cb77-132" aria-hidden="true" tabindex="-1"></a><span class="in">theme_mfx &lt;- function() {</span></span>
<span id="cb77-133"><a href="#cb77-133" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_minimal(base_family = "IBM Plex Sans Condensed") +</span></span>
<span id="cb77-134"><a href="#cb77-134" aria-hidden="true" tabindex="-1"></a><span class="in">    theme(panel.grid.minor = element_blank(),</span></span>
<span id="cb77-135"><a href="#cb77-135" aria-hidden="true" tabindex="-1"></a><span class="in">          plot.background = element_rect(fill = "white", color = NA),</span></span>
<span id="cb77-136"><a href="#cb77-136" aria-hidden="true" tabindex="-1"></a><span class="in">          plot.title = element_text(face = "bold"),</span></span>
<span id="cb77-137"><a href="#cb77-137" aria-hidden="true" tabindex="-1"></a><span class="in">          axis.title = element_text(face = "bold"),</span></span>
<span id="cb77-138"><a href="#cb77-138" aria-hidden="true" tabindex="-1"></a><span class="in">          strip.text = element_text(face = "bold"),</span></span>
<span id="cb77-139"><a href="#cb77-139" aria-hidden="true" tabindex="-1"></a><span class="in">          strip.background = element_rect(fill = "grey80", color = NA),</span></span>
<span id="cb77-140"><a href="#cb77-140" aria-hidden="true" tabindex="-1"></a><span class="in">          legend.title = element_text(face = "bold"))</span></span>
<span id="cb77-141"><a href="#cb77-141" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb77-142"><a href="#cb77-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-143"><a href="#cb77-143" aria-hidden="true" tabindex="-1"></a><span class="in"># Make labels use IBM Plex Sans by default</span></span>
<span id="cb77-144"><a href="#cb77-144" aria-hidden="true" tabindex="-1"></a><span class="in">update_geom_defaults("label", </span></span>
<span id="cb77-145"><a href="#cb77-145" aria-hidden="true" tabindex="-1"></a><span class="in">                     list(family = "IBM Plex Sans Condensed"))</span></span>
<span id="cb77-146"><a href="#cb77-146" aria-hidden="true" tabindex="-1"></a><span class="in">update_geom_defaults(ggtext::GeomRichText, </span></span>
<span id="cb77-147"><a href="#cb77-147" aria-hidden="true" tabindex="-1"></a><span class="in">                     list(family = "IBM Plex Sans Condensed"))</span></span>
<span id="cb77-148"><a href="#cb77-148" aria-hidden="true" tabindex="-1"></a><span class="in">update_geom_defaults("label_repel", </span></span>
<span id="cb77-149"><a href="#cb77-149" aria-hidden="true" tabindex="-1"></a><span class="in">                     list(family = "IBM Plex Sans Condensed"))</span></span>
<span id="cb77-150"><a href="#cb77-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-151"><a href="#cb77-151" aria-hidden="true" tabindex="-1"></a><span class="in"># Use the Johnson color palette</span></span>
<span id="cb77-152"><a href="#cb77-152" aria-hidden="true" tabindex="-1"></a><span class="in">clrs &lt;- met.brewer("Johnson")</span></span>
<span id="cb77-153"><a href="#cb77-153" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-154"><a href="#cb77-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-155"><a href="#cb77-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-156"><a href="#cb77-156" aria-hidden="true" tabindex="-1"></a><span class="fu">## What does "marginal" even mean in the first place?</span></span>
<span id="cb77-157"><a href="#cb77-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-158"><a href="#cb77-158" aria-hidden="true" tabindex="-1"></a>Put as simply as possible, in the world of statistics, "marginal" means "additional," or what happens to outcome variable $y$ when explanatory variable $x$ changes a little.</span>
<span id="cb77-159"><a href="#cb77-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-160"><a href="#cb77-160" aria-hidden="true" tabindex="-1"></a>To find out precisely how much things change, we need to use calculus. </span>
<span id="cb77-161"><a href="#cb77-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-162"><a href="#cb77-162" aria-hidden="true" tabindex="-1"></a>Oh no.</span>
<span id="cb77-163"><a href="#cb77-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-164"><a href="#cb77-164" aria-hidden="true" tabindex="-1"></a><span class="fu">### Super quick crash course in differential calculus (it's not scary, I promise!)</span></span>
<span id="cb77-165"><a href="#cb77-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-166"><a href="#cb77-166" aria-hidden="true" tabindex="-1"></a>I haven't taken a formal calculus class since my senior year of high school in 2002. I enjoyed it a ton and got the highest score on the <span class="co">[</span><span class="ot">AP Calculus BC test</span><span class="co">](https://apstudents.collegeboard.org/courses/ap-calculus-bc)</span>, which gave me enough college credits to not need it as an undergraduate, given that I majored in Middle East Studies, Arabic, and Italian. I figured I'd never need to think about calculus every again. lol. </span>
<span id="cb77-167"><a href="#cb77-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-168"><a href="#cb77-168" aria-hidden="true" tabindex="-1"></a>In my first PhD-level stats class in 2012, the professor cancelled class for the first month and assigned us all to go relearn calculus with Khan Academy, since I wasn't alone in my unlearning of calculus. Even after that crash course refresher, I don't really ever use it in my own research. When I do, I only use it to think about derivatives and slopes, since those are central to statistics.</span>
<span id="cb77-169"><a href="#cb77-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-170"><a href="#cb77-170" aria-hidden="true" tabindex="-1"></a>Calculus can be boiled down to two forms: (1) **differential calculus** is all about finding rates of changes by calculating derivatives, or slopes, while (2) **integral calculus** is all about finding total amounts, or areas, by adding infinitesimally small things together. According to <span class="co">[</span><span class="ot">the fundamental theorem of calculus</span><span class="co">](https://en.wikipedia.org/wiki/Fundamental_theorem_of_calculus)</span>, these two types are actually the inverse of each other—you can find the total area under a curve based on its slope, for instance. Super neat stuff. If you want a cool accessible refresher / history of all this, check out Steven Strogatz's <span class="co">[</span><span class="ot">*Infinite Powers: How Calculus Reveals the Secrets of the Universe*</span><span class="co">](https://www.amazon.com/Infinite-Powers-Calculus-Reveals-Universe/dp/1328879984)</span>—it's great.</span>
<span id="cb77-171"><a href="#cb77-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-172"><a href="#cb77-172" aria-hidden="true" tabindex="-1"></a>In the world of statistics and marginal effects all we care about are slopes, which are solely a differential calculus idea.</span>
<span id="cb77-173"><a href="#cb77-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-174"><a href="#cb77-174" aria-hidden="true" tabindex="-1"></a>Let's pretend we have a line that shows the relationship between $x$ and $y$ that's defined with an equation using the form $y = mx + b$, where $m$ is the slope and $b$ is the y-intercept. We can plot it with ggplot using the helpful <span class="in">`geom_function()`</span> function:</span>
<span id="cb77-175"><a href="#cb77-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-176"><a href="#cb77-176" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb77-177"><a href="#cb77-177" aria-hidden="true" tabindex="-1"></a>y = 2x - 1</span>
<span id="cb77-178"><a href="#cb77-178" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb77-179"><a href="#cb77-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-180"><a href="#cb77-180" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-line, warning=FALSE}</span></span>
<span id="cb77-181"><a href="#cb77-181" aria-hidden="true" tabindex="-1"></a><span class="in"># y = 2x - 1</span></span>
<span id="cb77-182"><a href="#cb77-182" aria-hidden="true" tabindex="-1"></a><span class="in">a_line &lt;- function(x) (2 * x) - 1</span></span>
<span id="cb77-183"><a href="#cb77-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-184"><a href="#cb77-184" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot() +</span></span>
<span id="cb77-185"><a href="#cb77-185" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0, linewidth = 0.5, color = "grey50") +</span></span>
<span id="cb77-186"><a href="#cb77-186" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_hline(yintercept = 0, linewidth = 0.5, color = "grey50") +</span></span>
<span id="cb77-187"><a href="#cb77-187" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_function(fun = a_line, linewidth = 1, color = clrs[2]) +</span></span>
<span id="cb77-188"><a href="#cb77-188" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(breaks = -2:5, limits = c(-1, 3)) +</span></span>
<span id="cb77-189"><a href="#cb77-189" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_y_continuous(breaks = -3:9) +</span></span>
<span id="cb77-190"><a href="#cb77-190" aria-hidden="true" tabindex="-1"></a><span class="in">  annotate(geom = "segment", x = 1, y = 1.3, xend = 1, yend = 3, color = clrs[4], linewidth = 0.5) +</span></span>
<span id="cb77-191"><a href="#cb77-191" aria-hidden="true" tabindex="-1"></a><span class="in">  annotate(geom = "segment", x = 1, y = 3, xend = 1.8, yend = 3, color = clrs[4], linewidth = 0.5) +</span></span>
<span id="cb77-192"><a href="#cb77-192" aria-hidden="true" tabindex="-1"></a><span class="in">  annotate(geom = "richtext", x = 1.4, y = 3.1, label = "Slope: **2**", vjust = 0) +</span></span>
<span id="cb77-193"><a href="#cb77-193" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "x", y = "y") +</span></span>
<span id="cb77-194"><a href="#cb77-194" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_equal() +</span></span>
<span id="cb77-195"><a href="#cb77-195" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_mfx()</span></span>
<span id="cb77-196"><a href="#cb77-196" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-197"><a href="#cb77-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-198"><a href="#cb77-198" aria-hidden="true" tabindex="-1"></a>The line crosses the y-axis at -1, and its slope, or its $\frac{\text{rise}}{\text{run}}$ is 2, or $\frac{2}{1}$, meaning that we go up two units and to the right one unit.</span>
<span id="cb77-199"><a href="#cb77-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-200"><a href="#cb77-200" aria-hidden="true" tabindex="-1"></a>Importantly, the slope shows the relationship between $x$ and $y$. If $x$ increases by 1 unit, $y$ increases by 2: when $x$ is 1, $y$ is 1; when $x$ is 2, $y$ is 3, and so on. We can call this the *marginal effect*, or the change in $y$ that results from one additional $x$.</span>
<span id="cb77-201"><a href="#cb77-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-202"><a href="#cb77-202" aria-hidden="true" tabindex="-1"></a>We can think about this slope using calculus language too. In differential calculus, slopes are called *derivatives* and they represent the change in $y$ that results from changes in $x$, or $\frac{dy}{dx}$. The $d$ here refers to an infinitesimal change in the values of $x$ and $y$, rather than a one-unit change like we think of when looking at the slope as $\frac{\text{rise}}{\text{run}}$. Even more technically, the $d$ indicates that we're working with the total derivative, since there's only one variable ($x$) to consider. If we had more variables (like $y = 2x + 3z -1$), we would need to find the partial derivative for $x$, holding $z$ constant, and we'd write the derivative with a $\partial$ symbol instead: $\frac{\partial y}{\partial x}$. More on that in a bit.</span>
<span id="cb77-203"><a href="#cb77-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-204"><a href="#cb77-204" aria-hidden="true" tabindex="-1"></a>By plotting this line, we can figure out $\frac{dy}{dx}$ visually—the slope is 2. But we can figure it out mathematically too. Differential calculus is full of <span class="co">[</span><span class="ot">fancy tricks and rules of thumb</span><span class="co">](https://en.wikipedia.org/wiki/Differentiation_rules)</span> for figuring out derivatives, like the <span class="co">[</span><span class="ot">power rule</span><span class="co">](https://en.wikipedia.org/wiki/Power_rule)</span>, the <span class="co">[</span><span class="ot">chain rule</span><span class="co">](https://en.wikipedia.org/wiki/Chain_rule)</span>, and so on. The easiest one for me to remember is the power rule, which says you can find the slope of a variable like $x$ by decreasing its exponent by 1 and multiplying that exponent by the variable's coefficient. All constants (terms without $x$) disappear.</span>
<span id="cb77-205"><a href="#cb77-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-206"><a href="#cb77-206" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb77-207"><a href="#cb77-207" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb77-208"><a href="#cb77-208" aria-hidden="true" tabindex="-1"></a>y &amp;= 2x - 1 <span class="sc">\\</span></span>
<span id="cb77-209"><a href="#cb77-209" aria-hidden="true" tabindex="-1"></a>&amp;= 2x^1 - 1 <span class="sc">\\</span></span>
<span id="cb77-210"><a href="#cb77-210" aria-hidden="true" tabindex="-1"></a>\frac{dy}{dx}&amp;= (1 \times 2) x^0 <span class="sc">\\</span></span>
<span id="cb77-211"><a href="#cb77-211" aria-hidden="true" tabindex="-1"></a>&amp;=  2</span>
<span id="cb77-212"><a href="#cb77-212" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb77-213"><a href="#cb77-213" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb77-214"><a href="#cb77-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-215"><a href="#cb77-215" aria-hidden="true" tabindex="-1"></a>(My secret is that I only know the power rule and so I avoid calculus at all costs and either <span class="co">[</span><span class="ot">use R</span><span class="co">](https://www.andrewheiss.com/blog/2018/02/15/derivatives-r-fun/)</span> or use Wolfram Alpha—go to <span class="co">[</span><span class="ot">Wolfram Alpha</span><span class="co">](https://www.wolframalpha.com)</span>, type in <span class="in">`derivative y = 2x - 1`</span> and you'll <span class="co">[</span><span class="ot">see some magic</span><span class="co">](https://www.wolframalpha.com/input?i=derivative+y+%3D+2x+-+1)</span>.)</span>
<span id="cb77-216"><a href="#cb77-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-217"><a href="#cb77-217" aria-hidden="true" tabindex="-1"></a>We thus know that the derivative of $y = 2x - 1$ is $\frac{dy}{dx} = 2$. At every point on this line, the slope is 2—it never changes.</span>
<span id="cb77-218"><a href="#cb77-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-219"><a href="#cb77-219" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-line-slope-labels, fig.height=7}</span></span>
<span id="cb77-220"><a href="#cb77-220" aria-hidden="true" tabindex="-1"></a><span class="in">slope_annotations &lt;- tibble(x = c(-0.25, 1.2, 2.4)) |&gt; </span></span>
<span id="cb77-221"><a href="#cb77-221" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(y = a_line(x)) |&gt; </span></span>
<span id="cb77-222"><a href="#cb77-222" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(nice_y = y + 1) |&gt; </span></span>
<span id="cb77-223"><a href="#cb77-223" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(nice_label = glue("x: {x}; y: {y}&lt;br&gt;",</span></span>
<span id="cb77-224"><a href="#cb77-224" aria-hidden="true" tabindex="-1"></a><span class="in">                           "Slope (dy/dx): **{2}**"))</span></span>
<span id="cb77-225"><a href="#cb77-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-226"><a href="#cb77-226" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot() +</span></span>
<span id="cb77-227"><a href="#cb77-227" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0, linewidth = 0.5, color = "grey50") +</span></span>
<span id="cb77-228"><a href="#cb77-228" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_hline(yintercept = 0, linewidth = 0.5, color = "grey50") +</span></span>
<span id="cb77-229"><a href="#cb77-229" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_function(fun = a_line, linewidth = 1, color = clrs[2]) +</span></span>
<span id="cb77-230"><a href="#cb77-230" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(data = slope_annotations, aes(x = x, y = y)) +</span></span>
<span id="cb77-231"><a href="#cb77-231" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_richtext(data = slope_annotations, </span></span>
<span id="cb77-232"><a href="#cb77-232" aria-hidden="true" tabindex="-1"></a><span class="in">                aes(x = x, y = y, label = nice_label),</span></span>
<span id="cb77-233"><a href="#cb77-233" aria-hidden="true" tabindex="-1"></a><span class="in">                nudge_y = 0.5) +</span></span>
<span id="cb77-234"><a href="#cb77-234" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(breaks = -2:5, limits = c(-1, 3)) +</span></span>
<span id="cb77-235"><a href="#cb77-235" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_y_continuous(breaks = -3:9) +</span></span>
<span id="cb77-236"><a href="#cb77-236" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "x", y = "y") +</span></span>
<span id="cb77-237"><a href="#cb77-237" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_equal() +</span></span>
<span id="cb77-238"><a href="#cb77-238" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_mfx()</span></span>
<span id="cb77-239"><a href="#cb77-239" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-240"><a href="#cb77-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-241"><a href="#cb77-241" aria-hidden="true" tabindex="-1"></a>The power rule seems super basic for equations with non-exponentiated $x$s, but it's really helpful with more complex equations, like this parabola $y = -0.5x^2 + 5x + 5$:</span>
<span id="cb77-242"><a href="#cb77-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-243"><a href="#cb77-243" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-parabola, fig.width=7, fig.height=5}</span></span>
<span id="cb77-244"><a href="#cb77-244" aria-hidden="true" tabindex="-1"></a><span class="in"># y = -0.5x^2 + 5x + 5</span></span>
<span id="cb77-245"><a href="#cb77-245" aria-hidden="true" tabindex="-1"></a><span class="in">a_parabola &lt;- function(x) (-0.5 * x^2) + (5 * x) + 5</span></span>
<span id="cb77-246"><a href="#cb77-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-247"><a href="#cb77-247" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot() +</span></span>
<span id="cb77-248"><a href="#cb77-248" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0, linewidth = 0.5, color = "grey50") +</span></span>
<span id="cb77-249"><a href="#cb77-249" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_hline(yintercept = 0, linewidth = 0.5, color = "grey50") +</span></span>
<span id="cb77-250"><a href="#cb77-250" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_function(fun = a_parabola, linewidth = 1, color = clrs[2]) +</span></span>
<span id="cb77-251"><a href="#cb77-251" aria-hidden="true" tabindex="-1"></a><span class="in">  xlim(-5, 15) +</span></span>
<span id="cb77-252"><a href="#cb77-252" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "x", y = "y") +</span></span>
<span id="cb77-253"><a href="#cb77-253" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(ylim = c(-5, 20)) +</span></span>
<span id="cb77-254"><a href="#cb77-254" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_mfx()</span></span>
<span id="cb77-255"><a href="#cb77-255" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-256"><a href="#cb77-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-257"><a href="#cb77-257" aria-hidden="true" tabindex="-1"></a>What's interesting here is that there's no longer a single slope for the whole function. The steepness of the slope across a range of $x$s depends on whatever $x$ currently is. The curve is steeper at really low and really high values of $x$ and it is shallower around 5 (and it is completely flat when $x$ is 5).</span>
<span id="cb77-258"><a href="#cb77-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-259"><a href="#cb77-259" aria-hidden="true" tabindex="-1"></a>If we apply the power rule to the parabola formula we can find the exact slope:</span>
<span id="cb77-260"><a href="#cb77-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-261"><a href="#cb77-261" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb77-262"><a href="#cb77-262" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb77-263"><a href="#cb77-263" aria-hidden="true" tabindex="-1"></a>y &amp;= -0.5x^2 + 5x^1 + 5 <span class="sc">\\</span></span>
<span id="cb77-264"><a href="#cb77-264" aria-hidden="true" tabindex="-1"></a>\frac{dy}{dx} &amp;= (2 \times -0.5) x + (1 \times 5) x^0 <span class="sc">\\</span></span>
<span id="cb77-265"><a href="#cb77-265" aria-hidden="true" tabindex="-1"></a>&amp;= -x + 5</span>
<span id="cb77-266"><a href="#cb77-266" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb77-267"><a href="#cb77-267" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb77-268"><a href="#cb77-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-269"><a href="#cb77-269" aria-hidden="true" tabindex="-1"></a>When $x$ is 0, the slope is 5 ($-0 + 5$); when $x$ is 8, the slope is −3 ($-8 + 5$), and so on. We can visualize this if we draw some lines tangent to some different points on the equation. The slope of each of these tangent lines represents the instantaneous slope of the parabola at each $x$ value.</span>
<span id="cb77-270"><a href="#cb77-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-271"><a href="#cb77-271" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-parabola-labels, fig.width=7, fig.height=5}</span></span>
<span id="cb77-272"><a href="#cb77-272" aria-hidden="true" tabindex="-1"></a><span class="in"># dy/dx = -x + 5</span></span>
<span id="cb77-273"><a href="#cb77-273" aria-hidden="true" tabindex="-1"></a><span class="in">parabola_slope &lt;- function(x) (-x) + 5</span></span>
<span id="cb77-274"><a href="#cb77-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-275"><a href="#cb77-275" aria-hidden="true" tabindex="-1"></a><span class="in">slope_annotations &lt;- tibble(</span></span>
<span id="cb77-276"><a href="#cb77-276" aria-hidden="true" tabindex="-1"></a><span class="in">  x = c(0, 3, 8)</span></span>
<span id="cb77-277"><a href="#cb77-277" aria-hidden="true" tabindex="-1"></a><span class="in">) |&gt; </span></span>
<span id="cb77-278"><a href="#cb77-278" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(y = a_parabola(x),</span></span>
<span id="cb77-279"><a href="#cb77-279" aria-hidden="true" tabindex="-1"></a><span class="in">         slope = parabola_slope(x),</span></span>
<span id="cb77-280"><a href="#cb77-280" aria-hidden="true" tabindex="-1"></a><span class="in">         intercept = find_intercept(x, y, slope),</span></span>
<span id="cb77-281"><a href="#cb77-281" aria-hidden="true" tabindex="-1"></a><span class="in">         nice_slope = glue("Slope (dy/dx)&lt;br&gt;&lt;span style='font-size:12pt;color:{clrs[4]}'&gt;**{slope}**&lt;/span&gt;"))</span></span>
<span id="cb77-282"><a href="#cb77-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-283"><a href="#cb77-283" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot() +</span></span>
<span id="cb77-284"><a href="#cb77-284" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0, linewidth = 0.5, color = "grey50") +</span></span>
<span id="cb77-285"><a href="#cb77-285" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_hline(yintercept = 0, linewidth = 0.5, color = "grey50") +</span></span>
<span id="cb77-286"><a href="#cb77-286" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_function(fun = a_parabola, linewidth = 1, color = clrs[2]) +</span></span>
<span id="cb77-287"><a href="#cb77-287" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_abline(data = slope_annotations,</span></span>
<span id="cb77-288"><a href="#cb77-288" aria-hidden="true" tabindex="-1"></a><span class="in">              aes(slope = slope, intercept = intercept),</span></span>
<span id="cb77-289"><a href="#cb77-289" aria-hidden="true" tabindex="-1"></a><span class="in">              linewidth = 0.5, color = clrs[4], linetype = "21") +</span></span>
<span id="cb77-290"><a href="#cb77-290" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(data = slope_annotations, aes(x = x, y = y),</span></span>
<span id="cb77-291"><a href="#cb77-291" aria-hidden="true" tabindex="-1"></a><span class="in">             size = 3, color = clrs[4]) +</span></span>
<span id="cb77-292"><a href="#cb77-292" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_richtext(data = slope_annotations, aes(x = x, y = y, label = nice_slope),</span></span>
<span id="cb77-293"><a href="#cb77-293" aria-hidden="true" tabindex="-1"></a><span class="in">                nudge_y = 2) +</span></span>
<span id="cb77-294"><a href="#cb77-294" aria-hidden="true" tabindex="-1"></a><span class="in">  xlim(-5, 15) +</span></span>
<span id="cb77-295"><a href="#cb77-295" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "x", y = "y") +</span></span>
<span id="cb77-296"><a href="#cb77-296" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(ylim = c(-5, 20)) +</span></span>
<span id="cb77-297"><a href="#cb77-297" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_mfx()</span></span>
<span id="cb77-298"><a href="#cb77-298" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-299"><a href="#cb77-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-300"><a href="#cb77-300" aria-hidden="true" tabindex="-1"></a>And here's an animation of what the slope looks like across a whole range of $x$s. Neat!</span>
<span id="cb77-301"><a href="#cb77-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-302"><a href="#cb77-302" aria-hidden="true" tabindex="-1"></a><span class="in">```{r animate-parabola-slope, include=FALSE, cache=TRUE}</span></span>
<span id="cb77-303"><a href="#cb77-303" aria-hidden="true" tabindex="-1"></a><span class="in">lotsa_lines &lt;- tibble(</span></span>
<span id="cb77-304"><a href="#cb77-304" aria-hidden="true" tabindex="-1"></a><span class="in">  x = seq(-1, 11, 0.1)</span></span>
<span id="cb77-305"><a href="#cb77-305" aria-hidden="true" tabindex="-1"></a><span class="in">) |&gt; </span></span>
<span id="cb77-306"><a href="#cb77-306" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(y = a_parabola(x),</span></span>
<span id="cb77-307"><a href="#cb77-307" aria-hidden="true" tabindex="-1"></a><span class="in">         slope = parabola_slope(x),</span></span>
<span id="cb77-308"><a href="#cb77-308" aria-hidden="true" tabindex="-1"></a><span class="in">         intercept = find_intercept(x, y, slope),</span></span>
<span id="cb77-309"><a href="#cb77-309" aria-hidden="true" tabindex="-1"></a><span class="in">         nice_slope = glue("Slope (dy/dx)&lt;br&gt;&lt;span style='font-size:12pt;color:{clrs[4]}'&gt;**{nice_number(slope)}**&lt;/span&gt;"))</span></span>
<span id="cb77-310"><a href="#cb77-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-311"><a href="#cb77-311" aria-hidden="true" tabindex="-1"></a><span class="in">parabola_slope &lt;- ggplot() +</span></span>
<span id="cb77-312"><a href="#cb77-312" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0, linewidth = 0.5, color = "grey50") +</span></span>
<span id="cb77-313"><a href="#cb77-313" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_hline(yintercept = 0, linewidth = 0.5, color = "grey50") +</span></span>
<span id="cb77-314"><a href="#cb77-314" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_function(fun = a_parabola, linewidth = 1, color = clrs[2]) +</span></span>
<span id="cb77-315"><a href="#cb77-315" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_abline(data = lotsa_lines,</span></span>
<span id="cb77-316"><a href="#cb77-316" aria-hidden="true" tabindex="-1"></a><span class="in">              aes(slope = slope, intercept = intercept),</span></span>
<span id="cb77-317"><a href="#cb77-317" aria-hidden="true" tabindex="-1"></a><span class="in">              linewidth = 0.5, color = clrs[4], linetype = "21") +</span></span>
<span id="cb77-318"><a href="#cb77-318" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(data = lotsa_lines, aes(x = x, y = y),</span></span>
<span id="cb77-319"><a href="#cb77-319" aria-hidden="true" tabindex="-1"></a><span class="in">             size = 3, color = clrs[4]) +</span></span>
<span id="cb77-320"><a href="#cb77-320" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_richtext(data = lotsa_lines, aes(x = x, y = y, label = nice_slope),</span></span>
<span id="cb77-321"><a href="#cb77-321" aria-hidden="true" tabindex="-1"></a><span class="in">                nudge_y = 2) +</span></span>
<span id="cb77-322"><a href="#cb77-322" aria-hidden="true" tabindex="-1"></a><span class="in">  xlim(-5, 15) +</span></span>
<span id="cb77-323"><a href="#cb77-323" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(ylim = c(-5, 20)) +</span></span>
<span id="cb77-324"><a href="#cb77-324" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_mfx() +</span></span>
<span id="cb77-325"><a href="#cb77-325" aria-hidden="true" tabindex="-1"></a><span class="in">  transition_manual(rev(slope))</span></span>
<span id="cb77-326"><a href="#cb77-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-327"><a href="#cb77-327" aria-hidden="true" tabindex="-1"></a><span class="in">parabola_slope_anim &lt;- animate(</span></span>
<span id="cb77-328"><a href="#cb77-328" aria-hidden="true" tabindex="-1"></a><span class="in">  parabola_slope, nframes = nrow(lotsa_lines),</span></span>
<span id="cb77-329"><a href="#cb77-329" aria-hidden="true" tabindex="-1"></a><span class="in">  width = 2016, height = 1440, res = 300,</span></span>
<span id="cb77-330"><a href="#cb77-330" aria-hidden="true" tabindex="-1"></a><span class="in">  renderer = av_renderer("video/parabola_slope.mp4"))</span></span>
<span id="cb77-331"><a href="#cb77-331" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-332"><a href="#cb77-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-333"><a href="#cb77-333" aria-hidden="true" tabindex="-1"></a>&lt;video controls width="90%" style="display: block; margin: auto;"&gt;</span>
<span id="cb77-334"><a href="#cb77-334" aria-hidden="true" tabindex="-1"></a>  &lt;source src="video/parabola_slope.mp4" type="video/mp4"&gt;</span>
<span id="cb77-335"><a href="#cb77-335" aria-hidden="true" tabindex="-1"></a>&lt;/video&gt;</span>
<span id="cb77-336"><a href="#cb77-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-337"><a href="#cb77-337" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb77-338"><a href="#cb77-338" aria-hidden="true" tabindex="-1"></a>For the sake of space, I didn't include the code for this here, but you can see how I made this animation with <span class="co">[</span><span class="ot">gganimate</span><span class="co">](https://gganimate.com/)</span> at <span class="co">[</span><span class="ot">the R Markdown file for this post at GitHub</span><span class="co">](https://github.com/andrewheiss/ath-hugo/blob/main/content/blog/2022-05-20_marginalia/index.Rmarkdown#L317)</span>.</span>
<span id="cb77-339"><a href="#cb77-339" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb77-340"><a href="#cb77-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-341"><a href="#cb77-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-342"><a href="#cb77-342" aria-hidden="true" tabindex="-1"></a><span class="fu">### Marginal things in economics</span></span>
<span id="cb77-343"><a href="#cb77-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-344"><a href="#cb77-344" aria-hidden="true" tabindex="-1"></a>In the calculus world, the term "marginal" isn't used all that often. Instead they talk about derivatives. But in the end, all these marginal/derivative things are just slopes.</span>
<span id="cb77-345"><a href="#cb77-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-346"><a href="#cb77-346" aria-hidden="true" tabindex="-1"></a>Before looking at how this applies to the world of statistics, let's look at a quick example from economics, since economists also use the word "marginal" to refer to slopes. My first exposure to the word "marginal" meaning "changes in things" wasn't actually in the world of statistics, but in economics. I took my first microeconomics class as a first-year MPA student in 2010 (and hated it; ironically <span class="co">[</span><span class="ot">I teach it now</span><span class="co">](https://econs21.classes.andrewheiss.com/)</span> <span class="in">`r emoji::emoji("shrug")`</span>).</span>
<span id="cb77-347"><a href="#cb77-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-348"><a href="#cb77-348" aria-hidden="true" tabindex="-1"></a>One common question in microeconomics relates to how people maximize their happiness, or utility, under budget constraints (<span class="co">[</span><span class="ot">see here for an R-based example</span><span class="co">](https://www.andrewheiss.com/blog/2019/02/16/algebra-calculus-r-yacas/)</span>). Economists imagine that people have utility functions in their heads that take inputs and convert them to utility (or happiness points). For instance, let's pretend that the happiness/utility ($u$) you get from the number of cookies you eat ($x$) is defined like this:</span>
<span id="cb77-349"><a href="#cb77-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-350"><a href="#cb77-350" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb77-351"><a href="#cb77-351" aria-hidden="true" tabindex="-1"></a>u = -0.5x^2 + 5x</span>
<span id="cb77-352"><a href="#cb77-352" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb77-353"><a href="#cb77-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-354"><a href="#cb77-354" aria-hidden="true" tabindex="-1"></a>Here's what that looks like:</span>
<span id="cb77-355"><a href="#cb77-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-356"><a href="#cb77-356" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-cookies-utility}</span></span>
<span id="cb77-357"><a href="#cb77-357" aria-hidden="true" tabindex="-1"></a><span class="in"># u = -0.5x^2 + 5x</span></span>
<span id="cb77-358"><a href="#cb77-358" aria-hidden="true" tabindex="-1"></a><span class="in">u_cookies &lt;- function(x) (-0.5 * x^2) + (5 * x)</span></span>
<span id="cb77-359"><a href="#cb77-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-360"><a href="#cb77-360" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot() +</span></span>
<span id="cb77-361"><a href="#cb77-361" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0, linewidth = 0.5, color = "grey50") +</span></span>
<span id="cb77-362"><a href="#cb77-362" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_hline(yintercept = 0, linewidth = 0.5, color = "grey50") +</span></span>
<span id="cb77-363"><a href="#cb77-363" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_function(fun = u_cookies, linewidth = 1, color = clrs[2]) +</span></span>
<span id="cb77-364"><a href="#cb77-364" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(breaks = seq(0, 12, 2), limits = c(0, 12)) +</span></span>
<span id="cb77-365"><a href="#cb77-365" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Cookies", y = "Utility (happiness points)") +</span></span>
<span id="cb77-366"><a href="#cb77-366" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_mfx()</span></span>
<span id="cb77-367"><a href="#cb77-367" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-368"><a href="#cb77-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-369"><a href="#cb77-369" aria-hidden="true" tabindex="-1"></a>This parabola represents your *total* utility from cookies. Eat 1 cookie, get <span class="in">`r u_cookies(1)`</span> happiness points; eat 3 cookies, get <span class="in">`r u_cookies(3)`</span> points; eat 6, get <span class="in">`r u_cookies(6)`</span> points; and so on.</span>
<span id="cb77-370"><a href="#cb77-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-371"><a href="#cb77-371" aria-hidden="true" tabindex="-1"></a>The *marginal* utility, on the other hand, tells how how much more happiness you'd get from eating one more cookie. If you're currently eating 1, how many more happiness points would you get by moving to 2? If if you're eating 7, what would happen to your happiness if you moved to 8? We can figure this out by looking at the slope of the parabola, which will show us the instantaneous rate of change, or marginal utility, for any number of cookies.</span>
<span id="cb77-372"><a href="#cb77-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-373"><a href="#cb77-373" aria-hidden="true" tabindex="-1"></a>Power rule time! &lt;small&gt;(or type <span class="co">[</span><span class="ot">`derivative -0.5x^2 + 5x`</span><span class="co">](https://www.wolframalpha.com/input?i=derivative+-0.5x%5E2+%2B+5x)</span> at Wolfram Alpha)&lt;/small&gt;</span>
<span id="cb77-374"><a href="#cb77-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-375"><a href="#cb77-375" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb77-376"><a href="#cb77-376" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb77-377"><a href="#cb77-377" aria-hidden="true" tabindex="-1"></a>u &amp;= -0.5x^2 + 5x <span class="sc">\\</span></span>
<span id="cb77-378"><a href="#cb77-378" aria-hidden="true" tabindex="-1"></a>\frac{du}{dx} &amp;= (2 \times -0.5) x^1 + 5x^0 <span class="sc">\\</span></span>
<span id="cb77-379"><a href="#cb77-379" aria-hidden="true" tabindex="-1"></a>&amp;= -x + 5 </span>
<span id="cb77-380"><a href="#cb77-380" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb77-381"><a href="#cb77-381" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb77-382"><a href="#cb77-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-383"><a href="#cb77-383" aria-hidden="true" tabindex="-1"></a>Let's plot this really quick too:</span>
<span id="cb77-384"><a href="#cb77-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-385"><a href="#cb77-385" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-cookies-marginal-utility}</span></span>
<span id="cb77-386"><a href="#cb77-386" aria-hidden="true" tabindex="-1"></a><span class="in"># du/dx = -x + 5</span></span>
<span id="cb77-387"><a href="#cb77-387" aria-hidden="true" tabindex="-1"></a><span class="in">mu_cookies &lt;- function(x) -x + 5</span></span>
<span id="cb77-388"><a href="#cb77-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-389"><a href="#cb77-389" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot() +</span></span>
<span id="cb77-390"><a href="#cb77-390" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0, linewidth = 0.5, color = "grey50") +</span></span>
<span id="cb77-391"><a href="#cb77-391" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_hline(yintercept = 0, linewidth = 0.5, color = "grey50") +</span></span>
<span id="cb77-392"><a href="#cb77-392" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 5, linewidth = 0.5, </span></span>
<span id="cb77-393"><a href="#cb77-393" aria-hidden="true" tabindex="-1"></a><span class="in">             linetype = "21", color = clrs[3]) +</span></span>
<span id="cb77-394"><a href="#cb77-394" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_function(fun = mu_cookies, linewidth = 1, color = clrs[5]) +</span></span>
<span id="cb77-395"><a href="#cb77-395" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(breaks = seq(0, 12, 2), limits = c(0, 12)) +</span></span>
<span id="cb77-396"><a href="#cb77-396" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Cookies", y = "Marginal utility (additional happiness points)") +</span></span>
<span id="cb77-397"><a href="#cb77-397" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_mfx()</span></span>
<span id="cb77-398"><a href="#cb77-398" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-399"><a href="#cb77-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-400"><a href="#cb77-400" aria-hidden="true" tabindex="-1"></a>If you're currently eating 1 cookie and you grab another one, you'll gain <span class="in">`r mu_cookies(1)`</span> *extra* or *marginal* happiness points. If you're eating 6 and you grab another one, you'll actually *lose* some happiness—the marginal utility at 6 is <span class="in">`r mu_cookies(6)`</span>. If you're an economist who wants to maximize your happiness, you should eat the number of cookies where the extra happiness you'd get is 0, or where marginal utility is 0:</span>
<span id="cb77-401"><a href="#cb77-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-402"><a href="#cb77-402" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb77-403"><a href="#cb77-403" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb77-404"><a href="#cb77-404" aria-hidden="true" tabindex="-1"></a>\frac{du}{dx} &amp;= -x + 5 <span class="sc">\\</span></span>
<span id="cb77-405"><a href="#cb77-405" aria-hidden="true" tabindex="-1"></a>0 &amp;= -x + 5 <span class="sc">\\</span></span>
<span id="cb77-406"><a href="#cb77-406" aria-hidden="true" tabindex="-1"></a>x &amp;= 5</span>
<span id="cb77-407"><a href="#cb77-407" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb77-408"><a href="#cb77-408" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb77-409"><a href="#cb77-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-410"><a href="#cb77-410" aria-hidden="true" tabindex="-1"></a>Eat 5 cookies, maximize your happiness. Eat any more and you'll start getting disutility (like a stomachache). This is apparent in the marginal utility plot too. All the values of marginal utility to the left of 5 are positive; all the values to the right of 5 are negative. Economists call this *decreasing marginal utility*.</span>
<span id="cb77-411"><a href="#cb77-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-412"><a href="#cb77-412" aria-hidden="true" tabindex="-1"></a>This relationship between total utility and marginal utility is even more apparent if we look at both simultaneously (for fun I included the second derivative ($\frac{d^2u}{dx^2}$), or the slope of the first derivative, in the marginal utility panel):</span>
<span id="cb77-413"><a href="#cb77-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-414"><a href="#cb77-414" aria-hidden="true" tabindex="-1"></a><span class="in">```{r animate-cookies, include=FALSE, cache=TRUE, fig.width=7, fig.height=6}</span></span>
<span id="cb77-415"><a href="#cb77-415" aria-hidden="true" tabindex="-1"></a><span class="in">cookie_plot_data &lt;- tibble(cookies = seq(0, 12, 0.1)) |&gt; </span></span>
<span id="cb77-416"><a href="#cb77-416" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(utility = u_cookies(cookies),</span></span>
<span id="cb77-417"><a href="#cb77-417" aria-hidden="true" tabindex="-1"></a><span class="in">         marginal_utility = mu_cookies(cookies),</span></span>
<span id="cb77-418"><a href="#cb77-418" aria-hidden="true" tabindex="-1"></a><span class="in">         slope = mu_cookies(cookies),</span></span>
<span id="cb77-419"><a href="#cb77-419" aria-hidden="true" tabindex="-1"></a><span class="in">         intercept = find_intercept(cookies, utility, marginal_utility)) |&gt; </span></span>
<span id="cb77-420"><a href="#cb77-420" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(label_utility = glue("Utility (u): **{nice_number(round(utility, 2))}**", "&lt;br&gt;",</span></span>
<span id="cb77-421"><a href="#cb77-421" aria-hidden="true" tabindex="-1"></a><span class="in">                              "Slope (du/dx): **{nice_number(round(marginal_utility, 2))}**"),</span></span>
<span id="cb77-422"><a href="#cb77-422" aria-hidden="true" tabindex="-1"></a><span class="in">         label_mu = glue("Marginal utility (du/dx): **{nice_number(round(marginal_utility, 2))}**", "&lt;br&gt;",</span></span>
<span id="cb77-423"><a href="#cb77-423" aria-hidden="true" tabindex="-1"></a><span class="in">                         "Slope (d&lt;sup&gt;2&lt;/sup&gt;u/dx&lt;sup&gt;2&lt;/sup&gt;): **{nice_number(-1)}**")) |&gt; </span></span>
<span id="cb77-424"><a href="#cb77-424" aria-hidden="true" tabindex="-1"></a><span class="in">  pivot_longer(cols = c(utility, marginal_utility)) |&gt; </span></span>
<span id="cb77-425"><a href="#cb77-425" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(label = ifelse(name == "utility", label_utility, label_mu)) |&gt; </span></span>
<span id="cb77-426"><a href="#cb77-426" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(slope = ifelse(name == "utility", slope, -1),</span></span>
<span id="cb77-427"><a href="#cb77-427" aria-hidden="true" tabindex="-1"></a><span class="in">         intercept_real = ifelse(name == "utility", intercept, 5)) |&gt; </span></span>
<span id="cb77-428"><a href="#cb77-428" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(name_nice = case_when(</span></span>
<span id="cb77-429"><a href="#cb77-429" aria-hidden="true" tabindex="-1"></a><span class="in">    name == "utility" ~ "Utility (happiness points)",</span></span>
<span id="cb77-430"><a href="#cb77-430" aria-hidden="true" tabindex="-1"></a><span class="in">    name == "marginal_utility" ~ "Marginal utility (additional happiness points)"</span></span>
<span id="cb77-431"><a href="#cb77-431" aria-hidden="true" tabindex="-1"></a><span class="in">  )) |&gt; </span></span>
<span id="cb77-432"><a href="#cb77-432" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(name_nice = fct_inorder(name_nice))</span></span>
<span id="cb77-433"><a href="#cb77-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-434"><a href="#cb77-434" aria-hidden="true" tabindex="-1"></a><span class="in">cookie_plot_lines &lt;- cookie_plot_data |&gt; </span></span>
<span id="cb77-435"><a href="#cb77-435" aria-hidden="true" tabindex="-1"></a><span class="in">  select(x = cookies, value, name_nice)</span></span>
<span id="cb77-436"><a href="#cb77-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-437"><a href="#cb77-437" aria-hidden="true" tabindex="-1"></a><span class="in">cookie_labels &lt;- tribble(</span></span>
<span id="cb77-438"><a href="#cb77-438" aria-hidden="true" tabindex="-1"></a><span class="in">  ~name, ~x, ~value, ~equation,</span></span>
<span id="cb77-439"><a href="#cb77-439" aria-hidden="true" tabindex="-1"></a><span class="in">  "utility", 0.4, -2, "**U = −0.5x&lt;sup&gt;2&lt;/sup&gt; + 5x**",</span></span>
<span id="cb77-440"><a href="#cb77-440" aria-hidden="true" tabindex="-1"></a><span class="in">  "marginal_utility", 0.4, -1, "**MU (du/dx) = −x + 5**"</span></span>
<span id="cb77-441"><a href="#cb77-441" aria-hidden="true" tabindex="-1"></a><span class="in">) |&gt; </span></span>
<span id="cb77-442"><a href="#cb77-442" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(name_nice = factor(name, labels = rev(levels(cookie_plot_data$name_nice))))</span></span>
<span id="cb77-443"><a href="#cb77-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-444"><a href="#cb77-444" aria-hidden="true" tabindex="-1"></a><span class="in">cookie_mfx &lt;- ggplot(cookie_plot_data, aes(x = cookies, y = value)) +</span></span>
<span id="cb77-445"><a href="#cb77-445" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0, linewidth = 0.5, color = "grey50") +</span></span>
<span id="cb77-446"><a href="#cb77-446" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_hline(yintercept = 0, linewidth = 0.5, color = "grey50") +</span></span>
<span id="cb77-447"><a href="#cb77-447" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(data = cookie_plot_lines, aes(x = x, y = value, color = name_nice),</span></span>
<span id="cb77-448"><a href="#cb77-448" aria-hidden="true" tabindex="-1"></a><span class="in">            linewidth = 1) +</span></span>
<span id="cb77-449"><a href="#cb77-449" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_abline(aes(slope = slope, intercept = intercept_real),</span></span>
<span id="cb77-450"><a href="#cb77-450" aria-hidden="true" tabindex="-1"></a><span class="in">              linewidth = 0.25, color = clrs[4], linetype = "21") +</span></span>
<span id="cb77-451"><a href="#cb77-451" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(size = 3, color = clrs[4]) +</span></span>
<span id="cb77-452"><a href="#cb77-452" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_richtext(data = cookie_labels, aes(x = x, label = equation, color = name_nice), hjust = 0,</span></span>
<span id="cb77-453"><a href="#cb77-453" aria-hidden="true" tabindex="-1"></a><span class="in">                fill = NA, label.color = NA,</span></span>
<span id="cb77-454"><a href="#cb77-454" aria-hidden="true" tabindex="-1"></a><span class="in">                label.padding = grid::unit(rep(0, 4), "pt")) +</span></span>
<span id="cb77-455"><a href="#cb77-455" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_richtext(data = filter(cookie_plot_data, name == "utility"), </span></span>
<span id="cb77-456"><a href="#cb77-456" aria-hidden="true" tabindex="-1"></a><span class="in">                aes(label = label), nudge_y = 3) +</span></span>
<span id="cb77-457"><a href="#cb77-457" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_richtext(data = filter(cookie_plot_data, name == "marginal_utility"), </span></span>
<span id="cb77-458"><a href="#cb77-458" aria-hidden="true" tabindex="-1"></a><span class="in">                aes(label = label), nudge_y = 1.5) +</span></span>
<span id="cb77-459"><a href="#cb77-459" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_color_manual(values = c(clrs[2], clrs[5]), guide = "none") +</span></span>
<span id="cb77-460"><a href="#cb77-460" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_y_continuous(expand = expansion(add = 3)) +</span></span>
<span id="cb77-461"><a href="#cb77-461" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(xlim = c(-2, 14)) +</span></span>
<span id="cb77-462"><a href="#cb77-462" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(vars(name_nice), ncol = 1, scales = "free_y", strip.position = "left") +</span></span>
<span id="cb77-463"><a href="#cb77-463" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Cookies", y = NULL,</span></span>
<span id="cb77-464"><a href="#cb77-464" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "Utility and marginal utility from cookie consumption") +</span></span>
<span id="cb77-465"><a href="#cb77-465" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_mfx() +</span></span>
<span id="cb77-466"><a href="#cb77-466" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(plot.title = element_text(face = "bold"),</span></span>
<span id="cb77-467"><a href="#cb77-467" aria-hidden="true" tabindex="-1"></a><span class="in">        strip.background = element_blank(),</span></span>
<span id="cb77-468"><a href="#cb77-468" aria-hidden="true" tabindex="-1"></a><span class="in">        strip.placement = "outside") + </span></span>
<span id="cb77-469"><a href="#cb77-469" aria-hidden="true" tabindex="-1"></a><span class="in">  transition_manual(cookies)</span></span>
<span id="cb77-470"><a href="#cb77-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-471"><a href="#cb77-471" aria-hidden="true" tabindex="-1"></a><span class="in">cookie_mfx_anim &lt;- animate(</span></span>
<span id="cb77-472"><a href="#cb77-472" aria-hidden="true" tabindex="-1"></a><span class="in">  cookie_mfx, nframes = length(unique(cookie_plot_data$cookies)),</span></span>
<span id="cb77-473"><a href="#cb77-473" aria-hidden="true" tabindex="-1"></a><span class="in">  width = 2016, height = 1728, res = 300,</span></span>
<span id="cb77-474"><a href="#cb77-474" aria-hidden="true" tabindex="-1"></a><span class="in">  renderer = av_renderer("video/cookie_mfx.mp4"))</span></span>
<span id="cb77-475"><a href="#cb77-475" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-476"><a href="#cb77-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-477"><a href="#cb77-477" aria-hidden="true" tabindex="-1"></a>&lt;video controls width="90%" style="display: block; margin: auto;"&gt;</span>
<span id="cb77-478"><a href="#cb77-478" aria-hidden="true" tabindex="-1"></a>  &lt;source src="video/cookie_mfx.mp4" type="video/mp4"&gt;</span>
<span id="cb77-479"><a href="#cb77-479" aria-hidden="true" tabindex="-1"></a>&lt;/video&gt;</span>
<span id="cb77-480"><a href="#cb77-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-481"><a href="#cb77-481" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb77-482"><a href="#cb77-482" aria-hidden="true" tabindex="-1"></a>Again, I omitted the code for this here, but <span class="co">[</span><span class="ot">you can see it at GitHub</span><span class="co">](https://github.com/andrewheiss/ath-hugo/blob/main/content/blog/2022-05-20_marginalia/index.Rmarkdown#L397)</span>.</span>
<span id="cb77-483"><a href="#cb77-483" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb77-484"><a href="#cb77-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-485"><a href="#cb77-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-486"><a href="#cb77-486" aria-hidden="true" tabindex="-1"></a><span class="fu">## What about marginal things in statistics?</span></span>
<span id="cb77-487"><a href="#cb77-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-488"><a href="#cb77-488" aria-hidden="true" tabindex="-1"></a>Marginal utility, marginal revenue, marginal costs, and all those other marginal things are great for economists, but how does this "marginal" concept relate to statistics? Is it the same?</span>
<span id="cb77-489"><a href="#cb77-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-490"><a href="#cb77-490" aria-hidden="true" tabindex="-1"></a>Yep! Basically!</span>
<span id="cb77-491"><a href="#cb77-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-492"><a href="#cb77-492" aria-hidden="true" tabindex="-1"></a>At its core, regression modeling in statistics is all about fancy ways of finding averages and fancy ways of drawing lines. Even if you're doing non-regression things like t-tests, <span class="co">[</span><span class="ot">those are technically still just regression behind the scenes</span><span class="co">](https://lindeloev.github.io/tests-as-linear/)</span>. </span>
<span id="cb77-493"><a href="#cb77-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-494"><a href="#cb77-494" aria-hidden="true" tabindex="-1"></a>Statistics is all about lines, and lines have slopes, or derivatives. These slopes represent the marginal changes in an outcome. As you move an independent/explanatory variable $x$, what happens to the dependent/outcome variable $y$?</span>
<span id="cb77-495"><a href="#cb77-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-496"><a href="#cb77-496" aria-hidden="true" tabindex="-1"></a><span class="fu">### Regression, sliders, switches, and mixing boards</span></span>
<span id="cb77-497"><a href="#cb77-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-498"><a href="#cb77-498" aria-hidden="true" tabindex="-1"></a>Before getting into the mechanics of statistical marginal effects, it's helpful to review what exactly regression coefficients are doing in statistical models, especially when dealing with both continuous and categorical explanatory variables. </span>
<span id="cb77-499"><a href="#cb77-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-500"><a href="#cb77-500" aria-hidden="true" tabindex="-1"></a>When I teach statistics to my students, my favorite analogy for regression is to think of sliders and switches. Sliders represent continuous variables: as you move them up and down, something gradual happens to the resulting light. Switches represent categorical variables: as you turn them on and off, there are larger overall changes to the resulting light.</span>
<span id="cb77-501"><a href="#cb77-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-502"><a href="#cb77-502" aria-hidden="true" tabindex="-1"></a><span class="in">```{r slider-switch, echo=FALSE, out.width="100%", fig.align="center"}</span></span>
<span id="cb77-503"><a href="#cb77-503" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::include_graphics("images/slider-switch-annotated-80.jpg")</span></span>
<span id="cb77-504"><a href="#cb77-504" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-505"><a href="#cb77-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-506"><a href="#cb77-506" aria-hidden="true" tabindex="-1"></a>Let's look at some super tiny quick models to illustrate this, using data from <span class="co">[</span><span class="ot">**palmerpenguins**</span><span class="co">](https://allisonhorst.github.io/palmerpenguins/)</span>:</span>
<span id="cb77-507"><a href="#cb77-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-508"><a href="#cb77-508" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-slider-switch}</span></span>
<span id="cb77-509"><a href="#cb77-509" aria-hidden="true" tabindex="-1"></a><span class="in">penguins &lt;- penguins |&gt; drop_na()</span></span>
<span id="cb77-510"><a href="#cb77-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-511"><a href="#cb77-511" aria-hidden="true" tabindex="-1"></a><span class="in">model_slider &lt;- lm(body_mass_g ~ flipper_length_mm, data = penguins)</span></span>
<span id="cb77-512"><a href="#cb77-512" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_slider)</span></span>
<span id="cb77-513"><a href="#cb77-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-514"><a href="#cb77-514" aria-hidden="true" tabindex="-1"></a><span class="in">model_switch &lt;- lm(body_mass_g ~ species, data = penguins)</span></span>
<span id="cb77-515"><a href="#cb77-515" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_switch)</span></span>
<span id="cb77-516"><a href="#cb77-516" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-517"><a href="#cb77-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-518"><a href="#cb77-518" aria-hidden="true" tabindex="-1"></a>Disregard the intercept for now and just look at the coefficients for <span class="in">`flipper_length_mm`</span> and <span class="in">`species*`</span>. Flipper length is a continuous variable, so it's a slider—as flipper length increases by 1 mm, penguin body mass increases by 50 grams. Slide it up more and you'll see a bigger increase: if flipper length increases by 10 mm, body mass should increase by 500 grams. Slide it down for fun too! If flipper length decreases by 1 mm, body mass decreases by 50 grams. Imagine it like a sliding light switch.</span>
<span id="cb77-519"><a href="#cb77-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-520"><a href="#cb77-520" aria-hidden="true" tabindex="-1"></a>Species, on the other hand, is a switch. There are three possible values here: Adelie, Chinstrap, and Gentoo. The base case in the results here is Adelie since it comes fist alphabetically. The coefficients for <span class="in">`speciesChinstrap`</span> and <span class="in">`speciesGentoo`</span> aren't sliders—you can't talk about one-unit increases in Gentoo-ness or Chinstrap-ness. Instead, the values show what happens in relation to the average weight of Adelie penguins if you flip the Chinstrap or Gentoo switch. Chinstrap penguins are 29 grams heavier than Adelie penguins on average, while the chonky Gentoo penguins are 1.4 kg heavier than Adellie penguins. With these categorical coefficients, we're flipping a switch on and off: Adelie vs. Chinstrap and Adelie vs. Gentoo.</span>
<span id="cb77-521"><a href="#cb77-521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-522"><a href="#cb77-522" aria-hidden="true" tabindex="-1"></a>This slider and switch analogy holds when thinking about multiple regression too, though we need to think of lots of sliders and switches, like in an audio mixer board:</span>
<span id="cb77-523"><a href="#cb77-523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-524"><a href="#cb77-524" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mixer-board, echo=FALSE, out.width="100%", fig.align="center"}</span></span>
<span id="cb77-525"><a href="#cb77-525" aria-hidden="true" tabindex="-1"></a><span class="in"># Original via Wikimedia commons: https://commons.wikimedia.org/wiki/File:Yamaha_Audio_Mixer_Board.jpg</span></span>
<span id="cb77-526"><a href="#cb77-526" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::include_graphics("images/mixer-board-annotated-80.jpg")</span></span>
<span id="cb77-527"><a href="#cb77-527" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-528"><a href="#cb77-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-529"><a href="#cb77-529" aria-hidden="true" tabindex="-1"></a>With a mixer board, we can move many different sliders up and down and use different combinations of switches, all of which ultimately influence the audio output. </span>
<span id="cb77-530"><a href="#cb77-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-531"><a href="#cb77-531" aria-hidden="true" tabindex="-1"></a>Let's make a more complex mixer-board-esque regression model with multiple continuous (slider) and categorical (switch) explanatory variables:</span>
<span id="cb77-532"><a href="#cb77-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-533"><a href="#cb77-533" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-mixer}</span></span>
<span id="cb77-534"><a href="#cb77-534" aria-hidden="true" tabindex="-1"></a><span class="in">model_mixer &lt;- lm(body_mass_g ~ flipper_length_mm + bill_depth_mm + species + sex,</span></span>
<span id="cb77-535"><a href="#cb77-535" aria-hidden="true" tabindex="-1"></a><span class="in">                  data = penguins)</span></span>
<span id="cb77-536"><a href="#cb77-536" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_mixer)</span></span>
<span id="cb77-537"><a href="#cb77-537" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-538"><a href="#cb77-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-539"><a href="#cb77-539" aria-hidden="true" tabindex="-1"></a>Interpreting these coefficients is a little different now, since we're working with multiple moving parts. In regular stats class, you've probably learned to say something like "Holding all other variables constant, a 1 mm increase in flipper length is associated with a 17.5 gram increase in body mass, on average" (slider) or "Holding all other variables constant, Chinstrap penguins are 79 grams lighter than Adelie penguins, on average" (switch). </span>
<span id="cb77-540"><a href="#cb77-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-541"><a href="#cb77-541" aria-hidden="true" tabindex="-1"></a>This idea of "holding everything constant" though can be tricky to wrap your head around. Imagining this model like a mixer board can help, though. Pretend that you set the bill depth slider to some value (0, the average, whatever), you flip the Chinstrap and Gentoo switches off, you flip the male switch off, and then you slide only the flipper length switch up and down. You'd be looking at the marginal effect of flipper length for female Adelie penguins with an average (or 0 or whatever) length of bill depth. Stop moving the flipper length slider and start moving the bill depth slider and you'll see the marginal effect of bill depth for female Adelie penguins. Flip on the male switch and you'll see the marginal effect of bill depth for male Adelie penguins. Flip on the Gentoo switch and you'll see the marginal effect of bill depth for male Gentoo penguins. And so on.</span>
<span id="cb77-542"><a href="#cb77-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-543"><a href="#cb77-543" aria-hidden="true" tabindex="-1"></a>In calculus, if you have a model like <span class="in">`model_slider`</span> with just one continuous variable, the slope or derivative of that variable is the *total* derivative, or $\frac{dy}{dx}$. If you have a model like `model_mixer` with lots of other variables, the slope or derivative of any of the individual explanatory variables is the *partial* derivative, or $\frac{\partial y}{\partial x}$, where all other variables are held constant.</span>
<span id="cb77-544"><a href="#cb77-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-545"><a href="#cb77-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-546"><a href="#cb77-546" aria-hidden="true" tabindex="-1"></a><span class="fu">## What are marginal effects?</span></span>
<span id="cb77-547"><a href="#cb77-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-548"><a href="#cb77-548" aria-hidden="true" tabindex="-1"></a>Oops. When talking about these penguin regression results up there ↑ I used the term "marginal effect," but we haven't officially defined it in the statistics world yet. It's tricky to do that, though, because there are so many synonyms and near synonyms for the idea of a statistical effect, like marginal effect, marginal mean, marginal slope, conditional effect, conditional marginal effect, and so on.</span>
<span id="cb77-549"><a href="#cb77-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-550"><a href="#cb77-550" aria-hidden="true" tabindex="-1"></a>Formally defined, a marginal effect is a partial derivative from a regression equation. It's the instantaneous slope of one of the explanatory variables in a model, with all the other variables held constant. If we continue with the mixing board analogy, it represents what would happen to the resulting audio levels if we set all sliders and switches to some stationary level and we moved just one slider up a tiny amount.</span>
<span id="cb77-551"><a href="#cb77-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-552"><a href="#cb77-552" aria-hidden="true" tabindex="-1"></a>However, in practice, people use the term "marginal effect" to mean a lot more than just a partial derivative. For instance, in a randomized controlled trial, the difference in group means between the treatment and control groups is often called a marginal effect (and sometimes called a conditional effect, or even a conditional marginal effect). The term is also often used to talk about other group differences, like differences in penguin weights across species.</span>
<span id="cb77-553"><a href="#cb77-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-554"><a href="#cb77-554" aria-hidden="true" tabindex="-1"></a>In my mind, all these quasi-synonymous terms represent the same idea of a *statistical effect*, or what would happen to an outcome $y$ if one of the explanatory variables $x$ (be it continuous, categorical, or whatever) were different. The more precise terms like marginal effect, conditional effect, marginal mean, and so on, are variations on this theme. This is similar to how a square is a rectangle, but a rectangle is not a square—they're all super similar, but with minor subtle differences depending on the type of $x$ we're working with:</span>
<span id="cb77-555"><a href="#cb77-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-556"><a href="#cb77-556" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Marginal effect**: the statistical effect for continuous explanatory variables; the partial derivative of a variable in a regression model; the effect of a single slider</span>
<span id="cb77-557"><a href="#cb77-557" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Conditional effect** or **group contrast**: the statistical effect for categorical explanatory variables; the difference in means when a condition is on vs. when it is off; the effect of a single switch</span>
<span id="cb77-558"><a href="#cb77-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-559"><a href="#cb77-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-560"><a href="#cb77-560" aria-hidden="true" tabindex="-1"></a><span class="fu">## Slopes and marginal effects</span></span>
<span id="cb77-561"><a href="#cb77-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-562"><a href="#cb77-562" aria-hidden="true" tabindex="-1"></a>Let's look at true marginal effects, or the partial derivatives of continuous variables in a model (or sliders, in our slider/switch analogy). For the rest of this post, we'll move away from penguins and instead look at some cross-national data about the relationship between public sector corruption, the legal requirement to disclose donations to political campaigns, and respect for human rights, since that's all more related to what I do in my own research (I know nothing about penguins). We'll explore two different political science/policy questions:</span>
<span id="cb77-563"><a href="#cb77-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-564"><a href="#cb77-564" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>What is the relationship between a country's respect for civil liberties and its level of public sector corruption? Do countries that respect individual human rights tend to have less corruption too?</span>
<span id="cb77-565"><a href="#cb77-565" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Does a country's level of public sector corruption influence whether it has laws that require campaign finance disclosure? How does corruption influence a country's choice to be electorally transparent?</span>
<span id="cb77-566"><a href="#cb77-566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-567"><a href="#cb77-567" aria-hidden="true" tabindex="-1"></a>We'll use data from the <span class="co">[</span><span class="ot">World Bank</span><span class="co">](https://data.worldbank.org/)</span> and from the <span class="co">[</span><span class="ot">Varieties of Democracy project</span><span class="co">](https://www.v-dem.net/)</span> and just look at one year of data (2020) so we don't have to worry about panel data. There's <span class="co">[</span><span class="ot">a great R package for accessing V-Dem data</span><span class="co">](https://github.com/vdeminstitute/vdemdata)</span> without needing to download it manually from their website, but it's not on CRAN—it has to be installed from GitHub.</span>
<span id="cb77-568"><a href="#cb77-568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-569"><a href="#cb77-569" aria-hidden="true" tabindex="-1"></a>V-Dem and the World Bank have hundreds of different variables, but we only need a few, and we'll make a few adjustments to the ones we do need. Here's what we'll do:</span>
<span id="cb77-570"><a href="#cb77-570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-571"><a href="#cb77-571" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Main continuous outcome** and **continuous explanatory variable**: Public sector corruption index (<span class="in">`v2x_pubcorr`</span> in V-Dem). This is a 0–1 scale that measures…</span>
<span id="cb77-572"><a href="#cb77-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-573"><a href="#cb77-573" aria-hidden="true" tabindex="-1"></a><span class="at">  &gt; To what extent do public sector employees grant favors in exchange for bribes, kickbacks, or other material inducements, and how often do they steal, embezzle, or misappropriate public funds or other state resources for personal or family use?</span></span>
<span id="cb77-574"><a href="#cb77-574" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb77-575"><a href="#cb77-575" aria-hidden="true" tabindex="-1"></a>  Higher values represent *worse* corruption.</span>
<span id="cb77-576"><a href="#cb77-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-577"><a href="#cb77-577" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Main binary outcome**: Disclosure of campaign donations (<span class="in">`v2eldonate_ord`</span> in V-Dem). This is an ordinal variable with these possible values:</span>
<span id="cb77-578"><a href="#cb77-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-579"><a href="#cb77-579" aria-hidden="true" tabindex="-1"></a><span class="at">  &gt; - 0: No. There are no disclosure requirements.</span></span>
<span id="cb77-580"><a href="#cb77-580" aria-hidden="true" tabindex="-1"></a><span class="at">  &gt; - 1: Not really. There are some, possibly partial, disclosure requirements in place but they are not observed or enforced most of the time.</span></span>
<span id="cb77-581"><a href="#cb77-581" aria-hidden="true" tabindex="-1"></a><span class="at">  &gt; - 2: Ambiguous. There are disclosure requirements in place, but it is unclear to what extent they are observed or enforced.</span></span>
<span id="cb77-582"><a href="#cb77-582" aria-hidden="true" tabindex="-1"></a><span class="at">  &gt; - 3: Mostly. The disclosure requirements may not be fully comprehensive (some donations not covered), but most existing arrangements are observed and enforced.</span></span>
<span id="cb77-583"><a href="#cb77-583" aria-hidden="true" tabindex="-1"></a><span class="at">  &gt; - 4: Yes. There are comprehensive requirements and they are observed and enforced almost all the time.</span></span>
<span id="cb77-584"><a href="#cb77-584" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb77-585"><a href="#cb77-585" aria-hidden="true" tabindex="-1"></a>  For the sake of simplicity, we'll collapse this into a binary variable. Countries have disclosure laws if they score a 3 or a 4; they don't if they score a 0, 1, or 2.</span>
<span id="cb77-586"><a href="#cb77-586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-587"><a href="#cb77-587" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Other continuous explanatory variables**: </span>
<span id="cb77-588"><a href="#cb77-588" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-589"><a href="#cb77-589" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Electoral democracy index, or polyarchy (<span class="in">`v2x_polyarchy`</span> in V-Dem): a continuous variable measured from 0–1 with higher values representing greater achievement of democratic ideals</span>
<span id="cb77-590"><a href="#cb77-590" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Civil liberties index (<span class="in">`v2x_civlib`</span> in V-Dem): a continuous variable measured from 0–1 with higher values representing better respect for human rights and civil liberties</span>
<span id="cb77-591"><a href="#cb77-591" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Log GDP per capita (<span class="co">[</span><span class="ot">`NY.GDP.PCAP.KD`</span><span class="co">](https://data.worldbank.org/indicator/NY.GDP.PCAP.KD)</span> at the World Bank): GDP per capita in constant 2015 USD</span>
<span id="cb77-592"><a href="#cb77-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-593"><a href="#cb77-593" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Region**: V-Dem provides multiple regional variables with varying specificity (19 different regions, 10 different regions, and 6 different regions). We'll use the 6-region version (<span class="in">`e_regionpol_6C`</span>) for simplicity here:</span>
<span id="cb77-594"><a href="#cb77-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-595"><a href="#cb77-595" aria-hidden="true" tabindex="-1"></a><span class="at">  &gt; - 1: Eastern Europe and Central Asia (including Mongolia)</span></span>
<span id="cb77-596"><a href="#cb77-596" aria-hidden="true" tabindex="-1"></a><span class="at">  &gt; - 2: Latin America and the Caribbean</span></span>
<span id="cb77-597"><a href="#cb77-597" aria-hidden="true" tabindex="-1"></a><span class="at">  &gt; - 3: The Middle East and North Africa (including Israel and Turkey, excluding Cyprus)</span></span>
<span id="cb77-598"><a href="#cb77-598" aria-hidden="true" tabindex="-1"></a><span class="at">  &gt; - 4: Sub-Saharan Africa</span></span>
<span id="cb77-599"><a href="#cb77-599" aria-hidden="true" tabindex="-1"></a><span class="at">  &gt; - 5: Western Europe and North America (including Cyprus, Australia and New Zealand)</span></span>
<span id="cb77-600"><a href="#cb77-600" aria-hidden="true" tabindex="-1"></a><span class="at">  &gt; - 6: Asia and Pacific (excluding Australia and New Zealand)</span></span>
<span id="cb77-601"><a href="#cb77-601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-602"><a href="#cb77-602" aria-hidden="true" tabindex="-1"></a><span class="in">```{r get-clean-data, cache=TRUE, R.options = list(width=90), eval=FALSE}</span></span>
<span id="cb77-603"><a href="#cb77-603" aria-hidden="true" tabindex="-1"></a><span class="in"># Get data from the World Bank's API</span></span>
<span id="cb77-604"><a href="#cb77-604" aria-hidden="true" tabindex="-1"></a><span class="in">wdi_raw &lt;- WDI(country = "all", </span></span>
<span id="cb77-605"><a href="#cb77-605" aria-hidden="true" tabindex="-1"></a><span class="in">               indicator = c(population = "SP.POP.TOTL",</span></span>
<span id="cb77-606"><a href="#cb77-606" aria-hidden="true" tabindex="-1"></a><span class="in">                             gdp_percapita = "NY.GDP.PCAP.KD"), </span></span>
<span id="cb77-607"><a href="#cb77-607" aria-hidden="true" tabindex="-1"></a><span class="in">               start = 2000, end = 2020, extra = TRUE)</span></span>
<span id="cb77-608"><a href="#cb77-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-609"><a href="#cb77-609" aria-hidden="true" tabindex="-1"></a><span class="in"># Clean up the World Bank data</span></span>
<span id="cb77-610"><a href="#cb77-610" aria-hidden="true" tabindex="-1"></a><span class="in">wdi_2020 &lt;- wdi_raw |&gt; </span></span>
<span id="cb77-611"><a href="#cb77-611" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(region != "Aggregates") |&gt; </span></span>
<span id="cb77-612"><a href="#cb77-612" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(year == 2020) |&gt; </span></span>
<span id="cb77-613"><a href="#cb77-613" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(log_gdp_percapita = log(gdp_percapita)) |&gt; </span></span>
<span id="cb77-614"><a href="#cb77-614" aria-hidden="true" tabindex="-1"></a><span class="in">  select(-region, -status, -year, -country, -lastupdated, -lending)</span></span>
<span id="cb77-615"><a href="#cb77-615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-616"><a href="#cb77-616" aria-hidden="true" tabindex="-1"></a><span class="in"># Get data from V-Dem and clean it up</span></span>
<span id="cb77-617"><a href="#cb77-617" aria-hidden="true" tabindex="-1"></a><span class="in">vdem_2020 &lt;- vdem %&gt;% </span></span>
<span id="cb77-618"><a href="#cb77-618" aria-hidden="true" tabindex="-1"></a><span class="in">  select(country_name, country_text_id, year, region = e_regionpol_6C,</span></span>
<span id="cb77-619"><a href="#cb77-619" aria-hidden="true" tabindex="-1"></a><span class="in">         disclose_donations_ord = v2eldonate_ord, </span></span>
<span id="cb77-620"><a href="#cb77-620" aria-hidden="true" tabindex="-1"></a><span class="in">         public_sector_corruption = v2x_pubcorr,</span></span>
<span id="cb77-621"><a href="#cb77-621" aria-hidden="true" tabindex="-1"></a><span class="in">         polyarchy = v2x_polyarchy, civil_liberties = v2x_civlib) %&gt;% </span></span>
<span id="cb77-622"><a href="#cb77-622" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(year == 2020) %&gt;% </span></span>
<span id="cb77-623"><a href="#cb77-623" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(disclose_donations = disclose_donations_ord &gt;= 3,</span></span>
<span id="cb77-624"><a href="#cb77-624" aria-hidden="true" tabindex="-1"></a><span class="in">         disclose_donations = ifelse(is.na(disclose_donations), FALSE, disclose_donations)) %&gt;% </span></span>
<span id="cb77-625"><a href="#cb77-625" aria-hidden="true" tabindex="-1"></a><span class="in">  # Scale these up so it's easier to talk about 1-unit changes</span></span>
<span id="cb77-626"><a href="#cb77-626" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(across(c(public_sector_corruption, polyarchy, civil_liberties), ~ . * 100)) |&gt; </span></span>
<span id="cb77-627"><a href="#cb77-627" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(region = factor(region, </span></span>
<span id="cb77-628"><a href="#cb77-628" aria-hidden="true" tabindex="-1"></a><span class="in">                         labels = c("Eastern Europe and Central Asia",</span></span>
<span id="cb77-629"><a href="#cb77-629" aria-hidden="true" tabindex="-1"></a><span class="in">                                    "Latin America and the Caribbean",</span></span>
<span id="cb77-630"><a href="#cb77-630" aria-hidden="true" tabindex="-1"></a><span class="in">                                    "Middle East and North Africa",</span></span>
<span id="cb77-631"><a href="#cb77-631" aria-hidden="true" tabindex="-1"></a><span class="in">                                    "Sub-Saharan Africa",</span></span>
<span id="cb77-632"><a href="#cb77-632" aria-hidden="true" tabindex="-1"></a><span class="in">                                    "Western Europe and North America",</span></span>
<span id="cb77-633"><a href="#cb77-633" aria-hidden="true" tabindex="-1"></a><span class="in">                                    "Asia and Pacific")))</span></span>
<span id="cb77-634"><a href="#cb77-634" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-635"><a href="#cb77-635" aria-hidden="true" tabindex="-1"></a><span class="in"># Combine World Bank and V-Dem data into a single dataset</span></span>
<span id="cb77-636"><a href="#cb77-636" aria-hidden="true" tabindex="-1"></a><span class="in">corruption &lt;- vdem_2020 |&gt; </span></span>
<span id="cb77-637"><a href="#cb77-637" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(wdi_2020, by = c("country_text_id" = "iso3c")) |&gt; </span></span>
<span id="cb77-638"><a href="#cb77-638" aria-hidden="true" tabindex="-1"></a><span class="in">  drop_na(gdp_percapita)</span></span>
<span id="cb77-639"><a href="#cb77-639" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-640"><a href="#cb77-640" aria-hidden="true" tabindex="-1"></a><span class="in">glimpse(corruption)</span></span>
<span id="cb77-641"><a href="#cb77-641" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-642"><a href="#cb77-642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-643"><a href="#cb77-643" aria-hidden="true" tabindex="-1"></a>::: {.callout-warning}</span>
<span id="cb77-644"><a href="#cb77-644" aria-hidden="true" tabindex="-1"></a><span class="fu">### Static data!</span></span>
<span id="cb77-645"><a href="#cb77-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-646"><a href="#cb77-646" aria-hidden="true" tabindex="-1"></a>When I wrote this in May 2022, I based it on the data that both the World Bank and V-Dem had available at that time. In the months since then, they've revised their data. If you run all this code now (I'm writing this in February 2024), you'll get slightly different results because of these revisions. For instance, when this ran in 2022, the World Bank reported that Mexico's log GDP per capita in 2020 was 9.10; when running this in 2024, it reports that it was 9.13. This is a minor difference, but all these minor differences change the results slightly. The code in this chunk above still runs just fine, you'll just get slightly different data, and thus slightly different results.</span>
<span id="cb77-647"><a href="#cb77-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-648"><a href="#cb77-648" aria-hidden="true" tabindex="-1"></a>So, in the interest of reproducibility, you should download and load this <span class="in">`.RData`</span> file that contains <span class="in">`wdi_raw`</span>, <span class="in">`wdi_2020`</span>, <span class="in">`vdem_2020`</span>, and <span class="in">`corruption`</span> from when I wrote this in 2022.</span>
<span id="cb77-649"><a href="#cb77-649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-650"><a href="#cb77-650" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">`data_2022.RData`</span><span class="co">](data_2022.Rdata)</span></span>
<span id="cb77-651"><a href="#cb77-651" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb77-652"><a href="#cb77-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-653"><a href="#cb77-653" aria-hidden="true" tabindex="-1"></a><span class="in">```{r load-clean-data, R.options = list(width=90)}</span></span>
<span id="cb77-654"><a href="#cb77-654" aria-hidden="true" tabindex="-1"></a><span class="in">load("data_2022.RData")</span></span>
<span id="cb77-655"><a href="#cb77-655" aria-hidden="true" tabindex="-1"></a><span class="in">glimpse(corruption)</span></span>
<span id="cb77-656"><a href="#cb77-656" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-657"><a href="#cb77-657" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-658"><a href="#cb77-658" aria-hidden="true" tabindex="-1"></a>Let's start off by looking at the effect of civil liberties on public sector corruption by using a really simple model with one explanatory variable:</span>
<span id="cb77-659"><a href="#cb77-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-660"><a href="#cb77-660" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-civlib-corruption}</span></span>
<span id="cb77-661"><a href="#cb77-661" aria-hidden="true" tabindex="-1"></a><span class="in">plot_corruption &lt;- corruption |&gt; </span></span>
<span id="cb77-662"><a href="#cb77-662" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(highlight = civil_liberties == min(civil_liberties) | </span></span>
<span id="cb77-663"><a href="#cb77-663" aria-hidden="true" tabindex="-1"></a><span class="in">           civil_liberties == max(civil_liberties))</span></span>
<span id="cb77-664"><a href="#cb77-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-665"><a href="#cb77-665" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(plot_corruption, aes(x = civil_liberties, y = public_sector_corruption)) +</span></span>
<span id="cb77-666"><a href="#cb77-666" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(aes(color = highlight)) +</span></span>
<span id="cb77-667"><a href="#cb77-667" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_smooth(method = "lm", formula = y ~ x, linewidth = 1, color = clrs[1]) +</span></span>
<span id="cb77-668"><a href="#cb77-668" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_label_repel(data = filter(plot_corruption, highlight == TRUE), </span></span>
<span id="cb77-669"><a href="#cb77-669" aria-hidden="true" tabindex="-1"></a><span class="in">                   aes(label = country_name), seed = 1234) +</span></span>
<span id="cb77-670"><a href="#cb77-670" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_color_manual(values = c("grey30", clrs[3]), guide = "none") +</span></span>
<span id="cb77-671"><a href="#cb77-671" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Civil liberties index", y = "Public sector corruption index") +</span></span>
<span id="cb77-672"><a href="#cb77-672" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_mfx()</span></span>
<span id="cb77-673"><a href="#cb77-673" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-674"><a href="#cb77-674" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-675"><a href="#cb77-675" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-simple-civlib-corruption}</span></span>
<span id="cb77-676"><a href="#cb77-676" aria-hidden="true" tabindex="-1"></a><span class="in">model_simple &lt;- lm(public_sector_corruption ~ civil_liberties,</span></span>
<span id="cb77-677"><a href="#cb77-677" aria-hidden="true" tabindex="-1"></a><span class="in">                   data = corruption)</span></span>
<span id="cb77-678"><a href="#cb77-678" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_simple)</span></span>
<span id="cb77-679"><a href="#cb77-679" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-680"><a href="#cb77-680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-681"><a href="#cb77-681" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-model-simple-civlib-corruption, include=FALSE}</span></span>
<span id="cb77-682"><a href="#cb77-682" aria-hidden="true" tabindex="-1"></a><span class="in">m_simple &lt;- tidy(model_simple) |&gt; </span></span>
<span id="cb77-683"><a href="#cb77-683" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(term = janitor::make_clean_names(term),</span></span>
<span id="cb77-684"><a href="#cb77-684" aria-hidden="true" tabindex="-1"></a><span class="in">         est = nice_number(estimate)) |&gt; </span></span>
<span id="cb77-685"><a href="#cb77-685" aria-hidden="true" tabindex="-1"></a><span class="in">  split(~ term)</span></span>
<span id="cb77-686"><a href="#cb77-686" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-687"><a href="#cb77-687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-688"><a href="#cb77-688" aria-hidden="true" tabindex="-1"></a>We have a nice fitted OLS line here with uncertainty around it. What's the marginal effect of civil liberties on public sector corruption? What kind of calculus and math do we need to do to find it? Not much, happily!</span>
<span id="cb77-689"><a href="#cb77-689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-690"><a href="#cb77-690" aria-hidden="true" tabindex="-1"></a>In general, we have a regression formula here that looks a lot like the $y = mx + b$ stuff we were using before, only now the intercept $b$ is $\beta_0$ and the slope $m$ is $\beta_1$. If we use the power rule to find the first derivative of this equation, we'll see that the slope of the entire line is $\beta_1$:</span>
<span id="cb77-691"><a href="#cb77-691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-692"><a href="#cb77-692" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb77-693"><a href="#cb77-693" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb77-694"><a href="#cb77-694" aria-hidden="true" tabindex="-1"></a>\operatorname{E}<span class="co">[</span><span class="ot">y \mid x</span><span class="co">]</span> &amp;= \beta_0 + \beta_1 x <span class="sc">\\</span><span class="co">[</span><span class="ot">4pt</span><span class="co">]</span></span>
<span id="cb77-695"><a href="#cb77-695" aria-hidden="true" tabindex="-1"></a>\frac{\partial \operatorname{E}<span class="co">[</span><span class="ot">y \mid x</span><span class="co">]</span>}{\partial x} &amp;= \beta_1</span>
<span id="cb77-696"><a href="#cb77-696" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb77-697"><a href="#cb77-697" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb77-698"><a href="#cb77-698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-699"><a href="#cb77-699" aria-hidden="true" tabindex="-1"></a>If we add actual coefficients from the model into the formula we can see that the $\beta_1$ coefficient for <span class="in">`civil_liberties`</span> (<span class="in">`r m_simple$civil_liberties$est`</span>) is indeed the marginal effect:</span>
<span id="cb77-700"><a href="#cb77-700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-701"><a href="#cb77-701" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb77-702"><a href="#cb77-702" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb77-703"><a href="#cb77-703" aria-hidden="true" tabindex="-1"></a>\operatorname{E}<span class="co">[</span><span class="ot">\text{Corruption} \mid \text{Civil liberties}</span><span class="co">]</span> &amp;= <span class="in">`r m_simple$intercept$est`</span> + (<span class="in">`r m_simple$civil_liberties$est`</span> \times \text{Civil liberties}) <span class="sc">\\</span><span class="co">[</span><span class="ot">6pt</span><span class="co">]</span></span>
<span id="cb77-704"><a href="#cb77-704" aria-hidden="true" tabindex="-1"></a>\frac{\partial \operatorname{E}<span class="co">[</span><span class="ot">\text{Corruption} \mid \text{Civil liberties}</span><span class="co">]</span>}{\partial\ \text{Civil liberties}} &amp;= <span class="in">`r m_simple$civil_liberties$est`</span></span>
<span id="cb77-705"><a href="#cb77-705" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb77-706"><a href="#cb77-706" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb77-707"><a href="#cb77-707" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-708"><a href="#cb77-708" aria-hidden="true" tabindex="-1"></a>The $\beta_1$ coefficient by itself is thus enough to tell us what the effect of moving civil liberties around is—it is *the* marginal effect of civil liberties on public sector corruption. Slide the civil liberties index up by 1 point and public sector corruption will be <span class="in">`r m_simple$civil_liberties$est`</span> points lower, on average.</span>
<span id="cb77-709"><a href="#cb77-709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-710"><a href="#cb77-710" aria-hidden="true" tabindex="-1"></a>Importantly, this is only the case because we're using simple linear regression without any curvy parts. If your model is completely linear without any polynomials or logs or interaction terms or doesn't use curvy regression families like logistic or beta regression, you can use individual coefficients as marginal effects.</span>
<span id="cb77-711"><a href="#cb77-711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-712"><a href="#cb77-712" aria-hidden="true" tabindex="-1"></a>Let's see what happens when we add curves. We'll add a polynomial term, including both <span class="in">`civil_liberties`</span> and <span class="in">`civil_liberties^2`</span> so that we can capture the parabolic shape of the relationship between civil liberties and corruption:</span>
<span id="cb77-713"><a href="#cb77-713" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-714"><a href="#cb77-714" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-civlib-corruption-sq}</span></span>
<span id="cb77-715"><a href="#cb77-715" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(plot_corruption, aes(x = civil_liberties, y = public_sector_corruption)) +</span></span>
<span id="cb77-716"><a href="#cb77-716" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(aes(color = highlight)) +</span></span>
<span id="cb77-717"><a href="#cb77-717" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_smooth(method = "lm", formula = y ~ x + I(x^2), linewidth = 1, color = clrs[2]) +</span></span>
<span id="cb77-718"><a href="#cb77-718" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_label_repel(data = filter(plot_corruption, highlight == TRUE), </span></span>
<span id="cb77-719"><a href="#cb77-719" aria-hidden="true" tabindex="-1"></a><span class="in">                   aes(label = country_name), seed = 1234) +</span></span>
<span id="cb77-720"><a href="#cb77-720" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_color_manual(values = c("grey30", clrs[3]), guide = "none") +</span></span>
<span id="cb77-721"><a href="#cb77-721" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Civil liberties index", y = "Public sector corruption index") +</span></span>
<span id="cb77-722"><a href="#cb77-722" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_mfx()</span></span>
<span id="cb77-723"><a href="#cb77-723" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-724"><a href="#cb77-724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-725"><a href="#cb77-725" aria-hidden="true" tabindex="-1"></a>This is most likely not a great model fit in real life, but using the quadratic term here makes a neat curved line, so we'll go with it for the sake of the example. But don't, like, make any policy decisions based on this line.</span>
<span id="cb77-726"><a href="#cb77-726" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-727"><a href="#cb77-727" aria-hidden="true" tabindex="-1"></a>When working with polynomials in regression, the coefficients appear and work a little differently:</span>
<span id="cb77-728"><a href="#cb77-728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-729"><a href="#cb77-729" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-sq-civlib-corruption}</span></span>
<span id="cb77-730"><a href="#cb77-730" aria-hidden="true" tabindex="-1"></a><span class="in">model_sq &lt;- lm(public_sector_corruption ~ civil_liberties + I(civil_liberties^2),</span></span>
<span id="cb77-731"><a href="#cb77-731" aria-hidden="true" tabindex="-1"></a><span class="in">               data = corruption)</span></span>
<span id="cb77-732"><a href="#cb77-732" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_sq)</span></span>
<span id="cb77-733"><a href="#cb77-733" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-734"><a href="#cb77-734" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-735"><a href="#cb77-735" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-model-sq-civlib-corruption, include=FALSE}</span></span>
<span id="cb77-736"><a href="#cb77-736" aria-hidden="true" tabindex="-1"></a><span class="in">m_sq &lt;- tidy(model_sq) |&gt; </span></span>
<span id="cb77-737"><a href="#cb77-737" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(term = janitor::make_clean_names(term),</span></span>
<span id="cb77-738"><a href="#cb77-738" aria-hidden="true" tabindex="-1"></a><span class="in">         est = nice_number(estimate)) |&gt; </span></span>
<span id="cb77-739"><a href="#cb77-739" aria-hidden="true" tabindex="-1"></a><span class="in">  split(~ term)</span></span>
<span id="cb77-740"><a href="#cb77-740" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-741"><a href="#cb77-741" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-742"><a href="#cb77-742" aria-hidden="true" tabindex="-1"></a>We now have two coefficients for civil liberties: $\beta_1$ and $\beta_2$. Importantly, we cannot use just one of these to talk about the marginal effect of changing civil liberties. A one-point increase in the civil liberties index is *not* associated with a <span class="in">`r m_sq$civil_liberties$est`</span> increase or a <span class="in">`r m_sq$i_civil_liberties_2$est`</span> decrease in corruption. The slope of the fitted line now comprises multiple moving parts: (1) the coefficient for the non-squared term, (2) the coefficient for the squared term, and (3) some value of civil liberties, since the slope isn't the same across the whole line. The math shows us why and how. </span>
<span id="cb77-743"><a href="#cb77-743" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-744"><a href="#cb77-744" aria-hidden="true" tabindex="-1"></a>We have terms for both $x$ and $x^2$ in our model. To find the derivative, we can use the power rule to get rid of the $x$ term ($\beta x^1 \rightarrow (1 \times \beta x^0) \rightarrow \beta$), but the $x$ in the $x^2$ term doesn't disappear ($\beta x^2 \rightarrow (2 \times \beta \times x^1) \rightarrow 2 \beta x$). The slope of the line thus depends on both the βs and the $x$:</span>
<span id="cb77-745"><a href="#cb77-745" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-746"><a href="#cb77-746" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb77-747"><a href="#cb77-747" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb77-748"><a href="#cb77-748" aria-hidden="true" tabindex="-1"></a>\operatorname{E}<span class="co">[</span><span class="ot">y \mid x</span><span class="co">]</span> &amp;= \beta_0 + \beta_1 x + \beta_2 x^2 <span class="sc">\\</span><span class="co">[</span><span class="ot">4pt</span><span class="co">]</span></span>
<span id="cb77-749"><a href="#cb77-749" aria-hidden="true" tabindex="-1"></a>\frac{\partial \operatorname{E}<span class="co">[</span><span class="ot">y \mid x</span><span class="co">]</span>}{\partial x} &amp;= \beta_1 + 2 \beta_2 x</span>
<span id="cb77-750"><a href="#cb77-750" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb77-751"><a href="#cb77-751" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb77-752"><a href="#cb77-752" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-753"><a href="#cb77-753" aria-hidden="true" tabindex="-1"></a>Here's what that looks like with the results of our civil liberties and corruption model:</span>
<span id="cb77-754"><a href="#cb77-754" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-755"><a href="#cb77-755" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb77-756"><a href="#cb77-756" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb77-757"><a href="#cb77-757" aria-hidden="true" tabindex="-1"></a>\operatorname{E}<span class="co">[</span><span class="ot">\text{Corruption} \mid \text{Civil liberties}</span><span class="co">]</span> &amp;= <span class="in">`r m_sq$intercept$est`</span> + (<span class="in">`r m_sq$civil_liberties$est`</span> \times \text{Civil liberties}) + (<span class="in">`r m_sq$i_civil_liberties_2$est`</span> \times \text{Civil liberties}^2) <span class="sc">\\</span><span class="co">[</span><span class="ot">6pt</span><span class="co">]</span></span>
<span id="cb77-758"><a href="#cb77-758" aria-hidden="true" tabindex="-1"></a>\frac{\partial \operatorname{E}<span class="co">[</span><span class="ot">\text{Corruption} \mid \text{Civil liberties}</span><span class="co">]</span>}{\partial\ \text{Civil liberties}} &amp;= <span class="in">`r m_sq$civil_liberties$est`</span> + (2\times <span class="in">`r m_sq$i_civil_liberties_2$est`</span> \times \text{Civil liberties})</span>
<span id="cb77-759"><a href="#cb77-759" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb77-760"><a href="#cb77-760" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb77-761"><a href="#cb77-761" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-762"><a href="#cb77-762" aria-hidden="true" tabindex="-1"></a>Because the actual slope depends on the value of civil liberties, we need to plug in different values to get the instantaneous slopes at each value. Let's plug in 25, 55, and 80, for fun:</span>
<span id="cb77-763"><a href="#cb77-763" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-764"><a href="#cb77-764" aria-hidden="true" tabindex="-1"></a><span class="in">```{r civ-lib-slopes}</span></span>
<span id="cb77-765"><a href="#cb77-765" aria-hidden="true" tabindex="-1"></a><span class="in"># Extract the two civil_liberties coefficients</span></span>
<span id="cb77-766"><a href="#cb77-766" aria-hidden="true" tabindex="-1"></a><span class="in">civ_lib1 &lt;- tidy(model_sq) |&gt; filter(term == "civil_liberties") |&gt; pull(estimate)</span></span>
<span id="cb77-767"><a href="#cb77-767" aria-hidden="true" tabindex="-1"></a><span class="in">civ_lib2 &lt;- tidy(model_sq) |&gt; filter(term == "I(civil_liberties^2)") |&gt; pull(estimate)</span></span>
<span id="cb77-768"><a href="#cb77-768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-769"><a href="#cb77-769" aria-hidden="true" tabindex="-1"></a><span class="in"># Make a little function to do the math</span></span>
<span id="cb77-770"><a href="#cb77-770" aria-hidden="true" tabindex="-1"></a><span class="in">civ_lib_slope &lt;- function(x) civ_lib1 + (2 * civ_lib2 * x)</span></span>
<span id="cb77-771"><a href="#cb77-771" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-772"><a href="#cb77-772" aria-hidden="true" tabindex="-1"></a><span class="in">civ_lib_slope(c(25, 55, 80))</span></span>
<span id="cb77-773"><a href="#cb77-773" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-774"><a href="#cb77-774" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-775"><a href="#cb77-775" aria-hidden="true" tabindex="-1"></a>We have three different slopes now: <span class="in">`r knitr::combine_words(nice_number(civ_lib_slope(c(25, 55, 80))))`</span> for civil liberties of <span class="in">`r knitr::combine_words(c(25, 55, 80))`</span>, respectively. We can plot these as tangent lines:</span>
<span id="cb77-776"><a href="#cb77-776" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-777"><a href="#cb77-777" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-civlib-slopes, fig.width=9, fig.height=6, out.width="100%"}</span></span>
<span id="cb77-778"><a href="#cb77-778" aria-hidden="true" tabindex="-1"></a><span class="in">tangents &lt;- model_sq |&gt; </span></span>
<span id="cb77-779"><a href="#cb77-779" aria-hidden="true" tabindex="-1"></a><span class="in">  augment(newdata = tibble(civil_liberties = c(25, 55, 80))) |&gt; </span></span>
<span id="cb77-780"><a href="#cb77-780" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(slope = civ_lib_slope(civil_liberties),</span></span>
<span id="cb77-781"><a href="#cb77-781" aria-hidden="true" tabindex="-1"></a><span class="in">         intercept = find_intercept(civil_liberties, .fitted, slope)) |&gt; </span></span>
<span id="cb77-782"><a href="#cb77-782" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(nice_label = glue("Civil liberties: {civil_liberties}&lt;br&gt;",</span></span>
<span id="cb77-783"><a href="#cb77-783" aria-hidden="true" tabindex="-1"></a><span class="in">                           "Fitted corruption: {nice_number(.fitted)}&lt;br&gt;",</span></span>
<span id="cb77-784"><a href="#cb77-784" aria-hidden="true" tabindex="-1"></a><span class="in">                           "Slope: **{nice_number(slope)}**"))</span></span>
<span id="cb77-785"><a href="#cb77-785" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-786"><a href="#cb77-786" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(corruption, aes(x = civil_liberties, y = public_sector_corruption)) +</span></span>
<span id="cb77-787"><a href="#cb77-787" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(color = "grey30") +</span></span>
<span id="cb77-788"><a href="#cb77-788" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_smooth(method = "lm", formula = y ~ x + I(x^2), linewidth = 1, se = FALSE, color = clrs[4]) +</span></span>
<span id="cb77-789"><a href="#cb77-789" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_abline(data = tangents, aes(slope = slope, intercept = intercept), </span></span>
<span id="cb77-790"><a href="#cb77-790" aria-hidden="true" tabindex="-1"></a><span class="in">              linewidth = 0.5, color = clrs[2], linetype = "21") +</span></span>
<span id="cb77-791"><a href="#cb77-791" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(data = tangents, aes(x = civil_liberties, y = .fitted), size = 4, shape = 18, color = clrs[2]) +</span></span>
<span id="cb77-792"><a href="#cb77-792" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_richtext(data = tangents, aes(x = civil_liberties, y = .fitted, label = nice_label), nudge_y = -7) +</span></span>
<span id="cb77-793"><a href="#cb77-793" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Civil liberties index", y = "Public sector corruption index") +</span></span>
<span id="cb77-794"><a href="#cb77-794" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_mfx()</span></span>
<span id="cb77-795"><a href="#cb77-795" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-796"><a href="#cb77-796" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-797"><a href="#cb77-797" aria-hidden="true" tabindex="-1"></a>Doing the calculus by hand here is tedious though, especially once we start working with even more covariates in a model. Plus we don't have any information about uncertainty, like standard errors and confidence intervals. There are official mathy ways to figure those out by hand, but who even wants to do that. Fortunately there are two different packages that let us find marginal slopes automatically, with important differences in their procedures, which we'll explore in detail below. But before looking at their differences, let's first see how they work.</span>
<span id="cb77-798"><a href="#cb77-798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-799"><a href="#cb77-799" aria-hidden="true" tabindex="-1"></a>First, we can use the <span class="in">`slopes()`</span> function from **marginaleffects** to see the slope (the <span class="in">`estimate`</span> column here) at various levels of civil liberties. We'll look at the mechanics of this function in more detail in the next section—for now we'll just plug in our three values of civil liberties and see what happens. We'll also set the <span class="in">`eps`</span> argument: behind the scenes, <span class="in">`slopes()`</span> doesn't actually do the by-hand calculus of piecing together first derivatives—instead, it calculates the fitted value of corruption when civil liberties is a value, calculates the fitted value of corruption when civil liberties is that same value plus a tiny bit more, and then subtracts them. The <span class="in">`eps`</span> value controls that tiny amount. In this case, it'll calculate the predictions for <span class="in">`civil_liberties = 25`</span> and <span class="in">`civil_liberties = 25.001`</span> and then find the slope of the tiny tangent line between those two points. It's a neat little mathy trick to avoid calculus.</span>
<span id="cb77-800"><a href="#cb77-800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-801"><a href="#cb77-801" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-mfx-sq-mfx}</span></span>
<span id="cb77-802"><a href="#cb77-802" aria-hidden="true" tabindex="-1"></a><span class="in">model_sq |&gt; </span></span>
<span id="cb77-803"><a href="#cb77-803" aria-hidden="true" tabindex="-1"></a><span class="in">  slopes(newdata = datagrid(civil_liberties = c(25, 55, 80)),</span></span>
<span id="cb77-804"><a href="#cb77-804" aria-hidden="true" tabindex="-1"></a><span class="in">         eps = 0.001)</span></span>
<span id="cb77-805"><a href="#cb77-805" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-806"><a href="#cb77-806" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-807"><a href="#cb77-807" aria-hidden="true" tabindex="-1"></a>Second, we can use the <span class="in">`emtrends()`</span> function from **emmeans** to also see the slope (the <span class="in">`civil_liberties.trend`</span> column here) at various levels of civil liberties. The syntax is different (note the <span class="in">`delta.var`</span> argument instead of <span class="in">`eps`</span>), but the results are essentially the same:</span>
<span id="cb77-808"><a href="#cb77-808" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-809"><a href="#cb77-809" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-mfx-sq-emtrends}</span></span>
<span id="cb77-810"><a href="#cb77-810" aria-hidden="true" tabindex="-1"></a><span class="in">model_sq |&gt; </span></span>
<span id="cb77-811"><a href="#cb77-811" aria-hidden="true" tabindex="-1"></a><span class="in">  emtrends(~ civil_liberties, var = "civil_liberties",</span></span>
<span id="cb77-812"><a href="#cb77-812" aria-hidden="true" tabindex="-1"></a><span class="in">           at = list(civil_liberties = c(25, 55, 80)),</span></span>
<span id="cb77-813"><a href="#cb77-813" aria-hidden="true" tabindex="-1"></a><span class="in">           delta.var = 0.001)</span></span>
<span id="cb77-814"><a href="#cb77-814" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-815"><a href="#cb77-815" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-816"><a href="#cb77-816" aria-hidden="true" tabindex="-1"></a>Both <span class="in">`slopes()`</span> and <span class="in">`emtrends()`</span> also helpfully provide uncertainty, with standard errors and confidence intervals, with a lot of super fancy math behind the scenes to make it all work. <span class="in">`slopes()`</span> provides p-values automatically; if you want p-values from <span class="in">`emtrends()`</span> you need to wrap it in <span class="in">`test()`</span>:</span>
<span id="cb77-817"><a href="#cb77-817" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-818"><a href="#cb77-818" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-mf-sq-emtrends-pvalue}</span></span>
<span id="cb77-819"><a href="#cb77-819" aria-hidden="true" tabindex="-1"></a><span class="in">model_sq |&gt; </span></span>
<span id="cb77-820"><a href="#cb77-820" aria-hidden="true" tabindex="-1"></a><span class="in">  emtrends(~ civil_liberties, var = "civil_liberties",</span></span>
<span id="cb77-821"><a href="#cb77-821" aria-hidden="true" tabindex="-1"></a><span class="in">           at = list(civil_liberties = c(25, 55, 80)),</span></span>
<span id="cb77-822"><a href="#cb77-822" aria-hidden="true" tabindex="-1"></a><span class="in">           delta.var = 0.001) |&gt; </span></span>
<span id="cb77-823"><a href="#cb77-823" aria-hidden="true" tabindex="-1"></a><span class="in">  test()</span></span>
<span id="cb77-824"><a href="#cb77-824" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-825"><a href="#cb77-825" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-826"><a href="#cb77-826" aria-hidden="true" tabindex="-1"></a>Another neat thing about these more automatic functions is that we can use them to create a marginal effects plot, placing the value of the slope on the y-axis rather than the fitted value of public corruption. **marginaleffects** helpfully has <span class="in">`plot_slopes()`</span> that will plot the values of <span class="in">`estimate`</span> across the whole range of civil liberties automatically. Alternatively, if we want full control over the plot, we can use either <span class="in">`slopes()`</span> or <span class="in">`emtrends()`</span> to create a data frame that we can plot ourselves with ggplot:</span>
<span id="cb77-827"><a href="#cb77-827" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-828"><a href="#cb77-828" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-cmes, fig.width=12, fig.height=5, out.width="100%"}</span></span>
<span id="cb77-829"><a href="#cb77-829" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-inset-right</span></span>
<span id="cb77-830"><a href="#cb77-830" aria-hidden="true" tabindex="-1"></a><span class="in"># Automatic plot from marginaleffects::plot_slopes()</span></span>
<span id="cb77-831"><a href="#cb77-831" aria-hidden="true" tabindex="-1"></a><span class="in">mfx_marginaleffects_auto &lt;- plot_slopes(model_sq, </span></span>
<span id="cb77-832"><a href="#cb77-832" aria-hidden="true" tabindex="-1"></a><span class="in">                                        variables = "civil_liberties", </span></span>
<span id="cb77-833"><a href="#cb77-833" aria-hidden="true" tabindex="-1"></a><span class="in">                                        condition = "civil_liberties") +</span></span>
<span id="cb77-834"><a href="#cb77-834" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Civil liberties", y = "Marginal effect of civil liberties on public sector corruption",</span></span>
<span id="cb77-835"><a href="#cb77-835" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "Created automatically with marginaleffects::plot_slopes()") +</span></span>
<span id="cb77-836"><a href="#cb77-836" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_mfx()</span></span>
<span id="cb77-837"><a href="#cb77-837" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-838"><a href="#cb77-838" aria-hidden="true" tabindex="-1"></a><span class="in"># Piece all the geoms together manually with results from marginaleffects::slopes()</span></span>
<span id="cb77-839"><a href="#cb77-839" aria-hidden="true" tabindex="-1"></a><span class="in">mfx_marginaleffects &lt;- model_sq |&gt; </span></span>
<span id="cb77-840"><a href="#cb77-840" aria-hidden="true" tabindex="-1"></a><span class="in">  slopes(newdata = datagrid(civil_liberties = </span></span>
<span id="cb77-841"><a href="#cb77-841" aria-hidden="true" tabindex="-1"></a><span class="in">                              seq(min(corruption$civil_liberties), </span></span>
<span id="cb77-842"><a href="#cb77-842" aria-hidden="true" tabindex="-1"></a><span class="in">                                 max(corruption$civil_liberties), 0.1)),</span></span>
<span id="cb77-843"><a href="#cb77-843" aria-hidden="true" tabindex="-1"></a><span class="in">                  eps = 0.001) |&gt; </span></span>
<span id="cb77-844"><a href="#cb77-844" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = civil_liberties, y = estimate)) +</span></span>
<span id="cb77-845"><a href="#cb77-845" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 42, color = clrs[3], linewidth = 0.5, linetype = "24") +</span></span>
<span id="cb77-846"><a href="#cb77-846" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = 0.1, fill = clrs[1]) +</span></span>
<span id="cb77-847"><a href="#cb77-847" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(linewidth = 1, color = clrs[1]) +</span></span>
<span id="cb77-848"><a href="#cb77-848" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Civil liberties", y = "Marginal effect of civil liberties on public sector corruption",</span></span>
<span id="cb77-849"><a href="#cb77-849" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "Calculated with slopes()") +</span></span>
<span id="cb77-850"><a href="#cb77-850" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_mfx()</span></span>
<span id="cb77-851"><a href="#cb77-851" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-852"><a href="#cb77-852" aria-hidden="true" tabindex="-1"></a><span class="in"># Piece all the geoms together manually with results from emmeans::emtrends()</span></span>
<span id="cb77-853"><a href="#cb77-853" aria-hidden="true" tabindex="-1"></a><span class="in">mfx_emtrends &lt;- model_sq |&gt; </span></span>
<span id="cb77-854"><a href="#cb77-854" aria-hidden="true" tabindex="-1"></a><span class="in">  emtrends(~ civil_liberties, var = "civil_liberties",</span></span>
<span id="cb77-855"><a href="#cb77-855" aria-hidden="true" tabindex="-1"></a><span class="in">           at = list(civil_liberties = </span></span>
<span id="cb77-856"><a href="#cb77-856" aria-hidden="true" tabindex="-1"></a><span class="in">                       seq(min(corruption$civil_liberties), </span></span>
<span id="cb77-857"><a href="#cb77-857" aria-hidden="true" tabindex="-1"></a><span class="in">                           max(corruption$civil_liberties), 0.1)),</span></span>
<span id="cb77-858"><a href="#cb77-858" aria-hidden="true" tabindex="-1"></a><span class="in">           delta.var = 0.001) |&gt; </span></span>
<span id="cb77-859"><a href="#cb77-859" aria-hidden="true" tabindex="-1"></a><span class="in">  as_tibble() |&gt; </span></span>
<span id="cb77-860"><a href="#cb77-860" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = civil_liberties, y = civil_liberties.trend)) +</span></span>
<span id="cb77-861"><a href="#cb77-861" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 42, color = clrs[3], linewidth = 0.5, linetype = "24") +</span></span>
<span id="cb77-862"><a href="#cb77-862" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_ribbon(aes(ymin = lower.CL, ymax = upper.CL), alpha = 0.1, fill = clrs[1]) +</span></span>
<span id="cb77-863"><a href="#cb77-863" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(linewidth = 1, color = clrs[1]) +</span></span>
<span id="cb77-864"><a href="#cb77-864" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Civil liberties", y = "Marginal effect of civil liberties on public sector corruption",</span></span>
<span id="cb77-865"><a href="#cb77-865" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "Calculated with emtrends()") +</span></span>
<span id="cb77-866"><a href="#cb77-866" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_mfx()</span></span>
<span id="cb77-867"><a href="#cb77-867" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-868"><a href="#cb77-868" aria-hidden="true" tabindex="-1"></a><span class="in">mfx_marginaleffects_auto | mfx_marginaleffects | mfx_emtrends</span></span>
<span id="cb77-869"><a href="#cb77-869" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-870"><a href="#cb77-870" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-871"><a href="#cb77-871" aria-hidden="true" tabindex="-1"></a>This kind of plot is useful since it shows precisely how the effect changes across civil liberties. The slope is 0 at around 42, positive before that, and negative after that, which—assuming this is a good model and who even knows if that's true—implies that countries with low levels of respect for civil liberties will see an increase in corruption as civil liberties increases, while countries with high respect for civil liberties will see a decrease in corruption as they improve their respect for human rights.</span>
<span id="cb77-872"><a href="#cb77-872" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-873"><a href="#cb77-873" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-874"><a href="#cb77-874" aria-hidden="true" tabindex="-1"></a><span class="fu">## **marginaleffects**'s and **emmeans**'s philosophies of averaging</span></span>
<span id="cb77-875"><a href="#cb77-875" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-876"><a href="#cb77-876" aria-hidden="true" tabindex="-1"></a>Finding marginal effects for lines like $y = 2x - 1$ and $y = -0.5x^2 + 5x + 5$ with calculus is fairly easy since there's no uncertainty involved. Finding marginal effects for fitted lines from a regression model, on the other hand, is more complicated because uncertainty abounds. The estimated partial slopes all have standard errors and measures of statistical significance attached to them. The slope of civil liberties at 55 is <span class="in">`r nice_number(civ_lib_slope(55))`</span>, but it could be higher and it could be lower. Could it even possibly be zero? Maybe! (But most likely not; the p-value that we saw above is less than 0.001, so there's only a sliver of a chance of seeing a slope like <span class="in">`r nice_number(civ_lib_slope(55))`</span> in a world where it is actually 0ish).</span>
<span id="cb77-877"><a href="#cb77-877" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-878"><a href="#cb77-878" aria-hidden="true" tabindex="-1"></a>We deal with the uncertainty of these marginal effects by taking averages, which is why we talk about "average marginal effects" when interpreting these effects. So far, <span class="in">`marginaleffects::slopes()`</span> and <span class="in">`emmeans::emtrends()`</span> have given identical results. But behind the scenes, these packages take two different approaches to calculating these marginal averages. The difference is very subtle, but incredibly important.</span>
<span id="cb77-879"><a href="#cb77-879" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-880"><a href="#cb77-880" aria-hidden="true" tabindex="-1"></a>Let's look at how these two packages calculate their marginal effects by default.</span>
<span id="cb77-881"><a href="#cb77-881" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-882"><a href="#cb77-882" aria-hidden="true" tabindex="-1"></a><span class="fu">### Average marginal effects (the default in **marginaleffects**)</span></span>
<span id="cb77-883"><a href="#cb77-883" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-884"><a href="#cb77-884" aria-hidden="true" tabindex="-1"></a>By default, **marginaleffects** calculates the *average marginal effect* (AME) for its partial slopes/coefficients. To do this, it follows a specific process of averaging:</span>
<span id="cb77-885"><a href="#cb77-885" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-886"><a href="#cb77-886" aria-hidden="true" tabindex="-1"></a><span class="in">```{r flow-ame, echo=FALSE, out.width="100%", fig.align="center"}</span></span>
<span id="cb77-887"><a href="#cb77-887" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-inset-right</span></span>
<span id="cb77-888"><a href="#cb77-888" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::include_graphics("images/flow-ame@3x.png")</span></span>
<span id="cb77-889"><a href="#cb77-889" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-890"><a href="#cb77-890" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-891"><a href="#cb77-891" aria-hidden="true" tabindex="-1"></a>It first plugs each row of the original dataset into the model and generates predictions for each row. It then uses fancy math (i.e. adding 0.001) to calculate the instantaneous slope for each row and stores each individual slope in the <span class="in">`estimate`</span> column here:</span>
<span id="cb77-892"><a href="#cb77-892" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-893"><a href="#cb77-893" aria-hidden="true" tabindex="-1"></a><span class="in">```{r ame-mfx-1}</span></span>
<span id="cb77-894"><a href="#cb77-894" aria-hidden="true" tabindex="-1"></a><span class="in">mfx_sq &lt;- slopes(model_sq)</span></span>
<span id="cb77-895"><a href="#cb77-895" aria-hidden="true" tabindex="-1"></a><span class="in">head(mfx_sq)</span></span>
<span id="cb77-896"><a href="#cb77-896" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-897"><a href="#cb77-897" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-898"><a href="#cb77-898" aria-hidden="true" tabindex="-1"></a>It finally calculates the average of the <span class="in">`estimate`</span> column. We can do that ourselves:</span>
<span id="cb77-899"><a href="#cb77-899" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-900"><a href="#cb77-900" aria-hidden="true" tabindex="-1"></a><span class="in">```{r ame-mfx-2}</span></span>
<span id="cb77-901"><a href="#cb77-901" aria-hidden="true" tabindex="-1"></a><span class="in">mfx_sq |&gt; </span></span>
<span id="cb77-902"><a href="#cb77-902" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(term) |&gt; </span></span>
<span id="cb77-903"><a href="#cb77-903" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(avg_slope = mean(estimate))</span></span>
<span id="cb77-904"><a href="#cb77-904" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-905"><a href="#cb77-905" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-906"><a href="#cb77-906" aria-hidden="true" tabindex="-1"></a>Or we can feed a <span class="in">`marginaleffects`</span> object to <span class="in">`summary()`</span>, which will calculate the correct uncertainty statistics, like the standard errors:</span>
<span id="cb77-907"><a href="#cb77-907" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-908"><a href="#cb77-908" aria-hidden="true" tabindex="-1"></a><span class="in">```{r ame-mfx-3}</span></span>
<span id="cb77-909"><a href="#cb77-909" aria-hidden="true" tabindex="-1"></a><span class="in">summary(mfx_sq)</span></span>
<span id="cb77-910"><a href="#cb77-910" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-911"><a href="#cb77-911" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-912"><a href="#cb77-912" aria-hidden="true" tabindex="-1"></a>Alternatively, we can use <span class="in">`avg_slopes()`</span> instead of <span class="in">`slopes(...) |&gt; summary()`</span> to do the averaging automatically:</span>
<span id="cb77-913"><a href="#cb77-913" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-914"><a href="#cb77-914" aria-hidden="true" tabindex="-1"></a><span class="in">```{r ame-mfx-avg-slopes}</span></span>
<span id="cb77-915"><a href="#cb77-915" aria-hidden="true" tabindex="-1"></a><span class="in">avg_slopes(model_sq)</span></span>
<span id="cb77-916"><a href="#cb77-916" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-917"><a href="#cb77-917" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-918"><a href="#cb77-918" aria-hidden="true" tabindex="-1"></a>Note that the average marginal effect here isn't the same as what we saw before when we set civil liberties to different values. In this case, the effect is averaged across the whole range of civil liberties—one single grand average mean. It shows that in general, the overall average slope of the fitted line is <span class="in">`r nice_number(mean(mfx_sq$estimate))`</span>. </span>
<span id="cb77-919"><a href="#cb77-919" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-920"><a href="#cb77-920" aria-hidden="true" tabindex="-1"></a>Don't worry about the number too much here—we're just exploring the underlying process of calculating this average marginal effect. In general, as the image shows above, for average marginal effects, we take the full original data, feed it to the model, generate fitted values for each original row, and then collapse the results into a single value.</span>
<span id="cb77-921"><a href="#cb77-921" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-922"><a href="#cb77-922" aria-hidden="true" tabindex="-1"></a>The main advantage of doing this is that each <span class="in">`estimate`</span> prediction uses values that exist in the actual data. The first <span class="in">`estimate`</span> slope estimate is for Mexico in 2020 and is based on Mexico's actual value of <span class="in">`civil_liberties`</span> (and any other covariates if we had included any others in the model). It's thus more reflective of reality.</span>
<span id="cb77-923"><a href="#cb77-923" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-924"><a href="#cb77-924" aria-hidden="true" tabindex="-1"></a><span class="fu">### Marginal effects at the mean (the default in **emmeans**)</span></span>
<span id="cb77-925"><a href="#cb77-925" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-926"><a href="#cb77-926" aria-hidden="true" tabindex="-1"></a>A different approach for this averaging is to calculate the *marginal effect at the mean*, or MEM. This is what the **emmeans** package does by default. (The **emmeans** package actually calculates two average things: "marginal effects at the means" (MEM), or average *slopes* using `emtrends()`, and "estimated marginal means" (EMM), or average *predictions* using `emmeans()`. It's named after the second of these, hence the name ***emm*eans**). </span>
<span id="cb77-927"><a href="#cb77-927" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-928"><a href="#cb77-928" aria-hidden="true" tabindex="-1"></a>To do this, we follow a slightly different process of averaging:</span>
<span id="cb77-929"><a href="#cb77-929" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-930"><a href="#cb77-930" aria-hidden="true" tabindex="-1"></a><span class="in">```{r flow-mem, echo=FALSE, out.width="100%", fig.align="center"}</span></span>
<span id="cb77-931"><a href="#cb77-931" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-inset-right</span></span>
<span id="cb77-932"><a href="#cb77-932" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::include_graphics("images/flow-mem@3x.png")</span></span>
<span id="cb77-933"><a href="#cb77-933" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-934"><a href="#cb77-934" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-935"><a href="#cb77-935" aria-hidden="true" tabindex="-1"></a>First, we calculate the average value of each of the covariates in the model (in this case, just <span class="in">`civil_liberties`</span>):</span>
<span id="cb77-936"><a href="#cb77-936" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-937"><a href="#cb77-937" aria-hidden="true" tabindex="-1"></a><span class="in">```{r find-avg-civ-lib}</span></span>
<span id="cb77-938"><a href="#cb77-938" aria-hidden="true" tabindex="-1"></a><span class="in">avg_civ_lib &lt;- mean(corruption$civil_liberties)</span></span>
<span id="cb77-939"><a href="#cb77-939" aria-hidden="true" tabindex="-1"></a><span class="in">avg_civ_lib</span></span>
<span id="cb77-940"><a href="#cb77-940" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-941"><a href="#cb77-941" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-942"><a href="#cb77-942" aria-hidden="true" tabindex="-1"></a>We then plug that average (and that average plus 0.001) into the model and generate fitted values:</span>
<span id="cb77-943"><a href="#cb77-943" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-944"><a href="#cb77-944" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mem-mfx-1}</span></span>
<span id="cb77-945"><a href="#cb77-945" aria-hidden="true" tabindex="-1"></a><span class="in">civ_lib_fitted &lt;- model_sq |&gt; </span></span>
<span id="cb77-946"><a href="#cb77-946" aria-hidden="true" tabindex="-1"></a><span class="in">  augment(newdata = tibble(civil_liberties = c(avg_civ_lib, avg_civ_lib + 0.001)))</span></span>
<span id="cb77-947"><a href="#cb77-947" aria-hidden="true" tabindex="-1"></a><span class="in">civ_lib_fitted</span></span>
<span id="cb77-948"><a href="#cb77-948" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-949"><a href="#cb77-949" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-950"><a href="#cb77-950" aria-hidden="true" tabindex="-1"></a>Because of rounding (and because the values are so tiny), this looks like the two rows are identical, but they're not—the second one really is 0.001 more than <span class="in">`r avg_civ_lib`</span>.</span>
<span id="cb77-951"><a href="#cb77-951" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-952"><a href="#cb77-952" aria-hidden="true" tabindex="-1"></a>We then subtract the two and divide by 0.001 to get the final marginal effect at the mean:</span>
<span id="cb77-953"><a href="#cb77-953" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-954"><a href="#cb77-954" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mem-mfx-2}</span></span>
<span id="cb77-955"><a href="#cb77-955" aria-hidden="true" tabindex="-1"></a><span class="in">(civ_lib_fitted[2,2] - civ_lib_fitted[1,2]) / 0.001</span></span>
<span id="cb77-956"><a href="#cb77-956" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-957"><a href="#cb77-957" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-958"><a href="#cb77-958" aria-hidden="true" tabindex="-1"></a>That doesn't give us any standard errors or uncertainty or anything, so it's better to use <span class="in">`emtrends()`</span> or <span class="in">`slopes()`</span>. <span class="in">`emtrends()`</span> calculates this MEM automatically:</span>
<span id="cb77-959"><a href="#cb77-959" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-960"><a href="#cb77-960" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mem-mfx-3}</span></span>
<span id="cb77-961"><a href="#cb77-961" aria-hidden="true" tabindex="-1"></a><span class="in">model_sq |&gt; </span></span>
<span id="cb77-962"><a href="#cb77-962" aria-hidden="true" tabindex="-1"></a><span class="in">  emtrends(~ civil_liberties, var = "civil_liberties", delta.var = 0.001)</span></span>
<span id="cb77-963"><a href="#cb77-963" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-964"><a href="#cb77-964" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-965"><a href="#cb77-965" aria-hidden="true" tabindex="-1"></a>We can also calculate the MEM with <span class="in">`avg_slopes()`</span> if we include the <span class="in">`newdata = "mean"`</span> argument, which will automatically shrink the original data down into average or typical values:</span>
<span id="cb77-966"><a href="#cb77-966" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-967"><a href="#cb77-967" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mem-mfx-4}</span></span>
<span id="cb77-968"><a href="#cb77-968" aria-hidden="true" tabindex="-1"></a><span class="in">model_sq |&gt; </span></span>
<span id="cb77-969"><a href="#cb77-969" aria-hidden="true" tabindex="-1"></a><span class="in">  avg_slopes(newdata = "mean")</span></span>
<span id="cb77-970"><a href="#cb77-970" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-971"><a href="#cb77-971" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-972"><a href="#cb77-972" aria-hidden="true" tabindex="-1"></a>The disadvantage of this approach is that no actual country has a <span class="in">`civil_liberties`</span> score of exactly <span class="in">`r avg_civ_lib`</span>. If we had other covariates in the model, no country would have exactly the average of every variable. The marginal effect is thus calculated based on a hypothetical country that might not possibly exist in real life.</span>
<span id="cb77-973"><a href="#cb77-973" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-974"><a href="#cb77-974" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-975"><a href="#cb77-975" aria-hidden="true" tabindex="-1"></a><span class="fu">## Where this subtle difference really matters</span></span>
<span id="cb77-976"><a href="#cb77-976" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-977"><a href="#cb77-977" aria-hidden="true" tabindex="-1"></a>So far, comparing average marginal effects (AME) with marginal effects at the mean (MEM) hasn't been that useful, since both <span class="in">`slopes()`</span> and <span class="in">`emtrends()`</span> provided nearly identical results with our simple model with civil liberties squared. That's because nothing that strange is going on in the model—there are no additional explanatory variables, no interactions or logs, and we're using OLS and not anything fancy like logistic regression or beta regression.</span>
<span id="cb77-978"><a href="#cb77-978" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-979"><a href="#cb77-979" aria-hidden="true" tabindex="-1"></a>Things change once we leave the land of OLS.</span>
<span id="cb77-980"><a href="#cb77-980" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-981"><a href="#cb77-981" aria-hidden="true" tabindex="-1"></a>Let's make a new model that predicts if a country has campaign finance disclosure laws based on public sector corruption. Disclosure laws is a binary outcome, so we'll use logistic regression to constrain the fitted values and predictions to between 0 and 1. </span>
<span id="cb77-982"><a href="#cb77-982" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-983"><a href="#cb77-983" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-logit-corruption-donations, message=FALSE, fig.width=7, fig.height=4}</span></span>
<span id="cb77-984"><a href="#cb77-984" aria-hidden="true" tabindex="-1"></a><span class="in">plot_corruption_logit &lt;- corruption |&gt; </span></span>
<span id="cb77-985"><a href="#cb77-985" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(highlight = public_sector_corruption == min(public_sector_corruption) | </span></span>
<span id="cb77-986"><a href="#cb77-986" aria-hidden="true" tabindex="-1"></a><span class="in">           public_sector_corruption == max(public_sector_corruption))</span></span>
<span id="cb77-987"><a href="#cb77-987" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb77-988"><a href="#cb77-988" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(plot_corruption_logit, </span></span>
<span id="cb77-989"><a href="#cb77-989" aria-hidden="true" tabindex="-1"></a><span class="in">       aes(x = public_sector_corruption, y = as.numeric(disclose_donations))) +</span></span>
<span id="cb77-990"><a href="#cb77-990" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(aes(color = highlight)) +</span></span>
<span id="cb77-991"><a href="#cb77-991" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_smooth(method = "glm", method.args = list(family = binomial(link = "logit")),</span></span>
<span id="cb77-992"><a href="#cb77-992" aria-hidden="true" tabindex="-1"></a><span class="in">              color = clrs[2]) +</span></span>
<span id="cb77-993"><a href="#cb77-993" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_label(data = slice(filter(plot_corruption_logit, highlight == TRUE), 1), </span></span>
<span id="cb77-994"><a href="#cb77-994" aria-hidden="true" tabindex="-1"></a><span class="in">             aes(label = country_name), nudge_y = 0.06, hjust = 1) +</span></span>
<span id="cb77-995"><a href="#cb77-995" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_label(data = slice(filter(plot_corruption_logit, highlight == TRUE), 2), </span></span>
<span id="cb77-996"><a href="#cb77-996" aria-hidden="true" tabindex="-1"></a><span class="in">             aes(label = country_name), nudge_y = -0.06, hjust = 0) +</span></span>
<span id="cb77-997"><a href="#cb77-997" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_color_manual(values = c("grey30", clrs[3]), guide = "none") +</span></span>
<span id="cb77-998"><a href="#cb77-998" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Public sector corruption", </span></span>
<span id="cb77-999"><a href="#cb77-999" aria-hidden="true" tabindex="-1"></a><span class="in">       y = "Presence or absence of\ncampaign finance disclosure laws\n(Line shows predicted probability)") +</span></span>
<span id="cb77-1000"><a href="#cb77-1000" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_mfx()</span></span>
<span id="cb77-1001"><a href="#cb77-1001" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1002"><a href="#cb77-1002" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1003"><a href="#cb77-1003" aria-hidden="true" tabindex="-1"></a>Even without any squared terms, we're already in non-linear land. We can build a model and explore this relationship:</span>
<span id="cb77-1004"><a href="#cb77-1004" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1005"><a href="#cb77-1005" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-logit-donations-corruption}</span></span>
<span id="cb77-1006"><a href="#cb77-1006" aria-hidden="true" tabindex="-1"></a><span class="in">model_logit &lt;- glm(</span></span>
<span id="cb77-1007"><a href="#cb77-1007" aria-hidden="true" tabindex="-1"></a><span class="in">  disclose_donations ~ public_sector_corruption,</span></span>
<span id="cb77-1008"><a href="#cb77-1008" aria-hidden="true" tabindex="-1"></a><span class="in">  family = binomial(link = "logit"),</span></span>
<span id="cb77-1009"><a href="#cb77-1009" aria-hidden="true" tabindex="-1"></a><span class="in">  data = corruption</span></span>
<span id="cb77-1010"><a href="#cb77-1010" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb77-1011"><a href="#cb77-1011" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1012"><a href="#cb77-1012" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_logit)</span></span>
<span id="cb77-1013"><a href="#cb77-1013" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1014"><a href="#cb77-1014" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1015"><a href="#cb77-1015" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-model-logit-donations-corruption, include=FALSE}</span></span>
<span id="cb77-1016"><a href="#cb77-1016" aria-hidden="true" tabindex="-1"></a><span class="in">m_logit &lt;- tidy(model_logit) |&gt;</span></span>
<span id="cb77-1017"><a href="#cb77-1017" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(term = janitor::make_clean_names(term),</span></span>
<span id="cb77-1018"><a href="#cb77-1018" aria-hidden="true" tabindex="-1"></a><span class="in">         est = label_number(accuracy = 0.001, style_negative = "minus")(estimate)) |&gt; </span></span>
<span id="cb77-1019"><a href="#cb77-1019" aria-hidden="true" tabindex="-1"></a><span class="in">  split(~ term)</span></span>
<span id="cb77-1020"><a href="#cb77-1020" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1021"><a href="#cb77-1021" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1022"><a href="#cb77-1022" aria-hidden="true" tabindex="-1"></a>The coefficients here are on a different scale and are measured in log odds units (or logits), not probabilities or percentage points. That means we can't use those coefficients directly. We can't say things like "a one-unit increase in public sector corruption is associated with a <span class="in">`r m_logit$public_sector_corruption$est`</span> percentage point decrease in the probability of having a disclosure law." That's wrong! We have to convert those logit scale coefficients to a probability scale instead. We can do this mathematically by combining both the intercept and the coefficient using <span class="in">`plogis(intercept + coefficient) - plogis(intercept)`</span>, but that's generally not recommended, especially when there are other coefficients (see <span class="co">[</span><span class="ot">this section on logistic regression for more details</span><span class="co">](https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/#2-fractional-logistic-regression)</span>). Additionally, manually combining intercepts and coefficients won't give us standard errors or any other kind of uncertainty. </span>
<span id="cb77-1023"><a href="#cb77-1023" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1024"><a href="#cb77-1024" aria-hidden="true" tabindex="-1"></a>Instead, we can calculate the average slope of the logistic regression fit using either <span class="in">`slopes()`</span> or <span class="in">`emtrends()`</span>.</span>
<span id="cb77-1025"><a href="#cb77-1025" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1026"><a href="#cb77-1026" aria-hidden="true" tabindex="-1"></a>First we'll use <span class="in">`avg_slopes()`</span>. Remember that it calculates the *average marginal effect* (AME) by plugging each row of the original data into the model, generating predictions and instantaneous slopes for each row, and then averaging the <span class="in">`estimate`</span> column. Each row contains actual observed data, so the predictions arguably reflect variation in reality. <span class="in">`avg_slopes()`</span> helpfully converts the AME into percentage points, so we can interpret the value directly.</span>
<span id="cb77-1027"><a href="#cb77-1027" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1028"><a href="#cb77-1028" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-mfx-donations-corruption-mfx}</span></span>
<span id="cb77-1029"><a href="#cb77-1029" aria-hidden="true" tabindex="-1"></a><span class="in">model_logit |&gt; </span></span>
<span id="cb77-1030"><a href="#cb77-1030" aria-hidden="true" tabindex="-1"></a><span class="in">  avg_slopes()</span></span>
<span id="cb77-1031"><a href="#cb77-1031" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1032"><a href="#cb77-1032" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1033"><a href="#cb77-1033" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-mfx-donations-corruption-mfx, include=FALSE}</span></span>
<span id="cb77-1034"><a href="#cb77-1034" aria-hidden="true" tabindex="-1"></a><span class="in">m_logit_mfx &lt;- model_logit |&gt; </span></span>
<span id="cb77-1035"><a href="#cb77-1035" aria-hidden="true" tabindex="-1"></a><span class="in">  avg_slopes() |&gt; </span></span>
<span id="cb77-1036"><a href="#cb77-1036" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(term = janitor::make_clean_names(term),</span></span>
<span id="cb77-1037"><a href="#cb77-1037" aria-hidden="true" tabindex="-1"></a><span class="in">         est_pct_pt = nice_number(estimate * 100),</span></span>
<span id="cb77-1038"><a href="#cb77-1038" aria-hidden="true" tabindex="-1"></a><span class="in">         est = label_number(accuracy = 0.0001, style_negative = "minus")(estimate)) |&gt; </span></span>
<span id="cb77-1039"><a href="#cb77-1039" aria-hidden="true" tabindex="-1"></a><span class="in">  split(~ term)</span></span>
<span id="cb77-1040"><a href="#cb77-1040" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1041"><a href="#cb77-1041" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1042"><a href="#cb77-1042" aria-hidden="true" tabindex="-1"></a>The average marginal effect for public sector corruption is <span class="in">`r m_logit_mfx$public_sector_corruption$est`</span>, which means that on average, a one-point increase in the public sector corruption index (i.e. as corruption gets worse) is associated with a <span class="in">`r m_logit_mfx$public_sector_corruption$est_pct_pt`</span> percentage point decrease in the probability of a country having a disclosure law.</span>
<span id="cb77-1043"><a href="#cb77-1043" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1044"><a href="#cb77-1044" aria-hidden="true" tabindex="-1"></a>Next we'll use <span class="in">`emtrends()`</span>, which calculates the *marginal effect at the mean* (MEM) by averaging all the model covariates first, plugging those averages into the model, and generating a single instantaneous slope. The values that get plugged into the model won't necessarily reflect reality—especially once more covariates are involved, which we'll see later. By default <span class="in">`emtrends()`</span> returns the results on the logit scale, but we can convert them to the response/percentage point scale by adding the <span class="in">`regrid = "response"`</span> argument:</span>
<span id="cb77-1045"><a href="#cb77-1045" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1046"><a href="#cb77-1046" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-mfx-donations-corruption-emtrends}</span></span>
<span id="cb77-1047"><a href="#cb77-1047" aria-hidden="true" tabindex="-1"></a><span class="in">model_logit |&gt; </span></span>
<span id="cb77-1048"><a href="#cb77-1048" aria-hidden="true" tabindex="-1"></a><span class="in">  emtrends(~ public_sector_corruption, </span></span>
<span id="cb77-1049"><a href="#cb77-1049" aria-hidden="true" tabindex="-1"></a><span class="in">           var = "public_sector_corruption", </span></span>
<span id="cb77-1050"><a href="#cb77-1050" aria-hidden="true" tabindex="-1"></a><span class="in">           regrid = "response")</span></span>
<span id="cb77-1051"><a href="#cb77-1051" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1052"><a href="#cb77-1052" aria-hidden="true" tabindex="-1"></a><span class="in"># avg_slopes() will show the same MEM result with `newdata = "mean"`</span></span>
<span id="cb77-1053"><a href="#cb77-1053" aria-hidden="true" tabindex="-1"></a><span class="in"># avg_slopes(model_logit, newdata = "mean")</span></span>
<span id="cb77-1054"><a href="#cb77-1054" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1055"><a href="#cb77-1055" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1056"><a href="#cb77-1056" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-mfx-donations-corruption-emtrends, include=FALSE}</span></span>
<span id="cb77-1057"><a href="#cb77-1057" aria-hidden="true" tabindex="-1"></a><span class="in">m_logit_mfx &lt;- model_logit |&gt; </span></span>
<span id="cb77-1058"><a href="#cb77-1058" aria-hidden="true" tabindex="-1"></a><span class="in">  emtrends(~ public_sector_corruption, </span></span>
<span id="cb77-1059"><a href="#cb77-1059" aria-hidden="true" tabindex="-1"></a><span class="in">           var = "public_sector_corruption", </span></span>
<span id="cb77-1060"><a href="#cb77-1060" aria-hidden="true" tabindex="-1"></a><span class="in">           regrid = "response") |&gt; </span></span>
<span id="cb77-1061"><a href="#cb77-1061" aria-hidden="true" tabindex="-1"></a><span class="in">  tidy() |&gt; </span></span>
<span id="cb77-1062"><a href="#cb77-1062" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(est_pct_pt = nice_number(public_sector_corruption.trend * 100),</span></span>
<span id="cb77-1063"><a href="#cb77-1063" aria-hidden="true" tabindex="-1"></a><span class="in">         est = label_number(accuracy = 0.0001, style_negative = "minus")(public_sector_corruption.trend),</span></span>
<span id="cb77-1064"><a href="#cb77-1064" aria-hidden="true" tabindex="-1"></a><span class="in">         avg = nice_number(public_sector_corruption))</span></span>
<span id="cb77-1065"><a href="#cb77-1065" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1066"><a href="#cb77-1066" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1067"><a href="#cb77-1067" aria-hidden="true" tabindex="-1"></a>When we plug the average public sector corruption (<span class="in">`r m_logit_mfx$avg`</span>) into the model, we get an MEM of <span class="in">`r m_logit_mfx$est`</span>, which means that on average, a one-point increase in the public sector corruption index is associated with a <span class="in">`r m_logit_mfx$est_pct_pt`</span> percentage point decrease in the probability of a country having a disclosure law. That's different (and bigger!) than the AME we found with <span class="in">`slopes()`</span>!</span>
<span id="cb77-1068"><a href="#cb77-1068" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1069"><a href="#cb77-1069" aria-hidden="true" tabindex="-1"></a>Let's plot these marginal effects and their uncertainty to see how much they differ:</span>
<span id="cb77-1070"><a href="#cb77-1070" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1071"><a href="#cb77-1071" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-mfx-ame-mem-basic, fig.height=2}</span></span>
<span id="cb77-1072"><a href="#cb77-1072" aria-hidden="true" tabindex="-1"></a><span class="in"># Get tidied results from slopes()</span></span>
<span id="cb77-1073"><a href="#cb77-1073" aria-hidden="true" tabindex="-1"></a><span class="in">plot_ame &lt;- model_logit |&gt; </span></span>
<span id="cb77-1074"><a href="#cb77-1074" aria-hidden="true" tabindex="-1"></a><span class="in">  avg_slopes()</span></span>
<span id="cb77-1075"><a href="#cb77-1075" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1076"><a href="#cb77-1076" aria-hidden="true" tabindex="-1"></a><span class="in"># Get tidied results from emtrends()</span></span>
<span id="cb77-1077"><a href="#cb77-1077" aria-hidden="true" tabindex="-1"></a><span class="in">plot_mem &lt;- model_logit |&gt; </span></span>
<span id="cb77-1078"><a href="#cb77-1078" aria-hidden="true" tabindex="-1"></a><span class="in">  emtrends(~ public_sector_corruption, </span></span>
<span id="cb77-1079"><a href="#cb77-1079" aria-hidden="true" tabindex="-1"></a><span class="in">           var = "public_sector_corruption", </span></span>
<span id="cb77-1080"><a href="#cb77-1080" aria-hidden="true" tabindex="-1"></a><span class="in">           regrid = "response") |&gt; </span></span>
<span id="cb77-1081"><a href="#cb77-1081" aria-hidden="true" tabindex="-1"></a><span class="in">  tidy(conf.int = TRUE) |&gt; </span></span>
<span id="cb77-1082"><a href="#cb77-1082" aria-hidden="true" tabindex="-1"></a><span class="in">  rename(estimate = public_sector_corruption.trend)</span></span>
<span id="cb77-1083"><a href="#cb77-1083" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1084"><a href="#cb77-1084" aria-hidden="true" tabindex="-1"></a><span class="in"># Combine the two tidy data frames for plotting</span></span>
<span id="cb77-1085"><a href="#cb77-1085" aria-hidden="true" tabindex="-1"></a><span class="in">plot_effects &lt;- bind_rows("AME" = plot_ame, "MEM" = plot_mem, .id = "type") |&gt; </span></span>
<span id="cb77-1086"><a href="#cb77-1086" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(nice_slope = nice_number(estimate * 100))</span></span>
<span id="cb77-1087"><a href="#cb77-1087" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1088"><a href="#cb77-1088" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(plot_effects, aes(x = estimate * 100, y = fct_rev(type), color = type)) +</span></span>
<span id="cb77-1089"><a href="#cb77-1089" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0, linewidth = 0.5, linetype = "24", color = clrs[1]) +</span></span>
<span id="cb77-1090"><a href="#cb77-1090" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_pointrange(aes(xmin = conf.low * 100, xmax = conf.high * 100)) +</span></span>
<span id="cb77-1091"><a href="#cb77-1091" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_label(aes(label = nice_slope), nudge_y = 0.3) +</span></span>
<span id="cb77-1092"><a href="#cb77-1092" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Marginal effect (percentage points)", y = NULL) +</span></span>
<span id="cb77-1093"><a href="#cb77-1093" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_color_manual(values = c(clrs[2], clrs[5]), guide = "none") +</span></span>
<span id="cb77-1094"><a href="#cb77-1094" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_mfx()</span></span>
<span id="cb77-1095"><a href="#cb77-1095" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1096"><a href="#cb77-1096" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1097"><a href="#cb77-1097" aria-hidden="true" tabindex="-1"></a>That's fascinating! The confidence interval around the AME is really small compared to the MEM, likely because the AME estimate comes from the average of <span class="in">`r nrow(corruption)`</span> values, while the MEM is the prediction of a single value. Additionally, while both estimates hover around a 1 percentage point decrease, the AME is larger than −1 while the MEM is smaller.</span>
<span id="cb77-1098"><a href="#cb77-1098" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1099"><a href="#cb77-1099" aria-hidden="true" tabindex="-1"></a>For fun, let's make a super fancy logistic regression model with a quadratic term and an interaction. We'll compare the AME and MEM for public sector corruption again. This is where either <span class="in">`slopes()`</span> or <span class="in">`emtrends()`</span> is incredibly helpful—correctly combining all the necessary coefficients, given that corruption is both squared and interacted, and given that there are other variables to worry about, would be really hard.</span>
<span id="cb77-1100"><a href="#cb77-1100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1101"><a href="#cb77-1101" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-logit-fancy}</span></span>
<span id="cb77-1102"><a href="#cb77-1102" aria-hidden="true" tabindex="-1"></a><span class="in">model_logit_fancy &lt;- glm(</span></span>
<span id="cb77-1103"><a href="#cb77-1103" aria-hidden="true" tabindex="-1"></a><span class="in">  disclose_donations ~ public_sector_corruption + I(public_sector_corruption^2) + </span></span>
<span id="cb77-1104"><a href="#cb77-1104" aria-hidden="true" tabindex="-1"></a><span class="in">    polyarchy + log_gdp_percapita + public_sector_corruption * region,</span></span>
<span id="cb77-1105"><a href="#cb77-1105" aria-hidden="true" tabindex="-1"></a><span class="in">  family = binomial(link = "logit"),</span></span>
<span id="cb77-1106"><a href="#cb77-1106" aria-hidden="true" tabindex="-1"></a><span class="in">  data = corruption</span></span>
<span id="cb77-1107"><a href="#cb77-1107" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb77-1108"><a href="#cb77-1108" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1109"><a href="#cb77-1109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1110"><a href="#cb77-1110" aria-hidden="true" tabindex="-1"></a>Here are the average marginal effects (AME) (again, each original row is plugged into the model, a slope is calculated for each, and then they're all averaged together):</span>
<span id="cb77-1111"><a href="#cb77-1111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1112"><a href="#cb77-1112" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-mfx-logit-fancy}</span></span>
<span id="cb77-1113"><a href="#cb77-1113" aria-hidden="true" tabindex="-1"></a><span class="in">model_logit_fancy |&gt; </span></span>
<span id="cb77-1114"><a href="#cb77-1114" aria-hidden="true" tabindex="-1"></a><span class="in">  avg_slopes()</span></span>
<span id="cb77-1115"><a href="#cb77-1115" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1116"><a href="#cb77-1116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1117"><a href="#cb77-1117" aria-hidden="true" tabindex="-1"></a>And here are the marginal effects at the mean (MEM) (again, the average values for each covariate are plugged into the model). Using <span class="in">`emtrends()`</span> results in a note about interactions, so we'll use <span class="in">`avg_slopes(..., newdata = "mean")`</span> instead:</span>
<span id="cb77-1118"><a href="#cb77-1118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1119"><a href="#cb77-1119" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-mfx-logit-fancy-mem}</span></span>
<span id="cb77-1120"><a href="#cb77-1120" aria-hidden="true" tabindex="-1"></a><span class="in">model_logit_fancy |&gt; </span></span>
<span id="cb77-1121"><a href="#cb77-1121" aria-hidden="true" tabindex="-1"></a><span class="in">  emtrends(~ public_sector_corruption, </span></span>
<span id="cb77-1122"><a href="#cb77-1122" aria-hidden="true" tabindex="-1"></a><span class="in">           var = "public_sector_corruption", </span></span>
<span id="cb77-1123"><a href="#cb77-1123" aria-hidden="true" tabindex="-1"></a><span class="in">           regrid = "response")</span></span>
<span id="cb77-1124"><a href="#cb77-1124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1125"><a href="#cb77-1125" aria-hidden="true" tabindex="-1"></a><span class="in"># This uses avg_slopes() to find the MEM instead</span></span>
<span id="cb77-1126"><a href="#cb77-1126" aria-hidden="true" tabindex="-1"></a><span class="in">model_logit_fancy |&gt; </span></span>
<span id="cb77-1127"><a href="#cb77-1127" aria-hidden="true" tabindex="-1"></a><span class="in">  avg_slopes(newdata = "mean")</span></span>
<span id="cb77-1128"><a href="#cb77-1128" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1129"><a href="#cb77-1129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1130"><a href="#cb77-1130" aria-hidden="true" tabindex="-1"></a>Now that we're working with multiple covariates, we have instantaneous marginal effects for each regression term, which is neat. We only care about corruption here, so let's extract the slopes and plot them:</span>
<span id="cb77-1131"><a href="#cb77-1131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1132"><a href="#cb77-1132" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-mfx-ame-mem-fancy, fig.height=2}</span></span>
<span id="cb77-1133"><a href="#cb77-1133" aria-hidden="true" tabindex="-1"></a><span class="in">plot_ame_fancy &lt;- model_logit_fancy |&gt; </span></span>
<span id="cb77-1134"><a href="#cb77-1134" aria-hidden="true" tabindex="-1"></a><span class="in">  avg_slopes()</span></span>
<span id="cb77-1135"><a href="#cb77-1135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1136"><a href="#cb77-1136" aria-hidden="true" tabindex="-1"></a><span class="in">plot_mem_fancy &lt;- model_logit_fancy |&gt; </span></span>
<span id="cb77-1137"><a href="#cb77-1137" aria-hidden="true" tabindex="-1"></a><span class="in">  avg_slopes(newdata = "mean")</span></span>
<span id="cb77-1138"><a href="#cb77-1138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1139"><a href="#cb77-1139" aria-hidden="true" tabindex="-1"></a><span class="in"># Combine the two tidy data frames for plotting</span></span>
<span id="cb77-1140"><a href="#cb77-1140" aria-hidden="true" tabindex="-1"></a><span class="in">plot_effects &lt;- bind_rows("AME" = plot_ame_fancy, "MEM" = plot_mem_fancy, .id = "type") |&gt; </span></span>
<span id="cb77-1141"><a href="#cb77-1141" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(term == "public_sector_corruption") |&gt; </span></span>
<span id="cb77-1142"><a href="#cb77-1142" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(nice_slope = nice_number(estimate * 100))</span></span>
<span id="cb77-1143"><a href="#cb77-1143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1144"><a href="#cb77-1144" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(plot_effects, aes(x = estimate * 100, y = fct_rev(type), color = type)) +</span></span>
<span id="cb77-1145"><a href="#cb77-1145" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0, linewidth = 0.5, linetype = "24", color = clrs[1]) +</span></span>
<span id="cb77-1146"><a href="#cb77-1146" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_pointrange(aes(xmin = conf.low * 100, xmax = conf.high * 100)) +</span></span>
<span id="cb77-1147"><a href="#cb77-1147" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_label(aes(label = nice_slope), nudge_y = 0.3) +</span></span>
<span id="cb77-1148"><a href="#cb77-1148" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Marginal effect (percentage points)", y = NULL) +</span></span>
<span id="cb77-1149"><a href="#cb77-1149" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_color_manual(values = c(clrs[2], clrs[5]), guide = "none") +</span></span>
<span id="cb77-1150"><a href="#cb77-1150" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_mfx()</span></span>
<span id="cb77-1151"><a href="#cb77-1151" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1152"><a href="#cb77-1152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1153"><a href="#cb77-1153" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-mfx-ame-mem-fancy, include=FALSE}</span></span>
<span id="cb77-1154"><a href="#cb77-1154" aria-hidden="true" tabindex="-1"></a><span class="in">mfx_ame_fancy &lt;- plot_ame_fancy |&gt; </span></span>
<span id="cb77-1155"><a href="#cb77-1155" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(term = janitor::make_clean_names(term),</span></span>
<span id="cb77-1156"><a href="#cb77-1156" aria-hidden="true" tabindex="-1"></a><span class="in">         est = nice_number(estimate),</span></span>
<span id="cb77-1157"><a href="#cb77-1157" aria-hidden="true" tabindex="-1"></a><span class="in">         p_clean = nice_p(p.value)) |&gt; </span></span>
<span id="cb77-1158"><a href="#cb77-1158" aria-hidden="true" tabindex="-1"></a><span class="in">  split(~ term)</span></span>
<span id="cb77-1159"><a href="#cb77-1159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1160"><a href="#cb77-1160" aria-hidden="true" tabindex="-1"></a><span class="in">mfx_mem_fancy &lt;- plot_mem_fancy |&gt; </span></span>
<span id="cb77-1161"><a href="#cb77-1161" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(term = janitor::make_clean_names(term),</span></span>
<span id="cb77-1162"><a href="#cb77-1162" aria-hidden="true" tabindex="-1"></a><span class="in">         est = nice_number(estimate),</span></span>
<span id="cb77-1163"><a href="#cb77-1163" aria-hidden="true" tabindex="-1"></a><span class="in">         p_clean = nice_p(p.value)) |&gt; </span></span>
<span id="cb77-1164"><a href="#cb77-1164" aria-hidden="true" tabindex="-1"></a><span class="in">  split(~ term)</span></span>
<span id="cb77-1165"><a href="#cb77-1165" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1166"><a href="#cb77-1166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1167"><a href="#cb77-1167" aria-hidden="true" tabindex="-1"></a>Yikes! The AME is statistically significant (<span class="in">`r mfx_ame_fancy$public_sector_corruption$p_clean`</span>) with a narrower confidence interval, but the MEM includes zero in its confidence interval and isn't significant (<span class="in">`r mfx_mem_fancy$public_sector_corruption$p_clean`</span>).</span>
<span id="cb77-1168"><a href="#cb77-1168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1169"><a href="#cb77-1169" aria-hidden="true" tabindex="-1"></a>The choice of marginal effect averaging thus matters a lot!</span>
<span id="cb77-1170"><a href="#cb77-1170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1171"><a href="#cb77-1171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1172"><a href="#cb77-1172" aria-hidden="true" tabindex="-1"></a><span class="fu">## Other marginal slope things</span></span>
<span id="cb77-1173"><a href="#cb77-1173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1174"><a href="#cb77-1174" aria-hidden="true" tabindex="-1"></a>To make life even more exciting, we're not limited to just average marginal effects (AMEs) or marginal effects at the mean (MEMs). Additionally, if we think back to the slider/switch/mixing board analogy, all we've really done so far with our logistic regression model is move one slider (<span class="in">`public_sector_corruption`</span>) up and down. What happens if we move other switches and sliders at the same time? (i.e. the marginal effect of corruption at specific values of corruption, or across different regions, or at different levels of GDP per capita and polyarchy)</span>
<span id="cb77-1175"><a href="#cb77-1175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1176"><a href="#cb77-1176" aria-hidden="true" tabindex="-1"></a>We can use both <span class="in">`slopes()`</span> and <span class="in">`emtrends()`</span>/<span class="in">`emmeans()`</span> to play with our model's full mixing board. We'll continue to use the logistic regression model as an example since it's sensitive to the order of averaging.</span>
<span id="cb77-1177"><a href="#cb77-1177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1178"><a href="#cb77-1178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1179"><a href="#cb77-1179" aria-hidden="true" tabindex="-1"></a><span class="fu">### Group average marginal effects</span></span>
<span id="cb77-1180"><a href="#cb77-1180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1181"><a href="#cb77-1181" aria-hidden="true" tabindex="-1"></a>If we have categorical covariates in our model like <span class="in">`region`</span>, we can find the average marginal effect (AME) of continuous predictors across those different groups. This is fairly straightforward when working with <span class="in">`slopes()`</span> because of its approach to averaging. Remember that with the AME, each original row gets its own fitted value and each individual slope, which we can then average and collapse into a single row. Group characteristics like region are maintained after calculating predictions, so we can calculate group averages of the individual slopes. This outlines the process:</span>
<span id="cb77-1182"><a href="#cb77-1182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1183"><a href="#cb77-1183" aria-hidden="true" tabindex="-1"></a><span class="in">```{r flow-game, echo=FALSE, out.width="100%", fig.align="center"}</span></span>
<span id="cb77-1184"><a href="#cb77-1184" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-inset-right</span></span>
<span id="cb77-1185"><a href="#cb77-1185" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::include_graphics("images/flow-game@3x.png")</span></span>
<span id="cb77-1186"><a href="#cb77-1186" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1187"><a href="#cb77-1187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1188"><a href="#cb77-1188" aria-hidden="true" tabindex="-1"></a>Because we're working with the AME, we have an <span class="in">`estimate`</span> column with instantaneous slopes for each row in the original data:</span>
<span id="cb77-1189"><a href="#cb77-1189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1190"><a href="#cb77-1190" aria-hidden="true" tabindex="-1"></a><span class="in">```{r game-mfx}</span></span>
<span id="cb77-1191"><a href="#cb77-1191" aria-hidden="true" tabindex="-1"></a><span class="in"># We'll specify variables = "public_sector_corruption" here to filter the</span></span>
<span id="cb77-1192"><a href="#cb77-1192" aria-hidden="true" tabindex="-1"></a><span class="in"># marginal effects results. If we don't we'll get dozens of separate marginal</span></span>
<span id="cb77-1193"><a href="#cb77-1193" aria-hidden="true" tabindex="-1"></a><span class="in"># effects later when using summary() for each of the coefficients, interactions,</span></span>
<span id="cb77-1194"><a href="#cb77-1194" aria-hidden="true" tabindex="-1"></a><span class="in"># and cross-region contrasts</span></span>
<span id="cb77-1195"><a href="#cb77-1195" aria-hidden="true" tabindex="-1"></a><span class="in">mfx_logit_fancy &lt;- model_logit_fancy |&gt; </span></span>
<span id="cb77-1196"><a href="#cb77-1196" aria-hidden="true" tabindex="-1"></a><span class="in">  slopes(variables = "public_sector_corruption")</span></span>
<span id="cb77-1197"><a href="#cb77-1197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1198"><a href="#cb77-1198" aria-hidden="true" tabindex="-1"></a><span class="in"># Original data frame + estimated slope for each row</span></span>
<span id="cb77-1199"><a href="#cb77-1199" aria-hidden="true" tabindex="-1"></a><span class="in">head(mfx_logit_fancy)</span></span>
<span id="cb77-1200"><a href="#cb77-1200" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1201"><a href="#cb77-1201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1202"><a href="#cb77-1202" aria-hidden="true" tabindex="-1"></a>All the original columns are still there, which means we can collapse the results however we want. For instance, here's the average marginal effect across each region:</span>
<span id="cb77-1203"><a href="#cb77-1203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1204"><a href="#cb77-1204" aria-hidden="true" tabindex="-1"></a><span class="in">```{r game-mfx-manual}</span></span>
<span id="cb77-1205"><a href="#cb77-1205" aria-hidden="true" tabindex="-1"></a><span class="in">mfx_logit_fancy |&gt; </span></span>
<span id="cb77-1206"><a href="#cb77-1206" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(region) |&gt; </span></span>
<span id="cb77-1207"><a href="#cb77-1207" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(region_ame = mean(estimate))</span></span>
<span id="cb77-1208"><a href="#cb77-1208" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1209"><a href="#cb77-1209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1210"><a href="#cb77-1210" aria-hidden="true" tabindex="-1"></a>We can also use summarizing methods built in to **marginaleffects** by using the <span class="in">`by`</span> argument in <span class="in">`slopes()`</span>. This is the better option, since it does some tricky standard error calculations behind the scenes:</span>
<span id="cb77-1211"><a href="#cb77-1211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1212"><a href="#cb77-1212" aria-hidden="true" tabindex="-1"></a><span class="in">```{r game-mfx-tidy}</span></span>
<span id="cb77-1213"><a href="#cb77-1213" aria-hidden="true" tabindex="-1"></a><span class="in">model_logit_fancy |&gt; </span></span>
<span id="cb77-1214"><a href="#cb77-1214" aria-hidden="true" tabindex="-1"></a><span class="in">  slopes(variables = "public_sector_corruption",</span></span>
<span id="cb77-1215"><a href="#cb77-1215" aria-hidden="true" tabindex="-1"></a><span class="in">         by = "region")</span></span>
<span id="cb77-1216"><a href="#cb77-1216" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1217"><a href="#cb77-1217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1218"><a href="#cb77-1218" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-game-mfx, include=FALSE}</span></span>
<span id="cb77-1219"><a href="#cb77-1219" aria-hidden="true" tabindex="-1"></a><span class="in">m_logit_fancy_mfx &lt;- model_logit_fancy |&gt; </span></span>
<span id="cb77-1220"><a href="#cb77-1220" aria-hidden="true" tabindex="-1"></a><span class="in">  slopes(variables = "public_sector_corruption",</span></span>
<span id="cb77-1221"><a href="#cb77-1221" aria-hidden="true" tabindex="-1"></a><span class="in">         by = "region") |&gt; </span></span>
<span id="cb77-1222"><a href="#cb77-1222" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(term = janitor::make_clean_names(term),</span></span>
<span id="cb77-1223"><a href="#cb77-1223" aria-hidden="true" tabindex="-1"></a><span class="in">         est = label_number(accuracy = 0.0001, style_negative = "minus")(estimate),</span></span>
<span id="cb77-1224"><a href="#cb77-1224" aria-hidden="true" tabindex="-1"></a><span class="in">         est_pct_pt = nice_number(estimate * 100),</span></span>
<span id="cb77-1225"><a href="#cb77-1225" aria-hidden="true" tabindex="-1"></a><span class="in">         p_clean = nice_p(p.value)) |&gt; </span></span>
<span id="cb77-1226"><a href="#cb77-1226" aria-hidden="true" tabindex="-1"></a><span class="in">  split(~ term)</span></span>
<span id="cb77-1227"><a href="#cb77-1227" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1228"><a href="#cb77-1228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1229"><a href="#cb77-1229" aria-hidden="true" tabindex="-1"></a>These are on the percentage point scale, not the logit scale, so we can interpret them directly. In Western Europe, the AME of corruption is <span class="in">`r m_logit_fancy_mfx$public_sector_corruption_2$est`</span>, so a one-point increase in the public sector corruption index there is associated with a <span class="in">`r m_logit_fancy_mfx$public_sector_corruption_2$est_pct_pt`</span> percentage point decrease in the probability of having a campaign finance disclosure law, on average (though it's not actually significant (<span class="in">`r m_logit_fancy_mfx$public_sector_corruption_2$p_clean`</span>)). In the Middle East, on the other hand, corruption seems to matter less for disclosure laws—an increase in the corruption index there is associated with a <span class="in">`r m_logit_fancy_mfx$public_sector_corruption_6$est_pct_pt`</span> percentage point decrease in the probability of having a laws, on average (and that *is* significant (<span class="in">`r m_logit_fancy_mfx$public_sector_corruption_6$p_clean`</span>)).</span>
<span id="cb77-1230"><a href="#cb77-1230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1231"><a href="#cb77-1231" aria-hidden="true" tabindex="-1"></a>We can use <span class="in">`emtrends()`</span> to get region-specific slopes, but we'll get different results because of the order of averaging. **emmeans** creates averages and then plugs them in; **marginaleffects** plugs all the values in and then creates averages:</span>
<span id="cb77-1232"><a href="#cb77-1232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1233"><a href="#cb77-1233" aria-hidden="true" tabindex="-1"></a><span class="in">```{r game-emtrends-mem}</span></span>
<span id="cb77-1234"><a href="#cb77-1234" aria-hidden="true" tabindex="-1"></a><span class="in">model_logit_fancy |&gt; </span></span>
<span id="cb77-1235"><a href="#cb77-1235" aria-hidden="true" tabindex="-1"></a><span class="in">  emtrends(~ public_sector_corruption + region,</span></span>
<span id="cb77-1236"><a href="#cb77-1236" aria-hidden="true" tabindex="-1"></a><span class="in">           var = "public_sector_corruption", regrid = "response")</span></span>
<span id="cb77-1237"><a href="#cb77-1237" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1238"><a href="#cb77-1238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1239"><a href="#cb77-1239" aria-hidden="true" tabindex="-1"></a>We can replicate the results from <span class="in">`emtrends()`</span> with <span class="in">`avg_slopes()`</span> if we plug in average or representative values (more on that in the next section), since that follows the same averaging order as **emmeans** (i.e. plugging averages into the model)</span>
<span id="cb77-1240"><a href="#cb77-1240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1241"><a href="#cb77-1241" aria-hidden="true" tabindex="-1"></a><span class="in">```{r game-mfx-mem}</span></span>
<span id="cb77-1242"><a href="#cb77-1242" aria-hidden="true" tabindex="-1"></a><span class="in">model_logit_fancy |&gt; </span></span>
<span id="cb77-1243"><a href="#cb77-1243" aria-hidden="true" tabindex="-1"></a><span class="in">  avg_slopes(variables = "public_sector_corruption",</span></span>
<span id="cb77-1244"><a href="#cb77-1244" aria-hidden="true" tabindex="-1"></a><span class="in">             newdata = datagrid(region = levels(corruption$region)),</span></span>
<span id="cb77-1245"><a href="#cb77-1245" aria-hidden="true" tabindex="-1"></a><span class="in">             by = "region")</span></span>
<span id="cb77-1246"><a href="#cb77-1246" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1247"><a href="#cb77-1247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1248"><a href="#cb77-1248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1249"><a href="#cb77-1249" aria-hidden="true" tabindex="-1"></a><span class="fu">### Marginal effects at user-specified or representative values</span></span>
<span id="cb77-1250"><a href="#cb77-1250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1251"><a href="#cb77-1251" aria-hidden="true" tabindex="-1"></a>If we want to unlock the full potential of our regression mixing board, we can feed the model any values we want. In general, we'll (1) make a little dataset with covariate values set to either specific values that we care about, or typical or average values, (2) plug that little dataset into the the model and get fitted values, and (3) work with the results. There are a bunch of different names for this little fake dataset like "data grid" and "reference grid", but they're all the same idea. Here's an overview of the approach:</span>
<span id="cb77-1252"><a href="#cb77-1252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1253"><a href="#cb77-1253" aria-hidden="true" tabindex="-1"></a><span class="in">```{r flow-mer, echo=FALSE, out.width="100%", fig.align="center"}</span></span>
<span id="cb77-1254"><a href="#cb77-1254" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-inset-right</span></span>
<span id="cb77-1255"><a href="#cb77-1255" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::include_graphics("images/flow-mer@3x.png")</span></span>
<span id="cb77-1256"><a href="#cb77-1256" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1257"><a href="#cb77-1257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1258"><a href="#cb77-1258" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Creating representative values</span></span>
<span id="cb77-1259"><a href="#cb77-1259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1260"><a href="#cb77-1260" aria-hidden="true" tabindex="-1"></a>Before plugging anything in, it's helpful to look at different ways of creating data grids with R. For all these examples, we'll make a dataset with public sector corruption set to 20 and 80 across Western Europe, Latin America, and the Middle East, with all other variables in the model set to their means. We'll make a little list of these regions to save typing time:</span>
<span id="cb77-1261"><a href="#cb77-1261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1262"><a href="#cb77-1262" aria-hidden="true" tabindex="-1"></a><span class="in">```{r define-regions}</span></span>
<span id="cb77-1263"><a href="#cb77-1263" aria-hidden="true" tabindex="-1"></a><span class="in">regions_to_use &lt;- c("Western Europe and North America", </span></span>
<span id="cb77-1264"><a href="#cb77-1264" aria-hidden="true" tabindex="-1"></a><span class="in">                    "Latin America and the Caribbean",</span></span>
<span id="cb77-1265"><a href="#cb77-1265" aria-hidden="true" tabindex="-1"></a><span class="in">                    "Middle East and North Africa")</span></span>
<span id="cb77-1266"><a href="#cb77-1266" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1267"><a href="#cb77-1267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1268"><a href="#cb77-1268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1269"><a href="#cb77-1269" aria-hidden="true" tabindex="-1"></a>First, we can do it all manually with the <span class="in">`expand_grid()`</span> function from **tidyr** (or <span class="in">`expand.grid()`</span> from base R). This creates a data frame from all combinations of the vectors and single values we feed it.</span>
<span id="cb77-1270"><a href="#cb77-1270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1271"><a href="#cb77-1271" aria-hidden="true" tabindex="-1"></a><span class="in">```{r grid-expand-grid}</span></span>
<span id="cb77-1272"><a href="#cb77-1272" aria-hidden="true" tabindex="-1"></a><span class="in">expand_grid(public_sector_corruption = c(20, 80),</span></span>
<span id="cb77-1273"><a href="#cb77-1273" aria-hidden="true" tabindex="-1"></a><span class="in">            region = regions_to_use,</span></span>
<span id="cb77-1274"><a href="#cb77-1274" aria-hidden="true" tabindex="-1"></a><span class="in">            polyarchy = mean(corruption$polyarchy),</span></span>
<span id="cb77-1275"><a href="#cb77-1275" aria-hidden="true" tabindex="-1"></a><span class="in">            log_gdp_percapita = mean(corruption$log_gdp_percapita))</span></span>
<span id="cb77-1276"><a href="#cb77-1276" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1277"><a href="#cb77-1277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1278"><a href="#cb77-1278" aria-hidden="true" tabindex="-1"></a>A disadvantage of using <span class="in">`expand_grid()`</span> like this is that the averages we calculated aren't necessarily the same averages of the data that gets used in the model. If any rows are dropped in the model because of missing values, that won't be reflected here. We could get around that by doing <span class="in">`model.frame(model_logit_fancy)$polyarchy`</span>, but that's starting to get unwieldy. Instead, we can use a function that takes information about the model into account.</span>
<span id="cb77-1279"><a href="#cb77-1279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1280"><a href="#cb77-1280" aria-hidden="true" tabindex="-1"></a>Second, we can use <span class="co">[</span><span class="ot">`data_grid()`</span><span class="co">](https://modelr.tidyverse.org/reference/data_grid.html)</span> from <span class="co">[</span><span class="ot">**modelr**</span><span class="co">](https://modelr.tidyverse.org/)</span>, which is part of the really neat <span class="co">[</span><span class="ot">**tidymodels** ecosystem</span><span class="co">](https://www.tidymodels.org/)</span>. An advantage of doing this is that it will handle the typical value part automatically—it will calculate the mean for continuous predictors and the mode for categorical predictors.</span>
<span id="cb77-1281"><a href="#cb77-1281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1282"><a href="#cb77-1282" aria-hidden="true" tabindex="-1"></a><span class="in">```{r grid-data-grid-modelr}</span></span>
<span id="cb77-1283"><a href="#cb77-1283" aria-hidden="true" tabindex="-1"></a><span class="in">modelr::data_grid(corruption,</span></span>
<span id="cb77-1284"><a href="#cb77-1284" aria-hidden="true" tabindex="-1"></a><span class="in">                  public_sector_corruption = c(20, 80),</span></span>
<span id="cb77-1285"><a href="#cb77-1285" aria-hidden="true" tabindex="-1"></a><span class="in">                  region = regions_to_use,</span></span>
<span id="cb77-1286"><a href="#cb77-1286" aria-hidden="true" tabindex="-1"></a><span class="in">                  .model = model_logit_fancy)</span></span>
<span id="cb77-1287"><a href="#cb77-1287" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1288"><a href="#cb77-1288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1289"><a href="#cb77-1289" aria-hidden="true" tabindex="-1"></a>Third, we can use **marginaleffects**'s <span class="in">`datagrid()`</span>, which will also calculate typical values for any covariates we don't specify:</span>
<span id="cb77-1290"><a href="#cb77-1290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1291"><a href="#cb77-1291" aria-hidden="true" tabindex="-1"></a><span class="in">```{r grid-datagrid}</span></span>
<span id="cb77-1292"><a href="#cb77-1292" aria-hidden="true" tabindex="-1"></a><span class="in">datagrid(model = model_logit_fancy,</span></span>
<span id="cb77-1293"><a href="#cb77-1293" aria-hidden="true" tabindex="-1"></a><span class="in">         public_sector_corruption = c(20, 80),</span></span>
<span id="cb77-1294"><a href="#cb77-1294" aria-hidden="true" tabindex="-1"></a><span class="in">         region = regions_to_use)</span></span>
<span id="cb77-1295"><a href="#cb77-1295" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1296"><a href="#cb77-1296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1297"><a href="#cb77-1297" aria-hidden="true" tabindex="-1"></a>And finally, we can use **emmeans**'s <span class="in">`ref_grid()`</span>, which will *also* automatically create typical values. This doesn't return a data frame—it's some sort of special <span class="in">`ref_grid`</span> object, but all the important information is still there:</span>
<span id="cb77-1298"><a href="#cb77-1298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1299"><a href="#cb77-1299" aria-hidden="true" tabindex="-1"></a><span class="in">```{r grid-ref-grid}</span></span>
<span id="cb77-1300"><a href="#cb77-1300" aria-hidden="true" tabindex="-1"></a><span class="in">ref_grid(model_logit_fancy,</span></span>
<span id="cb77-1301"><a href="#cb77-1301" aria-hidden="true" tabindex="-1"></a><span class="in">         at = list(public_sector_corruption = c(20, 80),</span></span>
<span id="cb77-1302"><a href="#cb77-1302" aria-hidden="true" tabindex="-1"></a><span class="in">                   region = regions_to_use))</span></span>
<span id="cb77-1303"><a href="#cb77-1303" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1304"><a href="#cb77-1304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1305"><a href="#cb77-1305" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Working with representative values</span></span>
<span id="cb77-1306"><a href="#cb77-1306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1307"><a href="#cb77-1307" aria-hidden="true" tabindex="-1"></a>Now that we have a hypothetical data grid of sliders and switches set to specific values, we can plug it into the model and generate fitted values. Importantly, doing this provides us with results that are analogous to the marginal effects at the mean (MEM) that we found earlier, and *not* the average marginal effect (AME), since we're not feeding the entire original dataset to the model. None of these hypothetical rows exist in real life—there is no country with any of these exact combinations of corruption, polyarchy/democracy, GDP per capita, or region. </span>
<span id="cb77-1308"><a href="#cb77-1308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1309"><a href="#cb77-1309" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-mer-mfx}</span></span>
<span id="cb77-1310"><a href="#cb77-1310" aria-hidden="true" tabindex="-1"></a><span class="in">model_logit_fancy |&gt; </span></span>
<span id="cb77-1311"><a href="#cb77-1311" aria-hidden="true" tabindex="-1"></a><span class="in">  slopes(variables = "public_sector_corruption",</span></span>
<span id="cb77-1312"><a href="#cb77-1312" aria-hidden="true" tabindex="-1"></a><span class="in">         newdata = datagrid(public_sector_corruption = c(20, 80),</span></span>
<span id="cb77-1313"><a href="#cb77-1313" aria-hidden="true" tabindex="-1"></a><span class="in">                            region = regions_to_use))</span></span>
<span id="cb77-1314"><a href="#cb77-1314" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1315"><a href="#cb77-1315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1316"><a href="#cb77-1316" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-mer-emtrends}</span></span>
<span id="cb77-1317"><a href="#cb77-1317" aria-hidden="true" tabindex="-1"></a><span class="in">model_logit_fancy |&gt; </span></span>
<span id="cb77-1318"><a href="#cb77-1318" aria-hidden="true" tabindex="-1"></a><span class="in">  emtrends(~ public_sector_corruption + region, var = "public_sector_corruption",</span></span>
<span id="cb77-1319"><a href="#cb77-1319" aria-hidden="true" tabindex="-1"></a><span class="in">           at = list(public_sector_corruption = c(20, 80),</span></span>
<span id="cb77-1320"><a href="#cb77-1320" aria-hidden="true" tabindex="-1"></a><span class="in">                     region = regions_to_use),</span></span>
<span id="cb77-1321"><a href="#cb77-1321" aria-hidden="true" tabindex="-1"></a><span class="in">           regrid = "response", delta.var = 0.001) </span></span>
<span id="cb77-1322"><a href="#cb77-1322" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1323"><a href="#cb77-1323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1324"><a href="#cb77-1324" aria-hidden="true" tabindex="-1"></a>We have a ton of marginal effects here, but this is all starting to get really complicated. These are slopes, but slopes for which lines? What do these marginal effects actually look like?</span>
<span id="cb77-1325"><a href="#cb77-1325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1326"><a href="#cb77-1326" aria-hidden="true" tabindex="-1"></a>Plotting these regression lines is tricky because we're no longer working with a single variable on the x-axis. Instead, we need to generate predicted values of the regression outcome across a range of one $x$ while holding all the other variables constant. This is exactly what we've been doing to get marginal effects, only now instead of getting slopes as the output, we want fitted values. Both **marginaleffects** and **emmeans** make this easy.</span>
<span id="cb77-1327"><a href="#cb77-1327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1328"><a href="#cb77-1328" aria-hidden="true" tabindex="-1"></a>In the **marginaleffects** world, we can use <span class="in">`predictions()`</span>. The <span class="in">`estimate`</span> column now shows the fitted value instead of the slope:</span>
<span id="cb77-1329"><a href="#cb77-1329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1330"><a href="#cb77-1330" aria-hidden="true" tabindex="-1"></a><span class="in">```{r predict-mfx}</span></span>
<span id="cb77-1331"><a href="#cb77-1331" aria-hidden="true" tabindex="-1"></a><span class="in">model_logit_fancy |&gt; </span></span>
<span id="cb77-1332"><a href="#cb77-1332" aria-hidden="true" tabindex="-1"></a><span class="in">  predictions(newdata = datagrid(public_sector_corruption = c(20, 80),</span></span>
<span id="cb77-1333"><a href="#cb77-1333" aria-hidden="true" tabindex="-1"></a><span class="in">                                 region = regions_to_use))</span></span>
<span id="cb77-1334"><a href="#cb77-1334" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1335"><a href="#cb77-1335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1336"><a href="#cb77-1336" aria-hidden="true" tabindex="-1"></a>In the **emmeans** world, we can use <span class="in">`emmeans()`</span>:</span>
<span id="cb77-1337"><a href="#cb77-1337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1338"><a href="#cb77-1338" aria-hidden="true" tabindex="-1"></a><span class="in">```{r predict-emmeans}</span></span>
<span id="cb77-1339"><a href="#cb77-1339" aria-hidden="true" tabindex="-1"></a><span class="in">model_logit_fancy |&gt; </span></span>
<span id="cb77-1340"><a href="#cb77-1340" aria-hidden="true" tabindex="-1"></a><span class="in">  emmeans(~ public_sector_corruption + region, var = "public_sector_corruption",</span></span>
<span id="cb77-1341"><a href="#cb77-1341" aria-hidden="true" tabindex="-1"></a><span class="in">          at = list(public_sector_corruption = c(20, 80),</span></span>
<span id="cb77-1342"><a href="#cb77-1342" aria-hidden="true" tabindex="-1"></a><span class="in">                    region = regions_to_use),</span></span>
<span id="cb77-1343"><a href="#cb77-1343" aria-hidden="true" tabindex="-1"></a><span class="in">          regrid = "response") </span></span>
<span id="cb77-1344"><a href="#cb77-1344" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1345"><a href="#cb77-1345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1346"><a href="#cb77-1346" aria-hidden="true" tabindex="-1"></a>The results from the two packages are identical because we're using a data grid—in both cases we're averaging *before* plugging stuff into the model.</span>
<span id="cb77-1347"><a href="#cb77-1347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1348"><a href="#cb77-1348" aria-hidden="true" tabindex="-1"></a>Instead of setting corruption to 20 and 80, we'll use a whole range of values so we can plot it.</span>
<span id="cb77-1349"><a href="#cb77-1349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1350"><a href="#cb77-1350" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-logit-predictions, fig.width=7, fig.height=5}</span></span>
<span id="cb77-1351"><a href="#cb77-1351" aria-hidden="true" tabindex="-1"></a><span class="in">logit_predictions &lt;- model_logit_fancy |&gt; </span></span>
<span id="cb77-1352"><a href="#cb77-1352" aria-hidden="true" tabindex="-1"></a><span class="in">  emmeans(~ public_sector_corruption + region, var = "public_sector_corruption",</span></span>
<span id="cb77-1353"><a href="#cb77-1353" aria-hidden="true" tabindex="-1"></a><span class="in">          at = list(public_sector_corruption = seq(0, 90, 1)),</span></span>
<span id="cb77-1354"><a href="#cb77-1354" aria-hidden="true" tabindex="-1"></a><span class="in">          regrid = "response") |&gt; </span></span>
<span id="cb77-1355"><a href="#cb77-1355" aria-hidden="true" tabindex="-1"></a><span class="in">  as_tibble()</span></span>
<span id="cb77-1356"><a href="#cb77-1356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1357"><a href="#cb77-1357" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(logit_predictions, aes(x = public_sector_corruption, y = prob, color = region)) +</span></span>
<span id="cb77-1358"><a href="#cb77-1358" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(linewidth = 1) +</span></span>
<span id="cb77-1359"><a href="#cb77-1359" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Public sector corruption", y = "Predicted probability of having\na campaign finance disclosure law", color = NULL) +</span></span>
<span id="cb77-1360"><a href="#cb77-1360" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_y_continuous(labels = percent_format()) +</span></span>
<span id="cb77-1361"><a href="#cb77-1361" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_color_manual(values = c(clrs, "grey30")) +</span></span>
<span id="cb77-1362"><a href="#cb77-1362" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_mfx() +</span></span>
<span id="cb77-1363"><a href="#cb77-1363" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = "bottom")</span></span>
<span id="cb77-1364"><a href="#cb77-1364" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1365"><a href="#cb77-1365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1366"><a href="#cb77-1366" aria-hidden="true" tabindex="-1"></a>(Alternatively, you can use **marginaleffects**'s built-in <span class="in">`plot_predictions()`</span> to make this plot with one line of code):</span>
<span id="cb77-1367"><a href="#cb77-1367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1368"><a href="#cb77-1368" aria-hidden="true" tabindex="-1"></a><span class="in">```{r example-plot-cap, eval=FALSE}</span></span>
<span id="cb77-1369"><a href="#cb77-1369" aria-hidden="true" tabindex="-1"></a><span class="in">plot_predictions(model_logit_fancy, condition = c("public_sector_corruption", "region"))</span></span>
<span id="cb77-1370"><a href="#cb77-1370" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1371"><a href="#cb77-1371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1372"><a href="#cb77-1372" aria-hidden="true" tabindex="-1"></a>That's such a cool plot! Each region has a different shape of predicted probabilities across public sector corruption. </span>
<span id="cb77-1373"><a href="#cb77-1373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1374"><a href="#cb77-1374" aria-hidden="true" tabindex="-1"></a>Earlier we calculated a bunch of instantaneous slopes when corruption was set to 20 and 80 in a few different regions, so let's put those slopes and their tangent lines on the plot:</span>
<span id="cb77-1375"><a href="#cb77-1375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1376"><a href="#cb77-1376" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-logit-predictions-slopes, fig.width=10, fig.height=6, out.width="100%"}</span></span>
<span id="cb77-1377"><a href="#cb77-1377" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-inset-right</span></span>
<span id="cb77-1378"><a href="#cb77-1378" aria-hidden="true" tabindex="-1"></a><span class="in">logit_slopes &lt;- model_logit_fancy |&gt; </span></span>
<span id="cb77-1379"><a href="#cb77-1379" aria-hidden="true" tabindex="-1"></a><span class="in">  emtrends(~ public_sector_corruption + region, var = "public_sector_corruption",</span></span>
<span id="cb77-1380"><a href="#cb77-1380" aria-hidden="true" tabindex="-1"></a><span class="in">           at = list(public_sector_corruption = c(20, 80),</span></span>
<span id="cb77-1381"><a href="#cb77-1381" aria-hidden="true" tabindex="-1"></a><span class="in">                     region = regions_to_use),</span></span>
<span id="cb77-1382"><a href="#cb77-1382" aria-hidden="true" tabindex="-1"></a><span class="in">           regrid = "response", delta.var = 0.001) |&gt; </span></span>
<span id="cb77-1383"><a href="#cb77-1383" aria-hidden="true" tabindex="-1"></a><span class="in">  as_tibble() |&gt; </span></span>
<span id="cb77-1384"><a href="#cb77-1384" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(panel = glue("Corruption set to {public_sector_corruption}"))</span></span>
<span id="cb77-1385"><a href="#cb77-1385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1386"><a href="#cb77-1386" aria-hidden="true" tabindex="-1"></a><span class="in">slopes_to_plot &lt;- logit_predictions |&gt; </span></span>
<span id="cb77-1387"><a href="#cb77-1387" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(public_sector_corruption %in% c(20, 80),</span></span>
<span id="cb77-1388"><a href="#cb77-1388" aria-hidden="true" tabindex="-1"></a><span class="in">         region %in% regions_to_use) |&gt; </span></span>
<span id="cb77-1389"><a href="#cb77-1389" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(select(logit_slopes, public_sector_corruption, region, public_sector_corruption.trend, panel),</span></span>
<span id="cb77-1390"><a href="#cb77-1390" aria-hidden="true" tabindex="-1"></a><span class="in">            by = c("public_sector_corruption", "region")) |&gt; </span></span>
<span id="cb77-1391"><a href="#cb77-1391" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(intercept = find_intercept(public_sector_corruption, prob, public_sector_corruption.trend)) |&gt; </span></span>
<span id="cb77-1392"><a href="#cb77-1392" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(round_slope = label_number(accuracy = 0.001, style_negative = "minus")(public_sector_corruption.trend * 100),</span></span>
<span id="cb77-1393"><a href="#cb77-1393" aria-hidden="true" tabindex="-1"></a><span class="in">         nice_slope = glue("Slope: {round_slope} pct pts"))</span></span>
<span id="cb77-1394"><a href="#cb77-1394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1395"><a href="#cb77-1395" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(logit_predictions, aes(x = public_sector_corruption, y = prob, color = region)) +</span></span>
<span id="cb77-1396"><a href="#cb77-1396" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(linewidth = 1) +</span></span>
<span id="cb77-1397"><a href="#cb77-1397" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(data = slopes_to_plot, size = 2, show.legend = FALSE) +</span></span>
<span id="cb77-1398"><a href="#cb77-1398" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_abline(data = slopes_to_plot, </span></span>
<span id="cb77-1399"><a href="#cb77-1399" aria-hidden="true" tabindex="-1"></a><span class="in">              aes(slope = public_sector_corruption.trend, intercept = intercept, color = region), </span></span>
<span id="cb77-1400"><a href="#cb77-1400" aria-hidden="true" tabindex="-1"></a><span class="in">              linewidth = 0.5, linetype = "21", show.legend = FALSE) +</span></span>
<span id="cb77-1401"><a href="#cb77-1401" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_label_repel(data = slopes_to_plot, aes(label = nice_slope),</span></span>
<span id="cb77-1402"><a href="#cb77-1402" aria-hidden="true" tabindex="-1"></a><span class="in">                   fontface = "bold", seed = 123, show.legend = FALSE,</span></span>
<span id="cb77-1403"><a href="#cb77-1403" aria-hidden="true" tabindex="-1"></a><span class="in">                   size = 3, direction = "y") +</span></span>
<span id="cb77-1404"><a href="#cb77-1404" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Public sector corruption", </span></span>
<span id="cb77-1405"><a href="#cb77-1405" aria-hidden="true" tabindex="-1"></a><span class="in">       y = "Predicted probability of having\na campaign finance disclosure law", </span></span>
<span id="cb77-1406"><a href="#cb77-1406" aria-hidden="true" tabindex="-1"></a><span class="in">       color = NULL) +</span></span>
<span id="cb77-1407"><a href="#cb77-1407" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_y_continuous(labels = percent_format()) +</span></span>
<span id="cb77-1408"><a href="#cb77-1408" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_color_manual(values = c("grey30", clrs)) +</span></span>
<span id="cb77-1409"><a href="#cb77-1409" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(vars(panel)) +</span></span>
<span id="cb77-1410"><a href="#cb77-1410" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_mfx() +</span></span>
<span id="cb77-1411"><a href="#cb77-1411" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = "bottom")</span></span>
<span id="cb77-1412"><a href="#cb77-1412" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1413"><a href="#cb77-1413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1414"><a href="#cb77-1414" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-logit-slopes-fancy-mer, include=FALSE}</span></span>
<span id="cb77-1415"><a href="#cb77-1415" aria-hidden="true" tabindex="-1"></a><span class="in">mfx_fancy_mer &lt;- slopes_to_plot |&gt; </span></span>
<span id="cb77-1416"><a href="#cb77-1416" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(term = paste0(region, public_sector_corruption, sep = "_"),</span></span>
<span id="cb77-1417"><a href="#cb77-1417" aria-hidden="true" tabindex="-1"></a><span class="in">         term = janitor::make_clean_names(term)) |&gt; </span></span>
<span id="cb77-1418"><a href="#cb77-1418" aria-hidden="true" tabindex="-1"></a><span class="in">  split(~ term)</span></span>
<span id="cb77-1419"><a href="#cb77-1419" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1420"><a href="#cb77-1420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1421"><a href="#cb77-1421" aria-hidden="true" tabindex="-1"></a>AHH this is delightful! This helps us understand and visualize all these marginal effects. Let's interpret them:</span>
<span id="cb77-1422"><a href="#cb77-1422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1423"><a href="#cb77-1423" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>In both the Middle East and Western Europe/North America, an increase in public sector corruption in countries with low levels of corruption (20) is associated with a <span class="in">`r mfx_fancy_mer$middle_east_and_north_africa20$round_slope`</span> and <span class="in">`r mfx_fancy_mer$western_europe_and_north_america20$round_slope`</span> percentage point decrease in the probability of seeing a disclosure law, while in low-corruption countries in Latin America, an increase in public sector corruption doesn't do much to the probability (it *increases* it slightly by <span class="in">`r mfx_fancy_mer$latin_america_and_the_caribbean20$round_slope`</span> percentage points)</span>
<span id="cb77-1424"><a href="#cb77-1424" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>In countries with high levels of corruption (80), on the other hand, a small increase in corruption doesn't do much to the probability of having a disclosure law in the Middle East (<span class="in">`r mfx_fancy_mer$middle_east_and_north_africa80$round_slope`</span> percentage point decrease) or Western Europe (<span class="in">`r mfx_fancy_mer$western_europe_and_north_america80$round_slope`</span> percentage point decrease). In Latin America, though, a small increase in corruption is associated with a <span class="in">`r mfx_fancy_mer$latin_america_and_the_caribbean80$round_slope`</span> percentage point decrease in the probability of having a disclosure law.</span>
<span id="cb77-1425"><a href="#cb77-1425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1426"><a href="#cb77-1426" aria-hidden="true" tabindex="-1"></a>**MAJOR CAVEAT**: None of these marginal effects are statistically significant, so there's a good chance that they're possibly zero, or positive, or more negative, or whatever. We can plot just these marginal slopes to show this:</span>
<span id="cb77-1427"><a href="#cb77-1427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1428"><a href="#cb77-1428" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-logit-mfx-coef-plot, height=3.5}</span></span>
<span id="cb77-1429"><a href="#cb77-1429" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(logit_slopes, aes(x = public_sector_corruption.trend * 100, y = region, color = region)) +</span></span>
<span id="cb77-1430"><a href="#cb77-1430" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0, linewidth = 0.5, linetype = "24", color = clrs[5]) +</span></span>
<span id="cb77-1431"><a href="#cb77-1431" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_pointrange(aes(xmin = asymp.LCL * 100, xmax = asymp.UCL * 100)) +</span></span>
<span id="cb77-1432"><a href="#cb77-1432" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_color_manual(values = c(clrs[4], clrs[1], clrs[2]), guide = "none") +</span></span>
<span id="cb77-1433"><a href="#cb77-1433" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Marginal effect (percentage points)", y = NULL) +</span></span>
<span id="cb77-1434"><a href="#cb77-1434" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(vars(panel), ncol = 1) +</span></span>
<span id="cb77-1435"><a href="#cb77-1435" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_mfx()</span></span>
<span id="cb77-1436"><a href="#cb77-1436" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1437"><a href="#cb77-1437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1438"><a href="#cb77-1438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1439"><a href="#cb77-1439" aria-hidden="true" tabindex="-1"></a><span class="fu">### Average marginal effects at counterfactual user-specified values</span></span>
<span id="cb77-1440"><a href="#cb77-1440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1441"><a href="#cb77-1441" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb77-1442"><a href="#cb77-1442" aria-hidden="true" tabindex="-1"></a><span class="fu">### Counterfactual grids in emmeans</span></span>
<span id="cb77-1443"><a href="#cb77-1443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1444"><a href="#cb77-1444" aria-hidden="true" tabindex="-1"></a>When I first wrote this in 2022, **emmeans** did not have support for counterfactual grids, but **marginaleffects** did, so here I only show this example with **marginaleffects**. Later in 2022, however, [**emmeans** added a `counterfactuals` argument to `ref_grid()`](https://cran.r-project.org/web/packages/emmeans/vignettes/messy-data.html#counterfact), so you can actually calculate these same average marginal effects at counterfactual user-specified values with both **marginaleffects** and **emmeans** now.</span>
<span id="cb77-1445"><a href="#cb77-1445" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb77-1446"><a href="#cb77-1446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1447"><a href="#cb77-1447" aria-hidden="true" tabindex="-1"></a>Calculating marginal effects at representative values is useful and widespread—plugging different values into the model while holding others constant is the best way to see how all the different moving parts of a model work, especially when there interactions, exponents, or non-linear outcomes. We're using the full mixing panel here!</span>
<span id="cb77-1448"><a href="#cb77-1448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1449"><a href="#cb77-1449" aria-hidden="true" tabindex="-1"></a>However, creating a hypothetical data or reference grid creates hypothetical observations that might never exist in real life. This was the main difference behind the average marginal effect (AME) and the marginal effect at the mean (MEM) that we looked at earlier. Passing average covariate values into a model creates average predictions, but those averages might not reflect reality.</span>
<span id="cb77-1450"><a href="#cb77-1450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1451"><a href="#cb77-1451" aria-hidden="true" tabindex="-1"></a>For example, we used this data grid to look at the effect of corruption on the probability of having a campaign finance disclosure law across different regions:</span>
<span id="cb77-1452"><a href="#cb77-1452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1453"><a href="#cb77-1453" aria-hidden="true" tabindex="-1"></a><span class="in">```{r grid-datagrid-again}</span></span>
<span id="cb77-1454"><a href="#cb77-1454" aria-hidden="true" tabindex="-1"></a><span class="in">datagrid(model = model_logit_fancy,</span></span>
<span id="cb77-1455"><a href="#cb77-1455" aria-hidden="true" tabindex="-1"></a><span class="in">         public_sector_corruption = c(20, 80),</span></span>
<span id="cb77-1456"><a href="#cb77-1456" aria-hidden="true" tabindex="-1"></a><span class="in">         region = regions_to_use)</span></span>
<span id="cb77-1457"><a href="#cb77-1457" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1458"><a href="#cb77-1458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1459"><a href="#cb77-1459" aria-hidden="true" tabindex="-1"></a>Polyarchy (democracy) and GDP per capita here are set at their dataset-level means, but that's not how the world actually works. Levels of democracy and personal wealth vary *a lot* by region:</span>
<span id="cb77-1460"><a href="#cb77-1460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1461"><a href="#cb77-1461" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-avg-polyarchy-gdp}</span></span>
<span id="cb77-1462"><a href="#cb77-1462" aria-hidden="true" tabindex="-1"></a><span class="in">corruption |&gt; </span></span>
<span id="cb77-1463"><a href="#cb77-1463" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(region %in% regions_to_use) |&gt; </span></span>
<span id="cb77-1464"><a href="#cb77-1464" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(region) |&gt; </span></span>
<span id="cb77-1465"><a href="#cb77-1465" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(avg_polyarchy = mean(polyarchy),</span></span>
<span id="cb77-1466"><a href="#cb77-1466" aria-hidden="true" tabindex="-1"></a><span class="in">            avg_log_gdp_percapita = mean(log_gdp_percapita))</span></span>
<span id="cb77-1467"><a href="#cb77-1467" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1468"><a href="#cb77-1468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1469"><a href="#cb77-1469" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-avg-polyarchy-gdp, include=FALSE}</span></span>
<span id="cb77-1470"><a href="#cb77-1470" aria-hidden="true" tabindex="-1"></a><span class="in">avg_region &lt;- corruption |&gt; </span></span>
<span id="cb77-1471"><a href="#cb77-1471" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(region %in% regions_to_use) |&gt; </span></span>
<span id="cb77-1472"><a href="#cb77-1472" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(region) |&gt; </span></span>
<span id="cb77-1473"><a href="#cb77-1473" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(avg_polyarchy = mean(polyarchy),</span></span>
<span id="cb77-1474"><a href="#cb77-1474" aria-hidden="true" tabindex="-1"></a><span class="in">            avg_log_gdp_percapita = mean(log_gdp_percapita)) |&gt; </span></span>
<span id="cb77-1475"><a href="#cb77-1475" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(clean_polyarchy = nice_number(avg_polyarchy)) |&gt; </span></span>
<span id="cb77-1476"><a href="#cb77-1476" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(region = janitor::make_clean_names(region)) |&gt; </span></span>
<span id="cb77-1477"><a href="#cb77-1477" aria-hidden="true" tabindex="-1"></a><span class="in">  split(~ region)</span></span>
<span id="cb77-1478"><a href="#cb77-1478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1479"><a href="#cb77-1479" aria-hidden="true" tabindex="-1"></a><span class="in">avg_polyarchy_overall &lt;- datagrid(model = model_logit_fancy,</span></span>
<span id="cb77-1480"><a href="#cb77-1480" aria-hidden="true" tabindex="-1"></a><span class="in">                                  public_sector_corruption = c(20, 80),</span></span>
<span id="cb77-1481"><a href="#cb77-1481" aria-hidden="true" tabindex="-1"></a><span class="in">                                  region = regions_to_use) |&gt; </span></span>
<span id="cb77-1482"><a href="#cb77-1482" aria-hidden="true" tabindex="-1"></a><span class="in">  slice(1) |&gt; </span></span>
<span id="cb77-1483"><a href="#cb77-1483" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(polyarchy = nice_number(polyarchy)) |&gt; </span></span>
<span id="cb77-1484"><a href="#cb77-1484" aria-hidden="true" tabindex="-1"></a><span class="in">  pull(polyarchy)</span></span>
<span id="cb77-1485"><a href="#cb77-1485" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1486"><a href="#cb77-1486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1487"><a href="#cb77-1487" aria-hidden="true" tabindex="-1"></a>Western Europe is far more democratic (average polyarchy = <span class="in">`r avg_region$western_europe_and_north_america$clean_polyarchy`</span>) than the Middle East (average polyarchy = <span class="in">`r avg_region$middle_east_and_north_africa$clean_polyarchy`</span>). But in our calculations for finding region-specific marginal effects, we've been using a polyarchy value of <span class="in">`r avg_polyarchy_overall`</span> for all the regions.</span>
<span id="cb77-1488"><a href="#cb77-1488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1489"><a href="#cb77-1489" aria-hidden="true" tabindex="-1"></a>Fortunately we can do something neat to work with observed covariate values and thus create an AME-flavored marginal effect at representative values instead of the current MEM-flavored marginal effect at representative values. Here's the general process:</span>
<span id="cb77-1490"><a href="#cb77-1490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1491"><a href="#cb77-1491" aria-hidden="true" tabindex="-1"></a><span class="in">```{r flow-counterfactual, echo=FALSE, out.width="100%", fig.align="center"}</span></span>
<span id="cb77-1492"><a href="#cb77-1492" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-inset-right</span></span>
<span id="cb77-1493"><a href="#cb77-1493" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::include_graphics("images/flow-counterfactual@3x.png")</span></span>
<span id="cb77-1494"><a href="#cb77-1494" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1495"><a href="#cb77-1495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1496"><a href="#cb77-1496" aria-hidden="true" tabindex="-1"></a>Instead of creating a data or reference grid, we create multiple copies of our original dataset. In each copy we change the columns that we want to set to specific values and we leave all the other columns at their original values. We then feed all the copies of the dataset into the model and generate a ton of fitted values, which we *then* collapse into average effects.</span>
<span id="cb77-1497"><a href="#cb77-1497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1498"><a href="#cb77-1498" aria-hidden="true" tabindex="-1"></a>That sounds really complex, but it's only a matter of adding one argument to <span class="in">`marginaleffects::datagrid()`</span>. We'll take <span class="in">`region`</span> out of <span class="in">`datagrid`</span> here so that we keep all the original regions—we'll take the average across those regions after the fact.</span>
<span id="cb77-1499"><a href="#cb77-1499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1500"><a href="#cb77-1500" aria-hidden="true" tabindex="-1"></a><span class="in">```{r create-cfct-data}</span></span>
<span id="cb77-1501"><a href="#cb77-1501" aria-hidden="true" tabindex="-1"></a><span class="in">cfct_data &lt;- datagrid(model = model_logit_fancy,</span></span>
<span id="cb77-1502"><a href="#cb77-1502" aria-hidden="true" tabindex="-1"></a><span class="in">                      public_sector_corruption = c(20, 80),</span></span>
<span id="cb77-1503"><a href="#cb77-1503" aria-hidden="true" tabindex="-1"></a><span class="in">                      grid_type = "counterfactual")</span></span>
<span id="cb77-1504"><a href="#cb77-1504" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1505"><a href="#cb77-1505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1506"><a href="#cb77-1506" aria-hidden="true" tabindex="-1"></a>This new data grid has twice the number of rows that we have in the original data, since there are now two copies of the data stacked together:</span>
<span id="cb77-1507"><a href="#cb77-1507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1508"><a href="#cb77-1508" aria-hidden="true" tabindex="-1"></a><span class="in">```{r nrow-cfct}</span></span>
<span id="cb77-1509"><a href="#cb77-1509" aria-hidden="true" tabindex="-1"></a><span class="in">nrow(corruption)</span></span>
<span id="cb77-1510"><a href="#cb77-1510" aria-hidden="true" tabindex="-1"></a><span class="in">nrow(cfct_data)</span></span>
<span id="cb77-1511"><a href="#cb77-1511" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1512"><a href="#cb77-1512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1513"><a href="#cb77-1513" aria-hidden="true" tabindex="-1"></a>To verify, lets look at the first 5 rows in each of the copies:</span>
<span id="cb77-1514"><a href="#cb77-1514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1515"><a href="#cb77-1515" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-stack-cfct}</span></span>
<span id="cb77-1516"><a href="#cb77-1516" aria-hidden="true" tabindex="-1"></a><span class="in">cfct_data[c(1:5, nrow(corruption) + 1:5), ]</span></span>
<span id="cb77-1517"><a href="#cb77-1517" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1518"><a href="#cb77-1518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1519"><a href="#cb77-1519" aria-hidden="true" tabindex="-1"></a>That's neat! These 5 countries all have their original values of polyarchy, GDP per capita, and region, but have their public sector corruption indexes set to 20 (in the first copy) and 80 (in the second copy).</span>
<span id="cb77-1520"><a href="#cb77-1520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1521"><a href="#cb77-1521" aria-hidden="true" tabindex="-1"></a>We can feed this stacked data to <span class="in">`slopes()`</span> to get an instantaneous slope (<span class="in">`estimate`</span>) for each row:</span>
<span id="cb77-1522"><a href="#cb77-1522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1523"><a href="#cb77-1523" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mfx-cfct}</span></span>
<span id="cb77-1524"><a href="#cb77-1524" aria-hidden="true" tabindex="-1"></a><span class="in"># Specify variables = "public_sector_corruption" so that it doesn't calculate</span></span>
<span id="cb77-1525"><a href="#cb77-1525" aria-hidden="true" tabindex="-1"></a><span class="in"># slopes and contrasts for all the other covariates</span></span>
<span id="cb77-1526"><a href="#cb77-1526" aria-hidden="true" tabindex="-1"></a><span class="in">mfx_cfct &lt;- model_logit_fancy |&gt; </span></span>
<span id="cb77-1527"><a href="#cb77-1527" aria-hidden="true" tabindex="-1"></a><span class="in">  slopes(newdata = datagrid(public_sector_corruption = c(20, 80),</span></span>
<span id="cb77-1528"><a href="#cb77-1528" aria-hidden="true" tabindex="-1"></a><span class="in">                            grid_type = "counterfactual"),</span></span>
<span id="cb77-1529"><a href="#cb77-1529" aria-hidden="true" tabindex="-1"></a><span class="in">         variables = "public_sector_corruption")</span></span>
<span id="cb77-1530"><a href="#cb77-1530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1531"><a href="#cb77-1531" aria-hidden="true" tabindex="-1"></a><span class="in">head(mfx_cfct)</span></span>
<span id="cb77-1532"><a href="#cb77-1532" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1533"><a href="#cb77-1533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1534"><a href="#cb77-1534" aria-hidden="true" tabindex="-1"></a>Finally we can calculate group averages for each of the levels of <span class="in">`public_sector_corruption`</span> to get AME-flavored effects:</span>
<span id="cb77-1535"><a href="#cb77-1535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1536"><a href="#cb77-1536" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mfx-cfct-dplyr}</span></span>
<span id="cb77-1537"><a href="#cb77-1537" aria-hidden="true" tabindex="-1"></a><span class="in">mfx_cfct |&gt; </span></span>
<span id="cb77-1538"><a href="#cb77-1538" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(public_sector_corruption) |&gt; </span></span>
<span id="cb77-1539"><a href="#cb77-1539" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(avg_slope = mean(estimate))</span></span>
<span id="cb77-1540"><a href="#cb77-1540" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1541"><a href="#cb77-1541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1542"><a href="#cb77-1542" aria-hidden="true" tabindex="-1"></a>Or we can let **marginaleffects** deal with the averaging so that we can get standard errors and confidence intervals:</span>
<span id="cb77-1543"><a href="#cb77-1543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1544"><a href="#cb77-1544" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mfx-cfct-mfx}</span></span>
<span id="cb77-1545"><a href="#cb77-1545" aria-hidden="true" tabindex="-1"></a><span class="in">model_logit_fancy |&gt; </span></span>
<span id="cb77-1546"><a href="#cb77-1546" aria-hidden="true" tabindex="-1"></a><span class="in">  avg_slopes(newdata = datagrid(public_sector_corruption = c(20, 80),</span></span>
<span id="cb77-1547"><a href="#cb77-1547" aria-hidden="true" tabindex="-1"></a><span class="in">                                grid_type = "counterfactual"),</span></span>
<span id="cb77-1548"><a href="#cb77-1548" aria-hidden="true" tabindex="-1"></a><span class="in">             variables = "public_sector_corruption",</span></span>
<span id="cb77-1549"><a href="#cb77-1549" aria-hidden="true" tabindex="-1"></a><span class="in">             by = "public_sector_corruption")</span></span>
<span id="cb77-1550"><a href="#cb77-1550" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1551"><a href="#cb77-1551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1552"><a href="#cb77-1552" aria-hidden="true" tabindex="-1"></a>We can also calculate group averages across each region to get region-specific AME-flavored effects:</span>
<span id="cb77-1553"><a href="#cb77-1553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1554"><a href="#cb77-1554" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mfx-cfct-game-dplyr}</span></span>
<span id="cb77-1555"><a href="#cb77-1555" aria-hidden="true" tabindex="-1"></a><span class="in">mfx_cfct |&gt; </span></span>
<span id="cb77-1556"><a href="#cb77-1556" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(region %in% regions_to_use) |&gt; </span></span>
<span id="cb77-1557"><a href="#cb77-1557" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(public_sector_corruption, region) |&gt; </span></span>
<span id="cb77-1558"><a href="#cb77-1558" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(avg_slope = mean(estimate))</span></span>
<span id="cb77-1559"><a href="#cb77-1559" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1560"><a href="#cb77-1560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1561"><a href="#cb77-1561" aria-hidden="true" tabindex="-1"></a>Or again, we can get standard errors and confidence intervals:</span>
<span id="cb77-1562"><a href="#cb77-1562" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1563"><a href="#cb77-1563" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mfx-cfct-game-mfx}</span></span>
<span id="cb77-1564"><a href="#cb77-1564" aria-hidden="true" tabindex="-1"></a><span class="in">model_logit_fancy |&gt; </span></span>
<span id="cb77-1565"><a href="#cb77-1565" aria-hidden="true" tabindex="-1"></a><span class="in">  avg_slopes(newdata = datagrid(public_sector_corruption = c(20, 80),</span></span>
<span id="cb77-1566"><a href="#cb77-1566" aria-hidden="true" tabindex="-1"></a><span class="in">                                grid_type = "counterfactual"),</span></span>
<span id="cb77-1567"><a href="#cb77-1567" aria-hidden="true" tabindex="-1"></a><span class="in">             variables = "public_sector_corruption",</span></span>
<span id="cb77-1568"><a href="#cb77-1568" aria-hidden="true" tabindex="-1"></a><span class="in">             by = c("public_sector_corruption", "region"))</span></span>
<span id="cb77-1569"><a href="#cb77-1569" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1570"><a href="#cb77-1570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1571"><a href="#cb77-1571" aria-hidden="true" tabindex="-1"></a>Let's compare these counterfactual marginal effects with the region-specific marginal effects at representative values that we calculated earlier:</span>
<span id="cb77-1572"><a href="#cb77-1572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1573"><a href="#cb77-1573" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-cfx-coef-plot, warning=FALSE, height=3.5}</span></span>
<span id="cb77-1574"><a href="#cb77-1574" aria-hidden="true" tabindex="-1"></a><span class="in">ame_flavored &lt;- model_logit_fancy |&gt; </span></span>
<span id="cb77-1575"><a href="#cb77-1575" aria-hidden="true" tabindex="-1"></a><span class="in">  slopes(newdata = datagrid(public_sector_corruption = c(20, 80),</span></span>
<span id="cb77-1576"><a href="#cb77-1576" aria-hidden="true" tabindex="-1"></a><span class="in">                            grid_type = "counterfactual"),</span></span>
<span id="cb77-1577"><a href="#cb77-1577" aria-hidden="true" tabindex="-1"></a><span class="in">         variables = "public_sector_corruption",</span></span>
<span id="cb77-1578"><a href="#cb77-1578" aria-hidden="true" tabindex="-1"></a><span class="in">         by = c("public_sector_corruption", "region")) |&gt; </span></span>
<span id="cb77-1579"><a href="#cb77-1579" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(region %in% regions_to_use)</span></span>
<span id="cb77-1580"><a href="#cb77-1580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1581"><a href="#cb77-1581" aria-hidden="true" tabindex="-1"></a><span class="in">mem_flavored &lt;- model_logit_fancy |&gt; </span></span>
<span id="cb77-1582"><a href="#cb77-1582" aria-hidden="true" tabindex="-1"></a><span class="in">  slopes(newdata = datagrid(public_sector_corruption = c(20, 80),</span></span>
<span id="cb77-1583"><a href="#cb77-1583" aria-hidden="true" tabindex="-1"></a><span class="in">                            region = regions_to_use),</span></span>
<span id="cb77-1584"><a href="#cb77-1584" aria-hidden="true" tabindex="-1"></a><span class="in">         variables = "public_sector_corruption",</span></span>
<span id="cb77-1585"><a href="#cb77-1585" aria-hidden="true" tabindex="-1"></a><span class="in">         by = c("public_sector_corruption", "region"))</span></span>
<span id="cb77-1586"><a href="#cb77-1586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1587"><a href="#cb77-1587" aria-hidden="true" tabindex="-1"></a><span class="in">mfx_to_plot &lt;- bind_rows(`Counterfactual stacked data` = ame_flavored, </span></span>
<span id="cb77-1588"><a href="#cb77-1588" aria-hidden="true" tabindex="-1"></a><span class="in">                         `Average values` = mem_flavored, </span></span>
<span id="cb77-1589"><a href="#cb77-1589" aria-hidden="true" tabindex="-1"></a><span class="in">                         .id = "approach") |&gt; </span></span>
<span id="cb77-1590"><a href="#cb77-1590" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(panel = glue("Corruption set to {public_sector_corruption}"))</span></span>
<span id="cb77-1591"><a href="#cb77-1591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1592"><a href="#cb77-1592" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(mfx_to_plot, aes(x = estimate * 100, y = region, color = region, </span></span>
<span id="cb77-1593"><a href="#cb77-1593" aria-hidden="true" tabindex="-1"></a><span class="in">                        linetype = approach, shape = approach)) +</span></span>
<span id="cb77-1594"><a href="#cb77-1594" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0, linewidth = 0.5, linetype = "24", color = clrs[5]) +</span></span>
<span id="cb77-1595"><a href="#cb77-1595" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_pointrange(aes(xmin = conf.low * 100, xmax = conf.high * 100),</span></span>
<span id="cb77-1596"><a href="#cb77-1596" aria-hidden="true" tabindex="-1"></a><span class="in">                  position = position_dodge(width = -0.6)) +</span></span>
<span id="cb77-1597"><a href="#cb77-1597" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_color_manual(values = c(clrs[4], clrs[1], clrs[2]), guide = "none") +</span></span>
<span id="cb77-1598"><a href="#cb77-1598" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Marginal effect (percentage points)", y = NULL, linetype = NULL, shape = NULL) +</span></span>
<span id="cb77-1599"><a href="#cb77-1599" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(vars(panel), ncol = 1) +</span></span>
<span id="cb77-1600"><a href="#cb77-1600" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_mfx() +</span></span>
<span id="cb77-1601"><a href="#cb77-1601" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = "bottom")</span></span>
<span id="cb77-1602"><a href="#cb77-1602" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1603"><a href="#cb77-1603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1604"><a href="#cb77-1604" aria-hidden="true" tabindex="-1"></a>In this case there are no huge differences <span class="in">`r emoji::emoji("shrug")`</span>. BUT STILL this is really neat!</span>
<span id="cb77-1605"><a href="#cb77-1605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1606"><a href="#cb77-1606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1607"><a href="#cb77-1607" aria-hidden="true" tabindex="-1"></a><span class="fu">## Categorical contrasts as statistical/marginal effects</span></span>
<span id="cb77-1608"><a href="#cb77-1608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1609"><a href="#cb77-1609" aria-hidden="true" tabindex="-1"></a>Confusingly, people sometimes also use the term "marginal effect" to talk about group averages or predicted values (<span class="co">[</span><span class="ot">I myself am guilty of this!</span><span class="co">](https://datavizs21.classes.andrewheiss.com/example/07-example/#marginal-effects-plots)</span>). Technically speaking, a marginal effect is only a partial derivative, or a slope—not a predicted value or a difference in group means.</span>
<span id="cb77-1610"><a href="#cb77-1610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1611"><a href="#cb77-1611" aria-hidden="true" tabindex="-1"></a>But regression lends itself well to group means, and predictions and fitted values are fundamental to calculating instantaneous slopes, so both **marginaleffects** and **emmeans** are used for adjusted predictions and marginal means and contrasts. They also use different approaches for calculating these averages, either averaging before putting values in the model (**emmeans**) or averaging after (**marginaleffects**'s default setting).</span>
<span id="cb77-1612"><a href="#cb77-1612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1613"><a href="#cb77-1613" aria-hidden="true" tabindex="-1"></a>We've already seen two different functions for generating predictions when we plotted the predicted probabilities of having a disclosure law for each region: <span class="in">`marginaleffects::predictions()`</span> and <span class="in">`emmeans::emmeans()`</span>.</span>
<span id="cb77-1614"><a href="#cb77-1614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1615"><a href="#cb77-1615" aria-hidden="true" tabindex="-1"></a>I won't go into a ton of detail here about the differences between the two approaches to predictions and contrasts, mostly because pretty much everything we've looked at so far applies to both. Instead, you should look at Vincent's excellent vignettes for **marginaleffects**:</span>
<span id="cb77-1616"><a href="#cb77-1616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1617"><a href="#cb77-1617" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Predictions</span><span class="co">](https://marginaleffects.com/articles/predictions.html)</span></span>
<span id="cb77-1618"><a href="#cb77-1618" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Comparisons</span><span class="co">](https://marginaleffects.com/articles/comparisons.html)</span></span>
<span id="cb77-1619"><a href="#cb77-1619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1620"><a href="#cb77-1620" aria-hidden="true" tabindex="-1"></a>And the equally excellent vignettes for **emmeans**:</span>
<span id="cb77-1621"><a href="#cb77-1621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1622"><a href="#cb77-1622" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Prediction in emmeans</span><span class="co">](https://cran.r-project.org/web/packages/emmeans/vignettes/predictions.html)</span></span>
<span id="cb77-1623"><a href="#cb77-1623" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Comparisons and contrasts in emmeans</span><span class="co">](https://cran.r-project.org/web/packages/emmeans/vignettes/comparisons.html)</span></span>
<span id="cb77-1624"><a href="#cb77-1624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1625"><a href="#cb77-1625" aria-hidden="true" tabindex="-1"></a>You should also check out <span class="co">[</span><span class="ot">this Twitter thread tutorial</span><span class="co">](https://twitter.com/alexpghayes/status/1282869973006909441)</span> by <span class="co">[</span><span class="ot">Alex Hayes</span><span class="co">](https://www.alexpghayes.com/)</span> on categorical contrasts and means—it's a fantastic illustration of this same process.</span>
<span id="cb77-1626"><a href="#cb77-1626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1627"><a href="#cb77-1627" aria-hidden="true" tabindex="-1"></a>In general, the two packages follow the same overall approach that we've seen with <span class="in">`slopes()`</span> and <span class="in">`emtrends()`</span>:</span>
<span id="cb77-1628"><a href="#cb77-1628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1629"><a href="#cb77-1629" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Prediction and comparison functions in **marginaleffects** try to calculate predictions and averages for each row, then collapses them to single average values (either globally or for specific groups). This approach is AME-flavored (though **marginaleffects** can also do MEM-flavored operations and average first).</span>
<span id="cb77-1630"><a href="#cb77-1630" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Prediction and contrast functions in **emmeans** collapse values into averages first, then feeds those average values into the model to generate average predictions and means (either globally or for specific groups). This approach is MEM-flavored.</span>
<span id="cb77-1631"><a href="#cb77-1631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1632"><a href="#cb77-1632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1633"><a href="#cb77-1633" aria-hidden="true" tabindex="-1"></a><span class="fu">## tl;dr: Overall summary of all these marginal effects approaches</span></span>
<span id="cb77-1634"><a href="#cb77-1634" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1635"><a href="#cb77-1635" aria-hidden="true" tabindex="-1"></a>***PHEW*** we just did a lot of marginal work. This is important stuff. Unless you're working with a linear OLS model without any fancy extra things like interactions, polynomials, logs, and so on, **don't try to talk about marginal effects based on just the output of a regression table—it's not possible unless you do a lot of manual math!**</span>
<span id="cb77-1636"><a href="#cb77-1636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1637"><a href="#cb77-1637" aria-hidden="true" tabindex="-1"></a>Both **marginaleffects** and **emmeans** provide all sorts of neat and powerful ways to calculate marginal effects without needing to resort to calculus, but as we've seen here, there are some subtle and extremely important differences in how they calculate their different effects.</span>
<span id="cb77-1638"><a href="#cb77-1638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1639"><a href="#cb77-1639" aria-hidden="true" tabindex="-1"></a>The main takeaway from this whole post is this: **If you take the average *before* plugging values into the model, you compute average marginal effects for a combination of covariates that might not actually exist in reality. If you take the average *after* plugging values into the model, each original observation reflects combinations of covariates that definitely exist in reality, so the average marginal effect reflects that reality.**</span>
<span id="cb77-1640"><a href="#cb77-1640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1641"><a href="#cb77-1641" aria-hidden="true" tabindex="-1"></a>To remember all these differences, here's a table summarizing all their different approaches:</span>
<span id="cb77-1642"><a href="#cb77-1642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1643"><a href="#cb77-1643" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fancy-comparison-table, echo=FALSE, message=FALSE}</span></span>
<span id="cb77-1644"><a href="#cb77-1644" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-inset-right</span></span>
<span id="cb77-1645"><a href="#cb77-1645" aria-hidden="true" tabindex="-1"></a><span class="in">library(kableExtra)</span></span>
<span id="cb77-1646"><a href="#cb77-1646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1647"><a href="#cb77-1647" aria-hidden="true" tabindex="-1"></a><span class="in">wrap_r &lt;- function(x) glue('&lt;pre class="r smaller"&gt;&lt;code&gt;{x}&lt;/code&gt;&lt;/pre&gt;')</span></span>
<span id="cb77-1648"><a href="#cb77-1648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1649"><a href="#cb77-1649" aria-hidden="true" tabindex="-1"></a><span class="in">cfct &lt;- r"{slopes(</span></span>
<span id="cb77-1650"><a href="#cb77-1650" aria-hidden="true" tabindex="-1"></a><span class="in">  model,</span></span>
<span id="cb77-1651"><a href="#cb77-1651" aria-hidden="true" tabindex="-1"></a><span class="in">  newdata = datagrid(</span></span>
<span id="cb77-1652"><a href="#cb77-1652" aria-hidden="true" tabindex="-1"></a><span class="in">    some_x = c(10, 20),</span></span>
<span id="cb77-1653"><a href="#cb77-1653" aria-hidden="true" tabindex="-1"></a><span class="in">    grid_type = "counterfactual"</span></span>
<span id="cb77-1654"><a href="#cb77-1654" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb77-1655"><a href="#cb77-1655" aria-hidden="true" tabindex="-1"></a><span class="in">)}"</span></span>
<span id="cb77-1656"><a href="#cb77-1656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1657"><a href="#cb77-1657" aria-hidden="true" tabindex="-1"></a><span class="in">cfct_emmeans &lt;- r"{emtrends(</span></span>
<span id="cb77-1658"><a href="#cb77-1658" aria-hidden="true" tabindex="-1"></a><span class="in">  model, "some_x",</span></span>
<span id="cb77-1659"><a href="#cb77-1659" aria-hidden="true" tabindex="-1"></a><span class="in">  counterfactuals = "some_x"</span></span>
<span id="cb77-1660"><a href="#cb77-1660" aria-hidden="true" tabindex="-1"></a><span class="in">)}"</span></span>
<span id="cb77-1661"><a href="#cb77-1661" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1662"><a href="#cb77-1662" aria-hidden="true" tabindex="-1"></a><span class="in">mer_mfx &lt;- r"{slopes(</span></span>
<span id="cb77-1663"><a href="#cb77-1663" aria-hidden="true" tabindex="-1"></a><span class="in">  model,</span></span>
<span id="cb77-1664"><a href="#cb77-1664" aria-hidden="true" tabindex="-1"></a><span class="in">  newdata = datagrid(some_x = c(10, 20))</span></span>
<span id="cb77-1665"><a href="#cb77-1665" aria-hidden="true" tabindex="-1"></a><span class="in">)}"</span></span>
<span id="cb77-1666"><a href="#cb77-1666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1667"><a href="#cb77-1667" aria-hidden="true" tabindex="-1"></a><span class="in">mer_emmeans &lt;- r"{emtrends(</span></span>
<span id="cb77-1668"><a href="#cb77-1668" aria-hidden="true" tabindex="-1"></a><span class="in">  model, ...,</span></span>
<span id="cb77-1669"><a href="#cb77-1669" aria-hidden="true" tabindex="-1"></a><span class="in">  at = list(some_x = c(10, 20))</span></span>
<span id="cb77-1670"><a href="#cb77-1670" aria-hidden="true" tabindex="-1"></a><span class="in">)}"</span></span>
<span id="cb77-1671"><a href="#cb77-1671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1672"><a href="#cb77-1672" aria-hidden="true" tabindex="-1"></a><span class="in">tribble(</span></span>
<span id="cb77-1673"><a href="#cb77-1673" aria-hidden="true" tabindex="-1"></a><span class="in">  ~Type, ~Process, ~marginaleffects, ~emmeans,</span></span>
<span id="cb77-1674"><a href="#cb77-1674" aria-hidden="true" tabindex="-1"></a><span class="in">  "Average marginal effects (AME)", "Generate predictions for each row of the original data, then collapse to averages", wrap_r("avg_slopes(model)"), "Not supported",</span></span>
<span id="cb77-1675"><a href="#cb77-1675" aria-hidden="true" tabindex="-1"></a><span class="in">  "Group average marginal effects (G-AME)", "Generate predictions for each row of the original data, then collapse to grouped averages", wrap_r('avg_slopes(model, by = "some_group")'), "Not supported",</span></span>
<span id="cb77-1676"><a href="#cb77-1676" aria-hidden="true" tabindex="-1"></a><span class="in">  "Marginal effects at the mean (MEM)", "Collapse data to averages, then generate predictions using those averages", wrap_r('avg_slopes(model, newdata = "mean")'), wrap_r("emtrends(model, ...)"),</span></span>
<span id="cb77-1677"><a href="#cb77-1677" aria-hidden="true" tabindex="-1"></a><span class="in">  "Marginal effects at user-specified or representative values (MER)", "Create a grid of specific and average or typical values, then generate predictions", wrap_r(mer_mfx), wrap_r(mer_emmeans),</span></span>
<span id="cb77-1678"><a href="#cb77-1678" aria-hidden="true" tabindex="-1"></a><span class="in">  "Average marginal effects at counterfactual user-specified values", "Create multiple copies of the original data with some columns set to specific values, then generate predictions for each row of each copy of the original data, then collapse to averages", wrap_r(cfct), wrap_r(cfct_emmeans)</span></span>
<span id="cb77-1679"><a href="#cb77-1679" aria-hidden="true" tabindex="-1"></a><span class="in">) |&gt;</span></span>
<span id="cb77-1680"><a href="#cb77-1680" aria-hidden="true" tabindex="-1"></a><span class="in">  kbl(table.attr = "style='font-size:80%;'", escape = FALSE) |&gt;</span></span>
<span id="cb77-1681"><a href="#cb77-1681" aria-hidden="true" tabindex="-1"></a><span class="in">  kable_styling() |&gt;</span></span>
<span id="cb77-1682"><a href="#cb77-1682" aria-hidden="true" tabindex="-1"></a><span class="in">  column_spec(1, width = "15%") |&gt;</span></span>
<span id="cb77-1683"><a href="#cb77-1683" aria-hidden="true" tabindex="-1"></a><span class="in">  column_spec(2, width = "25%") |&gt;</span></span>
<span id="cb77-1684"><a href="#cb77-1684" aria-hidden="true" tabindex="-1"></a><span class="in">  column_spec(3:4, width = "30%")</span></span>
<span id="cb77-1685"><a href="#cb77-1685" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1686"><a href="#cb77-1686" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1687"><a href="#cb77-1687" aria-hidden="true" tabindex="-1"></a>And here's an image with all five of the diagrams at the same time:</span>
<span id="cb77-1688"><a href="#cb77-1688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1689"><a href="#cb77-1689" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb77-1690"><a href="#cb77-1690" aria-hidden="true" tabindex="-1"></a><span class="fu">### Diagrams!</span></span>
<span id="cb77-1691"><a href="#cb77-1691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1692"><a href="#cb77-1692" aria-hidden="true" tabindex="-1"></a>You can download PDF, SVG, and PNG versions of the marginal effects diagrams in this guide, as well as the original Adobe Illustrator file, here:</span>
<span id="cb77-1693"><a href="#cb77-1693" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1694"><a href="#cb77-1694" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">PDFs, SVGs, and PNGs</span><span class="co">](http://files.andrewheiss.com/marginal-effects-diagrams/marginal-effects-output.zip)</span></span>
<span id="cb77-1695"><a href="#cb77-1695" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Illustrator .ai file</span><span class="co">](http://files.andrewheiss.com/marginal-effects-diagrams/marginal-effects.ai)</span></span>
<span id="cb77-1696"><a href="#cb77-1696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1697"><a href="#cb77-1697" aria-hidden="true" tabindex="-1"></a>Do whatever you want with them! They're licensed under <span class="co">[</span><span class="ot">Creative Commons Attribution-ShareAlike (BY-SA 4.0)</span><span class="co">](http://creativecommons.org/licenses/by-sa/4.0/)</span>.</span>
<span id="cb77-1698"><a href="#cb77-1698" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb77-1699"><a href="#cb77-1699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1700"><a href="#cb77-1700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1701"><a href="#cb77-1701" aria-hidden="true" tabindex="-1"></a><span class="in">```{r flow-everything, echo=FALSE, out.width="100%", fig.align="center"}</span></span>
<span id="cb77-1702"><a href="#cb77-1702" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-inset-right</span></span>
<span id="cb77-1703"><a href="#cb77-1703" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::include_graphics("images/flow-everything@3x.png")</span></span>
<span id="cb77-1704"><a href="#cb77-1704" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb77-1705"><a href="#cb77-1705" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1706"><a href="#cb77-1706" aria-hidden="true" tabindex="-1"></a><span class="fu">## Which approach is best?</span></span>
<span id="cb77-1707"><a href="#cb77-1707" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1708"><a href="#cb77-1708" aria-hidden="true" tabindex="-1"></a>Who even knows. </span>
<span id="cb77-1709"><a href="#cb77-1709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1710"><a href="#cb77-1710" aria-hidden="true" tabindex="-1"></a>Both kinds of averaging approaches are pretty widespread. The <span class="co">[</span><span class="ot">**tidymodels** ecosystem</span><span class="co">](https://www.tidymodels.org/)</span> encourages the use of <span class="in">`modelr::data_grid()`</span> and plugging various combinations of specific and typical variables into models to look at slopes and group contrasts. That's marginal effects at the mean (MEM) and marginal effects at representative values (MER), which both use average values before putting them in model. And it's fine—**tidymodels** is used in data science production pipelines around the world.</span>
<span id="cb77-1711"><a href="#cb77-1711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1712"><a href="#cb77-1712" aria-hidden="true" tabindex="-1"></a>**emmeans** is also incredibly popular in data science and academia. I use it in a few of my blog post guides ([like this one](https://www.andrewheiss.com/blog/2021/11/10/ame-bayes-re-guide/) where I talk about average marginal effects the whole time even though technically *none* of the effects there are true AMEs—they're all MEMs!). **emmeans** just calculates MEMs and MERs.</span>
<span id="cb77-1713"><a href="#cb77-1713" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1714"><a href="#cb77-1714" aria-hidden="true" tabindex="-1"></a>The idea of average marginal effects (AMEs)—calculating averages *after* plugging values into models—is incredibly popular in the social sciences. **marginaleffects**, its predecessor [**margins**](https://github.com/leeper/margins), and [its Stata counterpart **margins**](https://www.stata.com/features/overview/marginal-analysis/) are all used in research in political science, public policy, economics, and other fields. </span>
<span id="cb77-1715"><a href="#cb77-1715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1716"><a href="#cb77-1716" aria-hidden="true" tabindex="-1"></a>I'm sure there are super smart people in the world who know when AMEs or MEMs are most appropriate (<span class="co">[</span><span class="ot">like this article here!</span><span class="co">](https://doi.org/10.1111/j.1540-5907.2012.00602.x)</span>), and people who have even better and robust ways to account for the typicalness and/or uncertainty of the original data (<span class="co">[</span><span class="ot">see here for an averaging approach using a Bayesian bootstrap</span><span class="co">](https://arelbundock.com/bayesian_bootstrap.html)</span>, for instance), but I'm not one of those super smart people.</span>
<span id="cb77-1717"><a href="#cb77-1717" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1720"><a href="#cb77-1720" aria-hidden="true" tabindex="-1"></a><span class="in">```{comment}</span></span>
<span id="cb77-1721"><a href="#cb77-1721" aria-hidden="true" tabindex="-1"></a><span class="in">- &lt;https://data.library.virginia.edu/a-beginners-guide-to-marginal-effects/&gt;</span></span>
<span id="cb77-1722"><a href="#cb77-1722" aria-hidden="true" tabindex="-1"></a><span class="in">- &lt;https://errickson.net/marginsnotes/#introduction&gt;</span></span>
<span id="cb77-1723"><a href="#cb77-1723" aria-hidden="true" tabindex="-1"></a><span class="in">- AME, MEM, MER: &lt;https://clas.ucdenver.edu/marcelo-perraillon/sites/default/files/attached-files/perraillon_marginal_effects_lecture_lisbon_0.pdf&gt;</span></span>
<span id="cb77-1724"><a href="#cb77-1724" aria-hidden="true" tabindex="-1"></a><span class="in">- &lt;https://twitter.com/alexpghayes/status/1282869973006909441&gt;</span></span>
<span id="cb77-1725"><a href="#cb77-1725" aria-hidden="true" tabindex="-1"></a><span class="in">- &lt;https://stats.stackexchange.com/questions/442850/marginal-means-vs-marginal-effects-what-is-the-difference&gt;</span></span>
<span id="cb77-1726"><a href="#cb77-1726" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1727"><a href="#cb77-1727" aria-hidden="true" tabindex="-1"></a><span class="in">&gt; An effect is a difference of two means. We have simple effects, where we compare means on two levels of a categorical predictor. We have main effects, where we compare "global averages" across all levels of a categorical predictor. But what is a marginal effect? And does it relate to marginal mean?</span></span>
<span id="cb77-1728"><a href="#cb77-1728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1729"><a href="#cb77-1729" aria-hidden="true" tabindex="-1"></a><span class="in">&gt; I heard it's related to change of the response based on change in predictors, but isn't that what the model coefficients tell us? Like "a unit change in X1, ceteris paribus, changes the response by 32.1 units". So how the marginal effect relates to the model coefficients?</span></span>
<span id="cb77-1730"><a href="#cb77-1730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1731"><a href="#cb77-1731" aria-hidden="true" tabindex="-1"></a><span class="in">&gt; To summarize, what are the relationships, if any, between:</span></span>
<span id="cb77-1732"><a href="#cb77-1732" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-1733"><a href="#cb77-1733" aria-hidden="true" tabindex="-1"></a><span class="in">&gt; 1. marginal effect and marginal mean</span></span>
<span id="cb77-1734"><a href="#cb77-1734" aria-hidden="true" tabindex="-1"></a><span class="in">&gt; 2. marginal effect and model coefficient</span></span>
<span id="cb77-1735"><a href="#cb77-1735" aria-hidden="true" tabindex="-1"></a><span class="in">&gt; 3. marginal effect and main/simple effect</span></span>
<span id="cb77-1736"><a href="#cb77-1736" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p><span class="faux-block">Forked from <a href="https://www.andrewheiss.com/">Andrew Heiss</a></span> # <span class="faux-block"><a href="https://github.com/andrewheiss/ath-quarto">View the source at <i class="fa-brands fa-github" aria-label="github"></i> GitHub</a></span></p>
</div>
  </div>
</footer>


</body></html>