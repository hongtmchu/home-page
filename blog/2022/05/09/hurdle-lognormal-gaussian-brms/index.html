<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Hong T.M. Chu">
<meta name="description" content="Create, manipulate, understand, analyze, interpret, and plot Bayesian hurdle regression models (and a custom hurdle Gaussian model!) using R, the tidyverse, emmeans, brms, and Stan">
<title>A guide to modeling outcomes that have lots of zeros with Bayesian hurdle lognormal and hurdle Gaussian regression models | Hong T.M. Chu – Hong T.M. Chu</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../../../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../../../">
<link href="../../../../..//files/favicon-512.png" rel="icon" type="image/png">
<script src="../../../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../../../site_libs/quarto-html/quarto-syntax-highlighting-17c909d5fd25ae21b861c0c7a49b2096.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../../../site_libs/bootstrap/bootstrap-5cd0811f461c8271ae6bab49df9501be.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<link href="../../../../../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../../../../../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<script src="../../../../../site_libs/quarto-contrib/iconify-2.0.0/iconify-icon.min.js"></script><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script type="text/javascript">

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-527449-5', 'auto');

ga('send', {
  hitType: 'pageview',
  'anonymizeIp': true,
});
</script><style>

      .quarto-title-block .quarto-title-banner {
        background: #170C3A;
      }
</style>
<script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
<meta property="og:title" content="A guide to modeling outcomes that have lots of zeros with Bayesian hurdle lognormal and hurdle Gaussian regression models | Hong T.M. Chu">
<meta property="og:description" content="Create, manipulate, understand, analyze, interpret, and plot Bayesian hurdle regression models (and a custom hurdle Gaussian model!) using R, the tidyverse, emmeans, brms, and Stan">
<meta property="og:image" content="https://www.andrewheiss.com/blog/2022/05/09/hurdle-lognormal-gaussian-brms/index_files/figure-html/plot-emmeans-mfx-gdp-1.png">
<meta property="og:site_name" content="Hong T.M. Chu">
<meta property="og:locale" content="en_US">
<meta property="og:image:height" content="1728">
<meta property="og:image:width" content="1728">
<meta name="twitter:title" content="A guide to modeling outcomes that have lots of zeros with Bayesian hurdle lognormal and hurdle Gaussian regression models | Hong T.M. Chu">
<meta name="twitter:description" content="Create, manipulate, understand, analyze, interpret, and plot Bayesian hurdle regression models (and a custom hurdle Gaussian model!) using R, the tidyverse, emmeans, brms, and Stan">
<meta name="twitter:image" content="https://www.andrewheiss.com/blog/2022/05/09/hurdle-lognormal-gaussian-brms/index_files/figure-html/plot-emmeans-mfx-gdp-1.png">
<meta name="twitter:creator" content="@andrewheiss">
<meta name="twitter:site" content="@andrewheiss">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image-height" content="1728">
<meta name="twitter:image-width" content="1728">
</head>
<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../../../index.html">
    <span class="navbar-title">Hong T.M. Chu</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link" href="../../../../../index.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../cv/index.html"> 
<span class="menu-text">CV</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../research/index.html"> 
<span class="menu-text">Research</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../teaching/index.html"> 
<span class="menu-text">Teaching</span></a>
  </li>  
</ul>
<ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item">
    <a class="nav-link" href="mailto:hong.ctm@vinuni.edu.vn"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:envelope" style="font-size: 1.1em;" aria-label="Icon envelope from bi Iconify.design set." title="E-mail"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/andrewheiss" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:github" style="font-size: 1.1em;" aria-label="Icon github from bi Iconify.design set." title="GitHub"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.linkedin.com/in/hongtmchu" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:linkedin" style="font-size: 1.1em;" aria-label="Icon linkedin from bi Iconify.design set." title="LinkedIn"></iconify-icon></span></a>
  </li>  
</ul>
</div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><header id="title-block-header" class="quarto-title-block default blog-post page-columns page-full"><div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">A guide to modeling outcomes that have lots of zeros with Bayesian hurdle lognormal and hurdle Gaussian regression models</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
                  <div>
        <div class="description">
          Create, manipulate, understand, analyze, interpret, and plot Bayesian hurdle regression models (and a custom hurdle Gaussian model!) using R, the tidyverse, emmeans, brms, and Stan
        </div>
      </div>
                </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p><a href="https://www.andrewheiss.com/">Andrew Heiss</a> <a href="https://orcid.org/0000-0002-3948-3914" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">Monday, May 9, 2022</p>
      </div>
    </div>
    
      
      <div>
      <div class="quarto-title-meta-heading">Doi</div>
      <div class="quarto-title-meta-contents">
        <p class="doi">
          <a href="https://doi.org/10.59350/ety2j-09566">10.59350/ety2j-09566</a>
        </p>
      </div>
    </div>
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Contents</h2>
   
  <ul>
<li><a href="#who-this-post-is-for" id="toc-who-this-post-is-for" class="nav-link active" data-scroll-target="#who-this-post-is-for">Who this post is for</a></li>
  <li>
<a href="#exponentially-distributed-outcomes-with-zeros" id="toc-exponentially-distributed-outcomes-with-zeros" class="nav-link" data-scroll-target="#exponentially-distributed-outcomes-with-zeros">Exponentially distributed outcomes with zeros</a>
  <ul>
<li><a href="#explore-data" id="toc-explore-data" class="nav-link" data-scroll-target="#explore-data">Explore data</a></li>
  <li><a href="#regular-ols-model-on-an-unlogged-outcome" id="toc-regular-ols-model-on-an-unlogged-outcome" class="nav-link" data-scroll-target="#regular-ols-model-on-an-unlogged-outcome">1. Regular OLS model on an unlogged outcome</a></li>
  <li><a href="#regular-ols-model-on-a-logged-outcome" id="toc-regular-ols-model-on-a-logged-outcome" class="nav-link" data-scroll-target="#regular-ols-model-on-a-logged-outcome">2. Regular OLS model on a logged outcome</a></li>
  <li>
<a href="#hurdle-lognormal-model" id="toc-hurdle-lognormal-model" class="nav-link" data-scroll-target="#hurdle-lognormal-model">3. Hurdle lognormal model</a>
  <ul class="collapse">
<li><a href="#intercept-only-hurdle-model" id="toc-intercept-only-hurdle-model" class="nav-link" data-scroll-target="#intercept-only-hurdle-model">Intercept-only hurdle model</a></li>
  <li><a href="#hurdle-model-with-additional-terms" id="toc-hurdle-model-with-additional-terms" class="nav-link" data-scroll-target="#hurdle-model-with-additional-terms">Hurdle model with additional terms</a></li>
  <li><a href="#extracting-and-interpreting-coefficients-from-a-hurdle-model" id="toc-extracting-and-interpreting-coefficients-from-a-hurdle-model" class="nav-link" data-scroll-target="#extracting-and-interpreting-coefficients-from-a-hurdle-model">Extracting and interpreting coefficients from a hurdle model</a></li>
  <li><a href="#brmsconditional_effects-with-hurdle-models" id="toc-brmsconditional_effects-with-hurdle-models" class="nav-link" data-scroll-target="#brmsconditional_effects-with-hurdle-models"><code>brms::conditional_effects()</code> with hurdle models</a></li>
  <li><a href="#emmeans-with-hurdle-models" id="toc-emmeans-with-hurdle-models" class="nav-link" data-scroll-target="#emmeans-with-hurdle-models"><strong>emmeans</strong> with hurdle models</a></li>
  <li><a href="#predictions-with-hurdle-models" id="toc-predictions-with-hurdle-models" class="nav-link" data-scroll-target="#predictions-with-hurdle-models">Predictions with hurdle models</a></li>
  </ul>
</li>
  <li><a href="#hurdle-lognormal-model-with-fancy-multilevel-things" id="toc-hurdle-lognormal-model-with-fancy-multilevel-things" class="nav-link" data-scroll-target="#hurdle-lognormal-model-with-fancy-multilevel-things">4. Hurdle lognormal model with fancy multilevel things</a></li>
  </ul>
</li>
  <li>
<a href="#normally-distributed-outcomes-with-zeros" id="toc-normally-distributed-outcomes-with-zeros" class="nav-link" data-scroll-target="#normally-distributed-outcomes-with-zeros">Normally distributed outcomes with zeros</a>
  <ul>
<li><a href="#explore-data-1" id="toc-explore-data-1" class="nav-link" data-scroll-target="#explore-data-1">Explore data</a></li>
  <li><a href="#regular-ols-model-on-a-non-exponential-outcome" id="toc-regular-ols-model-on-a-non-exponential-outcome" class="nav-link" data-scroll-target="#regular-ols-model-on-a-non-exponential-outcome">1. Regular OLS model on a non-exponential outcome</a></li>
  <li><a href="#hurdle-lognormal-model-on-a-non-exponential-outcome" id="toc-hurdle-lognormal-model-on-a-non-exponential-outcome" class="nav-link" data-scroll-target="#hurdle-lognormal-model-on-a-non-exponential-outcome">2. Hurdle lognormal model on a non-exponential outcome</a></li>
  <li>
<a href="#hurdle-gaussian-model-with-a-custom-brms-family" id="toc-hurdle-gaussian-model-with-a-custom-brms-family" class="nav-link" data-scroll-target="#hurdle-gaussian-model-with-a-custom-brms-family">3. Hurdle gaussian model with a custom brms family</a>
  <ul class="collapse">
<li><a href="#i-liedthis-custom-family-isnt-all-the-way-complete" id="toc-i-liedthis-custom-family-isnt-all-the-way-complete" class="nav-link" data-scroll-target="#i-liedthis-custom-family-isnt-all-the-way-complete">I lied—this custom family isn’t all the way complete!</a></li>
  </ul>
</li>
  </ul>
</li>
  </ul></nav>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content"><p>In <a href="https://www.andrewheiss.com/research/articles/chaudhry-heiss-ngos-aid/">a research project I’ve been working on for several years</a> now, we’re interested in the effect of anti-NGO legal crackdowns on various foreign aid-related outcomes: the amount of foreign aid a country receives and the proportion of that aid dedicated to contentious vs.&nbsp;non-contentious causes or issues. These outcome variables are easily measurable thanks to <a href="https://www.aiddata.org/">the AidData project</a>, but they post a tricky methodological issue. The amount of foreign aid countries receive can both be huge (in the hundreds of millions or even billions of dollars), or completely zero. Moreover, the proportion of aid allocated to specific purposes is inherently bound between 0% and 100%, but can sometimes be exactly 0% or 100%. Using a statistical model that fits the distribution of these kinds of variables is important for modeling accuracy, but it’s a more complicated process than running a basic linear OLS regression with <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code>.</p>
<p><a href="https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/">In a previous post</a>, I wrote a guide to doing beta, zero-inflated beta, and zero-one-inflated beta regression for outcome variables that are bound between 0 and 1 and that can include 0 and/or 1. (That post was a side effect of working on this project on foreign aid and anti-NGO restrictions.)</p>
<p>Beta regression (and its zero- and zero-one-inflated varieties) works really well with these kinds of outcome variables, and you can end up with richly defined models and well-fitting models. Zero-inflated beta regression doesn’t work on outcomes that aren’t limited to 0–1, though. For outcome variables that extend beyond 1, we can use hurdle models instead, which follow the same general approach as zero-inflated models. We define a mixture of models for two separate processes:</p>
<ol type="1">
<li>A model that predicts if the outcome is zero or not zero</li>
<li>If the outcome is not zero, a model that predicts what the value of the outcome is</li>
</ol>
<p>Hurdle models do a great job at fitting the data well and providing accurate predictions. They’re a little unwieldy to work with though, since they involve so many different moving parts.</p>
<p>This post is a guide (mostly for future me) for how to create, manipulate, understand, analyze, and plot hurlde models in a Bayesian way using R and Stan (through <a href="https://paul-buerkner.github.io/brms/"><strong>brms</strong></a>).</p>
<p>Throughout this post, we’ll use data from two datasets to explore a couple different questions:</p>
<ol type="1">
<li>What happens to a country’s GDP per capita as its life expectancy increases? We’ll use data from the Gapminder Project (though the <a href="https://github.com/jennybc/gapminder"><strong>gapminder</strong> R package</a>)</li>
<li>What is the effect of bill length on body mass in Antarctic penguins? We’ll use data from the <a href="https://allisonhorst.github.io/palmerpenguins/"><strong>palmerpenguins</strong> R package</a>.</li>
</ol>
<p>Neither GDP per capita nor flipper length have any naturally ocurring zeros, so we’ll manipulate the data beforehand and build in some zeros based on some arbitrary rules. For the health/weatlh gapminder data, we’ll make it so countries with lower life expectancy will have a higher chance of seeing a 0 in GDP per capita; for the penguin data, we’ll make it so that shorter flipper length will increase the chance of seeing a 0 in body mass.</p>
<section id="who-this-post-is-for" class="level2"><h2 class="anchored" data-anchor-id="who-this-post-is-for">Who this post is for</h2>
<p>Here’s what I assume you know:</p>
<ul>
<li>You’re familiar with <a href="https://www.r-project.org/">R</a> and the <a href="https://www.tidyverse.org/">tidyverse</a> (particularly <a href="https://dplyr.tidyverse.org/">dplyr</a> and <a href="https://ggplot2.tidyverse.org/">ggplot2</a>).</li>
<li>You’re familiar with <a href="https://paul-buerkner.github.io/brms/"><strong>brms</strong></a> for running Bayesian regression models. See <a href="https://paul-buerkner.github.io/brms/articles/index.html">the vignettes here</a>, examples like <a href="https://www.rensvandeschoot.com/tutorials/brms-started/">this</a>, or <a href="https://evalsp22.classes.andrewheiss.com/resource/bayes/#resources">resources like these</a> for an introduction. You can also see <a href="../../../../../blog/2021/11/08/beta-regression-guide/">this guide on beta regression</a> or <a href="../../../../../blog/2021/11/10/ame-bayes-re-guide/">this guide on average marginal effects</a> for more examples.</li>
<li>You’re somewhat familiar with multilevel models. <a href="../../../../../blog/2021/12/01/multilevel-models-panel-data-guide/">See this guide on using multilevel models with panel data</a> for an extended example and a ton of extra resources.</li>
</ul>
<p>I use <strong>brms</strong> and Bayesian models throughout, since <strong>brms</strong> has built-in support for hurdled lognormal models (and can be extended to support other hurdled models). If you prefer frequentism, you can use <a href="https://cran.r-project.org/web/packages/pscl/index.html"><code>pscl::hurdle()</code></a> for frequentist hurdle models (<a href="https://www.rdatagen.net/post/a-hurdle-model-for-covid-19-infections-in-nursing-homes-sample-size-considerations/">see this post</a> or <a href="https://data.library.virginia.edu/getting-started-with-hurdle-models/">this post</a> for fully worked out examples), and lognormal regression can be done frequentistly with base R’s <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> function after logging the outcome:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Pre-log the outcome:</span></span>
<span><span class="va">whatever</span> <span class="op">&lt;-</span> <span class="va">whatever</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>y_logged <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">y_logged</span> <span class="op">~</span> <span class="va">x</span>, data <span class="op">=</span> <span class="va">whatever</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Log the outcome in the regression itself:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">~</span> <span class="va">x</span>, data <span class="op">=</span> <span class="va">whatever</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s get started by loading all the libraries we’ll need (and creating some couple helper functions):</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>       <span class="co"># ggplot, dplyr, and friends</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/paul-buerkner/brms">brms</a></span><span class="op">)</span>            <span class="co"># Bayesian modeling through Stan</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rvlenth.github.io/emmeans/">emmeans</a></span><span class="op">)</span>         <span class="co"># Calculate marginal effects in fancy ways</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mjskay.github.io/tidybayes/">tidybayes</a></span><span class="op">)</span>       <span class="co"># Manipulate Stan objects in a tidy way</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://broom.tidymodels.org/">broom</a></span><span class="op">)</span>           <span class="co"># Convert model objects to data frames</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bbolker/broom.mixed">broom.mixed</a></span><span class="op">)</span>     <span class="co"># Convert brms model objects to data frames</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://scales.r-lib.org">scales</a></span><span class="op">)</span>          <span class="co"># For formatting numbers with commas, percents, and dollars</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com">patchwork</a></span><span class="op">)</span>       <span class="co"># For combining plots</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/teunbrand/ggh4x">ggh4x</a></span><span class="op">)</span>           <span class="co"># For nested facets in ggplot</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://wilkelab.org/ggtext/">ggtext</a></span><span class="op">)</span>          <span class="co"># Use markdown and HTML in ggplot text</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">MetBrewer</span><span class="op">)</span>       <span class="co"># Use pretty artistic colors</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jennybc/gapminder">gapminder</a></span><span class="op">)</span>       <span class="co"># Country-year panel data from the Gapminder project</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://allisonhorst.github.io/palmerpenguins/">palmerpenguins</a></span><span class="op">)</span>  <span class="co"># Penguin data!</span></span>
<span></span>
<span><span class="co"># Use the cmdstanr backend for Stan because it's faster and more modern than the</span></span>
<span><span class="co"># default rstan You need to install the cmdstanr package first</span></span>
<span><span class="co"># (https://mc-stan.org/cmdstanr/) and then run cmdstanr::install_cmdstan() to</span></span>
<span><span class="co"># install cmdstan on your computer.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>mc.cores <span class="op">=</span> <span class="fl">4</span>,</span>
<span>        brms.backend <span class="op">=</span> <span class="st">"cmdstanr"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set some global Stan options</span></span>
<span><span class="va">CHAINS</span> <span class="op">&lt;-</span> <span class="fl">4</span></span>
<span><span class="va">ITER</span> <span class="op">&lt;-</span> <span class="fl">2000</span></span>
<span><span class="va">WARMUP</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="va">BAYES_SEED</span> <span class="op">&lt;-</span> <span class="fl">1234</span></span>
<span></span>
<span><span class="co"># Use the Johnson color palette</span></span>
<span><span class="va">clrs</span> <span class="op">&lt;-</span> <span class="fu">MetBrewer</span><span class="fu">::</span><span class="fu">met.brewer</span><span class="op">(</span><span class="st">"Johnson"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Tell bayesplot to use the Johnson palette (for things like pp_check())</span></span>
<span><span class="fu">bayesplot</span><span class="fu">::</span><span class="fu">color_scheme_set</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"grey30"</span>, <span class="va">clrs</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">clrs</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="va">clrs</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span>, <span class="va">clrs</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Custom ggplot theme to make pretty plots</span></span>
<span><span class="co"># Get the font at https://fonts.google.com/specimen/Jost</span></span>
<span><span class="va">theme_nice</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span>base_family <span class="op">=</span> <span class="st">"Jost"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">theme</span><span class="op">(</span>panel.grid.minor <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>          plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Jost"</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>          axis.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Jost Medium"</span><span class="op">)</span>,</span>
<span>          strip.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Jost"</span>, face <span class="op">=</span> <span class="st">"bold"</span>,</span>
<span>                                    size <span class="op">=</span> <span class="fu">rel</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, hjust <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>          strip.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"grey80"</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="exponentially-distributed-outcomes-with-zeros" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="exponentially-distributed-outcomes-with-zeros">Exponentially distributed outcomes with zeros</h2>
<p><a href="https://www.youtube.com/watch?v=Z8t4k0Q8e8Y">Like Hans Rosling</a>, we’re interested in the relationship between health and wealth. How do a country’s GDP per capita and life expectancy move together? We’ll look at this a few different ways, dealing with both the exponential shape of the data and the presence of all those zeros we added.</p>
<p>All these examples are the <strong><em>reverse</em></strong> of the standard way of looking at the health/wealth relationship—in Rosling’s TED talk, GDP is on the x-axis and life expectancy is on the y-axis, since his theory is that more wealth leads to better health and longer life. But since I want to illustrate how to model logged outcome, we’ll put GDP on the y-axis here, which means we’ll be seeing what happens to wealth as life expectancy changes by one year (i.e.&nbsp;instead of the more standard <code>lifeExp ~ gdpPercap</code>, we’ll look at <code>gdpPercap ~ lifeExp</code>).</p>
<p>The data from the <a href="https://www.gapminder.org/">Gapminder Project</a> is nice and clean and complete—there are no missing values, and there are no zero values. That means we’ll need to mess with the data a little to force it to have some zeros that we can work with. We’ll change some of the existing GDP per capita values to 0 based on two conditions:</p>
<ul>
<li>If life expectancy is less than 50 years, there will be a 30% chance that the value of GDP per capita is 0</li>
<li>If life expectancy is greater than 50 years, there will be a 2% chance that the value of GDP per capita is 0</li>
</ul>
<p>This means that countries with lower life expectancy will be more likely to have 0 GDP per capita in a given year.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span></span>
<span><span class="va">gapminder</span> <span class="op">&lt;-</span> <span class="fu">gapminder</span><span class="fu">::</span><span class="va">gapminder</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">continent</span> <span class="op">!=</span> <span class="st">"Oceania"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co"># Make a bunch of GDP values 0</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>prob_zero <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">lifeExp</span> <span class="op">&lt;</span> <span class="fl">50</span>, <span class="fl">0.3</span>, <span class="fl">0.02</span><span class="op">)</span>,</span>
<span>         will_be_zero <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span>, <span class="fl">1</span>, prob <span class="op">=</span> <span class="va">prob_zero</span><span class="op">)</span>,</span>
<span>         gdpPercap <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">will_be_zero</span>, <span class="fl">0</span>, <span class="va">gdpPercap</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">prob_zero</span>, <span class="op">-</span><span class="va">will_be_zero</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co"># Make a logged version of GDP per capita</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>log_gdpPercap <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log1p</a></span><span class="op">(</span><span class="va">gdpPercap</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>is_zero <span class="op">=</span> <span class="va">gdpPercap</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="explore-data" class="level3"><h3 class="anchored" data-anchor-id="explore-data">Explore data</h3>
<p>Let’s check if it worked:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">gapminder</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">count</span><span class="op">(</span><span class="va">is_zero</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>prop <span class="op">=</span> <span class="va">n</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 2 × 3</span></span>
<span><span class="co">##   is_zero     n  prop</span></span>
<span><span class="co">##   &lt;lgl&gt;   &lt;int&gt; &lt;dbl&gt;</span></span>
<span><span class="co">## 1 FALSE    1502 0.894</span></span>
<span><span class="co">## 2 TRUE      178 0.106</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Perfect! We broke the pristine data and now 10.6% of the values of GDP per capita are zero.</p>
<p>We can visualize this too (and we’ll cheat a little for the sake of plotting by temporarily changing all zeros to a negative number so we can get a separate count in the histogram).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">plot_dist_unlogged</span> <span class="op">&lt;-</span> <span class="va">gapminder</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>gdpPercap <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">is_zero</span>, <span class="op">-</span><span class="fl">0.1</span>, <span class="va">gdpPercap</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">gdpPercap</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">is_zero</span><span class="op">)</span>, binwidth <span class="op">=</span> <span class="fl">5000</span>, </span>
<span>                 boundary <span class="op">=</span> <span class="fl">0</span>, color <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_dollar</span><span class="op">(</span>scale_cut <span class="op">=</span> <span class="fu">cut_short_scale</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">clrs</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, </span>
<span>                    guide <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>reverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"GDP per capita"</span>, y <span class="op">=</span> <span class="st">"Count"</span>, fill <span class="op">=</span> <span class="st">"Is zero?"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Nice and exponentially shaped, with a bunch of zeros"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_nice</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_dist_logged</span> <span class="op">&lt;-</span> <span class="va">gapminder</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>log_gdpPercap <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">is_zero</span>, <span class="op">-</span><span class="fl">0.1</span>, <span class="va">log_gdpPercap</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">log_gdpPercap</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">is_zero</span><span class="op">)</span>, binwidth <span class="op">=</span> <span class="fl">0.5</span>, </span>
<span>                 boundary <span class="op">=</span> <span class="fl">0</span>, color <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_math</span><span class="op">(</span><span class="va">e</span><span class="op">^</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">clrs</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, </span>
<span>                    guide <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>reverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"GDP per capita"</span>, y <span class="op">=</span> <span class="st">"Count"</span>, fill <span class="op">=</span> <span class="st">"Is zero?"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Nice and normally shaped, with a bunch of zeros;\nit's hard to interpret intuitively though"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_nice</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="va">plot_dist_unlogged</span> <span class="op">|</span> <span class="va">plot_dist_logged</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">plot_layout</span><span class="op">(</span>guides <span class="op">=</span> <span class="st">"collect"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">plot_annotation</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"GDP per capita, original vs. logged"</span>,</span>
<span>                  theme <span class="op">=</span> <span class="fu">theme</span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Jost"</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>                                legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-gdp-dist-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>The left panel here shows the exponential distribution of GDP per capita. There are a lot of countries with low values (less than $500!), and increasingly fewer countries with more per capita wealth. The right panel shows the natural log (i.e.&nbsp;log <a href="https://en.wikipedia.org/wiki/E_(mathematical_constant)">base <em>e</em></a>) of GDP per capita. It’s now a lot more normally distributed (if we disregard the column showing the count of zeros), but note the x-axis scale—instead of using easily interpretable dollars, it shows the exponent that <em>e</em> is raised to, which is really unintuitive. Logged values are helpful when working with regression models, and <a href="https://stats.stackexchange.com/a/18639/3025">this CrossValidated post</a> reviews how to interpret model coefficients when different variables are logged or not. In this case, if we use logged GDP per capita as the outcome variable, any explanatory coefficients we have will represent the percent change in GDP per capita—a one-year increase in life expectancy will be associated with a X% change in GDP per capita, on average.</p>
<p>Ideally, it’d be great if we could work with dollar-scale coefficients and marginal effects rather than percent change-based coefficients (since I find dollars more intuitive than percent changes), but because of mathy and statsy reasons, it’s best to model this outcome using a log scale. With some neat tricks, though, we can back-transform the log-scale results to dollars.</p>
</section><section id="regular-ols-model-on-an-unlogged-outcome" class="level3"><h3 class="anchored" data-anchor-id="regular-ols-model-on-an-unlogged-outcome">1. Regular OLS model on an unlogged outcome</h3>
<p>Now that we’ve built in some zeros, let’s model the relationship between health and wealth.</p>
<p>First, we’ll use a basic linear regression model with all the data at its original scale—no logging, no accounting for zeros, just drawing a straight line through data using ordinal least squares (OLS). Let’s look at a scatterplot first:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">gapminder</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">lifeExp</span>, y <span class="op">=</span> <span class="va">gdpPercap</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">continent</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_smooth</span><span class="op">(</span>method <span class="op">=</span> <span class="st">"lm"</span>, color <span class="op">=</span> <span class="st">"#0074D9"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_dollar</span><span class="op">(</span>scale_cut <span class="op">=</span> <span class="fu">cut_short_scale</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">clrs</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Life expectancy"</span>, y <span class="op">=</span> <span class="st">"GDP per capita"</span>, color <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"OLS model fit on unlogged GDP"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>color <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1.5</span>, alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_nice</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-ols-unlogged-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>Hahaha that line is, um, great. Because of the exponential distribution of GDP per capita, the scatterplot follows a sort of hockey stick shape: the points are almost horizontal at low levels of life expectancy and they start trending at more of a 45º angle at at around 65 years The corresponding OLS trend line cuts across empty space in a ridiculous way and predicts negative income at low life expectancy and quite muted income at high life expectancy</p>
<p>Even so, <a href="https://en.wikipedia.org/wiki/Economics">many social science disciplines</a> love OLS and use it for literally everything, so we’ll use it here too. Let’s make a basic OLS model:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/model-gdp-basic_ecdb381c940c6a2670f4593ce8f67f9a">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_gdp_basic</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span></span>
<span>  <span class="fu">bf</span><span class="op">(</span><span class="va">gdpPercap</span> <span class="op">~</span> <span class="va">lifeExp</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">gapminder</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  chains <span class="op">=</span> <span class="va">CHAINS</span>, iter <span class="op">=</span> <span class="va">ITER</span>, warmup <span class="op">=</span> <span class="va">WARMUP</span>, seed <span class="op">=</span> <span class="va">BAYES_SEED</span>,</span>
<span>  silent <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_gdp_basic</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 3 × 8</span></span>
<span><span class="co">##   effect   component group    term            estimate std.error conf.low conf.high</span></span>
<span><span class="co">##   &lt;chr&gt;    &lt;chr&gt;     &lt;chr&gt;    &lt;chr&gt;              &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 fixed    cond      &lt;NA&gt;     (Intercept)      -19434.     943.   -21216.   -17608.</span></span>
<span><span class="co">## 2 fixed    cond      &lt;NA&gt;     lifeExp             442.      15.6     412.      472.</span></span>
<span><span class="co">## 3 ran_pars cond      Residual sd__Observation    8054.     140.     7789.     8337.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Based on this model, when life expectancy is 0, the average GDP per capita is -$19,433.69, though since no countries have life expectancy that low, we shouldn’t really interpret that intercept—it mostly just exists so that the line can start somewhere. We care the most about the <code>lifeExp</code> coefficient: a one-year increase in life expectancy is associated with a $442.49 increase in GDP per capita, on average.</p>
<p>We can already tell that the fitted OLS trend isn’t that great. Let’s do a posterior predictive check to see how well the actual observed GDP per capita (in <span style="color:#0086a8;">■&nbsp;light blue</span>) aligns with simulated GDP per capita from the posterior distribution of the model (in <span style="color:#d04e00;">■&nbsp;orange</span>):</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">pp_check</span><span class="op">(</span><span class="va">model_gdp_basic</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-pp-model-gdp-basic-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>Again, not fantastic. The actual distribution of GDP per capita is (1) exponential, so it has lots of low values, and (2) zero-inflated, so it has a lot of zeros. The posterior from the model shows a nice normal distribution of GDP per capita centered around $15,000ish. It’s not a great model at all.</p>
</section><section id="regular-ols-model-on-a-logged-outcome" class="level3"><h3 class="anchored" data-anchor-id="regular-ols-model-on-a-logged-outcome">2. Regular OLS model on a logged outcome</h3>
<p>A standard approach when working with exponentially distributed outcomes like this is to log them. If we look at this scatterplot with base-10-logged GDP per capita, the shape of the data is much more linear and modelable. I put the 0s in a separate facet so that they’re easier to see too. We can easily see the two different processes—there’s a positive relationship between life expectancy and logged GDP per capita (shown with the <span style="color:#0074D9;">■&nbsp;blue</span> line), and there are a bunch of observations with 0 GDP per capita, generally clustered among rows with life expectancy less than 50 (which is by design, since we made it so all those rows had a 20% chance of getting a 0).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">plot_health_wealth_facet</span> <span class="op">&lt;-</span> <span class="va">gapminder</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>nice_zero <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">is_zero</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">FALSE</span>, <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>                            labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"GDP &gt; $0"</span>, <span class="st">"0"</span><span class="op">)</span>,</span>
<span>                            ordered <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">lifeExp</span>, y <span class="op">=</span> <span class="va">gdpPercap</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">continent</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_smooth</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>linetype <span class="op">=</span> <span class="va">is_zero</span><span class="op">)</span>, method <span class="op">=</span> <span class="st">"lm"</span>, se <span class="op">=</span> <span class="cn">FALSE</span>, color <span class="op">=</span> <span class="st">"#0074D9"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_log10</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_dollar</span><span class="op">(</span>scale_cut <span class="op">=</span> <span class="fu">cut_short_scale</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                breaks <span class="op">=</span> <span class="fl">125</span> <span class="op">*</span> <span class="op">(</span><span class="fl">2</span><span class="op">^</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">clrs</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_linetype_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"solid"</span>, <span class="st">"blank"</span><span class="op">)</span>, guide <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Life expectancy"</span>, y <span class="op">=</span> <span class="st">"GDP per capita (base 10 logged)"</span>, color <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"OLS model fit only for rows where GDP &gt; 0"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"GDP per capita logged with base 10"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>color <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1.5</span>, alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">80</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_grid</span><span class="op">(</span>rows <span class="op">=</span> <span class="fu">vars</span><span class="op">(</span><span class="va">nice_zero</span><span class="op">)</span>, scales <span class="op">=</span> <span class="st">"free_y"</span>, space <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">theme_nice</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>        strip.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fu">rel</span><span class="op">(</span><span class="fl">0.7</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">plot_health_wealth_facet</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-health-wealth-facet-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>The same relationship holds when we use the natural log of GDP per capita, where values range from 6–12ish, as we saw in the histogram earlier. For statistical reasons, using the natural log works better and makes the interpretation of the coefficients easier since we can talk about percent changes in the outcome. Again, <a href="https://stats.stackexchange.com/a/18639/3025">this CrossValidated post</a> is indispensable for remembering how to interpret coefficients that are or aren’t logged when outcomes are or aren’t logged.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">plot_health_wealth_facet</span> <span class="op">+</span></span>
<span>  <span class="co"># Switch the column on the y-axis to logged GDP per capita</span></span>
<span>  <span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">log_gdpPercap</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_math</span><span class="op">(</span><span class="va">e</span><span class="op">^</span><span class="va">.x</span><span class="op">)</span>, breaks <span class="op">=</span> <span class="fl">5</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>y <span class="op">=</span> <span class="st">"GDP per capital (logged)"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"GDP per capita logged with base e"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-health-wealth-facet-ln-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>However, those zeros are going to cause problems. The nice <span style="color:#0074D9;">■&nbsp;blue</span> line is only fit using the non-zero data. If we include the zeros, like the <span style="color:#F012BE;">■&nbsp;fuchsia</span> line in this plot, the relationship is substantially different:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">gapminder</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">lifeExp</span>, y <span class="op">=</span> <span class="va">log_gdpPercap</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">continent</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_smooth</span><span class="op">(</span>method <span class="op">=</span> <span class="st">"lm"</span>, color <span class="op">=</span> <span class="st">"#F012BE"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_smooth</span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">gapminder</span>, <span class="va">gdpPercap</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span>, method <span class="op">=</span> <span class="st">"lm"</span>, color <span class="op">=</span> <span class="st">"#0074D9"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_math</span><span class="op">(</span><span class="va">e</span><span class="op">^</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">clrs</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Life expectancy"</span>, y <span class="op">=</span> <span class="st">"GDP per capita (log)"</span>, color <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>color <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1.5</span>, alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">80</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">'OLS models &lt;span style="color:#F012BE;"&gt;with&lt;/span&gt; and &lt;span style="color:#0074D9;"&gt;without&lt;/span&gt; zeros'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_nice</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>        plot.title <span class="op">=</span> <span class="fu">element_markdown</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-health-wealth-no-facet-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Let’s make a couple models that use logged GDP with and without zeros and compare the life expectancy coefficients:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/model-log-gdp-basic_21ad9d3b561cd2352a630e56258ead8e">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_log_gdp_basic</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span></span>
<span>  <span class="fu">bf</span><span class="op">(</span><span class="va">log_gdpPercap</span> <span class="op">~</span> <span class="va">lifeExp</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">gapminder</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  chains <span class="op">=</span> <span class="va">CHAINS</span>, iter <span class="op">=</span> <span class="va">ITER</span>, warmup <span class="op">=</span> <span class="va">WARMUP</span>, seed <span class="op">=</span> <span class="va">BAYES_SEED</span>,</span>
<span>  silent <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_log_gdp_no_zeros</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span></span>
<span>  <span class="fu">bf</span><span class="op">(</span><span class="va">log_gdpPercap</span> <span class="op">~</span> <span class="va">lifeExp</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">gapminder</span>, <span class="op">!</span><span class="va">is_zero</span><span class="op">)</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  chains <span class="op">=</span> <span class="va">CHAINS</span>, iter <span class="op">=</span> <span class="va">ITER</span>, warmup <span class="op">=</span> <span class="va">WARMUP</span>, seed <span class="op">=</span> <span class="va">BAYES_SEED</span>,</span>
<span>  silent <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_log_gdp_basic</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 3 × 8</span></span>
<span><span class="co">##   effect   component group    term            estimate std.error conf.low conf.high</span></span>
<span><span class="co">##   &lt;chr&gt;    &lt;chr&gt;     &lt;chr&gt;    &lt;chr&gt;              &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 fixed    cond      &lt;NA&gt;     (Intercept)       -0.468   0.256     -0.973    0.0252</span></span>
<span><span class="co">## 2 fixed    cond      &lt;NA&gt;     lifeExp            0.132   0.00420    0.124    0.141 </span></span>
<span><span class="co">## 3 ran_pars cond      Residual sd__Observation    2.21    0.0379     2.14     2.29</span></span>
<span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_log_gdp_no_zeros</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 3 × 8</span></span>
<span><span class="co">##   effect   component group    term            estimate std.error conf.low conf.high</span></span>
<span><span class="co">##   &lt;chr&gt;    &lt;chr&gt;     &lt;chr&gt;    &lt;chr&gt;              &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 fixed    cond      &lt;NA&gt;     (Intercept)       3.48     0.0943    3.29      3.66  </span></span>
<span><span class="co">## 2 fixed    cond      &lt;NA&gt;     lifeExp           0.0784   0.00152   0.0754    0.0814</span></span>
<span><span class="co">## 3 ran_pars cond      Residual sd__Observation   0.735    0.0133    0.708     0.761</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the model that includes the zeros (the <span style="color:#F012BE;">■&nbsp;fuchsia</span> line), a one-year increase in life expectancy is associated with a 13.2% increase in GDP per capita, on average, but if we omit the zeros (the <span style="color:#0074D9;">■&nbsp;blue</span> line), the slope changes substantially—here, a one-year increase in life expectancy is associated with a 7.8% increase in GDP per capita. The zero-free model fits the data better, but omits the zeros; the model with the zeros included is arguably more accurate, but is simultaneously less accurate given how poorly it predicts values with low life expectancy.</p>
<p>This is also apparent when we look at posterior predictive checks. The model that includes zeros has two very clear peaks in the distributions of the actual values of GDP per capita (in <span style="color:#0086a8;">■&nbsp;light blue</span>), while the simulated values of GDP per capita (in <span style="color:#d04e00;">■&nbsp;orange</span>) are unimodal and both under- and over-estimates</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">pp_check</span><span class="op">(</span><span class="va">model_log_gdp_basic</span><span class="op">)</span></span>
<span><span class="fu">pp_check</span><span class="op">(</span><span class="va">model_log_gdp_no_zeros</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-pp-model-log-gdp-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
</section><section id="hurdle-lognormal-model" class="level3"><h3 class="anchored" data-anchor-id="hurdle-lognormal-model">3. Hurdle lognormal model</h3>
<p>We thus have a dilemma. If we omit the zeros, we’ll get a good, accurate model fit for non-zero data, but we’ll be throwing away all the data with zeros (in this case that’s like 10% of the data!). If we include the zeros, we won’t be throwing any data away, but we’ll get a strange-fitting model that both under- and over-predicts values. So what do we do?!</p>
<p><del>We give up.</del></p>
<p><del>We live like economists and embrace OLS.</del></p>
<p>We use a model that incorporates information about both the zeros <em>and</em> the non-zeros!</p>
<p><a href="https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/">In an earlier post</a>, <a href="https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/#4-zero-inflated-beta-regression-bayesian-style">I show how zero-inflated beta regression works</a>. Beta regression works well for outcomes that are bounded between 0 and 1, but they cannot model values that are exactly 0 or 1. To get around this, it’s possible to model multiple processes simultaneously:</p>
<ol type="1">
<li>A logistic regression model that predicts if an outcome is 0 or not</li>
<li>A beta regression model that predicts if an outcome is between 0 and 1 if it’s not zero</li>
</ol>
<p>We can use a similar mixture process for outcomes that don’t use beta regression. For whatever reason, instead of calling these models <em>zero-inflated</em>, we call them <em>hurdle models</em>, and <strong>brms</strong> includes four different built-in families:</p>
<ol type="1">
<li>Use a logistic regression model that predicts if an outcome is 0 or not (this is the <em>hurdle</em> part)</li>
<li>Use a lognormal (<code>hurdle_lognormal()</code>), gamma (<code>hurdle_gamma()</code>), Poisson (<code>hurdle_poisson()</code>), or negative binomial (<code>hurdle_negbinomial()</code>) model for outcomes that are not zero</li>
</ol>
<p>As we do with <a href="https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/#4-zero-inflated-beta-regression-bayesian-style">zero-inflated beta regression</a>, we have to specify two different processes when dealing with hurdle models: (1) the main outcome and (2) the binary hurdle process, or <code>hu</code>.</p>
<section id="intercept-only-hurdle-model" class="level4"><h4 class="anchored" data-anchor-id="intercept-only-hurdle-model">Intercept-only hurdle model</h4>
<p>To help with the intuition, we’ll first run a model where we don’t actually define a real model for <code>hu</code>—it’ll just return the intercept, which will show the proportion of GDP per capita that is zero. We’ll use the <code>hurdle_lognormal()</code> family, since, as we’ve already seen, our GDP per capita measure is exponentially distributed. Through the magic of the lognormal family, we don’t actually need to feed the model logged GDP per capita—it handles the logging for us behind the scenes automatically.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/model-gdp-hurdle_b886fee540722f8b74d7a627eed6af4f">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_gdp_hurdle</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span></span>
<span>  <span class="fu">bf</span><span class="op">(</span><span class="va">gdpPercap</span> <span class="op">~</span> <span class="va">lifeExp</span>,</span>
<span>     <span class="va">hu</span> <span class="op">~</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">gapminder</span>,</span>
<span>  family <span class="op">=</span> <span class="fu">hurdle_lognormal</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  chains <span class="op">=</span> <span class="va">CHAINS</span>, iter <span class="op">=</span> <span class="va">ITER</span>, warmup <span class="op">=</span> <span class="va">WARMUP</span>, seed <span class="op">=</span> <span class="va">BAYES_SEED</span>,</span>
<span>  silent <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_gdp_hurdle</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 4 × 8</span></span>
<span><span class="co">##   effect   component group    term            estimate std.error conf.low conf.high</span></span>
<span><span class="co">##   &lt;chr&gt;    &lt;chr&gt;     &lt;chr&gt;    &lt;chr&gt;              &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 fixed    cond      &lt;NA&gt;     (Intercept)       3.47     0.0956    3.28      3.66  </span></span>
<span><span class="co">## 2 fixed    cond      &lt;NA&gt;     hu_(Intercept)   -2.13     0.0781   -2.28     -1.98  </span></span>
<span><span class="co">## 3 fixed    cond      &lt;NA&gt;     lifeExp           0.0786   0.00154   0.0755    0.0816</span></span>
<span><span class="co">## 4 ran_pars cond      Residual sd__Observation   0.736    0.0133    0.710     0.762</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The results from this model are a little different now. The coefficients for the regular part of the model (<code>(Intercept)</code> and <code>lifeExp</code>) are nearly identical to the zero-free model we made earlier (<code>model_log_gdp_no_zeros</code>), and we can interpret them just like we did before: a one-year increase in life expectancy is associated with a 7.9% increase in GDP per capita, on average.</p>
<p>We also have a coefficient with a <code>hu_</code> prefix: <code>hu_(Intercept)</code>. This is the intercept for the logistic regression model used for the hurdle (0/not 0) process, and it’s measured on the logit scale. That means we can back-transform it to proportions or probabilities with <code><a href="https://rdrr.io/r/stats/Logistic.html">plogis()</a></code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hu_intercept</span> <span class="op">&lt;-</span> <span class="fu">tidy</span><span class="op">(</span><span class="va">model_gdp_hurdle</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">term</span> <span class="op">==</span> <span class="st">"hu_(Intercept)"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">pull</span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Logit scale intercept</span></span>
<span><span class="va">hu_intercept</span></span>
<span><span class="co">## b_hu_Intercept </span></span>
<span><span class="co">##          -2.13</span></span>
<span></span>
<span><span class="co"># Transformed to a probability/proportion</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html">plogis</a></span><span class="op">(</span><span class="va">hu_intercept</span><span class="op">)</span></span>
<span><span class="co">## b_hu_Intercept </span></span>
<span><span class="co">##          0.106</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Since the hurdle part of the model includes only the intercept, this value represents the proportion of zeros in the data, or 10.6%. We can confirm with some <strong>dplyr</strong> magic:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">gapminder</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">count</span><span class="op">(</span><span class="va">is_zero</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>prop <span class="op">=</span> <span class="va">n</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 2 × 3</span></span>
<span><span class="co">##   is_zero     n  prop</span></span>
<span><span class="co">##   &lt;lgl&gt;   &lt;int&gt; &lt;dbl&gt;</span></span>
<span><span class="co">## 1 FALSE    1502 0.894</span></span>
<span><span class="co">## 2 TRUE      178 0.106</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>They’re the same!</p>
<p>The coefficients for the non-zero part of the model are basically the same as what we found with <code>model_log_gdp_no_zeros</code>, so why go through the hassle of creating a mixture model with the zero-process? Why not just filter out the zeros?</p>
<p>Because we combined the two processes in the same model, both processes are incorporated in the posterior distribution of GDP per capita. We can confirm this with a posterior predictive check. In the plot on the left, we can see that the model fits the exponential distribution of the data pretty well. It fits the zeros too, but we can’t actually see that part because of how small the plot is. To highlight the zero process, in the plot on the right we log the predicted values. Look how well those <span style="color:#d04e00;">■&nbsp;orange</span> posterior draws fit the actual <span style="color:#0086a8;">■&nbsp;blue</span> data!</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Exponential</span></span>
<span><span class="fu">pp_check</span><span class="op">(</span><span class="va">model_gdp_hurdle</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Logged</span></span>
<span><span class="va">pred</span> <span class="op">&lt;-</span> <span class="fu">posterior_predict</span><span class="op">(</span><span class="va">model_gdp_hurdle</span><span class="op">)</span></span>
<span><span class="fu">bayesplot</span><span class="fu">::</span><span class="fu">ppc_dens_overlay</span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log1p</a></span><span class="op">(</span><span class="va">gapminder</span><span class="op">$</span><span class="va">gdpPercap</span><span class="op">)</span>, </span>
<span>                            yrep <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log1p</a></span><span class="op">(</span><span class="va">pred</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,<span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-pp-model-gdp-hurdle-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>Additionally, when we make predictions, most of the predicted values will be some big number, but about 10% of them will be 0, corresponding to the modeled proportion of zeros. Any predictions we make using the posterior from the model should inherently reflect the zero process. If we make a histogram of predicted draws from the model, we’ll see around 10% of the predictions are 0, as expected:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pred_gdp_hurdle</span> <span class="op">&lt;-</span> <span class="va">model_gdp_hurdle</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">predicted_draws</span><span class="op">(</span>newdata <span class="op">=</span> <span class="fu">tibble</span><span class="op">(</span>lifeExp <span class="op">=</span> <span class="fl">60</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>is_zero <span class="op">=</span> <span class="va">.prediction</span> <span class="op">==</span> <span class="fl">0</span>,</span>
<span>         .prediction <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">is_zero</span>, <span class="va">.prediction</span> <span class="op">-</span> <span class="fl">0.1</span>, <span class="va">.prediction</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">pred_gdp_hurdle</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">.prediction</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">is_zero</span><span class="op">)</span>, binwidth <span class="op">=</span> <span class="fl">2500</span>, </span>
<span>                 boundary <span class="op">=</span> <span class="fl">0</span>, color <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_dollar</span><span class="op">(</span>scale_cut <span class="op">=</span> <span class="fu">cut_short_scale</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">clrs</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, </span>
<span>                    guide <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>reverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"GDP per capita"</span>, y <span class="op">=</span> <span class="st">"Count"</span>, fill <span class="op">=</span> <span class="st">"Is zero?"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"Predicted GDP per capita from hurdle model"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2500</span>, <span class="fl">75000</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_nice</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-predicted-gdp-hurdle-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
</section><section id="hurdle-model-with-additional-terms" class="level4"><h4 class="anchored" data-anchor-id="hurdle-model-with-additional-terms">Hurdle model with additional terms</h4>
<p>Right now, all we’ve modeled is the overall proportion of 0s. We haven’t modeled what determines those zeros. Fortunately in this case we know what that process is—we made it so that rows with a life expectancy of less than 50 had a 30% chance of being zero, while rows with a life expectancy of greater than 50 had a 2% chance of being zero. Life expectancy should thus strongly predict the 0/not 0 process. Let’s include it in the <code>hu</code> part of the model:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/model-gdp-hurdle-life_0ab168d341a6f3a90728bf69897c5aee">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_gdp_hurdle_life</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span></span>
<span>  <span class="fu">bf</span><span class="op">(</span><span class="va">gdpPercap</span> <span class="op">~</span> <span class="va">lifeExp</span>,</span>
<span>     <span class="va">hu</span> <span class="op">~</span> <span class="va">lifeExp</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">gapminder</span>,</span>
<span>  family <span class="op">=</span> <span class="fu">hurdle_lognormal</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  chains <span class="op">=</span> <span class="va">CHAINS</span>, iter <span class="op">=</span> <span class="va">ITER</span>, warmup <span class="op">=</span> <span class="va">WARMUP</span>, seed <span class="op">=</span> <span class="va">BAYES_SEED</span>,</span>
<span>  silent <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_gdp_hurdle_life</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 5 × 8</span></span>
<span><span class="co">##   effect   component group    term            estimate std.error conf.low conf.high</span></span>
<span><span class="co">##   &lt;chr&gt;    &lt;chr&gt;     &lt;chr&gt;    &lt;chr&gt;              &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 fixed    cond      &lt;NA&gt;     (Intercept)       3.47     0.0924    3.29      3.65  </span></span>
<span><span class="co">## 2 fixed    cond      &lt;NA&gt;     hu_(Intercept)    3.15     0.415     2.34      3.99  </span></span>
<span><span class="co">## 3 fixed    cond      &lt;NA&gt;     lifeExp           0.0785   0.00149   0.0756    0.0815</span></span>
<span><span class="co">## 4 fixed    cond      &lt;NA&gt;     hu_lifeExp       -0.0992   0.00844  -0.116    -0.0830</span></span>
<span><span class="co">## 5 ran_pars cond      Residual sd__Observation   0.736    0.0131    0.710     0.761</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="extracting-and-interpreting-coefficients-from-a-hurdle-model" class="level4"><h4 class="anchored" data-anchor-id="extracting-and-interpreting-coefficients-from-a-hurdle-model">Extracting and interpreting coefficients from a hurdle model</h4>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
More on average marginal effects
</div>
</div>
<div class="callout-body-container callout-body">
<p>After writing this guide, <a href="https://www.andrewheiss.com/blog/2022/05/20/marginalia/">I wrote another detailed guide about the exact differences between average marginal effects, marginal effects at the mean, and a bunch of other marginal-related things</a>, comparing <strong>emmeans</strong> with <strong>marginaleffects</strong>, two packages that take different approaches to calculating marginal effects from regression models. In the rest of this guide, I’m pretty inexact about the nuances between marginal effects and the output of <code>emtrends()</code>, which technically returns marginal effects at the mean and <em>not</em> average marginal effects. So keep that caveat in mind throughout.</p>
<p>You can extract non-hurdled effects, hurdled effects, and expected values from these models using either <strong>emmeans</strong> or <strong>marginaleffects</strong>. I use <strong>emmeans</strong> throughout the rest of this guide; <a href="https://vincentarelbundock.github.io/marginaleffects/articles/transformation.html#back-transforming-lognormal-hurdle-models">see this vignette for an example</a> with <strong>marginaleffects</strong>.</p>
</div>
</div>
<p>In this model, the non-hurdled coefficients are the same as before—a one-year increase in life expectancy is still associated with a 7.8% increase in GDP per capita, on average. But now we have a new term, <code>hu_lifeExp</code>, which shows the effect of life expectancy in the hurdling process. Since this is on the logit scale, we can combine it with the hurdle intercept and transform the coefficient into percentage points (see <a href="http://post8000.svmiller.com/lab-scripts/logistic-regression-lab.html">Steven Miller’s lab script here</a> for more on this process, or <a href="https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/#2-fractional-logistic-regression">this section on fractional logistic regression</a>):</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hurdle_intercept</span> <span class="op">&lt;-</span> <span class="fu">tidy</span><span class="op">(</span><span class="va">model_gdp_hurdle_life</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">term</span> <span class="op">==</span> <span class="st">"hu_(Intercept)"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">pull</span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span></span>
<span></span>
<span><span class="va">hurdle_lifeexp</span> <span class="op">&lt;-</span> <span class="fu">tidy</span><span class="op">(</span><span class="va">model_gdp_hurdle_life</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">term</span> <span class="op">==</span> <span class="st">"hu_lifeExp"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">pull</span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html">plogis</a></span><span class="op">(</span><span class="va">hurdle_intercept</span> <span class="op">+</span> <span class="va">hurdle_lifeexp</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html">plogis</a></span><span class="op">(</span><span class="va">hurdle_intercept</span><span class="op">)</span></span>
<span><span class="co">## b_hu_Intercept </span></span>
<span><span class="co">##       -0.00408</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A one-year increase in life expectancy thus <em>decreases</em> the probability of seeing a 0 in GDP per capita by 0.41 percentage points, on average. That’s neat!</p>
<p>Doing the complicated <code>plogis(intercept + coefficient) - plogis(intercept)</code> to convert logit-scale marginal effects and logit-scale predicted values as percentage points is tricky, though, especially once more coefficients are involved. It’s easy to mess up that math.</p>
<p>Instead, we can calculate marginal effects automatically using a couple different methods:</p>
<ol type="1">
<li>
<strong>brms</strong>’s <code>conditonal_effects()</code> will plot predicted values of specific coefficients while holding all other variables constant, and it converts the results to their original scales. It automatically creates a plot, which is nice, but extracting the data out of the object is a little tricky and convoluted.</li>
<li>Packages like <strong>emmeans</strong> or <strong>marginaleffects</strong> can calculate marginal effects and predicted values on their original scales too. For more details, <a href="https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/#2-fractional-logistic-regression">see my blog post on beta regression</a>, or the documentation for <strong>emmeans</strong> or <strong>marginaleffects</strong>. Also see <a href="https://www.andrewheiss.com/blog/2022/05/20/marginalia/">this mega detailed guide here</a> for more about marginal effects.</li>
</ol></section><section id="brmsconditional_effects-with-hurdle-models" class="level4"><h4 class="anchored" data-anchor-id="brmsconditional_effects-with-hurdle-models">
<code>brms::conditional_effects()</code> with hurdle models</h4>
<p>Since we’re working with a mixture model, the syntax for dealing with conditional/marginal effects is a little different, as the <code>lifeExp</code> variable exists in both the non-zero and the zero processes of the model. We can specify which version of <code>lifeExp</code> we want to work with using the <code>dpar</code> argument (<strong>d</strong>istributional <strong>par</strong>ameter) in <code>conditional_effects()</code>. By default, <code>conditional_effects()</code> will return the marginal/conditional means of the combined process using both the non-zero part <code>mu</code> and the zero part <code>hu</code>. If we want to see the 0/not 0 hurdle part, we can specify <code>dpar = "hu</code>“. The <code>conditional_effects()</code> function helpfully converts the predicted values into their original scales: when showing predicted life expectancy, it unlogs the values; when showing predicted proportion of zeros, it unlogits the values.</p>
<p>We can see both processes of the model simultaneously—at low levels of life expectancy, the probability of reporting no GDP per capita is fairly high, and the predicted level of GDP per capita is really low. As life expectancy increases, the probability of seeing a 0 drops and predicted wealth increases.</p>
<p>(Note that these plots look fancier than what you normally get when just running <code>conditional_effects(model_name)</code> in R. That’s because I extracted the plot data and built my own graph for this post. You can see the code for that at the <a href="https://github.com/andrewheiss/ath-hugo/blob/main/content/blog/2022-05-09_hurdle-lognormal-gaussian-brms/index.Rmarkdown">source Rmd for this post</a>.)</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">conditional_effects</span><span class="op">(</span><span class="va">model_gdp_hurdle_life</span><span class="op">)</span></span>
<span><span class="fu">conditional_effects</span><span class="op">(</span><span class="va">model_gdp_hurdle_life</span>, dpar <span class="op">=</span> <span class="st">"hu"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-conditional-gdp-life-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
</section><section id="emmeans-with-hurdle-models" class="level4"><h4 class="anchored" data-anchor-id="emmeans-with-hurdle-models">
<strong>emmeans</strong> with hurdle models</h4>
<p>While <code>conditional_effects()</code> is great for a quick marginal effects plot like this, we can’t see just the <code>mu</code> part of the model in isolation. More importantly, plots alone don’t help with determining the exact slope of the line at each point on the original scale. We know from the model results that a one-year increase in life expectancy is associated with a 7.8% increase in GDP per capita, and that’s apparent in the curviness of the conditional effects plot. But if we want to know the original-scale slope at 60 years, for instance (e.g.&nbsp;an increase in life expectancy from 60 to 61 years is associated with a $X increase in GDP per capita), that’s trickier. It’s even trickier when working with the hurdle part of the model. Moving from 60 to 61 years decreases the probability of seeing a 0 by… some percentage point amount… but without doing a bunch of <code><a href="https://rdrr.io/r/stats/Logistic.html">plogis()</a></code> math, it’s not obvious how to get that value. Fortunately <code>emmeans::emtrends()</code> makes this easy. Like <code>brms::conditional_effects()</code>, by default, functions from <strong>emmeans</strong> like <code>emmeans()</code> and <code>emtrends()</code> will return the marginal means of the combined non-zero and zero/not-zero process, or both <code>mu</code> and <code>hu</code>. We can specify <code>dpar = "mu"</code> to get just the <code>mu</code> part (both logged and unlogged) and <code>dpar = "hu"</code> to get the logit part (both as logits and probabilities).</p>
<section id="non-zero-mu-part-only" class="level5"><h5 class="anchored" data-anchor-id="non-zero-mu-part-only">Non-zero <code>mu</code> part only</h5>
<p>We can feed the model a bunch of possible different life expectancy values to see how steep the slope of the non-zero part is at each value. Because there are no interaction terms or random effects or anything fancy, this log-scale slope will be the same at every possible value of life expectancy—GDP per capita increases by 7.8% for each one-year increase in life expectancy.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_gdp_hurdle_life</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">emtrends</span><span class="op">(</span><span class="op">~</span> <span class="va">lifeExp</span>, var <span class="op">=</span> <span class="st">"lifeExp"</span>, dpar <span class="op">=</span> <span class="st">"mu"</span>,</span>
<span>           at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>lifeExp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">80</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">##  lifeExp lifeExp.trend lower.HPD upper.HPD</span></span>
<span><span class="co">##       30        0.0784    0.0756    0.0815</span></span>
<span><span class="co">##       40        0.0784    0.0756    0.0815</span></span>
<span><span class="co">##       50        0.0784    0.0756    0.0815</span></span>
<span><span class="co">##       60        0.0784    0.0756    0.0815</span></span>
<span><span class="co">##       70        0.0784    0.0756    0.0815</span></span>
<span><span class="co">##       80        0.0784    0.0756    0.0815</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Point estimate displayed: median </span></span>
<span><span class="co">## HPD interval probability: 0.95</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If we want to interpret more concrete numbers (i.e.&nbsp;dollars instead of percents), we should back-transform these slopes to the original dollar scale. This is a little tricky, though, because GDP per capita was logged before going into the model. If we try including <code>regrid = "response"</code> to have <code>emtrends()</code> back-transform the result, it won’t change anything:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_gdp_hurdle_life</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">emtrends</span><span class="op">(</span><span class="op">~</span> <span class="va">lifeExp</span>, var <span class="op">=</span> <span class="st">"lifeExp"</span>, dpar <span class="op">=</span> <span class="st">"mu"</span>, regrid <span class="op">=</span> <span class="st">"response"</span>,</span>
<span>           at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>lifeExp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">80</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">##  lifeExp lifeExp.trend lower.HPD upper.HPD</span></span>
<span><span class="co">##       30        0.0784    0.0756    0.0815</span></span>
<span><span class="co">##       40        0.0784    0.0756    0.0815</span></span>
<span><span class="co">##       50        0.0784    0.0756    0.0815</span></span>
<span><span class="co">##       60        0.0784    0.0756    0.0815</span></span>
<span><span class="co">##       70        0.0784    0.0756    0.0815</span></span>
<span><span class="co">##       80        0.0784    0.0756    0.0815</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Point estimate displayed: median </span></span>
<span><span class="co">## HPD interval probability: 0.95</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Behind the scenes, <code>emtrends()</code> calculates the numeric derivative (or instantaneous slope) by adding a tiny amount to each of the given levels of <code>lifeExp</code> (i.e.&nbsp;<code>lifeExp = 30</code> and <code>lifeExp = 30.001</code>) and then calculates the slope of the line that goes through each of those predicted points. In order to back-transform the slopes, we need to transform the predicted values <em>before</em> calculating the instantaneous slopes. To get this ordering right, we need to include a couple extra arguments: <code>tran = "log"</code> to trick <code>emtrends()</code> into thinking that it’s working with logged values and <code>type = "response"</code> to tell <code>emtrends()</code> to unlog the estimates after calculating the slopes. (This only works with the development version of <strong>brms</strong> installed on or after May 31, 2022; <strong><em>huge</em></strong> thanks to <a href="https://sites.google.com/view/mattansb">Mattan Ben-Shachar</a> for <a href="https://github.com/andrewheiss/ath-hugo/commit/70197c7389c87b46db6cd61fc1ef8ce7b5c94616#commitcomment-74350632">originally pointing this out</a> and for <a href="https://github.com/paul-buerkner/brms/issues/1360">opening an issue and getting it fixed</a> at both <strong>brms</strong> and <strong>emmeans</strong>!)</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_gdp_hurdle_life</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">emtrends</span><span class="op">(</span><span class="op">~</span> <span class="va">lifeExp</span>, var <span class="op">=</span> <span class="st">"lifeExp"</span>, dpar <span class="op">=</span> <span class="st">"mu"</span>, </span>
<span>           regrid <span class="op">=</span> <span class="st">"response"</span>, tran <span class="op">=</span> <span class="st">"log"</span>, type <span class="op">=</span> <span class="st">"response"</span>,</span>
<span>           at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>lifeExp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">80</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">##  lifeExp lifeExp.trend lower.HPD upper.HPD</span></span>
<span><span class="co">##       30            27        25        29</span></span>
<span><span class="co">##       40            59        56        61</span></span>
<span><span class="co">##       50           128       124       133</span></span>
<span><span class="co">##       60           281       268       296</span></span>
<span><span class="co">##       70           617       573       664</span></span>
<span><span class="co">##       80          1352      1219      1489</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Point estimate displayed: median </span></span>
<span><span class="co">## HPD interval probability: 0.95</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice how they’re no longer the same at each level—that’s because in the non-logged world, this trend is curved. These represent the instantaneous slopes at each of these values of life expectancy in just the <code>mu</code> part of the model. At 60 years, a one-year increase in life expectancy is associated with a \$281 increase in GDP per capita; at 70, it’s associated with a \$617 increase.</p>
<p>Alternatively, we can use the <strong>marginaleffects</strong> package to get the instantaneous <code>mu</code>-part slopes as well. Here we just need to tell it to exponentiate the predicted values for each level of life expectancy before calculating the numeric derivative using the <code>transform_pre = "expdydx"</code> argument. (This also only works with the development version of <strong>marginaleffects</strong> installed on or after May 31, 2022.)</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://marginaleffects.com/">marginaleffects</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_gdp_hurdle_life</span> <span class="op">|&gt;</span> <span class="fu">comparisons</span><span class="op">(</span></span>
<span>  newdata <span class="op">=</span> <span class="fu">datagrid</span><span class="op">(</span>lifeExp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">80</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  dpar <span class="op">=</span> <span class="st">"mu"</span>, </span>
<span>  transform_pre <span class="op">=</span> <span class="st">"expdydx"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     Term   Contrast Estimate  2.5 % 97.5 %</span></span>
<span><span class="co">##  lifeExp exp(dY/dX)     26.5   24.9   28.2</span></span>
<span><span class="co">##  lifeExp exp(dY/dX)     58.1   55.7   60.7</span></span>
<span><span class="co">##  lifeExp exp(dY/dX)    127.4  122.8  132.2</span></span>
<span><span class="co">##  lifeExp exp(dY/dX)    279.1  265.6  293.9</span></span>
<span><span class="co">##  lifeExp exp(dY/dX)    611.5  569.4  660.3</span></span>
<span><span class="co">##  lifeExp exp(dY/dX)   1340.9 1215.3 1490.3</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Columns: rowid, term, contrast, estimate, conf.low, conf.high, predicted, predicted_hi, predicted_lo, tmp_idx, gdpPercap, lifeExp</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For fun, we can plot the values of these slopes across a range of marginal effects. Importantly, the y-axis here is <em>not</em> the predicted value of GDP per capita—it’s the slope of life expectancy, or the first derivative of the <span style="color:#a00e00;">■&nbsp;red</span> line we made earlier with <code>conditional_effects()</code>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_gdp_hurdle_life</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">emtrends</span><span class="op">(</span><span class="op">~</span> <span class="va">lifeExp</span>, var <span class="op">=</span> <span class="st">"lifeExp"</span>, dpar <span class="op">=</span> <span class="st">"mu"</span>, </span>
<span>           regrid <span class="op">=</span> <span class="st">"response"</span>, tran <span class="op">=</span> <span class="st">"log"</span>, type <span class="op">=</span> <span class="st">"response"</span>,</span>
<span>           at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>lifeExp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">80</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">gather_emmeans_draws</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">lifeExp</span>, y <span class="op">=</span> <span class="va">.value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_lineribbon</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu">colorspace</span><span class="fu">::</span><span class="fu">lighten</span><span class="op">(</span><span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.95</span>, <span class="fl">0.7</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_dollar</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Life expectancy"</span>, y <span class="op">=</span> <span class="st">"Value of lifeExp coefficient\n(marginal effect)"</span>,</span>
<span>       fill <span class="op">=</span> <span class="st">"Credible interval"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"Marginal effect of life expectancy on GDP per capita"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"(mu part of model only)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_nice</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-emtrends-mfx-gdp-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
</section><section id="zero-hu-part-only" class="level5"><h5 class="anchored" data-anchor-id="zero-hu-part-only">Zero <code>hu</code> part only</h5>
<p>We can also deal with the hurdled parts of the model if we specify <code>dpar = "hu"</code>, like here, where we can look at the <code>hu_lifeExp</code> coefficient at different levels of life expectancy. The slope is consistent across the whole range, but that’s because it’s measured in logit units:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Logit-scale slopes</span></span>
<span><span class="va">model_gdp_hurdle_life</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">emtrends</span><span class="op">(</span><span class="op">~</span> <span class="va">lifeExp</span>, var <span class="op">=</span> <span class="st">"lifeExp"</span>, dpar <span class="op">=</span> <span class="st">"hu"</span>,</span>
<span>           at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>lifeExp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">80</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">##  lifeExp lifeExp.trend lower.HPD upper.HPD</span></span>
<span><span class="co">##       30       -0.0991    -0.117   -0.0839</span></span>
<span><span class="co">##       40       -0.0991    -0.117   -0.0839</span></span>
<span><span class="co">##       50       -0.0991    -0.117   -0.0839</span></span>
<span><span class="co">##       60       -0.0991    -0.117   -0.0839</span></span>
<span><span class="co">##       70       -0.0991    -0.117   -0.0839</span></span>
<span><span class="co">##       80       -0.0991    -0.117   -0.0839</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Point estimate displayed: median </span></span>
<span><span class="co">## HPD interval probability: 0.95</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can convert these slopes into proportions or percentage points by including the <code>regrid = "response"</code> argument. Note that we don’t need to also include <code>tran = "log"</code> and <code>type = "response"</code> like we did for the <code>mu</code> part—that’s because we’re not working with an outcome that’s on a strange pre-logged scale like <code>gdpPercap</code> is in the <code>mu</code> part. Here <code>emtrends()</code> knows that there’s a difference between the link (logit) and the response (percentage point) scales and it can switch between them easily.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Percentage-point-scale slopes</span></span>
<span><span class="va">model_gdp_hurdle_life</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">emtrends</span><span class="op">(</span><span class="op">~</span> <span class="va">lifeExp</span>, var <span class="op">=</span> <span class="st">"lifeExp"</span>, dpar <span class="op">=</span> <span class="st">"hu"</span>, regrid <span class="op">=</span> <span class="st">"response"</span>,</span>
<span>           at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>lifeExp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">80</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">##  lifeExp lifeExp.trend lower.HPD upper.HPD</span></span>
<span><span class="co">##       30      -0.02452  -0.02790  -0.02116</span></span>
<span><span class="co">##       40      -0.02102  -0.02626  -0.01669</span></span>
<span><span class="co">##       50      -0.01194  -0.01414  -0.00964</span></span>
<span><span class="co">##       60      -0.00532  -0.00612  -0.00450</span></span>
<span><span class="co">##       70      -0.00213  -0.00264  -0.00163</span></span>
<span><span class="co">##       80      -0.00082  -0.00114  -0.00053</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Point estimate displayed: median </span></span>
<span><span class="co">## HPD interval probability: 0.95</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The slope of the hurdle part is fairly steep and negative at low levels of life expectancy (-0.025 at 30 years), but it starts leveling out as life expectancy increases (-0.002 at 70 years).</p>
<p>Beyond <code>emtrends()</code>, we can use <code>emmeans()</code> to calculate predicted values of GDP per capita while holding all other variables constant. This is exactly what we did with <code>conditional_effects()</code> earlier—this just makes it easier to deal with the actual data itself instead of extracting the data from the ggplot object that <code>conditional_effects()</code> creates.</p>
<p>As we did with <code>emtrends()</code>, when dealing with the non-zero <code>mu</code> part we have to include all three extra <code>regrid</code>, <code>tran</code>, and <code>type</code> arguments to trick <code>emmeans()</code> into working with the pre-logged GDP values:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Predicted GDP per capita, logged</span></span>
<span><span class="va">model_gdp_hurdle_life</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">emmeans</span><span class="op">(</span><span class="op">~</span> <span class="va">lifeExp</span>, var <span class="op">=</span> <span class="st">"lifeExp"</span>, dpar <span class="op">=</span> <span class="st">"mu"</span>,</span>
<span>          at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>lifeExp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">80</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">##  lifeExp emmean lower.HPD upper.HPD</span></span>
<span><span class="co">##       30   5.83      5.73      5.93</span></span>
<span><span class="co">##       40   6.61      6.54      6.68</span></span>
<span><span class="co">##       50   7.40      7.35      7.45</span></span>
<span><span class="co">##       60   8.18      8.15      8.22</span></span>
<span><span class="co">##       70   8.97      8.92      9.01</span></span>
<span><span class="co">##       80   9.75      9.69      9.82</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Point estimate displayed: median </span></span>
<span><span class="co">## HPD interval probability: 0.95</span></span>
<span></span>
<span><span class="co"># Predicted GDP per capita, unlogged and back-transformed</span></span>
<span><span class="va">model_gdp_hurdle_life</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">emmeans</span><span class="op">(</span><span class="op">~</span> <span class="va">lifeExp</span>, var <span class="op">=</span> <span class="st">"lifeExp"</span>, dpar <span class="op">=</span> <span class="st">"mu"</span>,</span>
<span>          regrid <span class="op">=</span> <span class="st">"response"</span>, tran <span class="op">=</span> <span class="st">"log"</span>, type <span class="op">=</span> <span class="st">"response"</span>,</span>
<span>          at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>lifeExp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">80</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">##  lifeExp response lower.HPD upper.HPD</span></span>
<span><span class="co">##       30      340       309       374</span></span>
<span><span class="co">##       40      745       695       797</span></span>
<span><span class="co">##       50     1632      1558      1714</span></span>
<span><span class="co">##       60     3579      3446      3710</span></span>
<span><span class="co">##       70     7843      7480      8193</span></span>
<span><span class="co">##       80    17184     16088     18392</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Point estimate displayed: median </span></span>
<span><span class="co">## Results are back-transformed from the log scale </span></span>
<span><span class="co">## HPD interval probability: 0.95</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>When dealing with the hurdled part, we can convert the resulting logit-scale predictions to percentage points with just <code>regrid = "response"</code>, again like we did with <code>emtrends()</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Predicted proportion of zeros, logits</span></span>
<span><span class="va">model_gdp_hurdle_life</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">emmeans</span><span class="op">(</span><span class="op">~</span> <span class="va">lifeExp</span>, var <span class="op">=</span> <span class="st">"lifeExp"</span>, dpar <span class="op">=</span> <span class="st">"hu"</span>,</span>
<span>          at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>lifeExp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">80</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">##  lifeExp emmean lower.HPD upper.HPD</span></span>
<span><span class="co">##       30   0.18     -0.15      0.54</span></span>
<span><span class="co">##       40  -0.82     -1.02     -0.59</span></span>
<span><span class="co">##       50  -1.81     -1.97     -1.63</span></span>
<span><span class="co">##       60  -2.80     -3.06     -2.55</span></span>
<span><span class="co">##       70  -3.79     -4.21     -3.42</span></span>
<span><span class="co">##       80  -4.78     -5.33     -4.24</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Point estimate displayed: median </span></span>
<span><span class="co">## Results are given on the logit (not the response) scale. </span></span>
<span><span class="co">## HPD interval probability: 0.95</span></span>
<span></span>
<span><span class="co"># Predicted proportion of zeros, percentage points</span></span>
<span><span class="va">model_gdp_hurdle_life</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">emmeans</span><span class="op">(</span><span class="op">~</span> <span class="va">lifeExp</span>, var <span class="op">=</span> <span class="st">"lifeExp"</span>, dpar <span class="op">=</span> <span class="st">"hu"</span>, regrid <span class="op">=</span> <span class="st">"response"</span>,</span>
<span>          at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>lifeExp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">80</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">##  lifeExp response lower.HPD upper.HPD</span></span>
<span><span class="co">##       30    0.544     0.464     0.633</span></span>
<span><span class="co">##       40    0.306     0.260     0.352</span></span>
<span><span class="co">##       50    0.140     0.121     0.163</span></span>
<span><span class="co">##       60    0.057     0.044     0.072</span></span>
<span><span class="co">##       70    0.022     0.014     0.031</span></span>
<span><span class="co">##       80    0.008     0.005     0.014</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Point estimate displayed: median </span></span>
<span><span class="co">## HPD interval probability: 0.95</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can plot the results of <code>emmeans()</code> and create plots like the ones we made with <code>conditional_effects()</code>. I do this all the time in my regular research—I like being able to customize the plot fully rather than having to manipulate and readjust the pre-made <code>conditional_effects()</code> plot.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">plot_emmeans1</span> <span class="op">&lt;-</span> <span class="va">model_gdp_hurdle_life</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">emmeans</span><span class="op">(</span><span class="op">~</span> <span class="va">lifeExp</span>, var <span class="op">=</span> <span class="st">"lifeExp"</span>, dpar <span class="op">=</span> <span class="st">"mu"</span>,</span>
<span>          regrid <span class="op">=</span> <span class="st">"response"</span>, tran <span class="op">=</span> <span class="st">"log"</span>, type <span class="op">=</span> <span class="st">"response"</span>,</span>
<span>          at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>lifeExp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">80</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">gather_emmeans_draws</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>.value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">.value</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">lifeExp</span>, y <span class="op">=</span> <span class="va">.value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_lineribbon</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu">colorspace</span><span class="fu">::</span><span class="fu">lighten</span><span class="op">(</span><span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.95</span>, <span class="fl">0.7</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_dollar</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Life expectancy"</span>, y <span class="op">=</span> <span class="st">"Predicted GDP per capita"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Regular part of the model (dpar = \"mu\")"</span>,</span>
<span>       fill <span class="op">=</span> <span class="st">"Credible interval"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_nice</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_emmeans2</span> <span class="op">&lt;-</span> <span class="va">model_gdp_hurdle_life</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">emmeans</span><span class="op">(</span><span class="op">~</span> <span class="va">lifeExp</span>, var <span class="op">=</span> <span class="st">"lifeExp"</span>, dpar <span class="op">=</span> <span class="st">"hu"</span>, regrid <span class="op">=</span> <span class="st">"response"</span>,</span>
<span>          at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>lifeExp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">80</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">gather_emmeans_draws</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">lifeExp</span>, y <span class="op">=</span> <span class="va">.value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_lineribbon</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu">colorspace</span><span class="fu">::</span><span class="fu">lighten</span><span class="op">(</span><span class="va">clrs</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.95</span>, <span class="fl">0.7</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_percent</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Life expectancy"</span>, y <span class="op">=</span> <span class="st">"Predicted probability\nof seeing $0 GDP per capita"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Hurdle part of the model (dpar = \"hu\")"</span>,</span>
<span>       fill <span class="op">=</span> <span class="st">"Credible interval"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_nice</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="va">plot_emmeans1</span> <span class="op">/</span> <span class="va">plot_emmeans2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">plot_annotation</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Conditional effect of life expectancy on GDP per capita"</span>,</span>
<span>                  subtitle <span class="op">=</span> <span class="st">"Made with emmeans()"</span>,</span>
<span>                  theme <span class="op">=</span> <span class="fu">theme</span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Jost"</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>                                plot.subtitle <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Jost"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-emmeans-mfx-gdp-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
</section><section id="both-parts-of-the-model-simultaneously" class="level5"><h5 class="anchored" data-anchor-id="both-parts-of-the-model-simultaneously">Both parts of the model simultaneously</h5>
<p>So far we’ve looked at the <code>mu</code> and <code>hu</code> parts individually, but part of the magic of these models is that we can work with both processes simultaneously. When we ran <code>conditional_effects(model_gdp_hurdle_life)</code> without any <code>dpar</code> arguments, we saw predictions for both parts at the same time, but so far with <code>emmeans()</code> and <code>emtrends()</code>, we haven’t seen any of these combined values. To do this, we can calculate the expected value from the model and incorporate both parts simultaneously. In mathy terms, for this lognormal hurdle model, this is:</p>
<p><span class="math display">\[
\operatorname{E}[Y] = (1-\texttt{hu}) \times e^{\texttt{mu} + (\texttt{sigma}^2)/2}
\]</span></p>
<p>We can calculate this with <code>emtrends()</code> by including the <code>epred = TRUE</code> argument (to get expected values). We don’t need to transform anything to the response scale, and we don’t need to define a specific part of the model (<code>dpar = "mu"</code> or <code>dpar = "hu"</code>), since the output will automatically be on the dollar scale:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Dollar-scale slopes, incorporating both the mu and hu parts</span></span>
<span><span class="va">model_gdp_hurdle_life</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">emtrends</span><span class="op">(</span><span class="op">~</span> <span class="va">lifeExp</span>, var <span class="op">=</span> <span class="st">"lifeExp"</span>, epred <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>           at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>lifeExp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">80</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">##  lifeExp lifeExp.trend lower.HPD upper.HPD</span></span>
<span><span class="co">##       30            27        24        30</span></span>
<span><span class="co">##       40            74        69        79</span></span>
<span><span class="co">##       50           170       162       179</span></span>
<span><span class="co">##       60           373       354       394</span></span>
<span><span class="co">##       70           812       757       879</span></span>
<span><span class="co">##       80          1775      1612      1970</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Point estimate displayed: median </span></span>
<span><span class="co">## HPD interval probability: 0.95</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can also get predicted values with <code>emmeans()</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Dollar-scale predictions, incorporating both the mu and hu parts</span></span>
<span><span class="va">model_gdp_hurdle_life</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">emmeans</span><span class="op">(</span><span class="op">~</span> <span class="va">lifeExp</span>, epred <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>          at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>lifeExp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">80</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">##  lifeExp emmean lower.HPD upper.HPD</span></span>
<span><span class="co">##       30    203       162       248</span></span>
<span><span class="co">##       40    677       612       745</span></span>
<span><span class="co">##       50   1839      1737      1947</span></span>
<span><span class="co">##       60   4425      4213      4597</span></span>
<span><span class="co">##       70  10056      9572     10564</span></span>
<span><span class="co">##       80  22336     20964     24078</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Point estimate displayed: median </span></span>
<span><span class="co">## HPD interval probability: 0.95</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And we can plot these combined predictions too. <em>This</em> is identical to <code>conditional_effects()</code>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_gdp_hurdle_life</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">emmeans</span><span class="op">(</span><span class="op">~</span> <span class="va">lifeExp</span>, epred <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>          at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>lifeExp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">80</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">gather_emmeans_draws</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">lifeExp</span>, y <span class="op">=</span> <span class="va">.value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_lineribbon</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu">colorspace</span><span class="fu">::</span><span class="fu">lighten</span><span class="op">(</span><span class="va">clrs</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.95</span>, <span class="fl">0.7</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_dollar</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Life expectancy"</span>, y <span class="op">=</span> <span class="st">"Predicted GDP per capita"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"Predicted values incorporating both hu and mu"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"epred = TRUE"</span>,</span>
<span>       fill <span class="op">=</span> <span class="st">"Credible interval"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_nice</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-epred-gdp-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
</section><section id="all-three-types-of-predictions-at-the-same-time" class="level5"><h5 class="anchored" data-anchor-id="all-three-types-of-predictions-at-the-same-time">All three types of predictions at the same time</h5>
<p>For fun, we can plot the combined predictions, the <code>mu</code>-only predictions, and the <code>hu</code>-only predictions at the same time to see how they differ:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">plot_emmeans0</span> <span class="op">&lt;-</span> <span class="va">model_gdp_hurdle_life</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">emmeans</span><span class="op">(</span><span class="op">~</span> <span class="va">lifeExp</span>, var <span class="op">=</span> <span class="st">"lifeExp"</span>, epred <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>          at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>lifeExp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">80</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">gather_emmeans_draws</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">lifeExp</span>, y <span class="op">=</span> <span class="va">.value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_lineribbon</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu">colorspace</span><span class="fu">::</span><span class="fu">lighten</span><span class="op">(</span><span class="va">clrs</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.95</span>, <span class="fl">0.7</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_dollar</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Life expectancy"</span>, y <span class="op">=</span> <span class="st">"Predicted GDP per capita"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Expected values from mu and hu parts (epred = TRUE)"</span>,</span>
<span>       fill <span class="op">=</span> <span class="st">"Credible interval"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_nice</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="va">plot_emmeans0</span> <span class="op">/</span> <span class="va">plot_emmeans1</span> <span class="op">/</span> <span class="va">plot_emmeans2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">plot_annotation</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Conditional effect of life expectancy on GDP per capita"</span>,</span>
<span>                  theme <span class="op">=</span> <span class="fu">theme</span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Jost"</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>                                plot.subtitle <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Jost"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-emmeans-mfx-gdp-all-epred-too-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>The combined expected values produce larger predictions (with $10,000 at 70 years, for instance) than the <code>mu</code> part alone (with $7,500ish at 70 years). In real life, it’s probably best to work with predictions that incorporate both parts of the model, since that’s the whole point of doing this combined mixture model in the first place (otherwise we could just fit two separate models ourselves), but it’s super neat that we can still work with the predictions and slopes for the <code>mu</code> and <code>hu</code> parts separately.</p>
</section></section><section id="predictions-with-hurdle-models" class="level4"><h4 class="anchored" data-anchor-id="predictions-with-hurdle-models">Predictions with hurdle models</h4>
<p>The underlying prediction functions from <strong>brms</strong>—as well as other functions that wrap around them like <code>gather_draws()</code> from <a href="https://mjskay.github.io/tidybayes/"><strong>tidybayes</strong></a>—also incorporate the zero process. We can confirm this by predicting GDP per capita for two different values of life expectancy. There’s a huge proportion of zeros for countries with low life expectancy, and overall predicted GDP per capita is really low. There’s a much smaller proportion of zeros for countries with high life expectancy, and the distribution of wealth is more spread out.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pred_gdp_hurdle_life</span> <span class="op">&lt;-</span> <span class="va">model_gdp_hurdle_life</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">predicted_draws</span><span class="op">(</span>newdata <span class="op">=</span> <span class="fu">tibble</span><span class="op">(</span>lifeExp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">40</span>, <span class="fl">70</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>is_zero <span class="op">=</span> <span class="va">.prediction</span> <span class="op">==</span> <span class="fl">0</span>,</span>
<span>         .prediction <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">is_zero</span>, <span class="va">.prediction</span> <span class="op">-</span> <span class="fl">0.1</span>, <span class="va">.prediction</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>nice_life <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">lifeExp</span>, <span class="st">" year life expectancy"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">pred_gdp_hurdle_life</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">.prediction</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">is_zero</span><span class="op">)</span>, binwidth <span class="op">=</span> <span class="fl">2500</span>, </span>
<span>                 boundary <span class="op">=</span> <span class="fl">0</span>, color <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_dollar</span><span class="op">(</span>scale_cut <span class="op">=</span> <span class="fu">cut_short_scale</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">clrs</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, </span>
<span>                    guide <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>reverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"GDP per capita"</span>, y <span class="op">=</span> <span class="cn">NULL</span>, fill <span class="op">=</span> <span class="st">"Is zero?"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"Predicted GDP per capita at different life expectancies"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2500</span>, <span class="fl">50000</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">nice_life</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_nice</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-pred-gdp-life-40-70-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section></section><section id="hurdle-lognormal-model-with-fancy-multilevel-things" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="hurdle-lognormal-model-with-fancy-multilevel-things">4. Hurdle lognormal model with fancy multilevel things</h3>
<p>So far we’ve actually been modeling this data all wrong. This is panel data, which means each country appears multiple times in the data across different years. We’ve been treating each row as completely independent, but that’s not the case—GDP per capita in all these Afghanistan rows, for instance, is dependent on the year, and there are Afghanistan-specific trends that distinguish its GDP per capita from that of Albania. We need to take the structure of the panel data into account.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">gapminder</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 6 × 8</span></span>
<span><span class="co">##   country     continent  year lifeExp      pop gdpPercap log_gdpPercap is_zero</span></span>
<span><span class="co">##   &lt;fct&gt;       &lt;fct&gt;     &lt;int&gt;   &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt;         &lt;dbl&gt; &lt;lgl&gt;  </span></span>
<span><span class="co">## 1 Afghanistan Asia       1952    28.8  8425333      779.          6.66 FALSE  </span></span>
<span><span class="co">## 2 Afghanistan Asia       1957    30.3  9240934      821.          6.71 FALSE  </span></span>
<span><span class="co">## 3 Afghanistan Asia       1962    32.0 10267083      853.          6.75 FALSE  </span></span>
<span><span class="co">## 4 Afghanistan Asia       1967    34.0 11537966      836.          6.73 FALSE  </span></span>
<span><span class="co">## 5 Afghanistan Asia       1972    36.1 13079460        0           0    TRUE   </span></span>
<span><span class="co">## 6 Afghanistan Asia       1977    38.4 14880372      786.          6.67 FALSE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="https://www.andrewheiss.com/blog/2021/12/01/multilevel-models-panel-data-guide/">I have a whole guide about how to do this with multilevel models</a>—you should check it out for tons of details.</p>
<p>Here we’ll make it so each continent gets its own intercept, as well as continent-specific offsets to the slopes for life expectancy and year. Since we know the zero process (low values of life expectancy make it more likely to be 0), we’ll define a simple model there (though we could get as complex as we want). Ordinarily we’d want to do country-specific effects, but for the sake of computational time, we’ll just look at continents instead. (And even then, this takes a while! On my fancy M1 MacBook, this takes about 4 minutes; and there are all sorts of issues with divergent transitions that I’m going to ignore. In real life I’d set proper priors and scale the data down, but in this example I won’t worry about all that.)</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/model-gdp-hurdle-panel_501e07de31d8b735327387fd830a07cd">
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Shrink down year to make the model go faster</span></span>
<span><span class="va">gapminder_scaled</span> <span class="op">&lt;-</span> <span class="va">gapminder</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>year_orig <span class="op">=</span> <span class="va">year</span>,</span>
<span>         year <span class="op">=</span> <span class="va">year</span> <span class="op">-</span> <span class="fl">1952</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_gdp_hurdle_panel</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span></span>
<span>  <span class="fu">bf</span><span class="op">(</span><span class="va">gdpPercap</span> <span class="op">~</span> <span class="va">lifeExp</span> <span class="op">+</span> <span class="va">year</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">lifeExp</span> <span class="op">+</span> <span class="va">year</span> <span class="op">|</span> <span class="va">continent</span><span class="op">)</span>,</span>
<span>     <span class="va">hu</span> <span class="op">~</span> <span class="va">lifeExp</span>,</span>
<span>     decomp <span class="op">=</span> <span class="st">"QR"</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">gapminder_scaled</span>,</span>
<span>  family <span class="op">=</span> <span class="fu">hurdle_lognormal</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  chains <span class="op">=</span> <span class="va">CHAINS</span>, iter <span class="op">=</span> <span class="va">ITER</span>, warmup <span class="op">=</span> <span class="va">WARMUP</span>, seed <span class="op">=</span> <span class="va">BAYES_SEED</span>,</span>
<span>  silent <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  threads <span class="op">=</span> <span class="fu">threading</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>  <span class="co"># Two CPUs per chain to speed things up</span></span>
<span><span class="op">)</span></span>
<span><span class="co">## Warning: 248 of 4000 (6.0%) transitions ended with a divergence.</span></span>
<span><span class="co">## See https://mc-stan.org/misc/warnings for details.</span></span>
<span><span class="co">## Warning: 541 of 4000 (14.0%) transitions hit the maximum treedepth limit of 10.</span></span>
<span><span class="co">## See https://mc-stan.org/misc/warnings for details.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_gdp_hurdle_panel</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 12 × 8</span></span>
<span><span class="co">##    effect   component group     term                     estimate std.error conf.low conf.high</span></span>
<span><span class="co">##    &lt;chr&gt;    &lt;chr&gt;     &lt;chr&gt;     &lt;chr&gt;                       &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">##  1 fixed    cond      &lt;NA&gt;      (Intercept)               3.29      1.03     1.19      5.47   </span></span>
<span><span class="co">##  2 fixed    cond      &lt;NA&gt;      hu_(Intercept)            3.15      0.417    2.36      3.99   </span></span>
<span><span class="co">##  3 fixed    cond      &lt;NA&gt;      hu_lifeExp               -0.0993    0.00845 -0.117    -0.0834 </span></span>
<span><span class="co">##  4 fixed    cond      &lt;NA&gt;      lifeExp                   0.0846    0.0169   0.0491    0.120  </span></span>
<span><span class="co">##  5 fixed    cond      &lt;NA&gt;      year                     -0.00990   0.00949 -0.0309    0.00985</span></span>
<span><span class="co">##  6 ran_pars cond      continent sd__(Intercept)           2.03      0.889    0.880     4.30   </span></span>
<span><span class="co">##  7 ran_pars cond      continent sd__lifeExp               0.0335    0.0164   0.0140    0.0749 </span></span>
<span><span class="co">##  8 ran_pars cond      continent sd__year                  0.0169    0.0148   0.00374   0.0568 </span></span>
<span><span class="co">##  9 ran_pars cond      continent cor__(Intercept).lifeExp -0.655     0.322   -0.986     0.215  </span></span>
<span><span class="co">## 10 ran_pars cond      continent cor__(Intercept).year    -0.161     0.412   -0.823     0.682  </span></span>
<span><span class="co">## 11 ran_pars cond      continent cor__lifeExp.year         0.0337    0.423   -0.759     0.779  </span></span>
<span><span class="co">## 12 ran_pars cond      Residual  sd__Observation           0.678     0.0127   0.653     0.703</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This complex model has a whole bunch of moving parts now! We have coefficients for the 0/not 0 process, coefficients for the non-zero process, and random effects (and their corresponding correlations) for the non-zero process. The hurdle coefficients are the same that we saw earlier, since that part of the model is unchanged. The non-zero coefficients now take the panel structure of the data into account, showing that on average, a one-year change in life expectancy is associated with a 8.5% increase in GDP per capita, on average.</p>
<p>The actual dollar amount of GDP per capita depends on the existing level of life expectancy, but as before, we can visualize this with either <code>conditional_effects()</code> or <code>emmeans()</code>. We’ll do it both ways for fun, and we’ll look at predicted GDP per capita across different continents and years too, since we have that information.</p>
<p>In order to calculate conditional effects with <code>conditional_effects()</code>, we have to use some special syntax. We need to (1) specify <code>re_formula = NULL</code> so that the predictions take the random effects structure into account (<a href="https://www.andrewheiss.com/blog/2021/11/10/ame-bayes-re-guide/">see this post for way more about that</a>), and (2) create a data frame of year and continent values, along with a special <code>cond__</code> column that will be used for the facet titles.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">conditions</span> <span class="op">&lt;-</span> <span class="fu">expand_grid</span><span class="op">(</span>year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">55</span><span class="op">)</span>,</span>
<span>                          continent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">gapminder</span><span class="op">$</span><span class="va">continent</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>cond__ <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">year</span> <span class="op">+</span> <span class="fl">1952</span>, <span class="st">": "</span>, <span class="va">continent</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">conditional_effects</span><span class="op">(</span><span class="va">model_gdp_hurdle_panel</span>, effects <span class="op">=</span> <span class="st">"lifeExp"</span>,</span>
<span>                    conditions <span class="op">=</span> <span class="va">conditions</span>,</span>
<span>                    re_formula <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span>ncol <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/plot-gdp-hurdle-panel-conditional-effects-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page-inset-right" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>This is so neat! Across all continents, GDP per capita increases as life expectancy increases, but that relationship looks different across continents (compare Asia with Africa, for instance), and across time (1952 Asia looks a lot different from 2007 Asia).</p>
<p>The <code>conditional_effects()</code> function is great for a quick look at the predicted values, but if we want complete control over the predictions and the plot, we can use <code>emmeans()</code> instead:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_gdp_hurdle_panel</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">emmeans</span><span class="op">(</span><span class="op">~</span> <span class="va">lifeExp</span> <span class="op">+</span> <span class="va">year</span> <span class="op">+</span> <span class="va">continent</span>, var <span class="op">=</span> <span class="st">"lifeExp"</span>,</span>
<span>          at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">55</span><span class="op">)</span>, </span>
<span>                    continent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">gapminder</span><span class="op">$</span><span class="va">continent</span><span class="op">)</span>,</span>
<span>                    lifeExp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">80</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>          epred <span class="op">=</span> <span class="cn">TRUE</span>, re_formula <span class="op">=</span> <span class="cn">NULL</span>, allow_new_levels <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">gather_emmeans_draws</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>year <span class="op">=</span> <span class="va">year</span> <span class="op">+</span> <span class="fl">1952</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">lifeExp</span>, y <span class="op">=</span> <span class="va">.value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_lineribbon</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">continent</span>, fill <span class="op">=</span> <span class="va">continent</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1</span>, alpha <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_dollar</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_nested_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">year</span>, <span class="va">continent</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">2</span>, </span>
<span>                    strip <span class="op">=</span> <span class="fu">strip_nested</span><span class="op">(</span></span>
<span>                      text_x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu">element_text</span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Jost"</span>, </span>
<span>                                                 face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>, <span class="cn">NULL</span><span class="op">)</span>,</span>
<span>                      background_x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu">element_rect</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"grey92"</span><span class="op">)</span>, <span class="cn">NULL</span><span class="op">)</span>,</span>
<span>                      by_layer_x <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Life expectancy"</span>, y <span class="op">=</span> <span class="st">"Predicted GDP per capita"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"Predicted GDP per capita across life expectancy, continent, and time"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_nice</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/plot-gdp-hurdle-panel-emmeans-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page-inset-right" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>We can also look at the slopes or marginal effects of these predictions, which lets us answer questions like “how much does GDP per capita increase in Asia countries with high life expectancy in 2007.” To do this, we’ll turn to <code>emtrends()</code> to see predicted slopes for <code>lifeExp</code> while holding other model variables constant.</p>
<p>If we leave the coefficients on the log scale, there won’t be any change across life expectancy, since the trend increases by the same percentage each year. There are continent-specific differences now, though: the relationship is steeper in Europe (11.4%) than in Africa (6.1%)</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ame_model_gdp_hurdle_panel_log</span> <span class="op">&lt;-</span> <span class="va">model_gdp_hurdle_panel</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">emtrends</span><span class="op">(</span><span class="op">~</span> <span class="va">lifeExp</span> <span class="op">+</span> <span class="va">year</span> <span class="op">+</span> <span class="va">continent</span>,</span>
<span>           var <span class="op">=</span> <span class="st">"lifeExp"</span>,</span>
<span>           at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fl">0</span>, continent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">gapminder</span><span class="op">$</span><span class="va">continent</span><span class="op">)</span>,</span>
<span>                     lifeExp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">40</span>, <span class="fl">70</span><span class="op">)</span><span class="op">)</span>,</span>
<span>           re_formula <span class="op">=</span> <span class="cn">NULL</span>, allow_new_levels <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">ame_model_gdp_hurdle_panel_log</span></span>
<span><span class="co">##  lifeExp year continent lifeExp.trend lower.HPD upper.HPD</span></span>
<span><span class="co">##       40    0 Africa           0.0607    0.0529    0.0676</span></span>
<span><span class="co">##       70    0 Africa           0.0607    0.0529    0.0676</span></span>
<span><span class="co">##       40    0 Americas         0.0676    0.0561    0.0793</span></span>
<span><span class="co">##       70    0 Americas         0.0676    0.0561    0.0793</span></span>
<span><span class="co">##       40    0 Asia             0.0945    0.0863    0.1029</span></span>
<span><span class="co">##       70    0 Asia             0.0945    0.0863    0.1029</span></span>
<span><span class="co">##       40    0 Europe           0.1140    0.0959    0.1329</span></span>
<span><span class="co">##       70    0 Europe           0.1140    0.0959    0.1329</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Point estimate displayed: median </span></span>
<span><span class="co">## HPD interval probability: 0.95</span></span>
<span></span>
<span><span class="va">ame_model_gdp_hurdle_panel_log</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">gather_emmeans_draws</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>nice_life <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">lifeExp</span>, <span class="st">" year life expectancy"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">.value</span>, y <span class="op">=</span> <span class="va">continent</span>, fill <span class="op">=</span> <span class="va">continent</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_slabinterval</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_percent</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Marginal effect of life expectancy on GDP per capita"</span>, y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"Marginal effect of life expectancy, log-scale coefficients"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">nice_life</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_nice</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-mfx-life-log-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>However, if we convert the coefficients to the original unlogged dollar scale, there are substantial changes across life expectancy, as we saw earlier. Only now we can also incorporate continent and year effects too. Asian countries with a 40-year life expectancy have a life expectancy slope of \$82, while Asian countries with a 70-year life expectancy have a slope of \$1,532, on average.</p>
<p>Neat!</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ame_model_gdp_hurdle_panel_nolog</span> <span class="op">&lt;-</span> <span class="va">model_gdp_hurdle_panel</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">emtrends</span><span class="op">(</span><span class="op">~</span> <span class="va">lifeExp</span> <span class="op">+</span> <span class="va">year</span> <span class="op">+</span> <span class="va">continent</span>,</span>
<span>           var <span class="op">=</span> <span class="st">"lifeExp"</span>,</span>
<span>           at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fl">0</span>, continent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">gapminder</span><span class="op">$</span><span class="va">continent</span><span class="op">)</span>,</span>
<span>                     lifeExp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">40</span>, <span class="fl">70</span><span class="op">)</span><span class="op">)</span>,</span>
<span>           re_formula <span class="op">=</span> <span class="cn">NULL</span>, epred <span class="op">=</span> <span class="cn">TRUE</span>, allow_new_levels <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">ame_model_gdp_hurdle_panel_nolog</span></span>
<span><span class="co">##  lifeExp year continent lifeExp.trend lower.HPD upper.HPD</span></span>
<span><span class="co">##       40    0 Africa               85        72        97</span></span>
<span><span class="co">##       70    0 Africa              508       343       696</span></span>
<span><span class="co">##       40    0 Americas            115        96       136</span></span>
<span><span class="co">##       70    0 Americas            881       591      1223</span></span>
<span><span class="co">##       40    0 Asia                 82        70        94</span></span>
<span><span class="co">##       70    0 Asia               1532      1130      2021</span></span>
<span><span class="co">##       40    0 Europe               39        25        54</span></span>
<span><span class="co">##       70    0 Europe             1367      1017      1773</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Point estimate displayed: median </span></span>
<span><span class="co">## HPD interval probability: 0.95</span></span>
<span></span>
<span><span class="va">ame_model_gdp_hurdle_panel_nolog</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">gather_emmeans_draws</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>nice_life <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">lifeExp</span>, <span class="st">" year life expectancy"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">.value</span>, y <span class="op">=</span> <span class="va">continent</span>, color <span class="op">=</span> <span class="va">continent</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_pointinterval</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_dollar</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Marginal effect of life expectancy on GDP per capita"</span>, y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"Marginal effect of life expectancy, dollar-scale coefficients"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">nice_life</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">1</span>, scales <span class="op">=</span> <span class="st">"free_x"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_nice</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-mfx-life-unlog-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>For extra bonus fun, we can look at how the dollar-scale marginal effect changes across more granular changes in life expectancy <em>and</em> across time <em>and</em> across continent.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ame_model_gdp_hurdle_panel_nolog_fancy</span> <span class="op">&lt;-</span> <span class="va">model_gdp_hurdle_panel</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">emtrends</span><span class="op">(</span><span class="op">~</span> <span class="va">lifeExp</span> <span class="op">+</span> <span class="va">year</span> <span class="op">+</span> <span class="va">continent</span>,</span>
<span>           var <span class="op">=</span> <span class="st">"lifeExp"</span>,</span>
<span>           at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">55</span><span class="op">)</span>, continent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">gapminder</span><span class="op">$</span><span class="va">continent</span><span class="op">)</span>,</span>
<span>                     lifeExp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">40</span>, <span class="fl">70</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>           epred <span class="op">=</span> <span class="cn">TRUE</span>, re_formula <span class="op">=</span> <span class="cn">NULL</span>, allow_new_levels <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ame_model_gdp_hurdle_panel_nolog_fancy</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">gather_emmeans_draws</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>year <span class="op">=</span> <span class="va">year</span> <span class="op">+</span> <span class="fl">1952</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">.value</span>, y <span class="op">=</span> <span class="va">continent</span>, color <span class="op">=</span> <span class="va">lifeExp</span>, group <span class="op">=</span> <span class="va">lifeExp</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_pointinterval</span><span class="op">(</span>position <span class="op">=</span> <span class="st">"dodge"</span>, size <span class="op">=</span> <span class="fl">0.75</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_gradient</span><span class="op">(</span>low <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span>, high <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,</span>
<span>                       guide <span class="op">=</span> <span class="fu">guide_colorbar</span><span class="op">(</span>barwidth <span class="op">=</span> <span class="fl">12</span>, barheight <span class="op">=</span> <span class="fl">0.5</span>, direction <span class="op">=</span> <span class="st">"horizontal"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_dollar</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Value of lifeExp coefficient (marginal effect)"</span>, y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>       color <span class="op">=</span> <span class="st">"Life expectancy"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"Marginal effect of life expectancy on GDP per capita\nacross continent, time, and different values of life expectancy"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"…all while incorporating information about the hurdle process!"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">year</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_nice</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>        legend.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>vjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-mfx-lotsa-life-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>AHHH this is so cool. As life expectancy increases, the estimated <code>lifeExp</code> increases across all continents and across all years, but the trend behaves differently within each continent and within each year.</p>
</section></section><section id="normally-distributed-outcomes-with-zeros" class="level2"><h2 class="anchored" data-anchor-id="normally-distributed-outcomes-with-zeros">Normally distributed outcomes with zeros</h2>
<p><strong>brms</strong> comes with 4 different hurdle families and 6 different zero-inflated families. Working with <code>hurdle_lognormal()</code> in the gapminder example above was great because GDP per capita is exponentially distributed and well-suited for logging. But what if your outcome isn’t exponentially distributed, and doesn’t fit one of the other built-in hurdle or zero-inflated families (gamma, Poisson, negative binomial, beta, etc.)? What if you have something nice and linear already, but that also has a built-in zero process? Let’s see what we can do with that kind of outcome variable.</p>
<section id="explore-data-1" class="level3"><h3 class="anchored" data-anchor-id="explore-data-1">Explore data</h3>
<p>We’ll play with the delightful <a href="https://allisonhorst.github.io/palmerpenguins/"><code>palmerpenguins</code></a> data. It’s nice and pristine and has no zeros, but like we did with the gapminder data, we’ll build in some of our own zeros. Here we’ll say that penguins with a flipper length of less than 190 mm will have a 30% chance of recording a 0 in body mass, while those with flippers longer than 190 mm will have a 2% chance.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">penguins</span> <span class="op">&lt;-</span> <span class="fu">palmerpenguins</span><span class="fu">::</span><span class="va">penguins</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">drop_na</span><span class="op">(</span><span class="va">sex</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co"># Make a bunch of weight values 0</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>prob_zero <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">flipper_length_mm</span> <span class="op">&lt;</span> <span class="fl">190</span>, <span class="fl">0.3</span>, <span class="fl">0.02</span><span class="op">)</span>,</span>
<span>         will_be_zero <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span>, <span class="fl">1</span>, prob <span class="op">=</span> <span class="va">prob_zero</span><span class="op">)</span>,</span>
<span>         body_mass_g <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">will_be_zero</span>, <span class="fl">0</span>, <span class="va">body_mass_g</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">prob_zero</span>, <span class="op">-</span><span class="va">will_be_zero</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>is_zero <span class="op">=</span> <span class="va">body_mass_g</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s see how many zeros we ended up with:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">penguins</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">count</span><span class="op">(</span><span class="va">is_zero</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>prop <span class="op">=</span> <span class="va">n</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 2 × 3</span></span>
<span><span class="co">##   is_zero     n  prop</span></span>
<span><span class="co">##   &lt;lgl&gt;   &lt;int&gt; &lt;dbl&gt;</span></span>
<span><span class="co">## 1 FALSE     296 0.889</span></span>
<span><span class="co">## 2 TRUE       37 0.111</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Cool— 11.1% of the values of body mass are zero, which coincidentally is pretty close to the proportion we got in the gapminder example. Here’s what the distribution looks like:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">penguins</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>body_mass_g <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">is_zero</span>, <span class="op">-</span><span class="fl">0.1</span>, <span class="va">body_mass_g</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">body_mass_g</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">is_zero</span><span class="op">)</span>, binwidth <span class="op">=</span> <span class="fl">100</span>,</span>
<span>                 boundary <span class="op">=</span> <span class="fl">0</span>, color <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"darkorange"</span>, <span class="st">"purple"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">comma_format</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Body mass (g)"</span>, y <span class="op">=</span> <span class="st">"Count"</span>, fill <span class="op">=</span> <span class="st">"Is zero?"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"Distribution of penguin body mass"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_nice</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-body-mass-dist-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
</section><section id="regular-ols-model-on-a-non-exponential-outcome" class="level3"><h3 class="anchored" data-anchor-id="regular-ols-model-on-a-non-exponential-outcome">1. Regular OLS model on a non-exponential outcome</h3>
<p>Now that we have some artificial zeros, let’s model the relationship between body mass and bill length. Since body mass is relatively normally distributed, we’ll use regular old OLS and not worry about any logging.</p>
<p>The zeros we added are going to cause some problems. In this scatterplot, the <span style="color:#0074D9;">■&nbsp;blue</span> line is fit using only the non-zero data. If we include the zeros, like the <span style="color:#F012BE;">■&nbsp;fuchsia</span> line in this plot, the relationship changes a little—the model underpredicts the body mass of shorter-billed penguins.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">penguins</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">bill_length_mm</span>, y <span class="op">=</span> <span class="va">body_mass_g</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">species</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_smooth</span><span class="op">(</span>method <span class="op">=</span> <span class="st">"lm"</span>, color <span class="op">=</span> <span class="st">"#F012BE"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_smooth</span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">penguins</span>, <span class="va">body_mass_g</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span>, method <span class="op">=</span> <span class="st">"lm"</span>, color <span class="op">=</span> <span class="st">"#0074D9"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_comma</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"darkorange"</span>, <span class="st">"purple"</span>, <span class="st">"cyan4"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Bill length (mm)"</span>, y <span class="op">=</span> <span class="st">"Body mass (g)"</span>, color <span class="op">=</span> <span class="st">"Species"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">'OLS models &lt;span style="color:#F012BE;"&gt;with&lt;/span&gt; and &lt;span style="color:#0074D9;"&gt;without&lt;/span&gt; zeros'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_nice</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>        plot.title <span class="op">=</span> <span class="fu">element_markdown</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-ols-bill-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>Let’s make a couple models that predict body mass based on bill length and species, both with and without the zeros:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/model-mass-bill-basic_40826fd4bfa2178e90d7d35d17dbf4c5">
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_mass_basic</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span></span>
<span>  <span class="fu">bf</span><span class="op">(</span><span class="va">body_mass_g</span> <span class="op">~</span> <span class="va">bill_length_mm</span> <span class="op">+</span> <span class="va">species</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">penguins</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  chains <span class="op">=</span> <span class="va">CHAINS</span>, iter <span class="op">=</span> <span class="va">ITER</span>, warmup <span class="op">=</span> <span class="va">WARMUP</span>, seed <span class="op">=</span> <span class="va">BAYES_SEED</span>,</span>
<span>  silent <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_mass_basic_no_zero</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span></span>
<span>  <span class="fu">bf</span><span class="op">(</span><span class="va">body_mass_g</span> <span class="op">~</span> <span class="va">bill_length_mm</span> <span class="op">+</span> <span class="va">species</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">penguins</span>, <span class="op">!</span><span class="va">is_zero</span><span class="op">)</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  chains <span class="op">=</span> <span class="va">CHAINS</span>, iter <span class="op">=</span> <span class="va">ITER</span>, warmup <span class="op">=</span> <span class="va">WARMUP</span>, seed <span class="op">=</span> <span class="va">BAYES_SEED</span>,</span>
<span>  silent <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_mass_basic</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 5 × 8</span></span>
<span><span class="co">##   effect   component group    term             estimate std.error conf.low conf.high</span></span>
<span><span class="co">##   &lt;chr&gt;    &lt;chr&gt;     &lt;chr&gt;    &lt;chr&gt;               &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 fixed    cond      &lt;NA&gt;     (Intercept)        -1474.     737.   -2916.      -39.5</span></span>
<span><span class="co">## 2 fixed    cond      &lt;NA&gt;     bill_length_mm       122.      18.9     84.9     159. </span></span>
<span><span class="co">## 3 fixed    cond      &lt;NA&gt;     speciesChinstrap   -1046.     240.   -1516.     -571. </span></span>
<span><span class="co">## 4 fixed    cond      &lt;NA&gt;     speciesGentoo        769.     209.     381.     1182. </span></span>
<span><span class="co">## 5 ran_pars cond      Residual sd__Observation     1002.      39.3    929.     1082.</span></span>
<span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_mass_basic_no_zero</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 5 × 8</span></span>
<span><span class="co">##   effect   component group    term             estimate std.error conf.low conf.high</span></span>
<span><span class="co">##   &lt;chr&gt;    &lt;chr&gt;     &lt;chr&gt;    &lt;chr&gt;               &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 fixed    cond      &lt;NA&gt;     (Intercept)         219.     287.     -316.       794.</span></span>
<span><span class="co">## 2 fixed    cond      &lt;NA&gt;     bill_length_mm       90.4      7.31     75.6      104.</span></span>
<span><span class="co">## 3 fixed    cond      &lt;NA&gt;     speciesChinstrap   -887.      92.6   -1064.      -704.</span></span>
<span><span class="co">## 4 fixed    cond      &lt;NA&gt;     speciesGentoo       572.      77.4     419.       725.</span></span>
<span><span class="co">## 5 ran_pars cond      Residual sd__Observation     370.      15.0     342.       401.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>These models give different estimates for the effect of bill length on body mass. In the model that omits the zeros (<span style="color:#0074D9;">■&nbsp;blue</span>), a 1 mm increase in bill length is associated with a 121.91 gram increase in body mass, on average. If we include the zeros, though (<span style="color:#F012BE;">■&nbsp;fuchsia</span>), the effect drops to 90.42 grams.</p>
<p>If we look at a posterior predictive check for the <span style="color:#0074D9;">■&nbsp;blue</span> zero-free model we can see that the model doesn’t do a great job of fitting the distribution of the outcome. Compare the distribution of actual observed body mass (in <span style="color:#0086a8;">■&nbsp;light blue</span>) with simulated body mass from the posterior distribution (in <span style="color:#d04e00;">■&nbsp;orange</span>). Oh no:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">pp_check</span><span class="op">(</span><span class="va">model_mass_basic</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-pp-mass-bill-basic-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>We need to somehow account for these zeros, but how?</p>
</section><section id="hurdle-lognormal-model-on-a-non-exponential-outcome" class="level3"><h3 class="anchored" data-anchor-id="hurdle-lognormal-model-on-a-non-exponential-outcome">2. Hurdle lognormal model on a non-exponential outcome</h3>
<p>Unfortunately, there’s no built-in <code>hurdle_gaussian()</code> family we can use with <strong>brms</strong>. But maybe we can fake it and use <code>hurdle_lognormal()</code>. If we log body mass it shrinks the values down to ≈8.5, and we still have a normal-looking distribution (albeit with a really small range).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">penguins</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>body_mass_g <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log1p</a></span><span class="op">(</span><span class="va">body_mass_g</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>body_mass_g <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">is_zero</span>, <span class="op">-</span><span class="fl">0.01</span>, <span class="va">body_mass_g</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">body_mass_g</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">is_zero</span><span class="op">)</span>, binwidth <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>                 boundary <span class="op">=</span> <span class="fl">0</span>, color <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"darkorange"</span>, <span class="st">"purple"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Body mass (g)"</span>, y <span class="op">=</span> <span class="st">"Count"</span>, fill <span class="op">=</span> <span class="st">"Is zero?"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"Distribution of logged penguin body mass"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_nice</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-body-mass-dist-log-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>We can probably plausibly use a hurdled lognormal model here like we did with the gapminder example. This makes the coefficients a little harder to interpret—we can’t say that a 1 mm increase in bill length is associated with a X gram change in body mass, but we can say that a 1 mm increase in bill length is associated with a X% change in body mass. And we can back-transform these logged coefficients to the gram scale using <code>emmeans()</code>. Let’s try it.</p>
<p>Since we know the hurdle process (flipper length determined the 0/not 0 choice), we’ll use flipper length in the <code>hu</code> formula.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/model-mass-bill-hurdle-log_a7384f7e858dcc32d97bfc508fbb5be9">
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_mass_hurdle_log</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span></span>
<span>  <span class="fu">bf</span><span class="op">(</span><span class="va">body_mass_g</span> <span class="op">~</span> <span class="va">bill_length_mm</span> <span class="op">+</span> <span class="va">species</span>,</span>
<span>     <span class="va">hu</span> <span class="op">~</span> <span class="va">flipper_length_mm</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">penguins</span>,</span>
<span>  family <span class="op">=</span> <span class="fu">hurdle_lognormal</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  chains <span class="op">=</span> <span class="va">CHAINS</span>, iter <span class="op">=</span> <span class="va">ITER</span>, warmup <span class="op">=</span> <span class="va">WARMUP</span>, seed <span class="op">=</span> <span class="va">BAYES_SEED</span>,</span>
<span>  silent <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_mass_hurdle_log</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 7 × 8</span></span>
<span><span class="co">##   effect   component group    term                 estimate std.error conf.low conf.high</span></span>
<span><span class="co">##   &lt;chr&gt;    &lt;chr&gt;     &lt;chr&gt;    &lt;chr&gt;                   &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 fixed    cond      &lt;NA&gt;     (Intercept)            7.41     0.0692    7.28      7.55  </span></span>
<span><span class="co">## 2 fixed    cond      &lt;NA&gt;     hu_(Intercept)        27.4      5.95     16.5      39.7   </span></span>
<span><span class="co">## 3 fixed    cond      &lt;NA&gt;     bill_length_mm         0.0208   0.00176   0.0173    0.0242</span></span>
<span><span class="co">## 4 fixed    cond      &lt;NA&gt;     speciesChinstrap      -0.202    0.0224   -0.246    -0.157 </span></span>
<span><span class="co">## 5 fixed    cond      &lt;NA&gt;     speciesGentoo          0.131    0.0192    0.0936    0.169 </span></span>
<span><span class="co">## 6 fixed    cond      &lt;NA&gt;     hu_flipper_length_mm  -0.155    0.0317   -0.220    -0.0980</span></span>
<span><span class="co">## 7 ran_pars cond      Residual sd__Observation        0.0888   0.00366   0.0822    0.0961</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We have results, but they’re on the log scale so we have to think about the coefficients differently. According to the <code>bill_length_mm</code> coefficient, a one-millimeter increase in bill length is associated with a 2.1% increase in body mass.</p>
<p>We can also look at the logit-scale hurdle process, though it’s a little tricky since we can’t just use <code><a href="https://rdrr.io/r/stats/Logistic.html">plogis()</a></code> on the coefficient. We can use <code>emtrends()</code> to extract the slope, though. Since we’re on a logit scale, the actual slope depends on the value of flipper length depends on flipper length itself. We can feed <code>emtrends()</code> any flipper lengths we want—a range of possible flipper lengths; the average for the data; whatever—and get the corresponding slope or marginal effect. If we include <code>regrid = "response"</code> we’ll see the results on the percentage point-scale</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_mass_hurdle_log</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">emtrends</span><span class="op">(</span><span class="op">~</span> <span class="va">flipper_length_mm</span>, var <span class="op">=</span> <span class="st">"flipper_length_mm"</span>, </span>
<span>           dpar <span class="op">=</span> <span class="st">"hu"</span>, regrid <span class="op">=</span> <span class="st">"response"</span>,</span>
<span>           <span class="co"># Show the effect for the mean and for a range</span></span>
<span>           at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>flipper_length_mm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">penguins</span><span class="op">$</span><span class="va">flipper_length_mm</span><span class="op">)</span>, </span>
<span>                                           <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">170</span>, <span class="fl">230</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">##  flipper_length_mm flipper_length_mm.trend lower.HPD upper.HPD</span></span>
<span><span class="co">##                201                 -0.0032   -0.0049  -0.00144</span></span>
<span><span class="co">##                170                 -0.0292   -0.0364  -0.02038</span></span>
<span><span class="co">##                180                 -0.0352   -0.0532  -0.01646</span></span>
<span><span class="co">##                190                 -0.0144   -0.0211  -0.00798</span></span>
<span><span class="co">##                200                 -0.0036   -0.0056  -0.00184</span></span>
<span><span class="co">##                210                 -0.0008   -0.0018  -0.00017</span></span>
<span><span class="co">##                220                 -0.0002   -0.0006  -0.00001</span></span>
<span><span class="co">##                230                  0.0000   -0.0002   0.00000</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Point estimate displayed: median </span></span>
<span><span class="co">## HPD interval probability: 0.95</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The probability of seeing a zero decreases at different rates depending on existing flipper lengths. For short-flippered penguins, a one-mm change from 170 mm to 171 mm is associated with a -2.92 percentage point decrease in the probability of seeing a zero. For long-flippered penguins, a one-mm change from 220 mm to 221 mm is associated with a -0.02 percentage point decrease. For penguins with an average flipper length (200.97 mm), the change is -0.32 percentage points. These slopes are all visible in the <code>conditional_effects()</code> plot of the hurdle component of the model, which I’ll show below.</p>
<p>We can also check how well the model fits the data:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">pp_check</span><span class="op">(</span><span class="va">model_mass_hurdle_log</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-pp-mass-bill-hurdle-log-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>It accounts for the zeros, as expected.</p>
<p>Next we’ll look at the marginal/conditional effects of bill length on body mass and flipper length on the proportion of zeros. We can do it with both <code>conditional_effects()</code> (for quick and easy plots) and with <code>emmeans()</code> (for more control over everything). Unfortunately there’s no easy way to plot <em>only</em> the <code>mu</code> part using <code>conditional_effects()</code>—it defaults to showing expected predictions. We can show only the <code>mu</code> part with <code>emmeans()</code> though.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">conditional_effects</span><span class="op">(</span><span class="va">model_mass_hurdle_log</span>, effects <span class="op">=</span> <span class="st">"bill_length_mm"</span><span class="op">)</span></span>
<span><span class="fu">conditional_effects</span><span class="op">(</span><span class="va">model_mass_hurdle_log</span>, effects <span class="op">=</span> <span class="st">"flipper_length_mm"</span>, dpar <span class="op">=</span> <span class="st">"hu"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-conditional-mass-bill-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">plot_penguins_emmeans0</span> <span class="op">&lt;-</span> <span class="va">model_mass_hurdle_log</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">emmeans</span><span class="op">(</span><span class="op">~</span> <span class="va">bill_length_mm</span>, var <span class="op">=</span> <span class="st">"bill_length_mm"</span>,</span>
<span>          at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>bill_length_mm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">60</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>          epred <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">gather_emmeans_draws</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">bill_length_mm</span>, y <span class="op">=</span> <span class="va">.value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_lineribbon</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1</span>, color <span class="op">=</span> <span class="st">"cyan4"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu">colorspace</span><span class="fu">::</span><span class="fu">lighten</span><span class="op">(</span><span class="st">"cyan4"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.95</span>, <span class="fl">0.7</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_comma</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Bill length (mm)"</span>, y <span class="op">=</span> <span class="st">"Predicted body mass (g)"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Expected values from mu and hu parts (epred = TRUE)"</span>,</span>
<span>       fill <span class="op">=</span> <span class="st">"Credible interval"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_nice</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_penguins_emmeans1</span> <span class="op">&lt;-</span> <span class="va">model_mass_hurdle_log</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">emmeans</span><span class="op">(</span><span class="op">~</span> <span class="va">bill_length_mm</span>, var <span class="op">=</span> <span class="st">"bill_length_mm"</span>, dpar <span class="op">=</span> <span class="st">"mu"</span>,</span>
<span>          regrid <span class="op">=</span> <span class="st">"response"</span>, tran <span class="op">=</span> <span class="st">"log"</span>, type <span class="op">=</span> <span class="st">"response"</span>,</span>
<span>          at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>bill_length_mm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">60</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">gather_emmeans_draws</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>.value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">.value</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">bill_length_mm</span>, y <span class="op">=</span> <span class="va">.value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_lineribbon</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1</span>, color <span class="op">=</span> <span class="st">"darkorange"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu">colorspace</span><span class="fu">::</span><span class="fu">lighten</span><span class="op">(</span><span class="st">"darkorange"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.95</span>, <span class="fl">0.7</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_comma</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Bill length (mm)"</span>, y <span class="op">=</span> <span class="st">"Predicted body mass (g)"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Regular part of the model (dpar = \"mu\")"</span>,</span>
<span>       fill <span class="op">=</span> <span class="st">"Credible interval"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_nice</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_penguins_emmeans2</span> <span class="op">&lt;-</span> <span class="va">model_mass_hurdle_log</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">emmeans</span><span class="op">(</span><span class="op">~</span> <span class="va">flipper_length_mm</span>, var <span class="op">=</span> <span class="st">"flipper_length_mm"</span>, dpar <span class="op">=</span> <span class="st">"hu"</span>,</span>
<span>          at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>flipper_length_mm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">170</span>, <span class="fl">240</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">gather_emmeans_draws</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>.value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html">plogis</a></span><span class="op">(</span><span class="va">.value</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">flipper_length_mm</span>, y <span class="op">=</span> <span class="va">.value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_lineribbon</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1</span>, color <span class="op">=</span> <span class="st">"purple"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu">colorspace</span><span class="fu">::</span><span class="fu">lighten</span><span class="op">(</span><span class="st">"purple"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.95</span>, <span class="fl">0.7</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_percent</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Flipper length (mm)"</span>, y <span class="op">=</span> <span class="st">"Predicted probability\nof seeing 0 body mass"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Hurdle part of the model (dpar = \"hu\")"</span>,</span>
<span>       fill <span class="op">=</span> <span class="st">"Credible interval"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_nice</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="va">plot_penguins_emmeans0</span> <span class="op">/</span> <span class="va">plot_penguins_emmeans1</span> <span class="op">/</span> <span class="va">plot_penguins_emmeans2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">plot_annotation</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Conditional effects of bill length and flipper length"</span>,</span>
<span>                  subtitle <span class="op">=</span> <span class="st">"Made with emmeans()"</span>,</span>
<span>                  theme <span class="op">=</span> <span class="fu">theme</span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Jost"</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>                                plot.subtitle <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Jost"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-emmeans-mfx-mass-hurdle-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>That trend in predicted body mass looks surprisingly linear even though we modeled it with a log-based family! In general it shows that body mass increases by 2.1% for each millimeter increase in bill length. Since we used a log-based family, the actual slope on the original scale will be different across the whole range of bill length. <code>emtrends()</code> lets us see this:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Slopes for the combined mu and hu parts of the model</span></span>
<span><span class="va">model_mass_hurdle_log</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">emtrends</span><span class="op">(</span><span class="op">~</span> <span class="va">bill_length_mm</span>, var <span class="op">=</span> <span class="st">"bill_length_mm"</span>,</span>
<span>           at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>bill_length_mm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">60</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span>,</span>
<span>           epred <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">##  bill_length_mm bill_length_mm.trend lower.HPD upper.HPD</span></span>
<span><span class="co">##              30                 62.0      54.4      68.8</span></span>
<span><span class="co">##              40                 76.3      64.5      87.5</span></span>
<span><span class="co">##              50                 93.9      76.7     111.2</span></span>
<span><span class="co">##              60                115.6      91.1     141.5</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Results are averaged over the levels of: species </span></span>
<span><span class="co">## Point estimate displayed: median </span></span>
<span><span class="co">## HPD interval probability: 0.95</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For penguins with short bills like 30 mm, the slope of bill length is 62; for penguins with long bills like 60 mm, the slope is almost twice that at 115.6. That seems like a huge difference, but body mass ranges in the thousands of grams, so in the plot of conditional effects a 60 mm difference in slope barely registers visually.</p>
</section><section id="hurdle-gaussian-model-with-a-custom-brms-family" class="level3"><h3 class="anchored" data-anchor-id="hurdle-gaussian-model-with-a-custom-brms-family">3. Hurdle gaussian model with a custom brms family</h3>
<p>Modeling body mass with a lognormal model works pretty well despite its fairly-normal-and-not-at-all-exponential distribution. We have to do some additional data acrobatics to convert coefficients from logs to not-logs, which can be annoying. More importantly, though, it feels weird to knowingly use the wrong family to model this outcome. The whole point of doing this hurdle model stuff is to use models that most accurately reflect the underlying data (rather than throwing OLS at everything). It would be great if we could use something like <code>hurdle_gaussian()</code> to avoid all this roundabout log work.</p>
<p>Fortunately <strong>brms</strong> has the ability to create custom families, and <a href="https://cran.r-project.org/web/packages/brms/vignettes/brms_customfamilies.html">Paul Bürkner has a whole vignette about how to do it</a>. With some R and Stan magic, we can create our own <code>hurdle_gaussian()</code> family. <a href="https://cran.r-project.org/web/packages/brms/vignettes/brms_customfamilies.html">The vignette</a> goes into much more detail about each step, and I <a href="https://discourse.mc-stan.org/t/custom-gaussian-hurdle-family-not-quite-working-in-brms/21028">worked through most of it a year-ish ago after hours of googling and debugging</a> (and big help from different Stan forum users). Here’s the bare minimum of what’s needed:</p>
<ol type="1">
<li>
<p>Create a custom <strong>brms</strong> family with <code>custom_family()</code> to define the name, distributional parameters, links, and other model details.</p>
<p>Here we’ll make a family that accepts arguments for <code>mu</code>, <code>sigma</code>, and <code>hu</code>, which will be modeled using the identity (i.e.&nbsp;original) scale, log scale, and logit scale, respectively.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hurdle_gaussian</span> <span class="op">&lt;-</span> </span>
<span><span class="co"># Create a custom family that is logit if y = 0, normal/gaussian if not</span></span>
<span>  <span class="fu">custom_family</span><span class="op">(</span><span class="st">"hurdle_gaussian"</span>, </span>
<span>                dpars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"mu"</span>, <span class="st">"sigma"</span>, <span class="st">"hu"</span><span class="op">)</span>,</span>
<span>                links <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"identity"</span>, <span class="st">"log"</span>, <span class="st">"logit"</span><span class="op">)</span>,</span>
<span>                lb <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fl">0</span>, <span class="cn">NA</span><span class="op">)</span>,</span>
<span>                type <span class="op">=</span> <span class="st">"real"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
<li>
<p>Provide some raw Stan code to handle the actual sampling.</p>
<p>Here’s where we tell Stan to use a binomial family when the outcome is 0 and a normal Gaussian distribution if not.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Stan code</span></span>
<span><span class="va">stan_funs</span> <span class="op">&lt;-</span> <span class="st">"</span></span>
<span><span class="st">  real hurdle_gaussian_lpdf(real y, real mu, real sigma, real hu) { </span></span>
<span><span class="st">    if (y == 0) { </span></span>
<span><span class="st">      return bernoulli_lpmf(1 | hu); </span></span>
<span><span class="st">    } else { </span></span>
<span><span class="st">      return bernoulli_lpmf(0 | hu) +  </span></span>
<span><span class="st">             normal_lpdf(y | mu, sigma); </span></span>
<span><span class="st">    } </span></span>
<span><span class="st">  }</span></span>
<span><span class="st">"</span></span>
<span></span>
<span><span class="co"># Prepare Stan code for use in brm()</span></span>
<span><span class="va">stanvars</span> <span class="op">&lt;-</span> <span class="fu">stanvar</span><span class="op">(</span>scode <span class="op">=</span> <span class="va">stan_funs</span>, block <span class="op">=</span> <span class="st">"functions"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
<li>
<p>Create some post-processing functions so that things like <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> work:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">posterior_predict_hurdle_gaussian</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span>, <span class="va">prep</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">mu</span> <span class="op">&lt;-</span> <span class="fu">brms</span><span class="fu">::</span><span class="fu">get_dpar</span><span class="op">(</span><span class="va">prep</span>, <span class="st">"mu"</span>, i <span class="op">=</span> <span class="va">i</span><span class="op">)</span></span>
<span>  <span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fu">brms</span><span class="fu">::</span><span class="fu">get_dpar</span><span class="op">(</span><span class="va">prep</span>, <span class="st">"sigma"</span>, i <span class="op">=</span> <span class="va">i</span><span class="op">)</span></span>
<span>  <span class="va">theta</span> <span class="op">&lt;-</span> <span class="fu">brms</span><span class="fu">::</span><span class="fu">get_dpar</span><span class="op">(</span><span class="va">prep</span>, <span class="st">"hu"</span>, i <span class="op">=</span> <span class="va">i</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">hu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">prep</span><span class="op">$</span><span class="va">ndraws</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">hu</span> <span class="op">&lt;</span> <span class="va">theta</span>, <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">prep</span><span class="op">$</span><span class="va">ndraws</span>, <span class="va">mu</span>,<span class="va">sigma</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">posterior_epred_hurdle_gaussian</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">prep</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">prep</span><span class="op">$</span><span class="va">dpars</span>, <span class="va">mu</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">hu</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
</ol>
<p>And that’s it!</p>
<p>To use the custom family, we need to specify the name in <code>family</code> and pass the Stan code through the <code>stanvars</code> argument. Let’s use it!</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/model-mass-bill-hurdle-gaussian_cc09d4fc6ccef3f1fbdbef084dfec2a4">
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_mass_hurdle_gaussian</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span></span>
<span>  <span class="fu">bf</span><span class="op">(</span><span class="va">body_mass_g</span> <span class="op">~</span> <span class="va">bill_length_mm</span> <span class="op">+</span> <span class="va">species</span>,</span>
<span>     <span class="va">hu</span> <span class="op">~</span> <span class="va">flipper_length_mm</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">penguins</span>,</span>
<span>  family <span class="op">=</span> <span class="va">hurdle_gaussian</span>,  <span class="co"># &lt;--- This is new</span></span>
<span>  stanvars <span class="op">=</span> <span class="va">stanvars</span>,  <span class="co"># &lt;--- This is new</span></span>
<span>  chains <span class="op">=</span> <span class="va">CHAINS</span>, iter <span class="op">=</span> <span class="va">ITER</span>, warmup <span class="op">=</span> <span class="va">WARMUP</span>, seed <span class="op">=</span> <span class="va">BAYES_SEED</span>,</span>
<span>  silent <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_mass_hurdle_gaussian</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 7 × 8</span></span>
<span><span class="co">##   effect   component group    term                 estimate std.error  conf.low conf.high</span></span>
<span><span class="co">##   &lt;chr&gt;    &lt;chr&gt;     &lt;chr&gt;    &lt;chr&gt;                   &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 fixed    cond      &lt;NA&gt;     (Intercept)           208.     290.      -374.     762.    </span></span>
<span><span class="co">## 2 fixed    cond      &lt;NA&gt;     hu_(Intercept)         27.4      6.05      16.8     40.1   </span></span>
<span><span class="co">## 3 fixed    cond      &lt;NA&gt;     bill_length_mm         90.7      7.39      76.4    105.    </span></span>
<span><span class="co">## 4 fixed    cond      &lt;NA&gt;     speciesChinstrap     -889.      95.1    -1075.    -703.    </span></span>
<span><span class="co">## 5 fixed    cond      &lt;NA&gt;     speciesGentoo         570.      78.6      415.     724.    </span></span>
<span><span class="co">## 6 fixed    cond      &lt;NA&gt;     hu_flipper_length_mm   -0.156    0.0323    -0.222   -0.0991</span></span>
<span><span class="co">## 7 ran_pars cond      Residual sd__Observation       370.      14.9      342.     399.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The coefficients for the hurdled part like <code>hu_(Intercept)</code> and <code>hu_flipper_length_mm</code> are still on the logit scale, as expected, but now the coefficients for the non-zero part are on the original regular scale! A one-mm change in bill length is associated with a 90.69 gram increase in body mass; Chinstrap penguins are 888.87 grams lighter than Adélie penguins, while Gentoos are 570.32 grams heavier than Adélies. Nothing is logged and there are no percent changes to worry about. It’s all easy!</p>
<p>If we use <code>pp_check()</code> we can see that the model successfully takes the zeros into account:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">pp_check</span><span class="op">(</span><span class="va">model_mass_hurdle_gaussian</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-pp-mass-bill-hurdle-gaussian-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>The conditional/marginal effects are more straightforward now too. If we use <code>conditional_effects()</code> we’ll see a perfectly straight line:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># No need for epred = TRUE!</span></span>
<span><span class="fu">conditional_effects</span><span class="op">(</span><span class="va">model_mass_hurdle_gaussian</span>, effects <span class="op">=</span> <span class="st">"bill_length_mm"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-conditional-mass-hurdle-gaussian-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>And if we use <code>emtrends()</code> to check the slope of that line across different values of bill length, we’ll see the same slope instead of a range from 61.976 to 115.556 like we saw with the hurdle lognormal family:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_mass_hurdle_gaussian</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">emtrends</span><span class="op">(</span><span class="op">~</span> <span class="va">bill_length_mm</span>, var <span class="op">=</span> <span class="st">"bill_length_mm"</span>,</span>
<span>           at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>bill_length_mm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">60</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span>,</span>
<span>           epred <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">##  bill_length_mm bill_length_mm.trend lower.HPD upper.HPD</span></span>
<span><span class="co">##              30                 88.7      74.6       103</span></span>
<span><span class="co">##              40                 88.7      74.6       103</span></span>
<span><span class="co">##              50                 88.7      74.6       103</span></span>
<span><span class="co">##              60                 88.7      74.6       103</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Results are averaged over the levels of: species </span></span>
<span><span class="co">## Point estimate displayed: median </span></span>
<span><span class="co">## HPD interval probability: 0.95</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Importantly</strong> that slope (88.663) is different from what we found when looking at the model results with <code>tidy()</code> (90.69). That’s because <code>emmeans()</code> and <code>emtrends()</code> take the zero process into account by calculating the expected value (<code>epred = TRUE</code>).</p>
<p>We can confirm that there are predicted zeros. For penguins with a shorter bill like 30 mm, the overall distribution of predicted body mass is centered around 3,000ish grams, while those with longer bills (60 mm) are predicted to be clustered around 6,000 grams. Flipper length determines the distribution of zeros (since that’s the effect we built in; remember that we made it so that penguins with a flipper length of less than 190 mm have a 30% chance of being zero). The model picks this up. If we set flipper length to 189 mm (<em>just</em> under the cutoff), the model predicts a big proportion of zeros; if we set it to 210, it predicts a small proportion of zeros.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pred_mass_hurdle_gaussian</span> <span class="op">&lt;-</span> <span class="va">model_mass_hurdle_gaussian</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">predicted_draws</span><span class="op">(</span>newdata <span class="op">=</span> <span class="fu">expand_grid</span><span class="op">(</span>bill_length_mm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">60</span><span class="op">)</span>,</span>
<span>                                        species <span class="op">=</span> <span class="st">"Adelie"</span>,</span>
<span>                                        flipper_length_mm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">189</span>, <span class="fl">210</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>is_zero <span class="op">=</span> <span class="va">.prediction</span> <span class="op">==</span> <span class="fl">0</span>,</span>
<span>         .prediction <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">is_zero</span>, <span class="va">.prediction</span> <span class="op">-</span> <span class="fl">0.1</span>, <span class="va">.prediction</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>nice_bill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">bill_length_mm</span>, <span class="st">" mm bill"</span><span class="op">)</span>,</span>
<span>         nice_flipper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">flipper_length_mm</span>, <span class="st">" mm flippers"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">pred_mass_hurdle_gaussian</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">.prediction</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">is_zero</span><span class="op">)</span>, binwidth <span class="op">=</span> <span class="fl">100</span>, </span>
<span>                 boundary <span class="op">=</span> <span class="fl">0</span>, color <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_comma</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"darkorange"</span>, <span class="st">"purple"</span><span class="op">)</span>, </span>
<span>                    guide <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>reverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Predicted body mass (g)"</span>, y <span class="op">=</span> <span class="cn">NULL</span>, fill <span class="op">=</span> <span class="st">"Is zero?"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"Predicted body mass across different bill and flipper lengths"</span>,</span>
<span>       subitlte <span class="op">=</span> <span class="st">"Results from hurdled Gaussian model"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_nested_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">nice_bill</span>, <span class="va">nice_flipper</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">2</span>, </span>
<span>                    strip <span class="op">=</span> <span class="fu">strip_nested</span><span class="op">(</span></span>
<span>                      text_x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu">element_text</span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Jost"</span>, </span>
<span>                                                 face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>, <span class="cn">NULL</span><span class="op">)</span>,</span>
<span>                      background_x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu">element_rect</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"grey92"</span><span class="op">)</span>, <span class="cn">NULL</span><span class="op">)</span>,</span>
<span>                      by_layer_x <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_nice</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-predicted-mass-hurdle-gaussian-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>And that’s it! A fully working hurdle Gaussian model in <strong>brms</strong>! This single model contains an incredible amount of detail about all these different moving parts. Magical!</p>
<section id="i-liedthis-custom-family-isnt-all-the-way-complete" class="level4"><h4 class="anchored" data-anchor-id="i-liedthis-custom-family-isnt-all-the-way-complete">I lied—this custom family isn’t all the way complete!</h4>
<p>It would be really neat to have <code>hurdle_gaussian()</code> as an official native family in <strong>brms</strong>, and the <a href="https://cran.r-project.org/web/packages/brms/vignettes/brms_customfamilies.html#turning-a-custom-family-into-a-native-family">vignette makes it sound like it’s possible to submit a pull request</a> to formally add custom families like this, BUT what I have here doesn’t <em>quite</em> work all the way.</p>
<p>We’re still missing one post-processing function for calculating the log likelihood for the family. If we try to use a function that relies on the log likelihood like <code>loo()</code>, we’ll get an error:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">loo</span><span class="op">(</span><span class="va">model_mass_hurdle_gaussian</span><span class="op">)</span></span>
<span><span class="co">## Error in get(out, family$env): object 'log_lik_hurdle_gaussian' not found</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In addition to the <code>posterior_predict_hurdle_gaussian()</code> and <code>posterior_epred_hurdle_gaussian()</code> functions we defined earlier, we also need a <code>log_lik_hurdle_gaussian()</code> function. The only problem is that <em>I have no idea how to make this</em>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co"># idk</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>log_lik_hurdle_gaussian <span class="ot">&lt;-</span> <span class="cf">function</span>(???) {</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ????????</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Alas.</p>
<p>Despite this, for now the custom hurdle Gaussian model works well for most other things.</p>


<!-- -->

</section></section></section><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{heiss2022,
  author = {Heiss, Andrew},
  title = {A Guide to Modeling Outcomes That Have Lots of Zeros with
    {Bayesian} Hurdle Lognormal and Hurdle {Gaussian} Regression Models},
  date = {2022-05-09},
  url = {https://www.andrewheiss.com/blog/2022/05/09/hurdle-lognormal-gaussian-brms/},
  doi = {10.59350/ety2j-09566},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-heiss2022" class="csl-entry quarto-appendix-citeas" role="listitem">
Heiss, Andrew. 2022. <span>“A Guide to Modeling Outcomes That Have Lots
of Zeros with Bayesian Hurdle Lognormal and Hurdle Gaussian Regression
Models.”</span> May 9, 2022. <a href="https://doi.org/10.59350/ety2j-09566">https://doi.org/10.59350/ety2j-09566</a>.
</div></div></section></div></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/www\.andrewheiss\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><script src="https://giscus.app/client.js" data-repo="andrewheiss/ath-quarto" data-repo-id="R_kgDOIg6EJQ" data-category="Blog comments" data-category-id="DIC_kwDOIg6EJc4CSz92" data-mapping="pathname" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script><input type="hidden" id="giscus-base-theme" value="light"><input type="hidden" id="giscus-alt-theme" value="dark"><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb75" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "A guide to modeling outcomes that have lots of zeros with Bayesian hurdle lognormal and hurdle Gaussian regression models"</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> 2022-05-09</span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a><span class="an">description:</span><span class="co"> "Create, manipulate, understand, analyze, interpret, and plot Bayesian hurdle regression models (and a custom hurdle Gaussian model!) using R, the tidyverse, emmeans, brms, and Stan"</span></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a><span class="an">image:</span><span class="co"> index_files/figure-html/plot-emmeans-mfx-gdp-1.png</span></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a><span class="an">tags:</span></span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a><span class="co">  - r</span></span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a><span class="co">  - tidyverse</span></span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a><span class="co">  - regression</span></span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a><span class="co">  - statistics</span></span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a><span class="co">  - data visualization</span></span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a><span class="co">  - hurdle models</span></span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a><span class="co">  - bayes</span></span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a><span class="co">  - brms</span></span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a><span class="co">  - stan</span></span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span><span class="co"> </span></span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb75-18"><a href="#cb75-18" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-depth: 4</span></span>
<span id="cb75-19"><a href="#cb75-19" aria-hidden="true" tabindex="-1"></a><span class="an">doi:</span><span class="co"> 10.59350/ety2j-09566</span></span>
<span id="cb75-20"><a href="#cb75-20" aria-hidden="true" tabindex="-1"></a><span class="an">citation:</span><span class="co"> true</span></span>
<span id="cb75-21"><a href="#cb75-21" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb75-22"><a href="#cb75-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-23"><a href="#cb75-23" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setup, include=FALSE}</span></span>
<span id="cb75-24"><a href="#cb75-24" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::opts_chunk$set(fig.align = "center", fig.retina = 3,</span></span>
<span id="cb75-25"><a href="#cb75-25" aria-hidden="true" tabindex="-1"></a><span class="in">                      fig.width = 6, fig.height = (6 * 0.618),</span></span>
<span id="cb75-26"><a href="#cb75-26" aria-hidden="true" tabindex="-1"></a><span class="in">                      out.width = "90%", collapse = TRUE)</span></span>
<span id="cb75-27"><a href="#cb75-27" aria-hidden="true" tabindex="-1"></a><span class="in">options(digits = 3, width = 300)</span></span>
<span id="cb75-28"><a href="#cb75-28" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-29"><a href="#cb75-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-30"><a href="#cb75-30" aria-hidden="true" tabindex="-1"></a>In <span class="co">[</span><span class="ot">a research project I've been working on for several years</span><span class="co">](https://www.andrewheiss.com/research/articles/chaudhry-heiss-ngos-aid/)</span> now, we're interested in the effect of anti-NGO legal crackdowns on various foreign aid-related outcomes: the amount of foreign aid a country receives and the proportion of that aid dedicated to contentious vs. non-contentious causes or issues. These outcome variables are easily measurable thanks to <span class="co">[</span><span class="ot">the AidData project</span><span class="co">](https://www.aiddata.org/)</span>, but they post a tricky methodological issue. The amount of foreign aid countries receive can both be huge (in the hundreds of millions or even billions of dollars), or completely zero. Moreover, the proportion of aid allocated to specific purposes is inherently bound between 0% and 100%, but can sometimes be exactly 0% or 100%. Using a statistical model that fits the distribution of these kinds of variables is important for modeling accuracy, but it's a more complicated process than running a basic linear OLS regression with <span class="in">`lm()`</span>. </span>
<span id="cb75-31"><a href="#cb75-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-32"><a href="#cb75-32" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">In a previous post</span><span class="co">](https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/)</span>, I wrote a guide to doing beta, zero-inflated beta, and zero-one-inflated beta regression for outcome variables that are bound between 0 and 1 and that can include 0 and/or 1. (That post was a side effect of working on this project on foreign aid and anti-NGO restrictions.) </span>
<span id="cb75-33"><a href="#cb75-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-34"><a href="#cb75-34" aria-hidden="true" tabindex="-1"></a>Beta regression (and its zero- and zero-one-inflated varieties) works really well with these kinds of outcome variables, and you can end up with richly defined models and well-fitting models. Zero-inflated beta regression doesn't work on outcomes that aren't limited to 0–1, though. For outcome variables that extend beyond 1, we can use hurdle models instead, which follow the same general approach as zero-inflated models. We define a mixture of models for two separate processes:</span>
<span id="cb75-35"><a href="#cb75-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-36"><a href="#cb75-36" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>A model that predicts if the outcome is zero or not zero</span>
<span id="cb75-37"><a href="#cb75-37" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>If the outcome is not zero, a model that predicts what the value of the outcome is</span>
<span id="cb75-38"><a href="#cb75-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-39"><a href="#cb75-39" aria-hidden="true" tabindex="-1"></a>Hurdle models do a great job at fitting the data well and providing accurate predictions. They're a little unwieldy to work with though, since they involve so many different moving parts.</span>
<span id="cb75-40"><a href="#cb75-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-41"><a href="#cb75-41" aria-hidden="true" tabindex="-1"></a>This post is a guide (mostly for future me) for how to create, manipulate, understand, analyze, and plot hurlde models in a Bayesian way using R and Stan (through <span class="co">[</span><span class="ot">**brms**</span><span class="co">](https://paul-buerkner.github.io/brms/)</span>).</span>
<span id="cb75-42"><a href="#cb75-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-43"><a href="#cb75-43" aria-hidden="true" tabindex="-1"></a>Throughout this post, we'll use data from two datasets to explore a couple different questions:</span>
<span id="cb75-44"><a href="#cb75-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-45"><a href="#cb75-45" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>What happens to a country's GDP per capita as its life expectancy increases? We'll use data from the Gapminder Project (though the <span class="co">[</span><span class="ot">**gapminder** R package</span><span class="co">](https://github.com/jennybc/gapminder)</span>)</span>
<span id="cb75-46"><a href="#cb75-46" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>What is the effect of bill length on body mass in Antarctic penguins? We'll use data from the <span class="co">[</span><span class="ot">**palmerpenguins** R package</span><span class="co">](https://allisonhorst.github.io/palmerpenguins/)</span>.</span>
<span id="cb75-47"><a href="#cb75-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-48"><a href="#cb75-48" aria-hidden="true" tabindex="-1"></a>Neither GDP per capita nor flipper length have any naturally ocurring zeros, so we'll manipulate the data beforehand and build in some zeros based on some arbitrary rules. For the health/weatlh gapminder data, we'll make it so countries with lower life expectancy will have a higher chance of seeing a 0 in GDP per capita; for the penguin data, we'll make it so that shorter flipper length will increase the chance of seeing a 0 in body mass.</span>
<span id="cb75-49"><a href="#cb75-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-50"><a href="#cb75-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-51"><a href="#cb75-51" aria-hidden="true" tabindex="-1"></a><span class="fu">## Who this post is for</span></span>
<span id="cb75-52"><a href="#cb75-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-53"><a href="#cb75-53" aria-hidden="true" tabindex="-1"></a>Here's what I assume you know:</span>
<span id="cb75-54"><a href="#cb75-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-55"><a href="#cb75-55" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>You're familiar with <span class="co">[</span><span class="ot">R</span><span class="co">](https://www.r-project.org/)</span> and the <span class="co">[</span><span class="ot">tidyverse</span><span class="co">](https://www.tidyverse.org/)</span> (particularly <span class="co">[</span><span class="ot">dplyr</span><span class="co">](https://dplyr.tidyverse.org/)</span> and <span class="co">[</span><span class="ot">ggplot2</span><span class="co">](https://ggplot2.tidyverse.org/)</span>).</span>
<span id="cb75-56"><a href="#cb75-56" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>You're familiar with <span class="co">[</span><span class="ot">**brms**</span><span class="co">](https://paul-buerkner.github.io/brms/)</span> for running Bayesian regression models. See <span class="co">[</span><span class="ot">the vignettes here</span><span class="co">](https://paul-buerkner.github.io/brms/articles/index.html)</span>, examples like <span class="co">[</span><span class="ot">this</span><span class="co">](https://www.rensvandeschoot.com/tutorials/brms-started/)</span>, or <span class="co">[</span><span class="ot">resources like these</span><span class="co">](https://evalsp22.classes.andrewheiss.com/resource/bayes/#resources)</span> for an introduction. You can also see <span class="co">[</span><span class="ot">this guide on beta regression</span><span class="co">](/blog/2021/11/08/beta-regression-guide/)</span> or <span class="co">[</span><span class="ot">this guide on average marginal effects</span><span class="co">](/blog/2021/11/10/ame-bayes-re-guide/)</span> for more examples. </span>
<span id="cb75-57"><a href="#cb75-57" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>You're somewhat familiar with multilevel models. <span class="co">[</span><span class="ot">See this guide on using multilevel models with panel data</span><span class="co">](/blog/2021/12/01/multilevel-models-panel-data-guide/)</span> for an extended example and a ton of extra resources. </span>
<span id="cb75-58"><a href="#cb75-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-59"><a href="#cb75-59" aria-hidden="true" tabindex="-1"></a>I use **brms** and Bayesian models throughout, since **brms** has built-in support for hurdled lognormal models (and can be extended to support other hurdled models). If you prefer frequentism, you can use <span class="co">[</span><span class="ot">`pscl::hurdle()`</span><span class="co">](https://cran.r-project.org/web/packages/pscl/index.html)</span> for frequentist hurdle models (<span class="co">[</span><span class="ot">see this post</span><span class="co">](https://www.rdatagen.net/post/a-hurdle-model-for-covid-19-infections-in-nursing-homes-sample-size-considerations/)</span> or <span class="co">[</span><span class="ot">this post</span><span class="co">](https://data.library.virginia.edu/getting-started-with-hurdle-models/)</span> for fully worked out examples), and lognormal regression can be done frequentistly with base R's <span class="in">`lm()`</span> function after logging the outcome:</span>
<span id="cb75-60"><a href="#cb75-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-61"><a href="#cb75-61" aria-hidden="true" tabindex="-1"></a><span class="in">```{r example-log-freq, eval=FALSE}</span></span>
<span id="cb75-62"><a href="#cb75-62" aria-hidden="true" tabindex="-1"></a><span class="in"># Pre-log the outcome:</span></span>
<span id="cb75-63"><a href="#cb75-63" aria-hidden="true" tabindex="-1"></a><span class="in">whatever &lt;- whatever |&gt; </span></span>
<span id="cb75-64"><a href="#cb75-64" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(y_logged = log(y))</span></span>
<span id="cb75-65"><a href="#cb75-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-66"><a href="#cb75-66" aria-hidden="true" tabindex="-1"></a><span class="in">lm(y_logged ~ x, data = whatever)</span></span>
<span id="cb75-67"><a href="#cb75-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-68"><a href="#cb75-68" aria-hidden="true" tabindex="-1"></a><span class="in"># Log the outcome in the regression itself:</span></span>
<span id="cb75-69"><a href="#cb75-69" aria-hidden="true" tabindex="-1"></a><span class="in">lm(log(y) ~ x, data = whatever)</span></span>
<span id="cb75-70"><a href="#cb75-70" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-71"><a href="#cb75-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-72"><a href="#cb75-72" aria-hidden="true" tabindex="-1"></a>Let's get started by loading all the libraries we'll need (and creating some couple helper functions):</span>
<span id="cb75-73"><a href="#cb75-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-74"><a href="#cb75-74" aria-hidden="true" tabindex="-1"></a><span class="in">```{r libraries-functions, warning=FALSE, message=FALSE}</span></span>
<span id="cb75-75"><a href="#cb75-75" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidyverse)       # ggplot, dplyr, and friends</span></span>
<span id="cb75-76"><a href="#cb75-76" aria-hidden="true" tabindex="-1"></a><span class="in">library(brms)            # Bayesian modeling through Stan</span></span>
<span id="cb75-77"><a href="#cb75-77" aria-hidden="true" tabindex="-1"></a><span class="in">library(emmeans)         # Calculate marginal effects in fancy ways</span></span>
<span id="cb75-78"><a href="#cb75-78" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidybayes)       # Manipulate Stan objects in a tidy way</span></span>
<span id="cb75-79"><a href="#cb75-79" aria-hidden="true" tabindex="-1"></a><span class="in">library(broom)           # Convert model objects to data frames</span></span>
<span id="cb75-80"><a href="#cb75-80" aria-hidden="true" tabindex="-1"></a><span class="in">library(broom.mixed)     # Convert brms model objects to data frames</span></span>
<span id="cb75-81"><a href="#cb75-81" aria-hidden="true" tabindex="-1"></a><span class="in">library(scales)          # For formatting numbers with commas, percents, and dollars</span></span>
<span id="cb75-82"><a href="#cb75-82" aria-hidden="true" tabindex="-1"></a><span class="in">library(patchwork)       # For combining plots</span></span>
<span id="cb75-83"><a href="#cb75-83" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggh4x)           # For nested facets in ggplot</span></span>
<span id="cb75-84"><a href="#cb75-84" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggtext)          # Use markdown and HTML in ggplot text</span></span>
<span id="cb75-85"><a href="#cb75-85" aria-hidden="true" tabindex="-1"></a><span class="in">library(MetBrewer)       # Use pretty artistic colors</span></span>
<span id="cb75-86"><a href="#cb75-86" aria-hidden="true" tabindex="-1"></a><span class="in">library(gapminder)       # Country-year panel data from the Gapminder project</span></span>
<span id="cb75-87"><a href="#cb75-87" aria-hidden="true" tabindex="-1"></a><span class="in">library(palmerpenguins)  # Penguin data!</span></span>
<span id="cb75-88"><a href="#cb75-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-89"><a href="#cb75-89" aria-hidden="true" tabindex="-1"></a><span class="in"># Use the cmdstanr backend for Stan because it's faster and more modern than the</span></span>
<span id="cb75-90"><a href="#cb75-90" aria-hidden="true" tabindex="-1"></a><span class="in"># default rstan You need to install the cmdstanr package first</span></span>
<span id="cb75-91"><a href="#cb75-91" aria-hidden="true" tabindex="-1"></a><span class="in"># (https://mc-stan.org/cmdstanr/) and then run cmdstanr::install_cmdstan() to</span></span>
<span id="cb75-92"><a href="#cb75-92" aria-hidden="true" tabindex="-1"></a><span class="in"># install cmdstan on your computer.</span></span>
<span id="cb75-93"><a href="#cb75-93" aria-hidden="true" tabindex="-1"></a><span class="in">options(mc.cores = 4,</span></span>
<span id="cb75-94"><a href="#cb75-94" aria-hidden="true" tabindex="-1"></a><span class="in">        brms.backend = "cmdstanr")</span></span>
<span id="cb75-95"><a href="#cb75-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-96"><a href="#cb75-96" aria-hidden="true" tabindex="-1"></a><span class="in"># Set some global Stan options</span></span>
<span id="cb75-97"><a href="#cb75-97" aria-hidden="true" tabindex="-1"></a><span class="in">CHAINS &lt;- 4</span></span>
<span id="cb75-98"><a href="#cb75-98" aria-hidden="true" tabindex="-1"></a><span class="in">ITER &lt;- 2000</span></span>
<span id="cb75-99"><a href="#cb75-99" aria-hidden="true" tabindex="-1"></a><span class="in">WARMUP &lt;- 1000</span></span>
<span id="cb75-100"><a href="#cb75-100" aria-hidden="true" tabindex="-1"></a><span class="in">BAYES_SEED &lt;- 1234</span></span>
<span id="cb75-101"><a href="#cb75-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-102"><a href="#cb75-102" aria-hidden="true" tabindex="-1"></a><span class="in"># Use the Johnson color palette</span></span>
<span id="cb75-103"><a href="#cb75-103" aria-hidden="true" tabindex="-1"></a><span class="in">clrs &lt;- MetBrewer::met.brewer("Johnson")</span></span>
<span id="cb75-104"><a href="#cb75-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-105"><a href="#cb75-105" aria-hidden="true" tabindex="-1"></a><span class="in"># Tell bayesplot to use the Johnson palette (for things like pp_check())</span></span>
<span id="cb75-106"><a href="#cb75-106" aria-hidden="true" tabindex="-1"></a><span class="in">bayesplot::color_scheme_set(c("grey30", clrs[2], clrs[1], clrs[3], clrs[5], clrs[4]))</span></span>
<span id="cb75-107"><a href="#cb75-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-108"><a href="#cb75-108" aria-hidden="true" tabindex="-1"></a><span class="in"># Custom ggplot theme to make pretty plots</span></span>
<span id="cb75-109"><a href="#cb75-109" aria-hidden="true" tabindex="-1"></a><span class="in"># Get the font at https://fonts.google.com/specimen/Jost</span></span>
<span id="cb75-110"><a href="#cb75-110" aria-hidden="true" tabindex="-1"></a><span class="in">theme_nice &lt;- function() {</span></span>
<span id="cb75-111"><a href="#cb75-111" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_minimal(base_family = "Jost") +</span></span>
<span id="cb75-112"><a href="#cb75-112" aria-hidden="true" tabindex="-1"></a><span class="in">    theme(panel.grid.minor = element_blank(),</span></span>
<span id="cb75-113"><a href="#cb75-113" aria-hidden="true" tabindex="-1"></a><span class="in">          plot.title = element_text(family = "Jost", face = "bold"),</span></span>
<span id="cb75-114"><a href="#cb75-114" aria-hidden="true" tabindex="-1"></a><span class="in">          axis.title = element_text(family = "Jost Medium"),</span></span>
<span id="cb75-115"><a href="#cb75-115" aria-hidden="true" tabindex="-1"></a><span class="in">          strip.text = element_text(family = "Jost", face = "bold",</span></span>
<span id="cb75-116"><a href="#cb75-116" aria-hidden="true" tabindex="-1"></a><span class="in">                                    size = rel(1), hjust = 0),</span></span>
<span id="cb75-117"><a href="#cb75-117" aria-hidden="true" tabindex="-1"></a><span class="in">          strip.background = element_rect(fill = "grey80", color = NA))</span></span>
<span id="cb75-118"><a href="#cb75-118" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb75-119"><a href="#cb75-119" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-120"><a href="#cb75-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-121"><a href="#cb75-121" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exponentially distributed outcomes with zeros</span></span>
<span id="cb75-122"><a href="#cb75-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-123"><a href="#cb75-123" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">Like Hans Rosling</span><span class="co">](https://www.youtube.com/watch?v=Z8t4k0Q8e8Y)</span>, we're interested in the relationship between health and wealth. How do a country's GDP per capita and life expectancy move together? We'll look at this a few different ways, dealing with both the exponential shape of the data and the presence of all those zeros we added. </span>
<span id="cb75-124"><a href="#cb75-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-125"><a href="#cb75-125" aria-hidden="true" tabindex="-1"></a>All these examples are the ***reverse*** of the standard way of looking at the health/wealth relationship—in Rosling's TED talk, GDP is on the x-axis and life expectancy is on the y-axis, since his theory is that more wealth leads to better health and longer life. But since I want to illustrate how to model logged outcome, we'll put GDP on the y-axis here, which means we'll be seeing what happens to wealth as life expectancy changes by one year (i.e. instead of the more standard <span class="in">`lifeExp ~ gdpPercap`</span>, we'll look at <span class="in">`gdpPercap ~ lifeExp`</span>).</span>
<span id="cb75-126"><a href="#cb75-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-127"><a href="#cb75-127" aria-hidden="true" tabindex="-1"></a>The data from the <span class="co">[</span><span class="ot">Gapminder Project</span><span class="co">](https://www.gapminder.org/)</span> is nice and clean and complete—there are no missing values, and there are no zero values. That means we'll need to mess with the data a little to force it to have some zeros that we can work with. We'll change some of the existing GDP per capita values to 0 based on two conditions:</span>
<span id="cb75-128"><a href="#cb75-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-129"><a href="#cb75-129" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>If life expectancy is less than 50 years, there will be a 30% chance that the value of GDP per capita is 0</span>
<span id="cb75-130"><a href="#cb75-130" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>If life expectancy is greater than 50 years, there will be a 2% chance that the value of GDP per capita is 0</span>
<span id="cb75-131"><a href="#cb75-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-132"><a href="#cb75-132" aria-hidden="true" tabindex="-1"></a>This means that countries with lower life expectancy will be more likely to have 0 GDP per capita in a given year.</span>
<span id="cb75-133"><a href="#cb75-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-134"><a href="#cb75-134" aria-hidden="true" tabindex="-1"></a><span class="in">```{r make-zero-gapminder-data}</span></span>
<span id="cb75-135"><a href="#cb75-135" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(1234)</span></span>
<span id="cb75-136"><a href="#cb75-136" aria-hidden="true" tabindex="-1"></a><span class="in">gapminder &lt;- gapminder::gapminder |&gt; </span></span>
<span id="cb75-137"><a href="#cb75-137" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(continent != "Oceania") |&gt; </span></span>
<span id="cb75-138"><a href="#cb75-138" aria-hidden="true" tabindex="-1"></a><span class="in">  # Make a bunch of GDP values 0</span></span>
<span id="cb75-139"><a href="#cb75-139" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(prob_zero = ifelse(lifeExp &lt; 50, 0.3, 0.02),</span></span>
<span id="cb75-140"><a href="#cb75-140" aria-hidden="true" tabindex="-1"></a><span class="in">         will_be_zero = rbinom(n(), 1, prob = prob_zero),</span></span>
<span id="cb75-141"><a href="#cb75-141" aria-hidden="true" tabindex="-1"></a><span class="in">         gdpPercap = ifelse(will_be_zero, 0, gdpPercap)) |&gt; </span></span>
<span id="cb75-142"><a href="#cb75-142" aria-hidden="true" tabindex="-1"></a><span class="in">  select(-prob_zero, -will_be_zero) |&gt; </span></span>
<span id="cb75-143"><a href="#cb75-143" aria-hidden="true" tabindex="-1"></a><span class="in">  # Make a logged version of GDP per capita</span></span>
<span id="cb75-144"><a href="#cb75-144" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(log_gdpPercap = log1p(gdpPercap)) |&gt; </span></span>
<span id="cb75-145"><a href="#cb75-145" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(is_zero = gdpPercap == 0)</span></span>
<span id="cb75-146"><a href="#cb75-146" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-147"><a href="#cb75-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-148"><a href="#cb75-148" aria-hidden="true" tabindex="-1"></a><span class="fu">### Explore data</span></span>
<span id="cb75-149"><a href="#cb75-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-150"><a href="#cb75-150" aria-hidden="true" tabindex="-1"></a>Let's check if it worked:</span>
<span id="cb75-151"><a href="#cb75-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-152"><a href="#cb75-152" aria-hidden="true" tabindex="-1"></a><span class="in">```{r prop-zero-gapminder}</span></span>
<span id="cb75-153"><a href="#cb75-153" aria-hidden="true" tabindex="-1"></a><span class="in">gapminder |&gt; </span></span>
<span id="cb75-154"><a href="#cb75-154" aria-hidden="true" tabindex="-1"></a><span class="in">  count(is_zero) |&gt; </span></span>
<span id="cb75-155"><a href="#cb75-155" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(prop = n / sum(n))</span></span>
<span id="cb75-156"><a href="#cb75-156" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-157"><a href="#cb75-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-158"><a href="#cb75-158" aria-hidden="true" tabindex="-1"></a>Perfect! We broke the pristine data and now <span class="in">`r label_percent(accuracy = 0.1)(sum(gapminder$is_zero) / nrow(gapminder))`</span> of the values of GDP per capita are zero.</span>
<span id="cb75-159"><a href="#cb75-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-160"><a href="#cb75-160" aria-hidden="true" tabindex="-1"></a>We can visualize this too (and we'll cheat a little for the sake of plotting by temporarily changing all zeros to a negative number so we can get a separate count in the histogram). </span>
<span id="cb75-161"><a href="#cb75-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-162"><a href="#cb75-162" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-gdp-dist, fig.width=8, out.width="100%"}</span></span>
<span id="cb75-163"><a href="#cb75-163" aria-hidden="true" tabindex="-1"></a><span class="in">plot_dist_unlogged &lt;- gapminder |&gt; </span></span>
<span id="cb75-164"><a href="#cb75-164" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(gdpPercap = ifelse(is_zero, -0.1, gdpPercap)) |&gt; </span></span>
<span id="cb75-165"><a href="#cb75-165" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = gdpPercap)) +</span></span>
<span id="cb75-166"><a href="#cb75-166" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_histogram(aes(fill = is_zero), binwidth = 5000, </span></span>
<span id="cb75-167"><a href="#cb75-167" aria-hidden="true" tabindex="-1"></a><span class="in">                 boundary = 0, color = "white") +</span></span>
<span id="cb75-168"><a href="#cb75-168" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0) + </span></span>
<span id="cb75-169"><a href="#cb75-169" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_dollar(scale_cut = cut_short_scale())) +</span></span>
<span id="cb75-170"><a href="#cb75-170" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_manual(values = c(clrs[4], clrs[1]), </span></span>
<span id="cb75-171"><a href="#cb75-171" aria-hidden="true" tabindex="-1"></a><span class="in">                    guide = guide_legend(reverse = TRUE)) +</span></span>
<span id="cb75-172"><a href="#cb75-172" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "GDP per capita", y = "Count", fill = "Is zero?",</span></span>
<span id="cb75-173"><a href="#cb75-173" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "Nice and exponentially shaped, with a bunch of zeros") +</span></span>
<span id="cb75-174"><a href="#cb75-174" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice() +</span></span>
<span id="cb75-175"><a href="#cb75-175" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = "bottom")</span></span>
<span id="cb75-176"><a href="#cb75-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-177"><a href="#cb75-177" aria-hidden="true" tabindex="-1"></a><span class="in">plot_dist_logged &lt;- gapminder |&gt; </span></span>
<span id="cb75-178"><a href="#cb75-178" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(log_gdpPercap = ifelse(is_zero, -0.1, log_gdpPercap)) |&gt; </span></span>
<span id="cb75-179"><a href="#cb75-179" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = log_gdpPercap)) +</span></span>
<span id="cb75-180"><a href="#cb75-180" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_histogram(aes(fill = is_zero), binwidth = 0.5, </span></span>
<span id="cb75-181"><a href="#cb75-181" aria-hidden="true" tabindex="-1"></a><span class="in">                 boundary = 0, color = "white") +</span></span>
<span id="cb75-182"><a href="#cb75-182" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0) +</span></span>
<span id="cb75-183"><a href="#cb75-183" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_math(e^.x)) +</span></span>
<span id="cb75-184"><a href="#cb75-184" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_manual(values = c(clrs[4], clrs[1]), </span></span>
<span id="cb75-185"><a href="#cb75-185" aria-hidden="true" tabindex="-1"></a><span class="in">                    guide = guide_legend(reverse = TRUE)) +</span></span>
<span id="cb75-186"><a href="#cb75-186" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "GDP per capita", y = "Count", fill = "Is zero?",</span></span>
<span id="cb75-187"><a href="#cb75-187" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "Nice and normally shaped, with a bunch of zeros;\nit's hard to interpret intuitively though") +</span></span>
<span id="cb75-188"><a href="#cb75-188" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice() +</span></span>
<span id="cb75-189"><a href="#cb75-189" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = "bottom")</span></span>
<span id="cb75-190"><a href="#cb75-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-191"><a href="#cb75-191" aria-hidden="true" tabindex="-1"></a><span class="in">(plot_dist_unlogged | plot_dist_logged) +</span></span>
<span id="cb75-192"><a href="#cb75-192" aria-hidden="true" tabindex="-1"></a><span class="in">  plot_layout(guides = "collect") +</span></span>
<span id="cb75-193"><a href="#cb75-193" aria-hidden="true" tabindex="-1"></a><span class="in">  plot_annotation(title = "GDP per capita, original vs. logged",</span></span>
<span id="cb75-194"><a href="#cb75-194" aria-hidden="true" tabindex="-1"></a><span class="in">                  theme = theme(plot.title = element_text(family = "Jost", face = "bold"),</span></span>
<span id="cb75-195"><a href="#cb75-195" aria-hidden="true" tabindex="-1"></a><span class="in">                                legend.position = "bottom"))</span></span>
<span id="cb75-196"><a href="#cb75-196" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-197"><a href="#cb75-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-198"><a href="#cb75-198" aria-hidden="true" tabindex="-1"></a>The left panel here shows the exponential distribution of GDP per capita. There are a lot of countries with low values (less than $500!), and increasingly fewer countries with more per capita wealth. The right panel shows the natural log (i.e. log <span class="co">[</span><span class="ot">base *e*</span><span class="co">]</span>(https://en.wikipedia.org/wiki/E_(mathematical_constant))) of GDP per capita. It's now a lot more normally distributed (if we disregard the column showing the count of zeros), but note the x-axis scale—instead of using easily interpretable dollars, it shows the exponent that *e* is raised to, which is really unintuitive. Logged values are helpful when working with regression models, and <span class="co">[</span><span class="ot">this CrossValidated post</span><span class="co">](https://stats.stackexchange.com/a/18639/3025)</span> reviews how to interpret model coefficients when different variables are logged or not. In this case, if we use logged GDP per capita as the outcome variable, any explanatory coefficients we have will represent the percent change in GDP per capita—a one-year increase in life expectancy will be associated with a X% change in GDP per capita, on average.</span>
<span id="cb75-199"><a href="#cb75-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-200"><a href="#cb75-200" aria-hidden="true" tabindex="-1"></a>Ideally, it'd be great if we could work with dollar-scale coefficients and marginal effects rather than percent change-based coefficients (since I find dollars more intuitive than percent changes), but because of mathy and statsy reasons, it's best to model this outcome using a log scale. With some neat tricks, though, we can back-transform the log-scale results to dollars.</span>
<span id="cb75-201"><a href="#cb75-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-202"><a href="#cb75-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-203"><a href="#cb75-203" aria-hidden="true" tabindex="-1"></a><span class="fu">### 1. Regular OLS model on an unlogged outcome</span></span>
<span id="cb75-204"><a href="#cb75-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-205"><a href="#cb75-205" aria-hidden="true" tabindex="-1"></a>Now that we've built in some zeros, let's model the relationship between health and wealth.</span>
<span id="cb75-206"><a href="#cb75-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-207"><a href="#cb75-207" aria-hidden="true" tabindex="-1"></a>First, we'll use a basic linear regression model with all the data at its original scale—no logging, no accounting for zeros, just drawing a straight line through data using ordinal least squares (OLS). Let's look at a scatterplot first:</span>
<span id="cb75-208"><a href="#cb75-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-209"><a href="#cb75-209" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-ols-unlogged, message=FALSE}</span></span>
<span id="cb75-210"><a href="#cb75-210" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(gapminder, aes(x = lifeExp, y = gdpPercap)) +</span></span>
<span id="cb75-211"><a href="#cb75-211" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(aes(color = continent), size = 1, alpha = 0.5) + </span></span>
<span id="cb75-212"><a href="#cb75-212" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_smooth(method = "lm", color = "#0074D9") +</span></span>
<span id="cb75-213"><a href="#cb75-213" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_y_continuous(labels = label_dollar(scale_cut = cut_short_scale())) +</span></span>
<span id="cb75-214"><a href="#cb75-214" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_color_manual(values = clrs) +</span></span>
<span id="cb75-215"><a href="#cb75-215" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Life expectancy", y = "GDP per capita", color = NULL,</span></span>
<span id="cb75-216"><a href="#cb75-216" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "OLS model fit on unlogged GDP") +</span></span>
<span id="cb75-217"><a href="#cb75-217" aria-hidden="true" tabindex="-1"></a><span class="in">  guides(color = guide_legend(override.aes = list(size = 1.5, alpha = 1))) +</span></span>
<span id="cb75-218"><a href="#cb75-218" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice() +</span></span>
<span id="cb75-219"><a href="#cb75-219" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = "bottom")</span></span>
<span id="cb75-220"><a href="#cb75-220" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-221"><a href="#cb75-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-222"><a href="#cb75-222" aria-hidden="true" tabindex="-1"></a>Hahaha that line is, um, great. Because of the exponential distribution of GDP per capita, the scatterplot follows a sort of hockey stick shape: the points are almost horizontal at low levels of life expectancy and they start trending at more of a 45º angle at at around 65 years The corresponding OLS trend line cuts across empty space in a ridiculous way and predicts negative income at low life expectancy and quite muted income at high life expectancy</span>
<span id="cb75-223"><a href="#cb75-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-224"><a href="#cb75-224" aria-hidden="true" tabindex="-1"></a>Even so, <span class="co">[</span><span class="ot">many social science disciplines</span><span class="co">](https://en.wikipedia.org/wiki/Economics)</span> love OLS and use it for literally everything, so we'll use it here too. Let's make a basic OLS model:</span>
<span id="cb75-225"><a href="#cb75-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-226"><a href="#cb75-226" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-gdp-basic, cache=TRUE, warning=FALSE, results="hide"}</span></span>
<span id="cb75-227"><a href="#cb75-227" aria-hidden="true" tabindex="-1"></a><span class="in">model_gdp_basic &lt;- brm(</span></span>
<span id="cb75-228"><a href="#cb75-228" aria-hidden="true" tabindex="-1"></a><span class="in">  bf(gdpPercap ~ lifeExp),</span></span>
<span id="cb75-229"><a href="#cb75-229" aria-hidden="true" tabindex="-1"></a><span class="in">  data = gapminder,</span></span>
<span id="cb75-230"><a href="#cb75-230" aria-hidden="true" tabindex="-1"></a><span class="in">  family = gaussian(),</span></span>
<span id="cb75-231"><a href="#cb75-231" aria-hidden="true" tabindex="-1"></a><span class="in">  chains = CHAINS, iter = ITER, warmup = WARMUP, seed = BAYES_SEED,</span></span>
<span id="cb75-232"><a href="#cb75-232" aria-hidden="true" tabindex="-1"></a><span class="in">  silent = 2</span></span>
<span id="cb75-233"><a href="#cb75-233" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb75-234"><a href="#cb75-234" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-235"><a href="#cb75-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-236"><a href="#cb75-236" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-model-gdp-basic}</span></span>
<span id="cb75-237"><a href="#cb75-237" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_gdp_basic)</span></span>
<span id="cb75-238"><a href="#cb75-238" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-239"><a href="#cb75-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-240"><a href="#cb75-240" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-model-gdp-basic, include=FALSE}</span></span>
<span id="cb75-241"><a href="#cb75-241" aria-hidden="true" tabindex="-1"></a><span class="in">m_gdp_basic &lt;- tidy(model_gdp_basic) |&gt; </span></span>
<span id="cb75-242"><a href="#cb75-242" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(term = janitor::make_clean_names(term),</span></span>
<span id="cb75-243"><a href="#cb75-243" aria-hidden="true" tabindex="-1"></a><span class="in">         est = round(estimate, 2)) |&gt; </span></span>
<span id="cb75-244"><a href="#cb75-244" aria-hidden="true" tabindex="-1"></a><span class="in">  split(~ term)</span></span>
<span id="cb75-245"><a href="#cb75-245" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-246"><a href="#cb75-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-247"><a href="#cb75-247" aria-hidden="true" tabindex="-1"></a>Based on this model, when life expectancy is 0, the average GDP per capita is <span class="in">`r label_dollar()(m_gdp_basic$intercept$est)`</span>, though since no countries have life expectancy that low, we shouldn't really interpret that intercept—it mostly just exists so that the line can start somewhere. We care the most about the <span class="in">`lifeExp`</span> coefficient: a one-year increase in life expectancy is associated with a <span class="in">`r label_dollar()(m_gdp_basic$life_exp$est)`</span> increase in GDP per capita, on average.</span>
<span id="cb75-248"><a href="#cb75-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-249"><a href="#cb75-249" aria-hidden="true" tabindex="-1"></a>We can already tell that the fitted OLS trend isn't that great. Let's do a posterior predictive check to see how well the actual observed GDP per capita (in &lt;span style="color:`r clrs[4]`;"&gt;■<span class="dv">&amp;nbsp;</span>light blue&lt;/span&gt;) aligns with simulated GDP per capita from the posterior distribution of the model (in &lt;span style="color:`r clrs[2]`;"&gt;■<span class="dv">&amp;nbsp;</span>orange&lt;/span&gt;):</span>
<span id="cb75-250"><a href="#cb75-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-251"><a href="#cb75-251" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-pp-model-gdp-basic-fake, eval=FALSE}</span></span>
<span id="cb75-252"><a href="#cb75-252" aria-hidden="true" tabindex="-1"></a><span class="in">pp_check(model_gdp_basic)</span></span>
<span id="cb75-253"><a href="#cb75-253" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-254"><a href="#cb75-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-255"><a href="#cb75-255" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-pp-model-gdp-basic, fig.height=2.75, echo=FALSE, message=FALSE}</span></span>
<span id="cb75-256"><a href="#cb75-256" aria-hidden="true" tabindex="-1"></a><span class="in">pp_check(model_gdp_basic) +</span></span>
<span id="cb75-257"><a href="#cb75-257" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_dollar(scale_cut = cut_short_scale())) +</span></span>
<span id="cb75-258"><a href="#cb75-258" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(title = "Posterior predictive check", </span></span>
<span id="cb75-259"><a href="#cb75-259" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "OLS model fit on unlogged GDP") +</span></span>
<span id="cb75-260"><a href="#cb75-260" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice()</span></span>
<span id="cb75-261"><a href="#cb75-261" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-262"><a href="#cb75-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-263"><a href="#cb75-263" aria-hidden="true" tabindex="-1"></a>Again, not fantastic. The actual distribution of GDP per capita is (1) exponential, so it has lots of low values, and (2) zero-inflated, so it has a lot of zeros. The posterior from the model shows a nice normal distribution of GDP per capita centered around $15,000ish. It's not a great model at all.</span>
<span id="cb75-264"><a href="#cb75-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-265"><a href="#cb75-265" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2. Regular OLS model on a logged outcome</span></span>
<span id="cb75-266"><a href="#cb75-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-267"><a href="#cb75-267" aria-hidden="true" tabindex="-1"></a>A standard approach when working with exponentially distributed outcomes like this is to log them. If we look at this scatterplot with base-10-logged GDP per capita, the shape of the data is much more linear and modelable. I put the 0s in a separate facet so that they're easier to see too. We can easily see the two different processes—there's a positive relationship between life expectancy and logged GDP per capita (shown with the &lt;span style="color:#0074D9;"&gt;■<span class="dv">&amp;nbsp;</span>blue&lt;/span&gt; line), and there are a bunch of observations with 0 GDP per capita, generally clustered among rows with life expectancy less than 50 (which is by design, since we made it so all those rows had a 20% chance of getting a 0).</span>
<span id="cb75-268"><a href="#cb75-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-269"><a href="#cb75-269" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-health-wealth-facet, fig.width=8, fig.height=5, out.width="100%", message=FALSE}</span></span>
<span id="cb75-270"><a href="#cb75-270" aria-hidden="true" tabindex="-1"></a><span class="in">plot_health_wealth_facet &lt;- gapminder |&gt; </span></span>
<span id="cb75-271"><a href="#cb75-271" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(nice_zero = factor(is_zero, levels = c(FALSE, TRUE),</span></span>
<span id="cb75-272"><a href="#cb75-272" aria-hidden="true" tabindex="-1"></a><span class="in">                            labels = c("GDP &gt; $0", "0"),</span></span>
<span id="cb75-273"><a href="#cb75-273" aria-hidden="true" tabindex="-1"></a><span class="in">                            ordered = TRUE)) |&gt; </span></span>
<span id="cb75-274"><a href="#cb75-274" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = lifeExp, y = gdpPercap + 1)) +</span></span>
<span id="cb75-275"><a href="#cb75-275" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(aes(color = continent), size = 1, alpha = 0.5) +</span></span>
<span id="cb75-276"><a href="#cb75-276" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_smooth(aes(linetype = is_zero), method = "lm", se = FALSE, color = "#0074D9") +</span></span>
<span id="cb75-277"><a href="#cb75-277" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_y_log10(labels = label_dollar(scale_cut = cut_short_scale()),</span></span>
<span id="cb75-278"><a href="#cb75-278" aria-hidden="true" tabindex="-1"></a><span class="in">                breaks = 125 * (2^(1:10))) +</span></span>
<span id="cb75-279"><a href="#cb75-279" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_color_manual(values = clrs) +</span></span>
<span id="cb75-280"><a href="#cb75-280" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_linetype_manual(values = c("solid", "blank"), guide = NULL) +</span></span>
<span id="cb75-281"><a href="#cb75-281" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Life expectancy", y = "GDP per capita (base 10 logged)", color = NULL,</span></span>
<span id="cb75-282"><a href="#cb75-282" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "OLS model fit only for rows where GDP &gt; 0",</span></span>
<span id="cb75-283"><a href="#cb75-283" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "GDP per capita logged with base 10") +</span></span>
<span id="cb75-284"><a href="#cb75-284" aria-hidden="true" tabindex="-1"></a><span class="in">  guides(color = guide_legend(override.aes = list(size = 1.5, alpha = 1))) +</span></span>
<span id="cb75-285"><a href="#cb75-285" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(xlim = c(30, 80)) +</span></span>
<span id="cb75-286"><a href="#cb75-286" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_grid(rows = vars(nice_zero), scales = "free_y", space = "free") + </span></span>
<span id="cb75-287"><a href="#cb75-287" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice() + </span></span>
<span id="cb75-288"><a href="#cb75-288" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = "bottom",</span></span>
<span id="cb75-289"><a href="#cb75-289" aria-hidden="true" tabindex="-1"></a><span class="in">        strip.text = element_text(size = rel(0.7)))</span></span>
<span id="cb75-290"><a href="#cb75-290" aria-hidden="true" tabindex="-1"></a><span class="in">plot_health_wealth_facet</span></span>
<span id="cb75-291"><a href="#cb75-291" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-292"><a href="#cb75-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-293"><a href="#cb75-293" aria-hidden="true" tabindex="-1"></a>The same relationship holds when we use the natural log of GDP per capita, where values range from 6–12ish, as we saw in the histogram earlier. For statistical reasons, using the natural log works better and makes the interpretation of the coefficients easier since we can talk about percent changes in the outcome. Again, <span class="co">[</span><span class="ot">this CrossValidated post</span><span class="co">](https://stats.stackexchange.com/a/18639/3025)</span> is indispensable for remembering how to interpret coefficients that are or aren't logged when outcomes are or aren't logged.</span>
<span id="cb75-294"><a href="#cb75-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-295"><a href="#cb75-295" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-health-wealth-facet-ln, fig.width=8, fig.height=5, out.width="100%", message=FALSE, warning=FALSE}</span></span>
<span id="cb75-296"><a href="#cb75-296" aria-hidden="true" tabindex="-1"></a><span class="in">plot_health_wealth_facet +</span></span>
<span id="cb75-297"><a href="#cb75-297" aria-hidden="true" tabindex="-1"></a><span class="in">  # Switch the column on the y-axis to logged GDP per capita</span></span>
<span id="cb75-298"><a href="#cb75-298" aria-hidden="true" tabindex="-1"></a><span class="in">  aes(y = log_gdpPercap) +</span></span>
<span id="cb75-299"><a href="#cb75-299" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_y_continuous(labels = label_math(e^.x), breaks = 5:12) +</span></span>
<span id="cb75-300"><a href="#cb75-300" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(y = "GDP per capital (logged)",</span></span>
<span id="cb75-301"><a href="#cb75-301" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "GDP per capita logged with base e")</span></span>
<span id="cb75-302"><a href="#cb75-302" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-303"><a href="#cb75-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-304"><a href="#cb75-304" aria-hidden="true" tabindex="-1"></a>However, those zeros are going to cause problems. The nice &lt;span style="color:#0074D9;"&gt;■<span class="dv">&amp;nbsp;</span>blue&lt;/span&gt; line is only fit using the non-zero data. If we include the zeros, like the &lt;span style="color:#F012BE;"&gt;■<span class="dv">&amp;nbsp;</span>fuchsia&lt;/span&gt; line in this plot, the relationship is substantially different:</span>
<span id="cb75-305"><a href="#cb75-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-306"><a href="#cb75-306" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-health-wealth-no-facet, fig.width=8, fig.height=5, out.width="100%", message=FALSE}</span></span>
<span id="cb75-307"><a href="#cb75-307" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(gapminder, aes(x = lifeExp, y = log_gdpPercap)) +</span></span>
<span id="cb75-308"><a href="#cb75-308" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(aes(color = continent), size = 1, alpha = 0.5) + </span></span>
<span id="cb75-309"><a href="#cb75-309" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_smooth(method = "lm", color = "#F012BE") +</span></span>
<span id="cb75-310"><a href="#cb75-310" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_smooth(data = filter(gapminder, gdpPercap != 0), method = "lm", color = "#0074D9") +</span></span>
<span id="cb75-311"><a href="#cb75-311" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_y_continuous(labels = label_math(e^.x)) +</span></span>
<span id="cb75-312"><a href="#cb75-312" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_color_manual(values = clrs) +</span></span>
<span id="cb75-313"><a href="#cb75-313" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Life expectancy", y = "GDP per capita (log)", color = NULL) +</span></span>
<span id="cb75-314"><a href="#cb75-314" aria-hidden="true" tabindex="-1"></a><span class="in">  guides(color = guide_legend(override.aes = list(size = 1.5, alpha = 1))) +</span></span>
<span id="cb75-315"><a href="#cb75-315" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(xlim = c(30, 80)) +</span></span>
<span id="cb75-316"><a href="#cb75-316" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(title = 'OLS models &lt;span style="color:#F012BE;"&gt;with&lt;/span&gt; and &lt;span style="color:#0074D9;"&gt;without&lt;/span&gt; zeros') +</span></span>
<span id="cb75-317"><a href="#cb75-317" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice() +</span></span>
<span id="cb75-318"><a href="#cb75-318" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = "bottom",</span></span>
<span id="cb75-319"><a href="#cb75-319" aria-hidden="true" tabindex="-1"></a><span class="in">        plot.title = element_markdown())</span></span>
<span id="cb75-320"><a href="#cb75-320" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-321"><a href="#cb75-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-322"><a href="#cb75-322" aria-hidden="true" tabindex="-1"></a>Let's make a couple models that use logged GDP with and without zeros and compare the life expectancy coefficients:</span>
<span id="cb75-323"><a href="#cb75-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-324"><a href="#cb75-324" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-log-gdp-basic, cache=TRUE, warning=FALSE, results="hide"}</span></span>
<span id="cb75-325"><a href="#cb75-325" aria-hidden="true" tabindex="-1"></a><span class="in">model_log_gdp_basic &lt;- brm(</span></span>
<span id="cb75-326"><a href="#cb75-326" aria-hidden="true" tabindex="-1"></a><span class="in">  bf(log_gdpPercap ~ lifeExp),</span></span>
<span id="cb75-327"><a href="#cb75-327" aria-hidden="true" tabindex="-1"></a><span class="in">  data = gapminder,</span></span>
<span id="cb75-328"><a href="#cb75-328" aria-hidden="true" tabindex="-1"></a><span class="in">  family = gaussian(),</span></span>
<span id="cb75-329"><a href="#cb75-329" aria-hidden="true" tabindex="-1"></a><span class="in">  chains = CHAINS, iter = ITER, warmup = WARMUP, seed = BAYES_SEED,</span></span>
<span id="cb75-330"><a href="#cb75-330" aria-hidden="true" tabindex="-1"></a><span class="in">  silent = 2</span></span>
<span id="cb75-331"><a href="#cb75-331" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb75-332"><a href="#cb75-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-333"><a href="#cb75-333" aria-hidden="true" tabindex="-1"></a><span class="in">model_log_gdp_no_zeros &lt;- brm(</span></span>
<span id="cb75-334"><a href="#cb75-334" aria-hidden="true" tabindex="-1"></a><span class="in">  bf(log_gdpPercap ~ lifeExp),</span></span>
<span id="cb75-335"><a href="#cb75-335" aria-hidden="true" tabindex="-1"></a><span class="in">  data = filter(gapminder, !is_zero),</span></span>
<span id="cb75-336"><a href="#cb75-336" aria-hidden="true" tabindex="-1"></a><span class="in">  family = gaussian(),</span></span>
<span id="cb75-337"><a href="#cb75-337" aria-hidden="true" tabindex="-1"></a><span class="in">  chains = CHAINS, iter = ITER, warmup = WARMUP, seed = BAYES_SEED,</span></span>
<span id="cb75-338"><a href="#cb75-338" aria-hidden="true" tabindex="-1"></a><span class="in">  silent = 2</span></span>
<span id="cb75-339"><a href="#cb75-339" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb75-340"><a href="#cb75-340" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-341"><a href="#cb75-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-342"><a href="#cb75-342" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-model-log-gdp-basic}</span></span>
<span id="cb75-343"><a href="#cb75-343" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_log_gdp_basic)</span></span>
<span id="cb75-344"><a href="#cb75-344" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_log_gdp_no_zeros)</span></span>
<span id="cb75-345"><a href="#cb75-345" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-346"><a href="#cb75-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-347"><a href="#cb75-347" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-model-log-gdp-basic, include=FALSE}</span></span>
<span id="cb75-348"><a href="#cb75-348" aria-hidden="true" tabindex="-1"></a><span class="in">m_log_gdp_basic &lt;- tidy(model_log_gdp_basic) |&gt; </span></span>
<span id="cb75-349"><a href="#cb75-349" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(term = janitor::make_clean_names(term),</span></span>
<span id="cb75-350"><a href="#cb75-350" aria-hidden="true" tabindex="-1"></a><span class="in">         est = label_percent(accuracy = 0.1)(estimate)) |&gt; </span></span>
<span id="cb75-351"><a href="#cb75-351" aria-hidden="true" tabindex="-1"></a><span class="in">  split(~ term)</span></span>
<span id="cb75-352"><a href="#cb75-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-353"><a href="#cb75-353" aria-hidden="true" tabindex="-1"></a><span class="in">m_log_gdp_no_zeros &lt;- tidy(model_log_gdp_no_zeros) |&gt;  </span></span>
<span id="cb75-354"><a href="#cb75-354" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(term = janitor::make_clean_names(term),</span></span>
<span id="cb75-355"><a href="#cb75-355" aria-hidden="true" tabindex="-1"></a><span class="in">         est = label_percent(accuracy = 0.1)(estimate)) |&gt; </span></span>
<span id="cb75-356"><a href="#cb75-356" aria-hidden="true" tabindex="-1"></a><span class="in">  split(~ term)</span></span>
<span id="cb75-357"><a href="#cb75-357" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-358"><a href="#cb75-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-359"><a href="#cb75-359" aria-hidden="true" tabindex="-1"></a>In the model that includes the zeros (the &lt;span style="color:#F012BE;"&gt;■<span class="dv">&amp;nbsp;</span>fuchsia&lt;/span&gt; line), a one-year increase in life expectancy is associated with a <span class="in">`r m_log_gdp_basic$life_exp$est`</span> increase in GDP per capita, on average, but if we omit the zeros (the &lt;span style="color:#0074D9;"&gt;■<span class="dv">&amp;nbsp;</span>blue&lt;/span&gt; line), the slope changes substantially—here, a one-year increase in life expectancy is associated with a <span class="in">`r m_log_gdp_no_zeros$life_exp$est`</span> increase in GDP per capita. The zero-free model fits the data better, but omits the zeros; the model with the zeros included is arguably more accurate, but is simultaneously less accurate given how poorly it predicts values with low life expectancy.</span>
<span id="cb75-360"><a href="#cb75-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-361"><a href="#cb75-361" aria-hidden="true" tabindex="-1"></a>This is also apparent when we look at posterior predictive checks. The model that includes zeros has two very clear peaks in the distributions of the actual values of GDP per capita (in &lt;span style="color:`r clrs[4]`;"&gt;■<span class="dv">&amp;nbsp;</span>light blue&lt;/span&gt;), while the simulated values of GDP per capita (in &lt;span style="color:`r clrs[2]`;"&gt;■<span class="dv">&amp;nbsp;</span>orange&lt;/span&gt;) are unimodal and both under- and over-estimates</span>
<span id="cb75-362"><a href="#cb75-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-363"><a href="#cb75-363" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-pp-model-log-gdp-fake, eval=FALSE}</span></span>
<span id="cb75-364"><a href="#cb75-364" aria-hidden="true" tabindex="-1"></a><span class="in">pp_check(model_log_gdp_basic)</span></span>
<span id="cb75-365"><a href="#cb75-365" aria-hidden="true" tabindex="-1"></a><span class="in">pp_check(model_log_gdp_no_zeros)</span></span>
<span id="cb75-366"><a href="#cb75-366" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-367"><a href="#cb75-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-368"><a href="#cb75-368" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-pp-model-log-gdp, fig.width=8, fig.height=3.5, warning=FALSE, message=FALSE, echo=FALSE}</span></span>
<span id="cb75-369"><a href="#cb75-369" aria-hidden="true" tabindex="-1"></a><span class="in">plot_pp1 &lt;- pp_check(model_log_gdp_basic) +</span></span>
<span id="cb75-370"><a href="#cb75-370" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_math(e^.x)) +</span></span>
<span id="cb75-371"><a href="#cb75-371" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(subtitle = "Model includes zeros") +</span></span>
<span id="cb75-372"><a href="#cb75-372" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice()</span></span>
<span id="cb75-373"><a href="#cb75-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-374"><a href="#cb75-374" aria-hidden="true" tabindex="-1"></a><span class="in">plot_pp2 &lt;- pp_check(model_log_gdp_no_zeros) +</span></span>
<span id="cb75-375"><a href="#cb75-375" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_math(e^.x)) +</span></span>
<span id="cb75-376"><a href="#cb75-376" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(subtitle = "Model omits zeros") +</span></span>
<span id="cb75-377"><a href="#cb75-377" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice()</span></span>
<span id="cb75-378"><a href="#cb75-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-379"><a href="#cb75-379" aria-hidden="true" tabindex="-1"></a><span class="in">(plot_pp1 | plot_pp2) +</span></span>
<span id="cb75-380"><a href="#cb75-380" aria-hidden="true" tabindex="-1"></a><span class="in">  plot_layout(guides = "collect") +</span></span>
<span id="cb75-381"><a href="#cb75-381" aria-hidden="true" tabindex="-1"></a><span class="in">  plot_annotation(title = "Posterior predictive checks",</span></span>
<span id="cb75-382"><a href="#cb75-382" aria-hidden="true" tabindex="-1"></a><span class="in">                  theme = theme(plot.title = element_text(family = "Jost", face = "bold")))</span></span>
<span id="cb75-383"><a href="#cb75-383" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-384"><a href="#cb75-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-385"><a href="#cb75-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-386"><a href="#cb75-386" aria-hidden="true" tabindex="-1"></a><span class="fu">### 3. Hurdle lognormal model</span></span>
<span id="cb75-387"><a href="#cb75-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-388"><a href="#cb75-388" aria-hidden="true" tabindex="-1"></a>We thus have a dilemma. If we omit the zeros, we'll get a good, accurate model fit for non-zero data, but we'll be throwing away all the data with zeros (in this case that's like 10% of the data!). If we include the zeros, we won't be throwing any data away, but we'll get a strange-fitting model that both under- and over-predicts values. So what do we do?!</span>
<span id="cb75-389"><a href="#cb75-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-390"><a href="#cb75-390" aria-hidden="true" tabindex="-1"></a>~~We give up.~~ </span>
<span id="cb75-391"><a href="#cb75-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-392"><a href="#cb75-392" aria-hidden="true" tabindex="-1"></a>~~We live like economists and embrace OLS.~~</span>
<span id="cb75-393"><a href="#cb75-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-394"><a href="#cb75-394" aria-hidden="true" tabindex="-1"></a>We use a model that incorporates information about both the zeros *and* the non-zeros!</span>
<span id="cb75-395"><a href="#cb75-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-396"><a href="#cb75-396" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">In an earlier post</span><span class="co">](https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/)</span>, <span class="co">[</span><span class="ot">I show how zero-inflated beta regression works</span><span class="co">](https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/#4-zero-inflated-beta-regression-bayesian-style)</span>. Beta regression works well for outcomes that are bounded between 0 and 1, but they cannot model values that are exactly 0 or 1. To get around this, it's possible to model multiple processes simultaneously:</span>
<span id="cb75-397"><a href="#cb75-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-398"><a href="#cb75-398" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>A logistic regression model that predicts if an outcome is 0 or not</span>
<span id="cb75-399"><a href="#cb75-399" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>A beta regression model that predicts if an outcome is between 0 and 1 if it’s not zero</span>
<span id="cb75-400"><a href="#cb75-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-401"><a href="#cb75-401" aria-hidden="true" tabindex="-1"></a>We can use a similar mixture process for outcomes that don't use beta regression. For whatever reason, instead of calling these models *zero-inflated*, we call them *hurdle models*, and **brms** includes four different built-in families:</span>
<span id="cb75-402"><a href="#cb75-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-403"><a href="#cb75-403" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Use a logistic regression model that predicts if an outcome is 0 or not (this is the *hurdle* part)</span>
<span id="cb75-404"><a href="#cb75-404" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Use a lognormal (<span class="in">`hurdle_lognormal()`</span>), gamma (<span class="in">`hurdle_gamma()`</span>), Poisson (<span class="in">`hurdle_poisson()`</span>), or negative binomial (<span class="in">`hurdle_negbinomial()`</span>) model for outcomes that are not zero</span>
<span id="cb75-405"><a href="#cb75-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-406"><a href="#cb75-406" aria-hidden="true" tabindex="-1"></a>As we do with <span class="co">[</span><span class="ot">zero-inflated beta regression</span><span class="co">](https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/#4-zero-inflated-beta-regression-bayesian-style)</span>, we have to specify two different processes when dealing with hurdle models: (1) the main outcome and (2) the binary hurdle process, or <span class="in">`hu`</span>.</span>
<span id="cb75-407"><a href="#cb75-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-408"><a href="#cb75-408" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Intercept-only hurdle model</span></span>
<span id="cb75-409"><a href="#cb75-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-410"><a href="#cb75-410" aria-hidden="true" tabindex="-1"></a>To help with the intuition, we'll first run a model where we don't actually define a real model for <span class="in">`hu`</span>—it'll just return the intercept, which will show the proportion of GDP per capita that is zero. We'll use the <span class="in">`hurdle_lognormal()`</span> family, since, as we've already seen, our GDP per capita measure is exponentially distributed. Through the magic of the lognormal family, we don't actually need to feed the model logged GDP per capita—it handles the logging for us behind the scenes automatically.</span>
<span id="cb75-411"><a href="#cb75-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-412"><a href="#cb75-412" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-gdp-hurdle, cache=TRUE, warning=FALSE, results="hide"}</span></span>
<span id="cb75-413"><a href="#cb75-413" aria-hidden="true" tabindex="-1"></a><span class="in">model_gdp_hurdle &lt;- brm(</span></span>
<span id="cb75-414"><a href="#cb75-414" aria-hidden="true" tabindex="-1"></a><span class="in">  bf(gdpPercap ~ lifeExp,</span></span>
<span id="cb75-415"><a href="#cb75-415" aria-hidden="true" tabindex="-1"></a><span class="in">     hu ~ 1),</span></span>
<span id="cb75-416"><a href="#cb75-416" aria-hidden="true" tabindex="-1"></a><span class="in">  data = gapminder,</span></span>
<span id="cb75-417"><a href="#cb75-417" aria-hidden="true" tabindex="-1"></a><span class="in">  family = hurdle_lognormal(),</span></span>
<span id="cb75-418"><a href="#cb75-418" aria-hidden="true" tabindex="-1"></a><span class="in">  chains = CHAINS, iter = ITER, warmup = WARMUP, seed = BAYES_SEED,</span></span>
<span id="cb75-419"><a href="#cb75-419" aria-hidden="true" tabindex="-1"></a><span class="in">  silent = 2</span></span>
<span id="cb75-420"><a href="#cb75-420" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb75-421"><a href="#cb75-421" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-422"><a href="#cb75-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-423"><a href="#cb75-423" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-model-gdp-hurdle, warning=FALSE}</span></span>
<span id="cb75-424"><a href="#cb75-424" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_gdp_hurdle)</span></span>
<span id="cb75-425"><a href="#cb75-425" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-426"><a href="#cb75-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-427"><a href="#cb75-427" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-model-gdp-hurdle, include=FALSE}</span></span>
<span id="cb75-428"><a href="#cb75-428" aria-hidden="true" tabindex="-1"></a><span class="in">m_gdp_hurdle &lt;- tidy(model_gdp_hurdle) |&gt;  </span></span>
<span id="cb75-429"><a href="#cb75-429" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(term = janitor::make_clean_names(term)) |&gt; </span></span>
<span id="cb75-430"><a href="#cb75-430" aria-hidden="true" tabindex="-1"></a><span class="in">  split(~ term)</span></span>
<span id="cb75-431"><a href="#cb75-431" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-432"><a href="#cb75-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-433"><a href="#cb75-433" aria-hidden="true" tabindex="-1"></a>The results from this model are a little different now. The coefficients for the regular part of the model (<span class="in">`(Intercept)`</span> and <span class="in">`lifeExp`</span>) are nearly identical to the zero-free model we made earlier (<span class="in">`model_log_gdp_no_zeros`</span>), and we can interpret them just like we did before: a one-year increase in life expectancy is associated with a <span class="in">`r label_percent(accuracy = 0.1)(m_gdp_hurdle$life_exp$estimate)`</span> increase in GDP per capita, on average.</span>
<span id="cb75-434"><a href="#cb75-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-435"><a href="#cb75-435" aria-hidden="true" tabindex="-1"></a>We also have a coefficient with a <span class="in">`hu_`</span> prefix: <span class="in">`hu_(Intercept)`</span>. This is the intercept for the logistic regression model used for the hurdle (0/not 0) process, and it's measured on the logit scale. That means we can back-transform it to proportions or probabilities with <span class="in">`plogis()`</span>:</span>
<span id="cb75-436"><a href="#cb75-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-437"><a href="#cb75-437" aria-hidden="true" tabindex="-1"></a><span class="in">```{r transform-intercept, warning=FALSE}</span></span>
<span id="cb75-438"><a href="#cb75-438" aria-hidden="true" tabindex="-1"></a><span class="in">hu_intercept &lt;- tidy(model_gdp_hurdle) |&gt; </span></span>
<span id="cb75-439"><a href="#cb75-439" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(term == "hu_(Intercept)") |&gt; </span></span>
<span id="cb75-440"><a href="#cb75-440" aria-hidden="true" tabindex="-1"></a><span class="in">  pull(estimate)</span></span>
<span id="cb75-441"><a href="#cb75-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-442"><a href="#cb75-442" aria-hidden="true" tabindex="-1"></a><span class="in"># Logit scale intercept</span></span>
<span id="cb75-443"><a href="#cb75-443" aria-hidden="true" tabindex="-1"></a><span class="in">hu_intercept</span></span>
<span id="cb75-444"><a href="#cb75-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-445"><a href="#cb75-445" aria-hidden="true" tabindex="-1"></a><span class="in"># Transformed to a probability/proportion</span></span>
<span id="cb75-446"><a href="#cb75-446" aria-hidden="true" tabindex="-1"></a><span class="in">plogis(hu_intercept)</span></span>
<span id="cb75-447"><a href="#cb75-447" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-448"><a href="#cb75-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-449"><a href="#cb75-449" aria-hidden="true" tabindex="-1"></a>Since the hurdle part of the model includes only the intercept, this value represents the proportion of zeros in the data, or <span class="in">`r label_percent(accuracy = 0.1)(plogis(hu_intercept))`</span>. We can confirm with some **dplyr** magic:</span>
<span id="cb75-450"><a href="#cb75-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-451"><a href="#cb75-451" aria-hidden="true" tabindex="-1"></a><span class="in">```{r gapminder-count-zeros}</span></span>
<span id="cb75-452"><a href="#cb75-452" aria-hidden="true" tabindex="-1"></a><span class="in">gapminder |&gt; </span></span>
<span id="cb75-453"><a href="#cb75-453" aria-hidden="true" tabindex="-1"></a><span class="in">  count(is_zero) |&gt; </span></span>
<span id="cb75-454"><a href="#cb75-454" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(prop = n / sum(n))</span></span>
<span id="cb75-455"><a href="#cb75-455" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-456"><a href="#cb75-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-457"><a href="#cb75-457" aria-hidden="true" tabindex="-1"></a>They're the same!</span>
<span id="cb75-458"><a href="#cb75-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-459"><a href="#cb75-459" aria-hidden="true" tabindex="-1"></a>The coefficients for the non-zero part of the model are basically the same as what we found with <span class="in">`model_log_gdp_no_zeros`</span>, so why go through the hassle of creating a mixture model with the zero-process? Why not just filter out the zeros?</span>
<span id="cb75-460"><a href="#cb75-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-461"><a href="#cb75-461" aria-hidden="true" tabindex="-1"></a>Because we combined the two processes in the same model, both processes are incorporated in the posterior distribution of GDP per capita. We can confirm this with a posterior predictive check. In the plot on the left, we can see that the model fits the exponential distribution of the data pretty well. It fits the zeros too, but we can't actually see that part because of how small the plot is. To highlight the zero process, in the plot on the right we log the predicted values. Look how well those &lt;span style="color:`r clrs[2]`;"&gt;■<span class="dv">&amp;nbsp;</span>orange&lt;/span&gt; posterior draws fit the actual &lt;span style="color:`r clrs[4]`;"&gt;■<span class="dv">&amp;nbsp;</span>blue&lt;/span&gt; data!</span>
<span id="cb75-462"><a href="#cb75-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-463"><a href="#cb75-463" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-pp-model-gdp-hurdle-fake, eval=FALSE}</span></span>
<span id="cb75-464"><a href="#cb75-464" aria-hidden="true" tabindex="-1"></a><span class="in"># Exponential</span></span>
<span id="cb75-465"><a href="#cb75-465" aria-hidden="true" tabindex="-1"></a><span class="in">pp_check(model_gdp_hurdle)</span></span>
<span id="cb75-466"><a href="#cb75-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-467"><a href="#cb75-467" aria-hidden="true" tabindex="-1"></a><span class="in"># Logged</span></span>
<span id="cb75-468"><a href="#cb75-468" aria-hidden="true" tabindex="-1"></a><span class="in">pred &lt;- posterior_predict(model_gdp_hurdle)</span></span>
<span id="cb75-469"><a href="#cb75-469" aria-hidden="true" tabindex="-1"></a><span class="in">bayesplot::ppc_dens_overlay(y = log1p(gapminder$gdpPercap), </span></span>
<span id="cb75-470"><a href="#cb75-470" aria-hidden="true" tabindex="-1"></a><span class="in">                            yrep = log1p(pred[1:10,]))</span></span>
<span id="cb75-471"><a href="#cb75-471" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-472"><a href="#cb75-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-473"><a href="#cb75-473" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-pp-model-gdp-hurdle, fig.width=8, fig.height=3.5, message=FALSE, warning=FALSE, echo=FALSE}</span></span>
<span id="cb75-474"><a href="#cb75-474" aria-hidden="true" tabindex="-1"></a><span class="in"># Exponential</span></span>
<span id="cb75-475"><a href="#cb75-475" aria-hidden="true" tabindex="-1"></a><span class="in">plot_pp_gdp1 &lt;- pp_check(model_gdp_hurdle) +</span></span>
<span id="cb75-476"><a href="#cb75-476" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_dollar(scale_cut = cut_short_scale())) +</span></span>
<span id="cb75-477"><a href="#cb75-477" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(subtitle = "GDP per capita (original values)") +</span></span>
<span id="cb75-478"><a href="#cb75-478" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice()</span></span>
<span id="cb75-479"><a href="#cb75-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-480"><a href="#cb75-480" aria-hidden="true" tabindex="-1"></a><span class="in"># Logged</span></span>
<span id="cb75-481"><a href="#cb75-481" aria-hidden="true" tabindex="-1"></a><span class="in">pred &lt;- posterior_predict(model_gdp_hurdle)</span></span>
<span id="cb75-482"><a href="#cb75-482" aria-hidden="true" tabindex="-1"></a><span class="in">plot_pp_gdp2 &lt;- bayesplot::ppc_dens_overlay(y = log1p(gapminder$gdpPercap), </span></span>
<span id="cb75-483"><a href="#cb75-483" aria-hidden="true" tabindex="-1"></a><span class="in">                                            yrep = log1p(pred[1:10,])) +</span></span>
<span id="cb75-484"><a href="#cb75-484" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_math(e^.x)) +</span></span>
<span id="cb75-485"><a href="#cb75-485" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(subtitle = "GDP per capita (logged values)") +</span></span>
<span id="cb75-486"><a href="#cb75-486" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice()</span></span>
<span id="cb75-487"><a href="#cb75-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-488"><a href="#cb75-488" aria-hidden="true" tabindex="-1"></a><span class="in">(plot_pp_gdp1 | plot_pp_gdp2) +</span></span>
<span id="cb75-489"><a href="#cb75-489" aria-hidden="true" tabindex="-1"></a><span class="in">  plot_layout(guides = "collect") +</span></span>
<span id="cb75-490"><a href="#cb75-490" aria-hidden="true" tabindex="-1"></a><span class="in">  plot_annotation(title = "Posterior predictive checks for hurdle model",</span></span>
<span id="cb75-491"><a href="#cb75-491" aria-hidden="true" tabindex="-1"></a><span class="in">                  theme = theme(plot.title = element_text(family = "Jost", face = "bold")))</span></span>
<span id="cb75-492"><a href="#cb75-492" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-493"><a href="#cb75-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-494"><a href="#cb75-494" aria-hidden="true" tabindex="-1"></a>Additionally, when we make predictions, most of the predicted values will be some big number, but about 10% of them will be 0, corresponding to the modeled proportion of zeros. Any predictions we make using the posterior from the model should inherently reflect the zero process. If we make a histogram of predicted draws from the model, we'll see around 10% of the predictions are 0, as expected:</span>
<span id="cb75-495"><a href="#cb75-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-496"><a href="#cb75-496" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-predicted-gdp-hurdle, fig.height=3.5}</span></span>
<span id="cb75-497"><a href="#cb75-497" aria-hidden="true" tabindex="-1"></a><span class="in">pred_gdp_hurdle &lt;- model_gdp_hurdle |&gt; </span></span>
<span id="cb75-498"><a href="#cb75-498" aria-hidden="true" tabindex="-1"></a><span class="in">  predicted_draws(newdata = tibble(lifeExp = 60)) |&gt;</span></span>
<span id="cb75-499"><a href="#cb75-499" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(is_zero = .prediction == 0,</span></span>
<span id="cb75-500"><a href="#cb75-500" aria-hidden="true" tabindex="-1"></a><span class="in">         .prediction = ifelse(is_zero, .prediction - 0.1, .prediction))</span></span>
<span id="cb75-501"><a href="#cb75-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-502"><a href="#cb75-502" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(pred_gdp_hurdle, aes(x = .prediction)) +</span></span>
<span id="cb75-503"><a href="#cb75-503" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_histogram(aes(fill = is_zero), binwidth = 2500, </span></span>
<span id="cb75-504"><a href="#cb75-504" aria-hidden="true" tabindex="-1"></a><span class="in">                 boundary = 0, color = "white") +</span></span>
<span id="cb75-505"><a href="#cb75-505" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0) + </span></span>
<span id="cb75-506"><a href="#cb75-506" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_dollar(scale_cut = cut_short_scale())) +</span></span>
<span id="cb75-507"><a href="#cb75-507" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_manual(values = c(clrs[4], clrs[1]), </span></span>
<span id="cb75-508"><a href="#cb75-508" aria-hidden="true" tabindex="-1"></a><span class="in">                    guide = guide_legend(reverse = TRUE)) +</span></span>
<span id="cb75-509"><a href="#cb75-509" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "GDP per capita", y = "Count", fill = "Is zero?",</span></span>
<span id="cb75-510"><a href="#cb75-510" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "Predicted GDP per capita from hurdle model") +</span></span>
<span id="cb75-511"><a href="#cb75-511" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(xlim = c(-2500, 75000)) +</span></span>
<span id="cb75-512"><a href="#cb75-512" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice() +</span></span>
<span id="cb75-513"><a href="#cb75-513" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = "bottom")</span></span>
<span id="cb75-514"><a href="#cb75-514" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-515"><a href="#cb75-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-516"><a href="#cb75-516" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Hurdle model with additional terms</span></span>
<span id="cb75-517"><a href="#cb75-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-518"><a href="#cb75-518" aria-hidden="true" tabindex="-1"></a>Right now, all we've modeled is the overall proportion of 0s. We haven't modeled what determines those zeros. Fortunately in this case we know what that process is—we made it so that rows with a life expectancy of less than 50 had a 30% chance of being zero, while rows with a life expectancy of greater than 50 had a 2% chance of being zero. Life expectancy should thus strongly predict the 0/not 0 process. Let's include it in the <span class="in">`hu`</span> part of the model:</span>
<span id="cb75-519"><a href="#cb75-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-520"><a href="#cb75-520" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-gdp-hurdle-life, cache=TRUE, warning=FALSE, results="hide"}</span></span>
<span id="cb75-521"><a href="#cb75-521" aria-hidden="true" tabindex="-1"></a><span class="in">model_gdp_hurdle_life &lt;- brm(</span></span>
<span id="cb75-522"><a href="#cb75-522" aria-hidden="true" tabindex="-1"></a><span class="in">  bf(gdpPercap ~ lifeExp,</span></span>
<span id="cb75-523"><a href="#cb75-523" aria-hidden="true" tabindex="-1"></a><span class="in">     hu ~ lifeExp),</span></span>
<span id="cb75-524"><a href="#cb75-524" aria-hidden="true" tabindex="-1"></a><span class="in">  data = gapminder,</span></span>
<span id="cb75-525"><a href="#cb75-525" aria-hidden="true" tabindex="-1"></a><span class="in">  family = hurdle_lognormal(),</span></span>
<span id="cb75-526"><a href="#cb75-526" aria-hidden="true" tabindex="-1"></a><span class="in">  chains = CHAINS, iter = ITER, warmup = WARMUP, seed = BAYES_SEED,</span></span>
<span id="cb75-527"><a href="#cb75-527" aria-hidden="true" tabindex="-1"></a><span class="in">  silent = 2</span></span>
<span id="cb75-528"><a href="#cb75-528" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb75-529"><a href="#cb75-529" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-530"><a href="#cb75-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-531"><a href="#cb75-531" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-model-gdp-hurdle-life, warning=FALSE}</span></span>
<span id="cb75-532"><a href="#cb75-532" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_gdp_hurdle_life)</span></span>
<span id="cb75-533"><a href="#cb75-533" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-534"><a href="#cb75-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-535"><a href="#cb75-535" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-model-gdp-hurdle-life, include=FALSE}</span></span>
<span id="cb75-536"><a href="#cb75-536" aria-hidden="true" tabindex="-1"></a><span class="in">m_gdp_hurdle_life &lt;- tidy(model_gdp_hurdle_life) |&gt;  </span></span>
<span id="cb75-537"><a href="#cb75-537" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(term = janitor::make_clean_names(term)) |&gt; </span></span>
<span id="cb75-538"><a href="#cb75-538" aria-hidden="true" tabindex="-1"></a><span class="in">  split(~ term)</span></span>
<span id="cb75-539"><a href="#cb75-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-540"><a href="#cb75-540" aria-hidden="true" tabindex="-1"></a><span class="in">m_gdp_hurdle_life</span></span>
<span id="cb75-541"><a href="#cb75-541" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-542"><a href="#cb75-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-543"><a href="#cb75-543" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Extracting and interpreting coefficients from a hurdle model</span></span>
<span id="cb75-544"><a href="#cb75-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-545"><a href="#cb75-545" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb75-546"><a href="#cb75-546" aria-hidden="true" tabindex="-1"></a><span class="fu">### More on average marginal effects</span></span>
<span id="cb75-547"><a href="#cb75-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-548"><a href="#cb75-548" aria-hidden="true" tabindex="-1"></a>After writing this guide, <span class="co">[</span><span class="ot">I wrote another detailed guide about the exact differences between average marginal effects, marginal effects at the mean, and a bunch of other marginal-related things</span><span class="co">](https://www.andrewheiss.com/blog/2022/05/20/marginalia/)</span>, comparing **emmeans** with **marginaleffects**, two packages that take different approaches to calculating marginal effects from regression models. In the rest of this guide, I'm pretty inexact about the nuances between marginal effects and the output of <span class="in">`emtrends()`</span>, which technically returns marginal effects at the mean and *not* average marginal effects. So keep that caveat in mind throughout. </span>
<span id="cb75-549"><a href="#cb75-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-550"><a href="#cb75-550" aria-hidden="true" tabindex="-1"></a>You can extract non-hurdled effects, hurdled effects, and expected values from these models using either **emmeans** or **marginaleffects**. I use **emmeans** throughout the rest of this guide; [see this vignette for an example](https://vincentarelbundock.github.io/marginaleffects/articles/transformation.html#back-transforming-lognormal-hurdle-models) with **marginaleffects**.</span>
<span id="cb75-551"><a href="#cb75-551" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb75-552"><a href="#cb75-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-553"><a href="#cb75-553" aria-hidden="true" tabindex="-1"></a>In this model, the non-hurdled coefficients are the same as before—a one-year increase in life expectancy is still associated with a <span class="in">`r label_percent(accuracy = 0.1)(m_gdp_hurdle_life$life_exp$estimate)`</span> increase in GDP per capita, on average. But now we have a new term, <span class="in">`hu_lifeExp`</span>, which shows the effect of life expectancy in the hurdling process. Since this is on the logit scale, we can combine it with the hurdle intercept and transform the coefficient into percentage points (see <span class="co">[</span><span class="ot">Steven Miller's lab script here</span><span class="co">](http://post8000.svmiller.com/lab-scripts/logistic-regression-lab.html)</span> for more on this process, or <span class="co">[</span><span class="ot">this section on fractional logistic regression</span><span class="co">](https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/#2-fractional-logistic-regression)</span>):</span>
<span id="cb75-554"><a href="#cb75-554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-555"><a href="#cb75-555" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-hurdle-logits, warning=FALSE}</span></span>
<span id="cb75-556"><a href="#cb75-556" aria-hidden="true" tabindex="-1"></a><span class="in">hurdle_intercept &lt;- tidy(model_gdp_hurdle_life) |&gt; </span></span>
<span id="cb75-557"><a href="#cb75-557" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(term == "hu_(Intercept)") |&gt; </span></span>
<span id="cb75-558"><a href="#cb75-558" aria-hidden="true" tabindex="-1"></a><span class="in">  pull(estimate)</span></span>
<span id="cb75-559"><a href="#cb75-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-560"><a href="#cb75-560" aria-hidden="true" tabindex="-1"></a><span class="in">hurdle_lifeexp &lt;- tidy(model_gdp_hurdle_life) |&gt; </span></span>
<span id="cb75-561"><a href="#cb75-561" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(term == "hu_lifeExp") |&gt; </span></span>
<span id="cb75-562"><a href="#cb75-562" aria-hidden="true" tabindex="-1"></a><span class="in">  pull(estimate)</span></span>
<span id="cb75-563"><a href="#cb75-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-564"><a href="#cb75-564" aria-hidden="true" tabindex="-1"></a><span class="in">plogis(hurdle_intercept + hurdle_lifeexp) - plogis(hurdle_intercept)</span></span>
<span id="cb75-565"><a href="#cb75-565" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-566"><a href="#cb75-566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-567"><a href="#cb75-567" aria-hidden="true" tabindex="-1"></a>A one-year increase in life expectancy thus *decreases* the probability of seeing a 0 in GDP per capita by <span class="in">`r abs(round((plogis(hurdle_intercept + hurdle_lifeexp) - plogis(hurdle_intercept)) * 100, 2))`</span> percentage points, on average. That's neat!</span>
<span id="cb75-568"><a href="#cb75-568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-569"><a href="#cb75-569" aria-hidden="true" tabindex="-1"></a>Doing the complicated <span class="in">`plogis(intercept + coefficient) - plogis(intercept)`</span> to convert logit-scale marginal effects and logit-scale predicted values as percentage points is tricky, though, especially once more coefficients are involved. It's easy to mess up that math.</span>
<span id="cb75-570"><a href="#cb75-570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-571"><a href="#cb75-571" aria-hidden="true" tabindex="-1"></a>Instead, we can calculate marginal effects automatically using a couple different methods:</span>
<span id="cb75-572"><a href="#cb75-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-573"><a href="#cb75-573" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**brms**'s <span class="in">`conditonal_effects()`</span> will plot predicted values of specific coefficients while holding all other variables constant, and it converts the results to their original scales. It automatically creates a plot, which is nice, but extracting the data out of the object is a little tricky and convoluted.</span>
<span id="cb75-574"><a href="#cb75-574" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Packages like **emmeans** or **marginaleffects** can calculate marginal effects and predicted values on their original scales too. For more details, [see my blog post on beta regression](https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/#2-fractional-logistic-regression), or the documentation for **emmeans** or **marginaleffects**. Also see <span class="co">[</span><span class="ot">this mega detailed guide here</span><span class="co">](https://www.andrewheiss.com/blog/2022/05/20/marginalia/)</span> for more about marginal effects.</span>
<span id="cb75-575"><a href="#cb75-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-576"><a href="#cb75-576" aria-hidden="true" tabindex="-1"></a><span class="fu">#### `brms::conditional_effects()` with hurdle models</span></span>
<span id="cb75-577"><a href="#cb75-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-578"><a href="#cb75-578" aria-hidden="true" tabindex="-1"></a>Since we're working with a mixture model, the syntax for dealing with conditional/marginal effects is a little different, as the <span class="in">`lifeExp`</span> variable exists in both the non-zero and the zero processes of the model. We can specify which version of <span class="in">`lifeExp`</span> we want to work with using the <span class="in">`dpar`</span> argument (**d**istributional **par**ameter) in <span class="in">`conditional_effects()`</span>. By default, <span class="in">`conditional_effects()`</span> will return the marginal/conditional means of the combined process using both the non-zero part <span class="in">`mu`</span> and the zero part <span class="in">`hu`</span>. If we want to see the 0/not 0 hurdle part, we can specify <span class="in">`dpar = "hu`</span>". The <span class="in">`conditional_effects()`</span> function helpfully converts the predicted values into their original scales: when showing predicted life expectancy, it unlogs the values; when showing predicted proportion of zeros, it unlogits the values.</span>
<span id="cb75-579"><a href="#cb75-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-580"><a href="#cb75-580" aria-hidden="true" tabindex="-1"></a>We can see both processes of the model simultaneously—at low levels of life expectancy, the probability of reporting no GDP per capita is fairly high, and the predicted level of GDP per capita is really low. As life expectancy increases, the probability of seeing a 0 drops and predicted wealth increases.</span>
<span id="cb75-581"><a href="#cb75-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-582"><a href="#cb75-582" aria-hidden="true" tabindex="-1"></a>(Note that these plots look fancier than what you normally get when just running <span class="in">`conditional_effects(model_name)`</span> in R. That's because I extracted the plot data and built my own graph for this post. You can see the code for that at the <span class="co">[</span><span class="ot">source Rmd for this post</span><span class="co">](https://github.com/andrewheiss/ath-hugo/blob/main/content/blog/2022-05-09_hurdle-lognormal-gaussian-brms/index.Rmarkdown)</span>.)</span>
<span id="cb75-583"><a href="#cb75-583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-584"><a href="#cb75-584" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-conditional-gdp-life-fake, eval=FALSE}</span></span>
<span id="cb75-585"><a href="#cb75-585" aria-hidden="true" tabindex="-1"></a><span class="in">conditional_effects(model_gdp_hurdle_life)</span></span>
<span id="cb75-586"><a href="#cb75-586" aria-hidden="true" tabindex="-1"></a><span class="in">conditional_effects(model_gdp_hurdle_life, dpar = "hu")</span></span>
<span id="cb75-587"><a href="#cb75-587" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-588"><a href="#cb75-588" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-589"><a href="#cb75-589" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-conditional-gdp-life, fig.width=6, fig.height=6, echo=FALSE, warning=FALSE}</span></span>
<span id="cb75-590"><a href="#cb75-590" aria-hidden="true" tabindex="-1"></a><span class="in">plot_cond_gdp1 &lt;- plot(conditional_effects(model_gdp_hurdle_life), plot = FALSE)[[1]]$data |&gt; </span></span>
<span id="cb75-591"><a href="#cb75-591" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = effect1__, y = estimate__)) +</span></span>
<span id="cb75-592"><a href="#cb75-592" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_ribbon(aes(ymin = lower__, ymax = upper__), alpha = 0.3, color = NA) +</span></span>
<span id="cb75-593"><a href="#cb75-593" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(size = 1, color = clrs[1]) +</span></span>
<span id="cb75-594"><a href="#cb75-594" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_y_continuous(labels = label_dollar(scale_cut = cut_short_scale())) +</span></span>
<span id="cb75-595"><a href="#cb75-595" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Life expectancy", y = "Predicted GDP per capita",</span></span>
<span id="cb75-596"><a href="#cb75-596" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "Combined parts of the model (\"mu\" and \"hu\")") +</span></span>
<span id="cb75-597"><a href="#cb75-597" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice()</span></span>
<span id="cb75-598"><a href="#cb75-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-599"><a href="#cb75-599" aria-hidden="true" tabindex="-1"></a><span class="in">plot_cond_gdp2 &lt;- plot(conditional_effects(model_gdp_hurdle_life, dpar = "hu"), plot = FALSE)[[1]]$data |&gt; </span></span>
<span id="cb75-600"><a href="#cb75-600" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = effect1__, y = estimate__)) +</span></span>
<span id="cb75-601"><a href="#cb75-601" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_ribbon(aes(ymin = lower__, ymax = upper__), alpha = 0.3, color = NA) +</span></span>
<span id="cb75-602"><a href="#cb75-602" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(size = 1, color = clrs[5]) +</span></span>
<span id="cb75-603"><a href="#cb75-603" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_y_continuous(labels = label_percent()) +</span></span>
<span id="cb75-604"><a href="#cb75-604" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Life expectancy", y = "Predicted probability\nof seeing $0 GDP per capita",</span></span>
<span id="cb75-605"><a href="#cb75-605" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "Hurdle part of the model (dpar = \"hu\")") +</span></span>
<span id="cb75-606"><a href="#cb75-606" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice()</span></span>
<span id="cb75-607"><a href="#cb75-607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-608"><a href="#cb75-608" aria-hidden="true" tabindex="-1"></a><span class="in">(plot_cond_gdp1 / plot_cond_gdp2) +</span></span>
<span id="cb75-609"><a href="#cb75-609" aria-hidden="true" tabindex="-1"></a><span class="in">  plot_annotation(title = "Conditional effect of life expectancy on GDP per capita",</span></span>
<span id="cb75-610"><a href="#cb75-610" aria-hidden="true" tabindex="-1"></a><span class="in">                  subtitle = "Made with conditional_effects()",</span></span>
<span id="cb75-611"><a href="#cb75-611" aria-hidden="true" tabindex="-1"></a><span class="in">                  theme = theme(plot.title = element_text(family = "Jost", face = "bold"),</span></span>
<span id="cb75-612"><a href="#cb75-612" aria-hidden="true" tabindex="-1"></a><span class="in">                                plot.subtitle = element_text(family = "Jost")))</span></span>
<span id="cb75-613"><a href="#cb75-613" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-614"><a href="#cb75-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-615"><a href="#cb75-615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-616"><a href="#cb75-616" aria-hidden="true" tabindex="-1"></a><span class="fu">#### **emmeans** with hurdle models</span></span>
<span id="cb75-617"><a href="#cb75-617" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-618"><a href="#cb75-618" aria-hidden="true" tabindex="-1"></a>While <span class="in">`conditional_effects()`</span> is great for a quick marginal effects plot like this, we can't see just the <span class="in">`mu`</span> part of the model in isolation. More importantly, plots alone don't help with determining the exact slope of the line at each point on the original scale. We know from the model results that a one-year increase in life expectancy is associated with a <span class="in">`r label_percent(accuracy = 0.1)(m_gdp_hurdle_life$life_exp$estimate)`</span> increase in GDP per capita, and that's apparent in the curviness of the conditional effects plot. But if we want to know the original-scale slope at 60 years, for instance (e.g. an increase in life expectancy from 60 to 61 years is associated with a \$X increase in GDP per capita), that's trickier. It's even trickier when working with the hurdle part of the model. Moving from 60 to 61 years decreases the probability of seeing a 0 by… some percentage point amount… but without doing a bunch of <span class="in">`plogis()`</span> math, it's not obvious how to get that value. Fortunately <span class="in">`emmeans::emtrends()`</span> makes this easy. Like <span class="in">`brms::conditional_effects()`</span>, by default, functions from **emmeans** like <span class="in">`emmeans()`</span> and <span class="in">`emtrends()`</span> will return the marginal means of the combined non-zero and zero/not-zero process, or both <span class="in">`mu`</span> and <span class="in">`hu`</span>. We can specify <span class="in">`dpar = "mu"`</span> to get just the <span class="in">`mu`</span> part (both logged and unlogged) and <span class="in">`dpar = "hu"`</span> to get the logit part (both as logits and probabilities).</span>
<span id="cb75-619"><a href="#cb75-619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-620"><a href="#cb75-620" aria-hidden="true" tabindex="-1"></a><span class="fu">##### Non-zero `mu` part only</span></span>
<span id="cb75-621"><a href="#cb75-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-622"><a href="#cb75-622" aria-hidden="true" tabindex="-1"></a>We can feed the model a bunch of possible different life expectancy values to see how steep the slope of the non-zero part is at each value. Because there are no interaction terms or random effects or anything fancy, this log-scale slope will be the same at every possible value of life expectancy—GDP per capita increases by <span class="in">`r label_percent(accuracy = 0.1)(m_gdp_hurdle_life$life_exp$estimate)`</span> for each one-year increase in life expectancy.</span>
<span id="cb75-623"><a href="#cb75-623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-624"><a href="#cb75-624" aria-hidden="true" tabindex="-1"></a><span class="in">```{r emtrends-gdp-mu-range, message=FALSE}</span></span>
<span id="cb75-625"><a href="#cb75-625" aria-hidden="true" tabindex="-1"></a><span class="in">model_gdp_hurdle_life |&gt; </span></span>
<span id="cb75-626"><a href="#cb75-626" aria-hidden="true" tabindex="-1"></a><span class="in">  emtrends(~ lifeExp, var = "lifeExp", dpar = "mu",</span></span>
<span id="cb75-627"><a href="#cb75-627" aria-hidden="true" tabindex="-1"></a><span class="in">           at = list(lifeExp = seq(30, 80, 10)))</span></span>
<span id="cb75-628"><a href="#cb75-628" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-629"><a href="#cb75-629" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-630"><a href="#cb75-630" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-emtrends-gdp-mu-range, include=FALSE}</span></span>
<span id="cb75-631"><a href="#cb75-631" aria-hidden="true" tabindex="-1"></a><span class="in">mfx_gdp_hurdle_life &lt;- model_gdp_hurdle_life |&gt; </span></span>
<span id="cb75-632"><a href="#cb75-632" aria-hidden="true" tabindex="-1"></a><span class="in">  emtrends(~ lifeExp, var = "lifeExp", dpar = "mu", </span></span>
<span id="cb75-633"><a href="#cb75-633" aria-hidden="true" tabindex="-1"></a><span class="in">           regrid = "response", tran = "log", type = "response",</span></span>
<span id="cb75-634"><a href="#cb75-634" aria-hidden="true" tabindex="-1"></a><span class="in">           at = list(lifeExp = seq(30, 80, 10))) |&gt; </span></span>
<span id="cb75-635"><a href="#cb75-635" aria-hidden="true" tabindex="-1"></a><span class="in">  as_tibble() |&gt; </span></span>
<span id="cb75-636"><a href="#cb75-636" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(years = xfun::numbers_to_words(lifeExp)) |&gt; </span></span>
<span id="cb75-637"><a href="#cb75-637" aria-hidden="true" tabindex="-1"></a><span class="in">  split(~ years)</span></span>
<span id="cb75-638"><a href="#cb75-638" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-639"><a href="#cb75-639" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-640"><a href="#cb75-640" aria-hidden="true" tabindex="-1"></a>If we want to interpret more concrete numbers (i.e. dollars instead of percents), we should back-transform these slopes to the original dollar scale. This is a little tricky, though, because GDP per capita was logged before going into the model. If we try including <span class="in">`regrid = "response"`</span> to have <span class="in">`emtrends()`</span> back-transform the result, it won't change anything: </span>
<span id="cb75-641"><a href="#cb75-641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-642"><a href="#cb75-642" aria-hidden="true" tabindex="-1"></a><span class="in">```{r emtrends-gdp-mu-range-response-not-work}</span></span>
<span id="cb75-643"><a href="#cb75-643" aria-hidden="true" tabindex="-1"></a><span class="in">model_gdp_hurdle_life |&gt; </span></span>
<span id="cb75-644"><a href="#cb75-644" aria-hidden="true" tabindex="-1"></a><span class="in">  emtrends(~ lifeExp, var = "lifeExp", dpar = "mu", regrid = "response",</span></span>
<span id="cb75-645"><a href="#cb75-645" aria-hidden="true" tabindex="-1"></a><span class="in">           at = list(lifeExp = seq(30, 80, 10)))</span></span>
<span id="cb75-646"><a href="#cb75-646" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-647"><a href="#cb75-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-648"><a href="#cb75-648" aria-hidden="true" tabindex="-1"></a>Behind the scenes, <span class="in">`emtrends()`</span> calculates the numeric derivative (or instantaneous slope) by adding a tiny amount to each of the given levels of <span class="in">`lifeExp`</span> (i.e. <span class="in">`lifeExp = 30`</span> and <span class="in">`lifeExp = 30.001`</span>) and then calculates the slope of the line that goes through each of those predicted points. In order to back-transform the slopes, we need to transform the predicted values *before* calculating the instantaneous slopes. To get this ordering right, we need to include a couple extra arguments: `tran = "log"` to trick `emtrends()` into thinking that it's working with logged values and `type = "response"` to tell `emtrends()` to unlog the estimates after calculating the slopes. (This only works with the development version of **brms** installed on or after May 31, 2022; ***huge*** thanks to [Mattan Ben-Shachar](https://sites.google.com/view/mattansb) for [originally pointing this out](https://github.com/andrewheiss/ath-hugo/commit/70197c7389c87b46db6cd61fc1ef8ce7b5c94616#commitcomment-74350632) and for [opening an issue and getting it fixed](https://github.com/paul-buerkner/brms/issues/1360) at both **brms** and **emmeans**!)</span>
<span id="cb75-649"><a href="#cb75-649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-650"><a href="#cb75-650" aria-hidden="true" tabindex="-1"></a><span class="in">```{r emtrends-gdp-mu-range-response}</span></span>
<span id="cb75-651"><a href="#cb75-651" aria-hidden="true" tabindex="-1"></a><span class="in">model_gdp_hurdle_life |&gt; </span></span>
<span id="cb75-652"><a href="#cb75-652" aria-hidden="true" tabindex="-1"></a><span class="in">  emtrends(~ lifeExp, var = "lifeExp", dpar = "mu", </span></span>
<span id="cb75-653"><a href="#cb75-653" aria-hidden="true" tabindex="-1"></a><span class="in">           regrid = "response", tran = "log", type = "response",</span></span>
<span id="cb75-654"><a href="#cb75-654" aria-hidden="true" tabindex="-1"></a><span class="in">           at = list(lifeExp = seq(30, 80, 10)))</span></span>
<span id="cb75-655"><a href="#cb75-655" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-656"><a href="#cb75-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-657"><a href="#cb75-657" aria-hidden="true" tabindex="-1"></a>Notice how they're no longer the same at each level—that's because in the non-logged world, this trend is curved. These represent the instantaneous slopes at each of these values of life expectancy in just the <span class="in">`mu`</span> part of the model. At 60 years, a one-year increase in life expectancy is associated with a <span class="in">`r dollar_format(prefix = "\\\\$", accuracy = 1)(mfx_gdp_hurdle_life$sixty$lifeExp.trend)`</span> increase in GDP per capita; at 70, it's associated with a <span class="in">`r dollar_format(prefix = "\\\\$", accuracy = 1)(mfx_gdp_hurdle_life$seventy$lifeExp.trend)`</span> increase. </span>
<span id="cb75-658"><a href="#cb75-658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-659"><a href="#cb75-659" aria-hidden="true" tabindex="-1"></a>Alternatively, we can use the **marginaleffects** package to get the instantaneous `mu`-part slopes as well. Here we just need to tell it to exponentiate the predicted values for each level of life expectancy before calculating the numeric derivative using the `transform_pre = "expdydx"` argument. (This also only works with the development version of **marginaleffects** installed on or after May 31, 2022.)</span>
<span id="cb75-660"><a href="#cb75-660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-661"><a href="#cb75-661" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mfx-mu-only, warning=FALSE, message=FALSE}</span></span>
<span id="cb75-662"><a href="#cb75-662" aria-hidden="true" tabindex="-1"></a><span class="in">library(marginaleffects)</span></span>
<span id="cb75-663"><a href="#cb75-663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-664"><a href="#cb75-664" aria-hidden="true" tabindex="-1"></a><span class="in">model_gdp_hurdle_life |&gt; comparisons(</span></span>
<span id="cb75-665"><a href="#cb75-665" aria-hidden="true" tabindex="-1"></a><span class="in">  newdata = datagrid(lifeExp = seq(30, 80, 10)),</span></span>
<span id="cb75-666"><a href="#cb75-666" aria-hidden="true" tabindex="-1"></a><span class="in">  dpar = "mu", </span></span>
<span id="cb75-667"><a href="#cb75-667" aria-hidden="true" tabindex="-1"></a><span class="in">  transform_pre = "expdydx"</span></span>
<span id="cb75-668"><a href="#cb75-668" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb75-669"><a href="#cb75-669" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-670"><a href="#cb75-670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-671"><a href="#cb75-671" aria-hidden="true" tabindex="-1"></a>For fun, we can plot the values of these slopes across a range of marginal effects. Importantly, the y-axis here is *not* the predicted value of GDP per capita—it's the slope of life expectancy, or the first derivative of the &lt;span style="color:`r clrs[1]`;"&gt;■<span class="dv">&amp;nbsp;</span>red&lt;/span&gt; line we made earlier with <span class="in">`conditional_effects()`</span>.</span>
<span id="cb75-672"><a href="#cb75-672" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-673"><a href="#cb75-673" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-emtrends-mfx-gdp, warning=FALSE}</span></span>
<span id="cb75-674"><a href="#cb75-674" aria-hidden="true" tabindex="-1"></a><span class="in">model_gdp_hurdle_life |&gt; </span></span>
<span id="cb75-675"><a href="#cb75-675" aria-hidden="true" tabindex="-1"></a><span class="in">  emtrends(~ lifeExp, var = "lifeExp", dpar = "mu", </span></span>
<span id="cb75-676"><a href="#cb75-676" aria-hidden="true" tabindex="-1"></a><span class="in">           regrid = "response", tran = "log", type = "response",</span></span>
<span id="cb75-677"><a href="#cb75-677" aria-hidden="true" tabindex="-1"></a><span class="in">           at = list(lifeExp = seq(30, 80, 1))) |&gt; </span></span>
<span id="cb75-678"><a href="#cb75-678" aria-hidden="true" tabindex="-1"></a><span class="in">  gather_emmeans_draws() |&gt; </span></span>
<span id="cb75-679"><a href="#cb75-679" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = lifeExp, y = .value)) +</span></span>
<span id="cb75-680"><a href="#cb75-680" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_lineribbon(size = 1, color = clrs[1]) +</span></span>
<span id="cb75-681"><a href="#cb75-681" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_manual(values = colorspace::lighten(clrs[1], c(0.95, 0.7, 0.4))) +</span></span>
<span id="cb75-682"><a href="#cb75-682" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_y_continuous(labels = label_dollar()) +</span></span>
<span id="cb75-683"><a href="#cb75-683" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Life expectancy", y = "Value of lifeExp coefficient\n(marginal effect)",</span></span>
<span id="cb75-684"><a href="#cb75-684" aria-hidden="true" tabindex="-1"></a><span class="in">       fill = "Credible interval",</span></span>
<span id="cb75-685"><a href="#cb75-685" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "Marginal effect of life expectancy on GDP per capita",</span></span>
<span id="cb75-686"><a href="#cb75-686" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "(mu part of model only)") +</span></span>
<span id="cb75-687"><a href="#cb75-687" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice() +</span></span>
<span id="cb75-688"><a href="#cb75-688" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = "bottom")</span></span>
<span id="cb75-689"><a href="#cb75-689" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-690"><a href="#cb75-690" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-691"><a href="#cb75-691" aria-hidden="true" tabindex="-1"></a><span class="fu">##### Zero `hu` part only</span></span>
<span id="cb75-692"><a href="#cb75-692" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-693"><a href="#cb75-693" aria-hidden="true" tabindex="-1"></a>We can also deal with the hurdled parts of the model if we specify <span class="in">`dpar = "hu"`</span>, like here, where we can look at the <span class="in">`hu_lifeExp`</span> coefficient at different levels of life expectancy. The slope is consistent across the whole range, but that's because it's measured in logit units:</span>
<span id="cb75-694"><a href="#cb75-694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-695"><a href="#cb75-695" aria-hidden="true" tabindex="-1"></a><span class="in">```{r emtrends-gdp-hu}</span></span>
<span id="cb75-696"><a href="#cb75-696" aria-hidden="true" tabindex="-1"></a><span class="in"># Logit-scale slopes</span></span>
<span id="cb75-697"><a href="#cb75-697" aria-hidden="true" tabindex="-1"></a><span class="in">model_gdp_hurdle_life |&gt; </span></span>
<span id="cb75-698"><a href="#cb75-698" aria-hidden="true" tabindex="-1"></a><span class="in">  emtrends(~ lifeExp, var = "lifeExp", dpar = "hu",</span></span>
<span id="cb75-699"><a href="#cb75-699" aria-hidden="true" tabindex="-1"></a><span class="in">           at = list(lifeExp = seq(30, 80, 10)))</span></span>
<span id="cb75-700"><a href="#cb75-700" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-701"><a href="#cb75-701" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-702"><a href="#cb75-702" aria-hidden="true" tabindex="-1"></a>We can convert these slopes into proportions or percentage points by including the <span class="in">`regrid = "response"`</span> argument. Note that we don't need to also include <span class="in">`tran = "log"`</span> and <span class="in">`type = "response"`</span> like we did for the <span class="in">`mu`</span> part—that's because we're not working with an outcome that's on a strange pre-logged scale like <span class="in">`gdpPercap`</span> is in the <span class="in">`mu`</span> part. Here <span class="in">`emtrends()`</span> knows that there's a difference between the link (logit) and the response (percentage point) scales and it can switch between them easily.</span>
<span id="cb75-703"><a href="#cb75-703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-704"><a href="#cb75-704" aria-hidden="true" tabindex="-1"></a><span class="in">```{r emtrends-gdp-hu-response}</span></span>
<span id="cb75-705"><a href="#cb75-705" aria-hidden="true" tabindex="-1"></a><span class="in"># Percentage-point-scale slopes</span></span>
<span id="cb75-706"><a href="#cb75-706" aria-hidden="true" tabindex="-1"></a><span class="in">model_gdp_hurdle_life |&gt; </span></span>
<span id="cb75-707"><a href="#cb75-707" aria-hidden="true" tabindex="-1"></a><span class="in">  emtrends(~ lifeExp, var = "lifeExp", dpar = "hu", regrid = "response",</span></span>
<span id="cb75-708"><a href="#cb75-708" aria-hidden="true" tabindex="-1"></a><span class="in">           at = list(lifeExp = seq(30, 80, 10)))</span></span>
<span id="cb75-709"><a href="#cb75-709" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-710"><a href="#cb75-710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-711"><a href="#cb75-711" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-emtrends-gdp-hu-response, include=FALSE}</span></span>
<span id="cb75-712"><a href="#cb75-712" aria-hidden="true" tabindex="-1"></a><span class="in">mfx_gdp_hurdle_life_hu &lt;- model_gdp_hurdle_life |&gt; </span></span>
<span id="cb75-713"><a href="#cb75-713" aria-hidden="true" tabindex="-1"></a><span class="in">  emtrends(~ lifeExp, var = "lifeExp", dpar = "hu", regrid = "response",</span></span>
<span id="cb75-714"><a href="#cb75-714" aria-hidden="true" tabindex="-1"></a><span class="in">           at = list(lifeExp = seq(30, 80, 10))) |&gt; </span></span>
<span id="cb75-715"><a href="#cb75-715" aria-hidden="true" tabindex="-1"></a><span class="in">  as_tibble() |&gt; </span></span>
<span id="cb75-716"><a href="#cb75-716" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(years = xfun::numbers_to_words(lifeExp)) |&gt; </span></span>
<span id="cb75-717"><a href="#cb75-717" aria-hidden="true" tabindex="-1"></a><span class="in">  split(~ years)</span></span>
<span id="cb75-718"><a href="#cb75-718" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-719"><a href="#cb75-719" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-720"><a href="#cb75-720" aria-hidden="true" tabindex="-1"></a>The slope of the hurdle part is fairly steep and negative at low levels of life expectancy (<span class="in">`r round(mfx_gdp_hurdle_life_hu$thirty$lifeExp.trend, 3)`</span> at 30 years), but it starts leveling out as life expectancy increases (<span class="in">`r round(mfx_gdp_hurdle_life_hu$seventy$lifeExp.trend, 3)`</span> at 70 years).</span>
<span id="cb75-721"><a href="#cb75-721" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-722"><a href="#cb75-722" aria-hidden="true" tabindex="-1"></a>Beyond <span class="in">`emtrends()`</span>, we can use <span class="in">`emmeans()`</span> to calculate predicted values of GDP per capita while holding all other variables constant. This is exactly what we did with <span class="in">`conditional_effects()`</span> earlier—this just makes it easier to deal with the actual data itself instead of extracting the data from the ggplot object that <span class="in">`conditional_effects()`</span> creates.</span>
<span id="cb75-723"><a href="#cb75-723" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-724"><a href="#cb75-724" aria-hidden="true" tabindex="-1"></a>As we did with <span class="in">`emtrends()`</span>, when dealing with the non-zero <span class="in">`mu`</span> part we have to include all three extra <span class="in">`regrid`</span>, <span class="in">`tran`</span>, and <span class="in">`type`</span> arguments to trick <span class="in">`emmeans()`</span> into working with the pre-logged GDP values:</span>
<span id="cb75-725"><a href="#cb75-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-726"><a href="#cb75-726" aria-hidden="true" tabindex="-1"></a><span class="in">```{r emmeans-gdp-mu}</span></span>
<span id="cb75-727"><a href="#cb75-727" aria-hidden="true" tabindex="-1"></a><span class="in"># Predicted GDP per capita, logged</span></span>
<span id="cb75-728"><a href="#cb75-728" aria-hidden="true" tabindex="-1"></a><span class="in">model_gdp_hurdle_life |&gt; </span></span>
<span id="cb75-729"><a href="#cb75-729" aria-hidden="true" tabindex="-1"></a><span class="in">  emmeans(~ lifeExp, var = "lifeExp", dpar = "mu",</span></span>
<span id="cb75-730"><a href="#cb75-730" aria-hidden="true" tabindex="-1"></a><span class="in">          at = list(lifeExp = seq(30, 80, 10)))</span></span>
<span id="cb75-731"><a href="#cb75-731" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-732"><a href="#cb75-732" aria-hidden="true" tabindex="-1"></a><span class="in"># Predicted GDP per capita, unlogged and back-transformed</span></span>
<span id="cb75-733"><a href="#cb75-733" aria-hidden="true" tabindex="-1"></a><span class="in">model_gdp_hurdle_life |&gt; </span></span>
<span id="cb75-734"><a href="#cb75-734" aria-hidden="true" tabindex="-1"></a><span class="in">  emmeans(~ lifeExp, var = "lifeExp", dpar = "mu",</span></span>
<span id="cb75-735"><a href="#cb75-735" aria-hidden="true" tabindex="-1"></a><span class="in">          regrid = "response", tran = "log", type = "response",</span></span>
<span id="cb75-736"><a href="#cb75-736" aria-hidden="true" tabindex="-1"></a><span class="in">          at = list(lifeExp = seq(30, 80, 10)))</span></span>
<span id="cb75-737"><a href="#cb75-737" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-738"><a href="#cb75-738" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-739"><a href="#cb75-739" aria-hidden="true" tabindex="-1"></a>When dealing with the hurdled part, we can convert the resulting logit-scale predictions to percentage points with just <span class="in">`regrid = "response"`</span>, again like we did with <span class="in">`emtrends()`</span>:</span>
<span id="cb75-740"><a href="#cb75-740" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-741"><a href="#cb75-741" aria-hidden="true" tabindex="-1"></a><span class="in">```{r emmeans-gdp-hu}</span></span>
<span id="cb75-742"><a href="#cb75-742" aria-hidden="true" tabindex="-1"></a><span class="in"># Predicted proportion of zeros, logits</span></span>
<span id="cb75-743"><a href="#cb75-743" aria-hidden="true" tabindex="-1"></a><span class="in">model_gdp_hurdle_life |&gt; </span></span>
<span id="cb75-744"><a href="#cb75-744" aria-hidden="true" tabindex="-1"></a><span class="in">  emmeans(~ lifeExp, var = "lifeExp", dpar = "hu",</span></span>
<span id="cb75-745"><a href="#cb75-745" aria-hidden="true" tabindex="-1"></a><span class="in">          at = list(lifeExp = seq(30, 80, 10)))</span></span>
<span id="cb75-746"><a href="#cb75-746" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-747"><a href="#cb75-747" aria-hidden="true" tabindex="-1"></a><span class="in"># Predicted proportion of zeros, percentage points</span></span>
<span id="cb75-748"><a href="#cb75-748" aria-hidden="true" tabindex="-1"></a><span class="in">model_gdp_hurdle_life |&gt; </span></span>
<span id="cb75-749"><a href="#cb75-749" aria-hidden="true" tabindex="-1"></a><span class="in">  emmeans(~ lifeExp, var = "lifeExp", dpar = "hu", regrid = "response",</span></span>
<span id="cb75-750"><a href="#cb75-750" aria-hidden="true" tabindex="-1"></a><span class="in">          at = list(lifeExp = seq(30, 80, 10)))</span></span>
<span id="cb75-751"><a href="#cb75-751" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-752"><a href="#cb75-752" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-753"><a href="#cb75-753" aria-hidden="true" tabindex="-1"></a>We can plot the results of <span class="in">`emmeans()`</span> and create plots like the ones we made with <span class="in">`conditional_effects()`</span>. I do this all the time in my regular research—I like being able to customize the plot fully rather than having to manipulate and readjust the pre-made <span class="in">`conditional_effects()`</span> plot.</span>
<span id="cb75-754"><a href="#cb75-754" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-755"><a href="#cb75-755" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-emmeans-mfx-gdp, fig.width=6, fig.height=6, warning=FALSE}</span></span>
<span id="cb75-756"><a href="#cb75-756" aria-hidden="true" tabindex="-1"></a><span class="in">plot_emmeans1 &lt;- model_gdp_hurdle_life |&gt; </span></span>
<span id="cb75-757"><a href="#cb75-757" aria-hidden="true" tabindex="-1"></a><span class="in">  emmeans(~ lifeExp, var = "lifeExp", dpar = "mu",</span></span>
<span id="cb75-758"><a href="#cb75-758" aria-hidden="true" tabindex="-1"></a><span class="in">          regrid = "response", tran = "log", type = "response",</span></span>
<span id="cb75-759"><a href="#cb75-759" aria-hidden="true" tabindex="-1"></a><span class="in">          at = list(lifeExp = seq(30, 80, 1))) |&gt; </span></span>
<span id="cb75-760"><a href="#cb75-760" aria-hidden="true" tabindex="-1"></a><span class="in">  gather_emmeans_draws() |&gt; </span></span>
<span id="cb75-761"><a href="#cb75-761" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(.value = exp(.value)) |&gt; </span></span>
<span id="cb75-762"><a href="#cb75-762" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = lifeExp, y = .value)) +</span></span>
<span id="cb75-763"><a href="#cb75-763" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_lineribbon(size = 1, color = clrs[1]) +</span></span>
<span id="cb75-764"><a href="#cb75-764" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_manual(values = colorspace::lighten(clrs[1], c(0.95, 0.7, 0.4))) +</span></span>
<span id="cb75-765"><a href="#cb75-765" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_y_continuous(labels = label_dollar()) +</span></span>
<span id="cb75-766"><a href="#cb75-766" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Life expectancy", y = "Predicted GDP per capita",</span></span>
<span id="cb75-767"><a href="#cb75-767" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "Regular part of the model (dpar = \"mu\")",</span></span>
<span id="cb75-768"><a href="#cb75-768" aria-hidden="true" tabindex="-1"></a><span class="in">       fill = "Credible interval") +</span></span>
<span id="cb75-769"><a href="#cb75-769" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice() +</span></span>
<span id="cb75-770"><a href="#cb75-770" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = "bottom")</span></span>
<span id="cb75-771"><a href="#cb75-771" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-772"><a href="#cb75-772" aria-hidden="true" tabindex="-1"></a><span class="in">plot_emmeans2 &lt;- model_gdp_hurdle_life |&gt; </span></span>
<span id="cb75-773"><a href="#cb75-773" aria-hidden="true" tabindex="-1"></a><span class="in">  emmeans(~ lifeExp, var = "lifeExp", dpar = "hu", regrid = "response",</span></span>
<span id="cb75-774"><a href="#cb75-774" aria-hidden="true" tabindex="-1"></a><span class="in">          at = list(lifeExp = seq(30, 80, 1))) |&gt; </span></span>
<span id="cb75-775"><a href="#cb75-775" aria-hidden="true" tabindex="-1"></a><span class="in">  gather_emmeans_draws() |&gt; </span></span>
<span id="cb75-776"><a href="#cb75-776" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = lifeExp, y = .value)) +</span></span>
<span id="cb75-777"><a href="#cb75-777" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_lineribbon(size = 1, color = clrs[5]) +</span></span>
<span id="cb75-778"><a href="#cb75-778" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_manual(values = colorspace::lighten(clrs[5], c(0.95, 0.7, 0.4))) +</span></span>
<span id="cb75-779"><a href="#cb75-779" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_y_continuous(labels = label_percent()) +</span></span>
<span id="cb75-780"><a href="#cb75-780" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Life expectancy", y = "Predicted probability\nof seeing $0 GDP per capita",</span></span>
<span id="cb75-781"><a href="#cb75-781" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "Hurdle part of the model (dpar = \"hu\")",</span></span>
<span id="cb75-782"><a href="#cb75-782" aria-hidden="true" tabindex="-1"></a><span class="in">       fill = "Credible interval") +</span></span>
<span id="cb75-783"><a href="#cb75-783" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice() +</span></span>
<span id="cb75-784"><a href="#cb75-784" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = "bottom")</span></span>
<span id="cb75-785"><a href="#cb75-785" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-786"><a href="#cb75-786" aria-hidden="true" tabindex="-1"></a><span class="in">(plot_emmeans1 / plot_emmeans2) +</span></span>
<span id="cb75-787"><a href="#cb75-787" aria-hidden="true" tabindex="-1"></a><span class="in">  plot_annotation(title = "Conditional effect of life expectancy on GDP per capita",</span></span>
<span id="cb75-788"><a href="#cb75-788" aria-hidden="true" tabindex="-1"></a><span class="in">                  subtitle = "Made with emmeans()",</span></span>
<span id="cb75-789"><a href="#cb75-789" aria-hidden="true" tabindex="-1"></a><span class="in">                  theme = theme(plot.title = element_text(family = "Jost", face = "bold"),</span></span>
<span id="cb75-790"><a href="#cb75-790" aria-hidden="true" tabindex="-1"></a><span class="in">                                plot.subtitle = element_text(family = "Jost")))</span></span>
<span id="cb75-791"><a href="#cb75-791" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-792"><a href="#cb75-792" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-793"><a href="#cb75-793" aria-hidden="true" tabindex="-1"></a><span class="fu">##### Both parts of the model simultaneously</span></span>
<span id="cb75-794"><a href="#cb75-794" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-795"><a href="#cb75-795" aria-hidden="true" tabindex="-1"></a>So far we've looked at the <span class="in">`mu`</span> and <span class="in">`hu`</span> parts individually, but part of the magic of these models is that we can work with both processes simultaneously. When we ran <span class="in">`conditional_effects(model_gdp_hurdle_life)`</span> without any <span class="in">`dpar`</span> arguments, we saw predictions for both parts at the same time, but so far with <span class="in">`emmeans()`</span> and <span class="in">`emtrends()`</span>, we haven't seen any of these combined values. To do this, we can calculate the expected value from the model and incorporate both parts simultaneously. In mathy terms, for this lognormal hurdle model, this is:</span>
<span id="cb75-796"><a href="#cb75-796" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-797"><a href="#cb75-797" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb75-798"><a href="#cb75-798" aria-hidden="true" tabindex="-1"></a>\operatorname{E}<span class="co">[</span><span class="ot">Y</span><span class="co">]</span> = (1-\texttt{hu}) \times e^{\texttt{mu} + (\texttt{sigma}^2)/2}</span>
<span id="cb75-799"><a href="#cb75-799" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb75-800"><a href="#cb75-800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-801"><a href="#cb75-801" aria-hidden="true" tabindex="-1"></a>We can calculate this with <span class="in">`emtrends()`</span> by including the <span class="in">`epred = TRUE`</span> argument (to get expected values). We don't need to transform anything to the response scale, and we don't need to define a specific part of the model (<span class="in">`dpar = "mu"`</span> or <span class="in">`dpar = "hu"`</span>), since the output will automatically be on the dollar scale:</span>
<span id="cb75-802"><a href="#cb75-802" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-803"><a href="#cb75-803" aria-hidden="true" tabindex="-1"></a><span class="in">```{r epred-gdp-emtrends}</span></span>
<span id="cb75-804"><a href="#cb75-804" aria-hidden="true" tabindex="-1"></a><span class="in"># Dollar-scale slopes, incorporating both the mu and hu parts</span></span>
<span id="cb75-805"><a href="#cb75-805" aria-hidden="true" tabindex="-1"></a><span class="in">model_gdp_hurdle_life |&gt; </span></span>
<span id="cb75-806"><a href="#cb75-806" aria-hidden="true" tabindex="-1"></a><span class="in">  emtrends(~ lifeExp, var = "lifeExp", epred = TRUE,</span></span>
<span id="cb75-807"><a href="#cb75-807" aria-hidden="true" tabindex="-1"></a><span class="in">           at = list(lifeExp = seq(30, 80, 10)))</span></span>
<span id="cb75-808"><a href="#cb75-808" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-809"><a href="#cb75-809" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-810"><a href="#cb75-810" aria-hidden="true" tabindex="-1"></a>We can also get predicted values with <span class="in">`emmeans()`</span>:</span>
<span id="cb75-811"><a href="#cb75-811" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-812"><a href="#cb75-812" aria-hidden="true" tabindex="-1"></a><span class="in">```{r epred-gdp-emmeans}</span></span>
<span id="cb75-813"><a href="#cb75-813" aria-hidden="true" tabindex="-1"></a><span class="in"># Dollar-scale predictions, incorporating both the mu and hu parts</span></span>
<span id="cb75-814"><a href="#cb75-814" aria-hidden="true" tabindex="-1"></a><span class="in">model_gdp_hurdle_life |&gt; </span></span>
<span id="cb75-815"><a href="#cb75-815" aria-hidden="true" tabindex="-1"></a><span class="in">  emmeans(~ lifeExp, epred = TRUE,</span></span>
<span id="cb75-816"><a href="#cb75-816" aria-hidden="true" tabindex="-1"></a><span class="in">          at = list(lifeExp = seq(30, 80, 10)))</span></span>
<span id="cb75-817"><a href="#cb75-817" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-818"><a href="#cb75-818" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-819"><a href="#cb75-819" aria-hidden="true" tabindex="-1"></a>And we can plot these combined predictions too. *This* is identical to <span class="in">`conditional_effects()`</span>.</span>
<span id="cb75-820"><a href="#cb75-820" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-821"><a href="#cb75-821" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-epred-gdp, warning=FALSE}</span></span>
<span id="cb75-822"><a href="#cb75-822" aria-hidden="true" tabindex="-1"></a><span class="in">model_gdp_hurdle_life |&gt; </span></span>
<span id="cb75-823"><a href="#cb75-823" aria-hidden="true" tabindex="-1"></a><span class="in">  emmeans(~ lifeExp, epred = TRUE,</span></span>
<span id="cb75-824"><a href="#cb75-824" aria-hidden="true" tabindex="-1"></a><span class="in">          at = list(lifeExp = seq(30, 80, 1))) |&gt; </span></span>
<span id="cb75-825"><a href="#cb75-825" aria-hidden="true" tabindex="-1"></a><span class="in">  gather_emmeans_draws() |&gt; </span></span>
<span id="cb75-826"><a href="#cb75-826" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = lifeExp, y = .value)) +</span></span>
<span id="cb75-827"><a href="#cb75-827" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_lineribbon(size = 1, color = clrs[4]) +</span></span>
<span id="cb75-828"><a href="#cb75-828" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_manual(values = colorspace::lighten(clrs[4], c(0.95, 0.7, 0.4))) +</span></span>
<span id="cb75-829"><a href="#cb75-829" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_y_continuous(labels = label_dollar()) +</span></span>
<span id="cb75-830"><a href="#cb75-830" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Life expectancy", y = "Predicted GDP per capita",</span></span>
<span id="cb75-831"><a href="#cb75-831" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "Predicted values incorporating both hu and mu",</span></span>
<span id="cb75-832"><a href="#cb75-832" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "epred = TRUE",</span></span>
<span id="cb75-833"><a href="#cb75-833" aria-hidden="true" tabindex="-1"></a><span class="in">       fill = "Credible interval") +</span></span>
<span id="cb75-834"><a href="#cb75-834" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice() +</span></span>
<span id="cb75-835"><a href="#cb75-835" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = "bottom")</span></span>
<span id="cb75-836"><a href="#cb75-836" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-837"><a href="#cb75-837" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-838"><a href="#cb75-838" aria-hidden="true" tabindex="-1"></a><span class="fu">##### All three types of predictions at the same time</span></span>
<span id="cb75-839"><a href="#cb75-839" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-840"><a href="#cb75-840" aria-hidden="true" tabindex="-1"></a>For fun, we can plot the combined predictions, the <span class="in">`mu`</span>-only predictions, and the <span class="in">`hu`</span>-only predictions at the same time to see how they differ:</span>
<span id="cb75-841"><a href="#cb75-841" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-842"><a href="#cb75-842" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-emmeans-mfx-gdp-all-epred-too, fig.width=6, fig.height=9, warning=FALSE}</span></span>
<span id="cb75-843"><a href="#cb75-843" aria-hidden="true" tabindex="-1"></a><span class="in">plot_emmeans0 &lt;- model_gdp_hurdle_life |&gt; </span></span>
<span id="cb75-844"><a href="#cb75-844" aria-hidden="true" tabindex="-1"></a><span class="in">  emmeans(~ lifeExp, var = "lifeExp", epred = TRUE,</span></span>
<span id="cb75-845"><a href="#cb75-845" aria-hidden="true" tabindex="-1"></a><span class="in">          at = list(lifeExp = seq(30, 80, 1))) |&gt; </span></span>
<span id="cb75-846"><a href="#cb75-846" aria-hidden="true" tabindex="-1"></a><span class="in">  gather_emmeans_draws() |&gt; </span></span>
<span id="cb75-847"><a href="#cb75-847" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = lifeExp, y = .value)) +</span></span>
<span id="cb75-848"><a href="#cb75-848" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_lineribbon(size = 1, color = clrs[4]) +</span></span>
<span id="cb75-849"><a href="#cb75-849" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_manual(values = colorspace::lighten(clrs[4], c(0.95, 0.7, 0.4))) +</span></span>
<span id="cb75-850"><a href="#cb75-850" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_y_continuous(labels = label_dollar()) +</span></span>
<span id="cb75-851"><a href="#cb75-851" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Life expectancy", y = "Predicted GDP per capita",</span></span>
<span id="cb75-852"><a href="#cb75-852" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "Expected values from mu and hu parts (epred = TRUE)",</span></span>
<span id="cb75-853"><a href="#cb75-853" aria-hidden="true" tabindex="-1"></a><span class="in">       fill = "Credible interval") +</span></span>
<span id="cb75-854"><a href="#cb75-854" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice() +</span></span>
<span id="cb75-855"><a href="#cb75-855" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = "bottom")</span></span>
<span id="cb75-856"><a href="#cb75-856" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-857"><a href="#cb75-857" aria-hidden="true" tabindex="-1"></a><span class="in">(plot_emmeans0 / plot_emmeans1 / plot_emmeans2) +</span></span>
<span id="cb75-858"><a href="#cb75-858" aria-hidden="true" tabindex="-1"></a><span class="in">  plot_annotation(title = "Conditional effect of life expectancy on GDP per capita",</span></span>
<span id="cb75-859"><a href="#cb75-859" aria-hidden="true" tabindex="-1"></a><span class="in">                  theme = theme(plot.title = element_text(family = "Jost", face = "bold"),</span></span>
<span id="cb75-860"><a href="#cb75-860" aria-hidden="true" tabindex="-1"></a><span class="in">                                plot.subtitle = element_text(family = "Jost")))</span></span>
<span id="cb75-861"><a href="#cb75-861" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-862"><a href="#cb75-862" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-863"><a href="#cb75-863" aria-hidden="true" tabindex="-1"></a>The combined expected values produce larger predictions (with \$10,000 at 70 years, for instance) than the <span class="in">`mu`</span> part alone (with \$7,500ish at 70 years). In real life, it's probably best to work with predictions that incorporate both parts of the model, since that's the whole point of doing this combined mixture model in the first place (otherwise we could just fit two separate models ourselves), but it's super neat that we can still work with the predictions and slopes for the <span class="in">`mu`</span> and <span class="in">`hu`</span> parts separately.</span>
<span id="cb75-864"><a href="#cb75-864" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-865"><a href="#cb75-865" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-866"><a href="#cb75-866" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Predictions with hurdle models</span></span>
<span id="cb75-867"><a href="#cb75-867" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-868"><a href="#cb75-868" aria-hidden="true" tabindex="-1"></a>The underlying prediction functions from **brms**—as well as other functions that wrap around them like `gather_draws()` from [**tidybayes**](https://mjskay.github.io/tidybayes/)—also incorporate the zero process. We can confirm this by predicting GDP per capita for two different values of life expectancy. There's a huge proportion of zeros for countries with low life expectancy, and overall predicted GDP per capita is really low. There's a much smaller proportion of zeros for countries with high life expectancy, and the distribution of wealth is more spread out.</span>
<span id="cb75-869"><a href="#cb75-869" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-870"><a href="#cb75-870" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-pred-gdp-life-40-70, fig.width=8, fig.height=4, out.width="100%"}</span></span>
<span id="cb75-871"><a href="#cb75-871" aria-hidden="true" tabindex="-1"></a><span class="in">pred_gdp_hurdle_life &lt;- model_gdp_hurdle_life |&gt; </span></span>
<span id="cb75-872"><a href="#cb75-872" aria-hidden="true" tabindex="-1"></a><span class="in">  predicted_draws(newdata = tibble(lifeExp = c(40, 70))) |&gt;</span></span>
<span id="cb75-873"><a href="#cb75-873" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(is_zero = .prediction == 0,</span></span>
<span id="cb75-874"><a href="#cb75-874" aria-hidden="true" tabindex="-1"></a><span class="in">         .prediction = ifelse(is_zero, .prediction - 0.1, .prediction)) |&gt; </span></span>
<span id="cb75-875"><a href="#cb75-875" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(nice_life = paste0(lifeExp, " year life expectancy"))</span></span>
<span id="cb75-876"><a href="#cb75-876" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-877"><a href="#cb75-877" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(pred_gdp_hurdle_life, aes(x = .prediction)) +</span></span>
<span id="cb75-878"><a href="#cb75-878" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_histogram(aes(fill = is_zero), binwidth = 2500, </span></span>
<span id="cb75-879"><a href="#cb75-879" aria-hidden="true" tabindex="-1"></a><span class="in">                 boundary = 0, color = "white") +</span></span>
<span id="cb75-880"><a href="#cb75-880" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0) + </span></span>
<span id="cb75-881"><a href="#cb75-881" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_dollar(scale_cut = cut_short_scale())) +</span></span>
<span id="cb75-882"><a href="#cb75-882" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_manual(values = c(clrs[4], clrs[1]), </span></span>
<span id="cb75-883"><a href="#cb75-883" aria-hidden="true" tabindex="-1"></a><span class="in">                    guide = guide_legend(reverse = TRUE)) +</span></span>
<span id="cb75-884"><a href="#cb75-884" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "GDP per capita", y = NULL, fill = "Is zero?",</span></span>
<span id="cb75-885"><a href="#cb75-885" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "Predicted GDP per capita at different life expectancies") +</span></span>
<span id="cb75-886"><a href="#cb75-886" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(xlim = c(-2500, 50000)) +</span></span>
<span id="cb75-887"><a href="#cb75-887" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(vars(nice_life)) +</span></span>
<span id="cb75-888"><a href="#cb75-888" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice() +</span></span>
<span id="cb75-889"><a href="#cb75-889" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = "bottom")</span></span>
<span id="cb75-890"><a href="#cb75-890" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-891"><a href="#cb75-891" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-892"><a href="#cb75-892" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-893"><a href="#cb75-893" aria-hidden="true" tabindex="-1"></a><span class="fu">### 4. Hurdle lognormal model with fancy multilevel things</span></span>
<span id="cb75-894"><a href="#cb75-894" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-895"><a href="#cb75-895" aria-hidden="true" tabindex="-1"></a>So far we've actually been modeling this data all wrong. This is panel data, which means each country appears multiple times in the data across different years. We've been treating each row as completely independent, but that's not the case—GDP per capita in all these Afghanistan rows, for instance, is dependent on the year, and there are Afghanistan-specific trends that distinguish its GDP per capita from that of Albania. We need to take the structure of the panel data into account.</span>
<span id="cb75-896"><a href="#cb75-896" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-897"><a href="#cb75-897" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-gapminder-head}</span></span>
<span id="cb75-898"><a href="#cb75-898" aria-hidden="true" tabindex="-1"></a><span class="in">head(gapminder)</span></span>
<span id="cb75-899"><a href="#cb75-899" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-900"><a href="#cb75-900" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-901"><a href="#cb75-901" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">I have a whole guide about how to do this with multilevel models</span><span class="co">](https://www.andrewheiss.com/blog/2021/12/01/multilevel-models-panel-data-guide/)</span>—you should check it out for tons of details.</span>
<span id="cb75-902"><a href="#cb75-902" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-903"><a href="#cb75-903" aria-hidden="true" tabindex="-1"></a>Here we'll make it so each continent gets its own intercept, as well as continent-specific offsets to the slopes for life expectancy and year. Since we know the zero process (low values of life expectancy make it more likely to be 0), we'll define a simple model there (though we could get as complex as we want). Ordinarily we'd want to do country-specific effects, but for the sake of computational time, we'll just look at continents instead. (And even then, this takes a while! On my fancy M1 MacBook, this takes about 4 minutes; and there are all sorts of issues with divergent transitions that I'm going to ignore. In real life I'd set proper priors and scale the data down, but in this example I won't worry about all that.)</span>
<span id="cb75-904"><a href="#cb75-904" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-905"><a href="#cb75-905" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-gdp-hurdle-panel, cache=TRUE, warning=FALSE, results="hide"}</span></span>
<span id="cb75-906"><a href="#cb75-906" aria-hidden="true" tabindex="-1"></a><span class="in"># Shrink down year to make the model go faster</span></span>
<span id="cb75-907"><a href="#cb75-907" aria-hidden="true" tabindex="-1"></a><span class="in">gapminder_scaled &lt;- gapminder |&gt; </span></span>
<span id="cb75-908"><a href="#cb75-908" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(year_orig = year,</span></span>
<span id="cb75-909"><a href="#cb75-909" aria-hidden="true" tabindex="-1"></a><span class="in">         year = year - 1952)</span></span>
<span id="cb75-910"><a href="#cb75-910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-911"><a href="#cb75-911" aria-hidden="true" tabindex="-1"></a><span class="in">model_gdp_hurdle_panel &lt;- brm(</span></span>
<span id="cb75-912"><a href="#cb75-912" aria-hidden="true" tabindex="-1"></a><span class="in">  bf(gdpPercap ~ lifeExp + year + (1 + lifeExp + year | continent),</span></span>
<span id="cb75-913"><a href="#cb75-913" aria-hidden="true" tabindex="-1"></a><span class="in">     hu ~ lifeExp,</span></span>
<span id="cb75-914"><a href="#cb75-914" aria-hidden="true" tabindex="-1"></a><span class="in">     decomp = "QR"),</span></span>
<span id="cb75-915"><a href="#cb75-915" aria-hidden="true" tabindex="-1"></a><span class="in">  data = gapminder_scaled,</span></span>
<span id="cb75-916"><a href="#cb75-916" aria-hidden="true" tabindex="-1"></a><span class="in">  family = hurdle_lognormal(),</span></span>
<span id="cb75-917"><a href="#cb75-917" aria-hidden="true" tabindex="-1"></a><span class="in">  chains = CHAINS, iter = ITER, warmup = WARMUP, seed = BAYES_SEED,</span></span>
<span id="cb75-918"><a href="#cb75-918" aria-hidden="true" tabindex="-1"></a><span class="in">  silent = 2,</span></span>
<span id="cb75-919"><a href="#cb75-919" aria-hidden="true" tabindex="-1"></a><span class="in">  threads = threading(2)  # Two CPUs per chain to speed things up</span></span>
<span id="cb75-920"><a href="#cb75-920" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb75-921"><a href="#cb75-921" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-922"><a href="#cb75-922" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-923"><a href="#cb75-923" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-model-gdp-hurdle-panel, warning=FALSE}</span></span>
<span id="cb75-924"><a href="#cb75-924" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_gdp_hurdle_panel)</span></span>
<span id="cb75-925"><a href="#cb75-925" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-926"><a href="#cb75-926" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-927"><a href="#cb75-927" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-model-gdp-hurdle-panel, include=FALSE}</span></span>
<span id="cb75-928"><a href="#cb75-928" aria-hidden="true" tabindex="-1"></a><span class="in">m_gdp_hurdle_panel &lt;- tidy(model_gdp_hurdle_panel) |&gt; </span></span>
<span id="cb75-929"><a href="#cb75-929" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(term = janitor::make_clean_names(term)) |&gt; </span></span>
<span id="cb75-930"><a href="#cb75-930" aria-hidden="true" tabindex="-1"></a><span class="in">  split(~ term)</span></span>
<span id="cb75-931"><a href="#cb75-931" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-932"><a href="#cb75-932" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-933"><a href="#cb75-933" aria-hidden="true" tabindex="-1"></a>This complex model has a whole bunch of moving parts now! We have coefficients for the 0/not 0 process, coefficients for the non-zero process, and random effects (and their corresponding correlations) for the non-zero process. The hurdle coefficients are the same that we saw earlier, since that part of the model is unchanged. The non-zero coefficients now take the panel structure of the data into account, showing that on average, a one-year change in life expectancy is associated with a <span class="in">`r percent_format(accuracy = 0.1)(m_gdp_hurdle_panel$life_exp$estimate)`</span> increase in GDP per capita, on average.</span>
<span id="cb75-934"><a href="#cb75-934" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-935"><a href="#cb75-935" aria-hidden="true" tabindex="-1"></a>The actual dollar amount of GDP per capita depends on the existing level of life expectancy, but as before, we can visualize this with either <span class="in">`conditional_effects()`</span> or <span class="in">`emmeans()`</span>. We'll do it both ways for fun, and we'll look at predicted GDP per capita across different continents and years too, since we have that information.</span>
<span id="cb75-936"><a href="#cb75-936" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-937"><a href="#cb75-937" aria-hidden="true" tabindex="-1"></a>In order to calculate conditional effects with <span class="in">`conditional_effects()`</span>, we have to use some special syntax. We need to (1) specify <span class="in">`re_formula = NULL`</span> so that the predictions take the random effects structure into account (<span class="co">[</span><span class="ot">see this post for way more about that</span><span class="co">](https://www.andrewheiss.com/blog/2021/11/10/ame-bayes-re-guide/)</span>), and (2) create a data frame of year and continent values, along with a special <span class="in">`cond__`</span> column that will be used for the facet titles.</span>
<span id="cb75-938"><a href="#cb75-938" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-939"><a href="#cb75-939" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-gdp-hurdle-panel-conditional-effects-fake, eval=FALSE}</span></span>
<span id="cb75-940"><a href="#cb75-940" aria-hidden="true" tabindex="-1"></a><span class="in">conditions &lt;- expand_grid(year = c(0, 55),</span></span>
<span id="cb75-941"><a href="#cb75-941" aria-hidden="true" tabindex="-1"></a><span class="in">                          continent = unique(gapminder$continent)) |&gt; </span></span>
<span id="cb75-942"><a href="#cb75-942" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(cond__ = paste0(year + 1952, ": ", continent))</span></span>
<span id="cb75-943"><a href="#cb75-943" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-944"><a href="#cb75-944" aria-hidden="true" tabindex="-1"></a><span class="in">conditional_effects(model_gdp_hurdle_panel, effects = "lifeExp",</span></span>
<span id="cb75-945"><a href="#cb75-945" aria-hidden="true" tabindex="-1"></a><span class="in">                    conditions = conditions,</span></span>
<span id="cb75-946"><a href="#cb75-946" aria-hidden="true" tabindex="-1"></a><span class="in">                    re_formula = NULL) |&gt; </span></span>
<span id="cb75-947"><a href="#cb75-947" aria-hidden="true" tabindex="-1"></a><span class="in">  plot(ncol = 4)</span></span>
<span id="cb75-948"><a href="#cb75-948" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-949"><a href="#cb75-949" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-950"><a href="#cb75-950" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-gdp-hurdle-panel-conditional-effects, echo=FALSE, fig.width=9, fig.height=5.5, out.width="100%"}</span></span>
<span id="cb75-951"><a href="#cb75-951" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-inset-right</span></span>
<span id="cb75-952"><a href="#cb75-952" aria-hidden="true" tabindex="-1"></a><span class="in">conditions &lt;- expand_grid(year = c(0, 55),</span></span>
<span id="cb75-953"><a href="#cb75-953" aria-hidden="true" tabindex="-1"></a><span class="in">                          continent = unique(gapminder$continent)) |&gt; </span></span>
<span id="cb75-954"><a href="#cb75-954" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(cond__ = paste0(year + 1952, ": ", continent))</span></span>
<span id="cb75-955"><a href="#cb75-955" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-956"><a href="#cb75-956" aria-hidden="true" tabindex="-1"></a><span class="in">plot(conditional_effects(model_gdp_hurdle_panel, effects = "lifeExp",</span></span>
<span id="cb75-957"><a href="#cb75-957" aria-hidden="true" tabindex="-1"></a><span class="in">                    conditions = conditions,</span></span>
<span id="cb75-958"><a href="#cb75-958" aria-hidden="true" tabindex="-1"></a><span class="in">                    re_formula = NULL), plot = FALSE)[[1]]$data |&gt; </span></span>
<span id="cb75-959"><a href="#cb75-959" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = effect1__, y = estimate__)) +</span></span>
<span id="cb75-960"><a href="#cb75-960" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_ribbon(aes(ymin = lower__, ymax = upper__), alpha = 0.3, color = NA) +</span></span>
<span id="cb75-961"><a href="#cb75-961" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(size = 1, color = "#0074D9") +</span></span>
<span id="cb75-962"><a href="#cb75-962" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_y_continuous(labels = label_dollar(scale_cut = cut_short_scale())) +</span></span>
<span id="cb75-963"><a href="#cb75-963" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Life expectancy", y = "Predicted GDP per capita",</span></span>
<span id="cb75-964"><a href="#cb75-964" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "Predicted GDP per capita across life expectancy, continent, and time",</span></span>
<span id="cb75-965"><a href="#cb75-965" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "Made with conditional_effects()") +</span></span>
<span id="cb75-966"><a href="#cb75-966" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(vars(cond__), ncol = 4) +</span></span>
<span id="cb75-967"><a href="#cb75-967" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice()</span></span>
<span id="cb75-968"><a href="#cb75-968" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-969"><a href="#cb75-969" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-970"><a href="#cb75-970" aria-hidden="true" tabindex="-1"></a>This is so neat! Across all continents, GDP per capita increases as life expectancy increases, but that relationship looks different across continents (compare Asia with Africa, for instance), and across time (1952 Asia looks a lot different from 2007 Asia).</span>
<span id="cb75-971"><a href="#cb75-971" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-972"><a href="#cb75-972" aria-hidden="true" tabindex="-1"></a>The <span class="in">`conditional_effects()`</span> function is great for a quick look at the predicted values, but if we want complete control over the predictions and the plot, we can use <span class="in">`emmeans()`</span> instead:</span>
<span id="cb75-973"><a href="#cb75-973" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-974"><a href="#cb75-974" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-gdp-hurdle-panel-emmeans, fig.width=9, fig.height=5.5, out.width="100%", warning=FALSE}</span></span>
<span id="cb75-975"><a href="#cb75-975" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-inset-right</span></span>
<span id="cb75-976"><a href="#cb75-976" aria-hidden="true" tabindex="-1"></a><span class="in">model_gdp_hurdle_panel |&gt; </span></span>
<span id="cb75-977"><a href="#cb75-977" aria-hidden="true" tabindex="-1"></a><span class="in">  emmeans(~ lifeExp + year + continent, var = "lifeExp",</span></span>
<span id="cb75-978"><a href="#cb75-978" aria-hidden="true" tabindex="-1"></a><span class="in">          at = list(year = c(0, 55), </span></span>
<span id="cb75-979"><a href="#cb75-979" aria-hidden="true" tabindex="-1"></a><span class="in">                    continent = unique(gapminder$continent),</span></span>
<span id="cb75-980"><a href="#cb75-980" aria-hidden="true" tabindex="-1"></a><span class="in">                    lifeExp = seq(30, 80, 1)),</span></span>
<span id="cb75-981"><a href="#cb75-981" aria-hidden="true" tabindex="-1"></a><span class="in">          epred = TRUE, re_formula = NULL, allow_new_levels = TRUE) |&gt; </span></span>
<span id="cb75-982"><a href="#cb75-982" aria-hidden="true" tabindex="-1"></a><span class="in">  gather_emmeans_draws() |&gt; </span></span>
<span id="cb75-983"><a href="#cb75-983" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(year = year + 1952) |&gt; </span></span>
<span id="cb75-984"><a href="#cb75-984" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = lifeExp, y = .value)) +</span></span>
<span id="cb75-985"><a href="#cb75-985" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_lineribbon(aes(color = continent, fill = continent), size = 1, alpha = 0.25) +</span></span>
<span id="cb75-986"><a href="#cb75-986" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_manual(values = clrs[1:4], guide = "none") +</span></span>
<span id="cb75-987"><a href="#cb75-987" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_color_manual(values = clrs[1:4], guide = "none") +</span></span>
<span id="cb75-988"><a href="#cb75-988" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_y_continuous(labels = label_dollar()) +</span></span>
<span id="cb75-989"><a href="#cb75-989" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_nested_wrap(vars(year, continent), nrow = 2, </span></span>
<span id="cb75-990"><a href="#cb75-990" aria-hidden="true" tabindex="-1"></a><span class="in">                    strip = strip_nested(</span></span>
<span id="cb75-991"><a href="#cb75-991" aria-hidden="true" tabindex="-1"></a><span class="in">                      text_x = list(element_text(family = "Jost", </span></span>
<span id="cb75-992"><a href="#cb75-992" aria-hidden="true" tabindex="-1"></a><span class="in">                                                 face = "bold"), NULL),</span></span>
<span id="cb75-993"><a href="#cb75-993" aria-hidden="true" tabindex="-1"></a><span class="in">                      background_x = list(element_rect(fill = "grey92"), NULL),</span></span>
<span id="cb75-994"><a href="#cb75-994" aria-hidden="true" tabindex="-1"></a><span class="in">                      by_layer_x = TRUE)) +</span></span>
<span id="cb75-995"><a href="#cb75-995" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Life expectancy", y = "Predicted GDP per capita",</span></span>
<span id="cb75-996"><a href="#cb75-996" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "Predicted GDP per capita across life expectancy, continent, and time") +</span></span>
<span id="cb75-997"><a href="#cb75-997" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice() +</span></span>
<span id="cb75-998"><a href="#cb75-998" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = "bottom")</span></span>
<span id="cb75-999"><a href="#cb75-999" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-1000"><a href="#cb75-1000" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1001"><a href="#cb75-1001" aria-hidden="true" tabindex="-1"></a>We can also look at the slopes or marginal effects of these predictions, which lets us answer questions like "how much does GDP per capita increase in Asia countries with high life expectancy in 2007." To do this, we'll turn to <span class="in">`emtrends()`</span> to see predicted slopes for <span class="in">`lifeExp`</span> while holding other model variables constant. </span>
<span id="cb75-1002"><a href="#cb75-1002" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1003"><a href="#cb75-1003" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-mfx-life-log, include=FALSE}</span></span>
<span id="cb75-1004"><a href="#cb75-1004" aria-hidden="true" tabindex="-1"></a><span class="in">mfx_gdp_hurdle_panel_log &lt;- model_gdp_hurdle_panel |&gt; </span></span>
<span id="cb75-1005"><a href="#cb75-1005" aria-hidden="true" tabindex="-1"></a><span class="in">  emtrends(~ lifeExp + year + continent,</span></span>
<span id="cb75-1006"><a href="#cb75-1006" aria-hidden="true" tabindex="-1"></a><span class="in">           var = "lifeExp",</span></span>
<span id="cb75-1007"><a href="#cb75-1007" aria-hidden="true" tabindex="-1"></a><span class="in">           at = list(year = 0, continent = unique(gapminder$continent),</span></span>
<span id="cb75-1008"><a href="#cb75-1008" aria-hidden="true" tabindex="-1"></a><span class="in">                     lifeExp = c(40, 70)),</span></span>
<span id="cb75-1009"><a href="#cb75-1009" aria-hidden="true" tabindex="-1"></a><span class="in">           re_formula = NULL, allow_new_levels = TRUE) |&gt; </span></span>
<span id="cb75-1010"><a href="#cb75-1010" aria-hidden="true" tabindex="-1"></a><span class="in">  as_tibble() |&gt; </span></span>
<span id="cb75-1011"><a href="#cb75-1011" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(years = xfun::numbers_to_words(lifeExp)) |&gt; </span></span>
<span id="cb75-1012"><a href="#cb75-1012" aria-hidden="true" tabindex="-1"></a><span class="in">  split(~ years + continent)</span></span>
<span id="cb75-1013"><a href="#cb75-1013" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1014"><a href="#cb75-1014" aria-hidden="true" tabindex="-1"></a><span class="in">mfx_gdp_hurdle_panel_nolog &lt;- model_gdp_hurdle_panel |&gt; </span></span>
<span id="cb75-1015"><a href="#cb75-1015" aria-hidden="true" tabindex="-1"></a><span class="in">  emtrends(~ lifeExp + year + continent,</span></span>
<span id="cb75-1016"><a href="#cb75-1016" aria-hidden="true" tabindex="-1"></a><span class="in">           var = "lifeExp",</span></span>
<span id="cb75-1017"><a href="#cb75-1017" aria-hidden="true" tabindex="-1"></a><span class="in">           at = list(year = 0, continent = unique(gapminder$continent),</span></span>
<span id="cb75-1018"><a href="#cb75-1018" aria-hidden="true" tabindex="-1"></a><span class="in">                     lifeExp = c(40, 70)),</span></span>
<span id="cb75-1019"><a href="#cb75-1019" aria-hidden="true" tabindex="-1"></a><span class="in">           re_formula = NULL, epred = TRUE, allow_new_levels = TRUE) |&gt; </span></span>
<span id="cb75-1020"><a href="#cb75-1020" aria-hidden="true" tabindex="-1"></a><span class="in">  as_tibble() |&gt; </span></span>
<span id="cb75-1021"><a href="#cb75-1021" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(years = xfun::numbers_to_words(lifeExp)) |&gt; </span></span>
<span id="cb75-1022"><a href="#cb75-1022" aria-hidden="true" tabindex="-1"></a><span class="in">  split(~ years + continent)</span></span>
<span id="cb75-1023"><a href="#cb75-1023" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-1024"><a href="#cb75-1024" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1025"><a href="#cb75-1025" aria-hidden="true" tabindex="-1"></a>If we leave the coefficients on the log scale, there won't be any change across life expectancy, since the trend increases by the same percentage each year. There are continent-specific differences now, though: the relationship is steeper in Europe (<span class="in">`r percent_format(accuracy = 0.1)(mfx_gdp_hurdle_panel_log$forty.Europe$lifeExp.trend)`</span>) than in Africa (<span class="in">`r percent_format(accuracy = 0.1)(mfx_gdp_hurdle_panel_log$forty.Africa$lifeExp.trend)`</span>)</span>
<span id="cb75-1026"><a href="#cb75-1026" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1027"><a href="#cb75-1027" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-mfx-life-log, fig.width=7, fig.height=5, warning=FALSE}</span></span>
<span id="cb75-1028"><a href="#cb75-1028" aria-hidden="true" tabindex="-1"></a><span class="in">ame_model_gdp_hurdle_panel_log &lt;- model_gdp_hurdle_panel |&gt; </span></span>
<span id="cb75-1029"><a href="#cb75-1029" aria-hidden="true" tabindex="-1"></a><span class="in">  emtrends(~ lifeExp + year + continent,</span></span>
<span id="cb75-1030"><a href="#cb75-1030" aria-hidden="true" tabindex="-1"></a><span class="in">           var = "lifeExp",</span></span>
<span id="cb75-1031"><a href="#cb75-1031" aria-hidden="true" tabindex="-1"></a><span class="in">           at = list(year = 0, continent = unique(gapminder$continent),</span></span>
<span id="cb75-1032"><a href="#cb75-1032" aria-hidden="true" tabindex="-1"></a><span class="in">                     lifeExp = c(40, 70)),</span></span>
<span id="cb75-1033"><a href="#cb75-1033" aria-hidden="true" tabindex="-1"></a><span class="in">           re_formula = NULL, allow_new_levels = TRUE)</span></span>
<span id="cb75-1034"><a href="#cb75-1034" aria-hidden="true" tabindex="-1"></a><span class="in">ame_model_gdp_hurdle_panel_log</span></span>
<span id="cb75-1035"><a href="#cb75-1035" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1036"><a href="#cb75-1036" aria-hidden="true" tabindex="-1"></a><span class="in">ame_model_gdp_hurdle_panel_log |&gt; </span></span>
<span id="cb75-1037"><a href="#cb75-1037" aria-hidden="true" tabindex="-1"></a><span class="in">  gather_emmeans_draws() |&gt; </span></span>
<span id="cb75-1038"><a href="#cb75-1038" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(nice_life = paste0(lifeExp, " year life expectancy")) |&gt; </span></span>
<span id="cb75-1039"><a href="#cb75-1039" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = .value, y = continent, fill = continent)) +</span></span>
<span id="cb75-1040"><a href="#cb75-1040" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_slabinterval() +</span></span>
<span id="cb75-1041"><a href="#cb75-1041" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_manual(values = clrs[1:4], guide = "none") +</span></span>
<span id="cb75-1042"><a href="#cb75-1042" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_percent()) +</span></span>
<span id="cb75-1043"><a href="#cb75-1043" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Marginal effect of life expectancy on GDP per capita", y = NULL,</span></span>
<span id="cb75-1044"><a href="#cb75-1044" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "Marginal effect of life expectancy, log-scale coefficients") +</span></span>
<span id="cb75-1045"><a href="#cb75-1045" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(vars(nice_life), ncol = 1) +</span></span>
<span id="cb75-1046"><a href="#cb75-1046" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice()</span></span>
<span id="cb75-1047"><a href="#cb75-1047" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-1048"><a href="#cb75-1048" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1049"><a href="#cb75-1049" aria-hidden="true" tabindex="-1"></a>However, if we convert the coefficients to the original unlogged dollar scale, there are substantial changes across life expectancy, as we saw earlier. Only now we can also incorporate continent and year effects too. Asian countries with a 40-year life expectancy have a life expectancy slope of <span class="in">`r dollar_format(prefix = "\\\\$", accuracy = 1)(mfx_gdp_hurdle_panel_nolog$forty.Asia$lifeExp.trend)`</span>, while Asian countries with a 70-year life expectancy have a slope of <span class="in">`r dollar_format(prefix = "\\\\$", accuracy = 1)(mfx_gdp_hurdle_panel_nolog$seventy.Asia$lifeExp.trend)`</span>, on average. </span>
<span id="cb75-1050"><a href="#cb75-1050" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1051"><a href="#cb75-1051" aria-hidden="true" tabindex="-1"></a>Neat!</span>
<span id="cb75-1052"><a href="#cb75-1052" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1053"><a href="#cb75-1053" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-mfx-life-unlog, fig.width=7, fig.height=5}</span></span>
<span id="cb75-1054"><a href="#cb75-1054" aria-hidden="true" tabindex="-1"></a><span class="in">ame_model_gdp_hurdle_panel_nolog &lt;- model_gdp_hurdle_panel |&gt; </span></span>
<span id="cb75-1055"><a href="#cb75-1055" aria-hidden="true" tabindex="-1"></a><span class="in">  emtrends(~ lifeExp + year + continent,</span></span>
<span id="cb75-1056"><a href="#cb75-1056" aria-hidden="true" tabindex="-1"></a><span class="in">           var = "lifeExp",</span></span>
<span id="cb75-1057"><a href="#cb75-1057" aria-hidden="true" tabindex="-1"></a><span class="in">           at = list(year = 0, continent = unique(gapminder$continent),</span></span>
<span id="cb75-1058"><a href="#cb75-1058" aria-hidden="true" tabindex="-1"></a><span class="in">                     lifeExp = c(40, 70)),</span></span>
<span id="cb75-1059"><a href="#cb75-1059" aria-hidden="true" tabindex="-1"></a><span class="in">           re_formula = NULL, epred = TRUE, allow_new_levels = TRUE)</span></span>
<span id="cb75-1060"><a href="#cb75-1060" aria-hidden="true" tabindex="-1"></a><span class="in">ame_model_gdp_hurdle_panel_nolog</span></span>
<span id="cb75-1061"><a href="#cb75-1061" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1062"><a href="#cb75-1062" aria-hidden="true" tabindex="-1"></a><span class="in">ame_model_gdp_hurdle_panel_nolog |&gt; </span></span>
<span id="cb75-1063"><a href="#cb75-1063" aria-hidden="true" tabindex="-1"></a><span class="in">  gather_emmeans_draws() |&gt; </span></span>
<span id="cb75-1064"><a href="#cb75-1064" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(nice_life = paste0(lifeExp, " year life expectancy")) |&gt; </span></span>
<span id="cb75-1065"><a href="#cb75-1065" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = .value, y = continent, color = continent)) +</span></span>
<span id="cb75-1066"><a href="#cb75-1066" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_pointinterval() +</span></span>
<span id="cb75-1067"><a href="#cb75-1067" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_color_manual(values = clrs[1:4], guide = "none") +</span></span>
<span id="cb75-1068"><a href="#cb75-1068" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_dollar()) +</span></span>
<span id="cb75-1069"><a href="#cb75-1069" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Marginal effect of life expectancy on GDP per capita", y = NULL,</span></span>
<span id="cb75-1070"><a href="#cb75-1070" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "Marginal effect of life expectancy, dollar-scale coefficients") +</span></span>
<span id="cb75-1071"><a href="#cb75-1071" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(vars(nice_life), ncol = 1, scales = "free_x") +</span></span>
<span id="cb75-1072"><a href="#cb75-1072" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice()</span></span>
<span id="cb75-1073"><a href="#cb75-1073" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-1074"><a href="#cb75-1074" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1075"><a href="#cb75-1075" aria-hidden="true" tabindex="-1"></a>For extra bonus fun, we can look at how the dollar-scale marginal effect changes across more granular changes in life expectancy *and* across time *and* across continent.</span>
<span id="cb75-1076"><a href="#cb75-1076" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1077"><a href="#cb75-1077" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-mfx-lotsa-life, fig.width=7, fig.height=6.1}</span></span>
<span id="cb75-1078"><a href="#cb75-1078" aria-hidden="true" tabindex="-1"></a><span class="in">ame_model_gdp_hurdle_panel_nolog_fancy &lt;- model_gdp_hurdle_panel |&gt; </span></span>
<span id="cb75-1079"><a href="#cb75-1079" aria-hidden="true" tabindex="-1"></a><span class="in">  emtrends(~ lifeExp + year + continent,</span></span>
<span id="cb75-1080"><a href="#cb75-1080" aria-hidden="true" tabindex="-1"></a><span class="in">           var = "lifeExp",</span></span>
<span id="cb75-1081"><a href="#cb75-1081" aria-hidden="true" tabindex="-1"></a><span class="in">           at = list(year = c(0, 55), continent = unique(gapminder$continent),</span></span>
<span id="cb75-1082"><a href="#cb75-1082" aria-hidden="true" tabindex="-1"></a><span class="in">                     lifeExp = seq(40, 70, 2)),</span></span>
<span id="cb75-1083"><a href="#cb75-1083" aria-hidden="true" tabindex="-1"></a><span class="in">           epred = TRUE, re_formula = NULL, allow_new_levels = TRUE)</span></span>
<span id="cb75-1084"><a href="#cb75-1084" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1085"><a href="#cb75-1085" aria-hidden="true" tabindex="-1"></a><span class="in">ame_model_gdp_hurdle_panel_nolog_fancy |&gt; </span></span>
<span id="cb75-1086"><a href="#cb75-1086" aria-hidden="true" tabindex="-1"></a><span class="in">  gather_emmeans_draws() |&gt; </span></span>
<span id="cb75-1087"><a href="#cb75-1087" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(year = year + 1952) |&gt; </span></span>
<span id="cb75-1088"><a href="#cb75-1088" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = .value, y = continent, color = lifeExp, group = lifeExp)) +</span></span>
<span id="cb75-1089"><a href="#cb75-1089" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_pointinterval(position = "dodge", size = 0.75) +</span></span>
<span id="cb75-1090"><a href="#cb75-1090" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_color_gradient(low = clrs[5], high = clrs[2],</span></span>
<span id="cb75-1091"><a href="#cb75-1091" aria-hidden="true" tabindex="-1"></a><span class="in">                       guide = guide_colorbar(barwidth = 12, barheight = 0.5, direction = "horizontal")) +</span></span>
<span id="cb75-1092"><a href="#cb75-1092" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_dollar()) +</span></span>
<span id="cb75-1093"><a href="#cb75-1093" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Value of lifeExp coefficient (marginal effect)", y = NULL,</span></span>
<span id="cb75-1094"><a href="#cb75-1094" aria-hidden="true" tabindex="-1"></a><span class="in">       color = "Life expectancy",</span></span>
<span id="cb75-1095"><a href="#cb75-1095" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "Marginal effect of life expectancy on GDP per capita\nacross continent, time, and different values of life expectancy",</span></span>
<span id="cb75-1096"><a href="#cb75-1096" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "…all while incorporating information about the hurdle process!") +</span></span>
<span id="cb75-1097"><a href="#cb75-1097" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(vars(year), ncol = 1) +</span></span>
<span id="cb75-1098"><a href="#cb75-1098" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice() +</span></span>
<span id="cb75-1099"><a href="#cb75-1099" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = "bottom",</span></span>
<span id="cb75-1100"><a href="#cb75-1100" aria-hidden="true" tabindex="-1"></a><span class="in">        legend.title = element_text(vjust = 1))</span></span>
<span id="cb75-1101"><a href="#cb75-1101" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-1102"><a href="#cb75-1102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1103"><a href="#cb75-1103" aria-hidden="true" tabindex="-1"></a>AHHH this is so cool. As life expectancy increases, the estimated <span class="in">`lifeExp`</span> increases across all continents and across all years, but the trend behaves differently within each continent and within each year.</span>
<span id="cb75-1104"><a href="#cb75-1104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1105"><a href="#cb75-1105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1106"><a href="#cb75-1106" aria-hidden="true" tabindex="-1"></a><span class="fu">## Normally distributed outcomes with zeros</span></span>
<span id="cb75-1107"><a href="#cb75-1107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1108"><a href="#cb75-1108" aria-hidden="true" tabindex="-1"></a>**brms** comes with 4 different hurdle families and 6 different zero-inflated families. Working with <span class="in">`hurdle_lognormal()`</span> in the gapminder example above was great because GDP per capita is exponentially distributed and well-suited for logging. But what if your outcome isn't exponentially distributed, and doesn't fit one of the other built-in hurdle or zero-inflated families (gamma, Poisson, negative binomial, beta, etc.)? What if you have something nice and linear already, but that also has a built-in zero process? Let's see what we can do with that kind of outcome variable.</span>
<span id="cb75-1109"><a href="#cb75-1109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1110"><a href="#cb75-1110" aria-hidden="true" tabindex="-1"></a><span class="fu">### Explore data</span></span>
<span id="cb75-1111"><a href="#cb75-1111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1112"><a href="#cb75-1112" aria-hidden="true" tabindex="-1"></a>We'll play with the delightful <span class="co">[</span><span class="ot">`palmerpenguins`</span><span class="co">](https://allisonhorst.github.io/palmerpenguins/)</span> data. It's nice and pristine and has no zeros, but like we did with the gapminder data, we'll build in some of our own zeros. Here we'll say that penguins with a flipper length of less than 190 mm will have a 30% chance of recording a 0 in body mass, while those with flippers longer than 190 mm will have a 2% chance.</span>
<span id="cb75-1113"><a href="#cb75-1113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1114"><a href="#cb75-1114" aria-hidden="true" tabindex="-1"></a><span class="in">```{r make-zero-penguin-data}</span></span>
<span id="cb75-1115"><a href="#cb75-1115" aria-hidden="true" tabindex="-1"></a><span class="in">penguins &lt;- palmerpenguins::penguins |&gt; </span></span>
<span id="cb75-1116"><a href="#cb75-1116" aria-hidden="true" tabindex="-1"></a><span class="in">  drop_na(sex) |&gt; </span></span>
<span id="cb75-1117"><a href="#cb75-1117" aria-hidden="true" tabindex="-1"></a><span class="in">  # Make a bunch of weight values 0</span></span>
<span id="cb75-1118"><a href="#cb75-1118" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(prob_zero = ifelse(flipper_length_mm &lt; 190, 0.3, 0.02),</span></span>
<span id="cb75-1119"><a href="#cb75-1119" aria-hidden="true" tabindex="-1"></a><span class="in">         will_be_zero = rbinom(n(), 1, prob = prob_zero),</span></span>
<span id="cb75-1120"><a href="#cb75-1120" aria-hidden="true" tabindex="-1"></a><span class="in">         body_mass_g = ifelse(will_be_zero, 0, body_mass_g)) |&gt; </span></span>
<span id="cb75-1121"><a href="#cb75-1121" aria-hidden="true" tabindex="-1"></a><span class="in">  select(-prob_zero, -will_be_zero) |&gt; </span></span>
<span id="cb75-1122"><a href="#cb75-1122" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(is_zero = body_mass_g == 0)</span></span>
<span id="cb75-1123"><a href="#cb75-1123" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-1124"><a href="#cb75-1124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1125"><a href="#cb75-1125" aria-hidden="true" tabindex="-1"></a>Let's see how many zeros we ended up with:</span>
<span id="cb75-1126"><a href="#cb75-1126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1127"><a href="#cb75-1127" aria-hidden="true" tabindex="-1"></a><span class="in">```{r prop-zero-penguin}</span></span>
<span id="cb75-1128"><a href="#cb75-1128" aria-hidden="true" tabindex="-1"></a><span class="in">penguins |&gt; </span></span>
<span id="cb75-1129"><a href="#cb75-1129" aria-hidden="true" tabindex="-1"></a><span class="in">  count(is_zero) |&gt; </span></span>
<span id="cb75-1130"><a href="#cb75-1130" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(prop = n / sum(n))</span></span>
<span id="cb75-1131"><a href="#cb75-1131" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-1132"><a href="#cb75-1132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1133"><a href="#cb75-1133" aria-hidden="true" tabindex="-1"></a>Cool— <span class="in">`r label_percent(accuracy = 0.1)(sum(penguins$is_zero) / nrow(penguins))`</span> of the values of body mass are zero, which coincidentally is pretty close to the proportion we got in the gapminder example. Here's what the distribution looks like:</span>
<span id="cb75-1134"><a href="#cb75-1134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1135"><a href="#cb75-1135" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-body-mass-dist}</span></span>
<span id="cb75-1136"><a href="#cb75-1136" aria-hidden="true" tabindex="-1"></a><span class="in">penguins |&gt; </span></span>
<span id="cb75-1137"><a href="#cb75-1137" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(body_mass_g = ifelse(is_zero, -0.1, body_mass_g)) |&gt; </span></span>
<span id="cb75-1138"><a href="#cb75-1138" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = body_mass_g)) +</span></span>
<span id="cb75-1139"><a href="#cb75-1139" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_histogram(aes(fill = is_zero), binwidth = 100,</span></span>
<span id="cb75-1140"><a href="#cb75-1140" aria-hidden="true" tabindex="-1"></a><span class="in">                 boundary = 0, color = "white") +</span></span>
<span id="cb75-1141"><a href="#cb75-1141" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0) +</span></span>
<span id="cb75-1142"><a href="#cb75-1142" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_manual(values = c("darkorange", "purple")) +</span></span>
<span id="cb75-1143"><a href="#cb75-1143" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = comma_format()) +</span></span>
<span id="cb75-1144"><a href="#cb75-1144" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Body mass (g)", y = "Count", fill = "Is zero?",</span></span>
<span id="cb75-1145"><a href="#cb75-1145" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "Distribution of penguin body mass") +</span></span>
<span id="cb75-1146"><a href="#cb75-1146" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice() +</span></span>
<span id="cb75-1147"><a href="#cb75-1147" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = "bottom")</span></span>
<span id="cb75-1148"><a href="#cb75-1148" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-1149"><a href="#cb75-1149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1150"><a href="#cb75-1150" aria-hidden="true" tabindex="-1"></a><span class="fu">### 1. Regular OLS model on a non-exponential outcome</span></span>
<span id="cb75-1151"><a href="#cb75-1151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1152"><a href="#cb75-1152" aria-hidden="true" tabindex="-1"></a>Now that we have some artificial zeros, let's model the relationship between body mass and bill length. Since body mass is relatively normally distributed, we'll use regular old OLS and not worry about any logging.</span>
<span id="cb75-1153"><a href="#cb75-1153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1154"><a href="#cb75-1154" aria-hidden="true" tabindex="-1"></a>The zeros we added are going to cause some problems. In this scatterplot, the &lt;span style="color:#0074D9;"&gt;■<span class="dv">&amp;nbsp;</span>blue&lt;/span&gt; line is fit using only the non-zero data. If we include the zeros, like the &lt;span style="color:#F012BE;"&gt;■<span class="dv">&amp;nbsp;</span>fuchsia&lt;/span&gt; line in this plot, the relationship changes a little—the model underpredicts the body mass of shorter-billed penguins.</span>
<span id="cb75-1155"><a href="#cb75-1155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1156"><a href="#cb75-1156" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-ols-bill, fig.width=6.5, fig.height=4.25, message=FALSE}</span></span>
<span id="cb75-1157"><a href="#cb75-1157" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(penguins, aes(x = bill_length_mm, y = body_mass_g)) +</span></span>
<span id="cb75-1158"><a href="#cb75-1158" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(aes(color = species), size = 1.5) + </span></span>
<span id="cb75-1159"><a href="#cb75-1159" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_smooth(method = "lm", color = "#F012BE") +</span></span>
<span id="cb75-1160"><a href="#cb75-1160" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_smooth(data = filter(penguins, body_mass_g != 0), method = "lm", color = "#0074D9") +</span></span>
<span id="cb75-1161"><a href="#cb75-1161" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_y_continuous(labels = label_comma()) +</span></span>
<span id="cb75-1162"><a href="#cb75-1162" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_color_manual(values = c("darkorange", "purple", "cyan4")) +</span></span>
<span id="cb75-1163"><a href="#cb75-1163" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Bill length (mm)", y = "Body mass (g)", color = "Species",</span></span>
<span id="cb75-1164"><a href="#cb75-1164" aria-hidden="true" tabindex="-1"></a><span class="in">       title = 'OLS models &lt;span style="color:#F012BE;"&gt;with&lt;/span&gt; and &lt;span style="color:#0074D9;"&gt;without&lt;/span&gt; zeros') +</span></span>
<span id="cb75-1165"><a href="#cb75-1165" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice() +</span></span>
<span id="cb75-1166"><a href="#cb75-1166" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = "bottom",</span></span>
<span id="cb75-1167"><a href="#cb75-1167" aria-hidden="true" tabindex="-1"></a><span class="in">        plot.title = element_markdown())</span></span>
<span id="cb75-1168"><a href="#cb75-1168" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-1169"><a href="#cb75-1169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1170"><a href="#cb75-1170" aria-hidden="true" tabindex="-1"></a>Let's make a couple models that predict body mass based on bill length and species, both with and without the zeros:</span>
<span id="cb75-1171"><a href="#cb75-1171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1172"><a href="#cb75-1172" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-mass-bill-basic, cache=TRUE, warning=FALSE, results="hide"}</span></span>
<span id="cb75-1173"><a href="#cb75-1173" aria-hidden="true" tabindex="-1"></a><span class="in">model_mass_basic &lt;- brm(</span></span>
<span id="cb75-1174"><a href="#cb75-1174" aria-hidden="true" tabindex="-1"></a><span class="in">  bf(body_mass_g ~ bill_length_mm + species),</span></span>
<span id="cb75-1175"><a href="#cb75-1175" aria-hidden="true" tabindex="-1"></a><span class="in">  data = penguins,</span></span>
<span id="cb75-1176"><a href="#cb75-1176" aria-hidden="true" tabindex="-1"></a><span class="in">  family = gaussian(),</span></span>
<span id="cb75-1177"><a href="#cb75-1177" aria-hidden="true" tabindex="-1"></a><span class="in">  chains = CHAINS, iter = ITER, warmup = WARMUP, seed = BAYES_SEED,</span></span>
<span id="cb75-1178"><a href="#cb75-1178" aria-hidden="true" tabindex="-1"></a><span class="in">  silent = 2</span></span>
<span id="cb75-1179"><a href="#cb75-1179" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb75-1180"><a href="#cb75-1180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1181"><a href="#cb75-1181" aria-hidden="true" tabindex="-1"></a><span class="in">model_mass_basic_no_zero &lt;- brm(</span></span>
<span id="cb75-1182"><a href="#cb75-1182" aria-hidden="true" tabindex="-1"></a><span class="in">  bf(body_mass_g ~ bill_length_mm + species),</span></span>
<span id="cb75-1183"><a href="#cb75-1183" aria-hidden="true" tabindex="-1"></a><span class="in">  data = filter(penguins, !is_zero),</span></span>
<span id="cb75-1184"><a href="#cb75-1184" aria-hidden="true" tabindex="-1"></a><span class="in">  family = gaussian(),</span></span>
<span id="cb75-1185"><a href="#cb75-1185" aria-hidden="true" tabindex="-1"></a><span class="in">  chains = CHAINS, iter = ITER, warmup = WARMUP, seed = BAYES_SEED,</span></span>
<span id="cb75-1186"><a href="#cb75-1186" aria-hidden="true" tabindex="-1"></a><span class="in">  silent = 2</span></span>
<span id="cb75-1187"><a href="#cb75-1187" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb75-1188"><a href="#cb75-1188" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-1189"><a href="#cb75-1189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1190"><a href="#cb75-1190" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-mass-bill-basic, warning=FALSE}</span></span>
<span id="cb75-1191"><a href="#cb75-1191" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_mass_basic)</span></span>
<span id="cb75-1192"><a href="#cb75-1192" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_mass_basic_no_zero)</span></span>
<span id="cb75-1193"><a href="#cb75-1193" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-1194"><a href="#cb75-1194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1195"><a href="#cb75-1195" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-mass-bill-basic, include=FALSE}</span></span>
<span id="cb75-1196"><a href="#cb75-1196" aria-hidden="true" tabindex="-1"></a><span class="in">m_mass_basic &lt;- tidy(model_mass_basic) |&gt; </span></span>
<span id="cb75-1197"><a href="#cb75-1197" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(term = janitor::make_clean_names(term),</span></span>
<span id="cb75-1198"><a href="#cb75-1198" aria-hidden="true" tabindex="-1"></a><span class="in">         est = round(estimate, 2)) |&gt; </span></span>
<span id="cb75-1199"><a href="#cb75-1199" aria-hidden="true" tabindex="-1"></a><span class="in">  split(~ term)</span></span>
<span id="cb75-1200"><a href="#cb75-1200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1201"><a href="#cb75-1201" aria-hidden="true" tabindex="-1"></a><span class="in">m_mass_basic_no_zero &lt;- tidy(model_mass_basic_no_zero) |&gt; </span></span>
<span id="cb75-1202"><a href="#cb75-1202" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(term = janitor::make_clean_names(term),</span></span>
<span id="cb75-1203"><a href="#cb75-1203" aria-hidden="true" tabindex="-1"></a><span class="in">         est = round(estimate, 2)) |&gt; </span></span>
<span id="cb75-1204"><a href="#cb75-1204" aria-hidden="true" tabindex="-1"></a><span class="in">  split(~ term)</span></span>
<span id="cb75-1205"><a href="#cb75-1205" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-1206"><a href="#cb75-1206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1207"><a href="#cb75-1207" aria-hidden="true" tabindex="-1"></a>These models give different estimates for the effect of bill length on body mass. In the model that omits the zeros (&lt;span style="color:#0074D9;"&gt;■<span class="dv">&amp;nbsp;</span>blue&lt;/span&gt;), a 1 mm increase in bill length is associated with a <span class="in">`r m_mass_basic$bill_length_mm$est`</span> gram increase in body mass, on average. If we include the zeros, though (&lt;span style="color:#F012BE;"&gt;■<span class="dv">&amp;nbsp;</span>fuchsia&lt;/span&gt;), the effect drops to <span class="in">`r m_mass_basic_no_zero$bill_length_mm$est`</span> grams. </span>
<span id="cb75-1208"><a href="#cb75-1208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1209"><a href="#cb75-1209" aria-hidden="true" tabindex="-1"></a>If we look at a posterior predictive check for the &lt;span style="color:#0074D9;"&gt;■<span class="dv">&amp;nbsp;</span>blue&lt;/span&gt; zero-free model we can see that the model doesn't do a great job of fitting the distribution of the outcome. Compare the distribution of actual observed body mass (in &lt;span style="color:`r clrs[4]`;"&gt;■<span class="dv">&amp;nbsp;</span>light blue&lt;/span&gt;) with simulated body mass from the posterior distribution (in &lt;span style="color:`r clrs[2]`;"&gt;■<span class="dv">&amp;nbsp;</span>orange&lt;/span&gt;). Oh no:</span>
<span id="cb75-1210"><a href="#cb75-1210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1211"><a href="#cb75-1211" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-pp-model-mass-bill-basic-fake, eval=FALSE}</span></span>
<span id="cb75-1212"><a href="#cb75-1212" aria-hidden="true" tabindex="-1"></a><span class="in">pp_check(model_mass_basic)</span></span>
<span id="cb75-1213"><a href="#cb75-1213" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-1214"><a href="#cb75-1214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1215"><a href="#cb75-1215" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-pp-mass-bill-basic, fig.height=2.75, echo=FALSE, message=FALSE}</span></span>
<span id="cb75-1216"><a href="#cb75-1216" aria-hidden="true" tabindex="-1"></a><span class="in">pp_check(model_mass_basic) +</span></span>
<span id="cb75-1217"><a href="#cb75-1217" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_comma()) +</span></span>
<span id="cb75-1218"><a href="#cb75-1218" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(title = "Posterior predictive check", </span></span>
<span id="cb75-1219"><a href="#cb75-1219" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "OLS model fit on data with zeros") +</span></span>
<span id="cb75-1220"><a href="#cb75-1220" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice()</span></span>
<span id="cb75-1221"><a href="#cb75-1221" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-1222"><a href="#cb75-1222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1223"><a href="#cb75-1223" aria-hidden="true" tabindex="-1"></a>We need to somehow account for these zeros, but how?</span>
<span id="cb75-1224"><a href="#cb75-1224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1225"><a href="#cb75-1225" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2. Hurdle lognormal model on a non-exponential outcome</span></span>
<span id="cb75-1226"><a href="#cb75-1226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1227"><a href="#cb75-1227" aria-hidden="true" tabindex="-1"></a>Unfortunately, there's no built-in <span class="in">`hurdle_gaussian()`</span> family we can use with **brms**. But maybe we can fake it and use <span class="in">`hurdle_lognormal()`</span>. If we log body mass it shrinks the values down to ≈8.5, and we still have a normal-looking distribution (albeit with a really small range).</span>
<span id="cb75-1228"><a href="#cb75-1228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1229"><a href="#cb75-1229" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-body-mass-dist-log}</span></span>
<span id="cb75-1230"><a href="#cb75-1230" aria-hidden="true" tabindex="-1"></a><span class="in">penguins |&gt; </span></span>
<span id="cb75-1231"><a href="#cb75-1231" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(body_mass_g = log1p(body_mass_g)) |&gt; </span></span>
<span id="cb75-1232"><a href="#cb75-1232" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(body_mass_g = ifelse(is_zero, -0.01, body_mass_g)) |&gt; </span></span>
<span id="cb75-1233"><a href="#cb75-1233" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = body_mass_g)) +</span></span>
<span id="cb75-1234"><a href="#cb75-1234" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_histogram(aes(fill = is_zero), binwidth = 0.1,</span></span>
<span id="cb75-1235"><a href="#cb75-1235" aria-hidden="true" tabindex="-1"></a><span class="in">                 boundary = 0, color = "white") +</span></span>
<span id="cb75-1236"><a href="#cb75-1236" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0) +</span></span>
<span id="cb75-1237"><a href="#cb75-1237" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_manual(values = c("darkorange", "purple")) +</span></span>
<span id="cb75-1238"><a href="#cb75-1238" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Body mass (g)", y = "Count", fill = "Is zero?",</span></span>
<span id="cb75-1239"><a href="#cb75-1239" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "Distribution of logged penguin body mass") +</span></span>
<span id="cb75-1240"><a href="#cb75-1240" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice() +</span></span>
<span id="cb75-1241"><a href="#cb75-1241" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = "bottom")</span></span>
<span id="cb75-1242"><a href="#cb75-1242" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-1243"><a href="#cb75-1243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1244"><a href="#cb75-1244" aria-hidden="true" tabindex="-1"></a>We can probably plausibly use a hurdled lognormal model here like we did with the gapminder example. This makes the coefficients a little harder to interpret—we can't say that a 1 mm increase in bill length is associated with a X gram change in body mass, but we can say that a 1 mm increase in bill length is associated with a X% change in body mass. And we can back-transform these logged coefficients to the gram scale using <span class="in">`emmeans()`</span>. Let's try it.</span>
<span id="cb75-1245"><a href="#cb75-1245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1246"><a href="#cb75-1246" aria-hidden="true" tabindex="-1"></a>Since we know the hurdle process (flipper length determined the 0/not 0 choice), we'll use flipper length in the <span class="in">`hu`</span> formula.</span>
<span id="cb75-1247"><a href="#cb75-1247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1248"><a href="#cb75-1248" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-mass-bill-hurdle-log, cache=TRUE, warning=FALSE, results="hide"}</span></span>
<span id="cb75-1249"><a href="#cb75-1249" aria-hidden="true" tabindex="-1"></a><span class="in">model_mass_hurdle_log &lt;- brm(</span></span>
<span id="cb75-1250"><a href="#cb75-1250" aria-hidden="true" tabindex="-1"></a><span class="in">  bf(body_mass_g ~ bill_length_mm + species,</span></span>
<span id="cb75-1251"><a href="#cb75-1251" aria-hidden="true" tabindex="-1"></a><span class="in">     hu ~ flipper_length_mm),</span></span>
<span id="cb75-1252"><a href="#cb75-1252" aria-hidden="true" tabindex="-1"></a><span class="in">  data = penguins,</span></span>
<span id="cb75-1253"><a href="#cb75-1253" aria-hidden="true" tabindex="-1"></a><span class="in">  family = hurdle_lognormal(),</span></span>
<span id="cb75-1254"><a href="#cb75-1254" aria-hidden="true" tabindex="-1"></a><span class="in">  chains = CHAINS, iter = ITER, warmup = WARMUP, seed = BAYES_SEED,</span></span>
<span id="cb75-1255"><a href="#cb75-1255" aria-hidden="true" tabindex="-1"></a><span class="in">  silent = 2</span></span>
<span id="cb75-1256"><a href="#cb75-1256" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb75-1257"><a href="#cb75-1257" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-1258"><a href="#cb75-1258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1259"><a href="#cb75-1259" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-mass-bill-hurdle-log, warning=FALSE}</span></span>
<span id="cb75-1260"><a href="#cb75-1260" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_mass_hurdle_log)</span></span>
<span id="cb75-1261"><a href="#cb75-1261" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-1262"><a href="#cb75-1262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1263"><a href="#cb75-1263" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-mass-bill-hurdle-log, include=FALSE}</span></span>
<span id="cb75-1264"><a href="#cb75-1264" aria-hidden="true" tabindex="-1"></a><span class="in">m_mass_hurdle_log &lt;- tidy(model_mass_hurdle_log) |&gt; </span></span>
<span id="cb75-1265"><a href="#cb75-1265" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(term = janitor::make_clean_names(term),</span></span>
<span id="cb75-1266"><a href="#cb75-1266" aria-hidden="true" tabindex="-1"></a><span class="in">         est = round(estimate, 2)) |&gt; </span></span>
<span id="cb75-1267"><a href="#cb75-1267" aria-hidden="true" tabindex="-1"></a><span class="in">  split(~ term)</span></span>
<span id="cb75-1268"><a href="#cb75-1268" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-1269"><a href="#cb75-1269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1270"><a href="#cb75-1270" aria-hidden="true" tabindex="-1"></a>We have results, but they're on the log scale so we have to think about the coefficients differently. According to the <span class="in">`bill_length_mm`</span> coefficient, a one-millimeter increase in bill length is associated with a <span class="in">`r percent_format(accuracy = 0.1)(m_mass_hurdle_log$bill_length_mm$estimate)`</span> increase in body mass. </span>
<span id="cb75-1271"><a href="#cb75-1271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1272"><a href="#cb75-1272" aria-hidden="true" tabindex="-1"></a>We can also look at the logit-scale hurdle process, though it's a little tricky since we can't just use <span class="in">`plogis()`</span> on the coefficient. We can use <span class="in">`emtrends()`</span> to extract the slope, though. Since we're on a logit scale, the actual slope depends on the value of flipper length depends on flipper length itself. We can feed <span class="in">`emtrends()`</span> any flipper lengths we want—a range of possible flipper lengths; the average for the data; whatever—and get the corresponding slope or marginal effect. If we include <span class="in">`regrid = "response"`</span> we'll see the results on the percentage point-scale</span>
<span id="cb75-1273"><a href="#cb75-1273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1274"><a href="#cb75-1274" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-mass-flipper-hurdle-logit}</span></span>
<span id="cb75-1275"><a href="#cb75-1275" aria-hidden="true" tabindex="-1"></a><span class="in">model_mass_hurdle_log |&gt; </span></span>
<span id="cb75-1276"><a href="#cb75-1276" aria-hidden="true" tabindex="-1"></a><span class="in">  emtrends(~ flipper_length_mm, var = "flipper_length_mm", </span></span>
<span id="cb75-1277"><a href="#cb75-1277" aria-hidden="true" tabindex="-1"></a><span class="in">           dpar = "hu", regrid = "response",</span></span>
<span id="cb75-1278"><a href="#cb75-1278" aria-hidden="true" tabindex="-1"></a><span class="in">           # Show the effect for the mean and for a range</span></span>
<span id="cb75-1279"><a href="#cb75-1279" aria-hidden="true" tabindex="-1"></a><span class="in">           at = list(flipper_length_mm = c(mean(penguins$flipper_length_mm), </span></span>
<span id="cb75-1280"><a href="#cb75-1280" aria-hidden="true" tabindex="-1"></a><span class="in">                                           seq(170, 230, 10))))</span></span>
<span id="cb75-1281"><a href="#cb75-1281" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-1282"><a href="#cb75-1282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1283"><a href="#cb75-1283" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-mass-flipper-hurdle-logit, include=FALSE}</span></span>
<span id="cb75-1284"><a href="#cb75-1284" aria-hidden="true" tabindex="-1"></a><span class="in">mfx_mass_hurdle_logit &lt;- model_mass_hurdle_log |&gt; </span></span>
<span id="cb75-1285"><a href="#cb75-1285" aria-hidden="true" tabindex="-1"></a><span class="in">  emtrends(~ flipper_length_mm, var = "flipper_length_mm", </span></span>
<span id="cb75-1286"><a href="#cb75-1286" aria-hidden="true" tabindex="-1"></a><span class="in">           dpar = "hu", regrid = "response",</span></span>
<span id="cb75-1287"><a href="#cb75-1287" aria-hidden="true" tabindex="-1"></a><span class="in">           at = list(flipper_length_mm = c(mean(penguins$flipper_length_mm), </span></span>
<span id="cb75-1288"><a href="#cb75-1288" aria-hidden="true" tabindex="-1"></a><span class="in">                                           seq(170, 230, 10)))) |&gt; </span></span>
<span id="cb75-1289"><a href="#cb75-1289" aria-hidden="true" tabindex="-1"></a><span class="in">  as_tibble() |&gt; </span></span>
<span id="cb75-1290"><a href="#cb75-1290" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(length = xfun::numbers_to_words(round(flipper_length_mm, 0)),</span></span>
<span id="cb75-1291"><a href="#cb75-1291" aria-hidden="true" tabindex="-1"></a><span class="in">         length = str_replace_all(length, " ", "_")) |&gt; </span></span>
<span id="cb75-1292"><a href="#cb75-1292" aria-hidden="true" tabindex="-1"></a><span class="in">  split(~ length)</span></span>
<span id="cb75-1293"><a href="#cb75-1293" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-1294"><a href="#cb75-1294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1295"><a href="#cb75-1295" aria-hidden="true" tabindex="-1"></a>The probability of seeing a zero decreases at different rates depending on existing flipper lengths. For short-flippered penguins, a one-mm change from 170 mm to 171 mm is associated with a <span class="in">`r round(mfx_mass_hurdle_logit$one_hundred_seventy$flipper_length_mm.trend * 100, 2)`</span> percentage point decrease in the probability of seeing a zero. For long-flippered penguins, a one-mm change from 220 mm to 221 mm is associated with a <span class="in">`r round(mfx_mass_hurdle_logit$two_hundred_twenty$flipper_length_mm.trend * 100, 2)`</span> percentage point decrease. For penguins with an average flipper length (<span class="in">`r round(mean(penguins$flipper_length_mm), 2)`</span> mm), the change is <span class="in">`r round(mfx_mass_hurdle_logit$two_hundred_one$flipper_length_mm.trend * 100, 2)`</span> percentage points. These slopes are all visible in the <span class="in">`conditional_effects()`</span> plot of the hurdle component of the model, which I'll show below.</span>
<span id="cb75-1296"><a href="#cb75-1296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1297"><a href="#cb75-1297" aria-hidden="true" tabindex="-1"></a>We can also check how well the model fits the data:</span>
<span id="cb75-1298"><a href="#cb75-1298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1299"><a href="#cb75-1299" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-pp-model-mass-bill-hurdle-log-fake, eval=FALSE}</span></span>
<span id="cb75-1300"><a href="#cb75-1300" aria-hidden="true" tabindex="-1"></a><span class="in">pp_check(model_mass_hurdle_log)</span></span>
<span id="cb75-1301"><a href="#cb75-1301" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-1302"><a href="#cb75-1302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1303"><a href="#cb75-1303" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-pp-mass-bill-hurdle-log, fig.height=2.75, echo=FALSE, message=FALSE}</span></span>
<span id="cb75-1304"><a href="#cb75-1304" aria-hidden="true" tabindex="-1"></a><span class="in">pp_check(model_mass_hurdle_log) +</span></span>
<span id="cb75-1305"><a href="#cb75-1305" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_comma()) +</span></span>
<span id="cb75-1306"><a href="#cb75-1306" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(title = "Posterior predictive check", </span></span>
<span id="cb75-1307"><a href="#cb75-1307" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "Hurdle lognormal model fit on data with zeros") +</span></span>
<span id="cb75-1308"><a href="#cb75-1308" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice()</span></span>
<span id="cb75-1309"><a href="#cb75-1309" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-1310"><a href="#cb75-1310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1311"><a href="#cb75-1311" aria-hidden="true" tabindex="-1"></a>It accounts for the zeros, as expected.</span>
<span id="cb75-1312"><a href="#cb75-1312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1313"><a href="#cb75-1313" aria-hidden="true" tabindex="-1"></a>Next we'll look at the marginal/conditional effects of bill length on body mass and flipper length on the proportion of zeros. We can do it with both <span class="in">`conditional_effects()`</span> (for quick and easy plots) and with <span class="in">`emmeans()`</span> (for more control over everything). Unfortunately there's no easy way to plot *only* the <span class="in">`mu`</span> part using <span class="in">`conditional_effects()`</span>—it defaults to showing expected predictions. We can show only the <span class="in">`mu`</span> part with <span class="in">`emmeans()`</span> though.</span>
<span id="cb75-1314"><a href="#cb75-1314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1315"><a href="#cb75-1315" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-conditional-mass-bill-fake, eval=FALSE}</span></span>
<span id="cb75-1316"><a href="#cb75-1316" aria-hidden="true" tabindex="-1"></a><span class="in">conditional_effects(model_mass_hurdle_log, effects = "bill_length_mm")</span></span>
<span id="cb75-1317"><a href="#cb75-1317" aria-hidden="true" tabindex="-1"></a><span class="in">conditional_effects(model_mass_hurdle_log, effects = "flipper_length_mm", dpar = "hu")</span></span>
<span id="cb75-1318"><a href="#cb75-1318" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-1319"><a href="#cb75-1319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1320"><a href="#cb75-1320" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-conditional-mass-bill, fig.width=6, fig.height=6, echo=FALSE}</span></span>
<span id="cb75-1321"><a href="#cb75-1321" aria-hidden="true" tabindex="-1"></a><span class="in">plot_cond_mass1 &lt;- plot(conditional_effects(model_mass_hurdle_log, effects = "bill_length_mm", epred = TRUE), plot = FALSE)[[1]]$data |&gt; </span></span>
<span id="cb75-1322"><a href="#cb75-1322" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = effect1__, y = estimate__)) +</span></span>
<span id="cb75-1323"><a href="#cb75-1323" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_ribbon(aes(ymin = lower__, ymax = upper__), alpha = 0.3, color = NA) +</span></span>
<span id="cb75-1324"><a href="#cb75-1324" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(size = 1, color = "darkorange") +</span></span>
<span id="cb75-1325"><a href="#cb75-1325" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_y_continuous(labels = label_comma()) +</span></span>
<span id="cb75-1326"><a href="#cb75-1326" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Bill length (mm)", y = "Predicted body mass (g)",</span></span>
<span id="cb75-1327"><a href="#cb75-1327" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "Expected values (both mu and hu)") +</span></span>
<span id="cb75-1328"><a href="#cb75-1328" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice()</span></span>
<span id="cb75-1329"><a href="#cb75-1329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1330"><a href="#cb75-1330" aria-hidden="true" tabindex="-1"></a><span class="in">plot_cond_mass2 &lt;- plot(conditional_effects(model_mass_hurdle_log, effects = "flipper_length_mm", dpar = "hu"), plot = FALSE)[[1]]$data |&gt; </span></span>
<span id="cb75-1331"><a href="#cb75-1331" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = effect1__, y = estimate__)) +</span></span>
<span id="cb75-1332"><a href="#cb75-1332" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_ribbon(aes(ymin = lower__, ymax = upper__), alpha = 0.3, color = NA) +</span></span>
<span id="cb75-1333"><a href="#cb75-1333" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(size = 1, color = "purple") +</span></span>
<span id="cb75-1334"><a href="#cb75-1334" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_y_continuous(labels = label_percent()) +</span></span>
<span id="cb75-1335"><a href="#cb75-1335" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Flipper length (mm)", y = "Predicted probability\nof seeing 0 body mass",</span></span>
<span id="cb75-1336"><a href="#cb75-1336" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "Hurdle part of the model (dpar = \"hu\")") +</span></span>
<span id="cb75-1337"><a href="#cb75-1337" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice()</span></span>
<span id="cb75-1338"><a href="#cb75-1338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1339"><a href="#cb75-1339" aria-hidden="true" tabindex="-1"></a><span class="in">(plot_cond_mass1 / plot_cond_mass2) +</span></span>
<span id="cb75-1340"><a href="#cb75-1340" aria-hidden="true" tabindex="-1"></a><span class="in">  plot_annotation(title = "Conditional effects of bill length and flipper length",</span></span>
<span id="cb75-1341"><a href="#cb75-1341" aria-hidden="true" tabindex="-1"></a><span class="in">                  subtitle = "Made with conditional_effects()",</span></span>
<span id="cb75-1342"><a href="#cb75-1342" aria-hidden="true" tabindex="-1"></a><span class="in">                  theme = theme(plot.title = element_text(family = "Jost", face = "bold"),</span></span>
<span id="cb75-1343"><a href="#cb75-1343" aria-hidden="true" tabindex="-1"></a><span class="in">                                plot.subtitle = element_text(family = "Jost")))</span></span>
<span id="cb75-1344"><a href="#cb75-1344" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-1345"><a href="#cb75-1345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1346"><a href="#cb75-1346" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-emmeans-mfx-mass-hurdle, fig.width=6, fig.height=8, warning=FALSE}</span></span>
<span id="cb75-1347"><a href="#cb75-1347" aria-hidden="true" tabindex="-1"></a><span class="in">plot_penguins_emmeans0 &lt;- model_mass_hurdle_log |&gt; </span></span>
<span id="cb75-1348"><a href="#cb75-1348" aria-hidden="true" tabindex="-1"></a><span class="in">  emmeans(~ bill_length_mm, var = "bill_length_mm",</span></span>
<span id="cb75-1349"><a href="#cb75-1349" aria-hidden="true" tabindex="-1"></a><span class="in">          at = list(bill_length_mm = seq(30, 60, 1)),</span></span>
<span id="cb75-1350"><a href="#cb75-1350" aria-hidden="true" tabindex="-1"></a><span class="in">          epred = TRUE) |&gt; </span></span>
<span id="cb75-1351"><a href="#cb75-1351" aria-hidden="true" tabindex="-1"></a><span class="in">  gather_emmeans_draws() |&gt; </span></span>
<span id="cb75-1352"><a href="#cb75-1352" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = bill_length_mm, y = .value)) +</span></span>
<span id="cb75-1353"><a href="#cb75-1353" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_lineribbon(size = 1, color = "cyan4") +</span></span>
<span id="cb75-1354"><a href="#cb75-1354" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_manual(values = colorspace::lighten("cyan4", c(0.95, 0.7, 0.4))) +</span></span>
<span id="cb75-1355"><a href="#cb75-1355" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_y_continuous(labels = label_comma()) +</span></span>
<span id="cb75-1356"><a href="#cb75-1356" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Bill length (mm)", y = "Predicted body mass (g)",</span></span>
<span id="cb75-1357"><a href="#cb75-1357" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "Expected values from mu and hu parts (epred = TRUE)",</span></span>
<span id="cb75-1358"><a href="#cb75-1358" aria-hidden="true" tabindex="-1"></a><span class="in">       fill = "Credible interval") +</span></span>
<span id="cb75-1359"><a href="#cb75-1359" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice() +</span></span>
<span id="cb75-1360"><a href="#cb75-1360" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = "bottom")</span></span>
<span id="cb75-1361"><a href="#cb75-1361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1362"><a href="#cb75-1362" aria-hidden="true" tabindex="-1"></a><span class="in">plot_penguins_emmeans1 &lt;- model_mass_hurdle_log |&gt; </span></span>
<span id="cb75-1363"><a href="#cb75-1363" aria-hidden="true" tabindex="-1"></a><span class="in">  emmeans(~ bill_length_mm, var = "bill_length_mm", dpar = "mu",</span></span>
<span id="cb75-1364"><a href="#cb75-1364" aria-hidden="true" tabindex="-1"></a><span class="in">          regrid = "response", tran = "log", type = "response",</span></span>
<span id="cb75-1365"><a href="#cb75-1365" aria-hidden="true" tabindex="-1"></a><span class="in">          at = list(bill_length_mm = seq(30, 60, 1))) |&gt; </span></span>
<span id="cb75-1366"><a href="#cb75-1366" aria-hidden="true" tabindex="-1"></a><span class="in">  gather_emmeans_draws() |&gt; </span></span>
<span id="cb75-1367"><a href="#cb75-1367" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(.value = exp(.value)) |&gt; </span></span>
<span id="cb75-1368"><a href="#cb75-1368" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = bill_length_mm, y = .value)) +</span></span>
<span id="cb75-1369"><a href="#cb75-1369" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_lineribbon(size = 1, color = "darkorange") +</span></span>
<span id="cb75-1370"><a href="#cb75-1370" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_manual(values = colorspace::lighten("darkorange", c(0.95, 0.7, 0.4))) +</span></span>
<span id="cb75-1371"><a href="#cb75-1371" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_y_continuous(labels = label_comma()) +</span></span>
<span id="cb75-1372"><a href="#cb75-1372" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Bill length (mm)", y = "Predicted body mass (g)",</span></span>
<span id="cb75-1373"><a href="#cb75-1373" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "Regular part of the model (dpar = \"mu\")",</span></span>
<span id="cb75-1374"><a href="#cb75-1374" aria-hidden="true" tabindex="-1"></a><span class="in">       fill = "Credible interval") +</span></span>
<span id="cb75-1375"><a href="#cb75-1375" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice() +</span></span>
<span id="cb75-1376"><a href="#cb75-1376" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = "bottom")</span></span>
<span id="cb75-1377"><a href="#cb75-1377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1378"><a href="#cb75-1378" aria-hidden="true" tabindex="-1"></a><span class="in">plot_penguins_emmeans2 &lt;- model_mass_hurdle_log |&gt; </span></span>
<span id="cb75-1379"><a href="#cb75-1379" aria-hidden="true" tabindex="-1"></a><span class="in">  emmeans(~ flipper_length_mm, var = "flipper_length_mm", dpar = "hu",</span></span>
<span id="cb75-1380"><a href="#cb75-1380" aria-hidden="true" tabindex="-1"></a><span class="in">          at = list(flipper_length_mm = seq(170, 240, 1))) |&gt; </span></span>
<span id="cb75-1381"><a href="#cb75-1381" aria-hidden="true" tabindex="-1"></a><span class="in">  gather_emmeans_draws() |&gt; </span></span>
<span id="cb75-1382"><a href="#cb75-1382" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(.value = plogis(.value)) |&gt; </span></span>
<span id="cb75-1383"><a href="#cb75-1383" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = flipper_length_mm, y = .value)) +</span></span>
<span id="cb75-1384"><a href="#cb75-1384" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_lineribbon(size = 1, color = "purple") +</span></span>
<span id="cb75-1385"><a href="#cb75-1385" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_manual(values = colorspace::lighten("purple", c(0.95, 0.7, 0.4))) +</span></span>
<span id="cb75-1386"><a href="#cb75-1386" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_y_continuous(labels = label_percent()) +</span></span>
<span id="cb75-1387"><a href="#cb75-1387" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Flipper length (mm)", y = "Predicted probability\nof seeing 0 body mass",</span></span>
<span id="cb75-1388"><a href="#cb75-1388" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "Hurdle part of the model (dpar = \"hu\")",</span></span>
<span id="cb75-1389"><a href="#cb75-1389" aria-hidden="true" tabindex="-1"></a><span class="in">       fill = "Credible interval") +</span></span>
<span id="cb75-1390"><a href="#cb75-1390" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice() +</span></span>
<span id="cb75-1391"><a href="#cb75-1391" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = "bottom")</span></span>
<span id="cb75-1392"><a href="#cb75-1392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1393"><a href="#cb75-1393" aria-hidden="true" tabindex="-1"></a><span class="in">(plot_penguins_emmeans0 / plot_penguins_emmeans1 / plot_penguins_emmeans2) +</span></span>
<span id="cb75-1394"><a href="#cb75-1394" aria-hidden="true" tabindex="-1"></a><span class="in">  plot_annotation(title = "Conditional effects of bill length and flipper length",</span></span>
<span id="cb75-1395"><a href="#cb75-1395" aria-hidden="true" tabindex="-1"></a><span class="in">                  subtitle = "Made with emmeans()",</span></span>
<span id="cb75-1396"><a href="#cb75-1396" aria-hidden="true" tabindex="-1"></a><span class="in">                  theme = theme(plot.title = element_text(family = "Jost", face = "bold"),</span></span>
<span id="cb75-1397"><a href="#cb75-1397" aria-hidden="true" tabindex="-1"></a><span class="in">                                plot.subtitle = element_text(family = "Jost")))</span></span>
<span id="cb75-1398"><a href="#cb75-1398" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-1399"><a href="#cb75-1399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1400"><a href="#cb75-1400" aria-hidden="true" tabindex="-1"></a>That trend in predicted body mass looks surprisingly linear even though we modeled it with a log-based family! In general it shows that body mass increases by <span class="in">`r percent_format(accuracy = 0.1)(m_mass_hurdle_log$bill_length_mm$estimate)`</span> for each millimeter increase in bill length. Since we used a log-based family, the actual slope on the original scale will be different across the whole range of bill length. <span class="in">`emtrends()`</span> lets us see this:</span>
<span id="cb75-1401"><a href="#cb75-1401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1402"><a href="#cb75-1402" aria-hidden="true" tabindex="-1"></a><span class="in">```{r emtrends-mass-bill-epred}</span></span>
<span id="cb75-1403"><a href="#cb75-1403" aria-hidden="true" tabindex="-1"></a><span class="in"># Slopes for the combined mu and hu parts of the model</span></span>
<span id="cb75-1404"><a href="#cb75-1404" aria-hidden="true" tabindex="-1"></a><span class="in">model_mass_hurdle_log |&gt; </span></span>
<span id="cb75-1405"><a href="#cb75-1405" aria-hidden="true" tabindex="-1"></a><span class="in">  emtrends(~ bill_length_mm, var = "bill_length_mm",</span></span>
<span id="cb75-1406"><a href="#cb75-1406" aria-hidden="true" tabindex="-1"></a><span class="in">           at = list(bill_length_mm = seq(30, 60, 10)),</span></span>
<span id="cb75-1407"><a href="#cb75-1407" aria-hidden="true" tabindex="-1"></a><span class="in">           epred = TRUE)</span></span>
<span id="cb75-1408"><a href="#cb75-1408" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-1409"><a href="#cb75-1409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1410"><a href="#cb75-1410" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-emtrends-mass-bill-range, include=FALSE}</span></span>
<span id="cb75-1411"><a href="#cb75-1411" aria-hidden="true" tabindex="-1"></a><span class="in">mfx_mass_hurdle_log &lt;- model_mass_hurdle_log |&gt; </span></span>
<span id="cb75-1412"><a href="#cb75-1412" aria-hidden="true" tabindex="-1"></a><span class="in">  emtrends(~ bill_length_mm, var = "bill_length_mm",</span></span>
<span id="cb75-1413"><a href="#cb75-1413" aria-hidden="true" tabindex="-1"></a><span class="in">           at = list(bill_length_mm = seq(30, 60, 10)),</span></span>
<span id="cb75-1414"><a href="#cb75-1414" aria-hidden="true" tabindex="-1"></a><span class="in">           epred = TRUE) |&gt; </span></span>
<span id="cb75-1415"><a href="#cb75-1415" aria-hidden="true" tabindex="-1"></a><span class="in">  as_tibble() |&gt; </span></span>
<span id="cb75-1416"><a href="#cb75-1416" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(length = xfun::numbers_to_words(bill_length_mm)) |&gt; </span></span>
<span id="cb75-1417"><a href="#cb75-1417" aria-hidden="true" tabindex="-1"></a><span class="in">  split(~ length)</span></span>
<span id="cb75-1418"><a href="#cb75-1418" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-1419"><a href="#cb75-1419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1420"><a href="#cb75-1420" aria-hidden="true" tabindex="-1"></a>For penguins with short bills like 30 mm, the slope of bill length is <span class="in">`r round(mfx_mass_hurdle_log$thirty$bill_length_mm.trend, 1)`</span>; for penguins with long bills like 60 mm, the slope is almost twice that at <span class="in">`r round(mfx_mass_hurdle_log$sixty$bill_length_mm.trend, 1)`</span>. That seems like a huge difference, but body mass ranges in the thousands of grams, so in the plot of conditional effects a 60 mm difference in slope barely registers visually.</span>
<span id="cb75-1421"><a href="#cb75-1421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1422"><a href="#cb75-1422" aria-hidden="true" tabindex="-1"></a><span class="fu">### 3. Hurdle gaussian model with a custom brms family</span></span>
<span id="cb75-1423"><a href="#cb75-1423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1424"><a href="#cb75-1424" aria-hidden="true" tabindex="-1"></a>Modeling body mass with a lognormal model works pretty well despite its fairly-normal-and-not-at-all-exponential distribution. We have to do some additional data acrobatics to convert coefficients from logs to not-logs, which can be annoying. More importantly, though, it feels weird to knowingly use the wrong family to model this outcome. The whole point of doing this hurdle model stuff is to use models that most accurately reflect the underlying data (rather than throwing OLS at everything). It would be great if we could use something like <span class="in">`hurdle_gaussian()`</span> to avoid all this roundabout log work.</span>
<span id="cb75-1425"><a href="#cb75-1425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1426"><a href="#cb75-1426" aria-hidden="true" tabindex="-1"></a>Fortunately **brms** has the ability to create custom families, and <span class="co">[</span><span class="ot">Paul Bürkner has a whole vignette about how to do it</span><span class="co">](https://cran.r-project.org/web/packages/brms/vignettes/brms_customfamilies.html)</span>. With some R and Stan magic, we can create our own <span class="in">`hurdle_gaussian()`</span> family. <span class="co">[</span><span class="ot">The vignette</span><span class="co">](https://cran.r-project.org/web/packages/brms/vignettes/brms_customfamilies.html)</span> goes into much more detail about each step, and I <span class="co">[</span><span class="ot">worked through most of it a year-ish ago after hours of googling and debugging</span><span class="co">](https://discourse.mc-stan.org/t/custom-gaussian-hurdle-family-not-quite-working-in-brms/21028)</span> (and big help from different Stan forum users). Here's the bare minimum of what's needed:</span>
<span id="cb75-1427"><a href="#cb75-1427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1428"><a href="#cb75-1428" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Create a custom **brms** family with <span class="in">`custom_family()`</span> to define the name, distributional parameters, links, and other model details. </span>
<span id="cb75-1429"><a href="#cb75-1429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1430"><a href="#cb75-1430" aria-hidden="true" tabindex="-1"></a>   Here we'll make a family that accepts arguments for <span class="in">`mu`</span>, <span class="in">`sigma`</span>, and <span class="in">`hu`</span>, which will be modeled using the identity (i.e. original) scale, log scale, and logit scale, respectively. </span>
<span id="cb75-1431"><a href="#cb75-1431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1432"><a href="#cb75-1432" aria-hidden="true" tabindex="-1"></a><span class="in">```{r custom-family-step-1, indent="   "}</span></span>
<span id="cb75-1433"><a href="#cb75-1433" aria-hidden="true" tabindex="-1"></a><span class="in">hurdle_gaussian &lt;- </span></span>
<span id="cb75-1434"><a href="#cb75-1434" aria-hidden="true" tabindex="-1"></a><span class="in"># Create a custom family that is logit if y = 0, normal/gaussian if not</span></span>
<span id="cb75-1435"><a href="#cb75-1435" aria-hidden="true" tabindex="-1"></a><span class="in">  custom_family("hurdle_gaussian", </span></span>
<span id="cb75-1436"><a href="#cb75-1436" aria-hidden="true" tabindex="-1"></a><span class="in">                dpars = c("mu", "sigma", "hu"),</span></span>
<span id="cb75-1437"><a href="#cb75-1437" aria-hidden="true" tabindex="-1"></a><span class="in">                links = c("identity", "log", "logit"),</span></span>
<span id="cb75-1438"><a href="#cb75-1438" aria-hidden="true" tabindex="-1"></a><span class="in">                lb = c(NA, 0, NA),</span></span>
<span id="cb75-1439"><a href="#cb75-1439" aria-hidden="true" tabindex="-1"></a><span class="in">                type = "real")</span></span>
<span id="cb75-1440"><a href="#cb75-1440" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-1441"><a href="#cb75-1441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1442"><a href="#cb75-1442" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Provide some raw Stan code to handle the actual sampling.</span>
<span id="cb75-1443"><a href="#cb75-1443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1444"><a href="#cb75-1444" aria-hidden="true" tabindex="-1"></a>   Here's where we tell Stan to use a binomial family when the outcome is 0 and a normal Gaussian distribution if not.</span>
<span id="cb75-1445"><a href="#cb75-1445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1446"><a href="#cb75-1446" aria-hidden="true" tabindex="-1"></a><span class="in">```{r custom-family-step-2, indent="   "}</span></span>
<span id="cb75-1447"><a href="#cb75-1447" aria-hidden="true" tabindex="-1"></a><span class="in"># Stan code</span></span>
<span id="cb75-1448"><a href="#cb75-1448" aria-hidden="true" tabindex="-1"></a><span class="in">stan_funs &lt;- "</span></span>
<span id="cb75-1449"><a href="#cb75-1449" aria-hidden="true" tabindex="-1"></a><span class="in">  real hurdle_gaussian_lpdf(real y, real mu, real sigma, real hu) { </span></span>
<span id="cb75-1450"><a href="#cb75-1450" aria-hidden="true" tabindex="-1"></a><span class="in">    if (y == 0) { </span></span>
<span id="cb75-1451"><a href="#cb75-1451" aria-hidden="true" tabindex="-1"></a><span class="in">      return bernoulli_lpmf(1 | hu); </span></span>
<span id="cb75-1452"><a href="#cb75-1452" aria-hidden="true" tabindex="-1"></a><span class="in">    } else { </span></span>
<span id="cb75-1453"><a href="#cb75-1453" aria-hidden="true" tabindex="-1"></a><span class="in">      return bernoulli_lpmf(0 | hu) +  </span></span>
<span id="cb75-1454"><a href="#cb75-1454" aria-hidden="true" tabindex="-1"></a><span class="in">             normal_lpdf(y | mu, sigma); </span></span>
<span id="cb75-1455"><a href="#cb75-1455" aria-hidden="true" tabindex="-1"></a><span class="in">    } </span></span>
<span id="cb75-1456"><a href="#cb75-1456" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb75-1457"><a href="#cb75-1457" aria-hidden="true" tabindex="-1"></a><span class="in">"</span></span>
<span id="cb75-1458"><a href="#cb75-1458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1459"><a href="#cb75-1459" aria-hidden="true" tabindex="-1"></a><span class="in"># Prepare Stan code for use in brm()</span></span>
<span id="cb75-1460"><a href="#cb75-1460" aria-hidden="true" tabindex="-1"></a><span class="in">stanvars &lt;- stanvar(scode = stan_funs, block = "functions")</span></span>
<span id="cb75-1461"><a href="#cb75-1461" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-1462"><a href="#cb75-1462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1463"><a href="#cb75-1463" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Create some post-processing functions so that things like <span class="in">`predict()`</span> work:</span>
<span id="cb75-1464"><a href="#cb75-1464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1465"><a href="#cb75-1465" aria-hidden="true" tabindex="-1"></a><span class="in">```{r custom-family-step-3, indent="   "}</span></span>
<span id="cb75-1466"><a href="#cb75-1466" aria-hidden="true" tabindex="-1"></a><span class="in">posterior_predict_hurdle_gaussian &lt;- function(i, prep, ...) {</span></span>
<span id="cb75-1467"><a href="#cb75-1467" aria-hidden="true" tabindex="-1"></a><span class="in">  mu &lt;- brms::get_dpar(prep, "mu", i = i)</span></span>
<span id="cb75-1468"><a href="#cb75-1468" aria-hidden="true" tabindex="-1"></a><span class="in">  sigma &lt;- brms::get_dpar(prep, "sigma", i = i)</span></span>
<span id="cb75-1469"><a href="#cb75-1469" aria-hidden="true" tabindex="-1"></a><span class="in">  theta &lt;- brms::get_dpar(prep, "hu", i = i)</span></span>
<span id="cb75-1470"><a href="#cb75-1470" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb75-1471"><a href="#cb75-1471" aria-hidden="true" tabindex="-1"></a><span class="in">  hu &lt;- runif(prep$ndraws, 0, 1)</span></span>
<span id="cb75-1472"><a href="#cb75-1472" aria-hidden="true" tabindex="-1"></a><span class="in">  ifelse(hu &lt; theta, 0, rnorm(prep$ndraws, mu,sigma))</span></span>
<span id="cb75-1473"><a href="#cb75-1473" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb75-1474"><a href="#cb75-1474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1475"><a href="#cb75-1475" aria-hidden="true" tabindex="-1"></a><span class="in">posterior_epred_hurdle_gaussian &lt;- function(prep) {</span></span>
<span id="cb75-1476"><a href="#cb75-1476" aria-hidden="true" tabindex="-1"></a><span class="in">  with(prep$dpars, mu * (1 - hu))</span></span>
<span id="cb75-1477"><a href="#cb75-1477" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb75-1478"><a href="#cb75-1478" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-1479"><a href="#cb75-1479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1480"><a href="#cb75-1480" aria-hidden="true" tabindex="-1"></a>And that's it!</span>
<span id="cb75-1481"><a href="#cb75-1481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1482"><a href="#cb75-1482" aria-hidden="true" tabindex="-1"></a>To use the custom family, we need to specify the name in <span class="in">`family`</span> and pass the Stan code through the <span class="in">`stanvars`</span> argument. Let's use it!</span>
<span id="cb75-1483"><a href="#cb75-1483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1484"><a href="#cb75-1484" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-mass-bill-hurdle-gaussian, cache=TRUE, warning=FALSE, results="hide"}</span></span>
<span id="cb75-1485"><a href="#cb75-1485" aria-hidden="true" tabindex="-1"></a><span class="in">model_mass_hurdle_gaussian &lt;- brm(</span></span>
<span id="cb75-1486"><a href="#cb75-1486" aria-hidden="true" tabindex="-1"></a><span class="in">  bf(body_mass_g ~ bill_length_mm + species,</span></span>
<span id="cb75-1487"><a href="#cb75-1487" aria-hidden="true" tabindex="-1"></a><span class="in">     hu ~ flipper_length_mm),</span></span>
<span id="cb75-1488"><a href="#cb75-1488" aria-hidden="true" tabindex="-1"></a><span class="in">  data = penguins,</span></span>
<span id="cb75-1489"><a href="#cb75-1489" aria-hidden="true" tabindex="-1"></a><span class="in">  family = hurdle_gaussian,  # &lt;--- This is new</span></span>
<span id="cb75-1490"><a href="#cb75-1490" aria-hidden="true" tabindex="-1"></a><span class="in">  stanvars = stanvars,  # &lt;--- This is new</span></span>
<span id="cb75-1491"><a href="#cb75-1491" aria-hidden="true" tabindex="-1"></a><span class="in">  chains = CHAINS, iter = ITER, warmup = WARMUP, seed = BAYES_SEED,</span></span>
<span id="cb75-1492"><a href="#cb75-1492" aria-hidden="true" tabindex="-1"></a><span class="in">  silent = 2</span></span>
<span id="cb75-1493"><a href="#cb75-1493" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb75-1494"><a href="#cb75-1494" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-1495"><a href="#cb75-1495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1496"><a href="#cb75-1496" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-mass-bill-hurdle-gaussian, warning=FALSE}</span></span>
<span id="cb75-1497"><a href="#cb75-1497" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_mass_hurdle_gaussian)</span></span>
<span id="cb75-1498"><a href="#cb75-1498" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-1499"><a href="#cb75-1499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1500"><a href="#cb75-1500" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-mass-bill-hurdle-gaussian, include=FALSE}</span></span>
<span id="cb75-1501"><a href="#cb75-1501" aria-hidden="true" tabindex="-1"></a><span class="in">m_mass_hurdle_gaussian &lt;- tidy(model_mass_hurdle_gaussian) |&gt; </span></span>
<span id="cb75-1502"><a href="#cb75-1502" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(term = janitor::make_clean_names(term),</span></span>
<span id="cb75-1503"><a href="#cb75-1503" aria-hidden="true" tabindex="-1"></a><span class="in">         est = round(estimate, 2)) |&gt; </span></span>
<span id="cb75-1504"><a href="#cb75-1504" aria-hidden="true" tabindex="-1"></a><span class="in">  split(~ term)</span></span>
<span id="cb75-1505"><a href="#cb75-1505" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-1506"><a href="#cb75-1506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1507"><a href="#cb75-1507" aria-hidden="true" tabindex="-1"></a>The coefficients for the hurdled part like <span class="in">`hu_(Intercept)`</span> and <span class="in">`hu_flipper_length_mm`</span> are still on the logit scale, as expected, but now the coefficients for the non-zero part are on the original regular scale! A one-mm change in bill length is associated with a <span class="in">`r m_mass_hurdle_gaussian$bill_length_mm$est`</span> gram increase in body mass; Chinstrap penguins are <span class="in">`r abs(m_mass_hurdle_gaussian$species_chinstrap$est)`</span> grams lighter than Adélie penguins, while Gentoos are <span class="in">`r m_mass_hurdle_gaussian$species_gentoo$est`</span> grams heavier than Adélies. Nothing is logged and there are no percent changes to worry about. It's all easy!</span>
<span id="cb75-1508"><a href="#cb75-1508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1509"><a href="#cb75-1509" aria-hidden="true" tabindex="-1"></a>If we use <span class="in">`pp_check()`</span> we can see that the model successfully takes the zeros into account:</span>
<span id="cb75-1510"><a href="#cb75-1510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1511"><a href="#cb75-1511" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-pp-model-mass-bill-hurdle-gaussian-fake, eval=FALSE}</span></span>
<span id="cb75-1512"><a href="#cb75-1512" aria-hidden="true" tabindex="-1"></a><span class="in">pp_check(model_mass_hurdle_gaussian)</span></span>
<span id="cb75-1513"><a href="#cb75-1513" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-1514"><a href="#cb75-1514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1515"><a href="#cb75-1515" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-pp-mass-bill-hurdle-gaussian, fig.height=3, echo=FALSE, message=FALSE}</span></span>
<span id="cb75-1516"><a href="#cb75-1516" aria-hidden="true" tabindex="-1"></a><span class="in">pp_check(model_mass_hurdle_gaussian) +</span></span>
<span id="cb75-1517"><a href="#cb75-1517" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_comma()) +</span></span>
<span id="cb75-1518"><a href="#cb75-1518" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(title = "Posterior predictive check", </span></span>
<span id="cb75-1519"><a href="#cb75-1519" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "Hurdle Gaussian model fit on data with zeros") +</span></span>
<span id="cb75-1520"><a href="#cb75-1520" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice()</span></span>
<span id="cb75-1521"><a href="#cb75-1521" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-1522"><a href="#cb75-1522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1523"><a href="#cb75-1523" aria-hidden="true" tabindex="-1"></a>The conditional/marginal effects are more straightforward now too. If we use <span class="in">`conditional_effects()`</span> we'll see a perfectly straight line:</span>
<span id="cb75-1524"><a href="#cb75-1524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1525"><a href="#cb75-1525" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-conditional-mass-hurdle-gaussian-fake, eval=FALSE}</span></span>
<span id="cb75-1526"><a href="#cb75-1526" aria-hidden="true" tabindex="-1"></a><span class="in"># No need for epred = TRUE!</span></span>
<span id="cb75-1527"><a href="#cb75-1527" aria-hidden="true" tabindex="-1"></a><span class="in">conditional_effects(model_mass_hurdle_gaussian, effects = "bill_length_mm")</span></span>
<span id="cb75-1528"><a href="#cb75-1528" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-1529"><a href="#cb75-1529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1530"><a href="#cb75-1530" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-conditional-mass-hurdle-gaussian, fig.width=7, fig.height=4.25, echo=FALSE}</span></span>
<span id="cb75-1531"><a href="#cb75-1531" aria-hidden="true" tabindex="-1"></a><span class="in">plot(conditional_effects(model_mass_hurdle_gaussian, effects = "bill_length_mm"), plot = FALSE)[[1]]$data |&gt; </span></span>
<span id="cb75-1532"><a href="#cb75-1532" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = effect1__, y = estimate__)) +</span></span>
<span id="cb75-1533"><a href="#cb75-1533" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_ribbon(aes(ymin = lower__, ymax = upper__), alpha = 0.3, color = NA) +</span></span>
<span id="cb75-1534"><a href="#cb75-1534" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(size = 1, color = "darkorange") +</span></span>
<span id="cb75-1535"><a href="#cb75-1535" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_y_continuous(labels = label_comma()) +</span></span>
<span id="cb75-1536"><a href="#cb75-1536" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Bill length (mm)", y = "Predicted body mass (g)",</span></span>
<span id="cb75-1537"><a href="#cb75-1537" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "Conditional effects of bill length on body mass, hurdle Gaussian model",</span></span>
<span id="cb75-1538"><a href="#cb75-1538" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "Combined mu and hu parts of the model") +</span></span>
<span id="cb75-1539"><a href="#cb75-1539" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice()</span></span>
<span id="cb75-1540"><a href="#cb75-1540" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-1541"><a href="#cb75-1541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1542"><a href="#cb75-1542" aria-hidden="true" tabindex="-1"></a>And if we use <span class="in">`emtrends()`</span> to check the slope of that line across different values of bill length, we'll see the same slope instead of a range from <span class="in">`r mfx_mass_hurdle_log$thirty$bill_length_mm.trend`</span> to <span class="in">`r mfx_mass_hurdle_log$sixty$bill_length_mm.trend`</span> like we saw with the hurdle lognormal family:</span>
<span id="cb75-1543"><a href="#cb75-1543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1544"><a href="#cb75-1544" aria-hidden="true" tabindex="-1"></a><span class="in">```{r emtrends-hurdle-gaussian}</span></span>
<span id="cb75-1545"><a href="#cb75-1545" aria-hidden="true" tabindex="-1"></a><span class="in">model_mass_hurdle_gaussian |&gt; </span></span>
<span id="cb75-1546"><a href="#cb75-1546" aria-hidden="true" tabindex="-1"></a><span class="in">  emtrends(~ bill_length_mm, var = "bill_length_mm",</span></span>
<span id="cb75-1547"><a href="#cb75-1547" aria-hidden="true" tabindex="-1"></a><span class="in">           at = list(bill_length_mm = seq(30, 60, 10)),</span></span>
<span id="cb75-1548"><a href="#cb75-1548" aria-hidden="true" tabindex="-1"></a><span class="in">           epred = TRUE)</span></span>
<span id="cb75-1549"><a href="#cb75-1549" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-1550"><a href="#cb75-1550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1551"><a href="#cb75-1551" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-emtrends-hurdle-gaussian, include=FALSE}</span></span>
<span id="cb75-1552"><a href="#cb75-1552" aria-hidden="true" tabindex="-1"></a><span class="in">mfx_mass_hurdle_gaussian &lt;- model_mass_hurdle_gaussian |&gt; </span></span>
<span id="cb75-1553"><a href="#cb75-1553" aria-hidden="true" tabindex="-1"></a><span class="in">  emtrends(~ bill_length_mm, var = "bill_length_mm",</span></span>
<span id="cb75-1554"><a href="#cb75-1554" aria-hidden="true" tabindex="-1"></a><span class="in">           epred = TRUE) |&gt; </span></span>
<span id="cb75-1555"><a href="#cb75-1555" aria-hidden="true" tabindex="-1"></a><span class="in">  as_tibble()</span></span>
<span id="cb75-1556"><a href="#cb75-1556" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-1557"><a href="#cb75-1557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1558"><a href="#cb75-1558" aria-hidden="true" tabindex="-1"></a>**Importantly** that slope (<span class="in">`r mfx_mass_hurdle_gaussian$bill_length_mm.trend`</span>) is different from what we found when looking at the model results with <span class="in">`tidy()`</span> (<span class="in">`r m_mass_hurdle_gaussian$bill_length_mm$est`</span>). That's because <span class="in">`emmeans()`</span> and <span class="in">`emtrends()`</span> take the zero process into account by calculating the expected value (<span class="in">`epred = TRUE`</span>).</span>
<span id="cb75-1559"><a href="#cb75-1559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1560"><a href="#cb75-1560" aria-hidden="true" tabindex="-1"></a>We can confirm that there are predicted zeros. For penguins with a shorter bill like 30 mm, the overall distribution of predicted body mass is centered around 3,000ish grams, while those with longer bills (60 mm) are predicted to be clustered around 6,000 grams. Flipper length determines the distribution of zeros (since that's the effect we built in; remember that we made it so that penguins with a flipper length of less than 190 mm have a 30% chance of being zero). The model picks this up. If we set flipper length to 189 mm (*just* under the cutoff), the model predicts a big proportion of zeros; if we set it to 210, it predicts a small proportion of zeros. </span>
<span id="cb75-1561"><a href="#cb75-1561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1562"><a href="#cb75-1562" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-predicted-mass-hurdle-gaussian, fig.width=7.5, fig.height=5.5, out.width="100%"}</span></span>
<span id="cb75-1563"><a href="#cb75-1563" aria-hidden="true" tabindex="-1"></a><span class="in">pred_mass_hurdle_gaussian &lt;- model_mass_hurdle_gaussian |&gt; </span></span>
<span id="cb75-1564"><a href="#cb75-1564" aria-hidden="true" tabindex="-1"></a><span class="in">  predicted_draws(newdata = expand_grid(bill_length_mm = c(30, 60),</span></span>
<span id="cb75-1565"><a href="#cb75-1565" aria-hidden="true" tabindex="-1"></a><span class="in">                                        species = "Adelie",</span></span>
<span id="cb75-1566"><a href="#cb75-1566" aria-hidden="true" tabindex="-1"></a><span class="in">                                        flipper_length_mm = c(189, 210))) |&gt;</span></span>
<span id="cb75-1567"><a href="#cb75-1567" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(is_zero = .prediction == 0,</span></span>
<span id="cb75-1568"><a href="#cb75-1568" aria-hidden="true" tabindex="-1"></a><span class="in">         .prediction = ifelse(is_zero, .prediction - 0.1, .prediction)) |&gt; </span></span>
<span id="cb75-1569"><a href="#cb75-1569" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(nice_bill = paste0(bill_length_mm, " mm bill"),</span></span>
<span id="cb75-1570"><a href="#cb75-1570" aria-hidden="true" tabindex="-1"></a><span class="in">         nice_flipper = paste0(flipper_length_mm, " mm flippers"))</span></span>
<span id="cb75-1571"><a href="#cb75-1571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1572"><a href="#cb75-1572" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(pred_mass_hurdle_gaussian, aes(x = .prediction)) +</span></span>
<span id="cb75-1573"><a href="#cb75-1573" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_histogram(aes(fill = is_zero), binwidth = 100, </span></span>
<span id="cb75-1574"><a href="#cb75-1574" aria-hidden="true" tabindex="-1"></a><span class="in">                 boundary = 0, color = "white") +</span></span>
<span id="cb75-1575"><a href="#cb75-1575" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0) + </span></span>
<span id="cb75-1576"><a href="#cb75-1576" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_comma()) +</span></span>
<span id="cb75-1577"><a href="#cb75-1577" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_manual(values = c("darkorange", "purple"), </span></span>
<span id="cb75-1578"><a href="#cb75-1578" aria-hidden="true" tabindex="-1"></a><span class="in">                    guide = guide_legend(reverse = TRUE)) +</span></span>
<span id="cb75-1579"><a href="#cb75-1579" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Predicted body mass (g)", y = NULL, fill = "Is zero?",</span></span>
<span id="cb75-1580"><a href="#cb75-1580" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "Predicted body mass across different bill and flipper lengths",</span></span>
<span id="cb75-1581"><a href="#cb75-1581" aria-hidden="true" tabindex="-1"></a><span class="in">       subitlte = "Results from hurdled Gaussian model") +</span></span>
<span id="cb75-1582"><a href="#cb75-1582" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_nested_wrap(vars(nice_bill, nice_flipper), nrow = 2, </span></span>
<span id="cb75-1583"><a href="#cb75-1583" aria-hidden="true" tabindex="-1"></a><span class="in">                    strip = strip_nested(</span></span>
<span id="cb75-1584"><a href="#cb75-1584" aria-hidden="true" tabindex="-1"></a><span class="in">                      text_x = list(element_text(family = "Jost", </span></span>
<span id="cb75-1585"><a href="#cb75-1585" aria-hidden="true" tabindex="-1"></a><span class="in">                                                 face = "bold"), NULL),</span></span>
<span id="cb75-1586"><a href="#cb75-1586" aria-hidden="true" tabindex="-1"></a><span class="in">                      background_x = list(element_rect(fill = "grey92"), NULL),</span></span>
<span id="cb75-1587"><a href="#cb75-1587" aria-hidden="true" tabindex="-1"></a><span class="in">                      by_layer_x = TRUE)) +</span></span>
<span id="cb75-1588"><a href="#cb75-1588" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice() +</span></span>
<span id="cb75-1589"><a href="#cb75-1589" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = "bottom")</span></span>
<span id="cb75-1590"><a href="#cb75-1590" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-1591"><a href="#cb75-1591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1592"><a href="#cb75-1592" aria-hidden="true" tabindex="-1"></a>And that's it! A fully working hurdle Gaussian model in **brms**! This single model contains an incredible amount of detail about all these different moving parts. Magical!</span>
<span id="cb75-1593"><a href="#cb75-1593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1594"><a href="#cb75-1594" aria-hidden="true" tabindex="-1"></a><span class="fu">#### I lied—this custom family isn't all the way complete!</span></span>
<span id="cb75-1595"><a href="#cb75-1595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1596"><a href="#cb75-1596" aria-hidden="true" tabindex="-1"></a>It would be really neat to have <span class="in">`hurdle_gaussian()`</span> as an official native family in **brms**, and the <span class="co">[</span><span class="ot">vignette makes it sound like it's possible to submit a pull request</span><span class="co">](https://cran.r-project.org/web/packages/brms/vignettes/brms_customfamilies.html#turning-a-custom-family-into-a-native-family)</span> to formally add custom families like this, BUT what I have here doesn't *quite* work all the way.</span>
<span id="cb75-1597"><a href="#cb75-1597" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1598"><a href="#cb75-1598" aria-hidden="true" tabindex="-1"></a>We're still missing one post-processing function for calculating the log likelihood for the family. If we try to use a function that relies on the log likelihood like <span class="in">`loo()`</span>, we'll get an error:</span>
<span id="cb75-1599"><a href="#cb75-1599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1600"><a href="#cb75-1600" aria-hidden="true" tabindex="-1"></a><span class="in">```{r loo-hurdle-gausian-oh-no, error=TRUE}</span></span>
<span id="cb75-1601"><a href="#cb75-1601" aria-hidden="true" tabindex="-1"></a><span class="in">loo(model_mass_hurdle_gaussian)</span></span>
<span id="cb75-1602"><a href="#cb75-1602" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-1603"><a href="#cb75-1603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1604"><a href="#cb75-1604" aria-hidden="true" tabindex="-1"></a>In addition to the <span class="in">`posterior_predict_hurdle_gaussian()`</span> and <span class="in">`posterior_epred_hurdle_gaussian()`</span> functions we defined earlier, we also need a <span class="in">`log_lik_hurdle_gaussian()`</span> function. The only problem is that *I have no idea how to make this*. </span>
<span id="cb75-1605"><a href="#cb75-1605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1606"><a href="#cb75-1606" aria-hidden="true" tabindex="-1"></a><span class="in">```{r skeleton-loo-hurdle-gaussian, eval=FALSE}</span></span>
<span id="cb75-1607"><a href="#cb75-1607" aria-hidden="true" tabindex="-1"></a><span class="in"># idk</span></span>
<span id="cb75-1608"><a href="#cb75-1608" aria-hidden="true" tabindex="-1"></a><span class="in">log_lik_hurdle_gaussian &lt;- function(???) {</span></span>
<span id="cb75-1609"><a href="#cb75-1609" aria-hidden="true" tabindex="-1"></a><span class="in">  # ????????</span></span>
<span id="cb75-1610"><a href="#cb75-1610" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb75-1611"><a href="#cb75-1611" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-1612"><a href="#cb75-1612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1613"><a href="#cb75-1613" aria-hidden="true" tabindex="-1"></a>Alas.</span>
<span id="cb75-1614"><a href="#cb75-1614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-1615"><a href="#cb75-1615" aria-hidden="true" tabindex="-1"></a>Despite this, for now the custom hurdle Gaussian model works well for most other things.</span></code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p><span class="faux-block">Forked from <a href="https://www.andrewheiss.com/">Andrew Heiss</a></span> # <span class="faux-block"><a href="https://github.com/andrewheiss/ath-quarto">View the source at <i class="fa-brands fa-github" aria-label="github"></i> GitHub</a></span></p>
</div>
  </div>
</footer>


</body></html>