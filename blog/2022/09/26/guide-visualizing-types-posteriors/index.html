<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Andrew Heiss">
<meta name="description" content="A guide to different types of Bayesian posterior distributions and the nuances of posterior_predict, posterior_epred, and posterior_linpred">
<title>Visualizing the differences between Bayesian posterior predictions, linear predictions, and the expectation of posterior predictions | Andrew Heiss – Andrew Heiss</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../../../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../../../">
<link href="../../../../..//files/favicon-512.png" rel="icon" type="image/png">
<script src="../../../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../../../site_libs/quarto-html/quarto-syntax-highlighting-17c909d5fd25ae21b861c0c7a49b2096.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../../../site_libs/bootstrap/bootstrap-5cd0811f461c8271ae6bab49df9501be.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<link href="../../../../../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../../../../../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<script src="../../../../../site_libs/quarto-contrib/iconify-2.0.0/iconify-icon.min.js"></script><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script type="text/javascript">

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-527449-5', 'auto');

ga('send', {
  hitType: 'pageview',
  'anonymizeIp': true,
});
</script><style>

      .quarto-title-block .quarto-title-banner {
        background: #170C3A;
      }
</style>
<script src="../../../../../site_libs/kePrint-0.0.1/kePrint.js"></script><link href="../../../../../site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
<meta property="og:title" content="Visualizing the differences between Bayesian posterior predictions, linear predictions, and the expectation of posterior predictions | Andrew Heiss">
<meta property="og:description" content="A guide to different types of Bayesian posterior distributions and the nuances of posterior_predict, posterior_epred, and posterior_linpred">
<meta property="og:image" content="https://www.andrewheiss.com/blog/2022/09/26/guide-visualizing-types-posteriors/index_files/figure-html/plot-logit-predictions-1.png">
<meta property="og:site_name" content="Andrew Heiss">
<meta property="og:locale" content="en_US">
<meta property="og:image:height" content="2304">
<meta property="og:image:width" content="1728">
<meta name="twitter:title" content="Visualizing the differences between Bayesian posterior predictions, linear predictions, and the expectation of posterior predictions | Andrew Heiss">
<meta name="twitter:description" content="A guide to different types of Bayesian posterior distributions and the nuances of posterior_predict, posterior_epred, and posterior_linpred">
<meta name="twitter:image" content="https://www.andrewheiss.com/blog/2022/09/26/guide-visualizing-types-posteriors/index_files/figure-html/plot-logit-predictions-1.png">
<meta name="twitter:creator" content="@andrewheiss">
<meta name="twitter:site" content="@andrewheiss">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image-height" content="2304">
<meta name="twitter:image-width" content="1728">
</head>
<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../../../index.html">
    <span class="navbar-title">Andrew Heiss</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link" href="../../../../../index.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../cv/index.html"> 
<span class="menu-text">CV</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../blog/index.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../research/index.html"> 
<span class="menu-text">Research</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../teaching/index.html"> 
<span class="menu-text">Teaching</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../talks/index.html"> 
<span class="menu-text">Talks</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../now/index.html"> 
<span class="menu-text">Now</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../uses/index.html"> 
<span class="menu-text">Uses</span></a>
  </li>  
</ul>
<ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item">
    <a class="nav-link" href="../../../../../atom.xml"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:rss" style="font-size: 1.1em;" aria-label="Icon rss from bi Iconify.design set." title="RSS"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="mailto:aheiss@gsu.edu"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:envelope" style="font-size: 1.1em;" aria-label="Icon envelope from bi Iconify.design set." title="E-mail"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://bsky.app/profile/andrew.heiss.phd" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="fa6-brands:bluesky" style="font-size: 1.1em;" aria-label="Icon bluesky from fa6-brands Iconify.design set." title="Bluesky"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://fediscience.org/users/andrew/" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:mastodon" style="font-size: 1.1em;" aria-label="Icon mastodon from bi Iconify.design set." title="Mastodon"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/andrewheiss" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:github" style="font-size: 1.1em;" aria-label="Icon github from bi Iconify.design set." title="GitHub"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.youtube.com/andrewheiss" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:youtube" style="font-size: 1.1em;" aria-label="Icon youtube from bi Iconify.design set." title="YouTube"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.heissatopia.com/"> 
<span class="menu-text"><iconify-icon inline="" icon="fa6-brands:blogger" style="font-size: 1.15em;" aria-label="Icon blogger from fa6-brands Iconify.design set." title="Blogger"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.linkedin.com/in/andrewheiss" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:linkedin" style="font-size: 1.1em;" aria-label="Icon linkedin from bi Iconify.design set." title="LinkedIn"></iconify-icon></span></a>
  </li>  
</ul>
</div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><header id="title-block-header" class="quarto-title-block default blog-post page-columns page-full"><div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">Visualizing the differences between Bayesian posterior predictions, linear predictions, and the expectation of posterior predictions</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
                  <div>
        <div class="description">
          A guide to different types of Bayesian posterior distributions and the nuances of posterior_predict, posterior_epred, and posterior_linpred
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">r</div>
                <div class="quarto-category">tidyverse</div>
                <div class="quarto-category">ggplot</div>
                <div class="quarto-category">regression</div>
                <div class="quarto-category">bayes</div>
                <div class="quarto-category">brms</div>
                <div class="quarto-category">stan</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p><a href="https://www.andrewheiss.com/">Andrew Heiss</a> <a href="https://orcid.org/0000-0002-3948-3914" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">Monday, September 26, 2022</p>
      </div>
    </div>
    
      
      <div>
      <div class="quarto-title-meta-heading">Doi</div>
      <div class="quarto-title-meta-contents">
        <p class="doi">
          <a href="https://doi.org/10.59350/xge39-emt86">10.59350/xge39-emt86</a>
        </p>
      </div>
    </div>
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Contents</h2>
   
  <ul>
<li><a href="#normal-gaussian-model" id="toc-normal-gaussian-model" class="nav-link active" data-scroll-target="#normal-gaussian-model">Normal Gaussian model</a></li>
  <li>
<a href="#generalized-linear-models-with-link-transformations" id="toc-generalized-linear-models-with-link-transformations" class="nav-link" data-scroll-target="#generalized-linear-models-with-link-transformations">Generalized linear models with link transformations</a>
  <ul class="collapse">
<li><a href="#logistic-regression-example" id="toc-logistic-regression-example" class="nav-link" data-scroll-target="#logistic-regression-example">Logistic regression example</a></li>
  </ul>
</li>
  <li>
<a href="#distributional-models-with-link-transformations" id="toc-distributional-models-with-link-transformations" class="nav-link" data-scroll-target="#distributional-models-with-link-transformations">Distributional models with link transformations</a>
  <ul class="collapse">
<li><a href="#beta-regression-example" id="toc-beta-regression-example" class="nav-link" data-scroll-target="#beta-regression-example">Beta regression example</a></li>
  <li><a href="#bonus-playing-with-posterior-beta-parameters" id="toc-bonus-playing-with-posterior-beta-parameters" class="nav-link" data-scroll-target="#bonus-playing-with-posterior-beta-parameters">Bonus: Playing with posterior beta parameters</a></li>
  </ul>
</li>
  <li><a href="#when-posterior_epred-isnt-just-the-back-transformed-linear-predictor" id="toc-when-posterior_epred-isnt-just-the-back-transformed-linear-predictor" class="nav-link" data-scroll-target="#when-posterior_epred-isnt-just-the-back-transformed-linear-predictor">When <code>posterior_epred()</code> isn’t just the back-transformed linear predictor</a></li>
  <li>
<a href="#tldr-diagrams-and-cheat-sheets" id="toc-tldr-diagrams-and-cheat-sheets" class="nav-link" data-scroll-target="#tldr-diagrams-and-cheat-sheets">tl;dr: Diagrams and cheat sheets</a>
  <ul class="collapse">
<li><a href="#normal-gaussian-models" id="toc-normal-gaussian-models" class="nav-link" data-scroll-target="#normal-gaussian-models">Normal Gaussian models</a></li>
  <li><a href="#generalized-linear-models-with-link-transformations-logistic-regression-example" id="toc-generalized-linear-models-with-link-transformations-logistic-regression-example" class="nav-link" data-scroll-target="#generalized-linear-models-with-link-transformations-logistic-regression-example">Generalized linear models with link transformations (logistic regression example)</a></li>
  <li><a href="#distributional-models-with-link-transformations-beta-regression-example" id="toc-distributional-models-with-link-transformations-beta-regression-example" class="nav-link" data-scroll-target="#distributional-models-with-link-transformations-beta-regression-example">Distributional models with link transformations (beta regression example)</a></li>
  <li><a href="#complete-cheat-sheet" id="toc-complete-cheat-sheet" class="nav-link" data-scroll-target="#complete-cheat-sheet">Complete cheat sheet</a></li>
  </ul>
</li>
  </ul></nav>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content"><div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Downloadable cheat sheets!
</div>
</div>
<div class="callout-body-container callout-body">
<p>You can download PDF, SVG, and PNG versions of the diagrams and cheat sheets in this post, as well as the original Adobe Illustrator and InDesign files, <a href="#tldr-diagrams-and-cheat-sheets">at the bottom of this post</a></p>
<p>Do whatever you want with them! They’re licensed under <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike (BY-SA 4.0)</a>.</p>
</div>
</div>
<p>I’ve been working with Bayesian models and the Stan-based <strong>brms</strong> ecosystem (<strong>tidybayes</strong>, <strong>ggdist</strong>, <strong>marginaleffects</strong>, and friends) for a few years now, and I’m currently finally working through formal materials on Bayesianism and running an <a href="https://bayesf22.classes.andrewheiss.com/">independent readings class</a> with a PhD student at GSU where we’re reading <a href="https://xcelab.net/rm/statistical-rethinking/">Richard McElreath’s <em>Statistical Rethinking</em></a> and <a href="https://www.bayesrulesbook.com/">Alicia Johnson, Miles Ott, and Mine Dogucu’s <em>Bayes Rules!</em></a>, both of which are fantastic books (check out <a href="https://bayesf22-notebook.classes.andrewheiss.com/">my translation of their materials to tidyverse/brms here</a>).</p>
<p>Something that has always plagued me about working with Bayesian posterior distributions, but that I’ve always waved off as too hard to think about, has been the differences between posterior predictions, the expectation of the posterior predictive distribution, and the posterior of the linear predictor (or <code>posterior_predict()</code>, <code>posterior_epred()</code>, and <code>posterior_linpred()</code> in the <strong>brms</strong> world). But reading these two books has forced me to finally figure it out.</p>
<p>So here’s an explanation of my mental model of the differences between these types of posterior distributions. It’s definitely not 100% correct, but it makes sense for me.</p>
<p>For bonus fun, <a href="#tldr-diagrams-and-cheat-sheets">skip down to the incredibly useful diagrams and cheat sheets at the bottom of this post</a>.</p>
<p>Let’s load some packages, load some data, and get started!</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>        <span class="co"># ggplot, dplyr, and friends</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com">patchwork</a></span><span class="op">)</span>        <span class="co"># Combine ggplot plots</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://wilkelab.org/ggtext/">ggtext</a></span><span class="op">)</span>           <span class="co"># Fancier text in ggplot plots</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://scales.r-lib.org">scales</a></span><span class="op">)</span>           <span class="co"># Labeling functions</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/paul-buerkner/brms">brms</a></span><span class="op">)</span>             <span class="co"># Bayesian modeling through Stan</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mjskay.github.io/tidybayes/">tidybayes</a></span><span class="op">)</span>        <span class="co"># Manipulate Stan objects in a tidy way</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://marginaleffects.com/">marginaleffects</a></span><span class="op">)</span>  <span class="co"># Calculate marginal effects</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://modelr.tidyverse.org">modelr</a></span><span class="op">)</span>           <span class="co"># For quick model grids</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/twolodzko/extraDistr">extraDistr</a></span><span class="op">)</span>       <span class="co"># For dprop() beta distribution with mu/phi</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://pkg.mitchelloharawild.com/distributional/">distributional</a></span><span class="op">)</span>   <span class="co"># For plotting distributions with ggdist</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://allisonhorst.github.io/palmerpenguins/">palmerpenguins</a></span><span class="op">)</span>   <span class="co"># Penguins!</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://haozhu233.github.io/kableExtra/">kableExtra</a></span><span class="op">)</span>       <span class="co"># For nicer tables</span></span>
<span></span>
<span><span class="co"># Make random things reproducible</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Bayes stuff</span></span>
<span><span class="co"># Use the cmdstanr backend for Stan because it's faster and more modern than</span></span>
<span><span class="co"># the default rstan. You need to install the cmdstanr package first</span></span>
<span><span class="co"># (https://mc-stan.org/cmdstanr/) and then run cmdstanr::install_cmdstan() to</span></span>
<span><span class="co"># install cmdstan on your computer.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>mc.cores <span class="op">=</span> <span class="fl">4</span>,  <span class="co"># Use 4 cores</span></span>
<span>        brms.backend <span class="op">=</span> <span class="st">"cmdstanr"</span><span class="op">)</span></span>
<span><span class="va">bayes_seed</span> <span class="op">&lt;-</span> <span class="fl">1234</span></span>
<span></span>
<span><span class="co"># Colors from MetBrewer</span></span>
<span><span class="va">clrs</span> <span class="op">&lt;-</span> <span class="fu">MetBrewer</span><span class="fu">::</span><span class="fu">met.brewer</span><span class="op">(</span><span class="st">"Java"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Custom ggplot themes to make pretty plots</span></span>
<span><span class="co"># Get Roboto Condensed at https://fonts.google.com/specimen/Roboto+Condensed</span></span>
<span><span class="co"># Get Roboto Mono at https://fonts.google.com/specimen/Roboto+Mono</span></span>
<span><span class="va">theme_pred</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span>base_family <span class="op">=</span> <span class="st">"Roboto Condensed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">theme</span><span class="op">(</span>panel.grid.minor <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>          plot.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"white"</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>,</span>
<span>          plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>          strip.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>          strip.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"grey80"</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>,</span>
<span>          axis.title.x <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>          axis.title.y <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>          legend.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">theme_pred_dist</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">theme_pred</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">theme</span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu">element_markdown</span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Roboto Condensed"</span>, face <span class="op">=</span> <span class="st">"plain"</span><span class="op">)</span>,</span>
<span>          plot.subtitle <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Roboto Mono"</span>, size <span class="op">=</span> <span class="fu">rel</span><span class="op">(</span><span class="fl">0.9</span><span class="op">)</span>, hjust <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>          axis.text.y <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>          panel.grid.major.y <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>          panel.grid.minor.y <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">theme_pred_range</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">theme_pred</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">theme</span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu">element_markdown</span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Roboto Condensed"</span>, face <span class="op">=</span> <span class="st">"plain"</span><span class="op">)</span>,</span>
<span>          plot.subtitle <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Roboto Mono"</span>, size <span class="op">=</span> <span class="fu">rel</span><span class="op">(</span><span class="fl">0.9</span><span class="op">)</span>, hjust <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>          panel.grid.minor.y <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">update_geom_defaults</span><span class="op">(</span><span class="st">"text"</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Roboto Condensed"</span>, lineheight <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Add a couple new variables to the penguins data:</span></span>
<span><span class="co">#  - is_gentoo: Indicator for whether or not the penguin is a Gentoo</span></span>
<span><span class="co">#  - bill_ratio: The ratio of a penguin's bill depth (height) to its bill length</span></span>
<span><span class="va">penguins</span> <span class="op">&lt;-</span> <span class="va">penguins</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">drop_na</span><span class="op">(</span><span class="va">sex</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>is_gentoo <span class="op">=</span> <span class="va">species</span> <span class="op">==</span> <span class="st">"Gentoo"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>bill_ratio <span class="op">=</span> <span class="va">bill_depth_mm</span> <span class="op">/</span> <span class="va">bill_length_mm</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="normal-gaussian-model" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="normal-gaussian-model">Normal Gaussian model</h2>
<p>First we’ll look at basic linear regression. Normal or Gaussian models are roughly equivalent to frequentist ordinary least squares (OLS) regression. We estimate an intercept and a slope and draw a line through the data. If we include multiple explanatory variables or predictors, we’ll have multiple slopes, or partial derivatives or marginal effects (<a href="https://www.andrewheiss.com/blog/2022/05/20/marginalia/">see here for more about that</a>). But to keep things as simple and basic and illustrative as possible, we’ll just use one explanatory variable here.</p>
<p>In this example, we’re interested in the relationship between penguin flipper length and penguin body mass. Do penguins with longer flippers weigh more? Here’s what the data looks like:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">penguins</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">flipper_length_mm</span>, y <span class="op">=</span> <span class="va">body_mass_g</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1</span>, alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_smooth</span><span class="op">(</span>method <span class="op">=</span> <span class="st">"lm"</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span>, se <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_comma</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2000</span>, <span class="fl">6000</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Flipper length (mm)"</span>, y <span class="op">=</span> <span class="st">"Body mass (g)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_pred</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-mass-flipper-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>It seems like there’s a pretty clear relationship between the two. As flipper length increases, body mass also increases.</p>
<p>We can create a more formal model for the distribution of body mass, conditional on different values of flipper length, like this:</p>
<p><span class="math display">\[
\begin{aligned}
\text{Body mass}_i &amp;\sim \operatorname{Normal}(\mu_i, \sigma) \\
\mu_i &amp;= \alpha + \beta \ \text{Flipper length}_i
\end{aligned}
\]</span></p>
<p>Or more generally:</p>
<p><span class="math display">\[
\begin{aligned}
y_i &amp;\sim \operatorname{Normal}(\mu_i, \sigma) \\
\mu_i &amp;= \alpha + \beta x_i
\end{aligned}
\]</span></p>
<p>This implies that body mass follows a normal (or Gaussian) distribution with some average (<span class="math inline">\(\mu\)</span>) and some amount of spread (<span class="math inline">\(\sigma\)</span>), and that the <span class="math inline">\(\mu\)</span> parameter is conditional on (or based on, or dependent on) flipper length.</p>
<p>Let’s run that model in Stan through <strong>brms</strong> (with all the default priors; in real life you’d want to set more official priors for the intercept <span class="math inline">\(\alpha\)</span>, the coefficient <span class="math inline">\(\beta\)</span>, and the overall model spread <span class="math inline">\(\sigma\)</span>)</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/model-normal_511331ea89cae094056b0b05668ce544">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_normal</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span></span>
<span>  <span class="fu">bf</span><span class="op">(</span><span class="va">body_mass_g</span> <span class="op">~</span> <span class="va">flipper_length_mm</span><span class="op">)</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">penguins</span></span>
<span><span class="op">)</span></span>
<span><span class="co">## Start sampling</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If we look at the model results, we can see the means of the posterior distributions of each of the model’s parameters (<span class="math inline">\(\alpha\)</span>, <span class="math inline">\(\beta\)</span>, and <span class="math inline">\(\sigma\)</span>). The intercept (<span class="math inline">\(\alpha\)</span>) is huge and negative because flipper length is far away from 0, so it’s pretty uninterpretable. The <span class="math inline">\(\beta\)</span> coefficient shows that a one-mm increase in flipper length is associated with a 50 gram increase in body mass. And the overall model standard deviation <span class="math inline">\(\sigma\)</span> shows that there’s roughly 400 grams of deviation around the mean body mass.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">broom.mixed</span><span class="fu">::</span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_normal</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">bind_cols</span><span class="op">(</span>parameter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"α"</span>, <span class="st">"β"</span>, <span class="st">"σ"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">parameter</span>, <span class="va">term</span>, <span class="va">estimate</span>, <span class="va">std.error</span>, <span class="va">conf.low</span>, <span class="va">conf.high</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 3 × 6</span></span>
<span><span class="co">##   parameter term              estimate std.error conf.low conf.high</span></span>
<span><span class="co">##   &lt;chr&gt;     &lt;chr&gt;                &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 α         (Intercept)        -5874.     311.    -6466.    -5257. </span></span>
<span><span class="co">## 2 β         flipper_length_mm     50.2      1.54     47.1      53.1</span></span>
<span><span class="co">## 3 σ         sd__Observation      394.      15.7     366.      426.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>That table shows just the posterior means for each of these parameters, but these are technically all complete distributions. In this post we’re not interested in these actual values—we’re concerned with the outcome, or penguin weight here. (But you can see <a href="https://www.andrewheiss.com/blog/2022/05/20/marginalia/">this post</a> or <a href="https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/">this post</a> or <a href="https://www.andrewheiss.com/blog/2022/05/09/hurdle-lognormal-gaussian-brms/">this post</a> or <a href="https://mjskay.github.io/tidybayes/articles/tidy-brms.html">this documentation</a> for more about working with these coefficients and calculating marginal effects)</p>
<p>Going back to the formal model, so far we’ve looked at <span class="math inline">\(\alpha\)</span>, <span class="math inline">\(\beta\)</span>, and <span class="math inline">\(\sigma\)</span>, but what about <span class="math inline">\(\mu\)</span> and the overall posterior distribution of the outcome <span class="math inline">\(y\)</span> (or <span class="math inline">\(\operatorname{Normal}(\mu_i, \sigma)\)</span>)? This is where life gets a little trickier (and why this guide exists in the first place!). Both <span class="math inline">\(\mu\)</span> and the posterior for <span class="math inline">\(y\)</span> represent penguin body mass, but conceptually they’re different things. We’ll extract these different distributions with three different <strong>brms</strong> functions: <code>posterior_predict()</code>, <code>posterior_epred()</code>, and <code>posterior_linpred()</code> (the code uses <code>predicted_draws()</code>, <code>epred_draws()</code>, and <code>linpred_draws()</code>; these are <strong>tidybayes</strong>’s wrappers for the corresponding <strong>brms</strong> functions).</p>
<p>Note the <code>newdata</code> argument here. We have to feed a data frame of values to plug into to make these different posterior predictions. We could feed the original dataset with <code>newdata = penguins</code>, which would plug each row of the data into the model and generate 4000 posterior draws for it. Given that there are 333 rows in penguins data, using <code>newdata = penguins</code> would give us 333 × 4,000 = 1,332,000 rows. That’s a ton of data, and looking at it all together like that isn’t super useful unless we look at predictions across a range of possible predictors. We’ll do that later in this section and see the posterior predictions of weights across a range of flipper lengths. But here we’re just interested in the prediction of the outcome based on a single value of flipper lengths. We’ll use the average (200.967 mm), but it could easily be the median or whatever arbitrary number we want.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Make a little dataset of just the average flipper length</span></span>
<span><span class="va">penguins_avg_flipper</span> <span class="op">&lt;-</span> <span class="va">penguins</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>flipper_length_mm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">flipper_length_mm</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract different types of posteriors</span></span>
<span><span class="va">normal_linpred</span> <span class="op">&lt;-</span> <span class="va">model_normal</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">linpred_draws</span><span class="op">(</span>newdata <span class="op">=</span> <span class="va">penguins_avg_flipper</span><span class="op">)</span></span>
<span></span>
<span><span class="va">normal_epred</span> <span class="op">&lt;-</span> <span class="va">model_normal</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">epred_draws</span><span class="op">(</span>newdata <span class="op">=</span> <span class="va">penguins_avg_flipper</span><span class="op">)</span></span>
<span></span>
<span><span class="va">normal_predicted</span> <span class="op">&lt;-</span> <span class="va">model_normal</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">predicted_draws</span><span class="op">(</span>newdata <span class="op">=</span> <span class="va">penguins_avg_flipper</span>,</span>
<span>                  seed <span class="op">=</span> <span class="fl">12345</span><span class="op">)</span>  <span class="co"># So that the manual results with rnorm() are the same later</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>These each show the posterior distribution of penguin weight, and each corresponds to a different part of the formal mathematical model with. We can explore these nuances if we look at these distributions’ means, medians, standard deviations, and overall shapes:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">summary_normal_linpred</span> <span class="op">&lt;-</span> <span class="va">normal_linpred</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="va">.linpred</span>, <span class="fu">lst</span><span class="op">(</span><span class="va">mean</span>, <span class="va">sd</span>, <span class="va">median</span><span class="op">)</span>, .names <span class="op">=</span> <span class="st">"{.fn}"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">summary_normal_epred</span> <span class="op">&lt;-</span> <span class="va">normal_epred</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="va">.epred</span>, <span class="fu">lst</span><span class="op">(</span><span class="va">mean</span>, <span class="va">sd</span>, <span class="va">median</span><span class="op">)</span>, .names <span class="op">=</span> <span class="st">"{.fn}"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">summary_normal_predicted</span> <span class="op">&lt;-</span> <span class="va">normal_predicted</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="va">.prediction</span>, <span class="fu">lst</span><span class="op">(</span><span class="va">mean</span>, <span class="va">sd</span>, <span class="va">median</span><span class="op">)</span>, .names <span class="op">=</span> <span class="st">"{.fn}"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tribble</span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">Function</span>, <span class="op">~</span><span class="va">`Model element`</span>,</span>
<span>  <span class="st">"&lt;code&gt;posterior_linpred()&lt;/code&gt;"</span>, <span class="st">"\\(\\mu\\) in the model"</span>,</span>
<span>  <span class="st">"&lt;code&gt;posterior_epred()&lt;/code&gt;"</span>, <span class="st">"\\(\\operatorname{E(y)}\\) and \\(\\mu\\) in the model"</span>,</span>
<span>  <span class="st">"&lt;code&gt;posterior_predict()&lt;/code&gt;"</span>, <span class="st">"Random draws from posterior \\(\\operatorname{Normal}(\\mu_i, \\sigma)\\)"</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">bind_cols</span><span class="op">(</span><span class="fu">bind_rows</span><span class="op">(</span><span class="va">summary_normal_linpred</span>, <span class="va">summary_normal_epred</span>, <span class="va">summary_normal_predicted</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">kbl</span><span class="op">(</span>escape <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">kable_styling</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div id="tbl-normal-posteriors" class="cell quarto-float quarto-figure quarto-figure-center anchored page-columns page-full" data-layout-align="center">
<figure class="quarto-float quarto-float-tbl figure page-columns page-full"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-normal-posteriors-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: Normal posteriors
</figcaption><div aria-describedby="tbl-normal-posteriors-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<div class="cell-output-display column-page-inset-right">
<table class="table do-not-create-environment cell caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead><tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Function</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Model element</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mean</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">sd</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">median</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>posterior_linpred()</code></td>
<td style="text-align: left;">\(\mu\) in the model</td>
<td style="text-align: right;">4206</td>
<td style="text-align: right;">21.8</td>
<td style="text-align: right;">4207</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>posterior_epred()</code></td>
<td style="text-align: left;">\(\operatorname{E(y)}\) and \(\mu\) in the model</td>
<td style="text-align: right;">4206</td>
<td style="text-align: right;">21.8</td>
<td style="text-align: right;">4207</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>posterior_predict()</code></td>
<td style="text-align: left;">Random draws from posterior \(\operatorname{Normal}(\mu_i, \sigma)\)</td>
<td style="text-align: right;">4207</td>
<td style="text-align: right;">386.7</td>
<td style="text-align: right;">4209</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">normal_linpred</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">.linpred</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_comma</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4100</span>, <span class="fl">4300</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Body mass (g)"</span>, y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"**Linear predictor** &lt;span style='font-size: 14px;'&gt;*µ* in the model&lt;/span&gt;"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"posterior_linpred(..., tibble(flipper_length_mm = 201))"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_pred_dist</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu">element_markdown</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">normal_epred</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">.epred</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_comma</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4100</span>, <span class="fl">4300</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Body mass (g)"</span>, y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"**Expectation of the posterior** &lt;span style='font-size: 14px;'&gt;E[*y*] and *µ* in the model&lt;/span&gt;"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"posterior_epred(..., tibble(flipper_length_mm = 201))"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_pred_dist</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">normal_predicted</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">.prediction</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_comma</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2900</span>, <span class="fl">5500</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Body mass (g)"</span>, y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"**Posterior predictions** &lt;span style='font-size: 14px;'&gt;Random draws from posterior Normal(*µ*, *σ*)&lt;/span&gt;"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"posterior_predict(..., tibble(flipper_length_mm = 201))"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_pred_dist</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="va">p1</span> <span class="op">/</span> <span class="fu">plot_spacer</span><span class="op">(</span><span class="op">)</span> <span class="op">/</span> <span class="va">p2</span> <span class="op">/</span> <span class="fu">plot_spacer</span><span class="op">(</span><span class="op">)</span> <span class="op">/</span> <span class="va">p3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">plot_layout</span><span class="op">(</span>heights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="fl">0.05</span>, <span class="fl">0.3</span>, <span class="fl">0.05</span>, <span class="fl">0.3</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-normal-posteriors-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>The most obvious difference between these different posterior predictions is the range of predictions. For <code>posterior_linpred()</code> and <code>posterior_epred()</code>, the standard error is tiny and the range of plausible predicted values is really narrow. For <code>posterior_predict()</code>, the standard error is substantially bigger, and the corresponding range of predicted values is huge.</p>
<p>To understand why, let’s explore the math going on behind the scenes in these functions. Both <code>posterior_linpred()</code> and <code>posterior_epred()</code> correspond to the <span class="math inline">\(\mu\)</span> part of the model. They’re the average penguin weight as predicted by the linear model (hence <code>linpred</code>; <strong>lin</strong>ear <strong>pred</strong>ictor). We can see this if we plug a 201 mm flipper length into each row of the posterior and calculate <code>mu</code> by hand with <span class="math inline">\(\beta_0 + (\beta_1 \times 201)\)</span>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">linpred_manual</span> <span class="op">&lt;-</span> <span class="va">model_normal</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">spread_draws</span><span class="op">(</span><span class="va">b_Intercept</span>, <span class="va">b_flipper_length_mm</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>mu <span class="op">=</span> <span class="va">b_Intercept</span> <span class="op">+</span> </span>
<span>           <span class="op">(</span><span class="va">b_flipper_length_mm</span> <span class="op">*</span> <span class="va">penguins_avg_flipper</span><span class="op">$</span><span class="va">flipper_length_mm</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">linpred_manual</span></span>
<span><span class="co">## # A tibble: 4,000 × 6</span></span>
<span><span class="co">##    .chain .iteration .draw b_Intercept b_flipper_length_mm    mu</span></span>
<span><span class="co">##     &lt;int&gt;      &lt;int&gt; &lt;int&gt;       &lt;dbl&gt;               &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">##  1      1          1     1      -6152.                51.5 4204.</span></span>
<span><span class="co">##  2      1          2     2      -5872                 50.2 4221.</span></span>
<span><span class="co">##  3      1          3     3      -6263.                52.1 4202.</span></span>
<span><span class="co">##  4      1          4     4      -6066.                51.1 4213.</span></span>
<span><span class="co">##  5      1          5     5      -5740.                49.4 4191.</span></span>
<span><span class="co">##  6      1          6     6      -5678.                49.2 4213.</span></span>
<span><span class="co">##  7      1          7     7      -6107.                51.1 4160.</span></span>
<span><span class="co">##  8      1          8     8      -5422.                48.0 4235.</span></span>
<span><span class="co">##  9      1          9     9      -6303.                52.1 4177.</span></span>
<span><span class="co">## 10      1         10    10      -6193.                51.6 4184.</span></span>
<span><span class="co">## # ℹ 3,990 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>That <code>mu</code> column is identical to what we calculate with <code>posterior_linpred()</code>. Just to confirm, we can plot the two distributions:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">p1_manual</span> <span class="op">&lt;-</span> <span class="va">linpred_manual</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">mu</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span>fill <span class="op">=</span> <span class="fu">colorspace</span><span class="fu">::</span><span class="fu">lighten</span><span class="op">(</span><span class="va">clrs</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_comma</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4100</span>, <span class="fl">4300</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Body mass (g)"</span>, y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"**Linear predictor** &lt;span style='font-size: 14px;'&gt;*µ* in the model&lt;/span&gt;"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"b_Intercept + (b_flipper_length_mm * 201)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_pred_dist</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu">element_markdown</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p1_manual</span> <span class="op">|</span> <span class="va">p1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/plot-linpred-manual-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page-inset-right" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Importantly, the distribution of the <span class="math inline">\(\mu\)</span> part of the model here does <em>not</em> incorporate information about <span class="math inline">\(\sigma\)</span>. That’s why the distribution is so narrow.</p>
<p>The results from <code>posterior_predict()</code>, on the other hand, correspond to the <span class="math inline">\(y\)</span> part of the model. Officially, they are draws from a random normal distribution using <em>both</em> the estimated <span class="math inline">\(\mu\)</span> and the estimated <span class="math inline">\(\sigma\)</span>. These results contain the full uncertainty of the posterior distribution of penguin weight. To help with the intuition, we can do the same thing by hand when plugging in a 201 mm flipper length:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">12345</span><span class="op">)</span>  <span class="co"># To get the same results as posterior_predict() from earlier</span></span>
<span></span>
<span><span class="va">postpred_manual</span> <span class="op">&lt;-</span> <span class="va">model_normal</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">spread_draws</span><span class="op">(</span><span class="va">b_Intercept</span>, <span class="va">b_flipper_length_mm</span>, <span class="va">sigma</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>mu <span class="op">=</span> <span class="va">b_Intercept</span> <span class="op">+</span> </span>
<span>           <span class="op">(</span><span class="va">b_flipper_length_mm</span> <span class="op">*</span> </span>
<span>              <span class="va">penguins_avg_flipper</span><span class="op">$</span><span class="va">flipper_length_mm</span><span class="op">)</span>,  <span class="co"># This is posterior_linpred()</span></span>
<span>         y_new <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span>, mean <span class="op">=</span> <span class="va">mu</span>, sd <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>  <span class="co"># This is posterior_predict()</span></span>
<span></span>
<span><span class="va">postpred_manual</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">.draw</span><span class="op">:</span><span class="va">y_new</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 4,000 × 6</span></span>
<span><span class="co">##    .draw b_Intercept b_flipper_length_mm sigma    mu y_new</span></span>
<span><span class="co">##    &lt;int&gt;       &lt;dbl&gt;               &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">##  1     1      -6152.                51.5  384. 4204. 4429.</span></span>
<span><span class="co">##  2     2      -5872                 50.2  401. 4221. 4506.</span></span>
<span><span class="co">##  3     3      -6263.                52.1  390. 4202. 4159.</span></span>
<span><span class="co">##  4     4      -6066.                51.1  409. 4213. 4027.</span></span>
<span><span class="co">##  5     5      -5740.                49.4  362. 4191. 4411.</span></span>
<span><span class="co">##  6     6      -5678.                49.2  393. 4213. 3499.</span></span>
<span><span class="co">##  7     7      -6107.                51.1  417. 4160. 4423.</span></span>
<span><span class="co">##  8     8      -5422.                48.0  351. 4235. 4138.</span></span>
<span><span class="co">##  9     9      -6303.                52.1  426. 4177. 4055.</span></span>
<span><span class="co">## 10    10      -6193.                51.6  426. 4184. 3793.</span></span>
<span><span class="co">## # ℹ 3,990 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>That <code>y_new</code> column here is the <span class="math inline">\(y\)</span> part of the model and should have a lot more uncertainty than the <code>mu</code> column, which is just the <span class="math inline">\(\mu\)</span> part of the model. Notably, the <code>y_new</code> column is the same as what we get when using <code>posterior predict()</code>. We’ll plot the two distributions to confirm:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">p3_manual</span> <span class="op">&lt;-</span> <span class="va">postpred_manual</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">y_new</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span>fill <span class="op">=</span> <span class="fu">colorspace</span><span class="fu">::</span><span class="fu">lighten</span><span class="op">(</span><span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_comma</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2900</span>, <span class="fl">5500</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Body mass (g)"</span>, y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"**Posterior predictions** &lt;span style='font-size: 14px;'&gt;Random draws from posterior Normal(*µ*, *σ*)&lt;/span&gt;"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"rnorm(b_Intercept + (b_flipper_length_mm * 201), sigma)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_pred_dist</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu">element_markdown</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p3_manual</span> <span class="op">|</span> <span class="va">p3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/plot-postpred-manual-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page-inset-right" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>The results from <code>posterior_predict()</code> and <code>posterior_linpred()</code> have the same mean, but the full posterior predictions that incorporate the estimated <span class="math inline">\(\sigma\)</span> have a much wider range of plausible values.</p>
<p>The results from <code>posterior_epred()</code> are a little strange to understand, and in the case of normal/Gaussian regression (and many other types of regression models!), they’re identical to the linear predictor (<code>posterior_linpred()</code>). These are the posterior draws of the expected value or mean of the the posterior distribution, or <span class="math inline">\(E(y_i)\)</span> in the model. Behind the scenes, this is calculated by taking the average of each row’s posterior distribution and then taking the average of <em>that</em>.</p>
<p>Once again, a quick illustration can help. As before, we’ll manually plug a flipper length of 201 mm into the posterior estimates of the intercept and slope to calculate the <span class="math inline">\(\mu\)</span> part of the model. We’ll then use that <span class="math inline">\(\mu\)</span> along with the estimated <span class="math inline">\(\sigma\)</span> to in <code><a href="https://rdrr.io/r/stats/Normal.html">rnorm()</a></code> to generate the posterior predictive distribution, or the <span class="math inline">\(y\)</span> part of the model. Finally, we’ll take the average of the <code>y_new</code> posterior predictive distribution to get the expectation of the posterior predictive distribution, or <code>epred</code>. It’s the same as what we get when using <code>posterior_epred()</code>; the only differences are because of randomness.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">epred_manual</span> <span class="op">&lt;-</span> <span class="va">model_normal</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">spread_draws</span><span class="op">(</span><span class="va">b_Intercept</span>, <span class="va">b_flipper_length_mm</span>, <span class="va">sigma</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>mu <span class="op">=</span> <span class="va">b_Intercept</span> <span class="op">+</span> </span>
<span>           <span class="op">(</span><span class="va">b_flipper_length_mm</span> <span class="op">*</span> </span>
<span>              <span class="va">penguins_avg_flipper</span><span class="op">$</span><span class="va">flipper_length_mm</span><span class="op">)</span>,  <span class="co"># This is posterior_linpred()</span></span>
<span>         y_new <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span>, mean <span class="op">=</span> <span class="va">mu</span>, sd <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>  <span class="co"># This is posterior_predict()</span></span>
<span></span>
<span><span class="co"># This is posterior_epred()</span></span>
<span><span class="va">epred_manual</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>epred <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">y_new</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 1 × 1</span></span>
<span><span class="co">##   epred</span></span>
<span><span class="co">##   &lt;dbl&gt;</span></span>
<span><span class="co">## 1 4204.</span></span>
<span></span>
<span><span class="co"># It's essentially the same as the actual posterior_epred()</span></span>
<span><span class="va">normal_epred</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span>epred <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">.epred</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 1 × 1</span></span>
<span><span class="co">##   epred</span></span>
<span><span class="co">##   &lt;dbl&gt;</span></span>
<span><span class="co">## 1 4206.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For mathy reasons, in Gaussian regression, this <span class="math inline">\(\operatorname{E(y)}\)</span> happens to be identical to the linear predictor <span class="math inline">\(\mu\)</span>, so the results from <code>posterior_linpred()</code> and <code>posterior_epred()</code> are identical. And—fun fact—the <strong>brms</strong> code for <code>posterior_epred()</code> for Gaussian models doesn’t recalculate the average of the posterior. <a href="https://github.com/paul-buerkner/brms/blob/28f778d7933f95422dda8f9a9f4333b975261120/R/posterior_epred.R#L341">It just returns the linear predictor</a> <span class="math inline">\(\mu\)</span>.</p>
<p>We can also look at these different types of posterior predictions across a range of possible flipper lengths. There’s a lot more uncertainty in the full posterior, since it incorporates the uncertainty of both <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\sigma\)</span>, while the uncertainty of the linear predictor/expected value of the posterior is much more narrow (and equivalent in this case):</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="va">penguins</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">data_grid</span><span class="op">(</span>flipper_length_mm <span class="op">=</span> <span class="fu">seq_range</span><span class="op">(</span><span class="va">flipper_length_mm</span>, n <span class="op">=</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">add_linpred_draws</span><span class="op">(</span><span class="va">model_normal</span>, ndraws <span class="op">=</span> <span class="fl">100</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">flipper_length_mm</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_lineribbon</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">.linpred</span><span class="op">)</span>, .width <span class="op">=</span> <span class="fl">0.95</span>,</span>
<span>                  alpha <span class="op">=</span> <span class="fl">0.5</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, fill <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>data <span class="op">=</span> <span class="va">penguins</span>, <span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">body_mass_g</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1</span>, alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_comma</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2000</span>, <span class="fl">6000</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Flipper length (mm)"</span>, y <span class="op">=</span> <span class="st">"Body mass (g)"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"**Linear predictor** &lt;span style='font-size: 14px;'&gt;*µ* in the model&lt;/span&gt;"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"posterior_linpred()"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_pred_range</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="va">penguins</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">data_grid</span><span class="op">(</span>flipper_length_mm <span class="op">=</span> <span class="fu">seq_range</span><span class="op">(</span><span class="va">flipper_length_mm</span>, n <span class="op">=</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">add_epred_draws</span><span class="op">(</span><span class="va">model_normal</span>, ndraws <span class="op">=</span> <span class="fl">100</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">flipper_length_mm</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_lineribbon</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">.epred</span><span class="op">)</span>, .width <span class="op">=</span> <span class="fl">0.95</span>,</span>
<span>                  alpha <span class="op">=</span> <span class="fl">0.5</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, fill <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>data <span class="op">=</span> <span class="va">penguins</span>, <span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">body_mass_g</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1</span>, alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_comma</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2000</span>, <span class="fl">6000</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Flipper length (mm)"</span>, y <span class="op">=</span> <span class="st">"Body mass (g)"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"**Expectation of the posterior** &lt;span style='font-size: 14px;'&gt;E[*y*] and *µ* in the model&lt;/span&gt;"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"posterior_epred()"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_pred_range</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p3</span> <span class="op">&lt;-</span> <span class="va">penguins</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">data_grid</span><span class="op">(</span>flipper_length_mm <span class="op">=</span> <span class="fu">seq_range</span><span class="op">(</span><span class="va">flipper_length_mm</span>, n <span class="op">=</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">add_predicted_draws</span><span class="op">(</span><span class="va">model_normal</span>, ndraws <span class="op">=</span> <span class="fl">100</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">flipper_length_mm</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_lineribbon</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">.prediction</span><span class="op">)</span>, .width <span class="op">=</span> <span class="fl">0.95</span>,</span>
<span>                  alpha <span class="op">=</span> <span class="fl">0.5</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, fill <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>data <span class="op">=</span> <span class="va">penguins</span>, <span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">body_mass_g</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1</span>, alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_comma</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2000</span>, <span class="fl">6000</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Flipper length (mm)"</span>, y <span class="op">=</span> <span class="st">"Body mass (g)"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"**Posterior predictions** &lt;span style='font-size: 14px;'&gt;Random draws from posterior Normal(*µ*, *σ*)&lt;/span&gt;"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"posterior_predict()"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_pred_range</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="va">p1</span> <span class="op">/</span> <span class="fu">plot_spacer</span><span class="op">(</span><span class="op">)</span> <span class="op">/</span> <span class="va">p2</span> <span class="op">/</span> <span class="fu">plot_spacer</span><span class="op">(</span><span class="op">)</span> <span class="op">/</span> <span class="va">p3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">plot_layout</span><span class="op">(</span>heights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="fl">0.05</span>, <span class="fl">0.3</span>, <span class="fl">0.05</span>, <span class="fl">0.3</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-normal-predictions-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>Phew. There are a lot of moving parts here with different types of posteriors and averages and variances. Here’s a helpful diagram that shows how everything is connected and which R functions calculate which parts:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="images/normal@3x.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page-inset-right" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section><section id="generalized-linear-models-with-link-transformations" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="generalized-linear-models-with-link-transformations">Generalized linear models with link transformations</h2>
<p>Generalized linear models (e.g., logistic, probit, ordered logistic, exponential, Poisson, negative binomial, etc.) use special link functions (e.g.&nbsp;logit, log, etc.) to transform the likelihood of an outcome into a scale that is more amenable to linear regression.</p>
<p>Estimates from these models can be used in their transformed scales (e.g., log odds in logistic regression) or can be back-transformed into their original scale (e.g., probabilities in logistic regression).</p>
<p>When working with links, the various Bayesian prediction functions return values on different scales, each corresponding to different parts of the model.</p>
<section id="logistic-regression-example" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="logistic-regression-example">Logistic regression example</h3>
<p>To show how different link functions work with posteriors from generalized linear models, we’ll use logistic regression with a single explanatory variable (again, for the sake of illustrative simplicity). We’re interested in whether a penguin’s bill length can predict if a penguin is a <a href="https://en.wikipedia.org/wiki/Gentoo_penguin">Gentoo</a> or not. Here’s what the data looks like—Gentoos seem to have taller bills than their Chinstrap and Adélie counterparts.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">penguins</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">bill_length_mm</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">is_gentoo</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_dots</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>side <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">is_gentoo</span>, <span class="st">"bottom"</span>, <span class="st">"top"</span><span class="op">)</span><span class="op">)</span>, </span>
<span>            pch <span class="op">=</span> <span class="fl">19</span>, color <span class="op">=</span> <span class="st">"grey20"</span>, scale <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_smooth</span><span class="op">(</span>method <span class="op">=</span> <span class="st">"glm"</span>, method.args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">binomial</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"logit"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>              color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span>, se <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_percent</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Bill length (mm)"</span>, y <span class="op">=</span> <span class="st">"Probability of being a Gentoo"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_pred</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-gentoo-bill-depth-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>We ultimately want to model that curvy line, but working with regular slopes and intercepts makes it tricky, since the data is all constrained between 0% and 100% and the line is, um, curvy. If we were economists we could just <a href="https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/#1-linear-probability-models">stick a straight line on that graph, call it a linear probability model, and be done</a>. But that’s weird.</p>
<p>Instead, we can transform the outcome variable from 0s and 1s into logged odds or logits, which creates a nice straight line that we can use with regular old linear regression. Again, I won’t go into the details of how logistic regression works here (see <a href="https://evalf22.classes.andrewheiss.com/example/matching-ipw.html#oversimplified-crash-course-in-logistic-regression">this example</a> or <a href="https://uc-r.github.io/logistic_regression">this tutorial</a> or <a href="https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/#2-fractional-logistic-regression">this post</a> or <a href="http://post8000.svmiller.com/lab-scripts/logistic-regression-lab.html">this post</a> for lots more about it).</p>
<p>Just know that logits (or log odds) are a transformation of probabilities (<span class="math inline">\(p\)</span>) into a different scale using on this formula:</p>
<p><span class="math display">\[
\operatorname{logit}(p) = \log\left(\frac{p}{1 - p}\right)
\]</span></p>
<p>This plot shows the relationship between the two scales. Probabilities range from 0 to 1, while logits typically range from −4 to 4ish, where logit of 0 is a <span class="math inline">\(p\)</span> of 0.5. There are big changes in probability between −4ish and 4ish, but once you start getting into the 5s and beyond, the probability is all essentially the same.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tibble</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">8</span>, <span class="fl">8</span>, by <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html">plogis</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Logit scale"</span>, y <span class="op">=</span> <span class="st">"Probability scale"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_pred</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-logit-p-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>We can create a formal model for the probability of being a Gentoo following a binomial distribution with a size of 1 (i.e.&nbsp;the distribution contains only 0s and 1s—either the penguin is a Gentoo or it is not), and a probability <span class="math inline">\(\pi\)</span> that is conditional on different values of bill length:</p>
<p><span class="math display">\[
\begin{aligned}
\text{Is Gentoo?}_i &amp;\sim \operatorname{Binomial}(1, \pi_i) \\
\operatorname{logit}(\pi_i) &amp;= \alpha + \beta \ \text{Bill length}_i
\end{aligned}
\]</span></p>
<p>Or more generally,</p>
<p><span class="math display">\[
\begin{aligned}
y_i &amp;\sim \operatorname{Binomial}(1, \pi_i) \\
\operatorname{logit}(\pi_i) &amp;= \alpha + \beta x_i
\end{aligned}
\]</span></p>
<p>Model time! Again, we’re using all the default priors here—in real life you’d want to set more official priors for the intercept <span class="math inline">\(\alpha\)</span> and the coefficient <span class="math inline">\(\beta\)</span>, especially since <span class="math inline">\(\beta\)</span> is <a href="https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/#set-better-priors">on the logit scale and unlikely to ever be bigger than 3 or 4</a>.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/model-logit_f8262747e0ce1b530d2c0bfa4b371b40">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_logit</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span></span>
<span>  <span class="fu">bf</span><span class="op">(</span><span class="va">is_gentoo</span> <span class="op">~</span> <span class="va">bill_length_mm</span><span class="op">)</span>,</span>
<span>  family <span class="op">=</span> <span class="fu">bernoulli</span><span class="op">(</span>link <span class="op">=</span> <span class="st">"logit"</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">penguins</span></span>
<span><span class="op">)</span></span>
<span><span class="co">## Start sampling</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We could look at these coefficients and interpret their marginal effects, but here we’re more interested in the distribution of the outcome, not the coefficients (see <a href="https://www.andrewheiss.com/blog/2022/05/20/marginalia/#where-this-subtle-difference-really-matters">here</a> or <a href="http://post8000.svmiller.com/lab-scripts/logistic-regression-lab.html">here</a> or <a href="https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/#2-fractional-logistic-regression">here</a> for examples of how to interpret logistic regression coefficients).</p>
<p>Let’s again extract these different posterior distributions with the three main <strong>brms</strong> functions: <code>posterior_linpred()</code>, <code>posterior_epred()</code>, and <code>posterior_predict()</code>. We’ll look at the posterior distribution when <code>bill_length_mm</code> is its average value, or 43.993:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Make a little dataset of just the average bill length</span></span>
<span><span class="va">penguins_avg_bill</span> <span class="op">&lt;-</span> <span class="va">penguins</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>bill_length_mm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">bill_length_mm</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract different types of posteriors</span></span>
<span><span class="va">logit_linpred</span> <span class="op">&lt;-</span> <span class="va">model_logit</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">linpred_draws</span><span class="op">(</span>newdata <span class="op">=</span> <span class="va">penguins_avg_bill</span><span class="op">)</span></span>
<span></span>
<span><span class="va">logit_epred</span> <span class="op">&lt;-</span> <span class="va">model_logit</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">epred_draws</span><span class="op">(</span>newdata <span class="op">=</span> <span class="va">penguins_avg_bill</span><span class="op">)</span></span>
<span></span>
<span><span class="va">logit_predicted</span> <span class="op">&lt;-</span> <span class="va">model_logit</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">predicted_draws</span><span class="op">(</span>newdata <span class="op">=</span> <span class="va">penguins_avg_bill</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>These each show the posterior distribution of being a Gentoo, but unlike the Gaussian posteriors we looked at earlier, each of these is measured completely differently now!</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">summary_logit_linpred</span> <span class="op">&lt;-</span> <span class="va">logit_linpred</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="va">.linpred</span>, <span class="fu">lst</span><span class="op">(</span><span class="va">mean</span>, <span class="va">sd</span>, <span class="va">median</span><span class="op">)</span>, .names <span class="op">=</span> <span class="st">"{.fn}"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">summary_logit_epred</span> <span class="op">&lt;-</span> <span class="va">logit_epred</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="va">.epred</span>, <span class="fu">lst</span><span class="op">(</span><span class="va">mean</span>, <span class="va">sd</span>, <span class="va">median</span><span class="op">)</span>, .names <span class="op">=</span> <span class="st">"{.fn}"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">summary_logit_predicted</span> <span class="op">&lt;-</span> <span class="va">logit_predicted</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="va">.prediction</span>, <span class="fu">lst</span><span class="op">(</span><span class="va">mean</span><span class="op">)</span>, .names <span class="op">=</span> <span class="st">"{.fn}"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tribble</span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">Function</span>, <span class="op">~</span><span class="va">`Model element`</span>, <span class="op">~</span><span class="va">Values</span>,</span>
<span>  <span class="st">"&lt;code&gt;posterior_linpred()&lt;/code&gt;"</span>, <span class="st">"\\(\\operatorname{logit}(\\pi)\\) in the model"</span>, <span class="st">"Logits or log odds"</span>,</span>
<span>  <span class="st">"&lt;code&gt;posterior_linpred(transform = TRUE)&lt;/code&gt; or &lt;code&gt;posterior_epred()&lt;/code&gt;"</span>, <span class="st">"\\(\\operatorname{E(y)}\\) and \\(\\pi\\) in the model"</span>, <span class="st">"Probabilities"</span>,</span>
<span>  <span class="st">"&lt;code&gt;posterior_predict()&lt;/code&gt;"</span>, <span class="st">"Random draws from posterior \\(\\operatorname{Binomial}(1, \\pi)\\)"</span>, <span class="st">"0s and 1s"</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">bind_cols</span><span class="op">(</span><span class="fu">bind_rows</span><span class="op">(</span><span class="va">summary_logit_linpred</span>, <span class="va">summary_logit_epred</span>, <span class="va">summary_logit_predicted</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">kbl</span><span class="op">(</span>escape <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">kable_styling</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div id="tbl-logit-posteriors" class="cell quarto-float quarto-figure quarto-figure-center anchored page-columns page-full" data-layout-align="center">
<figure class="quarto-float quarto-float-tbl figure page-columns page-full"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-logit-posteriors-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2: Logit posteriors
</figcaption><div aria-describedby="tbl-logit-posteriors-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<div class="cell-output-display column-page-inset-right">
<table class="table do-not-create-environment cell caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead><tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Function</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Model element</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Values</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mean</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">sd</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">median</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>posterior_linpred()</code></td>
<td style="text-align: left;">\(\operatorname{logit}(\pi)\) in the model</td>
<td style="text-align: left;">Logits or log odds</td>
<td style="text-align: right;">-0.798</td>
<td style="text-align: right;">0.138</td>
<td style="text-align: right;">-0.796</td>
</tr>
<tr class="even">
<td style="text-align: left;">
<code>posterior_linpred(transform = TRUE)</code> or <code>posterior_epred()</code>
</td>
<td style="text-align: left;">\(\operatorname{E(y)}\) and \(\pi\) in the model</td>
<td style="text-align: left;">Probabilities</td>
<td style="text-align: right;">0.311</td>
<td style="text-align: right;">0.029</td>
<td style="text-align: right;">0.311</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>posterior_predict()</code></td>
<td style="text-align: left;">Random draws from posterior \(\operatorname{Binomial}(1, \pi)\)</td>
<td style="text-align: left;">0s and 1s</td>
<td style="text-align: right;">0.306</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">logit_linpred</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">.linpred</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1.5</span>, <span class="op">-</span><span class="fl">0.2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Logit-transformed probability of being a Gentoo"</span>, y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"**Linear predictor** &lt;span style='font-size: 14px;'&gt;logit(*π*) in the model&lt;/span&gt;"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"posterior_linpred(..., tibble(bill_length_mm = 44))"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_pred_dist</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">logit_epred</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">.epred</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_percent</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.45</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Probability of being a Gentoo"</span>, y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"**Expectation of the posterior** &lt;span style='font-size: 14px;'&gt;E[*y*] and *π* in the model&lt;/span&gt;"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"posterior_epred(..., tibble(bill_length_mm = 44))"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_pred_dist</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p3</span> <span class="op">&lt;-</span> <span class="va">logit_predicted</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">count</span><span class="op">(</span>is_gentoo <span class="op">=</span> <span class="va">.prediction</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>prop <span class="op">=</span> <span class="va">n</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>,</span>
<span>         prop_nice <span class="op">=</span> <span class="fu">label_percent</span><span class="op">(</span>accuracy <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span><span class="op">(</span><span class="va">prop</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">is_gentoo</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_col</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_text</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">prop_nice</span><span class="op">)</span>, nudge_y <span class="op">=</span> <span class="op">-</span><span class="fl">300</span>, color <span class="op">=</span> <span class="st">"white"</span>, size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_discrete</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Not Gentoo (0)"</span>, <span class="st">"Gentoo (1)"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_comma</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Prediction of being a Gentoo"</span>, y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"**Posterior predictions** &lt;span style='font-size: 14px;'&gt;Random draws from posterior Binomial(1, *π*)&lt;/span&gt;"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"posterior_predict(..., tibble(bill_length_mm = 44))"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_pred_range</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>panel.grid.major.x <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="va">p1</span> <span class="op">/</span> <span class="fu">plot_spacer</span><span class="op">(</span><span class="op">)</span> <span class="op">/</span> <span class="va">p2</span> <span class="op">/</span> <span class="fu">plot_spacer</span><span class="op">(</span><span class="op">)</span> <span class="op">/</span> <span class="va">p3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">plot_layout</span><span class="op">(</span>heights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="fl">0.05</span>, <span class="fl">0.3</span>, <span class="fl">0.05</span>, <span class="fl">0.3</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-logit-posteriors-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>Unlike the Gaussian/normal regression from earlier, the results from <code>posterior_epred()</code> and <code>posterior_linpred()</code> are not identical here. They still both correspond to the <span class="math inline">\(\pi\)</span> part of the model, but on different scales. <code>posterior_epred()</code> provides results on the probability scale, un-logiting and back-transforming the results from <code>posterior_linpred()</code> (which provides results on the logit scale).</p>
<p>Again, <em>technically</em>, <code>posterior_epred()</code> isn’t just the back-transformed linear predictor (if you want that, you can use <code>posterior_linpred(..., transform = TRUE)</code>). More formally, <code>posterior_epred()</code> returns the expected values of the posterior, or <span class="math inline">\(\operatorname{E(y)}\)</span>, or the average of the posterior’s averages. But as with Gaussian regression, for mathy reasons this average-of-averages happens to be the same as the back-transformed <span class="math inline">\(\pi\)</span>, so <span class="math inline">\(E(y) = \operatorname{inverse logit}(\pi)\)</span>.</p>
<p>The results from <code>posterior_predict()</code> are draws from a random binomial distribution using the estimated <span class="math inline">\(\pi\)</span>, and they consist of only 0s and 1s (not Gentoo and Gentoo).</p>
<p>Showing these posterior predictions across a range of bill lengths also helps with the intuition here and illustrates the different scales and values that these posterior functions return:</p>
<ul>
<li>
<code>posterior_linpred()</code> returns the value of <span class="math inline">\(\pi\)</span> on the logit scale</li>
<li>
<code>posterior_epred()</code> returns the value of <span class="math inline">\(\pi\)</span> on the probability scale (technically it’s returning <span class="math inline">\(\operatorname{E(y)}\)</span>, but in practice those are identical here)</li>
<li>
<code>posterior_predict()</code> returns 0s and 1s, plotted here as points at bill lengths of 35, 45, and 55 mm</li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pred_logit_gentoo</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span>bill_length_mm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">35</span>, <span class="fl">45</span>, <span class="fl">55</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">add_predicted_draws</span><span class="op">(</span><span class="va">model_logit</span>, ndraws <span class="op">=</span> <span class="fl">500</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pred_logit_gentoo_summary</span> <span class="op">&lt;-</span> <span class="va">pred_logit_gentoo</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">bill_length_mm</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>prop <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">.prediction</span><span class="op">)</span>,</span>
<span>            prop_nice <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu">label_percent</span><span class="op">(</span>accuracy <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span><span class="op">(</span><span class="va">prop</span><span class="op">)</span>, <span class="st">"\nGentoos"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="va">penguins</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">data_grid</span><span class="op">(</span>bill_length_mm <span class="op">=</span> <span class="fu">seq_range</span><span class="op">(</span><span class="va">bill_length_mm</span>, n <span class="op">=</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">add_linpred_draws</span><span class="op">(</span><span class="va">model_logit</span>, ndraws <span class="op">=</span> <span class="fl">100</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">bill_length_mm</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_lineribbon</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">.linpred</span><span class="op">)</span>, .width <span class="op">=</span> <span class="fl">0.95</span>,</span>
<span>                  alpha <span class="op">=</span> <span class="fl">0.5</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, fill <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">60</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Bill length (mm)"</span>, y <span class="op">=</span> <span class="st">"Logit-transformed\nprobability of being a Gentoo"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"**Linear predictor posterior** &lt;span style='font-size: 14px;'&gt;logit(*π*) in the model&lt;/span&gt;"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"posterior_linpred()"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_pred_range</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="va">penguins</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">data_grid</span><span class="op">(</span>bill_length_mm <span class="op">=</span> <span class="fu">seq_range</span><span class="op">(</span><span class="va">bill_length_mm</span>, n <span class="op">=</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">add_epred_draws</span><span class="op">(</span><span class="va">model_logit</span>, ndraws <span class="op">=</span> <span class="fl">100</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">bill_length_mm</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_dots</span><span class="op">(</span>data <span class="op">=</span> <span class="va">penguins</span>, <span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">is_gentoo</span><span class="op">)</span>, x <span class="op">=</span> <span class="va">bill_length_mm</span>, </span>
<span>                                 side <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">is_gentoo</span>, <span class="st">"bottom"</span>, <span class="st">"top"</span><span class="op">)</span><span class="op">)</span>, </span>
<span>            pch <span class="op">=</span> <span class="fl">19</span>, color <span class="op">=</span> <span class="st">"grey20"</span>, scale <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_lineribbon</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">.epred</span><span class="op">)</span>, .width <span class="op">=</span> <span class="fl">0.95</span>,</span>
<span>                  alpha <span class="op">=</span> <span class="fl">0.5</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, fill <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_percent</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">60</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Bill length (mm)"</span>, y <span class="op">=</span> <span class="st">"Probability of\nbeing a Gentoo"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"**Expectation of the posterior** &lt;span style='font-size: 14px;'&gt;E[*y*] and *π* in the model&lt;/span&gt;"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"posterior_epred()"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_pred_range</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">pred_logit_gentoo</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">bill_length_mm</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">.prediction</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>position <span class="op">=</span> <span class="fu">position_jitter</span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.2</span>, height <span class="op">=</span> <span class="fl">0.1</span>, seed <span class="op">=</span> <span class="fl">1234</span><span class="op">)</span>,</span>
<span>             size <span class="op">=</span> <span class="fl">0.75</span>, alpha <span class="op">=</span> <span class="fl">0.3</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_text</span><span class="op">(</span>data <span class="op">=</span> <span class="va">pred_logit_gentoo_summary</span>, <span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="fl">0.5</span>, label <span class="op">=</span> <span class="va">prop_nice</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span>  </span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Not\nGentoo"</span>, <span class="st">"Gentoo"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Bill length (mm)"</span>, y <span class="op">=</span> <span class="st">"Prediction of\nbeing a Gentoo"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"**Posterior predictions** &lt;span style='font-size: 14px;'&gt;Random draws from posterior Binomial(1, *π*)&lt;/span&gt;"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"posterior_predict()"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_pred_range</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>panel.grid.major.x <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>        panel.grid.major.y <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.text.y <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span>, hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="va">p1</span> <span class="op">/</span> <span class="fu">plot_spacer</span><span class="op">(</span><span class="op">)</span> <span class="op">/</span> <span class="va">p2</span> <span class="op">/</span> <span class="fu">plot_spacer</span><span class="op">(</span><span class="op">)</span> <span class="op">/</span> <span class="va">p3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">plot_layout</span><span class="op">(</span>heights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="fl">0.05</span>, <span class="fl">0.3</span>, <span class="fl">0.05</span>, <span class="fl">0.3</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-logit-predictions-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>There are a lot more moving parts here than with Gaussian regression, with different types of posteriors measured on three different scales! This diagram summarizes everything:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="images/logistic@3x.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page-inset-right" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section></section><section id="distributional-models-with-link-transformations" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="distributional-models-with-link-transformations">Distributional models with link transformations</h2>
<p>Regression models often focus solely on the location parameter of the model (e.g., <span class="math inline">\(\mu\)</span> in <span class="math inline">\(\operatorname{Normal}(\mu, \sigma)\)</span>; <span class="math inline">\(\pi\)</span> in <span class="math inline">\(\operatorname{Binomial}(n, \pi)\)</span>). However, it is also possible to specify separate predictors for the scale or shape parameters of models (e.g., <span class="math inline">\(\sigma\)</span> in <span class="math inline">\(\operatorname{Normal}(\mu, \sigma)\)</span>, <span class="math inline">\(\phi\)</span> in <span class="math inline">\(\operatorname{Beta}(\mu, \phi)\)</span>). In the world of <strong>brms</strong>, these are called <a href="https://cran.r-project.org/web/packages/brms/vignettes/brms_distreg.html">distributional models</a>.</p>
<p>More complex models can use a collection of distributional parameters. <a href="https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/#4-zero-inflated-beta-regression-bayesian-style">Zero-inflated beta models</a> estimate a mean <span class="math inline">\(\mu\)</span>, precision <span class="math inline">\(\phi\)</span>, and a zero-inflated parameter <code>zi</code>, while <a href="https://www.andrewheiss.com/blog/2022/05/09/hurdle-lognormal-gaussian-brms/">hurdle lognormal models</a> estimate a mean <span class="math inline">\(\mu\)</span>, scale <span class="math inline">\(\sigma\)</span>, and a hurdle parameter <code>hu</code>. Even plain old Gaussian models become distributional models when a set of predictors is specified for <span class="math inline">\(\sigma\)</span> (e.g.&nbsp;<code>brm(y ~ x1 + x2, sigma ~ x2 + x3)</code>).</p>
<p>When working with extra distributional parameters, the various Bayesian posterior prediction functions return values on different scales for each different component of the model, making life even more complex! Estimates and distributional parameters (what <strong>brms</strong> calls <code>dpar</code> in its functions) from these models can be used in their transformed scales or can be back-transformed into their original scale.</p>
<section id="beta-regression-example" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="beta-regression-example">Beta regression example</h3>
<p>To show how different link functions <em>and</em> distributional parameters work with posteriors from distributional models, we’ll use beta regression with a single explanatory variable. The penguin data we’ve been using doesn’t have any variables that are proportions or otherwise constrained between 0 and 1, so we’ll make one up. Here we’re interested in the the ratio of penguin bill depth (equivalent to the height of the bill; <a href="https://allisonhorst.github.io/palmerpenguins/articles/art.html#culmen-measurements">see this illustration</a>) to bill length and whether flipper length influences that ratio. I know nothing about penguins (or birds, for that matter), so I don’t know if biologists even care about the depth/length ratio in bills, but it makes a nice proportion so we’ll go with it.</p>
<p>Here’s what the relationship looks like—as flipper length increases, the bill ratio decreases. Longer-flippered penguins have shorter and longer bills; shorter-flippered penguins have taller bills in proportion to their lengths. Or something like that.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">penguins</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">flipper_length_mm</span>, y <span class="op">=</span> <span class="va">bill_ratio</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1</span>, alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_smooth</span><span class="op">(</span>method <span class="op">=</span> <span class="st">"lm"</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span>, se <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Flipper length (mm)"</span>, y <span class="op">=</span> <span class="st">"Ratio of bill depth / bill length"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_pred</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-mass-bill-ratio-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>We want to model that green line, and in this case it appears nice and straight and could probably be modeled with regular Gaussian regression, but we also want to make sure any predictions are constrained between 0 and 1 since we’re working with a proportion. Beta regression is perfect for this. Once again, I won’t go into detail about how beta models work—<a href="https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/">I have a whole detailed guide to it here</a>.</p>
<p>With beta regression, we need to model two parameters of the beta distribution—the mean <span class="math inline">\(\mu\)</span> and the precision <span class="math inline">\(\phi\)</span>. Ordinarily beta distributions are actually defined by two other parameters, called either shape 1 and shape 2 or <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span>. The two systems of parameters are closely related and you can switch between them with a little algebra—<a href="https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/#beta-distributions-and-shape-parameters">see this guide for an example of how</a>.</p>
<p>We can create a formal model for the distribution of the ratio of bill depth to bill length with a beta distribution with a mean <span class="math inline">\(\mu\)</span> and precision <span class="math inline">\(\phi\)</span>, each of which are conditional on different values of flipper length. The models for <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\phi\)</span> don’t have to use the same explanatory variables—I’m just doing that here for the sake of simplicity.</p>
<p><span class="math display">\[
\begin{aligned}
\text{Bill ratio}_i &amp;\sim \operatorname{Beta}(\mu_i, \phi_i) \\
\operatorname{logit}(\mu_i) &amp;= \alpha_{\mu} + \beta_{\mu} \ \text{Flipper length}_i \\
\log({\phi}) &amp;= \alpha_{\phi} + \beta_{\phi} \ \text{Flipper length}_i
\end{aligned}
\]</span></p>
<p>Or more generally,</p>
<p><span class="math display">\[
\begin{aligned}
y_i &amp;\sim \operatorname{Beta}(\mu_i, \phi_i) \\
\operatorname{logit}(\mu_i) &amp;= \alpha_{\mu} + \beta_{\mu} x_i \\
\log({\phi}) &amp;= \alpha_{\phi} + \beta_{\phi} x_i
\end{aligned}
\]</span></p>
<p>Let’s fit the model! But first, we’ll actually set more specific priors this time instead of relying on the defaults. Since <span class="math inline">\(\mu\)</span> is on the logit scale, it’s unlikely to ever have any huge numbers (i.e.&nbsp;anything beyond ±4; recall the probability scale/logit scale plot earlier). The default brms priors for coefficients in beta regression models are flat and uniform, resulting in some potentially huge and implausible priors that lead to really bad model fit (and really slow sampling!). So we’ll help Stan a little here and explicitly tell it that the coefficients will be small (<code>normal(0, 1)</code>) and that <span class="math inline">\(\phi\)</span> must be positive (<code>exponential(1)</code> with a lower bound of 0).</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/model-beta_d507c52d4934925034ccece4ca6665d6">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_beta</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span></span>
<span>  <span class="fu">bf</span><span class="op">(</span><span class="va">bill_ratio</span> <span class="op">~</span> <span class="va">flipper_length_mm</span>,</span>
<span>     <span class="va">phi</span> <span class="op">~</span> <span class="va">flipper_length_mm</span><span class="op">)</span>,</span>
<span>  family <span class="op">=</span> <span class="fu">Beta</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  init <span class="op">=</span> <span class="st">"0"</span>,</span>
<span>  data <span class="op">=</span> <span class="va">penguins</span>,</span>
<span>  prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu">prior</span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"b"</span><span class="op">)</span>,</span>
<span>            <span class="fu">prior</span><span class="op">(</span><span class="fu">exponential</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"b"</span>, dpar <span class="op">=</span> <span class="st">"phi"</span>, lb <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">## Start sampling</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Again, we don’t care about the coefficients or marginal effects here—see <a href="https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/">this guide</a> for more about how to work with those. Let’s instead extract these different posterior distributions of bill ratios with the three main <strong>brms</strong> functions: <code>posterior_linpred()</code>, <code>posterior_epred()</code>, and <code>posterior_predict()</code>. And once again, we’ll use a single value flipper length (the average, 200.967 mm) to explore these distributions.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Make a little dataset of just the average flipper length</span></span>
<span><span class="va">penguins_avg_flipper</span> <span class="op">&lt;-</span> <span class="va">penguins</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>flipper_length_mm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">flipper_length_mm</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract different types of posteriors</span></span>
<span><span class="va">beta_linpred</span> <span class="op">&lt;-</span> <span class="va">model_beta</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">linpred_draws</span><span class="op">(</span>newdata <span class="op">=</span> <span class="va">penguins_avg_flipper</span><span class="op">)</span></span>
<span></span>
<span><span class="va">beta_linpred_phi</span> <span class="op">&lt;-</span> <span class="va">model_beta</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">linpred_draws</span><span class="op">(</span>newdata <span class="op">=</span> <span class="va">penguins_avg_flipper</span>, dpar <span class="op">=</span> <span class="st">"phi"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">beta_linpred_trans</span> <span class="op">&lt;-</span> <span class="va">model_beta</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">linpred_draws</span><span class="op">(</span>newdata <span class="op">=</span> <span class="va">penguins_avg_flipper</span>, transform <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">beta_linpred_phi_trans</span> <span class="op">&lt;-</span> <span class="va">model_beta</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">linpred_draws</span><span class="op">(</span>newdata <span class="op">=</span> <span class="va">penguins_avg_flipper</span>, dpar <span class="op">=</span> <span class="st">"phi"</span>, transform <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">beta_epred</span> <span class="op">&lt;-</span> <span class="va">model_beta</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">epred_draws</span><span class="op">(</span>newdata <span class="op">=</span> <span class="va">penguins_avg_flipper</span><span class="op">)</span></span>
<span></span>
<span><span class="va">beta_predicted</span> <span class="op">&lt;-</span> <span class="va">model_beta</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">predicted_draws</span><span class="op">(</span>newdata <span class="op">=</span> <span class="va">penguins_avg_flipper</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice the addition of two new posteriors here: <code>linpred_draws(..., dpar = "phi")</code> and <code>linpred_draws(..., dpar = "phi", transform = TRUE)</code>. These give us the posterior distributions of the precision (<span class="math inline">\(\phi\)</span>) distributional parameter, measured on different scales.</p>
<p>Importantly, <a href="https://twitter.com/mjskay/status/1574489463497314304">for weird historical reasons</a>, it is possible to use <code>posterior_epred(..., dpar = "phi")</code> to get the unlogged <span class="math inline">\(\phi\)</span> parameter. However, conceptually this is wrong. An <code>epred</code> is the expected value, or average, of the posterior predictive distribution, or <span class="math inline">\(y\)</span>. It is <em>not</em> the expected value of the <span class="math inline">\(\phi\)</span> part of the model. <strong>brms</strong> (or <strong>tidybayes</strong>) happily spits out the unlogged posterior distribution of <span class="math inline">\(\phi\)</span> when you use <code>posterior_epred(..., dpar = "phi")</code>, but it’s technically not an <code>epred</code> despite its name. <a href="https://twitter.com/mjskay/status/1574489124429520896">To keep the terminology consistent</a>, it’s best to use <code>posterior_linpred()</code> when working with distributional parameters, using either <code>transform = FALSE</code> or <code>transform = TRUE</code> for the logged or the unlogged scale.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">summary_beta_linpred</span> <span class="op">&lt;-</span> <span class="va">beta_linpred</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="va">.linpred</span>, <span class="fu">lst</span><span class="op">(</span><span class="va">mean</span>, <span class="va">sd</span>, <span class="va">median</span><span class="op">)</span>, .names <span class="op">=</span> <span class="st">"{.fn}"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">summary_beta_linpred_phi</span> <span class="op">&lt;-</span> <span class="va">beta_linpred_phi</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="va">phi</span>, <span class="fu">lst</span><span class="op">(</span><span class="va">mean</span>, <span class="va">sd</span>, <span class="va">median</span><span class="op">)</span>, .names <span class="op">=</span> <span class="st">"{.fn}"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">summary_beta_linpred_phi_trans</span> <span class="op">&lt;-</span> <span class="va">beta_linpred_phi_trans</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="va">phi</span>, <span class="fu">lst</span><span class="op">(</span><span class="va">mean</span>, <span class="va">sd</span>, <span class="va">median</span><span class="op">)</span>, .names <span class="op">=</span> <span class="st">"{.fn}"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">summary_beta_epred</span> <span class="op">&lt;-</span> <span class="va">beta_epred</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="va">.epred</span>, <span class="fu">lst</span><span class="op">(</span><span class="va">mean</span>, <span class="va">sd</span>, <span class="va">median</span><span class="op">)</span>, .names <span class="op">=</span> <span class="st">"{.fn}"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">summary_beta_predicted</span> <span class="op">&lt;-</span> <span class="va">beta_predicted</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="va">.prediction</span>, <span class="fu">lst</span><span class="op">(</span><span class="va">mean</span>, <span class="va">sd</span>, <span class="va">median</span><span class="op">)</span>, .names <span class="op">=</span> <span class="st">"{.fn}"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tribble</span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">Function</span>, <span class="op">~</span><span class="va">`Model element`</span>, <span class="op">~</span><span class="va">Values</span>,</span>
<span>  <span class="st">"&lt;code&gt;posterior_linpred()&lt;/code&gt;"</span>, <span class="st">"\\(\\operatorname{logit}(\\mu)\\) in the model"</span>, <span class="st">"Logits or log odds"</span>,</span>
<span>  <span class="st">"&lt;code&gt;posterior_linpred(transform = TRUE)&lt;/code&gt; or &lt;code&gt;posterior_epred()&lt;/code&gt;"</span>, <span class="st">"\\(\\operatorname{E(y)}\\) and \\(\\mu\\) in the model"</span>, <span class="st">"Probabilities"</span>,</span>
<span>  <span class="st">'&lt;code&gt;posterior_linpred(dpar = "phi")&lt;/code&gt;'</span>, <span class="st">"\\(\\log(\\phi)\\) in the model"</span>, <span class="st">"Logged precision values"</span>,</span>
<span>  <span class="st">'&lt;code&gt;posterior_linpred(dpar = "phi", transform = TRUE)&lt;/code&gt;'</span>, <span class="st">"\\(\\phi\\) in the model"</span>, <span class="st">"Unlogged precision values"</span>,</span>
<span>  <span class="st">"&lt;code&gt;posterior_predict()&lt;/code&gt;"</span>, <span class="st">"Random draws from posterior \\(\\operatorname{Beta}(\\mu, \\phi)\\)"</span>, <span class="st">"Values between 0–1"</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">bind_cols</span><span class="op">(</span><span class="fu">bind_rows</span><span class="op">(</span><span class="va">summary_beta_linpred</span>, <span class="va">summary_beta_epred</span>, </span>
<span>                      <span class="va">summary_beta_linpred_phi</span>, <span class="va">summary_beta_linpred_phi_trans</span>,</span>
<span>                      <span class="va">summary_beta_predicted</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">kbl</span><span class="op">(</span>escape <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">kable_styling</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div id="tbl-beta-posteriors" class="cell quarto-float quarto-figure quarto-figure-center anchored page-columns page-full" data-layout-align="center">
<figure class="quarto-float quarto-float-tbl figure page-columns page-full"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-beta-posteriors-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;3: Beta posteriors
</figcaption><div aria-describedby="tbl-beta-posteriors-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<div class="cell-output-display column-page-inset-right">
<table class="table do-not-create-environment cell caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead><tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Function</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Model element</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Values</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mean</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">sd</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">median</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>posterior_linpred()</code></td>
<td style="text-align: left;">\(\operatorname{logit}(\mu)\) in the model</td>
<td style="text-align: left;">Logits or log odds</td>
<td style="text-align: right;">-0.423</td>
<td style="text-align: right;">0.011</td>
<td style="text-align: right;">-0.423</td>
</tr>
<tr class="even">
<td style="text-align: left;">
<code>posterior_linpred(transform = TRUE)</code> or <code>posterior_epred()</code>
</td>
<td style="text-align: left;">\(\operatorname{E(y)}\) and \(\mu\) in the model</td>
<td style="text-align: left;">Probabilities</td>
<td style="text-align: right;">0.396</td>
<td style="text-align: right;">0.003</td>
<td style="text-align: right;">0.396</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>posterior_linpred(dpar = "phi")</code></td>
<td style="text-align: left;">\(\log(\phi)\) in the model</td>
<td style="text-align: left;">Logged precision values</td>
<td style="text-align: right;">4.672</td>
<td style="text-align: right;">0.078</td>
<td style="text-align: right;">4.675</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>posterior_linpred(dpar = "phi", transform = TRUE)</code></td>
<td style="text-align: left;">\(\phi\) in the model</td>
<td style="text-align: left;">Unlogged precision values</td>
<td style="text-align: right;">107.284</td>
<td style="text-align: right;">8.329</td>
<td style="text-align: right;">107.259</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>posterior_predict()</code></td>
<td style="text-align: left;">Random draws from posterior \(\operatorname{Beta}(\mu, \phi)\)</td>
<td style="text-align: left;">Values between 0–1</td>
<td style="text-align: right;">0.397</td>
<td style="text-align: right;">0.048</td>
<td style="text-align: right;">0.397</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>Neat! We have a bunch of different pieces here, all measured differently. Let’s look at all these different pieces simultaneously:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">beta_linpred</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">.linpred</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Logit-scale ratio of bill depth / bill length"</span>, y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"**Linear predictor** &lt;span style='font-size: 14px;'&gt;logit(*µ*) in the model&lt;/span&gt;"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"posterior_linpred(\n  ..., tibble(flipper_length_mm = 201))\n"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_pred_dist</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p1a</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">beta_linpred_phi</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">phi</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span>fill <span class="op">=</span> <span class="fu">colorspace</span><span class="fu">::</span><span class="fu">lighten</span><span class="op">(</span><span class="va">clrs</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">0.3</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Log-scale precision parameter"</span>, y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"**Precision parameter** &lt;span style='font-size: 14px;'&gt;log(*φ*) in the model&lt;/span&gt;"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">'posterior_linpred(\n  ..., tibble(flipper_length_mm = 201),\n  dpar = "phi")'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_pred_dist</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">beta_epred</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">.epred</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Ratio of bill depth / bill length"</span>, y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"**Expectation of the posterior** &lt;span style='font-size: 14px;'&gt;E[*y*] or *µ* in the model&lt;/span&gt;"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"posterior_epred(\n  ..., tibble(flipper_length_mm = 201)) # or \nposterior_linpred(..., transform = TRUE)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_pred_dist</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p2a</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">beta_linpred_phi_trans</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">phi</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span>fill <span class="op">=</span> <span class="fu">colorspace</span><span class="fu">::</span><span class="fu">lighten</span><span class="op">(</span><span class="va">clrs</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Precision parameter"</span>, y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"**Precision parameter** &lt;span style='font-size: 14px;'&gt;*φ* in the model&lt;/span&gt;"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">'posterior_linpred(\n  ..., tibble(flipper_length_mm = 201),\n  dpar = "phi", transform = TRUE)\n'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_pred_dist</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">beta_predicted</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">.prediction</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.6</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Ratio of bill depth / bill length"</span>, y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"**Posterior predictions** &lt;span style='font-size: 14px;'&gt;Random draws from posterior Beta(*µ*, *φ*)&lt;/span&gt;"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"posterior_predict()"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_pred_dist</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">layout</span> <span class="op">&lt;-</span> <span class="st">"</span></span>
<span><span class="st">AB</span></span>
<span><span class="st">CC</span></span>
<span><span class="st">DE</span></span>
<span><span class="st">FF</span></span>
<span><span class="st">GG</span></span>
<span><span class="st">"</span></span>
<span></span>
<span><span class="va">p1</span> <span class="op">+</span> <span class="va">p1a</span> <span class="op">+</span> <span class="fu">plot_spacer</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="va">p2</span> <span class="op">+</span> <span class="va">p2a</span> <span class="op">+</span> <span class="fu">plot_spacer</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="va">p3</span> <span class="op">+</span></span>
<span>  <span class="fu">plot_layout</span><span class="op">(</span>design <span class="op">=</span> <span class="va">layout</span>, heights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="fl">0.05</span>, <span class="fl">0.3</span>, <span class="fl">0.05</span>, <span class="fl">0.3</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/plot-beta-posteriors-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page-inset-right" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>As with logistic regression, the results from <code>posterior_epred()</code> and <code>posterior_linpred()</code> are not identical. They still both correspond to the <span class="math inline">\(\mu\)</span> part of the model, but on different scales. <code>posterior_epred()</code> provides results on the probability or proportion scale, un-logiting and back-transforming the logit-scale results from <code>posterior_linpred()</code>.</p>
<p>And once again, <code>posterior_epred()</code> isn’t technically the back-transformed linear predictor (if you want that, you can use <code>posterior_linpred(..., transform = TRUE)</code>). Instead it shows the expected values of the posterior, or <span class="math inline">\(\operatorname{E(y)}\)</span>, or the average of the posterior’s averages. But just like Gaussian regression and logistic regression, this average-of-averages still happens to be the same as the back-transformed <span class="math inline">\(\mu\)</span>, so <span class="math inline">\(E(y) = \operatorname{inverse logit}(\mu)\)</span>.</p>
<p>We can extract the <span class="math inline">\(\phi\)</span> parameter by including the <code>dpar = "phi"</code> argument (or technically just <code>dpar = TRUE</code>, which returns all possible distributional parameters, which is helpful in cases with lots of them like zero-one-inflated beta regression). <code>posterior_linpred(..., dpar = "phi", transform = TRUE)</code> provides <span class="math inline">\(\phi\)</span> on the original precision scale (however that’s measured), while <code>posterior_linpred(..., dpar = "phi")</code> returns a log-transformed version.</p>
<p>And finally, the results from <code>posterior_predict()</code> are draws from a random beta distribution using the estimated <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\phi\)</span>, and they consist of values ranging between 0 and 1.</p>
<p>Showing the posterior predictions for these different parameters across a range of flipper lengths will help with the intuition and illustrate the different scales, values, and parameters that these posterior functions return:</p>
<ul>
<li>
<code>posterior_linpred()</code> returns the value of <span class="math inline">\(\mu\)</span> on the logit scale</li>
<li>
<code>posterior_epred()</code> returns the value of <span class="math inline">\(\mu\)</span> on the probability scale (technically it’s returning <span class="math inline">\(\operatorname{E(y)}\)</span>, but in practice those are identical here)</li>
<li>
<code>posterior_linpred(..., dpar = "phi")</code> returns the logged value of <span class="math inline">\(\phi\)</span>
</li>
<li>
<code>posterior_linpred(..., dpar = "phi", transform = TRUE)</code> returns the value of <span class="math inline">\(\phi\)</span> on its original scale</li>
<li>
<code>posterior_predict()</code> returns probabilities or proportions</li>
</ul>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="va">penguins</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">data_grid</span><span class="op">(</span>flipper_length_mm <span class="op">=</span> <span class="fu">seq_range</span><span class="op">(</span><span class="va">flipper_length_mm</span>, n <span class="op">=</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">add_linpred_draws</span><span class="op">(</span><span class="va">model_beta</span>, ndraws <span class="op">=</span> <span class="fl">100</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">flipper_length_mm</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>data <span class="op">=</span> <span class="va">penguins</span>, <span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html">qlogis</a></span><span class="op">(</span><span class="va">bill_ratio</span><span class="op">)</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1</span>, alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_lineribbon</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">.linpred</span><span class="op">)</span>, .width <span class="op">=</span> <span class="fl">0.95</span>,</span>
<span>                  alpha <span class="op">=</span> <span class="fl">0.5</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, fill <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">170</span>, <span class="fl">230</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Flipper length (mm)"</span>, y <span class="op">=</span> <span class="st">"Logit-scale ratio of\nbill depth / bill length"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"**Linear predictor posterior** &lt;span style='font-size: 14px;'&gt;logit(*µ*) in the model&lt;/span&gt;"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"posterior_linpred()"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_pred_range</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p1a</span> <span class="op">&lt;-</span> <span class="va">penguins</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">data_grid</span><span class="op">(</span>flipper_length_mm <span class="op">=</span> <span class="fu">seq_range</span><span class="op">(</span><span class="va">flipper_length_mm</span>, n <span class="op">=</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">add_linpred_draws</span><span class="op">(</span><span class="va">model_beta</span>, ndraws <span class="op">=</span> <span class="fl">100</span>, dpar <span class="op">=</span> <span class="st">"phi"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">flipper_length_mm</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_lineribbon</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">phi</span><span class="op">)</span>, .width <span class="op">=</span> <span class="fl">0.95</span>, alpha <span class="op">=</span> <span class="fl">0.5</span>, </span>
<span>                  color <span class="op">=</span> <span class="fu">colorspace</span><span class="fu">::</span><span class="fu">lighten</span><span class="op">(</span><span class="va">clrs</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">0.3</span><span class="op">)</span>, fill <span class="op">=</span> <span class="fu">colorspace</span><span class="fu">::</span><span class="fu">lighten</span><span class="op">(</span><span class="va">clrs</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">0.3</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">170</span>, <span class="fl">230</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Flipper length (mm)"</span>, y <span class="op">=</span> <span class="st">"Log-scale\nprecision parameter"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"**Precision parameter** &lt;span style='font-size: 14px;'&gt;log(*φ*) in the model&lt;/span&gt;"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">'posterior_linpred(dpar = "phi")'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_pred_range</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="va">penguins</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">data_grid</span><span class="op">(</span>flipper_length_mm <span class="op">=</span> <span class="fu">seq_range</span><span class="op">(</span><span class="va">flipper_length_mm</span>, n <span class="op">=</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">add_epred_draws</span><span class="op">(</span><span class="va">model_beta</span>, ndraws <span class="op">=</span> <span class="fl">100</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">flipper_length_mm</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>data <span class="op">=</span> <span class="va">penguins</span>, <span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">bill_ratio</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1</span>, alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_lineribbon</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">.epred</span><span class="op">)</span>, .width <span class="op">=</span> <span class="fl">0.95</span>,</span>
<span>                  alpha <span class="op">=</span> <span class="fl">0.5</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, fill <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">170</span>, <span class="fl">230</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Flipper length (mm)"</span>, y <span class="op">=</span> <span class="st">"Ratio of\nbill depth / bill length"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"**Expectation of the posterior** &lt;span style='font-size: 14px;'&gt;E[*y*] or *µ* in the model&lt;/span&gt;"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">'posterior_epred()\nposterior_linpred(transform = TRUE)'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_pred_range</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p2a</span> <span class="op">&lt;-</span> <span class="va">penguins</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">data_grid</span><span class="op">(</span>flipper_length_mm <span class="op">=</span> <span class="fu">seq_range</span><span class="op">(</span><span class="va">flipper_length_mm</span>, n <span class="op">=</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">add_epred_draws</span><span class="op">(</span><span class="va">model_beta</span>, ndraws <span class="op">=</span> <span class="fl">100</span>, dpar <span class="op">=</span> <span class="st">"phi"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">flipper_length_mm</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_lineribbon</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">phi</span><span class="op">)</span>, .width <span class="op">=</span> <span class="fl">0.95</span>, alpha <span class="op">=</span> <span class="fl">0.5</span>, </span>
<span>                  color <span class="op">=</span> <span class="fu">colorspace</span><span class="fu">::</span><span class="fu">lighten</span><span class="op">(</span><span class="va">clrs</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="fl">0.4</span><span class="op">)</span>, fill <span class="op">=</span> <span class="fu">colorspace</span><span class="fu">::</span><span class="fu">lighten</span><span class="op">(</span><span class="va">clrs</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">170</span>, <span class="fl">230</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Flipper length (mm)"</span>, y <span class="op">=</span> <span class="st">"Precision parameter"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"**Precision parameter** &lt;span style='font-size: 14px;'&gt;*φ* in the model&lt;/span&gt;"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">'posterior_linpred(dpar = "phi",\n                  transform = TRUE)'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_pred_range</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p3</span> <span class="op">&lt;-</span> <span class="va">penguins</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">data_grid</span><span class="op">(</span>flipper_length_mm <span class="op">=</span> <span class="fu">seq_range</span><span class="op">(</span><span class="va">flipper_length_mm</span>, n <span class="op">=</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">add_predicted_draws</span><span class="op">(</span><span class="va">model_beta</span>, ndraws <span class="op">=</span> <span class="fl">500</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">flipper_length_mm</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>data <span class="op">=</span> <span class="va">penguins</span>, <span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">bill_ratio</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1</span>, alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_lineribbon</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">.prediction</span><span class="op">)</span>, .width <span class="op">=</span> <span class="fl">0.95</span>,</span>
<span>                  alpha <span class="op">=</span> <span class="fl">0.5</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, fill <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">170</span>, <span class="fl">230</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Flipper length (mm)"</span>, y <span class="op">=</span> <span class="st">"Ratio of\nbill depth / bill length"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"**Posterior predictions** &lt;span style='font-size: 14px;'&gt;Random draws from posterior Beta(*µ*, *φ*)&lt;/span&gt;"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"posterior_predict()"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_pred_range</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">layout</span> <span class="op">&lt;-</span> <span class="st">"</span></span>
<span><span class="st">AB</span></span>
<span><span class="st">CC</span></span>
<span><span class="st">DE</span></span>
<span><span class="st">FF</span></span>
<span><span class="st">GG</span></span>
<span><span class="st">"</span></span>
<span></span>
<span><span class="va">p1</span> <span class="op">+</span> <span class="va">p1a</span> <span class="op">+</span> <span class="fu">plot_spacer</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="va">p2</span> <span class="op">+</span> <span class="va">p2a</span> <span class="op">+</span> <span class="fu">plot_spacer</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="va">p3</span> <span class="op">+</span></span>
<span>  <span class="fu">plot_layout</span><span class="op">(</span>design <span class="op">=</span> <span class="va">layout</span>, heights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="fl">0.05</span>, <span class="fl">0.3</span>, <span class="fl">0.05</span>, <span class="fl">0.3</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/plot-beta-predictions-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page-inset-right" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>So many moving parts in these distributional models! This diagram summarizes all these different posteriors, scales, and distributional parameters:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="images/beta@3x.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page-inset-right" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section><section id="bonus-playing-with-posterior-beta-parameters" class="level3"><h3 class="anchored" data-anchor-id="bonus-playing-with-posterior-beta-parameters">Bonus: Playing with posterior beta parameters</h3>
<p>Before finishing with beta regression, we can play around with some of these posterior parameters to better understand what this kind of distributional model is actually doing. First, we can plot the posterior distribution using the means of the posterior <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\phi\)</span> parameters instead of using the results from <code>posterior_predict()</code>, creating a pseudo-analytical posterior distribution. We’ll use the <code>dprop()</code> function from the <strong>extraDistr</strong> package instead of <code><a href="https://rdrr.io/r/stats/Beta.html">dbeta()</a></code>, since <code>dprop</code> uses <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\phi\)</span> instead of shape 1 and shape 2.</p>
<p>It’s not the greatest model at all—the actual distribution of bill ratios is bimodal (probably because of species-specific differences), but using the posterior values for <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\phi\)</span> creates a distribution that picks up the average ratio.</p>
<p>In practice we typically don’t actually want to use these two parameters like this—we can use the results from <code>posterior_predict()</code> instead—but it’s cool that we can produce the same distribution with these parameters. That’s the magic of these distributional models!</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mu</span> <span class="op">&lt;-</span> <span class="va">summary_beta_epred</span><span class="op">$</span><span class="va">mean</span></span>
<span><span class="va">phi</span> <span class="op">&lt;-</span> <span class="va">summary_beta_linpred_phi_trans</span><span class="op">$</span><span class="va">mean</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">penguins</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">bill_ratio</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_density</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"Actual data"</span><span class="op">)</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_function</span><span class="op">(</span></span>
<span>    <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"Beta(µ = {round(mu, 3)}, φ = {round(phi, 2)})"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    geom <span class="op">=</span> <span class="st">"area"</span>, fun <span class="op">=</span> <span class="op">~</span> <span class="fu">extraDistr</span><span class="fu">::</span><span class="fu">dprop</span><span class="op">(</span><span class="va">.</span>, mean <span class="op">=</span> <span class="va">mu</span>, size <span class="op">=</span> <span class="va">phi</span><span class="op">)</span>,</span>
<span>    alpha <span class="op">=</span> <span class="fl">0.7</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">clrs</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span>, <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, name <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlim</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.65</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Ratio of bill depth / bill length"</span>, y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"**Analytical posterior predictions** &lt;span style='font-size: 14px;'&gt;Average posterior *µ* and *φ* from the model&lt;/span&gt;"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_pred_dist</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.9</span><span class="op">)</span>,</span>
<span>        legend.justification <span class="op">=</span> <span class="st">"left"</span>,</span>
<span>        legend.key.size <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0.75</span>, <span class="st">"lines"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-empirical-posterior-data-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>For even more fun, because we modeled the <span class="math inline">\(\phi\)</span> parameter as conditional on flipper length, it changes depending on different flipper lengths. This means that the actual posterior beta distribution is shaped differently across a whole range of lengths. Here’s what that looks like, with analytical distributions plotted at 180, 200, and 200 mm. As the precision increases, the distributions become more narrow and precise (which is also reflected in the size of the <code>posterior_predict()</code>-based credible intervals around the points)</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">muphi_to_shapes</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mu</span>, <span class="va">phi</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">shape1</span> <span class="op">&lt;-</span> <span class="va">mu</span> <span class="op">*</span> <span class="va">phi</span></span>
<span>  <span class="va">shape2</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">mu</span><span class="op">)</span> <span class="op">*</span> <span class="va">phi</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu">lst</span><span class="op">(</span>shape1 <span class="op">=</span> <span class="va">shape1</span>, shape2 <span class="op">=</span> <span class="va">shape2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">beta_posteriors</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span>flipper_length_mm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">180</span>, <span class="fl">200</span>, <span class="fl">220</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">add_linpred_draws</span><span class="op">(</span><span class="va">model_beta</span>, ndraws <span class="op">=</span> <span class="fl">500</span>, dpar <span class="op">=</span> <span class="cn">TRUE</span>, transform <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">flipper_length_mm</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">mu</span>, <span class="va">phi</span><span class="op">)</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>shapes <span class="op">=</span> <span class="fu">map2</span><span class="op">(</span><span class="va">mu</span>, <span class="va">phi</span>, <span class="op">~</span><span class="fu">as_tibble</span><span class="op">(</span><span class="fu">muphi_to_shapes</span><span class="op">(</span><span class="va">.x</span>, <span class="va">.y</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">unnest</span><span class="op">(</span><span class="va">shapes</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>nice_label <span class="op">=</span> <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"Beta(µ = {round(mu, 3)}, φ = {round(phi, 2)})"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Here are the parameters we'll use</span></span>
<span><span class="co"># We need to convert the mu and phi values to shape1 and shape2 so that we can</span></span>
<span><span class="co"># use dist_beta() to plot the halfeye distributions correctly</span></span>
<span><span class="va">beta_posteriors</span></span>
<span><span class="co">## # A tibble: 3 × 6</span></span>
<span><span class="co">##   flipper_length_mm    mu   phi shape1 shape2 nice_label                </span></span>
<span><span class="co">##               &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;glue&gt;                    </span></span>
<span><span class="co">## 1               180 0.485  57.3   27.8   29.5 Beta(µ = 0.485, φ = 57.29)</span></span>
<span><span class="co">## 2               200 0.400 104.    41.5   62.4 Beta(µ = 0.4, φ = 103.92) </span></span>
<span><span class="co">## 3               220 0.320 191.    61.3  130.  Beta(µ = 0.32, φ = 191.31)</span></span>
<span></span>
<span><span class="va">penguins</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">data_grid</span><span class="op">(</span>flipper_length_mm <span class="op">=</span> <span class="fu">seq_range</span><span class="op">(</span><span class="va">flipper_length_mm</span>, n <span class="op">=</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">add_predicted_draws</span><span class="op">(</span><span class="va">model_beta</span>, ndraws <span class="op">=</span> <span class="fl">500</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">flipper_length_mm</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>data <span class="op">=</span> <span class="va">penguins</span>, <span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">bill_ratio</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1</span>, alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span>data <span class="op">=</span> <span class="va">beta_posteriors</span>, <span class="fu">aes</span><span class="op">(</span>ydist <span class="op">=</span> <span class="fu">dist_beta</span><span class="op">(</span><span class="va">shape1</span>, <span class="va">shape2</span><span class="op">)</span>, y <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span>, </span>
<span>               side <span class="op">=</span> <span class="st">"bottom"</span>, fill <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, alpha <span class="op">=</span> <span class="fl">0.75</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_lineribbon</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">.prediction</span><span class="op">)</span>, .width <span class="op">=</span> <span class="fl">0.95</span>,</span>
<span>                  alpha <span class="op">=</span> <span class="fl">0.1</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, fill <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_text</span><span class="op">(</span>data <span class="op">=</span> <span class="va">beta_posteriors</span>, </span>
<span>            <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">flipper_length_mm</span>, y <span class="op">=</span> <span class="fl">0.9</span>, label <span class="op">=</span> <span class="va">nice_label</span><span class="op">)</span>,</span>
<span>            hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">170</span>, <span class="fl">230</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Flipper length (mm)"</span>, y <span class="op">=</span> <span class="st">"Ratio of\nbill depth / bill length"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"**Analytical posterior predictions** &lt;span style='font-size: 14px;'&gt;Average posterior *µ* and *φ* from the model&lt;/span&gt;"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_pred_range</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-beta-posterior-dists-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
</section></section><section id="when-posterior_epred-isnt-just-the-back-transformed-linear-predictor" class="level2"><h2 class="anchored" data-anchor-id="when-posterior_epred-isnt-just-the-back-transformed-linear-predictor">When <code>posterior_epred()</code> isn’t just the back-transformed linear predictor</h2>
<p>In all the examples in this guide, the results from <code>posterior_epred()</code> have been identical to the back-transformed results from <code>posterior_linpred()</code> (or <code>posterior_linpred(..., transform = TRUE)</code> if there are link functions). With logistic regression, <code>posterior_epred()</code> returned the probability-scale values of <span class="math inline">\(\pi\)</span>; with beta regression, <code>posterior_epred()</code> returned the proportion/probability-scale values of <span class="math inline">\(\mu\)</span>. This is the case for many model families in Stan and <strong>brms</strong>—for mathy reasons that go beyond my skills, the average of averages <span class="math inline">\(\operatorname{E(y)}\)</span> is the same as the back-transformed linear predictor for lots of distributions.</p>
<p>This isn’t always the case though! In some families, like lognormal models, <code>posterior_epred()</code> and <code>posterior_linpred(..., transform = TRUE)</code> give <em>different</em> estimates. For lognormal models <span class="math inline">\(\operatorname{E(y)}\)</span> isn’t just one of the distribution’s parameters—it’s this:</p>
<p><span class="math display">\[
\operatorname{E}(y | \mid \mu, \sigma) = \exp \left( \mu + \frac{\sigma^2}{2} \right)
\]</span></p>
<p>I won’t show any examples of that here—this guide is already too long—but <a href="https://github.com/mjskay/uncertainty-examples/blob/master/linpred_epred.md">Matthew Kay has an example here</a> that shows the differences between expected posterior values and back-transformed linear posterior values.</p>
<p>To see which kinds of families use fancier <code>epred</code>s, <a href="https://github.com/paul-buerkner/brms/blob/28f778d7933f95422dda8f9a9f4333b975261120/R/posterior_epred.R#L341">look at the source for <code>brms::posterior_epred()</code> here</a>. Most of the families just use the back-transformed <code>mu</code> (<code>prep\$dpars\$mu</code> in the code), but some have special values, like lognormal’s <code>with(prep$dpars, exp(mu + sigma^2 / 2))</code></p>
</section><section id="tldr-diagrams-and-cheat-sheets" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="tldr-diagrams-and-cheat-sheets">tl;dr: Diagrams and cheat sheets</h2>
<p>Keeping track of which kinds of posterior predictions you’re working with, on which scales, and for which parameters, can be tricky, especially with more complex models with lots of moving parts. To make life easier, here are all the summary diagrams in one place:</p>
<section id="normal-gaussian-models" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="normal-gaussian-models">Normal Gaussian models</h3>
<p><a href="images/normal.pdf"><strong>(Download a PDF)</strong></a> or <a href="model-diagrams.ai"><strong>(download original Adobe Illustrator file)</strong></a></p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="images/normal@3x.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page-inset-right" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section><section id="generalized-linear-models-with-link-transformations-logistic-regression-example" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="generalized-linear-models-with-link-transformations-logistic-regression-example">Generalized linear models with link transformations (logistic regression example)</h3>
<p><a href="images/logistic.pdf"><strong>(Download a PDF)</strong></a> or <a href="model-diagrams.ai"><strong>(download original Adobe Illustrator file)</strong></a></p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="images/logistic@3x.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page-inset-right" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section><section id="distributional-models-with-link-transformations-beta-regression-example" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="distributional-models-with-link-transformations-beta-regression-example">Distributional models with link transformations (beta regression example)</h3>
<p><a href="images/beta.pdf"><strong>(Download a PDF)</strong></a> or <a href="model-diagrams.ai"><strong>(download original Adobe Illustrator file)</strong></a></p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="images/beta@3x.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page-inset-right" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section><section id="complete-cheat-sheet" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="complete-cheat-sheet">Complete cheat sheet</h3>
<p>And here’s an even more detailed summary cheat sheet as a printable PDF:</p>
<p><a href="images/posterior-predictions-cheat-sheet_v2-0.pdf"><strong>(Download a PDF)</strong></a> or <a href="cheat-sheet_v2-0.zip"><strong>(download the original Adobe InDesign file)</strong></a></p>
<div class="cell" data-layout-align="center">
<style type="text/css">
.embed-container {
  position: relative;
  padding-bottom: 129%;
  height: 0;
  overflow: hidden;
  max-width: 100%;
}

.embed-container iframe,
.embed-container object,
.embed-container embed {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
}
</style>
</div>
<div class="column-page-inset-right">
<div class="embed-container">
<iframe src="images/posterior-predictions-cheat-sheet_v2-0.pdf" style="border: 0.5px">
</iframe>
</div>
</div>


<!-- -->

</section></section><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{heiss2022,
  author = {Heiss, Andrew},
  title = {Visualizing the Differences Between {Bayesian} Posterior
    Predictions, Linear Predictions, and the Expectation of Posterior
    Predictions},
  date = {2022-09-26},
  url = {https://www.andrewheiss.com/blog/2022/09/26/guide-visualizing-types-posteriors/},
  doi = {10.59350/xge39-emt86},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-heiss2022" class="csl-entry quarto-appendix-citeas" role="listitem">
Heiss, Andrew. 2022. <span>“Visualizing the Differences Between Bayesian
Posterior Predictions, Linear Predictions, and the Expectation of
Posterior Predictions.”</span> September 26, 2022. <a href="https://doi.org/10.59350/xge39-emt86">https://doi.org/10.59350/xge39-emt86</a>.
</div></div></section></div></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/www\.andrewheiss\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><script src="https://giscus.app/client.js" data-repo="andrewheiss/ath-quarto" data-repo-id="R_kgDOIg6EJQ" data-category="Blog comments" data-category-id="DIC_kwDOIg6EJc4CSz92" data-mapping="pathname" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script><input type="hidden" id="giscus-base-theme" value="light"><input type="hidden" id="giscus-alt-theme" value="dark"><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb30" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Visualizing the differences between Bayesian posterior predictions, linear predictions, and the expectation of posterior predictions"</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> 2022-09-26</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="an">description:</span><span class="co"> "A guide to different types of Bayesian posterior distributions and the nuances of posterior_predict, posterior_epred, and posterior_linpred"</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="an">image:</span><span class="co"> index_files/figure-html/plot-logit-predictions-1.png</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="co">  - r</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="co">  - tidyverse</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="co">  - ggplot</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="co">  - regression</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="co">  - bayes</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="co">  - brms</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a><span class="co">  - stan</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a><span class="an">resources:</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a><span class="co">  - "*.zip"</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a><span class="co">  - "*.ai"</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a><span class="co">  - "*.indd"</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a><span class="an">doi:</span><span class="co"> 10.59350/xge39-emt86</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a><span class="an">citation:</span><span class="co"> true</span></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setup, include=FALSE}</span></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::opts_chunk$set(fig.align = "center", fig.retina = 3,</span></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a><span class="in">                      fig.width = 6, fig.height = (6 * 0.618),</span></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a><span class="in">                      out.width = "90%", collapse = TRUE)</span></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a><span class="in">options(digits = 3, width = 110, knitr.kable.NA = "")</span></span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a><span class="fu">### Downloadable cheat sheets!</span></span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>You can download PDF, SVG, and PNG versions of the diagrams and cheat sheets in this post, as well as the original Adobe Illustrator and InDesign files, &lt;a href="#tldr-diagrams-and-cheat-sheets"&gt;at the bottom of this post&lt;/a&gt;</span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>Do whatever you want with them! They're licensed under <span class="co">[</span><span class="ot">Creative Commons Attribution-ShareAlike (BY-SA 4.0)</span><span class="co">](http://creativecommons.org/licenses/by-sa/4.0/)</span>.</span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>I've been working with Bayesian models and the Stan-based **brms** ecosystem (**tidybayes**, **ggdist**, **marginaleffects**, and friends) for a few years now, and I'm currently finally working through formal materials on Bayesianism and running an <span class="co">[</span><span class="ot">independent readings class</span><span class="co">](https://bayesf22.classes.andrewheiss.com/)</span> with a PhD student at GSU where we're reading <span class="co">[</span><span class="ot">Richard McElreath's *Statistical Rethinking*</span><span class="co">](https://xcelab.net/rm/statistical-rethinking/)</span> and <span class="co">[</span><span class="ot">Alicia Johnson, Miles Ott, and Mine Dogucu's *Bayes Rules!*</span><span class="co">](https://www.bayesrulesbook.com/)</span>, both of which are fantastic books (check out <span class="co">[</span><span class="ot">my translation of their materials to tidyverse/brms here</span><span class="co">](https://bayesf22-notebook.classes.andrewheiss.com/)</span>).</span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a>Something that has always plagued me about working with Bayesian posterior distributions, but that I've always waved off as too hard to think about, has been the differences between posterior predictions, the expectation of the posterior predictive distribution, and the posterior of the linear predictor (or <span class="in">`posterior_predict()`</span>, <span class="in">`posterior_epred()`</span>, and <span class="in">`posterior_linpred()`</span> in the **brms** world). But reading these two books has forced me to finally figure it out. </span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a>So here's an explanation of my mental model of the differences between these types of posterior distributions. It's definitely not 100% correct, but it makes sense for me.</span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a>For bonus fun, <span class="co">[</span><span class="ot">skip down to the incredibly useful diagrams and cheat sheets at the bottom of this post</span><span class="co">](#tldr-diagrams-and-cheat-sheets)</span>.</span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a>Let's load some packages, load some data, and get started!</span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a><span class="in">```{r libraries-functions, warning=FALSE, message=FALSE}</span></span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidyverse)        # ggplot, dplyr, and friends</span></span>
<span id="cb30-49"><a href="#cb30-49" aria-hidden="true" tabindex="-1"></a><span class="in">library(patchwork)        # Combine ggplot plots</span></span>
<span id="cb30-50"><a href="#cb30-50" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggtext)           # Fancier text in ggplot plots</span></span>
<span id="cb30-51"><a href="#cb30-51" aria-hidden="true" tabindex="-1"></a><span class="in">library(scales)           # Labeling functions</span></span>
<span id="cb30-52"><a href="#cb30-52" aria-hidden="true" tabindex="-1"></a><span class="in">library(brms)             # Bayesian modeling through Stan</span></span>
<span id="cb30-53"><a href="#cb30-53" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidybayes)        # Manipulate Stan objects in a tidy way</span></span>
<span id="cb30-54"><a href="#cb30-54" aria-hidden="true" tabindex="-1"></a><span class="in">library(marginaleffects)  # Calculate marginal effects</span></span>
<span id="cb30-55"><a href="#cb30-55" aria-hidden="true" tabindex="-1"></a><span class="in">library(modelr)           # For quick model grids</span></span>
<span id="cb30-56"><a href="#cb30-56" aria-hidden="true" tabindex="-1"></a><span class="in">library(extraDistr)       # For dprop() beta distribution with mu/phi</span></span>
<span id="cb30-57"><a href="#cb30-57" aria-hidden="true" tabindex="-1"></a><span class="in">library(distributional)   # For plotting distributions with ggdist</span></span>
<span id="cb30-58"><a href="#cb30-58" aria-hidden="true" tabindex="-1"></a><span class="in">library(palmerpenguins)   # Penguins!</span></span>
<span id="cb30-59"><a href="#cb30-59" aria-hidden="true" tabindex="-1"></a><span class="in">library(kableExtra)       # For nicer tables</span></span>
<span id="cb30-60"><a href="#cb30-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-61"><a href="#cb30-61" aria-hidden="true" tabindex="-1"></a><span class="in"># Make random things reproducible</span></span>
<span id="cb30-62"><a href="#cb30-62" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(1234)</span></span>
<span id="cb30-63"><a href="#cb30-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-64"><a href="#cb30-64" aria-hidden="true" tabindex="-1"></a><span class="in"># Bayes stuff</span></span>
<span id="cb30-65"><a href="#cb30-65" aria-hidden="true" tabindex="-1"></a><span class="in"># Use the cmdstanr backend for Stan because it's faster and more modern than</span></span>
<span id="cb30-66"><a href="#cb30-66" aria-hidden="true" tabindex="-1"></a><span class="in"># the default rstan. You need to install the cmdstanr package first</span></span>
<span id="cb30-67"><a href="#cb30-67" aria-hidden="true" tabindex="-1"></a><span class="in"># (https://mc-stan.org/cmdstanr/) and then run cmdstanr::install_cmdstan() to</span></span>
<span id="cb30-68"><a href="#cb30-68" aria-hidden="true" tabindex="-1"></a><span class="in"># install cmdstan on your computer.</span></span>
<span id="cb30-69"><a href="#cb30-69" aria-hidden="true" tabindex="-1"></a><span class="in">options(mc.cores = 4,  # Use 4 cores</span></span>
<span id="cb30-70"><a href="#cb30-70" aria-hidden="true" tabindex="-1"></a><span class="in">        brms.backend = "cmdstanr")</span></span>
<span id="cb30-71"><a href="#cb30-71" aria-hidden="true" tabindex="-1"></a><span class="in">bayes_seed &lt;- 1234</span></span>
<span id="cb30-72"><a href="#cb30-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-73"><a href="#cb30-73" aria-hidden="true" tabindex="-1"></a><span class="in"># Colors from MetBrewer</span></span>
<span id="cb30-74"><a href="#cb30-74" aria-hidden="true" tabindex="-1"></a><span class="in">clrs &lt;- MetBrewer::met.brewer("Java")</span></span>
<span id="cb30-75"><a href="#cb30-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-76"><a href="#cb30-76" aria-hidden="true" tabindex="-1"></a><span class="in"># Custom ggplot themes to make pretty plots</span></span>
<span id="cb30-77"><a href="#cb30-77" aria-hidden="true" tabindex="-1"></a><span class="in"># Get Roboto Condensed at https://fonts.google.com/specimen/Roboto+Condensed</span></span>
<span id="cb30-78"><a href="#cb30-78" aria-hidden="true" tabindex="-1"></a><span class="in"># Get Roboto Mono at https://fonts.google.com/specimen/Roboto+Mono</span></span>
<span id="cb30-79"><a href="#cb30-79" aria-hidden="true" tabindex="-1"></a><span class="in">theme_pred &lt;- function() {</span></span>
<span id="cb30-80"><a href="#cb30-80" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_minimal(base_family = "Roboto Condensed") +</span></span>
<span id="cb30-81"><a href="#cb30-81" aria-hidden="true" tabindex="-1"></a><span class="in">    theme(panel.grid.minor = element_blank(),</span></span>
<span id="cb30-82"><a href="#cb30-82" aria-hidden="true" tabindex="-1"></a><span class="in">          plot.background = element_rect(fill = "white", color = NA),</span></span>
<span id="cb30-83"><a href="#cb30-83" aria-hidden="true" tabindex="-1"></a><span class="in">          plot.title = element_text(face = "bold"),</span></span>
<span id="cb30-84"><a href="#cb30-84" aria-hidden="true" tabindex="-1"></a><span class="in">          strip.text = element_text(face = "bold"),</span></span>
<span id="cb30-85"><a href="#cb30-85" aria-hidden="true" tabindex="-1"></a><span class="in">          strip.background = element_rect(fill = "grey80", color = NA),</span></span>
<span id="cb30-86"><a href="#cb30-86" aria-hidden="true" tabindex="-1"></a><span class="in">          axis.title.x = element_text(hjust = 0),</span></span>
<span id="cb30-87"><a href="#cb30-87" aria-hidden="true" tabindex="-1"></a><span class="in">          axis.title.y = element_text(hjust = 0),</span></span>
<span id="cb30-88"><a href="#cb30-88" aria-hidden="true" tabindex="-1"></a><span class="in">          legend.title = element_text(face = "bold"))</span></span>
<span id="cb30-89"><a href="#cb30-89" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb30-90"><a href="#cb30-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-91"><a href="#cb30-91" aria-hidden="true" tabindex="-1"></a><span class="in">theme_pred_dist &lt;- function() {</span></span>
<span id="cb30-92"><a href="#cb30-92" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_pred() +</span></span>
<span id="cb30-93"><a href="#cb30-93" aria-hidden="true" tabindex="-1"></a><span class="in">    theme(plot.title = element_markdown(family = "Roboto Condensed", face = "plain"),</span></span>
<span id="cb30-94"><a href="#cb30-94" aria-hidden="true" tabindex="-1"></a><span class="in">          plot.subtitle = element_text(family = "Roboto Mono", size = rel(0.9), hjust = 0),</span></span>
<span id="cb30-95"><a href="#cb30-95" aria-hidden="true" tabindex="-1"></a><span class="in">          axis.text.y = element_blank(),</span></span>
<span id="cb30-96"><a href="#cb30-96" aria-hidden="true" tabindex="-1"></a><span class="in">          panel.grid.major.y = element_blank(),</span></span>
<span id="cb30-97"><a href="#cb30-97" aria-hidden="true" tabindex="-1"></a><span class="in">          panel.grid.minor.y = element_blank())</span></span>
<span id="cb30-98"><a href="#cb30-98" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb30-99"><a href="#cb30-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-100"><a href="#cb30-100" aria-hidden="true" tabindex="-1"></a><span class="in">theme_pred_range &lt;- function() {</span></span>
<span id="cb30-101"><a href="#cb30-101" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_pred() +</span></span>
<span id="cb30-102"><a href="#cb30-102" aria-hidden="true" tabindex="-1"></a><span class="in">    theme(plot.title = element_markdown(family = "Roboto Condensed", face = "plain"),</span></span>
<span id="cb30-103"><a href="#cb30-103" aria-hidden="true" tabindex="-1"></a><span class="in">          plot.subtitle = element_text(family = "Roboto Mono", size = rel(0.9), hjust = 0),</span></span>
<span id="cb30-104"><a href="#cb30-104" aria-hidden="true" tabindex="-1"></a><span class="in">          panel.grid.minor.y = element_blank())</span></span>
<span id="cb30-105"><a href="#cb30-105" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb30-106"><a href="#cb30-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-107"><a href="#cb30-107" aria-hidden="true" tabindex="-1"></a><span class="in">update_geom_defaults("text", list(family = "Roboto Condensed", lineheight = 1))</span></span>
<span id="cb30-108"><a href="#cb30-108" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-109"><a href="#cb30-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-110"><a href="#cb30-110" aria-hidden="true" tabindex="-1"></a><span class="in">```{r save-swatch, include=FALSE, eval=FALSE}</span></span>
<span id="cb30-111"><a href="#cb30-111" aria-hidden="true" tabindex="-1"></a><span class="in">clrs |&gt; </span></span>
<span id="cb30-112"><a href="#cb30-112" aria-hidden="true" tabindex="-1"></a><span class="in">  set_names(paste("Java", 1:length(clrs))) |&gt; </span></span>
<span id="cb30-113"><a href="#cb30-113" aria-hidden="true" tabindex="-1"></a><span class="in">  swatches::hex_to_ase("spot") |&gt; </span></span>
<span id="cb30-114"><a href="#cb30-114" aria-hidden="true" tabindex="-1"></a><span class="in">  swatches::ase_encode() |&gt; </span></span>
<span id="cb30-115"><a href="#cb30-115" aria-hidden="true" tabindex="-1"></a><span class="in">  writeBin("Java.ase")</span></span>
<span id="cb30-116"><a href="#cb30-116" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-117"><a href="#cb30-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-118"><a href="#cb30-118" aria-hidden="true" tabindex="-1"></a><span class="in">```{r clean-data, warning=FALSE, message=FALSE}</span></span>
<span id="cb30-119"><a href="#cb30-119" aria-hidden="true" tabindex="-1"></a><span class="in"># Add a couple new variables to the penguins data:</span></span>
<span id="cb30-120"><a href="#cb30-120" aria-hidden="true" tabindex="-1"></a><span class="in">#  - is_gentoo: Indicator for whether or not the penguin is a Gentoo</span></span>
<span id="cb30-121"><a href="#cb30-121" aria-hidden="true" tabindex="-1"></a><span class="in">#  - bill_ratio: The ratio of a penguin's bill depth (height) to its bill length</span></span>
<span id="cb30-122"><a href="#cb30-122" aria-hidden="true" tabindex="-1"></a><span class="in">penguins &lt;- penguins |&gt; </span></span>
<span id="cb30-123"><a href="#cb30-123" aria-hidden="true" tabindex="-1"></a><span class="in">  drop_na(sex) |&gt; </span></span>
<span id="cb30-124"><a href="#cb30-124" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(is_gentoo = species == "Gentoo") |&gt; </span></span>
<span id="cb30-125"><a href="#cb30-125" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(bill_ratio = bill_depth_mm / bill_length_mm)</span></span>
<span id="cb30-126"><a href="#cb30-126" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-127"><a href="#cb30-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-128"><a href="#cb30-128" aria-hidden="true" tabindex="-1"></a><span class="fu">## Normal Gaussian model</span></span>
<span id="cb30-129"><a href="#cb30-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-130"><a href="#cb30-130" aria-hidden="true" tabindex="-1"></a>First we'll look at basic linear regression. Normal or Gaussian models are roughly equivalent to frequentist ordinary least squares (OLS) regression. We estimate an intercept and a slope and draw a line through the data. If we include multiple explanatory variables or predictors, we'll have multiple slopes, or partial derivatives or marginal effects (<span class="co">[</span><span class="ot">see here for more about that</span><span class="co">](https://www.andrewheiss.com/blog/2022/05/20/marginalia/)</span>). But to keep things as simple and basic and illustrative as possible, we'll just use one explanatory variable here.</span>
<span id="cb30-131"><a href="#cb30-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-132"><a href="#cb30-132" aria-hidden="true" tabindex="-1"></a>In this example, we're interested in the relationship between penguin flipper length and penguin body mass. Do penguins with longer flippers weigh more? Here's what the data looks like:</span>
<span id="cb30-133"><a href="#cb30-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-134"><a href="#cb30-134" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-mass-flipper, message=FALSE}</span></span>
<span id="cb30-135"><a href="#cb30-135" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(penguins, aes(x = flipper_length_mm, y = body_mass_g)) +</span></span>
<span id="cb30-136"><a href="#cb30-136" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(size = 1, alpha = 0.7) +</span></span>
<span id="cb30-137"><a href="#cb30-137" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_smooth(method = "lm", color = clrs[5], se = FALSE) +</span></span>
<span id="cb30-138"><a href="#cb30-138" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_y_continuous(labels = label_comma()) +</span></span>
<span id="cb30-139"><a href="#cb30-139" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(ylim = c(2000, 6000)) +</span></span>
<span id="cb30-140"><a href="#cb30-140" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Flipper length (mm)", y = "Body mass (g)") +</span></span>
<span id="cb30-141"><a href="#cb30-141" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_pred()</span></span>
<span id="cb30-142"><a href="#cb30-142" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-143"><a href="#cb30-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-144"><a href="#cb30-144" aria-hidden="true" tabindex="-1"></a>It seems like there's a pretty clear relationship between the two. As flipper length increases, body mass also increases. </span>
<span id="cb30-145"><a href="#cb30-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-146"><a href="#cb30-146" aria-hidden="true" tabindex="-1"></a>We can create a more formal model for the distribution of body mass, conditional on different values of flipper length, like this:</span>
<span id="cb30-147"><a href="#cb30-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-148"><a href="#cb30-148" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb30-149"><a href="#cb30-149" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb30-150"><a href="#cb30-150" aria-hidden="true" tabindex="-1"></a>\text{Body mass}_i &amp;\sim \operatorname{Normal}(\mu_i, \sigma) <span class="sc">\\</span></span>
<span id="cb30-151"><a href="#cb30-151" aria-hidden="true" tabindex="-1"></a>\mu_i &amp;= \alpha + \beta \ \text{Flipper length}_i</span>
<span id="cb30-152"><a href="#cb30-152" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb30-153"><a href="#cb30-153" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb30-154"><a href="#cb30-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-155"><a href="#cb30-155" aria-hidden="true" tabindex="-1"></a>Or more generally:</span>
<span id="cb30-156"><a href="#cb30-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-157"><a href="#cb30-157" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb30-158"><a href="#cb30-158" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb30-159"><a href="#cb30-159" aria-hidden="true" tabindex="-1"></a>y_i &amp;\sim \operatorname{Normal}(\mu_i, \sigma) <span class="sc">\\</span></span>
<span id="cb30-160"><a href="#cb30-160" aria-hidden="true" tabindex="-1"></a>\mu_i &amp;= \alpha + \beta x_i</span>
<span id="cb30-161"><a href="#cb30-161" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb30-162"><a href="#cb30-162" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb30-163"><a href="#cb30-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-164"><a href="#cb30-164" aria-hidden="true" tabindex="-1"></a>This implies that body mass follows a normal (or Gaussian) distribution with some average ($\mu$) and some amount of spread ($\sigma$), and that the $\mu$ parameter is conditional on (or based on, or dependent on) flipper length. </span>
<span id="cb30-165"><a href="#cb30-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-166"><a href="#cb30-166" aria-hidden="true" tabindex="-1"></a>Let's run that model in Stan through **brms** (with all the default priors; in real life you'd want to set more official priors for the intercept $\alpha$, the coefficient $\beta$, and the overall model spread $\sigma$)</span>
<span id="cb30-167"><a href="#cb30-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-168"><a href="#cb30-168" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-normal, cache=TRUE, results="hide"}</span></span>
<span id="cb30-169"><a href="#cb30-169" aria-hidden="true" tabindex="-1"></a><span class="in">model_normal &lt;- brm(</span></span>
<span id="cb30-170"><a href="#cb30-170" aria-hidden="true" tabindex="-1"></a><span class="in">  bf(body_mass_g ~ flipper_length_mm),</span></span>
<span id="cb30-171"><a href="#cb30-171" aria-hidden="true" tabindex="-1"></a><span class="in">  family = gaussian(),</span></span>
<span id="cb30-172"><a href="#cb30-172" aria-hidden="true" tabindex="-1"></a><span class="in">  data = penguins</span></span>
<span id="cb30-173"><a href="#cb30-173" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb30-174"><a href="#cb30-174" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-175"><a href="#cb30-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-176"><a href="#cb30-176" aria-hidden="true" tabindex="-1"></a>If we look at the model results, we can see the means of the posterior distributions of each of the model's parameters ($\alpha$, $\beta$, and $\sigma$). The intercept ($\alpha$) is huge and negative because flipper length is far away from 0, so it's pretty uninterpretable. The $\beta$ coefficient shows that a one-mm increase in flipper length is associated with a 50 gram increase in body mass. And the overall model standard deviation $\sigma$ shows that there's roughly 400 grams of deviation around the mean body mass.</span>
<span id="cb30-177"><a href="#cb30-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-178"><a href="#cb30-178" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-model-normal, warning=FALSE}</span></span>
<span id="cb30-179"><a href="#cb30-179" aria-hidden="true" tabindex="-1"></a><span class="in">broom.mixed::tidy(model_normal) |&gt; </span></span>
<span id="cb30-180"><a href="#cb30-180" aria-hidden="true" tabindex="-1"></a><span class="in">  bind_cols(parameter = c("α", "β", "σ")) |&gt; </span></span>
<span id="cb30-181"><a href="#cb30-181" aria-hidden="true" tabindex="-1"></a><span class="in">  select(parameter, term, estimate, std.error, conf.low, conf.high)</span></span>
<span id="cb30-182"><a href="#cb30-182" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-183"><a href="#cb30-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-184"><a href="#cb30-184" aria-hidden="true" tabindex="-1"></a>That table shows just the posterior means for each of these parameters, but these are technically all complete distributions. In this post we're not interested in these actual values—we're concerned with the outcome, or penguin weight here. (But you can see <span class="co">[</span><span class="ot">this post</span><span class="co">](https://www.andrewheiss.com/blog/2022/05/20/marginalia/)</span> or <span class="co">[</span><span class="ot">this post</span><span class="co">](https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/)</span> or <span class="co">[</span><span class="ot">this post</span><span class="co">](https://www.andrewheiss.com/blog/2022/05/09/hurdle-lognormal-gaussian-brms/)</span> or <span class="co">[</span><span class="ot">this documentation</span><span class="co">](https://mjskay.github.io/tidybayes/articles/tidy-brms.html)</span> for more about working with these coefficients and calculating marginal effects)</span>
<span id="cb30-185"><a href="#cb30-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-186"><a href="#cb30-186" aria-hidden="true" tabindex="-1"></a>Going back to the formal model, so far we've looked at $\alpha$, $\beta$, and $\sigma$, but what about $\mu$ and the overall posterior distribution of the outcome $y$ (or $\operatorname{Normal}(\mu_i, \sigma)$)? This is where life gets a little trickier (and why this guide exists in the first place!). Both $\mu$ and the posterior for $y$ represent penguin body mass, but conceptually they're different things. We'll extract these different distributions with three different **brms** functions: `posterior_predict()`, `posterior_epred()`, and `posterior_linpred()` (the code uses `predicted_draws()`, `epred_draws()`, and `linpred_draws()`; these are **tidybayes**'s wrappers for the corresponding **brms** functions). </span>
<span id="cb30-187"><a href="#cb30-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-188"><a href="#cb30-188" aria-hidden="true" tabindex="-1"></a>Note the <span class="in">`newdata`</span> argument here. We have to feed a data frame of values to plug into to make these different posterior predictions. We could feed the original dataset with <span class="in">`newdata = penguins`</span>, which would plug each row of the data into the model and generate 4000 posterior draws for it. Given that there are 333 rows in penguins data, using <span class="in">`newdata = penguins`</span> would give us 333 × 4,000 = 1,332,000 rows. That's a ton of data, and looking at it all together like that isn't super useful unless we look at predictions across a range of possible predictors. We'll do that later in this section and see the posterior predictions of weights across a range of flipper lengths. But here we're just interested in the prediction of the outcome based on a single value of flipper lengths. We'll use the average (<span class="in">`r mean(penguins$flipper_length_mm)`</span> mm), but it could easily be the median or whatever arbitrary number we want.</span>
<span id="cb30-189"><a href="#cb30-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-190"><a href="#cb30-190" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-normal-posteriors}</span></span>
<span id="cb30-191"><a href="#cb30-191" aria-hidden="true" tabindex="-1"></a><span class="in"># Make a little dataset of just the average flipper length</span></span>
<span id="cb30-192"><a href="#cb30-192" aria-hidden="true" tabindex="-1"></a><span class="in">penguins_avg_flipper &lt;- penguins |&gt; </span></span>
<span id="cb30-193"><a href="#cb30-193" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(flipper_length_mm = mean(flipper_length_mm))</span></span>
<span id="cb30-194"><a href="#cb30-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-195"><a href="#cb30-195" aria-hidden="true" tabindex="-1"></a><span class="in"># Extract different types of posteriors</span></span>
<span id="cb30-196"><a href="#cb30-196" aria-hidden="true" tabindex="-1"></a><span class="in">normal_linpred &lt;- model_normal |&gt; </span></span>
<span id="cb30-197"><a href="#cb30-197" aria-hidden="true" tabindex="-1"></a><span class="in">  linpred_draws(newdata = penguins_avg_flipper)</span></span>
<span id="cb30-198"><a href="#cb30-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-199"><a href="#cb30-199" aria-hidden="true" tabindex="-1"></a><span class="in">normal_epred &lt;- model_normal |&gt; </span></span>
<span id="cb30-200"><a href="#cb30-200" aria-hidden="true" tabindex="-1"></a><span class="in">  epred_draws(newdata = penguins_avg_flipper)</span></span>
<span id="cb30-201"><a href="#cb30-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-202"><a href="#cb30-202" aria-hidden="true" tabindex="-1"></a><span class="in">normal_predicted &lt;- model_normal |&gt; </span></span>
<span id="cb30-203"><a href="#cb30-203" aria-hidden="true" tabindex="-1"></a><span class="in">  predicted_draws(newdata = penguins_avg_flipper,</span></span>
<span id="cb30-204"><a href="#cb30-204" aria-hidden="true" tabindex="-1"></a><span class="in">                  seed = 12345)  # So that the manual results with rnorm() are the same later</span></span>
<span id="cb30-205"><a href="#cb30-205" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-206"><a href="#cb30-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-207"><a href="#cb30-207" aria-hidden="true" tabindex="-1"></a>These each show the posterior distribution of penguin weight, and each corresponds to a different part of the formal mathematical model with. We can explore these nuances if we look at these distributions' means, medians, standard deviations, and overall shapes:</span>
<span id="cb30-208"><a href="#cb30-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-209"><a href="#cb30-209" aria-hidden="true" tabindex="-1"></a><span class="in">```{r tbl-normal-posteriors}</span></span>
<span id="cb30-210"><a href="#cb30-210" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb30-211"><a href="#cb30-211" aria-hidden="true" tabindex="-1"></a><span class="in">#| tbl-cap: Normal posteriors</span></span>
<span id="cb30-212"><a href="#cb30-212" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-inset-right</span></span>
<span id="cb30-213"><a href="#cb30-213" aria-hidden="true" tabindex="-1"></a><span class="in">summary_normal_linpred &lt;- normal_linpred |&gt; </span></span>
<span id="cb30-214"><a href="#cb30-214" aria-hidden="true" tabindex="-1"></a><span class="in">  ungroup() |&gt; </span></span>
<span id="cb30-215"><a href="#cb30-215" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(across(.linpred, lst(mean, sd, median), .names = "{.fn}"))</span></span>
<span id="cb30-216"><a href="#cb30-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-217"><a href="#cb30-217" aria-hidden="true" tabindex="-1"></a><span class="in">summary_normal_epred &lt;- normal_epred |&gt; </span></span>
<span id="cb30-218"><a href="#cb30-218" aria-hidden="true" tabindex="-1"></a><span class="in">  ungroup() |&gt; </span></span>
<span id="cb30-219"><a href="#cb30-219" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(across(.epred, lst(mean, sd, median), .names = "{.fn}"))</span></span>
<span id="cb30-220"><a href="#cb30-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-221"><a href="#cb30-221" aria-hidden="true" tabindex="-1"></a><span class="in">summary_normal_predicted &lt;- normal_predicted |&gt; </span></span>
<span id="cb30-222"><a href="#cb30-222" aria-hidden="true" tabindex="-1"></a><span class="in">  ungroup() |&gt; </span></span>
<span id="cb30-223"><a href="#cb30-223" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(across(.prediction, lst(mean, sd, median), .names = "{.fn}"))</span></span>
<span id="cb30-224"><a href="#cb30-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-225"><a href="#cb30-225" aria-hidden="true" tabindex="-1"></a><span class="in">tribble(</span></span>
<span id="cb30-226"><a href="#cb30-226" aria-hidden="true" tabindex="-1"></a><span class="in">  ~Function, ~`Model element`,</span></span>
<span id="cb30-227"><a href="#cb30-227" aria-hidden="true" tabindex="-1"></a><span class="in">  "&lt;code&gt;posterior_linpred()&lt;/code&gt;", "\\(\\mu\\) in the model",</span></span>
<span id="cb30-228"><a href="#cb30-228" aria-hidden="true" tabindex="-1"></a><span class="in">  "&lt;code&gt;posterior_epred()&lt;/code&gt;", "\\(\\operatorname{E(y)}\\) and \\(\\mu\\) in the model",</span></span>
<span id="cb30-229"><a href="#cb30-229" aria-hidden="true" tabindex="-1"></a><span class="in">  "&lt;code&gt;posterior_predict()&lt;/code&gt;", "Random draws from posterior \\(\\operatorname{Normal}(\\mu_i, \\sigma)\\)"</span></span>
<span id="cb30-230"><a href="#cb30-230" aria-hidden="true" tabindex="-1"></a><span class="in">) |&gt; </span></span>
<span id="cb30-231"><a href="#cb30-231" aria-hidden="true" tabindex="-1"></a><span class="in">  bind_cols(bind_rows(summary_normal_linpred, summary_normal_epred, summary_normal_predicted)) |&gt; </span></span>
<span id="cb30-232"><a href="#cb30-232" aria-hidden="true" tabindex="-1"></a><span class="in">  kbl(escape = FALSE) |&gt; </span></span>
<span id="cb30-233"><a href="#cb30-233" aria-hidden="true" tabindex="-1"></a><span class="in">  kable_styling()</span></span>
<span id="cb30-234"><a href="#cb30-234" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-235"><a href="#cb30-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-236"><a href="#cb30-236" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-normal-posteriors, fig.width=6, fig.height=8, warning=FALSE}</span></span>
<span id="cb30-237"><a href="#cb30-237" aria-hidden="true" tabindex="-1"></a><span class="in">p1 &lt;- ggplot(normal_linpred, aes(x = .linpred)) +</span></span>
<span id="cb30-238"><a href="#cb30-238" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye(fill = clrs[3]) +</span></span>
<span id="cb30-239"><a href="#cb30-239" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_comma()) +</span></span>
<span id="cb30-240"><a href="#cb30-240" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(xlim = c(4100, 4300)) +</span></span>
<span id="cb30-241"><a href="#cb30-241" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Body mass (g)", y = NULL,</span></span>
<span id="cb30-242"><a href="#cb30-242" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "**Linear predictor** &lt;span style='font-size: 14px;'&gt;*µ* in the model&lt;/span&gt;",</span></span>
<span id="cb30-243"><a href="#cb30-243" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "posterior_linpred(..., tibble(flipper_length_mm = 201))") +</span></span>
<span id="cb30-244"><a href="#cb30-244" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_pred_dist() +</span></span>
<span id="cb30-245"><a href="#cb30-245" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(plot.title = element_markdown())</span></span>
<span id="cb30-246"><a href="#cb30-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-247"><a href="#cb30-247" aria-hidden="true" tabindex="-1"></a><span class="in">p2 &lt;- ggplot(normal_epred, aes(x = .epred)) +</span></span>
<span id="cb30-248"><a href="#cb30-248" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye(fill = clrs[2]) +</span></span>
<span id="cb30-249"><a href="#cb30-249" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_comma()) +</span></span>
<span id="cb30-250"><a href="#cb30-250" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(xlim = c(4100, 4300)) +</span></span>
<span id="cb30-251"><a href="#cb30-251" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Body mass (g)", y = NULL,</span></span>
<span id="cb30-252"><a href="#cb30-252" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "**Expectation of the posterior** &lt;span style='font-size: 14px;'&gt;E[*y*] and *µ* in the model&lt;/span&gt;",</span></span>
<span id="cb30-253"><a href="#cb30-253" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "posterior_epred(..., tibble(flipper_length_mm = 201))") +</span></span>
<span id="cb30-254"><a href="#cb30-254" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_pred_dist()</span></span>
<span id="cb30-255"><a href="#cb30-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-256"><a href="#cb30-256" aria-hidden="true" tabindex="-1"></a><span class="in">p3 &lt;- ggplot(normal_predicted, aes(x = .prediction)) +</span></span>
<span id="cb30-257"><a href="#cb30-257" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye(fill = clrs[1]) +</span></span>
<span id="cb30-258"><a href="#cb30-258" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_comma()) +</span></span>
<span id="cb30-259"><a href="#cb30-259" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(xlim = c(2900, 5500)) +</span></span>
<span id="cb30-260"><a href="#cb30-260" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Body mass (g)", y = NULL,</span></span>
<span id="cb30-261"><a href="#cb30-261" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "**Posterior predictions** &lt;span style='font-size: 14px;'&gt;Random draws from posterior Normal(*µ*, *σ*)&lt;/span&gt;",</span></span>
<span id="cb30-262"><a href="#cb30-262" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "posterior_predict(..., tibble(flipper_length_mm = 201))") +</span></span>
<span id="cb30-263"><a href="#cb30-263" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_pred_dist()</span></span>
<span id="cb30-264"><a href="#cb30-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-265"><a href="#cb30-265" aria-hidden="true" tabindex="-1"></a><span class="in">(p1 / plot_spacer() / p2 / plot_spacer() / p3) +</span></span>
<span id="cb30-266"><a href="#cb30-266" aria-hidden="true" tabindex="-1"></a><span class="in">  plot_layout(heights = c(0.3, 0.05, 0.3, 0.05, 0.3))</span></span>
<span id="cb30-267"><a href="#cb30-267" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-268"><a href="#cb30-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-269"><a href="#cb30-269" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pdf-plot-normal-posteriors, include=FALSE}</span></span>
<span id="cb30-270"><a href="#cb30-270" aria-hidden="true" tabindex="-1"></a><span class="in">ggsave("images/normal-posteriors.pdf", plot = last_plot(), device = cairo_pdf,</span></span>
<span id="cb30-271"><a href="#cb30-271" aria-hidden="true" tabindex="-1"></a><span class="in">       width = 6, height = 8, units = "in")</span></span>
<span id="cb30-272"><a href="#cb30-272" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-273"><a href="#cb30-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-274"><a href="#cb30-274" aria-hidden="true" tabindex="-1"></a>The most obvious difference between these different posterior predictions is the range of predictions. For <span class="in">`posterior_linpred()`</span> and <span class="in">`posterior_epred()`</span>, the standard error is tiny and the range of plausible predicted values is really narrow. For <span class="in">`posterior_predict()`</span>, the standard error is substantially bigger, and the corresponding range of predicted values is huge. </span>
<span id="cb30-275"><a href="#cb30-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-276"><a href="#cb30-276" aria-hidden="true" tabindex="-1"></a>To understand why, let's explore the math going on behind the scenes in these functions. Both <span class="in">`posterior_linpred()`</span> and <span class="in">`posterior_epred()`</span> correspond to the $\mu$ part of the model. They're the average penguin weight as predicted by the linear model (hence <span class="in">`linpred`</span>; **lin**ear **pred**ictor). We can see this if we plug a 201 mm flipper length into each row of the posterior and calculate <span class="in">`mu`</span> by hand with $\beta_0 + (\beta_1 \times 201)$:</span>
<span id="cb30-277"><a href="#cb30-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-278"><a href="#cb30-278" aria-hidden="true" tabindex="-1"></a><span class="in">```{r make-linpred-manual}</span></span>
<span id="cb30-279"><a href="#cb30-279" aria-hidden="true" tabindex="-1"></a><span class="in">linpred_manual &lt;- model_normal |&gt; </span></span>
<span id="cb30-280"><a href="#cb30-280" aria-hidden="true" tabindex="-1"></a><span class="in">  spread_draws(b_Intercept, b_flipper_length_mm) |&gt; </span></span>
<span id="cb30-281"><a href="#cb30-281" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(mu = b_Intercept + </span></span>
<span id="cb30-282"><a href="#cb30-282" aria-hidden="true" tabindex="-1"></a><span class="in">           (b_flipper_length_mm * penguins_avg_flipper$flipper_length_mm))</span></span>
<span id="cb30-283"><a href="#cb30-283" aria-hidden="true" tabindex="-1"></a><span class="in">linpred_manual</span></span>
<span id="cb30-284"><a href="#cb30-284" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-285"><a href="#cb30-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-286"><a href="#cb30-286" aria-hidden="true" tabindex="-1"></a>That <span class="in">`mu`</span> column is identical to what we calculate with <span class="in">`posterior_linpred()`</span>. Just to confirm, we can plot the two distributions:</span>
<span id="cb30-287"><a href="#cb30-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-288"><a href="#cb30-288" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-linpred-manual, fig.width=9.5, fig.height=3, out.width="100%"}</span></span>
<span id="cb30-289"><a href="#cb30-289" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-inset-right</span></span>
<span id="cb30-290"><a href="#cb30-290" aria-hidden="true" tabindex="-1"></a><span class="in">p1_manual &lt;- linpred_manual |&gt; </span></span>
<span id="cb30-291"><a href="#cb30-291" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = mu)) + </span></span>
<span id="cb30-292"><a href="#cb30-292" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye(fill = colorspace::lighten(clrs[3], 0.5)) +</span></span>
<span id="cb30-293"><a href="#cb30-293" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_comma()) +</span></span>
<span id="cb30-294"><a href="#cb30-294" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(xlim = c(4100, 4300)) +</span></span>
<span id="cb30-295"><a href="#cb30-295" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Body mass (g)", y = NULL,</span></span>
<span id="cb30-296"><a href="#cb30-296" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "**Linear predictor** &lt;span style='font-size: 14px;'&gt;*µ* in the model&lt;/span&gt;",</span></span>
<span id="cb30-297"><a href="#cb30-297" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "b_Intercept + (b_flipper_length_mm * 201)") +</span></span>
<span id="cb30-298"><a href="#cb30-298" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_pred_dist() +</span></span>
<span id="cb30-299"><a href="#cb30-299" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(plot.title = element_markdown())</span></span>
<span id="cb30-300"><a href="#cb30-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-301"><a href="#cb30-301" aria-hidden="true" tabindex="-1"></a><span class="in">p1_manual | p1</span></span>
<span id="cb30-302"><a href="#cb30-302" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-303"><a href="#cb30-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-304"><a href="#cb30-304" aria-hidden="true" tabindex="-1"></a>Importantly, the distribution of the $\mu$ part of the model here does *not* incorporate information about $\sigma$. That's why the distribution is so narrow.</span>
<span id="cb30-305"><a href="#cb30-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-306"><a href="#cb30-306" aria-hidden="true" tabindex="-1"></a>The results from <span class="in">`posterior_predict()`</span>, on the other hand, correspond to the $y$ part of the model. Officially, they are draws from a random normal distribution using *both* the estimated $\mu$ and the estimated $\sigma$. These results contain the full uncertainty of the posterior distribution of penguin weight. To help with the intuition, we can do the same thing by hand when plugging in a 201 mm flipper length:</span>
<span id="cb30-307"><a href="#cb30-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-308"><a href="#cb30-308" aria-hidden="true" tabindex="-1"></a><span class="in">```{r make-posterior-predict-manual}</span></span>
<span id="cb30-309"><a href="#cb30-309" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(12345)  # To get the same results as posterior_predict() from earlier</span></span>
<span id="cb30-310"><a href="#cb30-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-311"><a href="#cb30-311" aria-hidden="true" tabindex="-1"></a><span class="in">postpred_manual &lt;- model_normal |&gt; </span></span>
<span id="cb30-312"><a href="#cb30-312" aria-hidden="true" tabindex="-1"></a><span class="in">  spread_draws(b_Intercept, b_flipper_length_mm, sigma) |&gt; </span></span>
<span id="cb30-313"><a href="#cb30-313" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(mu = b_Intercept + </span></span>
<span id="cb30-314"><a href="#cb30-314" aria-hidden="true" tabindex="-1"></a><span class="in">           (b_flipper_length_mm * </span></span>
<span id="cb30-315"><a href="#cb30-315" aria-hidden="true" tabindex="-1"></a><span class="in">              penguins_avg_flipper$flipper_length_mm),  # This is posterior_linpred()</span></span>
<span id="cb30-316"><a href="#cb30-316" aria-hidden="true" tabindex="-1"></a><span class="in">         y_new = rnorm(n(), mean = mu, sd = sigma))  # This is posterior_predict()</span></span>
<span id="cb30-317"><a href="#cb30-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-318"><a href="#cb30-318" aria-hidden="true" tabindex="-1"></a><span class="in">postpred_manual |&gt; </span></span>
<span id="cb30-319"><a href="#cb30-319" aria-hidden="true" tabindex="-1"></a><span class="in">  select(.draw:y_new)</span></span>
<span id="cb30-320"><a href="#cb30-320" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-321"><a href="#cb30-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-322"><a href="#cb30-322" aria-hidden="true" tabindex="-1"></a>That <span class="in">`y_new`</span> column here is the $y$ part of the model and should have a lot more uncertainty than the <span class="in">`mu`</span> column, which is just the $\mu$ part of the model. Notably, the <span class="in">`y_new`</span> column is the same as what we get when using <span class="in">`posterior predict()`</span>. We'll plot the two distributions to confirm:</span>
<span id="cb30-323"><a href="#cb30-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-324"><a href="#cb30-324" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-postpred-manual, fig.width=9.5, fig.height=3, out.width="100%"}</span></span>
<span id="cb30-325"><a href="#cb30-325" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-inset-right</span></span>
<span id="cb30-326"><a href="#cb30-326" aria-hidden="true" tabindex="-1"></a><span class="in">p3_manual &lt;- postpred_manual |&gt; </span></span>
<span id="cb30-327"><a href="#cb30-327" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = y_new)) + </span></span>
<span id="cb30-328"><a href="#cb30-328" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye(fill = colorspace::lighten(clrs[1], 0.5)) +</span></span>
<span id="cb30-329"><a href="#cb30-329" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_comma()) +</span></span>
<span id="cb30-330"><a href="#cb30-330" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(xlim = c(2900, 5500)) +</span></span>
<span id="cb30-331"><a href="#cb30-331" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Body mass (g)", y = NULL,</span></span>
<span id="cb30-332"><a href="#cb30-332" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "**Posterior predictions** &lt;span style='font-size: 14px;'&gt;Random draws from posterior Normal(*µ*, *σ*)&lt;/span&gt;",</span></span>
<span id="cb30-333"><a href="#cb30-333" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "rnorm(b_Intercept + (b_flipper_length_mm * 201), sigma)") +</span></span>
<span id="cb30-334"><a href="#cb30-334" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_pred_dist() +</span></span>
<span id="cb30-335"><a href="#cb30-335" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(plot.title = element_markdown())</span></span>
<span id="cb30-336"><a href="#cb30-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-337"><a href="#cb30-337" aria-hidden="true" tabindex="-1"></a><span class="in">p3_manual | p3</span></span>
<span id="cb30-338"><a href="#cb30-338" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-339"><a href="#cb30-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-340"><a href="#cb30-340" aria-hidden="true" tabindex="-1"></a>The results from <span class="in">`posterior_predict()`</span> and <span class="in">`posterior_linpred()`</span> have the same mean, but the full posterior predictions that incorporate the estimated $\sigma$ have a much wider range of plausible values. </span>
<span id="cb30-341"><a href="#cb30-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-342"><a href="#cb30-342" aria-hidden="true" tabindex="-1"></a>The results from <span class="in">`posterior_epred()`</span> are a little strange to understand, and in the case of normal/Gaussian regression (and many other types of regression models!), they're identical to the linear predictor (<span class="in">`posterior_linpred()`</span>). These are the posterior draws of the expected value or mean of the the posterior distribution, or $E(y_i)$ in the model. Behind the scenes, this is calculated by taking the average of each row's posterior distribution and then taking the average of *that*. </span>
<span id="cb30-343"><a href="#cb30-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-344"><a href="#cb30-344" aria-hidden="true" tabindex="-1"></a>Once again, a quick illustration can help. As before, we'll manually plug a flipper length of 201 mm into the posterior estimates of the intercept and slope to calculate the $\mu$ part of the model. We'll then use that $\mu$ along with the estimated $\sigma$ to in <span class="in">`rnorm()`</span> to generate the posterior predictive distribution, or the $y$ part of the model. Finally, we'll take the average of the <span class="in">`y_new`</span> posterior predictive distribution to get the expectation of the posterior predictive distribution, or <span class="in">`epred`</span>. It's the same as what we get when using <span class="in">`posterior_epred()`</span>; the only differences are because of randomness.</span>
<span id="cb30-345"><a href="#cb30-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-346"><a href="#cb30-346" aria-hidden="true" tabindex="-1"></a><span class="in">```{r epred-manual}</span></span>
<span id="cb30-347"><a href="#cb30-347" aria-hidden="true" tabindex="-1"></a><span class="in">epred_manual &lt;- model_normal |&gt; </span></span>
<span id="cb30-348"><a href="#cb30-348" aria-hidden="true" tabindex="-1"></a><span class="in">  spread_draws(b_Intercept, b_flipper_length_mm, sigma) |&gt; </span></span>
<span id="cb30-349"><a href="#cb30-349" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(mu = b_Intercept + </span></span>
<span id="cb30-350"><a href="#cb30-350" aria-hidden="true" tabindex="-1"></a><span class="in">           (b_flipper_length_mm * </span></span>
<span id="cb30-351"><a href="#cb30-351" aria-hidden="true" tabindex="-1"></a><span class="in">              penguins_avg_flipper$flipper_length_mm),  # This is posterior_linpred()</span></span>
<span id="cb30-352"><a href="#cb30-352" aria-hidden="true" tabindex="-1"></a><span class="in">         y_new = rnorm(n(), mean = mu, sd = sigma))  # This is posterior_predict()</span></span>
<span id="cb30-353"><a href="#cb30-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-354"><a href="#cb30-354" aria-hidden="true" tabindex="-1"></a><span class="in"># This is posterior_epred()</span></span>
<span id="cb30-355"><a href="#cb30-355" aria-hidden="true" tabindex="-1"></a><span class="in">epred_manual |&gt; </span></span>
<span id="cb30-356"><a href="#cb30-356" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(epred = mean(y_new))</span></span>
<span id="cb30-357"><a href="#cb30-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-358"><a href="#cb30-358" aria-hidden="true" tabindex="-1"></a><span class="in"># It's essentially the same as the actual posterior_epred()</span></span>
<span id="cb30-359"><a href="#cb30-359" aria-hidden="true" tabindex="-1"></a><span class="in">normal_epred |&gt; </span></span>
<span id="cb30-360"><a href="#cb30-360" aria-hidden="true" tabindex="-1"></a><span class="in">  ungroup() |&gt;</span></span>
<span id="cb30-361"><a href="#cb30-361" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(epred = mean(.epred))</span></span>
<span id="cb30-362"><a href="#cb30-362" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-363"><a href="#cb30-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-364"><a href="#cb30-364" aria-hidden="true" tabindex="-1"></a>For mathy reasons, in Gaussian regression, this $\operatorname{E(y)}$ happens to be identical to the linear predictor $\mu$, so the results from <span class="in">`posterior_linpred()`</span> and <span class="in">`posterior_epred()`</span> are identical. And—fun fact—the **brms** code for <span class="in">`posterior_epred()`</span> for Gaussian models doesn't recalculate the average of the posterior. <span class="co">[</span><span class="ot">It just returns the linear predictor</span><span class="co">](https://github.com/paul-buerkner/brms/blob/28f778d7933f95422dda8f9a9f4333b975261120/R/posterior_epred.R#L341)</span> $\mu$.</span>
<span id="cb30-365"><a href="#cb30-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-366"><a href="#cb30-366" aria-hidden="true" tabindex="-1"></a>We can also look at these different types of posterior predictions across a range of possible flipper lengths. There's a lot more uncertainty in the full posterior, since it incorporates the uncertainty of both $\mu$ and $\sigma$, while the uncertainty of the linear predictor/expected value of the posterior is much more narrow (and equivalent in this case):</span>
<span id="cb30-367"><a href="#cb30-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-368"><a href="#cb30-368" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-normal-predictions, fig.width=6, fig.height=8, warning=FALSE}</span></span>
<span id="cb30-369"><a href="#cb30-369" aria-hidden="true" tabindex="-1"></a><span class="in">p1 &lt;- penguins |&gt; </span></span>
<span id="cb30-370"><a href="#cb30-370" aria-hidden="true" tabindex="-1"></a><span class="in">  data_grid(flipper_length_mm = seq_range(flipper_length_mm, n = 100)) |&gt; </span></span>
<span id="cb30-371"><a href="#cb30-371" aria-hidden="true" tabindex="-1"></a><span class="in">  add_linpred_draws(model_normal, ndraws = 100) |&gt; </span></span>
<span id="cb30-372"><a href="#cb30-372" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = flipper_length_mm)) +</span></span>
<span id="cb30-373"><a href="#cb30-373" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_lineribbon(aes(y = .linpred), .width = 0.95,</span></span>
<span id="cb30-374"><a href="#cb30-374" aria-hidden="true" tabindex="-1"></a><span class="in">                  alpha = 0.5, color = clrs[3], fill = clrs[3]) +</span></span>
<span id="cb30-375"><a href="#cb30-375" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(data = penguins, aes(y = body_mass_g), size = 1, alpha = 0.7) +</span></span>
<span id="cb30-376"><a href="#cb30-376" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_y_continuous(labels = label_comma()) +</span></span>
<span id="cb30-377"><a href="#cb30-377" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(ylim = c(2000, 6000)) +</span></span>
<span id="cb30-378"><a href="#cb30-378" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Flipper length (mm)", y = "Body mass (g)",</span></span>
<span id="cb30-379"><a href="#cb30-379" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "**Linear predictor** &lt;span style='font-size: 14px;'&gt;*µ* in the model&lt;/span&gt;",</span></span>
<span id="cb30-380"><a href="#cb30-380" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "posterior_linpred()") +</span></span>
<span id="cb30-381"><a href="#cb30-381" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_pred_range()</span></span>
<span id="cb30-382"><a href="#cb30-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-383"><a href="#cb30-383" aria-hidden="true" tabindex="-1"></a><span class="in">p2 &lt;- penguins |&gt; </span></span>
<span id="cb30-384"><a href="#cb30-384" aria-hidden="true" tabindex="-1"></a><span class="in">  data_grid(flipper_length_mm = seq_range(flipper_length_mm, n = 100)) |&gt; </span></span>
<span id="cb30-385"><a href="#cb30-385" aria-hidden="true" tabindex="-1"></a><span class="in">  add_epred_draws(model_normal, ndraws = 100) |&gt; </span></span>
<span id="cb30-386"><a href="#cb30-386" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = flipper_length_mm)) +</span></span>
<span id="cb30-387"><a href="#cb30-387" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_lineribbon(aes(y = .epred), .width = 0.95,</span></span>
<span id="cb30-388"><a href="#cb30-388" aria-hidden="true" tabindex="-1"></a><span class="in">                  alpha = 0.5, color = clrs[2], fill = clrs[2]) +</span></span>
<span id="cb30-389"><a href="#cb30-389" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(data = penguins, aes(y = body_mass_g), size = 1, alpha = 0.7) +</span></span>
<span id="cb30-390"><a href="#cb30-390" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_y_continuous(labels = label_comma()) +</span></span>
<span id="cb30-391"><a href="#cb30-391" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(ylim = c(2000, 6000)) +</span></span>
<span id="cb30-392"><a href="#cb30-392" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Flipper length (mm)", y = "Body mass (g)",</span></span>
<span id="cb30-393"><a href="#cb30-393" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "**Expectation of the posterior** &lt;span style='font-size: 14px;'&gt;E[*y*] and *µ* in the model&lt;/span&gt;",</span></span>
<span id="cb30-394"><a href="#cb30-394" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "posterior_epred()") +</span></span>
<span id="cb30-395"><a href="#cb30-395" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_pred_range()</span></span>
<span id="cb30-396"><a href="#cb30-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-397"><a href="#cb30-397" aria-hidden="true" tabindex="-1"></a><span class="in">p3 &lt;- penguins |&gt; </span></span>
<span id="cb30-398"><a href="#cb30-398" aria-hidden="true" tabindex="-1"></a><span class="in">  data_grid(flipper_length_mm = seq_range(flipper_length_mm, n = 100)) |&gt; </span></span>
<span id="cb30-399"><a href="#cb30-399" aria-hidden="true" tabindex="-1"></a><span class="in">  add_predicted_draws(model_normal, ndraws = 100) |&gt; </span></span>
<span id="cb30-400"><a href="#cb30-400" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = flipper_length_mm)) +</span></span>
<span id="cb30-401"><a href="#cb30-401" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_lineribbon(aes(y = .prediction), .width = 0.95,</span></span>
<span id="cb30-402"><a href="#cb30-402" aria-hidden="true" tabindex="-1"></a><span class="in">                  alpha = 0.5, color = clrs[1], fill = clrs[1]) +</span></span>
<span id="cb30-403"><a href="#cb30-403" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(data = penguins, aes(y = body_mass_g), size = 1, alpha = 0.7) +</span></span>
<span id="cb30-404"><a href="#cb30-404" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_y_continuous(labels = label_comma()) +</span></span>
<span id="cb30-405"><a href="#cb30-405" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(ylim = c(2000, 6000)) +</span></span>
<span id="cb30-406"><a href="#cb30-406" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Flipper length (mm)", y = "Body mass (g)",</span></span>
<span id="cb30-407"><a href="#cb30-407" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "**Posterior predictions** &lt;span style='font-size: 14px;'&gt;Random draws from posterior Normal(*µ*, *σ*)&lt;/span&gt;",</span></span>
<span id="cb30-408"><a href="#cb30-408" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "posterior_predict()") +</span></span>
<span id="cb30-409"><a href="#cb30-409" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_pred_range()</span></span>
<span id="cb30-410"><a href="#cb30-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-411"><a href="#cb30-411" aria-hidden="true" tabindex="-1"></a><span class="in">(p1 / plot_spacer() / p2 / plot_spacer() / p3) +</span></span>
<span id="cb30-412"><a href="#cb30-412" aria-hidden="true" tabindex="-1"></a><span class="in">  plot_layout(heights = c(0.3, 0.05, 0.3, 0.05, 0.3))</span></span>
<span id="cb30-413"><a href="#cb30-413" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-414"><a href="#cb30-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-415"><a href="#cb30-415" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pdf-plot-normal-predictions, include=FALSE}</span></span>
<span id="cb30-416"><a href="#cb30-416" aria-hidden="true" tabindex="-1"></a><span class="in">ggsave("images/normal-predictions.pdf", plot = last_plot(), device = cairo_pdf,</span></span>
<span id="cb30-417"><a href="#cb30-417" aria-hidden="true" tabindex="-1"></a><span class="in">       width = 6, height = 8, units = "in")</span></span>
<span id="cb30-418"><a href="#cb30-418" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-419"><a href="#cb30-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-420"><a href="#cb30-420" aria-hidden="true" tabindex="-1"></a>Phew. There are a lot of moving parts here with different types of posteriors and averages and variances. Here's a helpful diagram that shows how everything is connected and which R functions calculate which parts:</span>
<span id="cb30-421"><a href="#cb30-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-422"><a href="#cb30-422" aria-hidden="true" tabindex="-1"></a><span class="in">```{r normal-diagram, echo=FALSE, out.width="100%"}</span></span>
<span id="cb30-423"><a href="#cb30-423" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-inset-right</span></span>
<span id="cb30-424"><a href="#cb30-424" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::include_graphics("images/normal@3x.png")</span></span>
<span id="cb30-425"><a href="#cb30-425" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-426"><a href="#cb30-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-427"><a href="#cb30-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-428"><a href="#cb30-428" aria-hidden="true" tabindex="-1"></a><span class="fu">## Generalized linear models with link transformations</span></span>
<span id="cb30-429"><a href="#cb30-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-430"><a href="#cb30-430" aria-hidden="true" tabindex="-1"></a>Generalized linear models (e.g., logistic, probit, ordered logistic, exponential, Poisson, negative binomial, etc.) use special link functions (e.g. logit, log, etc.) to transform the likelihood of an outcome into a scale that is more amenable to linear regression.</span>
<span id="cb30-431"><a href="#cb30-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-432"><a href="#cb30-432" aria-hidden="true" tabindex="-1"></a>Estimates from these models can be used in their transformed scales (e.g., log odds in logistic regression) or can be back-transformed into their original scale (e.g., probabilities in logistic regression).</span>
<span id="cb30-433"><a href="#cb30-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-434"><a href="#cb30-434" aria-hidden="true" tabindex="-1"></a>When working with links, the various Bayesian prediction functions return values on different scales, each corresponding to different parts of the model.</span>
<span id="cb30-435"><a href="#cb30-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-436"><a href="#cb30-436" aria-hidden="true" tabindex="-1"></a><span class="fu">### Logistic regression example</span></span>
<span id="cb30-437"><a href="#cb30-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-438"><a href="#cb30-438" aria-hidden="true" tabindex="-1"></a>To show how different link functions work with posteriors from generalized linear models, we'll use logistic regression with a single explanatory variable (again, for the sake of illustrative simplicity). We're interested in whether a penguin's bill length can predict if a penguin is a <span class="co">[</span><span class="ot">Gentoo</span><span class="co">](https://en.wikipedia.org/wiki/Gentoo_penguin)</span> or not. Here's what the data looks like—Gentoos seem to have taller bills than their Chinstrap and Adélie counterparts.</span>
<span id="cb30-439"><a href="#cb30-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-440"><a href="#cb30-440" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-gentoo-bill-depth, message=FALSE}</span></span>
<span id="cb30-441"><a href="#cb30-441" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(penguins, aes(x = bill_length_mm, y = as.numeric(is_gentoo))) +</span></span>
<span id="cb30-442"><a href="#cb30-442" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_dots(aes(side = ifelse(is_gentoo, "bottom", "top")), </span></span>
<span id="cb30-443"><a href="#cb30-443" aria-hidden="true" tabindex="-1"></a><span class="in">            pch = 19, color = "grey20", scale = 0.2) +</span></span>
<span id="cb30-444"><a href="#cb30-444" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_smooth(method = "glm", method.args = list(family = binomial(link = "logit")),</span></span>
<span id="cb30-445"><a href="#cb30-445" aria-hidden="true" tabindex="-1"></a><span class="in">              color = clrs[5], se = FALSE) +</span></span>
<span id="cb30-446"><a href="#cb30-446" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_y_continuous(labels = label_percent()) +</span></span>
<span id="cb30-447"><a href="#cb30-447" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Bill length (mm)", y = "Probability of being a Gentoo") +</span></span>
<span id="cb30-448"><a href="#cb30-448" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_pred()</span></span>
<span id="cb30-449"><a href="#cb30-449" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-450"><a href="#cb30-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-451"><a href="#cb30-451" aria-hidden="true" tabindex="-1"></a>We ultimately want to model that curvy line, but working with regular slopes and intercepts makes it tricky, since the data is all constrained between 0% and 100% and the line is, um, curvy. If we were economists we could just <span class="co">[</span><span class="ot">stick a straight line on that graph, call it a linear probability model, and be done</span><span class="co">](https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/#1-linear-probability-models)</span>. But that's weird.</span>
<span id="cb30-452"><a href="#cb30-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-453"><a href="#cb30-453" aria-hidden="true" tabindex="-1"></a>Instead, we can transform the outcome variable from 0s and 1s into logged odds or logits, which creates a nice straight line that we can use with regular old linear regression. Again, I won't go into the details of how logistic regression works here (see <span class="co">[</span><span class="ot">this example</span><span class="co">](https://evalf22.classes.andrewheiss.com/example/matching-ipw.html#oversimplified-crash-course-in-logistic-regression)</span> or <span class="co">[</span><span class="ot">this tutorial</span><span class="co">](https://uc-r.github.io/logistic_regression)</span> or <span class="co">[</span><span class="ot">this post</span><span class="co">](https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/#2-fractional-logistic-regression)</span> or <span class="co">[</span><span class="ot">this post</span><span class="co">](http://post8000.svmiller.com/lab-scripts/logistic-regression-lab.html)</span> for lots more about it). </span>
<span id="cb30-454"><a href="#cb30-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-455"><a href="#cb30-455" aria-hidden="true" tabindex="-1"></a>Just know that logits (or log odds) are a transformation of probabilities ($p$) into a different scale using on this formula:</span>
<span id="cb30-456"><a href="#cb30-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-457"><a href="#cb30-457" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb30-458"><a href="#cb30-458" aria-hidden="true" tabindex="-1"></a>\operatorname{logit}(p) = \log\left(\frac{p}{1 - p}\right)</span>
<span id="cb30-459"><a href="#cb30-459" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb30-460"><a href="#cb30-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-461"><a href="#cb30-461" aria-hidden="true" tabindex="-1"></a>This plot shows the relationship between the two scales. Probabilities range from 0 to 1, while logits typically range from −4 to 4ish, where logit of 0 is a $p$ of 0.5. There are big changes in probability between −4ish and 4ish, but once you start getting into the 5s and beyond, the probability is all essentially the same.</span>
<span id="cb30-462"><a href="#cb30-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-463"><a href="#cb30-463" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-logit-p, fig.width=5, fig.height=2.5, warning=FALSE}</span></span>
<span id="cb30-464"><a href="#cb30-464" aria-hidden="true" tabindex="-1"></a><span class="in">tibble(x = seq(-8, 8, by = 0.1)) |&gt; </span></span>
<span id="cb30-465"><a href="#cb30-465" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(y = plogis(x)) |&gt; </span></span>
<span id="cb30-466"><a href="#cb30-466" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = x, y = y)) +</span></span>
<span id="cb30-467"><a href="#cb30-467" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(size = 1, color = clrs[4]) +</span></span>
<span id="cb30-468"><a href="#cb30-468" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Logit scale", y = "Probability scale") +</span></span>
<span id="cb30-469"><a href="#cb30-469" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_pred()</span></span>
<span id="cb30-470"><a href="#cb30-470" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-471"><a href="#cb30-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-472"><a href="#cb30-472" aria-hidden="true" tabindex="-1"></a>We can create a formal model for the probability of being a Gentoo following a binomial distribution with a size of 1 (i.e. the distribution contains only 0s and 1s—either the penguin is a Gentoo or it is not), and a probability $\pi$ that is conditional on different values of bill length:</span>
<span id="cb30-473"><a href="#cb30-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-474"><a href="#cb30-474" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb30-475"><a href="#cb30-475" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb30-476"><a href="#cb30-476" aria-hidden="true" tabindex="-1"></a>\text{Is Gentoo?}_i &amp;\sim \operatorname{Binomial}(1, \pi_i) <span class="sc">\\</span></span>
<span id="cb30-477"><a href="#cb30-477" aria-hidden="true" tabindex="-1"></a>\operatorname{logit}(\pi_i) &amp;= \alpha + \beta \ \text{Bill length}_i</span>
<span id="cb30-478"><a href="#cb30-478" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb30-479"><a href="#cb30-479" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb30-480"><a href="#cb30-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-481"><a href="#cb30-481" aria-hidden="true" tabindex="-1"></a>Or more generally, </span>
<span id="cb30-482"><a href="#cb30-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-483"><a href="#cb30-483" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb30-484"><a href="#cb30-484" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb30-485"><a href="#cb30-485" aria-hidden="true" tabindex="-1"></a>y_i &amp;\sim \operatorname{Binomial}(1, \pi_i) <span class="sc">\\</span></span>
<span id="cb30-486"><a href="#cb30-486" aria-hidden="true" tabindex="-1"></a>\operatorname{logit}(\pi_i) &amp;= \alpha + \beta x_i</span>
<span id="cb30-487"><a href="#cb30-487" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb30-488"><a href="#cb30-488" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb30-489"><a href="#cb30-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-490"><a href="#cb30-490" aria-hidden="true" tabindex="-1"></a>Model time! Again, we're using all the default priors here—in real life you'd want to set more official priors for the intercept $\alpha$ and the coefficient $\beta$, especially since $\beta$ is <span class="co">[</span><span class="ot">on the logit scale and unlikely to ever be bigger than 3 or 4</span><span class="co">](https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/#set-better-priors)</span>.</span>
<span id="cb30-491"><a href="#cb30-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-492"><a href="#cb30-492" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-logit, cache=TRUE, results="hide"}</span></span>
<span id="cb30-493"><a href="#cb30-493" aria-hidden="true" tabindex="-1"></a><span class="in">model_logit &lt;- brm(</span></span>
<span id="cb30-494"><a href="#cb30-494" aria-hidden="true" tabindex="-1"></a><span class="in">  bf(is_gentoo ~ bill_length_mm),</span></span>
<span id="cb30-495"><a href="#cb30-495" aria-hidden="true" tabindex="-1"></a><span class="in">  family = bernoulli(link = "logit"),</span></span>
<span id="cb30-496"><a href="#cb30-496" aria-hidden="true" tabindex="-1"></a><span class="in">  data = penguins</span></span>
<span id="cb30-497"><a href="#cb30-497" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb30-498"><a href="#cb30-498" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-499"><a href="#cb30-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-500"><a href="#cb30-500" aria-hidden="true" tabindex="-1"></a>We could look at these coefficients and interpret their marginal effects, but here we're more interested in the distribution of the outcome, not the coefficients (see <span class="co">[</span><span class="ot">here</span><span class="co">](https://www.andrewheiss.com/blog/2022/05/20/marginalia/#where-this-subtle-difference-really-matters)</span> or <span class="co">[</span><span class="ot">here</span><span class="co">](http://post8000.svmiller.com/lab-scripts/logistic-regression-lab.html)</span> or <span class="co">[</span><span class="ot">here</span><span class="co">](https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/#2-fractional-logistic-regression)</span> for examples of how to interpret logistic regression coefficients).</span>
<span id="cb30-501"><a href="#cb30-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-502"><a href="#cb30-502" aria-hidden="true" tabindex="-1"></a>Let's again extract these different posterior distributions with the three main **brms** functions: <span class="in">`posterior_linpred()`</span>, <span class="in">`posterior_epred()`</span>, and <span class="in">`posterior_predict()`</span>. We'll look at the posterior distribution when <span class="in">`bill_length_mm`</span> is its average value, or <span class="in">`r mean(penguins$bill_length_mm)`</span>:</span>
<span id="cb30-503"><a href="#cb30-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-504"><a href="#cb30-504" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-logit-posteriors}</span></span>
<span id="cb30-505"><a href="#cb30-505" aria-hidden="true" tabindex="-1"></a><span class="in"># Make a little dataset of just the average bill length</span></span>
<span id="cb30-506"><a href="#cb30-506" aria-hidden="true" tabindex="-1"></a><span class="in">penguins_avg_bill &lt;- penguins |&gt; </span></span>
<span id="cb30-507"><a href="#cb30-507" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(bill_length_mm = mean(bill_length_mm))</span></span>
<span id="cb30-508"><a href="#cb30-508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-509"><a href="#cb30-509" aria-hidden="true" tabindex="-1"></a><span class="in"># Extract different types of posteriors</span></span>
<span id="cb30-510"><a href="#cb30-510" aria-hidden="true" tabindex="-1"></a><span class="in">logit_linpred &lt;- model_logit |&gt; </span></span>
<span id="cb30-511"><a href="#cb30-511" aria-hidden="true" tabindex="-1"></a><span class="in">  linpred_draws(newdata = penguins_avg_bill)</span></span>
<span id="cb30-512"><a href="#cb30-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-513"><a href="#cb30-513" aria-hidden="true" tabindex="-1"></a><span class="in">logit_epred &lt;- model_logit |&gt; </span></span>
<span id="cb30-514"><a href="#cb30-514" aria-hidden="true" tabindex="-1"></a><span class="in">  epred_draws(newdata = penguins_avg_bill)</span></span>
<span id="cb30-515"><a href="#cb30-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-516"><a href="#cb30-516" aria-hidden="true" tabindex="-1"></a><span class="in">logit_predicted &lt;- model_logit |&gt; </span></span>
<span id="cb30-517"><a href="#cb30-517" aria-hidden="true" tabindex="-1"></a><span class="in">  predicted_draws(newdata = penguins_avg_bill)</span></span>
<span id="cb30-518"><a href="#cb30-518" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-519"><a href="#cb30-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-520"><a href="#cb30-520" aria-hidden="true" tabindex="-1"></a>These each show the posterior distribution of being a Gentoo, but unlike the Gaussian posteriors we looked at earlier, each of these is measured completely differently now!</span>
<span id="cb30-521"><a href="#cb30-521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-522"><a href="#cb30-522" aria-hidden="true" tabindex="-1"></a><span class="in">```{r tbl-logit-posteriors}</span></span>
<span id="cb30-523"><a href="#cb30-523" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb30-524"><a href="#cb30-524" aria-hidden="true" tabindex="-1"></a><span class="in">#| tbl-cap: Logit posteriors</span></span>
<span id="cb30-525"><a href="#cb30-525" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-inset-right</span></span>
<span id="cb30-526"><a href="#cb30-526" aria-hidden="true" tabindex="-1"></a><span class="in">summary_logit_linpred &lt;- logit_linpred |&gt; </span></span>
<span id="cb30-527"><a href="#cb30-527" aria-hidden="true" tabindex="-1"></a><span class="in">  ungroup() |&gt; </span></span>
<span id="cb30-528"><a href="#cb30-528" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(across(.linpred, lst(mean, sd, median), .names = "{.fn}"))</span></span>
<span id="cb30-529"><a href="#cb30-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-530"><a href="#cb30-530" aria-hidden="true" tabindex="-1"></a><span class="in">summary_logit_epred &lt;- logit_epred |&gt; </span></span>
<span id="cb30-531"><a href="#cb30-531" aria-hidden="true" tabindex="-1"></a><span class="in">  ungroup() |&gt; </span></span>
<span id="cb30-532"><a href="#cb30-532" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(across(.epred, lst(mean, sd, median), .names = "{.fn}"))</span></span>
<span id="cb30-533"><a href="#cb30-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-534"><a href="#cb30-534" aria-hidden="true" tabindex="-1"></a><span class="in">summary_logit_predicted &lt;- logit_predicted |&gt; </span></span>
<span id="cb30-535"><a href="#cb30-535" aria-hidden="true" tabindex="-1"></a><span class="in">  ungroup() |&gt; </span></span>
<span id="cb30-536"><a href="#cb30-536" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(across(.prediction, lst(mean), .names = "{.fn}"))</span></span>
<span id="cb30-537"><a href="#cb30-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-538"><a href="#cb30-538" aria-hidden="true" tabindex="-1"></a><span class="in">tribble(</span></span>
<span id="cb30-539"><a href="#cb30-539" aria-hidden="true" tabindex="-1"></a><span class="in">  ~Function, ~`Model element`, ~Values,</span></span>
<span id="cb30-540"><a href="#cb30-540" aria-hidden="true" tabindex="-1"></a><span class="in">  "&lt;code&gt;posterior_linpred()&lt;/code&gt;", "\\(\\operatorname{logit}(\\pi)\\) in the model", "Logits or log odds",</span></span>
<span id="cb30-541"><a href="#cb30-541" aria-hidden="true" tabindex="-1"></a><span class="in">  "&lt;code&gt;posterior_linpred(transform = TRUE)&lt;/code&gt; or &lt;code&gt;posterior_epred()&lt;/code&gt;", "\\(\\operatorname{E(y)}\\) and \\(\\pi\\) in the model", "Probabilities",</span></span>
<span id="cb30-542"><a href="#cb30-542" aria-hidden="true" tabindex="-1"></a><span class="in">  "&lt;code&gt;posterior_predict()&lt;/code&gt;", "Random draws from posterior \\(\\operatorname{Binomial}(1, \\pi)\\)", "0s and 1s"</span></span>
<span id="cb30-543"><a href="#cb30-543" aria-hidden="true" tabindex="-1"></a><span class="in">) |&gt; </span></span>
<span id="cb30-544"><a href="#cb30-544" aria-hidden="true" tabindex="-1"></a><span class="in">  bind_cols(bind_rows(summary_logit_linpred, summary_logit_epred, summary_logit_predicted)) |&gt; </span></span>
<span id="cb30-545"><a href="#cb30-545" aria-hidden="true" tabindex="-1"></a><span class="in">  kbl(escape = FALSE) |&gt; </span></span>
<span id="cb30-546"><a href="#cb30-546" aria-hidden="true" tabindex="-1"></a><span class="in">  kable_styling()</span></span>
<span id="cb30-547"><a href="#cb30-547" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-548"><a href="#cb30-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-549"><a href="#cb30-549" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-logit-posteriors, fig.width=6, fig.height=8}</span></span>
<span id="cb30-550"><a href="#cb30-550" aria-hidden="true" tabindex="-1"></a><span class="in">p1 &lt;- ggplot(logit_linpred, aes(x = .linpred)) +</span></span>
<span id="cb30-551"><a href="#cb30-551" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye(fill = clrs[3]) +</span></span>
<span id="cb30-552"><a href="#cb30-552" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(xlim = c(-1.5, -0.2)) +</span></span>
<span id="cb30-553"><a href="#cb30-553" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Logit-transformed probability of being a Gentoo", y = NULL,</span></span>
<span id="cb30-554"><a href="#cb30-554" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "**Linear predictor** &lt;span style='font-size: 14px;'&gt;logit(*π*) in the model&lt;/span&gt;",</span></span>
<span id="cb30-555"><a href="#cb30-555" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "posterior_linpred(..., tibble(bill_length_mm = 44))") +</span></span>
<span id="cb30-556"><a href="#cb30-556" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_pred_dist()</span></span>
<span id="cb30-557"><a href="#cb30-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-558"><a href="#cb30-558" aria-hidden="true" tabindex="-1"></a><span class="in">p2 &lt;- ggplot(logit_epred, aes(x = .epred)) +</span></span>
<span id="cb30-559"><a href="#cb30-559" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye(fill = clrs[2]) +</span></span>
<span id="cb30-560"><a href="#cb30-560" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_percent()) +</span></span>
<span id="cb30-561"><a href="#cb30-561" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(xlim = c(0.2, 0.45)) +</span></span>
<span id="cb30-562"><a href="#cb30-562" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Probability of being a Gentoo", y = NULL,</span></span>
<span id="cb30-563"><a href="#cb30-563" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "**Expectation of the posterior** &lt;span style='font-size: 14px;'&gt;E[*y*] and *π* in the model&lt;/span&gt;",</span></span>
<span id="cb30-564"><a href="#cb30-564" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "posterior_epred(..., tibble(bill_length_mm = 44))") +</span></span>
<span id="cb30-565"><a href="#cb30-565" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_pred_dist()</span></span>
<span id="cb30-566"><a href="#cb30-566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-567"><a href="#cb30-567" aria-hidden="true" tabindex="-1"></a><span class="in">p3 &lt;- logit_predicted |&gt; </span></span>
<span id="cb30-568"><a href="#cb30-568" aria-hidden="true" tabindex="-1"></a><span class="in">  count(is_gentoo = .prediction) |&gt; </span></span>
<span id="cb30-569"><a href="#cb30-569" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(prop = n / sum(n),</span></span>
<span id="cb30-570"><a href="#cb30-570" aria-hidden="true" tabindex="-1"></a><span class="in">         prop_nice = label_percent(accuracy = 0.1)(prop)) |&gt; </span></span>
<span id="cb30-571"><a href="#cb30-571" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = factor(is_gentoo), y = n)) +</span></span>
<span id="cb30-572"><a href="#cb30-572" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_col(fill = clrs[1]) +</span></span>
<span id="cb30-573"><a href="#cb30-573" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_text(aes(label = prop_nice), nudge_y = -300, color = "white", size = 3) +</span></span>
<span id="cb30-574"><a href="#cb30-574" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_discrete(labels = c("Not Gentoo (0)", "Gentoo (1)")) +</span></span>
<span id="cb30-575"><a href="#cb30-575" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_y_continuous(labels = label_comma()) +</span></span>
<span id="cb30-576"><a href="#cb30-576" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Prediction of being a Gentoo", y = NULL,</span></span>
<span id="cb30-577"><a href="#cb30-577" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "**Posterior predictions** &lt;span style='font-size: 14px;'&gt;Random draws from posterior Binomial(1, *π*)&lt;/span&gt;",</span></span>
<span id="cb30-578"><a href="#cb30-578" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "posterior_predict(..., tibble(bill_length_mm = 44))") +</span></span>
<span id="cb30-579"><a href="#cb30-579" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_pred_range() +</span></span>
<span id="cb30-580"><a href="#cb30-580" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(panel.grid.major.x = element_blank())</span></span>
<span id="cb30-581"><a href="#cb30-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-582"><a href="#cb30-582" aria-hidden="true" tabindex="-1"></a><span class="in">(p1 / plot_spacer() / p2 / plot_spacer() / p3) +</span></span>
<span id="cb30-583"><a href="#cb30-583" aria-hidden="true" tabindex="-1"></a><span class="in">  plot_layout(heights = c(0.3, 0.05, 0.3, 0.05, 0.3))</span></span>
<span id="cb30-584"><a href="#cb30-584" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-585"><a href="#cb30-585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-586"><a href="#cb30-586" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pdf-plot-logit-posteriors, include=FALSE}</span></span>
<span id="cb30-587"><a href="#cb30-587" aria-hidden="true" tabindex="-1"></a><span class="in">ggsave("images/logit-posteriors.pdf", plot = last_plot(), device = cairo_pdf,</span></span>
<span id="cb30-588"><a href="#cb30-588" aria-hidden="true" tabindex="-1"></a><span class="in">       width = 6, height = 8, units = "in")</span></span>
<span id="cb30-589"><a href="#cb30-589" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-590"><a href="#cb30-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-591"><a href="#cb30-591" aria-hidden="true" tabindex="-1"></a>Unlike the Gaussian/normal regression from earlier, the results from <span class="in">`posterior_epred()`</span> and <span class="in">`posterior_linpred()`</span> are not identical here. They still both correspond to the $\pi$ part of the model, but on different scales. <span class="in">`posterior_epred()`</span> provides results on the probability scale, un-logiting and back-transforming the results from <span class="in">`posterior_linpred()`</span> (which provides results on the logit scale). </span>
<span id="cb30-592"><a href="#cb30-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-593"><a href="#cb30-593" aria-hidden="true" tabindex="-1"></a>Again, *technically*, <span class="in">`posterior_epred()`</span> isn't just the back-transformed linear predictor (if you want that, you can use <span class="in">`posterior_linpred(..., transform = TRUE)`</span>). More formally, <span class="in">`posterior_epred()`</span> returns the expected values of the posterior, or $\operatorname{E(y)}$, or the average of the posterior's averages. But as with Gaussian regression, for mathy reasons this average-of-averages happens to be the same as the back-transformed $\pi$, so $E(y) = \operatorname{inverse logit}(\pi)$.</span>
<span id="cb30-594"><a href="#cb30-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-595"><a href="#cb30-595" aria-hidden="true" tabindex="-1"></a>The results from <span class="in">`posterior_predict()`</span> are draws from a random binomial distribution using the estimated $\pi$, and they consist of only 0s and 1s (not Gentoo and Gentoo).</span>
<span id="cb30-596"><a href="#cb30-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-597"><a href="#cb30-597" aria-hidden="true" tabindex="-1"></a>Showing these posterior predictions across a range of bill lengths also helps with the intuition here and illustrates the different scales and values that these posterior functions return:</span>
<span id="cb30-598"><a href="#cb30-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-599"><a href="#cb30-599" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`posterior_linpred()`</span> returns the value of $\pi$ on the logit scale</span>
<span id="cb30-600"><a href="#cb30-600" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`posterior_epred()`</span> returns the value of $\pi$ on the probability scale (technically it's returning $\operatorname{E(y)}$, but in practice those are identical here)</span>
<span id="cb30-601"><a href="#cb30-601" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`posterior_predict()`</span> returns 0s and 1s, plotted here as points at bill lengths of 35, 45, and 55 mm</span>
<span id="cb30-602"><a href="#cb30-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-603"><a href="#cb30-603" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-logit-predictions, fig.width=6, fig.height=8, warning=FALSE}</span></span>
<span id="cb30-604"><a href="#cb30-604" aria-hidden="true" tabindex="-1"></a><span class="in">pred_logit_gentoo &lt;- tibble(bill_length_mm = c(35, 45, 55)) |&gt; </span></span>
<span id="cb30-605"><a href="#cb30-605" aria-hidden="true" tabindex="-1"></a><span class="in">  add_predicted_draws(model_logit, ndraws = 500)</span></span>
<span id="cb30-606"><a href="#cb30-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-607"><a href="#cb30-607" aria-hidden="true" tabindex="-1"></a><span class="in">pred_logit_gentoo_summary &lt;- pred_logit_gentoo |&gt; </span></span>
<span id="cb30-608"><a href="#cb30-608" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(bill_length_mm) |&gt; </span></span>
<span id="cb30-609"><a href="#cb30-609" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(prop = mean(.prediction),</span></span>
<span id="cb30-610"><a href="#cb30-610" aria-hidden="true" tabindex="-1"></a><span class="in">            prop_nice = paste0(label_percent(accuracy = 0.1)(prop), "\nGentoos"))</span></span>
<span id="cb30-611"><a href="#cb30-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-612"><a href="#cb30-612" aria-hidden="true" tabindex="-1"></a><span class="in">p1 &lt;- penguins |&gt; </span></span>
<span id="cb30-613"><a href="#cb30-613" aria-hidden="true" tabindex="-1"></a><span class="in">  data_grid(bill_length_mm = seq_range(bill_length_mm, n = 100)) |&gt; </span></span>
<span id="cb30-614"><a href="#cb30-614" aria-hidden="true" tabindex="-1"></a><span class="in">  add_linpred_draws(model_logit, ndraws = 100) |&gt; </span></span>
<span id="cb30-615"><a href="#cb30-615" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = bill_length_mm)) +</span></span>
<span id="cb30-616"><a href="#cb30-616" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_lineribbon(aes(y = .linpred), .width = 0.95,</span></span>
<span id="cb30-617"><a href="#cb30-617" aria-hidden="true" tabindex="-1"></a><span class="in">                  alpha = 0.5, color = clrs[3], fill = clrs[3]) +</span></span>
<span id="cb30-618"><a href="#cb30-618" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(xlim = c(30, 60)) +</span></span>
<span id="cb30-619"><a href="#cb30-619" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Bill length (mm)", y = "Logit-transformed\nprobability of being a Gentoo",</span></span>
<span id="cb30-620"><a href="#cb30-620" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "**Linear predictor posterior** &lt;span style='font-size: 14px;'&gt;logit(*π*) in the model&lt;/span&gt;",</span></span>
<span id="cb30-621"><a href="#cb30-621" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "posterior_linpred()") +</span></span>
<span id="cb30-622"><a href="#cb30-622" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_pred_range()</span></span>
<span id="cb30-623"><a href="#cb30-623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-624"><a href="#cb30-624" aria-hidden="true" tabindex="-1"></a><span class="in">p2 &lt;- penguins |&gt; </span></span>
<span id="cb30-625"><a href="#cb30-625" aria-hidden="true" tabindex="-1"></a><span class="in">  data_grid(bill_length_mm = seq_range(bill_length_mm, n = 100)) |&gt; </span></span>
<span id="cb30-626"><a href="#cb30-626" aria-hidden="true" tabindex="-1"></a><span class="in">  add_epred_draws(model_logit, ndraws = 100) |&gt; </span></span>
<span id="cb30-627"><a href="#cb30-627" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = bill_length_mm)) +</span></span>
<span id="cb30-628"><a href="#cb30-628" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_dots(data = penguins, aes(y = as.numeric(is_gentoo), x = bill_length_mm, </span></span>
<span id="cb30-629"><a href="#cb30-629" aria-hidden="true" tabindex="-1"></a><span class="in">                                 side = ifelse(is_gentoo, "bottom", "top")), </span></span>
<span id="cb30-630"><a href="#cb30-630" aria-hidden="true" tabindex="-1"></a><span class="in">            pch = 19, color = "grey20", scale = 0.2) +</span></span>
<span id="cb30-631"><a href="#cb30-631" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_lineribbon(aes(y = .epred), .width = 0.95,</span></span>
<span id="cb30-632"><a href="#cb30-632" aria-hidden="true" tabindex="-1"></a><span class="in">                  alpha = 0.5, color = clrs[2], fill = clrs[2]) +</span></span>
<span id="cb30-633"><a href="#cb30-633" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_y_continuous(labels = label_percent()) +</span></span>
<span id="cb30-634"><a href="#cb30-634" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(xlim = c(30, 60)) +</span></span>
<span id="cb30-635"><a href="#cb30-635" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Bill length (mm)", y = "Probability of\nbeing a Gentoo",</span></span>
<span id="cb30-636"><a href="#cb30-636" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "**Expectation of the posterior** &lt;span style='font-size: 14px;'&gt;E[*y*] and *π* in the model&lt;/span&gt;",</span></span>
<span id="cb30-637"><a href="#cb30-637" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "posterior_epred()") +</span></span>
<span id="cb30-638"><a href="#cb30-638" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_pred_range()</span></span>
<span id="cb30-639"><a href="#cb30-639" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-640"><a href="#cb30-640" aria-hidden="true" tabindex="-1"></a><span class="in">p3 &lt;- ggplot(pred_logit_gentoo, aes(x = factor(bill_length_mm), y = .prediction)) +</span></span>
<span id="cb30-641"><a href="#cb30-641" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(position = position_jitter(width = 0.2, height = 0.1, seed = 1234),</span></span>
<span id="cb30-642"><a href="#cb30-642" aria-hidden="true" tabindex="-1"></a><span class="in">             size = 0.75, alpha = 0.3, color = clrs[1]) +</span></span>
<span id="cb30-643"><a href="#cb30-643" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_text(data = pred_logit_gentoo_summary, aes(y = 0.5, label = prop_nice), size = 3) +  </span></span>
<span id="cb30-644"><a href="#cb30-644" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_y_continuous(breaks = c(0, 1), labels = c("Not\nGentoo", "Gentoo")) +</span></span>
<span id="cb30-645"><a href="#cb30-645" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Bill length (mm)", y = "Prediction of\nbeing a Gentoo",</span></span>
<span id="cb30-646"><a href="#cb30-646" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "**Posterior predictions** &lt;span style='font-size: 14px;'&gt;Random draws from posterior Binomial(1, *π*)&lt;/span&gt;",</span></span>
<span id="cb30-647"><a href="#cb30-647" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "posterior_predict()") +</span></span>
<span id="cb30-648"><a href="#cb30-648" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_pred_range() +</span></span>
<span id="cb30-649"><a href="#cb30-649" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(panel.grid.major.x = element_blank(),</span></span>
<span id="cb30-650"><a href="#cb30-650" aria-hidden="true" tabindex="-1"></a><span class="in">        panel.grid.major.y = element_blank(),</span></span>
<span id="cb30-651"><a href="#cb30-651" aria-hidden="true" tabindex="-1"></a><span class="in">        axis.text.y = element_text(angle = 90, hjust = 0.5))</span></span>
<span id="cb30-652"><a href="#cb30-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-653"><a href="#cb30-653" aria-hidden="true" tabindex="-1"></a><span class="in">(p1 / plot_spacer() / p2 / plot_spacer() / p3) +</span></span>
<span id="cb30-654"><a href="#cb30-654" aria-hidden="true" tabindex="-1"></a><span class="in">  plot_layout(heights = c(0.3, 0.05, 0.3, 0.05, 0.3))</span></span>
<span id="cb30-655"><a href="#cb30-655" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-656"><a href="#cb30-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-657"><a href="#cb30-657" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pdf-plot-logit-predictions, include=FALSE}</span></span>
<span id="cb30-658"><a href="#cb30-658" aria-hidden="true" tabindex="-1"></a><span class="in">ggsave("images/logit-predictions.pdf", plot = last_plot(), device = cairo_pdf,</span></span>
<span id="cb30-659"><a href="#cb30-659" aria-hidden="true" tabindex="-1"></a><span class="in">       width = 6, height = 8, units = "in")</span></span>
<span id="cb30-660"><a href="#cb30-660" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-661"><a href="#cb30-661" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-662"><a href="#cb30-662" aria-hidden="true" tabindex="-1"></a>There are a lot more moving parts here than with Gaussian regression, with different types of posteriors measured on three different scales! This diagram summarizes everything:</span>
<span id="cb30-663"><a href="#cb30-663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-664"><a href="#cb30-664" aria-hidden="true" tabindex="-1"></a><span class="in">```{r logit-diagram, echo=FALSE, out.width="100%"}</span></span>
<span id="cb30-665"><a href="#cb30-665" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-inset-right</span></span>
<span id="cb30-666"><a href="#cb30-666" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::include_graphics("images/logistic@3x.png")</span></span>
<span id="cb30-667"><a href="#cb30-667" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-668"><a href="#cb30-668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-669"><a href="#cb30-669" aria-hidden="true" tabindex="-1"></a><span class="fu">## Distributional models with link transformations</span></span>
<span id="cb30-670"><a href="#cb30-670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-671"><a href="#cb30-671" aria-hidden="true" tabindex="-1"></a>Regression models often focus solely on the location parameter of the model (e.g., $\mu$ in $\operatorname{Normal}(\mu, \sigma)$; $\pi$ in $\operatorname{Binomial}(n, \pi)$). However, it is also possible to specify separate predictors for the scale or shape parameters of models (e.g., $\sigma$ in $\operatorname{Normal}(\mu, \sigma)$, $\phi$ in $\operatorname{Beta}(\mu, \phi)$). In the world of **brms**, these are called <span class="co">[</span><span class="ot">distributional models</span><span class="co">](https://cran.r-project.org/web/packages/brms/vignettes/brms_distreg.html)</span>.</span>
<span id="cb30-672"><a href="#cb30-672" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-673"><a href="#cb30-673" aria-hidden="true" tabindex="-1"></a>More complex models can use a collection of distributional parameters. <span class="co">[</span><span class="ot">Zero-inflated beta models</span><span class="co">](https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/#4-zero-inflated-beta-regression-bayesian-style)</span> estimate a mean $\mu$, precision $\phi$, and a zero-inflated parameter <span class="in">`zi`</span>, while <span class="co">[</span><span class="ot">hurdle lognormal models</span><span class="co">](https://www.andrewheiss.com/blog/2022/05/09/hurdle-lognormal-gaussian-brms/)</span> estimate a mean $\mu$, scale $\sigma$, and a hurdle parameter <span class="in">`hu`</span>. Even plain old Gaussian models become distributional models when a set of predictors is specified for $\sigma$ (e.g. <span class="in">`brm(y ~ x1 + x2, sigma ~ x2 + x3)`</span>).</span>
<span id="cb30-674"><a href="#cb30-674" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-675"><a href="#cb30-675" aria-hidden="true" tabindex="-1"></a>When working with extra distributional parameters, the various Bayesian posterior prediction functions return values on different scales for each different component of the model, making life even more complex! Estimates and distributional parameters (what **brms** calls <span class="in">`dpar`</span> in its functions) from these models can be used in their transformed scales or can be back-transformed into their original scale.</span>
<span id="cb30-676"><a href="#cb30-676" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-677"><a href="#cb30-677" aria-hidden="true" tabindex="-1"></a><span class="fu">### Beta regression example</span></span>
<span id="cb30-678"><a href="#cb30-678" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-679"><a href="#cb30-679" aria-hidden="true" tabindex="-1"></a>To show how different link functions *and* distributional parameters work with posteriors from distributional models, we'll use beta regression with a single explanatory variable. The penguin data we've been using doesn't have any variables that are proportions or otherwise constrained between 0 and 1, so we'll make one up. Here we're interested in the the ratio of penguin bill depth (equivalent to the height of the bill; <span class="co">[</span><span class="ot">see this illustration</span><span class="co">](https://allisonhorst.github.io/palmerpenguins/articles/art.html#culmen-measurements)</span>) to bill length and whether flipper length influences that ratio. I know nothing about penguins (or birds, for that matter), so I don't know if biologists even care about the depth/length ratio in bills, but it makes a nice proportion so we'll go with it.</span>
<span id="cb30-680"><a href="#cb30-680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-681"><a href="#cb30-681" aria-hidden="true" tabindex="-1"></a>Here's what the relationship looks like—as flipper length increases, the bill ratio decreases. Longer-flippered penguins have shorter and longer bills; shorter-flippered penguins have taller bills in proportion to their lengths. Or something like that. </span>
<span id="cb30-682"><a href="#cb30-682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-683"><a href="#cb30-683" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-mass-bill-ratio, message=FALSE}</span></span>
<span id="cb30-684"><a href="#cb30-684" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(penguins, aes(x = flipper_length_mm, y = bill_ratio)) +</span></span>
<span id="cb30-685"><a href="#cb30-685" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(size = 1, alpha = 0.7) +</span></span>
<span id="cb30-686"><a href="#cb30-686" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_smooth(method = "lm", color = clrs[5], se = FALSE) +</span></span>
<span id="cb30-687"><a href="#cb30-687" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Flipper length (mm)", y = "Ratio of bill depth / bill length") +</span></span>
<span id="cb30-688"><a href="#cb30-688" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_pred()</span></span>
<span id="cb30-689"><a href="#cb30-689" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-690"><a href="#cb30-690" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-691"><a href="#cb30-691" aria-hidden="true" tabindex="-1"></a>We want to model that green line, and in this case it appears nice and straight and could probably be modeled with regular Gaussian regression, but we also want to make sure any predictions are constrained between 0 and 1 since we're working with a proportion. Beta regression is perfect for this. Once again, I won't go into detail about how beta models work—<span class="co">[</span><span class="ot">I have a whole detailed guide to it here</span><span class="co">](https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/)</span>.</span>
<span id="cb30-692"><a href="#cb30-692" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-693"><a href="#cb30-693" aria-hidden="true" tabindex="-1"></a>With beta regression, we need to model two parameters of the beta distribution—the mean $\mu$ and the precision $\phi$. Ordinarily beta distributions are actually defined by two other parameters, called either shape 1 and shape 2 or $\alpha$ and $\beta$. The two systems of parameters are closely related and you can switch between them with a little algebra—<span class="co">[</span><span class="ot">see this guide for an example of how</span><span class="co">](https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/#beta-distributions-and-shape-parameters)</span>.</span>
<span id="cb30-694"><a href="#cb30-694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-695"><a href="#cb30-695" aria-hidden="true" tabindex="-1"></a>We can create a formal model for the distribution of the ratio of bill depth to bill length with a beta distribution with a mean $\mu$ and precision $\phi$, each of which are conditional on different values of flipper length. The models for $\mu$ and $\phi$ don't have to use the same explanatory variables—I'm just doing that here for the sake of simplicity.</span>
<span id="cb30-696"><a href="#cb30-696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-697"><a href="#cb30-697" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb30-698"><a href="#cb30-698" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb30-699"><a href="#cb30-699" aria-hidden="true" tabindex="-1"></a>\text{Bill ratio}_i &amp;\sim \operatorname{Beta}(\mu_i, \phi_i) <span class="sc">\\</span></span>
<span id="cb30-700"><a href="#cb30-700" aria-hidden="true" tabindex="-1"></a>\operatorname{logit}(\mu_i) &amp;= \alpha_{\mu} + \beta_{\mu} \ \text{Flipper length}_i <span class="sc">\\</span></span>
<span id="cb30-701"><a href="#cb30-701" aria-hidden="true" tabindex="-1"></a>\log({\phi}) &amp;= \alpha_{\phi} + \beta_{\phi} \ \text{Flipper length}_i</span>
<span id="cb30-702"><a href="#cb30-702" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb30-703"><a href="#cb30-703" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb30-704"><a href="#cb30-704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-705"><a href="#cb30-705" aria-hidden="true" tabindex="-1"></a>Or more generally, </span>
<span id="cb30-706"><a href="#cb30-706" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-707"><a href="#cb30-707" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb30-708"><a href="#cb30-708" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb30-709"><a href="#cb30-709" aria-hidden="true" tabindex="-1"></a>y_i &amp;\sim \operatorname{Beta}(\mu_i, \phi_i) <span class="sc">\\</span></span>
<span id="cb30-710"><a href="#cb30-710" aria-hidden="true" tabindex="-1"></a>\operatorname{logit}(\mu_i) &amp;= \alpha_{\mu} + \beta_{\mu} x_i <span class="sc">\\</span></span>
<span id="cb30-711"><a href="#cb30-711" aria-hidden="true" tabindex="-1"></a>\log({\phi}) &amp;= \alpha_{\phi} + \beta_{\phi} x_i</span>
<span id="cb30-712"><a href="#cb30-712" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb30-713"><a href="#cb30-713" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb30-714"><a href="#cb30-714" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-715"><a href="#cb30-715" aria-hidden="true" tabindex="-1"></a>Let's fit the model! But first, we'll actually set more specific priors this time instead of relying on the defaults. Since $\mu$ is on the logit scale, it's unlikely to ever have any huge numbers (i.e. anything beyond ±4; recall the probability scale/logit scale plot earlier). The default brms priors for coefficients in beta regression models are flat and uniform, resulting in some potentially huge and implausible priors that lead to really bad model fit (and really slow sampling!). So we'll help Stan a little here and explicitly tell it that the coefficients will be small (<span class="in">`normal(0, 1)`</span>) and that $\phi$ must be positive (<span class="in">`exponential(1)`</span> with a lower bound of 0).</span>
<span id="cb30-716"><a href="#cb30-716" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-717"><a href="#cb30-717" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-beta, cache=TRUE, results="hide"}</span></span>
<span id="cb30-718"><a href="#cb30-718" aria-hidden="true" tabindex="-1"></a><span class="in">model_beta &lt;- brm(</span></span>
<span id="cb30-719"><a href="#cb30-719" aria-hidden="true" tabindex="-1"></a><span class="in">  bf(bill_ratio ~ flipper_length_mm,</span></span>
<span id="cb30-720"><a href="#cb30-720" aria-hidden="true" tabindex="-1"></a><span class="in">     phi ~ flipper_length_mm),</span></span>
<span id="cb30-721"><a href="#cb30-721" aria-hidden="true" tabindex="-1"></a><span class="in">  family = Beta(),</span></span>
<span id="cb30-722"><a href="#cb30-722" aria-hidden="true" tabindex="-1"></a><span class="in">  init = "0",</span></span>
<span id="cb30-723"><a href="#cb30-723" aria-hidden="true" tabindex="-1"></a><span class="in">  data = penguins,</span></span>
<span id="cb30-724"><a href="#cb30-724" aria-hidden="true" tabindex="-1"></a><span class="in">  prior = c(prior(normal(0, 1), class = "b"),</span></span>
<span id="cb30-725"><a href="#cb30-725" aria-hidden="true" tabindex="-1"></a><span class="in">            prior(exponential(1), class = "b", dpar = "phi", lb = 0))</span></span>
<span id="cb30-726"><a href="#cb30-726" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb30-727"><a href="#cb30-727" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-728"><a href="#cb30-728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-729"><a href="#cb30-729" aria-hidden="true" tabindex="-1"></a>Again, we don't care about the coefficients or marginal effects here—see <span class="co">[</span><span class="ot">this guide</span><span class="co">](https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/)</span> for more about how to work with those. Let's instead extract these different posterior distributions of bill ratios with the three main **brms** functions: <span class="in">`posterior_linpred()`</span>, <span class="in">`posterior_epred()`</span>, and <span class="in">`posterior_predict()`</span>. And once again, we'll use a single value flipper length (the average, <span class="in">`r mean(penguins$flipper_length_mm)`</span> mm) to explore these distributions.</span>
<span id="cb30-730"><a href="#cb30-730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-731"><a href="#cb30-731" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-beta-posteriors}</span></span>
<span id="cb30-732"><a href="#cb30-732" aria-hidden="true" tabindex="-1"></a><span class="in"># Make a little dataset of just the average flipper length</span></span>
<span id="cb30-733"><a href="#cb30-733" aria-hidden="true" tabindex="-1"></a><span class="in">penguins_avg_flipper &lt;- penguins |&gt; </span></span>
<span id="cb30-734"><a href="#cb30-734" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(flipper_length_mm = mean(flipper_length_mm))</span></span>
<span id="cb30-735"><a href="#cb30-735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-736"><a href="#cb30-736" aria-hidden="true" tabindex="-1"></a><span class="in"># Extract different types of posteriors</span></span>
<span id="cb30-737"><a href="#cb30-737" aria-hidden="true" tabindex="-1"></a><span class="in">beta_linpred &lt;- model_beta |&gt; </span></span>
<span id="cb30-738"><a href="#cb30-738" aria-hidden="true" tabindex="-1"></a><span class="in">  linpred_draws(newdata = penguins_avg_flipper)</span></span>
<span id="cb30-739"><a href="#cb30-739" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-740"><a href="#cb30-740" aria-hidden="true" tabindex="-1"></a><span class="in">beta_linpred_phi &lt;- model_beta |&gt; </span></span>
<span id="cb30-741"><a href="#cb30-741" aria-hidden="true" tabindex="-1"></a><span class="in">  linpred_draws(newdata = penguins_avg_flipper, dpar = "phi")</span></span>
<span id="cb30-742"><a href="#cb30-742" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-743"><a href="#cb30-743" aria-hidden="true" tabindex="-1"></a><span class="in">beta_linpred_trans &lt;- model_beta |&gt; </span></span>
<span id="cb30-744"><a href="#cb30-744" aria-hidden="true" tabindex="-1"></a><span class="in">  linpred_draws(newdata = penguins_avg_flipper, transform = TRUE)</span></span>
<span id="cb30-745"><a href="#cb30-745" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-746"><a href="#cb30-746" aria-hidden="true" tabindex="-1"></a><span class="in">beta_linpred_phi_trans &lt;- model_beta |&gt; </span></span>
<span id="cb30-747"><a href="#cb30-747" aria-hidden="true" tabindex="-1"></a><span class="in">  linpred_draws(newdata = penguins_avg_flipper, dpar = "phi", transform = TRUE)</span></span>
<span id="cb30-748"><a href="#cb30-748" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-749"><a href="#cb30-749" aria-hidden="true" tabindex="-1"></a><span class="in">beta_epred &lt;- model_beta |&gt; </span></span>
<span id="cb30-750"><a href="#cb30-750" aria-hidden="true" tabindex="-1"></a><span class="in">  epred_draws(newdata = penguins_avg_flipper)</span></span>
<span id="cb30-751"><a href="#cb30-751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-752"><a href="#cb30-752" aria-hidden="true" tabindex="-1"></a><span class="in">beta_predicted &lt;- model_beta |&gt; </span></span>
<span id="cb30-753"><a href="#cb30-753" aria-hidden="true" tabindex="-1"></a><span class="in">  predicted_draws(newdata = penguins_avg_flipper)</span></span>
<span id="cb30-754"><a href="#cb30-754" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-755"><a href="#cb30-755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-756"><a href="#cb30-756" aria-hidden="true" tabindex="-1"></a>Notice the addition of two new posteriors here: <span class="in">`linpred_draws(..., dpar = "phi")`</span> and <span class="in">`linpred_draws(..., dpar = "phi", transform = TRUE)`</span>. These give us the posterior distributions of the precision ($\phi$) distributional parameter, measured on different scales.</span>
<span id="cb30-757"><a href="#cb30-757" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-758"><a href="#cb30-758" aria-hidden="true" tabindex="-1"></a>Importantly, <span class="co">[</span><span class="ot">for weird historical reasons</span><span class="co">](https://twitter.com/mjskay/status/1574489463497314304)</span>, it is possible to use <span class="in">`posterior_epred(..., dpar = "phi")`</span> to get the unlogged $\phi$ parameter. However, conceptually this is wrong. An <span class="in">`epred`</span> is the expected value, or average, of the posterior predictive distribution, or $y$. It is *not* the expected value of the $\phi$ part of the model. **brms** (or **tidybayes**) happily spits out the unlogged posterior distribution of $\phi$ when you use <span class="in">`posterior_epred(..., dpar = "phi")`</span>, but it's technically not an <span class="in">`epred`</span> despite its name. <span class="co">[</span><span class="ot">To keep the terminology consistent</span><span class="co">](https://twitter.com/mjskay/status/1574489124429520896)</span>, it's best to use <span class="in">`posterior_linpred()`</span> when working with distributional parameters, using either <span class="in">`transform = FALSE`</span> or <span class="in">`transform = TRUE`</span> for the logged or the unlogged scale.</span>
<span id="cb30-759"><a href="#cb30-759" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-760"><a href="#cb30-760" aria-hidden="true" tabindex="-1"></a><span class="in">```{r tbl-beta-posteriors}</span></span>
<span id="cb30-761"><a href="#cb30-761" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb30-762"><a href="#cb30-762" aria-hidden="true" tabindex="-1"></a><span class="in">#| tbl-cap: Beta posteriors</span></span>
<span id="cb30-763"><a href="#cb30-763" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-inset-right</span></span>
<span id="cb30-764"><a href="#cb30-764" aria-hidden="true" tabindex="-1"></a><span class="in">summary_beta_linpred &lt;- beta_linpred |&gt; </span></span>
<span id="cb30-765"><a href="#cb30-765" aria-hidden="true" tabindex="-1"></a><span class="in">  ungroup() |&gt; </span></span>
<span id="cb30-766"><a href="#cb30-766" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(across(.linpred, lst(mean, sd, median), .names = "{.fn}"))</span></span>
<span id="cb30-767"><a href="#cb30-767" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-768"><a href="#cb30-768" aria-hidden="true" tabindex="-1"></a><span class="in">summary_beta_linpred_phi &lt;- beta_linpred_phi |&gt; </span></span>
<span id="cb30-769"><a href="#cb30-769" aria-hidden="true" tabindex="-1"></a><span class="in">  ungroup() |&gt; </span></span>
<span id="cb30-770"><a href="#cb30-770" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(across(phi, lst(mean, sd, median), .names = "{.fn}"))</span></span>
<span id="cb30-771"><a href="#cb30-771" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-772"><a href="#cb30-772" aria-hidden="true" tabindex="-1"></a><span class="in">summary_beta_linpred_phi_trans &lt;- beta_linpred_phi_trans |&gt; </span></span>
<span id="cb30-773"><a href="#cb30-773" aria-hidden="true" tabindex="-1"></a><span class="in">  ungroup() |&gt; </span></span>
<span id="cb30-774"><a href="#cb30-774" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(across(phi, lst(mean, sd, median), .names = "{.fn}"))</span></span>
<span id="cb30-775"><a href="#cb30-775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-776"><a href="#cb30-776" aria-hidden="true" tabindex="-1"></a><span class="in">summary_beta_epred &lt;- beta_epred |&gt; </span></span>
<span id="cb30-777"><a href="#cb30-777" aria-hidden="true" tabindex="-1"></a><span class="in">  ungroup() |&gt; </span></span>
<span id="cb30-778"><a href="#cb30-778" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(across(.epred, lst(mean, sd, median), .names = "{.fn}"))</span></span>
<span id="cb30-779"><a href="#cb30-779" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-780"><a href="#cb30-780" aria-hidden="true" tabindex="-1"></a><span class="in">summary_beta_predicted &lt;- beta_predicted |&gt; </span></span>
<span id="cb30-781"><a href="#cb30-781" aria-hidden="true" tabindex="-1"></a><span class="in">  ungroup() |&gt; </span></span>
<span id="cb30-782"><a href="#cb30-782" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(across(.prediction, lst(mean, sd, median), .names = "{.fn}"))</span></span>
<span id="cb30-783"><a href="#cb30-783" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-784"><a href="#cb30-784" aria-hidden="true" tabindex="-1"></a><span class="in">tribble(</span></span>
<span id="cb30-785"><a href="#cb30-785" aria-hidden="true" tabindex="-1"></a><span class="in">  ~Function, ~`Model element`, ~Values,</span></span>
<span id="cb30-786"><a href="#cb30-786" aria-hidden="true" tabindex="-1"></a><span class="in">  "&lt;code&gt;posterior_linpred()&lt;/code&gt;", "\\(\\operatorname{logit}(\\mu)\\) in the model", "Logits or log odds",</span></span>
<span id="cb30-787"><a href="#cb30-787" aria-hidden="true" tabindex="-1"></a><span class="in">  "&lt;code&gt;posterior_linpred(transform = TRUE)&lt;/code&gt; or &lt;code&gt;posterior_epred()&lt;/code&gt;", "\\(\\operatorname{E(y)}\\) and \\(\\mu\\) in the model", "Probabilities",</span></span>
<span id="cb30-788"><a href="#cb30-788" aria-hidden="true" tabindex="-1"></a><span class="in">  '&lt;code&gt;posterior_linpred(dpar = "phi")&lt;/code&gt;', "\\(\\log(\\phi)\\) in the model", "Logged precision values",</span></span>
<span id="cb30-789"><a href="#cb30-789" aria-hidden="true" tabindex="-1"></a><span class="in">  '&lt;code&gt;posterior_linpred(dpar = "phi", transform = TRUE)&lt;/code&gt;', "\\(\\phi\\) in the model", "Unlogged precision values",</span></span>
<span id="cb30-790"><a href="#cb30-790" aria-hidden="true" tabindex="-1"></a><span class="in">  "&lt;code&gt;posterior_predict()&lt;/code&gt;", "Random draws from posterior \\(\\operatorname{Beta}(\\mu, \\phi)\\)", "Values between 0–1"</span></span>
<span id="cb30-791"><a href="#cb30-791" aria-hidden="true" tabindex="-1"></a><span class="in">) |&gt; </span></span>
<span id="cb30-792"><a href="#cb30-792" aria-hidden="true" tabindex="-1"></a><span class="in">  bind_cols(bind_rows(summary_beta_linpred, summary_beta_epred, </span></span>
<span id="cb30-793"><a href="#cb30-793" aria-hidden="true" tabindex="-1"></a><span class="in">                      summary_beta_linpred_phi, summary_beta_linpred_phi_trans,</span></span>
<span id="cb30-794"><a href="#cb30-794" aria-hidden="true" tabindex="-1"></a><span class="in">                      summary_beta_predicted)) |&gt; </span></span>
<span id="cb30-795"><a href="#cb30-795" aria-hidden="true" tabindex="-1"></a><span class="in">  kbl(escape = FALSE) |&gt; </span></span>
<span id="cb30-796"><a href="#cb30-796" aria-hidden="true" tabindex="-1"></a><span class="in">  kable_styling()</span></span>
<span id="cb30-797"><a href="#cb30-797" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-798"><a href="#cb30-798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-799"><a href="#cb30-799" aria-hidden="true" tabindex="-1"></a>Neat! We have a bunch of different pieces here, all measured differently. Let's look at all these different pieces simultaneously:</span>
<span id="cb30-800"><a href="#cb30-800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-801"><a href="#cb30-801" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-beta-posteriors, fig.width=8.5, fig.height=8.5}</span></span>
<span id="cb30-802"><a href="#cb30-802" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-inset-right</span></span>
<span id="cb30-803"><a href="#cb30-803" aria-hidden="true" tabindex="-1"></a><span class="in">p1 &lt;- ggplot(beta_linpred, aes(x = .linpred)) +</span></span>
<span id="cb30-804"><a href="#cb30-804" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye(fill = clrs[3]) +</span></span>
<span id="cb30-805"><a href="#cb30-805" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Logit-scale ratio of bill depth / bill length", y = NULL,</span></span>
<span id="cb30-806"><a href="#cb30-806" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "**Linear predictor** &lt;span style='font-size: 14px;'&gt;logit(*µ*) in the model&lt;/span&gt;",</span></span>
<span id="cb30-807"><a href="#cb30-807" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "posterior_linpred(\n  ..., tibble(flipper_length_mm = 201))\n") +</span></span>
<span id="cb30-808"><a href="#cb30-808" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_pred_dist()</span></span>
<span id="cb30-809"><a href="#cb30-809" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-810"><a href="#cb30-810" aria-hidden="true" tabindex="-1"></a><span class="in">p1a &lt;- ggplot(beta_linpred_phi, aes(x = phi)) +</span></span>
<span id="cb30-811"><a href="#cb30-811" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye(fill = colorspace::lighten(clrs[3], 0.3)) +</span></span>
<span id="cb30-812"><a href="#cb30-812" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Log-scale precision parameter", y = NULL,</span></span>
<span id="cb30-813"><a href="#cb30-813" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "**Precision parameter** &lt;span style='font-size: 14px;'&gt;log(*φ*) in the model&lt;/span&gt;",</span></span>
<span id="cb30-814"><a href="#cb30-814" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = 'posterior_linpred(\n  ..., tibble(flipper_length_mm = 201),\n  dpar = "phi")') +</span></span>
<span id="cb30-815"><a href="#cb30-815" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_pred_dist()</span></span>
<span id="cb30-816"><a href="#cb30-816" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-817"><a href="#cb30-817" aria-hidden="true" tabindex="-1"></a><span class="in">p2 &lt;- ggplot(beta_epred, aes(x = .epred)) +</span></span>
<span id="cb30-818"><a href="#cb30-818" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye(fill = clrs[2]) +</span></span>
<span id="cb30-819"><a href="#cb30-819" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Ratio of bill depth / bill length", y = NULL,</span></span>
<span id="cb30-820"><a href="#cb30-820" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "**Expectation of the posterior** &lt;span style='font-size: 14px;'&gt;E[*y*] or *µ* in the model&lt;/span&gt;",</span></span>
<span id="cb30-821"><a href="#cb30-821" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "posterior_epred(\n  ..., tibble(flipper_length_mm = 201)) # or \nposterior_linpred(..., transform = TRUE)") +</span></span>
<span id="cb30-822"><a href="#cb30-822" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_pred_dist()</span></span>
<span id="cb30-823"><a href="#cb30-823" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-824"><a href="#cb30-824" aria-hidden="true" tabindex="-1"></a><span class="in">p2a &lt;- ggplot(beta_linpred_phi_trans, aes(x = phi)) +</span></span>
<span id="cb30-825"><a href="#cb30-825" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye(fill = colorspace::lighten(clrs[2], 0.4)) +</span></span>
<span id="cb30-826"><a href="#cb30-826" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Precision parameter", y = NULL,</span></span>
<span id="cb30-827"><a href="#cb30-827" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "**Precision parameter** &lt;span style='font-size: 14px;'&gt;*φ* in the model&lt;/span&gt;",</span></span>
<span id="cb30-828"><a href="#cb30-828" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = 'posterior_linpred(\n  ..., tibble(flipper_length_mm = 201),\n  dpar = "phi", transform = TRUE)\n') +</span></span>
<span id="cb30-829"><a href="#cb30-829" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_pred_dist()</span></span>
<span id="cb30-830"><a href="#cb30-830" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-831"><a href="#cb30-831" aria-hidden="true" tabindex="-1"></a><span class="in">p3 &lt;- ggplot(beta_predicted, aes(x = .prediction)) +</span></span>
<span id="cb30-832"><a href="#cb30-832" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye(fill = clrs[1]) +</span></span>
<span id="cb30-833"><a href="#cb30-833" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(xlim = c(0.2, 0.6)) +</span></span>
<span id="cb30-834"><a href="#cb30-834" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Ratio of bill depth / bill length", y = NULL,</span></span>
<span id="cb30-835"><a href="#cb30-835" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "**Posterior predictions** &lt;span style='font-size: 14px;'&gt;Random draws from posterior Beta(*µ*, *φ*)&lt;/span&gt;",</span></span>
<span id="cb30-836"><a href="#cb30-836" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "posterior_predict()") +</span></span>
<span id="cb30-837"><a href="#cb30-837" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_pred_dist()</span></span>
<span id="cb30-838"><a href="#cb30-838" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-839"><a href="#cb30-839" aria-hidden="true" tabindex="-1"></a><span class="in">layout &lt;- "</span></span>
<span id="cb30-840"><a href="#cb30-840" aria-hidden="true" tabindex="-1"></a><span class="in">AB</span></span>
<span id="cb30-841"><a href="#cb30-841" aria-hidden="true" tabindex="-1"></a><span class="in">CC</span></span>
<span id="cb30-842"><a href="#cb30-842" aria-hidden="true" tabindex="-1"></a><span class="in">DE</span></span>
<span id="cb30-843"><a href="#cb30-843" aria-hidden="true" tabindex="-1"></a><span class="in">FF</span></span>
<span id="cb30-844"><a href="#cb30-844" aria-hidden="true" tabindex="-1"></a><span class="in">GG</span></span>
<span id="cb30-845"><a href="#cb30-845" aria-hidden="true" tabindex="-1"></a><span class="in">"</span></span>
<span id="cb30-846"><a href="#cb30-846" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-847"><a href="#cb30-847" aria-hidden="true" tabindex="-1"></a><span class="in">p1 + p1a + plot_spacer() + p2 + p2a + plot_spacer() + p3 +</span></span>
<span id="cb30-848"><a href="#cb30-848" aria-hidden="true" tabindex="-1"></a><span class="in">  plot_layout(design = layout, heights = c(0.3, 0.05, 0.3, 0.05, 0.3))</span></span>
<span id="cb30-849"><a href="#cb30-849" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-850"><a href="#cb30-850" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-851"><a href="#cb30-851" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pdf-plot-beta-posteriors, include=FALSE}</span></span>
<span id="cb30-852"><a href="#cb30-852" aria-hidden="true" tabindex="-1"></a><span class="in">ggsave("images/beta-posteriors.pdf", plot = last_plot(), device = cairo_pdf,</span></span>
<span id="cb30-853"><a href="#cb30-853" aria-hidden="true" tabindex="-1"></a><span class="in">       width = 8.5, height = 8.5, units = "in")</span></span>
<span id="cb30-854"><a href="#cb30-854" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-855"><a href="#cb30-855" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-856"><a href="#cb30-856" aria-hidden="true" tabindex="-1"></a>As with logistic regression, the results from <span class="in">`posterior_epred()`</span> and <span class="in">`posterior_linpred()`</span> are not identical. They still both correspond to the $\mu$ part of the model, but on different scales. <span class="in">`posterior_epred()`</span> provides results on the probability or proportion scale, un-logiting and back-transforming the logit-scale results from <span class="in">`posterior_linpred()`</span>.</span>
<span id="cb30-857"><a href="#cb30-857" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-858"><a href="#cb30-858" aria-hidden="true" tabindex="-1"></a>And once again, <span class="in">`posterior_epred()`</span> isn't technically the back-transformed linear predictor (if you want that, you can use <span class="in">`posterior_linpred(..., transform = TRUE)`</span>). Instead it shows the expected values of the posterior, or $\operatorname{E(y)}$, or the average of the posterior's averages. But just like Gaussian regression and logistic regression, this average-of-averages still happens to be the same as the back-transformed $\mu$, so $E(y) = \operatorname{inverse logit}(\mu)$.</span>
<span id="cb30-859"><a href="#cb30-859" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-860"><a href="#cb30-860" aria-hidden="true" tabindex="-1"></a>We can extract the $\phi$ parameter by including the <span class="in">`dpar = "phi"`</span> argument (or technically just <span class="in">`dpar = TRUE`</span>, which returns all possible distributional parameters, which is helpful in cases with lots of them like zero-one-inflated beta regression). <span class="in">`posterior_linpred(..., dpar = "phi", transform = TRUE)`</span> provides $\phi$ on the original precision scale (however that's measured), while <span class="in">`posterior_linpred(..., dpar = "phi")`</span> returns a log-transformed version.</span>
<span id="cb30-861"><a href="#cb30-861" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-862"><a href="#cb30-862" aria-hidden="true" tabindex="-1"></a>And finally, the results from <span class="in">`posterior_predict()`</span> are draws from a random beta distribution using the estimated $\mu$ and $\phi$, and they consist of values ranging between 0 and 1.</span>
<span id="cb30-863"><a href="#cb30-863" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-864"><a href="#cb30-864" aria-hidden="true" tabindex="-1"></a>Showing the posterior predictions for these different parameters across a range of flipper lengths will help with the intuition and illustrate the different scales, values, and parameters that these posterior functions return:</span>
<span id="cb30-865"><a href="#cb30-865" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-866"><a href="#cb30-866" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`posterior_linpred()`</span> returns the value of $\mu$ on the logit scale</span>
<span id="cb30-867"><a href="#cb30-867" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`posterior_epred()`</span> returns the value of $\mu$ on the probability scale (technically it's returning $\operatorname{E(y)}$, but in practice those are identical here)</span>
<span id="cb30-868"><a href="#cb30-868" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`posterior_linpred(..., dpar = "phi")`</span> returns the logged value of $\phi$</span>
<span id="cb30-869"><a href="#cb30-869" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`posterior_linpred(..., dpar = "phi", transform = TRUE)`</span> returns the value of $\phi$ on its original scale</span>
<span id="cb30-870"><a href="#cb30-870" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`posterior_predict()`</span> returns probabilities or proportions</span>
<span id="cb30-871"><a href="#cb30-871" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-872"><a href="#cb30-872" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-beta-predictions, fig.width=8.5, fig.height=8.5, warning=FALSE}</span></span>
<span id="cb30-873"><a href="#cb30-873" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-inset-right</span></span>
<span id="cb30-874"><a href="#cb30-874" aria-hidden="true" tabindex="-1"></a><span class="in">p1 &lt;- penguins |&gt; </span></span>
<span id="cb30-875"><a href="#cb30-875" aria-hidden="true" tabindex="-1"></a><span class="in">  data_grid(flipper_length_mm = seq_range(flipper_length_mm, n = 100)) |&gt; </span></span>
<span id="cb30-876"><a href="#cb30-876" aria-hidden="true" tabindex="-1"></a><span class="in">  add_linpred_draws(model_beta, ndraws = 100) |&gt; </span></span>
<span id="cb30-877"><a href="#cb30-877" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = flipper_length_mm)) +</span></span>
<span id="cb30-878"><a href="#cb30-878" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(data = penguins, aes(y = qlogis(bill_ratio)), size = 1, alpha = 0.7) +</span></span>
<span id="cb30-879"><a href="#cb30-879" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_lineribbon(aes(y = .linpred), .width = 0.95,</span></span>
<span id="cb30-880"><a href="#cb30-880" aria-hidden="true" tabindex="-1"></a><span class="in">                  alpha = 0.5, color = clrs[3], fill = clrs[3]) +</span></span>
<span id="cb30-881"><a href="#cb30-881" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(xlim = c(170, 230)) +</span></span>
<span id="cb30-882"><a href="#cb30-882" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Flipper length (mm)", y = "Logit-scale ratio of\nbill depth / bill length",</span></span>
<span id="cb30-883"><a href="#cb30-883" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "**Linear predictor posterior** &lt;span style='font-size: 14px;'&gt;logit(*µ*) in the model&lt;/span&gt;",</span></span>
<span id="cb30-884"><a href="#cb30-884" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "posterior_linpred()") +</span></span>
<span id="cb30-885"><a href="#cb30-885" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_pred_range()</span></span>
<span id="cb30-886"><a href="#cb30-886" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-887"><a href="#cb30-887" aria-hidden="true" tabindex="-1"></a><span class="in">p1a &lt;- penguins |&gt; </span></span>
<span id="cb30-888"><a href="#cb30-888" aria-hidden="true" tabindex="-1"></a><span class="in">  data_grid(flipper_length_mm = seq_range(flipper_length_mm, n = 100)) |&gt; </span></span>
<span id="cb30-889"><a href="#cb30-889" aria-hidden="true" tabindex="-1"></a><span class="in">  add_linpred_draws(model_beta, ndraws = 100, dpar = "phi") |&gt; </span></span>
<span id="cb30-890"><a href="#cb30-890" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = flipper_length_mm)) +</span></span>
<span id="cb30-891"><a href="#cb30-891" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_lineribbon(aes(y = phi), .width = 0.95, alpha = 0.5, </span></span>
<span id="cb30-892"><a href="#cb30-892" aria-hidden="true" tabindex="-1"></a><span class="in">                  color = colorspace::lighten(clrs[3], 0.3), fill = colorspace::lighten(clrs[3], 0.3)) +</span></span>
<span id="cb30-893"><a href="#cb30-893" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(xlim = c(170, 230)) +</span></span>
<span id="cb30-894"><a href="#cb30-894" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Flipper length (mm)", y = "Log-scale\nprecision parameter",</span></span>
<span id="cb30-895"><a href="#cb30-895" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "**Precision parameter** &lt;span style='font-size: 14px;'&gt;log(*φ*) in the model&lt;/span&gt;",</span></span>
<span id="cb30-896"><a href="#cb30-896" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = 'posterior_linpred(dpar = "phi")') +</span></span>
<span id="cb30-897"><a href="#cb30-897" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_pred_range()</span></span>
<span id="cb30-898"><a href="#cb30-898" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-899"><a href="#cb30-899" aria-hidden="true" tabindex="-1"></a><span class="in">p2 &lt;- penguins |&gt; </span></span>
<span id="cb30-900"><a href="#cb30-900" aria-hidden="true" tabindex="-1"></a><span class="in">  data_grid(flipper_length_mm = seq_range(flipper_length_mm, n = 100)) |&gt; </span></span>
<span id="cb30-901"><a href="#cb30-901" aria-hidden="true" tabindex="-1"></a><span class="in">  add_epred_draws(model_beta, ndraws = 100) |&gt; </span></span>
<span id="cb30-902"><a href="#cb30-902" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = flipper_length_mm)) +</span></span>
<span id="cb30-903"><a href="#cb30-903" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(data = penguins, aes(y = bill_ratio), size = 1, alpha = 0.7) +</span></span>
<span id="cb30-904"><a href="#cb30-904" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_lineribbon(aes(y = .epred), .width = 0.95,</span></span>
<span id="cb30-905"><a href="#cb30-905" aria-hidden="true" tabindex="-1"></a><span class="in">                  alpha = 0.5, color = clrs[2], fill = clrs[2]) +</span></span>
<span id="cb30-906"><a href="#cb30-906" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(xlim = c(170, 230)) +</span></span>
<span id="cb30-907"><a href="#cb30-907" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Flipper length (mm)", y = "Ratio of\nbill depth / bill length",</span></span>
<span id="cb30-908"><a href="#cb30-908" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "**Expectation of the posterior** &lt;span style='font-size: 14px;'&gt;E[*y*] or *µ* in the model&lt;/span&gt;",</span></span>
<span id="cb30-909"><a href="#cb30-909" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = 'posterior_epred()\nposterior_linpred(transform = TRUE)') +</span></span>
<span id="cb30-910"><a href="#cb30-910" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_pred_range()</span></span>
<span id="cb30-911"><a href="#cb30-911" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-912"><a href="#cb30-912" aria-hidden="true" tabindex="-1"></a><span class="in">p2a &lt;- penguins |&gt; </span></span>
<span id="cb30-913"><a href="#cb30-913" aria-hidden="true" tabindex="-1"></a><span class="in">  data_grid(flipper_length_mm = seq_range(flipper_length_mm, n = 100)) |&gt; </span></span>
<span id="cb30-914"><a href="#cb30-914" aria-hidden="true" tabindex="-1"></a><span class="in">  add_epred_draws(model_beta, ndraws = 100, dpar = "phi") |&gt; </span></span>
<span id="cb30-915"><a href="#cb30-915" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = flipper_length_mm)) +</span></span>
<span id="cb30-916"><a href="#cb30-916" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_lineribbon(aes(y = phi), .width = 0.95, alpha = 0.5, </span></span>
<span id="cb30-917"><a href="#cb30-917" aria-hidden="true" tabindex="-1"></a><span class="in">                  color = colorspace::lighten(clrs[2], 0.4), fill = colorspace::lighten(clrs[2], 0.4)) +</span></span>
<span id="cb30-918"><a href="#cb30-918" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(xlim = c(170, 230)) +</span></span>
<span id="cb30-919"><a href="#cb30-919" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Flipper length (mm)", y = "Precision parameter",</span></span>
<span id="cb30-920"><a href="#cb30-920" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "**Precision parameter** &lt;span style='font-size: 14px;'&gt;*φ* in the model&lt;/span&gt;",</span></span>
<span id="cb30-921"><a href="#cb30-921" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = 'posterior_linpred(dpar = "phi",\n                  transform = TRUE)') +</span></span>
<span id="cb30-922"><a href="#cb30-922" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_pred_range()</span></span>
<span id="cb30-923"><a href="#cb30-923" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-924"><a href="#cb30-924" aria-hidden="true" tabindex="-1"></a><span class="in">p3 &lt;- penguins |&gt; </span></span>
<span id="cb30-925"><a href="#cb30-925" aria-hidden="true" tabindex="-1"></a><span class="in">  data_grid(flipper_length_mm = seq_range(flipper_length_mm, n = 100)) |&gt; </span></span>
<span id="cb30-926"><a href="#cb30-926" aria-hidden="true" tabindex="-1"></a><span class="in">  add_predicted_draws(model_beta, ndraws = 500) |&gt; </span></span>
<span id="cb30-927"><a href="#cb30-927" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = flipper_length_mm)) +</span></span>
<span id="cb30-928"><a href="#cb30-928" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(data = penguins, aes(y = bill_ratio), size = 1, alpha = 0.7) +</span></span>
<span id="cb30-929"><a href="#cb30-929" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_lineribbon(aes(y = .prediction), .width = 0.95,</span></span>
<span id="cb30-930"><a href="#cb30-930" aria-hidden="true" tabindex="-1"></a><span class="in">                  alpha = 0.5, color = clrs[1], fill = clrs[1]) +</span></span>
<span id="cb30-931"><a href="#cb30-931" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(xlim = c(170, 230)) +</span></span>
<span id="cb30-932"><a href="#cb30-932" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Flipper length (mm)", y = "Ratio of\nbill depth / bill length",</span></span>
<span id="cb30-933"><a href="#cb30-933" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "**Posterior predictions** &lt;span style='font-size: 14px;'&gt;Random draws from posterior Beta(*µ*, *φ*)&lt;/span&gt;",</span></span>
<span id="cb30-934"><a href="#cb30-934" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "posterior_predict()") +</span></span>
<span id="cb30-935"><a href="#cb30-935" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_pred_range()</span></span>
<span id="cb30-936"><a href="#cb30-936" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-937"><a href="#cb30-937" aria-hidden="true" tabindex="-1"></a><span class="in">layout &lt;- "</span></span>
<span id="cb30-938"><a href="#cb30-938" aria-hidden="true" tabindex="-1"></a><span class="in">AB</span></span>
<span id="cb30-939"><a href="#cb30-939" aria-hidden="true" tabindex="-1"></a><span class="in">CC</span></span>
<span id="cb30-940"><a href="#cb30-940" aria-hidden="true" tabindex="-1"></a><span class="in">DE</span></span>
<span id="cb30-941"><a href="#cb30-941" aria-hidden="true" tabindex="-1"></a><span class="in">FF</span></span>
<span id="cb30-942"><a href="#cb30-942" aria-hidden="true" tabindex="-1"></a><span class="in">GG</span></span>
<span id="cb30-943"><a href="#cb30-943" aria-hidden="true" tabindex="-1"></a><span class="in">"</span></span>
<span id="cb30-944"><a href="#cb30-944" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-945"><a href="#cb30-945" aria-hidden="true" tabindex="-1"></a><span class="in">p1 + p1a + plot_spacer() + p2 + p2a + plot_spacer() + p3 +</span></span>
<span id="cb30-946"><a href="#cb30-946" aria-hidden="true" tabindex="-1"></a><span class="in">  plot_layout(design = layout, heights = c(0.3, 0.05, 0.3, 0.05, 0.3))</span></span>
<span id="cb30-947"><a href="#cb30-947" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-948"><a href="#cb30-948" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-949"><a href="#cb30-949" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pdf-plot-beta-predictions, include=FALSE}</span></span>
<span id="cb30-950"><a href="#cb30-950" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-inset-right</span></span>
<span id="cb30-951"><a href="#cb30-951" aria-hidden="true" tabindex="-1"></a><span class="in">ggsave("images/beta-predictions.pdf", plot = last_plot(), device = cairo_pdf,</span></span>
<span id="cb30-952"><a href="#cb30-952" aria-hidden="true" tabindex="-1"></a><span class="in">       width = 8.5, height = 8.5, units = "in")</span></span>
<span id="cb30-953"><a href="#cb30-953" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-954"><a href="#cb30-954" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-955"><a href="#cb30-955" aria-hidden="true" tabindex="-1"></a>So many moving parts in these distributional models! This diagram summarizes all these different posteriors, scales, and distributional parameters:</span>
<span id="cb30-956"><a href="#cb30-956" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-957"><a href="#cb30-957" aria-hidden="true" tabindex="-1"></a><span class="in">```{r beta-diagram, echo=FALSE, out.width="100%"}</span></span>
<span id="cb30-958"><a href="#cb30-958" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-inset-right</span></span>
<span id="cb30-959"><a href="#cb30-959" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::include_graphics("images/beta@3x.png")</span></span>
<span id="cb30-960"><a href="#cb30-960" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-961"><a href="#cb30-961" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-962"><a href="#cb30-962" aria-hidden="true" tabindex="-1"></a><span class="fu">### Bonus: Playing with posterior beta parameters</span></span>
<span id="cb30-963"><a href="#cb30-963" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-964"><a href="#cb30-964" aria-hidden="true" tabindex="-1"></a>Before finishing with beta regression, we can play around with some of these posterior parameters to better understand what this kind of distributional model is actually doing. First, we can plot the posterior distribution using the means of the posterior $\mu$ and $\phi$ parameters instead of using the results from <span class="in">`posterior_predict()`</span>, creating a pseudo-analytical posterior distribution. We'll use the <span class="in">`dprop()`</span> function from the **extraDistr** package instead of <span class="in">`dbeta()`</span>, since <span class="in">`dprop`</span> uses $\mu$ and $\phi$ instead of shape 1 and shape 2.</span>
<span id="cb30-965"><a href="#cb30-965" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-966"><a href="#cb30-966" aria-hidden="true" tabindex="-1"></a>It's not the greatest model at all—the actual distribution of bill ratios is bimodal (probably because of species-specific differences), but using the posterior values for $\mu$ and $\phi$ creates a distribution that picks up the average ratio. </span>
<span id="cb30-967"><a href="#cb30-967" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-968"><a href="#cb30-968" aria-hidden="true" tabindex="-1"></a>In practice we typically don't actually want to use these two parameters like this—we can use the results from <span class="in">`posterior_predict()`</span> instead—but it's cool that we can produce the same distribution with these parameters. That's the magic of these distributional models!</span>
<span id="cb30-969"><a href="#cb30-969" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-970"><a href="#cb30-970" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-empirical-posterior-data, warning=FALSE}</span></span>
<span id="cb30-971"><a href="#cb30-971" aria-hidden="true" tabindex="-1"></a><span class="in">mu &lt;- summary_beta_epred$mean</span></span>
<span id="cb30-972"><a href="#cb30-972" aria-hidden="true" tabindex="-1"></a><span class="in">phi &lt;- summary_beta_linpred_phi_trans$mean</span></span>
<span id="cb30-973"><a href="#cb30-973" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-974"><a href="#cb30-974" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(penguins, aes(x = bill_ratio)) +</span></span>
<span id="cb30-975"><a href="#cb30-975" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_density(aes(fill = "Actual data"), color = NA) +</span></span>
<span id="cb30-976"><a href="#cb30-976" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_function(</span></span>
<span id="cb30-977"><a href="#cb30-977" aria-hidden="true" tabindex="-1"></a><span class="in">    aes(fill = glue::glue("Beta(µ = {round(mu, 3)}, φ = {round(phi, 2)})")),</span></span>
<span id="cb30-978"><a href="#cb30-978" aria-hidden="true" tabindex="-1"></a><span class="in">    geom = "area", fun = ~ extraDistr::dprop(., mean = mu, size = phi),</span></span>
<span id="cb30-979"><a href="#cb30-979" aria-hidden="true" tabindex="-1"></a><span class="in">    alpha = 0.7</span></span>
<span id="cb30-980"><a href="#cb30-980" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb30-981"><a href="#cb30-981" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_manual(values = c(clrs[5], clrs[1]), name = NULL) +</span></span>
<span id="cb30-982"><a href="#cb30-982" aria-hidden="true" tabindex="-1"></a><span class="in">  xlim(c(0.2, 0.65)) +</span></span>
<span id="cb30-983"><a href="#cb30-983" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Ratio of bill depth / bill length", y = NULL,</span></span>
<span id="cb30-984"><a href="#cb30-984" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "**Analytical posterior predictions** &lt;span style='font-size: 14px;'&gt;Average posterior *µ* and *φ* from the model&lt;/span&gt;") +</span></span>
<span id="cb30-985"><a href="#cb30-985" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_pred_dist() +</span></span>
<span id="cb30-986"><a href="#cb30-986" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = c(0, 0.9),</span></span>
<span id="cb30-987"><a href="#cb30-987" aria-hidden="true" tabindex="-1"></a><span class="in">        legend.justification = "left",</span></span>
<span id="cb30-988"><a href="#cb30-988" aria-hidden="true" tabindex="-1"></a><span class="in">        legend.key.size = unit(0.75, "lines"))</span></span>
<span id="cb30-989"><a href="#cb30-989" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-990"><a href="#cb30-990" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-991"><a href="#cb30-991" aria-hidden="true" tabindex="-1"></a>For even more fun, because we modeled the $\phi$ parameter as conditional on flipper length, it changes depending on different flipper lengths. This means that the actual posterior beta distribution is shaped differently across a whole range of lengths. Here's what that looks like, with analytical distributions plotted at 180, 200, and 200 mm. As the precision increases, the distributions become more narrow and precise (which is also reflected in the size of the <span class="in">`posterior_predict()`</span>-based credible intervals around the points)</span>
<span id="cb30-992"><a href="#cb30-992" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-993"><a href="#cb30-993" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-beta-posterior-dists}</span></span>
<span id="cb30-994"><a href="#cb30-994" aria-hidden="true" tabindex="-1"></a><span class="in">muphi_to_shapes &lt;- function(mu, phi) {</span></span>
<span id="cb30-995"><a href="#cb30-995" aria-hidden="true" tabindex="-1"></a><span class="in">  shape1 &lt;- mu * phi</span></span>
<span id="cb30-996"><a href="#cb30-996" aria-hidden="true" tabindex="-1"></a><span class="in">  shape2 &lt;- (1 - mu) * phi</span></span>
<span id="cb30-997"><a href="#cb30-997" aria-hidden="true" tabindex="-1"></a><span class="in">  return(lst(shape1 = shape1, shape2 = shape2))</span></span>
<span id="cb30-998"><a href="#cb30-998" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb30-999"><a href="#cb30-999" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-1000"><a href="#cb30-1000" aria-hidden="true" tabindex="-1"></a><span class="in">beta_posteriors &lt;- tibble(flipper_length_mm = c(180, 200, 220)) |&gt; </span></span>
<span id="cb30-1001"><a href="#cb30-1001" aria-hidden="true" tabindex="-1"></a><span class="in">  add_linpred_draws(model_beta, ndraws = 500, dpar = TRUE, transform = TRUE) |&gt; </span></span>
<span id="cb30-1002"><a href="#cb30-1002" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(flipper_length_mm) |&gt; </span></span>
<span id="cb30-1003"><a href="#cb30-1003" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(across(c(mu, phi), ~mean(.))) |&gt; </span></span>
<span id="cb30-1004"><a href="#cb30-1004" aria-hidden="true" tabindex="-1"></a><span class="in">  ungroup() |&gt; </span></span>
<span id="cb30-1005"><a href="#cb30-1005" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(shapes = map2(mu, phi, ~as_tibble(muphi_to_shapes(.x, .y)))) |&gt; </span></span>
<span id="cb30-1006"><a href="#cb30-1006" aria-hidden="true" tabindex="-1"></a><span class="in">  unnest(shapes) |&gt; </span></span>
<span id="cb30-1007"><a href="#cb30-1007" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(nice_label = glue::glue("Beta(µ = {round(mu, 3)}, φ = {round(phi, 2)})"))</span></span>
<span id="cb30-1008"><a href="#cb30-1008" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-1009"><a href="#cb30-1009" aria-hidden="true" tabindex="-1"></a><span class="in"># Here are the parameters we'll use</span></span>
<span id="cb30-1010"><a href="#cb30-1010" aria-hidden="true" tabindex="-1"></a><span class="in"># We need to convert the mu and phi values to shape1 and shape2 so that we can</span></span>
<span id="cb30-1011"><a href="#cb30-1011" aria-hidden="true" tabindex="-1"></a><span class="in"># use dist_beta() to plot the halfeye distributions correctly</span></span>
<span id="cb30-1012"><a href="#cb30-1012" aria-hidden="true" tabindex="-1"></a><span class="in">beta_posteriors</span></span>
<span id="cb30-1013"><a href="#cb30-1013" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-1014"><a href="#cb30-1014" aria-hidden="true" tabindex="-1"></a><span class="in">penguins |&gt; </span></span>
<span id="cb30-1015"><a href="#cb30-1015" aria-hidden="true" tabindex="-1"></a><span class="in">  data_grid(flipper_length_mm = seq_range(flipper_length_mm, n = 100)) |&gt; </span></span>
<span id="cb30-1016"><a href="#cb30-1016" aria-hidden="true" tabindex="-1"></a><span class="in">  add_predicted_draws(model_beta, ndraws = 500) |&gt; </span></span>
<span id="cb30-1017"><a href="#cb30-1017" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = flipper_length_mm)) +</span></span>
<span id="cb30-1018"><a href="#cb30-1018" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(data = penguins, aes(y = bill_ratio), size = 1, alpha = 0.7) +</span></span>
<span id="cb30-1019"><a href="#cb30-1019" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye(data = beta_posteriors, aes(ydist = dist_beta(shape1, shape2), y = NULL), </span></span>
<span id="cb30-1020"><a href="#cb30-1020" aria-hidden="true" tabindex="-1"></a><span class="in">               side = "bottom", fill = clrs[1], alpha = 0.75) +</span></span>
<span id="cb30-1021"><a href="#cb30-1021" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_lineribbon(aes(y = .prediction), .width = 0.95,</span></span>
<span id="cb30-1022"><a href="#cb30-1022" aria-hidden="true" tabindex="-1"></a><span class="in">                  alpha = 0.1, color = clrs[1], fill = clrs[1]) +</span></span>
<span id="cb30-1023"><a href="#cb30-1023" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_text(data = beta_posteriors, </span></span>
<span id="cb30-1024"><a href="#cb30-1024" aria-hidden="true" tabindex="-1"></a><span class="in">            aes(x = flipper_length_mm, y = 0.9, label = nice_label),</span></span>
<span id="cb30-1025"><a href="#cb30-1025" aria-hidden="true" tabindex="-1"></a><span class="in">            hjust = 0.5) +</span></span>
<span id="cb30-1026"><a href="#cb30-1026" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(xlim = c(170, 230)) +</span></span>
<span id="cb30-1027"><a href="#cb30-1027" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Flipper length (mm)", y = "Ratio of\nbill depth / bill length",</span></span>
<span id="cb30-1028"><a href="#cb30-1028" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "**Analytical posterior predictions** &lt;span style='font-size: 14px;'&gt;Average posterior *µ* and *φ* from the model&lt;/span&gt;") +</span></span>
<span id="cb30-1029"><a href="#cb30-1029" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_pred_range()</span></span>
<span id="cb30-1030"><a href="#cb30-1030" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-1031"><a href="#cb30-1031" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-1032"><a href="#cb30-1032" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-1033"><a href="#cb30-1033" aria-hidden="true" tabindex="-1"></a><span class="fu">## When `posterior_epred()` isn't just the back-transformed linear predictor</span></span>
<span id="cb30-1034"><a href="#cb30-1034" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-1035"><a href="#cb30-1035" aria-hidden="true" tabindex="-1"></a>In all the examples in this guide, the results from <span class="in">`posterior_epred()`</span> have been identical to the back-transformed results from <span class="in">`posterior_linpred()`</span> (or <span class="in">`posterior_linpred(..., transform = TRUE)`</span> if there are link functions). With logistic regression, <span class="in">`posterior_epred()`</span> returned the probability-scale values of $\pi$; with beta regression, <span class="in">`posterior_epred()`</span> returned the proportion/probability-scale values of $\mu$. This is the case for many model families in Stan and **brms**—for mathy reasons that go beyond my skills, the average of averages $\operatorname{E(y)}$ is the same as the back-transformed linear predictor for lots of distributions.</span>
<span id="cb30-1036"><a href="#cb30-1036" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-1037"><a href="#cb30-1037" aria-hidden="true" tabindex="-1"></a>This isn't always the case though! In some families, like lognormal models, <span class="in">`posterior_epred()`</span> and <span class="in">`posterior_linpred(..., transform = TRUE)`</span> give *different* estimates. For lognormal models $\operatorname{E(y)}$ isn't just one of the distribution's parameters—it's this:</span>
<span id="cb30-1038"><a href="#cb30-1038" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-1039"><a href="#cb30-1039" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb30-1040"><a href="#cb30-1040" aria-hidden="true" tabindex="-1"></a>\operatorname{E}(y | \mid \mu, \sigma) = \exp \left( \mu + \frac{\sigma^2}{2} \right)</span>
<span id="cb30-1041"><a href="#cb30-1041" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb30-1042"><a href="#cb30-1042" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-1043"><a href="#cb30-1043" aria-hidden="true" tabindex="-1"></a>I won't show any examples of that here—this guide is already too long—but <span class="co">[</span><span class="ot">Matthew Kay has an example here</span><span class="co">](https://github.com/mjskay/uncertainty-examples/blob/master/linpred_epred.md)</span> that shows the differences between expected posterior values and back-transformed linear posterior values.</span>
<span id="cb30-1044"><a href="#cb30-1044" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-1045"><a href="#cb30-1045" aria-hidden="true" tabindex="-1"></a>To see which kinds of families use fancier <span class="in">`epred`</span>s, <span class="co">[</span><span class="ot">look at the source for `brms::posterior_epred()` here</span><span class="co">](https://github.com/paul-buerkner/brms/blob/28f778d7933f95422dda8f9a9f4333b975261120/R/posterior_epred.R#L341)</span>. Most of the families just use the back-transformed <span class="in">`mu`</span> (<span class="in">`prep\$dpars\$mu`</span> in the code), but some have special values, like lognormal's <span class="in">`with(prep$dpars, exp(mu + sigma^2 / 2))`</span></span>
<span id="cb30-1046"><a href="#cb30-1046" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-1047"><a href="#cb30-1047" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-1048"><a href="#cb30-1048" aria-hidden="true" tabindex="-1"></a><span class="fu">## tl;dr: Diagrams and cheat sheets</span></span>
<span id="cb30-1049"><a href="#cb30-1049" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-1050"><a href="#cb30-1050" aria-hidden="true" tabindex="-1"></a>Keeping track of which kinds of posterior predictions you're working with, on which scales, and for which parameters, can be tricky, especially with more complex models with lots of moving parts. To make life easier, here are all the summary diagrams in one place:</span>
<span id="cb30-1051"><a href="#cb30-1051" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-1052"><a href="#cb30-1052" aria-hidden="true" tabindex="-1"></a><span class="fu">### Normal Gaussian models</span></span>
<span id="cb30-1053"><a href="#cb30-1053" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-1054"><a href="#cb30-1054" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">**(Download a PDF)**</span><span class="co">](images/normal.pdf)</span> or <span class="co">[</span><span class="ot">**(download original Adobe Illustrator file)**</span><span class="co">](model-diagrams.ai)</span></span>
<span id="cb30-1055"><a href="#cb30-1055" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-1056"><a href="#cb30-1056" aria-hidden="true" tabindex="-1"></a><span class="in">```{r normal-diagram-final, echo=FALSE, out.width="100%"}</span></span>
<span id="cb30-1057"><a href="#cb30-1057" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-inset-right</span></span>
<span id="cb30-1058"><a href="#cb30-1058" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::include_graphics("images/normal@3x.png")</span></span>
<span id="cb30-1059"><a href="#cb30-1059" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-1060"><a href="#cb30-1060" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-1061"><a href="#cb30-1061" aria-hidden="true" tabindex="-1"></a><span class="fu">### Generalized linear models with link transformations (logistic regression example)</span></span>
<span id="cb30-1062"><a href="#cb30-1062" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-1063"><a href="#cb30-1063" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">**(Download a PDF)**</span><span class="co">](images/logistic.pdf)</span> or <span class="co">[</span><span class="ot">**(download original Adobe Illustrator file)**</span><span class="co">](model-diagrams.ai)</span></span>
<span id="cb30-1064"><a href="#cb30-1064" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-1065"><a href="#cb30-1065" aria-hidden="true" tabindex="-1"></a><span class="in">```{r logit-diagram-final, echo=FALSE, out.width="100%"}</span></span>
<span id="cb30-1066"><a href="#cb30-1066" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-inset-right</span></span>
<span id="cb30-1067"><a href="#cb30-1067" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::include_graphics("images/logistic@3x.png")</span></span>
<span id="cb30-1068"><a href="#cb30-1068" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-1069"><a href="#cb30-1069" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-1070"><a href="#cb30-1070" aria-hidden="true" tabindex="-1"></a><span class="fu">### Distributional models with link transformations (beta regression example)</span></span>
<span id="cb30-1071"><a href="#cb30-1071" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-1072"><a href="#cb30-1072" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">**(Download a PDF)**</span><span class="co">](images/beta.pdf)</span> or <span class="co">[</span><span class="ot">**(download original Adobe Illustrator file)**</span><span class="co">](model-diagrams.ai)</span></span>
<span id="cb30-1073"><a href="#cb30-1073" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-1074"><a href="#cb30-1074" aria-hidden="true" tabindex="-1"></a><span class="in">```{r beta-diagram-final, echo=FALSE, out.width="100%"}</span></span>
<span id="cb30-1075"><a href="#cb30-1075" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-inset-right</span></span>
<span id="cb30-1076"><a href="#cb30-1076" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::include_graphics("images/beta@3x.png")</span></span>
<span id="cb30-1077"><a href="#cb30-1077" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-1078"><a href="#cb30-1078" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-1079"><a href="#cb30-1079" aria-hidden="true" tabindex="-1"></a><span class="fu">### Complete cheat sheet</span></span>
<span id="cb30-1080"><a href="#cb30-1080" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-1081"><a href="#cb30-1081" aria-hidden="true" tabindex="-1"></a>And here's an even more detailed summary cheat sheet as a printable PDF:</span>
<span id="cb30-1082"><a href="#cb30-1082" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-1083"><a href="#cb30-1083" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">**(Download a PDF)**</span><span class="co">](images/posterior-predictions-cheat-sheet_v2-0.pdf)</span> or <span class="co">[</span><span class="ot">**(download the original Adobe InDesign file)**</span><span class="co">](cheat-sheet_v2-0.zip)</span></span>
<span id="cb30-1084"><a href="#cb30-1084" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-1085"><a href="#cb30-1085" aria-hidden="true" tabindex="-1"></a><span class="in">```{css echo=FALSE}</span></span>
<span id="cb30-1086"><a href="#cb30-1086" aria-hidden="true" tabindex="-1"></a><span class="in">.embed-container {</span></span>
<span id="cb30-1087"><a href="#cb30-1087" aria-hidden="true" tabindex="-1"></a><span class="in">  position: relative;</span></span>
<span id="cb30-1088"><a href="#cb30-1088" aria-hidden="true" tabindex="-1"></a><span class="in">  padding-bottom: 129%;</span></span>
<span id="cb30-1089"><a href="#cb30-1089" aria-hidden="true" tabindex="-1"></a><span class="in">  height: 0;</span></span>
<span id="cb30-1090"><a href="#cb30-1090" aria-hidden="true" tabindex="-1"></a><span class="in">  overflow: hidden;</span></span>
<span id="cb30-1091"><a href="#cb30-1091" aria-hidden="true" tabindex="-1"></a><span class="in">  max-width: 100%;</span></span>
<span id="cb30-1092"><a href="#cb30-1092" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb30-1093"><a href="#cb30-1093" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-1094"><a href="#cb30-1094" aria-hidden="true" tabindex="-1"></a><span class="in">.embed-container iframe,</span></span>
<span id="cb30-1095"><a href="#cb30-1095" aria-hidden="true" tabindex="-1"></a><span class="in">.embed-container object,</span></span>
<span id="cb30-1096"><a href="#cb30-1096" aria-hidden="true" tabindex="-1"></a><span class="in">.embed-container embed {</span></span>
<span id="cb30-1097"><a href="#cb30-1097" aria-hidden="true" tabindex="-1"></a><span class="in">  position: absolute;</span></span>
<span id="cb30-1098"><a href="#cb30-1098" aria-hidden="true" tabindex="-1"></a><span class="in">  top: 0;</span></span>
<span id="cb30-1099"><a href="#cb30-1099" aria-hidden="true" tabindex="-1"></a><span class="in">  left: 0;</span></span>
<span id="cb30-1100"><a href="#cb30-1100" aria-hidden="true" tabindex="-1"></a><span class="in">  width: 100%;</span></span>
<span id="cb30-1101"><a href="#cb30-1101" aria-hidden="true" tabindex="-1"></a><span class="in">  height: 100%;</span></span>
<span id="cb30-1102"><a href="#cb30-1102" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb30-1103"><a href="#cb30-1103" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-1104"><a href="#cb30-1104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-1105"><a href="#cb30-1105" aria-hidden="true" tabindex="-1"></a>:::{.column-page-inset-right}</span>
<span id="cb30-1106"><a href="#cb30-1106" aria-hidden="true" tabindex="-1"></a>&lt;div class="embed-container"&gt;&lt;iframe src="images/posterior-predictions-cheat-sheet_v2-0.pdf" style="border: 0.5px"&gt;&lt;/iframe&gt;&lt;/div&gt;</span>
<span id="cb30-1107"><a href="#cb30-1107" aria-hidden="true" tabindex="-1"></a>:::</span></code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
<p><span class="faux-block"><i class="fa-brands fa-creative-commons" aria-label="creative-commons"></i> 2007–2024 Andrew Heiss</span> <span class="faux-block">All content licensed under<br><a href="https://creativecommons.org/licenses/by/4.0/"><i class="fa-brands fa-creative-commons" aria-label="creative-commons"></i> <i class="fa-brands fa-creative-commons-by" aria-label="creative-commons-by"></i> Creative Commons CC BY 4.0</a></span></p>
</div>   
    <div class="nav-footer-center">
<p><span class="faux-block"><i class="fa-brands fa-orcid" aria-label="orcid"></i> <strong>ORCID</strong> <a href="https://orcid.org/0000-0002-3948-3914">0000-0002-3948-3914</a></span> <span class="faux-block"><i class="fa-solid fa-key" aria-label="key"></i> <a href="../../../../../pgp_ath.asc.txt">PGP public key</a>   <i class="fa-solid fa-fingerprint" aria-label="fingerprint"></i> Fingerprint:<br><span class="fingerprint">4AA2 FA83 A8B2 05A4 E30F<br> 610D 1382 6216 9178 36AB</span></span></p>
</div>
    <div class="nav-footer-right">
<p><span class="faux-block">Made with <i class="fa-brands fa-r-project" aria-label="r-project"></i> and <a href="https://quarto.org/">Quarto</a></span> <span class="faux-block"><a href="https://github.com/andrewheiss/ath-quarto">View the source at <i class="fa-brands fa-github" aria-label="github"></i> GitHub</a></span></p>
</div>
  </div>
</footer>


</body></html>