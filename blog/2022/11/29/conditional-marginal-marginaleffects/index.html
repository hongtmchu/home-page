<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Hong T.M. Chu">
<meta name="description" content="Use the {marginaleffects} package to calculate tricky and nuanced marginal and conditional effects in generalized linear mixed models">
<title>Marginal and conditional effects for GLMMs with {marginaleffects} | Hong T.M. Chu – Hong T.M. Chu</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../../../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../../../">
<link href="../../../../..//files/favicon-512.png" rel="icon" type="image/png">
<script src="../../../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../../../site_libs/quarto-html/quarto-syntax-highlighting-17c909d5fd25ae21b861c0c7a49b2096.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../../../site_libs/bootstrap/bootstrap-5cd0811f461c8271ae6bab49df9501be.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<link href="../../../../../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../../../../../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<script src="../../../../../site_libs/quarto-contrib/iconify-2.0.0/iconify-icon.min.js"></script><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script type="text/javascript">

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-527449-5', 'auto');

ga('send', {
  hitType: 'pageview',
  'anonymizeIp': true,
});
</script><style>

      .quarto-title-block .quarto-title-banner {
        background: #170C3A;
      }
</style>
<script src="../../../../../site_libs/kePrint-0.0.1/kePrint.js"></script><link href="../../../../../site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
<meta property="og:title" content="Marginal and conditional effects for GLMMs with {marginaleffects} | Hong T.M. Chu">
<meta property="og:description" content="Use the {marginaleffects} package to calculate tricky and nuanced marginal and conditional effects in generalized linear mixed models">
<meta property="og:image" content="https://www.andrewheiss.com/blog/2022/11/29/conditional-marginal-marginaleffects/index_files/figure-html/plot-conditional-preds-1.png">
<meta property="og:site_name" content="Hong T.M. Chu">
<meta property="og:locale" content="en_US">
<meta property="og:image:height" content="1080">
<meta property="og:image:width" content="1584">
<meta name="twitter:title" content="Marginal and conditional effects for GLMMs with {marginaleffects} | Hong T.M. Chu">
<meta name="twitter:description" content="Use the {marginaleffects} package to calculate tricky and nuanced marginal and conditional effects in generalized linear mixed models">
<meta name="twitter:image" content="https://www.andrewheiss.com/blog/2022/11/29/conditional-marginal-marginaleffects/index_files/figure-html/plot-conditional-preds-1.png">
<meta name="twitter:creator" content="@andrewheiss">
<meta name="twitter:site" content="@andrewheiss">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image-height" content="1080">
<meta name="twitter:image-width" content="1584">
</head>
<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../../../index.html">
    <span class="navbar-title">Hong T.M. Chu</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link" href="../../../../../index.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../cv/index.html"> 
<span class="menu-text">CV</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../research/index.html"> 
<span class="menu-text">Research</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../teaching/index.html"> 
<span class="menu-text">Teaching</span></a>
  </li>  
</ul>
<ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item">
    <a class="nav-link" href="mailto:hong.ctm@vinuni.edu.vn"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:envelope" style="font-size: 1.1em;" aria-label="Icon envelope from bi Iconify.design set." title="E-mail"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/andrewheiss" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:github" style="font-size: 1.1em;" aria-label="Icon github from bi Iconify.design set." title="GitHub"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.linkedin.com/in/hongtmchu" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:linkedin" style="font-size: 1.1em;" aria-label="Icon linkedin from bi Iconify.design set." title="LinkedIn"></iconify-icon></span></a>
  </li>  
</ul>
</div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><header id="title-block-header" class="quarto-title-block default blog-post page-columns page-full"><div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">Marginal and conditional effects for GLMMs with {marginaleffects}</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
                  <div>
        <div class="description">
          Use the {marginaleffects} package to calculate tricky and nuanced marginal and conditional effects in generalized linear mixed models
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">r</div>
                <div class="quarto-category">tidyverse</div>
                <div class="quarto-category">regression</div>
                <div class="quarto-category">statistics</div>
                <div class="quarto-category">bayes</div>
                <div class="quarto-category">brms</div>
                <div class="quarto-category">lognormal</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p><a href="https://www.andrewheiss.com/">Andrew Heiss</a> <a href="https://orcid.org/0000-0002-3948-3914" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">Tuesday, November 29, 2022</p>
      </div>
    </div>
    
      
      <div>
      <div class="quarto-title-meta-heading">Doi</div>
      <div class="quarto-title-meta-contents">
        <p class="doi">
          <a href="https://doi.org/10.59350/xwnfm-x1827">10.59350/xwnfm-x1827</a>
        </p>
      </div>
    </div>
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Contents</h2>
   
  <ul>
<li><a href="#magnussons-data-and-model-the-effect-of-a-treatment-on-gambling-losses" id="toc-magnussons-data-and-model-the-effect-of-a-treatment-on-gambling-losses" class="nav-link active" data-scroll-target="#magnussons-data-and-model-the-effect-of-a-treatment-on-gambling-losses">Magnusson’s data and model: the effect of a treatment on gambling losses</a></li>
  <li>
<a href="#conditional-effects-or-effect-of-a-variable-in-an-average-cluster" id="toc-conditional-effects-or-effect-of-a-variable-in-an-average-cluster" class="nav-link" data-scroll-target="#conditional-effects-or-effect-of-a-variable-in-an-average-cluster">Conditional effects, or effect of a variable in an average cluster</a>
  <ul class="collapse">
<li><a href="#average-outcomes-for-a-typical-cluster" id="toc-average-outcomes-for-a-typical-cluster" class="nav-link" data-scroll-target="#average-outcomes-for-a-typical-cluster">Average outcomes for a typical cluster</a></li>
  <li><a href="#ate-for-a-typical-cluster" id="toc-ate-for-a-typical-cluster" class="nav-link" data-scroll-target="#ate-for-a-typical-cluster">ATE for a typical cluster</a></li>
  </ul>
</li>
  <li>
<a href="#marginal-effects-or-effect-of-a-variable-across-clusters-on-average" id="toc-marginal-effects-or-effect-of-a-variable-across-clusters-on-average" class="nav-link" data-scroll-target="#marginal-effects-or-effect-of-a-variable-across-clusters-on-average">Marginal effects, or effect of a variable across clusters on average</a>
  <ul class="collapse">
<li><a href="#average-population-level-outcomes" id="toc-average-population-level-outcomes" class="nav-link" data-scroll-target="#average-population-level-outcomes">Average population-level outcomes</a></li>
  <li><a href="#population-level-ate" id="toc-population-level-ate" class="nav-link" data-scroll-target="#population-level-ate">Population-level ATE</a></li>
  </ul>
</li>
  <li><a href="#ratios-and-multiplicative-effects" id="toc-ratios-and-multiplicative-effects" class="nav-link" data-scroll-target="#ratios-and-multiplicative-effects">Ratios and multiplicative effects</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  </ul></nav>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content"><p>As a field, statistics is really bad at naming things.</p>
<p>Take, for instance, the term “fixed effects.” In econometrics and other social science-flavored statistics, this typically refers to categorical terms in a regression model. Like, if we run a model like this with <a href="https://github.com/jennybc/gapminder">gapminder</a> data…</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jennybc/gapminder">gapminder</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">some_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">lifeExp</span> <span class="op">~</span> <span class="va">gdpPercap</span> <span class="op">+</span> <span class="va">country</span>,</span>
<span>                 data <span class="op">=</span> <span class="va">gapminder</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>…we can say that we’ve added “country fixed effects.”</p>
<p>That’s all fine and good until we come to the world of hierarchical or multilevel models, which has its own issues with nomenclature and can’t decide what to even call itself:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="chelsea-meme.jpg" class="img-fluid figure-img" style="width:60.0%"></p>
<figcaption>Image by <a href="https://twitter.com/chelseaparlett/status/1458461737431146500">Chelsea Parlett-Pelleriti</a></figcaption></figure>
</div>
</div>
</div>
<p>If we fit a model like this with country-based offsets to the intercept…</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lme4/lme4/">lme4</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">some_multilevel_model</span> <span class="op">&lt;-</span> <span class="fu">lmer</span><span class="op">(</span><span class="va">lifeExp</span> <span class="op">~</span> <span class="va">gdpPercap</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">country</span><span class="op">)</span>, </span>
<span>                              data <span class="op">=</span> <span class="va">gapminder</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>…then we get to say that there are “country random effects” or “country group effects”, while <code>gdpPercap</code> is actually a “fixed effect” or “population-level effect”</p>
<p>“Fixed effects” in multilevel models aren’t at all the same as “fixed effects” in econometrics-land.</p>
<p>Wild.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="fixed-random-effects.png" class="img-fluid figure-img column-page" style="width:100.0%"></p>
<figcaption>lol statisticians call opposite things the same thing</figcaption></figure>
</div>
</div>
</div>
<p>Another confusing term is the idea of “marginal effects.” One common definition of marginal effects is that they are slopes, or <a href="https://vincentarelbundock.github.io/marginaleffects/articles/marginaleffects.html">as the {marginaleffects} vignette says</a>…</p>
<blockquote class="blockquote">
<p>…partial derivatives of the regression equation with respect to each variable in the model for each unit in the data.</p>
</blockquote>
<p>There’s a whole R package ({marginaleffects}) dedicated to calculating these, and <a href="https://www.andrewheiss.com/blog/2022/05/20/marginalia/">I have a whole big long guide about this</a>. Basically marginal effects are the change in the outcome in a regression model when you move one of the explanatory variables up a little while holding all other covariates constant.</p>
<p>But there’s also another definition (seemingly?) unrelated to the idea of partial derivatives or slopes! And once again, it’s a key part of the multilevel model world. I’ve run into it many times when reading about multilevel models (and I’ve even kind of alluded to it <a href="https://www.andrewheiss.com/blog/2021/11/10/ame-bayes-re-guide/">in past blog posts like this</a>), but I’ve never fully understood what multilevel marginal effects are and how they’re different from slope-based marginal effects.</p>
<p>In multilevel models, you can calculate both <em>marginal effects</em> and <em>conditional effects</em>. Neither are necessarily related to slopes (though they both can be). They’re often mixed up. Even {brms} used to have a function named <code>marginal_effects()</code> that they’ve renamed to <code>conditional_effects()</code>.</p>
<p>I’m not alone in my inability to remember the difference between marginal and conditional effects in multilevel models, it seems. Everyone mixes these up. <a href="https://twitter.com/tjmahr/status/1581563839459385344">TJ Mahr recently tweeted about the confusion</a>:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="tj-conditional-marginal-tweet.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:85.0%"></p>
</figure>
</div>
</div>
</div>
<p>TJ studies language development in children and often works with data with repeated child subjects. His typical models might look something like this, with observations grouped by child:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tj_model</span> <span class="op">&lt;-</span> <span class="fu">lmer</span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x1</span> <span class="op">+</span> <span class="va">x2</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">child</span><span class="op">)</span>,</span>
<span>                 data <span class="op">=</span> <span class="va">whatever</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>His data has child-based clusters, since individual children have repeated observations over time. We can find two different kinds of effects given this type of multilevel model: we can look at the effect of <code>x1</code> or <code>x2</code> in one typical child, or we can look at the effect of <code>x1</code> or <code>x2</code> across all children on average. The confusingly-named terms “conditional effect” and “marginal effect” refer to each of these “flavors” of effect:</p>
<ul>
<li>
<strong>Conditional effect</strong> = average child</li>
<li>
<strong>Marginal effect</strong> = children on average</li>
</ul>
<p>If we have country random effects like <code>(1 | country)</code> like I do in my own work, we can calculate the same two kinds of effects. Imagine a multilevel model like this:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lme4/lme4/">lme4</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">some_multilevel_model</span> <span class="op">&lt;-</span> <span class="fu">lmer</span><span class="op">(</span><span class="va">lifeExp</span> <span class="op">~</span> <span class="va">gdpPercap</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">country</span><span class="op">)</span>, </span>
<span>                              data <span class="op">=</span> <span class="va">gapminder</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Or more formally,</p>
<p><span class="math display">\[
\begin{aligned}
\text{lifeExp} &amp;\sim \mathcal{N}(\mu_{i_j}, \sigma_y) &amp; \text{Life expectancy within countries } j \\
\mu_{i_j} &amp;= (\beta_0 + b_{0_j}) + \beta_1\, \text{gdpPercap}_{i_j} &amp; \text{Model of within-country variation} \\
b_{0_j} &amp;\sim \mathcal{N}(0, \sigma_0) &amp; \text{Random country offsets from global average}
\end{aligned}
\]</span></p>
<p>With this model, we can look at two different types of effects:</p>
<ul>
<li>
<strong>Conditional effect</strong> = effect of <code>gdpPercap</code> (<span class="math inline">\(\beta_1\)</span>) in an average or typical country (where the random country offset <span class="math inline">\(b_{0_j}\)</span> is 0)</li>
<li>
<strong>Marginal effect</strong> = average effect of <code>gdpPercap</code> (<span class="math inline">\(\beta_1\)</span> again) across all countries (where the random country offset <span class="math inline">\(b_{0_j}\)</span> is dealt with… somehow…)</li>
</ul>
<p>This conditional vs.&nbsp;marginal distinction applies to any sort of hierarchical structure in multilevel models:</p>
<ul>
<li>
<strong>Conditional effect</strong> = group-specific, subject-specific, cluster-specific, country-specific effect. We set all group-specific random offsets to 0 to find the effect for a <em>typical</em> group / subject / student / child / cluster / country / whatever.</li>
<li>
<strong>Marginal effect</strong> = global population-level average effect, or global effect, where group-specific differences are averaged out or integrated out or held constant.</li>
</ul>
<p>Calculating these different effects can be tricky, even with OLS-like normal or Gaussian regression, and interpreting them can get extra complicated with generalized linear mixed models (GLMMs) where we use links like Poisson, negative binomial, logistic, or lognormal families. The math with GLMMs gets <em>complicated</em>—particularly with lognormal models. <a href="https://rpsychologist.com/GLMM-part1-lognormal">Kristoffer Magnusson has several incredible blog posts</a> that explore the exact math behind each of these effects in a lognormal GLMM.</p>
<p>Vincent Arel-Bundock’s magisterial <a href="https://vincentarelbundock.github.io/marginaleffects/">{marginaleffects}</a> R package can calculate both conditional and marginal effects automatically. I accidentally stumbled across the idea of multilevel marginal and conditional effects <a href="https://www.andrewheiss.com/blog/2021/11/10/ame-bayes-re-guide/#overall-summary-of-different-approaches">in an earlier blog post</a>, but there I did everything with {emmeans} rather than {marginaleffects}, and <a href="https://www.andrewheiss.com/blog/2022/05/20/marginalia/">as I explore here</a>, {marginaleffects} is great for calculating average marginal effects (AMEs) rather than marginal effects at the mean (MEMs). Also in that earlier guide, I don’t really use this “conditional” vs.&nbsp;“marginal” distinction and just end up calling everything marginal. So everything here is more in line with the seemingly standard multilevel model ideas of “conditional” and “marginal” effects.</p>
<p>Let’s load some libraries, use some neat colors and a nice ggplot theme, and get started.</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/paul-buerkner/brms">brms</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mjskay.github.io/tidybayes/">tidybayes</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://marginaleffects.com/">marginaleffects</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bbolker/broom.mixed">broom.mixed</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://haozhu233.github.io/kableExtra/">kableExtra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://scales.r-lib.org">scales</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://wilkelab.org/ggtext/">ggtext</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com">patchwork</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Southern Utah colors</span></span>
<span><span class="va">clrs</span> <span class="op">&lt;-</span> <span class="fu">NatParksPalettes</span><span class="fu">::</span><span class="fu">natparks.pals</span><span class="op">(</span><span class="st">"BryceCanyon"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Custom ggplot themes to make pretty plots</span></span>
<span><span class="co"># Get Noto Sans at https://fonts.google.com/specimen/Noto+Sans</span></span>
<span><span class="va">theme_nice</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span>base_family <span class="op">=</span> <span class="st">"Noto Sans"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">theme</span><span class="op">(</span>panel.grid.minor <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>          plot.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"white"</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>,</span>
<span>          plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>          strip.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>          strip.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"grey80"</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>,</span>
<span>          legend.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="magnussons-data-and-model-the-effect-of-a-treatment-on-gambling-losses" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="magnussons-data-and-model-the-effect-of-a-treatment-on-gambling-losses">Magnusson’s data and model: the effect of a treatment on gambling losses</h2>
<p>To make sure I’ve translated <a href="https://rpsychologist.com/GLMM-part1-lognormal">Magnusson’s math</a> into the corresponding (and correct) {marginaleffects} syntax, I recreate his analysis here. He imagines some sort of intervention or treatment <span class="math inline">\(\text{TX}\)</span> that is designed to reduce the amount of dollars lost in gambling each week (<span class="math inline">\(Y\)</span>). The individuals in this situation are grouped into some sort of clusters—perhaps neighborhoods, states, or countries, or even the same individuals over time if we have repeated longitudinal observations. The exact kind of cluster doesn’t matter here—all that matters is that observations are nested in groups, and those groups have their own specific characteristics that influence individual-level outcomes. In this simulated data, there are 20 clusters, with 30 individuals in each cluster, with 600 total observations.</p>
<p>To be more formal about the structure, we can say that every outcome <span class="math inline">\(Y\)</span> gets two subscripts for the cluster (<span class="math inline">\(j\)</span>) and person inside each cluster (<span class="math inline">\(i_j\)</span>). We thus have <span class="math inline">\(Y_{i_j}\)</span> where <span class="math inline">\(i_j \in \{1, 2, \dots, 30\}\)</span> and <span class="math inline">\(j \in \{1, 2, \dots, 20\}\)</span>. The nested, hierarchical, multilevel nature of the data makes the structure look something like this:</p>
<div class="page-columns page-full">
<div class="cell page-columns page-full" data-layout-align="center" data-engine.opts="{&quot;dvisvgm.opts&quot;:&quot;--font-format=woff&quot;}">
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/clustered-structure-1.svg" class="img-fluid figure-img column-body-outset" style="width:100.0%"></p>
<figcaption>Individuals grouped into clusters</figcaption></figure>
</div>
</div>
</div>
</div>
<p>&nbsp;</p>
<p>I’ve included Magnusson’s original code for generating this data here, but you can also <a href="df_example_lognormal.rds">download an <code>.rds</code> version of it here</a>, or use the URL directly with <code>readr::read_rds()</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu">read_rds</span><span class="op">(</span><span class="st">"https://www.andrewheiss.com/blog/2022/11/29/conditional-marginal-marginaleffects/df_example_lognormal.rds"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Kristoffer Magnusson’s original data generation code</summary><div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#' Generate lognormal data with a random intercept</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param n1 patients per cluster</span></span>
<span><span class="co">#' @param n2 clusters per treatment</span></span>
<span><span class="co">#' @param B0 log intercept</span></span>
<span><span class="co">#' @param B1 log treatment effect</span></span>
<span><span class="co">#' @param sd_log log sd</span></span>
<span><span class="co">#' @param u0 SD of log intercepts (random intercept)</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @return a data.frame</span></span>
<span><span class="va">gen_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n1</span>, <span class="va">n2</span>, <span class="va">B0</span>, <span class="va">B1</span>, <span class="va">sd_log</span>, <span class="va">u0</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">cluster</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">n2</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">n1</span><span class="op">)</span></span>
<span>  <span class="va">TX</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">n1</span> <span class="op">*</span> <span class="va">n2</span><span class="op">)</span></span>
<span>  <span class="va">u0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">n2</span>, sd <span class="op">=</span> <span class="va">u0</span><span class="op">)</span><span class="op">[</span><span class="va">cluster</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">mulog</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">B0</span> <span class="op">+</span> <span class="va">B1</span> <span class="op">*</span> <span class="va">TX</span> <span class="op">+</span> <span class="va">u0</span><span class="op">)</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html">rlnorm</a></span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">n1</span> <span class="op">*</span> <span class="va">n2</span>, meanlog <span class="op">=</span> <span class="va">mulog</span>, sdlog <span class="op">=</span> <span class="va">sd_log</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">cluster</span>,</span>
<span>                  <span class="va">TX</span>,</span>
<span>                  <span class="va">y</span><span class="op">)</span></span>
<span>  <span class="va">d</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">4445</span><span class="op">)</span></span>
<span><span class="va">pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"n1"</span> <span class="op">=</span> <span class="fl">30</span>, <span class="co"># observations per cluster</span></span>
<span>             <span class="st">"n2"</span> <span class="op">=</span> <span class="fl">10</span>, <span class="co"># clusters per treatment</span></span>
<span>             <span class="st">"B0"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">500</span><span class="op">)</span>,</span>
<span>             <span class="st">"B1"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span>,</span>
<span>             <span class="st">"sd_log"</span> <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>             <span class="st">"u0"</span> <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">gen_data</span>,</span>
<span>             <span class="va">pars</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The model of the effect of <span class="math inline">\(\text{TX}\)</span> on gambling losses for individuals nested in clusters can be written formally like this, with cluster <span class="math inline">\(j\)</span>-specific offsets to the <span class="math inline">\(\beta_0\)</span> intercept term (i.e.&nbsp;<span class="math inline">\(b_{0_j}\)</span>, or cluster random effects):</p>
<p><span class="math display">\[
\begin{aligned}
\log (Y_{i_j}) &amp;\sim \mathcal{N}(\mu_{i_j}, \sigma_y) &amp; \text{Gambling losses for individual $i$ within cluster } j \\
\mu_{i_j} &amp;= (\beta_0 + b_{0_j}) + \beta_1\, \text{TX}_{i_j} &amp; \text{Model of within-cluster variation} \\
b_{0_j} &amp;\sim \mathcal{N}(0, \sigma_0) &amp; \text{Random cluster offsets from global average}
\end{aligned}
\]</span></p>
<p>We can fit this model with {brms} (or <code>lme4::lmer()</code> if you don’t want to be Bayesian):</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span></span>
<span>  <span class="fu">bf</span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">TX</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">cluster</span><span class="op">)</span><span class="op">)</span>, </span>
<span>  family <span class="op">=</span> <span class="fu">lognormal</span><span class="op">(</span><span class="op">)</span>, </span>
<span>  data <span class="op">=</span> <span class="va">d</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">4</span>, iter <span class="op">=</span> <span class="fl">5000</span>, warmup <span class="op">=</span> <span class="fl">1000</span>, seed <span class="op">=</span> <span class="fl">4445</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">fit</span></span>
<span><span class="co">##  Family: lognormal </span></span>
<span><span class="co">##   Links: mu = identity; sigma = identity </span></span>
<span><span class="co">## Formula: y ~ 1 + TX + (1 | cluster) </span></span>
<span><span class="co">##    Data: dat (Number of observations: 600) </span></span>
<span><span class="co">##   Draws: 4 chains, each with iter = 5000; warmup = 1000; thin = 1;</span></span>
<span><span class="co">##          total post-warmup draws = 16000</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Group-Level Effects: </span></span>
<span><span class="co">## ~cluster (Number of levels: 20) </span></span>
<span><span class="co">##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span><span class="co">## sd(Intercept)     0.63      0.12     0.45     0.92 1.00     2024     3522</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Population-Level Effects: </span></span>
<span><span class="co">##           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span><span class="co">## Intercept     6.21      0.20     5.81     6.62 1.00     2052     3057</span></span>
<span><span class="co">## TX           -0.70      0.29    -1.28    -0.13 1.00     2014     2843</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Family Specific Parameters: </span></span>
<span><span class="co">##       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span><span class="co">## sigma     0.51      0.01     0.48     0.54 1.00     7316     8256</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Draws were sampled using sample(hmc). For each parameter, Bulk_ESS</span></span>
<span><span class="co">## and Tail_ESS are effective sample size measures, and Rhat is the potential</span></span>
<span><span class="co">## scale reduction factor on split chains (at convergence, Rhat = 1).</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There are four parameters that we care about in that huge wall of text. We’ll pull them out as standalone objects (using <a href="https://www.tjmahr.com/lists-knitr-secret-weapon/">TJ Mahr’s neat model-to-list trick</a>) and show them in a table so we can keep track of everything easier.</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">r_fit</span> <span class="op">&lt;-</span> <span class="va">fit</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">tidy</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>term <span class="op">=</span> <span class="fu">janitor</span><span class="fu">::</span><span class="fu">make_clean_names</span><span class="op">(</span><span class="va">term</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span><span class="op">(</span><span class="op">~</span><span class="va">term</span><span class="op">)</span></span>
<span></span>
<span><span class="va">B0</span> <span class="op">&lt;-</span> <span class="va">r_fit</span><span class="op">$</span><span class="va">intercept</span><span class="op">$</span><span class="va">estimate</span></span>
<span><span class="va">B1</span> <span class="op">&lt;-</span> <span class="va">r_fit</span><span class="op">$</span><span class="va">tx</span><span class="op">$</span><span class="va">estimate</span></span>
<span><span class="va">sigma_y</span> <span class="op">&lt;-</span> <span class="va">r_fit</span><span class="op">$</span><span class="va">sd_observation</span><span class="op">$</span><span class="va">estimate</span></span>
<span><span class="va">sigma_0</span> <span class="op">&lt;-</span> <span class="va">r_fit</span><span class="op">$</span><span class="va">sd_intercept</span><span class="op">$</span><span class="va">estimate</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">fit</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">tidy</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>Parameter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"\\(\\beta_0\\)"</span>, <span class="st">"\\(\\beta_1\\)"</span>, </span>
<span>                       <span class="st">"\\(\\sigma_0\\)"</span>, <span class="st">"\\(\\sigma_y\\)"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>Description <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Global average gambling losses across all individuals"</span>,</span>
<span>                         <span class="st">"Effect of treatment on gambling losses for all individuals"</span>,</span>
<span>                         <span class="st">"Between-cluster variability of average gambling losses"</span>,</span>
<span>                         <span class="st">"Within-cluster variability of gambling losses"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>term <span class="op">=</span> <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"&lt;code&gt;{term}&lt;/code&gt;"</span><span class="op">)</span>,</span>
<span>         estimate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">estimate</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">Parameter</span>, Term <span class="op">=</span> <span class="va">term</span>, <span class="va">Description</span>, Estimate <span class="op">=</span> <span class="va">estimate</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">kbl</span><span class="op">(</span>escape <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">kable_styling</span><span class="op">(</span>full_width <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead><tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Parameter</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Term</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Description</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Estimate</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">\(\beta_0\)</td>
<td style="text-align: left;"><code>(Intercept)</code></td>
<td style="text-align: left;">Global average gambling losses across all individuals</td>
<td style="text-align: right;">6.210</td>
</tr>
<tr class="even">
<td style="text-align: left;">\(\beta_1\)</td>
<td style="text-align: left;"><code>TX</code></td>
<td style="text-align: left;">Effect of treatment on gambling losses for all individuals</td>
<td style="text-align: right;">-0.702</td>
</tr>
<tr class="odd">
<td style="text-align: left;">\(\sigma_0\)</td>
<td style="text-align: left;"><code>sd__(Intercept)</code></td>
<td style="text-align: left;">Between-cluster variability of average gambling losses</td>
<td style="text-align: right;">0.635</td>
</tr>
<tr class="even">
<td style="text-align: left;">\(\sigma_y\)</td>
<td style="text-align: left;"><code>sd__Observation</code></td>
<td style="text-align: left;">Within-cluster variability of gambling losses</td>
<td style="text-align: right;">0.507</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>There are a few problems with these estimates though: (1) they’re on the log odds scale, which isn’t very interpretable, and (2) neither the intercept term nor the <span class="math inline">\(\text{TX}\)</span> term incorporate any details about the cluster-level effects beyond <a href="https://bayesf22-notebook.classes.andrewheiss.com/bayes-rules/16-chapter.html#shrinkage-and-the-bias-variance-tradeoff">the extra information we get through partial pooling</a>. So our goal here is to <strong>transform these estimates into something interpretable that also incorporates group-level information</strong>.</p>
</section><section id="conditional-effects-or-effect-of-a-variable-in-an-average-cluster" class="level2"><h2 class="anchored" data-anchor-id="conditional-effects-or-effect-of-a-variable-in-an-average-cluster">Conditional effects, or effect of a variable in an average cluster</h2>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Conditional effects
</div>
</div>
<div class="callout-body-container callout-body">
<p>Conditional effects = average or typical cluster; random offsets <span class="math inline">\(b_{0_j}\)</span> set to 0</p>
</div>
</div>
<p><strong>Conditional effects</strong> refer to the effect of a variable in a <em>typical</em> group—country, cluster, school, subject, or whatever else is in the <code>(1 | group)</code> term in the model. “Typical” here means that the random offset <span class="math inline">\(b_{0_j}\)</span> is set to zero, or that there are no random effects involved.</p>
<section id="average-outcomes-for-a-typical-cluster" class="level3"><h3 class="anchored" data-anchor-id="average-outcomes-for-a-typical-cluster">Average outcomes for a typical cluster</h3>
<p>The average outcome <span class="math inline">\(Y_{i_j}\)</span> across the possible values of <span class="math inline">\(\text{TX}\)</span> for a typical cluster is formally defined as</p>
<p><span class="math display">\[
\textbf{E}(Y_{i_j} \mid b_{0_j} = 0, \text{TX} = \{0, 1\})
\]</span></p>
<p>Exactly how you calculate this mathematically depends on the distribution family. For a lognormal distribution, it is this:</p>
<p><span class="math display">\[
\textbf{E}(Y_{i_j} \mid b_{0_j} = 0, \text{TX} = \{0, 1\}) =
\exp \left((\beta_0 + b_{0_j}) + \beta_1 \text{TX}_i + \frac{\sigma_y^2}{2}\right)
\]</span></p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">TXs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"0"</span> <span class="op">=</span> <span class="fl">0</span>, <span class="st">"1"</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">b0j</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">(</span><span class="va">B0</span> <span class="op">+</span> <span class="va">b0j</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">B1</span> <span class="op">*</span> <span class="va">TXs</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">sigma_y</span><span class="op">^</span><span class="fl">2</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">##   0   1 </span></span>
<span><span class="co">## 566 281</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can calculate this automatically with <code>marginaleffects::predictions()</code> by setting <code>re_formula = NA</code> to ignore all random effects, or to set all the random <span class="math inline">\(b_{0_j}\)</span> offsets to zero:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">predictions</span><span class="op">(</span></span>
<span>  <span class="va">fit</span>, </span>
<span>  newdata <span class="op">=</span> <span class="fu">datagrid</span><span class="op">(</span>TX <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>, </span>
<span>  by <span class="op">=</span> <span class="st">"TX"</span>, </span>
<span>  re_formula <span class="op">=</span> <span class="cn">NA</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output cell-output-stdout">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## # A tibble: 2 × 6</span></span>
<span><span class="co">##   rowid type        TX predicted conf.low conf.high</span></span>
<span><span class="co">##   &lt;int&gt; &lt;chr&gt;    &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1     1 response     0      566.     379.      857.</span></span>
<span><span class="co">## 2     2 response     1      281.     188.      425.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Because we’re working with Bayesian posteriors, we might as well do neat stuff with them instead of just collapsing them down to single-number point estimates. The <code>posteriordraws()</code> function in {marginaleffects} lets us extract the modified/calculated MCMC draws, and then we can plot them with {tidybayes} / {ggdist}:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">conditional_preds</span> <span class="op">&lt;-</span> <span class="fu">predictions</span><span class="op">(</span></span>
<span>  <span class="va">fit</span>, </span>
<span>  newdata <span class="op">=</span> <span class="fu">datagrid</span><span class="op">(</span>TX <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>, </span>
<span>  by <span class="op">=</span> <span class="st">"TX"</span>, </span>
<span>  re_formula <span class="op">=</span> <span class="cn">NA</span></span>
<span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">posteriordraws</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">p_conditional_preds</span> <span class="op">&lt;-</span> <span class="va">conditional_preds</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">draw</span>, fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">TX</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">clrs</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span>, <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_dollar</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Gambling losses"</span>, y <span class="op">=</span> <span class="st">"Density"</span>, fill <span class="op">=</span> <span class="st">"TX"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"Conditional cluster-specific means"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Typical cluster where *b*&lt;sub&gt;0&lt;sub&gt;j&lt;/sub&gt;&lt;/sub&gt; = 0"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">1000</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_nice</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>plot.subtitle <span class="op">=</span> <span class="fu">element_markdown</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p_conditional_preds</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-conditional-preds-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:85.0%"></p>
</figure>
</div>
</div>
</div>
<p>Neat.</p>
</section><section id="ate-for-a-typical-cluster" class="level3"><h3 class="anchored" data-anchor-id="ate-for-a-typical-cluster">ATE for a typical cluster</h3>
<p>The average treatment effect (ATE) for a binary treatment is the difference between the two averages when <span class="math inline">\(\text{TX} = 1\)</span> and <span class="math inline">\(\text{TX} = 0\)</span>:</p>
<p><span class="math display">\[
\textbf{E}(Y_{i_j} \mid b_{0_j} = 0, \text{TX} = 1) - \textbf{E}(Y_{i_j} \mid b_{0_j} = 0, \text{TX} = 0)
\]</span></p>
<p>For a lognormal family, it’s this:</p>
<p><span class="math display">\[
\begin{aligned}
&amp;\textbf{E}(Y_{i_j} \mid b_{0_j} = 0, \text{TX} = 1) - \textbf{E}(Y_{i_j} \mid b_{0_j} = 0, \text{TX} = 0) = \\
&amp;\qquad \exp \left((\beta_0 + b_{0_j}) + \beta_1 + \frac{\sigma_y^2}{2}\right) - \exp \left((\beta_0 + b_{0_j}) + \frac{\sigma_y^2}{2}\right)
\end{aligned}
\]</span></p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">TXs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"0"</span> <span class="op">=</span> <span class="fl">0</span>, <span class="st">"1"</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">b0j</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span></span>
<span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">(</span><span class="va">B0</span> <span class="op">+</span> <span class="va">b0j</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">B1</span> <span class="op">*</span> <span class="va">TXs</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">sigma_y</span><span class="op">^</span><span class="fl">2</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">(</span><span class="va">B0</span> <span class="op">+</span> <span class="va">b0j</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">B1</span> <span class="op">*</span> <span class="va">TXs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">sigma_y</span><span class="op">^</span><span class="fl">2</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unname.html">unname</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">## [1] -286</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can again calculate this by setting <code>re_formula = NA</code> in <code>marginaleffects::comparisons()</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Cluster-specific average treatment effect (when offset is 0)</span></span>
<span><span class="fu">comparisons</span><span class="op">(</span></span>
<span>  <span class="va">fit</span>, </span>
<span>  variables <span class="op">=</span> <span class="st">"TX"</span>,</span>
<span>  re_formula <span class="op">=</span> <span class="cn">NA</span></span>
<span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">tidy</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output cell-output-stdout">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## # A tibble: 1 × 6</span></span>
<span><span class="co">##   type     term  contrast estimate conf.low conf.high</span></span>
<span><span class="co">##   &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt;       &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 response TX    1 - 0       -282.    -590.     -51.3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>And here’s what the posterior of that conditional ATE looks like:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">conditional_ate</span> <span class="op">&lt;-</span> <span class="fu">comparisons</span><span class="op">(</span></span>
<span>  <span class="va">fit</span>, </span>
<span>  variables <span class="op">=</span> <span class="st">"TX"</span>,</span>
<span>  re_formula <span class="op">=</span> <span class="cn">NA</span></span>
<span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">posteriordraws</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">p_conditional_ate</span> <span class="op">&lt;-</span> <span class="va">conditional_ate</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">draw</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_dollar</span><span class="op">(</span>style_negative <span class="op">=</span> <span class="st">"minus"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"(TX = 1) − (TX = 0)"</span>, y <span class="op">=</span> <span class="st">"Density"</span>, </span>
<span>       title <span class="op">=</span> <span class="st">"Conditional cluster-specific ATE"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Typical cluster where *b*&lt;sub&gt;0&lt;sub&gt;j&lt;/sub&gt;&lt;/sub&gt; = 0"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">900</span>, <span class="fl">300</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_nice</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>plot.subtitle <span class="op">=</span> <span class="fu">element_markdown</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p_conditional_ate</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-conditional-ate-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:85.0%"></p>
</figure>
</div>
</div>
</div>
</section></section><section id="marginal-effects-or-effect-of-a-variable-across-clusters-on-average" class="level2"><h2 class="anchored" data-anchor-id="marginal-effects-or-effect-of-a-variable-across-clusters-on-average">Marginal effects, or effect of a variable across clusters on average</h2>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Marginal effects
</div>
</div>
<div class="callout-body-container callout-body">
<p>Marginal effects = global/population-level effect; clusters on average; random offsets <span class="math inline">\(b_{0_j}\)</span> are incorporated into the estimate</p>
</div>
</div>
<p><strong>Marginal effects</strong> refer to the global- or population-level effect of a variable. In multilevel models, coefficients can have random group-specific offsets to a global mean. That’s what the <span class="math inline">\(b_{0_j}\)</span> in <span class="math inline">\((\beta_0 + b_{0_j})\)</span> is in the formal model we defined earlier:</p>
<p><span class="math display">\[
\begin{aligned}
\mu_{i_j} &amp;= (\beta_0 + b_{0_j}) + \beta_1\, \text{TX}_i &amp; \text{Model of within-cluster variation} \\
b_{0_j} &amp;\sim \mathcal{N}(0, \sigma_0) &amp; \text{Random cluster offsets}
\end{aligned}
\]</span></p>
<p>By definition, these offsets are distributed normally with a mean of 0 and a standard deviation of <span class="math inline">\(\sigma_0\)</span>, or <code>sd__(Intercept)</code> in {brms} output. We can visualize these cluster-specific offsets to get a better feel for how they work:</p>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">fit</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">linpred_draws</span><span class="op">(</span><span class="fu">tibble</span><span class="op">(</span>cluster <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">cluster</span><span class="op">)</span>,</span>
<span>                       TX <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>offset <span class="op">=</span> <span class="va">B0</span> <span class="op">-</span> <span class="va">.linpred</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>cluster <span class="op">=</span> <span class="fu">fct_reorder</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span>, <span class="va">offset</span>, .fun <span class="op">=</span> <span class="va">mean</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">offset</span>, y <span class="op">=</span> <span class="va">cluster</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_pointinterval</span><span class="op">(</span>color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"*b*&lt;sub&gt;0&lt;/sub&gt; offset from β&lt;sub&gt;0&lt;/sub&gt;"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_nice</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>axis.title.x <span class="op">=</span> <span class="fu">element_markdown</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-offsets-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:85.0%"></p>
</figure>
</div>
</div>
</div>
<p>The intercept for Cluster 1 here is basically the same as the global <span class="math inline">\(\beta_0\)</span> coefficient; Cluster 19 has a big positive offset, while Cluster 11 has a big negative offset.</p>
<p>The model parameters show the whole range of possible cluster-specific intercepts, or <span class="math inline">\(\beta_0 \pm \sigma_0\)</span>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_function</span><span class="op">(</span>fun <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">.</span>, mean <span class="op">=</span> <span class="va">B0</span>, sd <span class="op">=</span> <span class="va">sigma_0</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>                geom <span class="op">=</span> <span class="st">"area"</span>, fill <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlim</span><span class="op">(</span><span class="fl">4</span>, <span class="fl">8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Possible cluster-specific intercepts"</span>, y <span class="op">=</span> <span class="st">"Density"</span>,</span>
<span>       title <span class="op">=</span> <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"Normal(µ = {round(B0, 3)}, σ = {round(sigma_0, 3)}&lt;sup&gt;2&lt;/sup&gt;)"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_nice</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu">element_markdown</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-offset-distribution-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:85.0%"></p>
</figure>
</div>
</div>
</div>
<p>When generating population-level estimates, then, we need to somehow incorporate this range of possible cluster-specific intercepts into the population-level predictions. We can do this a couple different ways: we can (1) average, marginalize or integrate across them, or (2) integrate them out.</p>
<section id="average-population-level-outcomes" class="level3"><h3 class="anchored" data-anchor-id="average-population-level-outcomes">Average population-level outcomes</h3>
<p>The average outcome <span class="math inline">\(Y_{i_j}\)</span> across the possible values of <span class="math inline">\(\text{TX}\)</span> for all clusters together is formally defined as</p>
<p><span class="math display">\[
\textbf{E}(Y_{i_j} \mid \text{TX} = \{0, 1\})
\]</span></p>
<p>As with the conditional effects, the equation for calculating this depends on the family you’re using. For lognormal families, it’s this incredibly scary formula:</p>
<p><span class="math display">\[
\textbf{E}(Y_{i_j} \mid \text{TX} = \{0, 1\}) = \int \exp \left(x + \sigma_y^2 / 2 \right) \, f_{\texttt{dnorm}} \left(x, \left(\beta_0 + \beta_1 \text{TX} \right), \sigma_0^2 \right) \,dx
\]</span></p>
<p>Wild. This is a mess because it integrates over the normally-distributed cluster-specific offsets, thus incorporating them all into the overall effect.</p>
<p>We can calculate this integral in a few different ways. <a href="https://rpsychologist.com/GLMM-part1-lognormal#how-to-calculate-marginal-effects-on-the-data-scale">Kristoffer Magnusson shows three different ways</a> to calculate this hairy integral in his original post:</p>
<ol type="1">
<li>
<p><strong>Numeric integration</strong> with <code><a href="https://rdrr.io/r/stats/integrate.html">integrate()</a></code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">B_TXs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">B0</span>, <span class="va">B0</span> <span class="op">+</span> <span class="va">B1</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">set_names</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"0"</span>, <span class="st">"1"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">B_TXs</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">map</span><span class="op">(</span><span class="op">~</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/integrate.html">integrate</a></span><span class="op">(</span></span>
<span>      f <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">x</span> <span class="op">+</span> <span class="va">sigma_y</span> <span class="op">^</span> <span class="fl">2</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">.</span>, sd <span class="op">=</span> <span class="va">sigma_0</span><span class="op">)</span></span>
<span>      <span class="op">}</span>,</span>
<span>      lower <span class="op">=</span> <span class="va">B0</span> <span class="op">-</span> <span class="fl">10</span> <span class="op">*</span> <span class="va">sigma_0</span>,</span>
<span>      upper <span class="op">=</span> <span class="va">B0</span> <span class="op">+</span> <span class="fl">10</span> <span class="op">*</span> <span class="va">sigma_0</span></span>
<span>    <span class="op">)</span><span class="op">$</span><span class="va">value</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="co">## $`0`</span></span>
<span><span class="co">## [1] 692</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $`1`</span></span>
<span><span class="co">## [1] 343</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
<li>
<p>A magical <a href="https://en.wikipedia.org/wiki/Log-normal_distribution#Characteristic_function_and_moment_generating_function"><strong>moment-generating function</strong> for the lognormal distribution</a>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">B_TXs</span> <span class="op">+</span> <span class="op">(</span><span class="va">sigma_0</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="va">sigma_y</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">##   0   1 </span></span>
<span><span class="co">## 692 343</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
<li>
<p><strong>Brute force Monte Carlo integration</strong>, where we create a bunch of hypothetical cluster offsets <span class="math inline">\(b_{0_j}\)</span> with a mean of 0 and a standard deviation of <span class="math inline">\(\sigma_0\)</span>, calculate the average outcome, then take the average of all those hypothetical clusters:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># A bunch of hypothetical cluster offsets</span></span>
<span><span class="va">sigma_0_i</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1e5</span>, <span class="fl">0</span>, <span class="va">sigma_0</span><span class="op">)</span></span>
<span><span class="va">B_TXs</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">map</span><span class="op">(</span><span class="op">~</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">.</span> <span class="op">+</span> <span class="va">sigma_0_i</span> <span class="op">+</span> <span class="va">sigma_y</span><span class="op">^</span><span class="fl">2</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="co">## $`0`</span></span>
<span><span class="co">## [1] 692</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $`1`</span></span>
<span><span class="co">## [1] 343</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
</ol>
<p>Those approaches are all great, but the math can get really complicated if there are interaction terms or splines or if you have more complex random effects structures (random slope offsets! nested groups!)</p>
<p>So instead we can use {marginaleffects} to handle all that complexity for us.</p>
<ol start="4" type="1">
<li>
<p><strong>Average / marginalize / integrate across existing random effects</strong>: Here we calculate predictions for <span class="math inline">\(\text{TX} = \{0, 1\}\)</span> within each of the existing clusters. We then collapse them into averages for each level of <span class="math inline">\(\text{TX}\)</span>. The values here are not identical to what we found with the earlier approaches, though they’re in the same general area. I’m not 100% why—I’m guessing it’s because there aren’t a lot of clusters to work with, so the averages aren’t really stable.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">predictions</span><span class="op">(</span></span>
<span>  <span class="va">fit</span>, </span>
<span>  newdata <span class="op">=</span> <span class="fu">datagrid</span><span class="op">(</span>TX <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, </span>
<span>                     cluster <span class="op">=</span> <span class="va">unique</span><span class="op">)</span>, </span>
<span>  by <span class="op">=</span> <span class="st">"TX"</span>, </span>
<span>  re_formula <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output cell-output-stdout">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## # A tibble: 2 × 5</span></span>
<span><span class="co">##   type        TX predicted conf.low conf.high</span></span>
<span><span class="co">##   &lt;chr&gt;    &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 response     0      647.     502.      905.</span></span>
<span><span class="co">## 2 response     1      321.     250.      443.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>We can visualize the posteriors too:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">marginal_preds</span> <span class="op">&lt;-</span> <span class="fu">predictions</span><span class="op">(</span></span>
<span>  <span class="va">fit</span>, </span>
<span>  newdata <span class="op">=</span> <span class="fu">datagrid</span><span class="op">(</span>TX <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, </span>
<span>                     cluster <span class="op">=</span> <span class="va">unique</span><span class="op">)</span>, </span>
<span>  by <span class="op">=</span> <span class="st">"TX"</span>, </span>
<span>  re_formula <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">posteriordraws</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">p_marginal_preds</span> <span class="op">&lt;-</span> <span class="va">marginal_preds</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">draw</span>, fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">TX</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu">colorspace</span><span class="fu">::</span><span class="fu">lighten</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">clrs</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span>, <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_dollar</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Gambling losses"</span>, y <span class="op">=</span> <span class="st">"Density"</span>, fill <span class="op">=</span> <span class="st">"TX"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"Marginal population-level means"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Random effects averaged / marginalized / integrated"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">1500</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_nice</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">p_marginal_preds</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-marginal-preds-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:85.0%"></p>
</figure>
</div>
</div>
</div>
</li>
<li>
<p><strong>Integrate out random effects</strong>: Instead of using the existing cluster intercepts, we can integrate out the random effects by generating predictions for a bunch of clusters (like 100), and then collapse those predictions into averages. This is similar to the intuition of brute force Monte Carlo integration in approach #3 earlier. <em>This takes a long time!</em> It results in the same estimates we found with the mathematical approaches in #1, #2, and #3 earlier.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">predictions</span><span class="op">(</span><span class="va">fit</span>, newdata <span class="op">=</span> <span class="fu">datagrid</span><span class="op">(</span>TX <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, cluster <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">:</span><span class="op">-</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            allow_new_levels <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>            sample_new_levels <span class="op">=</span> <span class="st">"gaussian"</span>,</span>
<span>            by <span class="op">=</span> <span class="st">"TX"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output cell-output-stdout">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## # A tibble: 2 × 5</span></span>
<span><span class="co">##   type        TX predicted conf.low conf.high</span></span>
<span><span class="co">##   &lt;chr&gt;    &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 response     0      682.     461.     1168.</span></span>
<span><span class="co">## 2 response     1      340.     227.      577.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">marginal_preds_int</span> <span class="op">&lt;-</span> <span class="fu">predictions</span><span class="op">(</span></span>
<span>  <span class="va">fit</span>, </span>
<span>  newdata <span class="op">=</span> <span class="fu">datagrid</span><span class="op">(</span>TX <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, </span>
<span>                     cluster <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">:</span><span class="op">-</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  re_formula <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  allow_new_levels <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  sample_new_levels <span class="op">=</span> <span class="st">"gaussian"</span>,</span>
<span>  by <span class="op">=</span> <span class="st">"TX"</span></span>
<span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">posteriordraws</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">p_marginal_preds_int</span> <span class="op">&lt;-</span> <span class="va">marginal_preds_int</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">draw</span>, fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">TX</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu">colorspace</span><span class="fu">::</span><span class="fu">lighten</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">clrs</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span>, <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_dollar</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Gambling losses"</span>, y <span class="op">=</span> <span class="st">"Density"</span>, fill <span class="op">=</span> <span class="st">"TX"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"Marginal population-level means"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Random effects integrated out"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">1500</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_nice</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">p_marginal_preds_int</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-marginal-preds-int-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:85.0%"></p>
</figure>
</div>
</div>
</div>
</li>
</ol></section><section id="population-level-ate" class="level3"><h3 class="anchored" data-anchor-id="population-level-ate">Population-level ATE</h3>
<p>The average treatment effect (ATE) for a binary treatment is the difference between the two averages when <span class="math inline">\(\text{TX} = 1\)</span> and <span class="math inline">\(\text{TX} = 0\)</span>, after somehow incorporating all the random cluster-specific offsets:</p>
<p><span class="math display">\[
\textbf{E}(Y_{i_j} \mid \text{TX} = 1) - \textbf{E}(Y_{i_j} \mid \text{TX} = 0)
\]</span></p>
<p>For a lognormal family, it’s this terrifying thing:</p>
<p><span class="math display">\[
\begin{aligned}
&amp;\textbf{E}(Y_{i_j} \mid \text{TX} = 1) - \textbf{E}(Y_{i_j} \mid \text{TX} = 0) = \\
&amp;\qquad \int \exp \left(x + \sigma_y^2 / 2 \right) \, f_{\texttt{dnorm}} \left(x, \left(\beta_0 + \beta_1 \right), \sigma_0^2 \right) \,dx \ - \\
&amp;\qquad \int \exp \left(x + \sigma_y^2 / 2 \right) \, f_{\texttt{dnorm}} \left(x, \beta_0, \sigma_0^2 \right) \,dx
\end{aligned}
\]</span></p>
<p>That looks scary, but really it’s just the difference in the two estimates we found before: <span class="math inline">\(\textbf{E}(Y_{i_j} \mid \text{TX} = 1)\)</span> and <span class="math inline">\(\textbf{E}(Y_{i_j} \mid \text{TX} = 0)\)</span>. We can use the same approaches from above and just subtract the two estimates, like this with the magical moment-generating function thing:</p>
<ol start="2" type="1">
<li>
<p>Population-level ATE with <strong>moment-generating function</strong>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">B_TXs</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="op">(</span><span class="va">sigma_0</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="va">sigma_y</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span> <span class="op">-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">B_TXs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="op">(</span><span class="va">sigma_0</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="va">sigma_y</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">##    1 </span></span>
<span><span class="co">## -349</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
</ol>
<p>We can do this with {marginaleffects} too, either by averaging / marginalizing / integrating across existing clusters (though again, this weirdly gives slightly different results) or by integrating out the random effects from a bunch of hypothetical clusters (which gives the same result as the more analytical / mathematical estimates):</p>
<ol start="4" type="1">
<li>
<p><strong>Average / marginalize / integrate across existing random effects</strong>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Marginal treatment effect (or global population level effect)</span></span>
<span><span class="fu">comparisons</span><span class="op">(</span></span>
<span>  <span class="va">fit</span>, </span>
<span>  variables <span class="op">=</span> <span class="st">"TX"</span>, </span>
<span>  re_formula <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">tidy</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output cell-output-stdout">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## # A tibble: 1 × 6</span></span>
<span><span class="co">##   type     term  contrast estimate conf.low conf.high</span></span>
<span><span class="co">##   &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt;       &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 response TX    1 - 0       -326.    -652.     -60.9</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">marginal_ate</span> <span class="op">&lt;-</span> <span class="fu">comparisons</span><span class="op">(</span></span>
<span>  <span class="va">fit</span>, </span>
<span>  variables <span class="op">=</span> <span class="st">"TX"</span>, </span>
<span>  re_formula <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">posteriordraws</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">p_marginal_ate</span> <span class="op">&lt;-</span> <span class="va">marginal_ate</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">drawid</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>draw <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">draw</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">draw</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span>fill <span class="op">=</span> <span class="fu">colorspace</span><span class="fu">::</span><span class="fu">lighten</span><span class="op">(</span><span class="va">clrs</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_dollar</span><span class="op">(</span>style_negative <span class="op">=</span> <span class="st">"minus"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"(TX = 1) − (TX = 0)"</span>, y <span class="op">=</span> <span class="st">"Density"</span>, </span>
<span>       title <span class="op">=</span> <span class="st">"Marginal population-level ATE"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Random effects averaged / marginalized / integrated"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">900</span>, <span class="fl">300</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_nice</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">p_marginal_ate</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-marginal-ate-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:85.0%"></p>
</figure>
</div>
</div>
</div>
</li>
<li>
<p><strong>Integrate out random effects</strong></p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># This takes a *really* long time</span></span>
<span><span class="fu">comparisons</span><span class="op">(</span></span>
<span>  <span class="va">fit</span>, </span>
<span>  variables <span class="op">=</span> <span class="st">"TX"</span>, </span>
<span>  newdata <span class="op">=</span> <span class="fu">datagrid</span><span class="op">(</span>cluster <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">:</span><span class="op">-</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  re_formula <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  allow_new_levels <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  sample_new_levels <span class="op">=</span> <span class="st">"gaussian"</span></span>
<span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">tidy</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output cell-output-stdout">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## # A tibble: 1 × 6</span></span>
<span><span class="co">##   type     term  contrast estimate conf.low conf.high</span></span>
<span><span class="co">##   &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt;       &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 response TX    1 - 0       -338.    -779.     -64.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">marginal_ate_int</span> <span class="op">&lt;-</span> <span class="fu">comparisons</span><span class="op">(</span></span>
<span>  <span class="va">fit</span>, </span>
<span>  variables <span class="op">=</span> <span class="st">"TX"</span>, </span>
<span>  newdata <span class="op">=</span> <span class="fu">datagrid</span><span class="op">(</span>cluster <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">:</span><span class="op">-</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  re_formula <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  allow_new_levels <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  sample_new_levels <span class="op">=</span> <span class="st">"gaussian"</span></span>
<span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">posteriordraws</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">p_marginal_ate_int</span> <span class="op">&lt;-</span> <span class="va">marginal_ate_int</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">drawid</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>draw <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">draw</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">draw</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span>fill <span class="op">=</span> <span class="fu">colorspace</span><span class="fu">::</span><span class="fu">lighten</span><span class="op">(</span><span class="va">clrs</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_dollar</span><span class="op">(</span>style_negative <span class="op">=</span> <span class="st">"minus"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"(TX = 1) − (TX = 0)"</span>, y <span class="op">=</span> <span class="st">"Density"</span>, </span>
<span>       title <span class="op">=</span> <span class="st">"Marginal population-level ATE"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Random effects integrated out"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">900</span>, <span class="fl">300</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_nice</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">p_marginal_ate_int</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-marginal-ate-int-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:85.0%"></p>
</figure>
</div>
</div>
</div>
</li>
</ol></section></section><section id="ratios-and-multiplicative-effects" class="level2"><h2 class="anchored" data-anchor-id="ratios-and-multiplicative-effects">Ratios and multiplicative effects</h2>
<p>Finally, we can work directly with the coefficients to get more slope-like effects, which is especially helpful when the coefficient of interest isn’t for a binary variable. Typically with GLMs with log or logit links (like logit, Poisson, negative binomial, lognormal, etc.) we can exponentiate the coefficient to get it as an odds ratio or a multiplicative effect. That works here too:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">B1</span><span class="op">)</span></span>
<span><span class="co">##  b_TX </span></span>
<span><span class="co">## 0.495</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A one-unit increase in <span class="math inline">\(\text{TX}\)</span> causes a 51% decrease (<code>exp(B1) - 1</code>) in the outcome. Great.</p>
<p>That’s all fine here because the lognormal model doesn’t have any weird nonlinearities or interactions, but in the case of logistic regression or anything with interaction terms, life gets more complicated, so it’s better to work with <code>marginaleffects()</code> instead of exponentiating things by hand. If we use <code>type = "link"</code> we’ll keep the results as logged odds, and then we can exponentiate them. All the other random effects options that we used before (<code>re_formula = NA</code>, <code>re_formula = NULL</code>, integrating effects out, and so on) work here too.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">marginaleffects</span><span class="op">(</span></span>
<span>  <span class="va">fit</span>, </span>
<span>  variable <span class="op">=</span> <span class="st">"TX"</span>, </span>
<span>  type <span class="op">=</span> <span class="st">"link"</span>,</span>
<span>  newdata <span class="op">=</span> <span class="fu">datagrid</span><span class="op">(</span>TX <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">estimate</span>, <span class="va">conf.low</span>, <span class="va">conf.high</span><span class="op">)</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">rowid</span>, <span class="va">term</span>, <span class="va">estimate</span>, <span class="va">conf.low</span>, <span class="va">conf.high</span><span class="op">)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##  Term Estimate CI low CI high</span></span>
<span><span class="co">##    TX    0.496  0.279    0.88</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Columns: rowid, term, estimate, conf.low, conf.high</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can visualize the odds-ratio-scale posterior for fun:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">marginaleffects</span><span class="op">(</span></span>
<span>  <span class="va">fit</span>, </span>
<span>  variable <span class="op">=</span> <span class="st">"TX"</span>, </span>
<span>  type <span class="op">=</span> <span class="st">"link"</span>,</span>
<span>  newdata <span class="op">=</span> <span class="fu">datagrid</span><span class="op">(</span>TX <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">posteriordraws</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>draw <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">draw</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">draw</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span>fill <span class="op">=</span> <span class="fu">colorspace</span><span class="fu">::</span><span class="fu">darken</span><span class="op">(</span><span class="va">clrs</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_percent</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Percent change in outcome"</span>, y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_nice</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/unnamed-chunk-41-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:85.0%"></p>
</figure>
</div>
</div>
</div>
<p>If we use <code>type = "response"</code>, we can get slopes at specific values of the coefficient (which is less helpful here, since <span class="math inline">\(\text{TX}\)</span> can only be 0 or 1; but it’s useful for continuous coefficients of interest).</p>
</section><section id="summary" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>Phew, that was a lot. Here’s a summary table to reference to help keep things straight.</p>
<div class="column-page-right">
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">wrap_r</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">'&lt;div class="sourceCode cell-code"&gt;&lt;pre class="sourceCode r"&gt;&lt;code class="sourceCode r"&gt;{x}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">conditional_out</span> <span class="op">&lt;-</span> <span class="st">r"{predictions(</span></span>
<span><span class="st">  fit, </span></span>
<span><span class="st">  newdata = datagrid(TX = c(0, 1)), </span></span>
<span><span class="st">  by = "TX", </span></span>
<span><span class="st">  re_formula = NA</span></span>
<span><span class="st">)}"</span></span>
<span></span>
<span><span class="va">conditional_ate</span> <span class="op">&lt;-</span> <span class="st">r"{comparisons(</span></span>
<span><span class="st">  fit, </span></span>
<span><span class="st">  variables = "TX",</span></span>
<span><span class="st">  re_formula = NA</span></span>
<span><span class="st">)}"</span></span>
<span></span>
<span><span class="va">marginal_out</span> <span class="op">&lt;-</span> <span class="st">r"{predictions(</span></span>
<span><span class="st">  fit, </span></span>
<span><span class="st">  newdata = datagrid(TX = c(0, 1), </span></span>
<span><span class="st">                     cluster = unique), </span></span>
<span><span class="st">  by = "TX", </span></span>
<span><span class="st">  re_formula = NULL</span></span>
<span><span class="st">)}"</span></span>
<span></span>
<span><span class="va">marginal_out_int</span> <span class="op">&lt;-</span> <span class="st">r"{predictions(</span></span>
<span><span class="st">  fit, </span></span>
<span><span class="st">  newdata = datagrid(TX = c(0, 1), </span></span>
<span><span class="st">                     cluster = c(-1:-100)),</span></span>
<span><span class="st">  re_formula = NULL,</span></span>
<span><span class="st">  allow_new_levels = TRUE,</span></span>
<span><span class="st">  sample_new_levels = "gaussian",</span></span>
<span><span class="st">  by = "TX"</span></span>
<span><span class="st">)}"</span></span>
<span></span>
<span><span class="va">marginal_ate</span> <span class="op">&lt;-</span> <span class="st">r"{comparisons(</span></span>
<span><span class="st">  fit, </span></span>
<span><span class="st">  variables = "TX", </span></span>
<span><span class="st">  re_formula = NULL</span></span>
<span><span class="st">) %&gt;% </span></span>
<span><span class="st">  tidy()</span></span>
<span><span class="st">}"</span></span>
<span></span>
<span><span class="va">marginal_ate_int</span> <span class="op">&lt;-</span> <span class="st">r"{comparisons(</span></span>
<span><span class="st">  fit, </span></span>
<span><span class="st">  variables = "TX", </span></span>
<span><span class="st">  newdata = datagrid(cluster = c(-1:-100)),</span></span>
<span><span class="st">  re_formula = NULL,</span></span>
<span><span class="st">  allow_new_levels = TRUE,</span></span>
<span><span class="st">  sample_new_levels = "gaussian"</span></span>
<span><span class="st">) %&gt;% </span></span>
<span><span class="st">  tidy()</span></span>
<span><span class="st">}"</span></span>
<span></span>
<span><span class="fu">tribble</span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">Effect</span>, <span class="op">~</span><span class="va">Formula</span>, <span class="op">~</span><span class="va">`{marginaleffects} code`</span>,</span>
<span>  <span class="st">"Average outcomes in typical group"</span>, <span class="st">"\\(\\textbf{E}(Y_{i_j} \\mid b_{0_j} = 0, \\text{TX} = \\{0, 1\\})\\)"</span>, <span class="fu">wrap_r</span><span class="op">(</span><span class="va">conditional_out</span><span class="op">)</span>,</span>
<span>  <span class="st">"ATE in typical group"</span>, <span class="st">"\\(\\textbf{E}(Y_{i_j} \\mid b_{0_j} = 0, \\text{TX} = 1) -\\)&lt;br&gt; \\(\\quad\\textbf{E}(Y_{i_j} \\mid b_{0_j} = 0, \\text{TX} = 0)\\)"</span>, <span class="fu">wrap_r</span><span class="op">(</span><span class="va">conditional_ate</span><span class="op">)</span>,</span>
<span>  <span class="st">"Average population-level outcomes (marginalized)"</span>, <span class="st">"\\(\\textbf{E}(Y_{i_j} \\mid \\text{TX} = \\{0, 1\\})\\)"</span>, <span class="fu">wrap_r</span><span class="op">(</span><span class="va">marginal_out</span><span class="op">)</span>,</span>
<span>  <span class="st">"Average population-level outcomes (integrated out)"</span>, <span class="st">"\\(\\textbf{E}(Y_{i_j} \\mid \\text{TX} = \\{0, 1\\})\\)"</span>, <span class="fu">wrap_r</span><span class="op">(</span><span class="va">marginal_out_int</span><span class="op">)</span>,</span>
<span>  <span class="st">"Population-level ATE (marginalized)"</span>, <span class="st">"\\(\\textbf{E}(Y_{i_j} \\mid \\text{TX} = 1) -\\)&lt;br&gt; \\(\\quad\\textbf{E}(Y_{i_j} \\mid \\text{TX} = 0)\\)"</span>, <span class="fu">wrap_r</span><span class="op">(</span><span class="va">marginal_ate</span><span class="op">)</span>,</span>
<span>  <span class="st">"Population-level ATE (integrated out)"</span>, <span class="st">"\\(\\textbf{E}(Y_{i_j} \\mid \\text{TX} = 1) -\\)&lt;br&gt; \\(\\quad\\textbf{E}(Y_{i_j} \\mid \\text{TX} = 0)\\)"</span>, <span class="fu">wrap_r</span><span class="op">(</span><span class="va">marginal_ate_int</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">kbl</span><span class="op">(</span>escape <span class="op">=</span> <span class="cn">FALSE</span>, align <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"l"</span>, <span class="st">"l"</span>, <span class="st">"l"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">kable_styling</span><span class="op">(</span>htmltable_class <span class="op">=</span> <span class="st">"table table-sm"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">pack_rows</span><span class="op">(</span>index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Conditional effects"</span> <span class="op">=</span> <span class="fl">2</span>, <span class="st">"Marginal effects"</span> <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">column_spec</span><span class="op">(</span><span class="fl">1</span>, width <span class="op">=</span> <span class="st">"25%"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">column_spec</span><span class="op">(</span><span class="fl">2</span>, width <span class="op">=</span> <span class="st">"35%"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">column_spec</span><span class="op">(</span><span class="fl">3</span>, width <span class="op">=</span> <span class="st">"40%"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<table class="table table-sm caption-top table-striped small" data-quarto-postprocess="true">
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Effect</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Formula</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">{marginaleffects} code</th>
</tr></thead>
<tbody>
<tr class="odd" data-grouplength="2">
<td colspan="3" style="border-bottom: 1px solid"><strong>Conditional effects</strong></td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em; width: 25%;" data-indentlevel="1">Average outcomes in typical group</td>
<td style="text-align: left; width: 35%;">\(\textbf{E}(Y_{i_j} \mid b_{0_j} = 0, \text{TX} = \{0, 1\})\)</td>
<td style="text-align: left; width: 40%;"><div class="sourceCode cell-code">
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">predictions</span><span class="op">(</span></span>
<span>  <span class="va">fit</span>, </span>
<span>  newdata <span class="op">=</span> <span class="fu">datagrid</span><span class="op">(</span>TX <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>, </span>
<span>  by <span class="op">=</span> <span class="st">"TX"</span>, </span>
<span>  re_formula <span class="op">=</span> <span class="cn">NA</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em; width: 25%;" data-indentlevel="1">ATE in typical group</td>
<td style="text-align: left; width: 35%;">\(\textbf{E}(Y_{i_j} \mid b_{0_j} = 0, \text{TX} = 1) -\)<br>
\(\quad\textbf{E}(Y_{i_j} \mid b_{0_j} = 0, \text{TX} = 0)\)</td>
<td style="text-align: left; width: 40%;"><div class="sourceCode cell-code">
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">comparisons</span><span class="op">(</span></span>
<span>  <span class="va">fit</span>, </span>
<span>  variables <span class="op">=</span> <span class="st">"TX"</span>,</span>
<span>  re_formula <span class="op">=</span> <span class="cn">NA</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></td>
</tr>
<tr class="even" data-grouplength="4">
<td colspan="3" style="border-bottom: 1px solid"><strong>Marginal effects</strong></td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em; width: 25%;" data-indentlevel="1">Average population-level outcomes (marginalized)</td>
<td style="text-align: left; width: 35%;">\(\textbf{E}(Y_{i_j} \mid \text{TX} = \{0, 1\})\)</td>
<td style="text-align: left; width: 40%;"><div class="sourceCode cell-code">
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">predictions</span><span class="op">(</span></span>
<span>  <span class="va">fit</span>, </span>
<span>  newdata <span class="op">=</span> <span class="fu">datagrid</span><span class="op">(</span>TX <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, </span>
<span>                     cluster <span class="op">=</span> <span class="va">unique</span><span class="op">)</span>, </span>
<span>  by <span class="op">=</span> <span class="st">"TX"</span>, </span>
<span>  re_formula <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em; width: 25%;" data-indentlevel="1">Average population-level outcomes (integrated out)</td>
<td style="text-align: left; width: 35%;">\(\textbf{E}(Y_{i_j} \mid \text{TX} = \{0, 1\})\)</td>
<td style="text-align: left; width: 40%;"><div class="sourceCode cell-code">
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">predictions</span><span class="op">(</span></span>
<span>  <span class="va">fit</span>, </span>
<span>  newdata <span class="op">=</span> <span class="fu">datagrid</span><span class="op">(</span>TX <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, </span>
<span>                     cluster <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">:</span><span class="op">-</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  re_formula <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  allow_new_levels <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  sample_new_levels <span class="op">=</span> <span class="st">"gaussian"</span>,</span>
<span>  by <span class="op">=</span> <span class="st">"TX"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em; width: 25%;" data-indentlevel="1">Population-level ATE (marginalized)</td>
<td style="text-align: left; width: 35%;">\(\textbf{E}(Y_{i_j} \mid \text{TX} = 1) -\)<br>
\(\quad\textbf{E}(Y_{i_j} \mid \text{TX} = 0)\)</td>
<td style="text-align: left; width: 40%;"><div class="sourceCode cell-code">
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">comparisons</span><span class="op">(</span></span>
<span>  <span class="va">fit</span>, </span>
<span>  variables <span class="op">=</span> <span class="st">"TX"</span>, </span>
<span>  re_formula <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">tidy</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em; width: 25%;" data-indentlevel="1">Population-level ATE (integrated out)</td>
<td style="text-align: left; width: 35%;">\(\textbf{E}(Y_{i_j} \mid \text{TX} = 1) -\)<br>
\(\quad\textbf{E}(Y_{i_j} \mid \text{TX} = 0)\)</td>
<td style="text-align: left; width: 40%;"><div class="sourceCode cell-code">
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">comparisons</span><span class="op">(</span></span>
<span>  <span class="va">fit</span>, </span>
<span>  variables <span class="op">=</span> <span class="st">"TX"</span>, </span>
<span>  newdata <span class="op">=</span> <span class="fu">datagrid</span><span class="op">(</span>cluster <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">:</span><span class="op">-</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  re_formula <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  allow_new_levels <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  sample_new_levels <span class="op">=</span> <span class="st">"gaussian"</span></span>
<span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">tidy</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>And here are all the posteriors all together, for easier comparison:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span><span class="op">(</span><span class="va">p_conditional_preds</span> <span class="op">+</span> <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1200</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|</span> <span class="va">p_conditional_ate</span><span class="op">)</span> <span class="op">/</span></span>
<span>  <span class="op">(</span><span class="op">(</span><span class="va">p_marginal_preds</span> <span class="op">+</span> <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1200</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|</span> <span class="va">p_marginal_ate</span><span class="op">)</span> <span class="op">/</span></span>
<span>  <span class="op">(</span><span class="op">(</span><span class="va">p_marginal_preds_int</span> <span class="op">+</span> <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1200</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|</span> <span class="va">p_marginal_ate_int</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/plot-everything-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page" style="width:85.0%"></p>
</figure>
</div>
</div>
</div>


<!-- -->

</section><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{heiss2022,
  author = {Heiss, Andrew},
  title = {Marginal and Conditional Effects for {GLMMs} with
    \{Marginaleffects\}},
  date = {2022-11-29},
  url = {https://www.andrewheiss.com/blog/2022/11/29/conditional-marginal-marginaleffects/},
  doi = {10.59350/xwnfm-x1827},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-heiss2022" class="csl-entry quarto-appendix-citeas" role="listitem">
Heiss, Andrew. 2022. <span>“Marginal and Conditional Effects for GLMMs
with {Marginaleffects}.”</span> November 29, 2022. <a href="https://doi.org/10.59350/xwnfm-x1827">https://doi.org/10.59350/xwnfm-x1827</a>.
</div></div></section></div></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/www\.andrewheiss\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><script src="https://giscus.app/client.js" data-repo="andrewheiss/ath-quarto" data-repo-id="R_kgDOIg6EJQ" data-category="Blog comments" data-category-id="DIC_kwDOIg6EJc4CSz92" data-mapping="pathname" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script><input type="hidden" id="giscus-base-theme" value="light"><input type="hidden" id="giscus-alt-theme" value="dark"><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb55" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Marginal and conditional effects for GLMMs with {marginaleffects}"</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> 2022-11-29</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="an">description:</span><span class="co"> "Use the {marginaleffects} package to calculate tricky and nuanced marginal and conditional effects in generalized linear mixed models"</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a><span class="an">image:</span><span class="co"> index_files/figure-html/plot-conditional-preds-1.png</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a><span class="co">  - r</span></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a><span class="co">  - tidyverse</span></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a><span class="co">  - regression</span></span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a><span class="co">  - statistics</span></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a><span class="co">  - bayes</span></span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a><span class="co">  - brms</span></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a><span class="co">  - lognormal</span></span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a><span class="an">resources:</span><span class="co"> </span></span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a><span class="co">  - "df_example_lognormal.rds"</span></span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a><span class="co">  html: </span></span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: false</span></span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a><span class="co">    fig-cap-location: bottom</span></span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a><span class="co">    shift-heading-level-by: 1</span></span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a><span class="an">doi:</span><span class="co"> 10.59350/xwnfm-x1827</span></span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a><span class="an">citation:</span><span class="co"> true</span></span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-25"><a href="#cb55-25" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setup, include=FALSE}</span></span>
<span id="cb55-26"><a href="#cb55-26" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::opts_chunk$set(fig.align = "center", fig.retina = 3,</span></span>
<span id="cb55-27"><a href="#cb55-27" aria-hidden="true" tabindex="-1"></a><span class="in">                      fig.width = 6, fig.height = (6 * 0.618),</span></span>
<span id="cb55-28"><a href="#cb55-28" aria-hidden="true" tabindex="-1"></a><span class="in">                      out.width = "85%", collapse = TRUE,</span></span>
<span id="cb55-29"><a href="#cb55-29" aria-hidden="true" tabindex="-1"></a><span class="in">                      dev = "png", dev.args = list(type = "cairo-png"))</span></span>
<span id="cb55-30"><a href="#cb55-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-31"><a href="#cb55-31" aria-hidden="true" tabindex="-1"></a><span class="in">options(digits = 3, width = 120,</span></span>
<span id="cb55-32"><a href="#cb55-32" aria-hidden="true" tabindex="-1"></a><span class="in">        dplyr.summarise.inform = FALSE,</span></span>
<span id="cb55-33"><a href="#cb55-33" aria-hidden="true" tabindex="-1"></a><span class="in">        knitr.kable.NA = "")</span></span>
<span id="cb55-34"><a href="#cb55-34" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-35"><a href="#cb55-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-36"><a href="#cb55-36" aria-hidden="true" tabindex="-1"></a>As a field, statistics is really bad at naming things. </span>
<span id="cb55-37"><a href="#cb55-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-38"><a href="#cb55-38" aria-hidden="true" tabindex="-1"></a>Take, for instance, the term "fixed effects." In econometrics and other social science-flavored statistics, this typically refers to categorical terms in a regression model. Like, if we run a model like this with <span class="co">[</span><span class="ot">gapminder</span><span class="co">](https://github.com/jennybc/gapminder)</span> data…</span>
<span id="cb55-39"><a href="#cb55-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-40"><a href="#cb55-40" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval=FALSE}</span></span>
<span id="cb55-41"><a href="#cb55-41" aria-hidden="true" tabindex="-1"></a><span class="in">library(gapminder)</span></span>
<span id="cb55-42"><a href="#cb55-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-43"><a href="#cb55-43" aria-hidden="true" tabindex="-1"></a><span class="in">some_model &lt;- lm(lifeExp ~ gdpPercap + country,</span></span>
<span id="cb55-44"><a href="#cb55-44" aria-hidden="true" tabindex="-1"></a><span class="in">                 data = gapminder)</span></span>
<span id="cb55-45"><a href="#cb55-45" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-46"><a href="#cb55-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-47"><a href="#cb55-47" aria-hidden="true" tabindex="-1"></a>…we can say that we've added "country fixed effects."</span>
<span id="cb55-48"><a href="#cb55-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-49"><a href="#cb55-49" aria-hidden="true" tabindex="-1"></a>That's all fine and good until we come to the world of hierarchical or multilevel models, which has its own issues with nomenclature and can't decide what to even call itself:</span>
<span id="cb55-50"><a href="#cb55-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-51"><a href="#cb55-51" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=FALSE}</span></span>
<span id="cb55-52"><a href="#cb55-52" aria-hidden="true" tabindex="-1"></a><span class="in">#| out.width: 60%</span></span>
<span id="cb55-53"><a href="#cb55-53" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: "Image by [Chelsea Parlett-Pelleriti](https://twitter.com/chelseaparlett/status/1458461737431146500)"</span></span>
<span id="cb55-54"><a href="#cb55-54" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::include_graphics("chelsea-meme.jpg")</span></span>
<span id="cb55-55"><a href="#cb55-55" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-56"><a href="#cb55-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-57"><a href="#cb55-57" aria-hidden="true" tabindex="-1"></a>If we fit a model like this with country-based offsets to the intercept…</span>
<span id="cb55-58"><a href="#cb55-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-59"><a href="#cb55-59" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval=FALSE}</span></span>
<span id="cb55-60"><a href="#cb55-60" aria-hidden="true" tabindex="-1"></a><span class="in">library(lme4)</span></span>
<span id="cb55-61"><a href="#cb55-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-62"><a href="#cb55-62" aria-hidden="true" tabindex="-1"></a><span class="in">some_multilevel_model &lt;- lmer(lifeExp ~ gdpPercap + (1 | country), </span></span>
<span id="cb55-63"><a href="#cb55-63" aria-hidden="true" tabindex="-1"></a><span class="in">                              data = gapminder)</span></span>
<span id="cb55-64"><a href="#cb55-64" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-65"><a href="#cb55-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-66"><a href="#cb55-66" aria-hidden="true" tabindex="-1"></a>…then we get to say that there are "country random effects" or "country group effects", while <span class="in">`gdpPercap`</span> is actually a "fixed effect" or "population-level effect" </span>
<span id="cb55-67"><a href="#cb55-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-68"><a href="#cb55-68" aria-hidden="true" tabindex="-1"></a>"Fixed effects" in multilevel models aren't at all the same as "fixed effects" in econometrics-land. </span>
<span id="cb55-69"><a href="#cb55-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-70"><a href="#cb55-70" aria-hidden="true" tabindex="-1"></a>Wild.</span>
<span id="cb55-71"><a href="#cb55-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-74"><a href="#cb55-74" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb55-75"><a href="#cb55-75" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb55-76"><a href="#cb55-76" aria-hidden="true" tabindex="-1"></a><span class="co">#| out-width: 100%</span></span>
<span id="cb55-77"><a href="#cb55-77" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "lol statisticians call opposite things the same thing"</span></span>
<span id="cb55-78"><a href="#cb55-78" aria-hidden="true" tabindex="-1"></a><span class="co">#| column: page</span></span>
<span id="cb55-79"><a href="#cb55-79" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">"fixed-random-effects.png"</span>)</span>
<span id="cb55-80"><a href="#cb55-80" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-81"><a href="#cb55-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-82"><a href="#cb55-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-83"><a href="#cb55-83" aria-hidden="true" tabindex="-1"></a>Another confusing term is the idea of "marginal effects." One common definition of marginal effects is that they are slopes, or <span class="co">[</span><span class="ot">as the {marginaleffects} vignette says</span><span class="co">](https://vincentarelbundock.github.io/marginaleffects/articles/marginaleffects.html)</span>…</span>
<span id="cb55-84"><a href="#cb55-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-85"><a href="#cb55-85" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; …partial derivatives of the regression equation with respect to each variable in the model for each unit in the data.</span></span>
<span id="cb55-86"><a href="#cb55-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-87"><a href="#cb55-87" aria-hidden="true" tabindex="-1"></a>There's a whole R package ({marginaleffects}) dedicated to calculating these, and <span class="co">[</span><span class="ot">I have a whole big long guide about this</span><span class="co">](https://www.andrewheiss.com/blog/2022/05/20/marginalia/)</span>. Basically marginal effects are the change in the outcome in a regression model when you move one of the explanatory variables up a little while holding all other covariates constant.</span>
<span id="cb55-88"><a href="#cb55-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-89"><a href="#cb55-89" aria-hidden="true" tabindex="-1"></a>But there's also another definition (seemingly?) unrelated to the idea of partial derivatives or slopes! And once again, it's a key part of the multilevel model world. I've run into it many times when reading about multilevel models (and I've even kind of alluded to it <span class="co">[</span><span class="ot">in past blog posts like this</span><span class="co">](https://www.andrewheiss.com/blog/2021/11/10/ame-bayes-re-guide/)</span>), but I've never fully understood what multilevel marginal effects are and how they're different from slope-based marginal effects.</span>
<span id="cb55-90"><a href="#cb55-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-91"><a href="#cb55-91" aria-hidden="true" tabindex="-1"></a>In multilevel models, you can calculate both *marginal effects* and *conditional effects*. Neither are necessarily related to slopes (though they both can be). They're often mixed up. Even {brms} used to have a function named <span class="in">`marginal_effects()`</span> that they've renamed to <span class="in">`conditional_effects()`</span>.</span>
<span id="cb55-92"><a href="#cb55-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-93"><a href="#cb55-93" aria-hidden="true" tabindex="-1"></a>I'm not alone in my inability to remember the difference between marginal and conditional effects in multilevel models, it seems. Everyone mixes these up. <span class="co">[</span><span class="ot">TJ Mahr recently tweeted about the confusion</span><span class="co">](https://twitter.com/tjmahr/status/1581563839459385344)</span>:</span>
<span id="cb55-94"><a href="#cb55-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-95"><a href="#cb55-95" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=FALSE}</span></span>
<span id="cb55-96"><a href="#cb55-96" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::include_graphics("tj-conditional-marginal-tweet.png")</span></span>
<span id="cb55-97"><a href="#cb55-97" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-98"><a href="#cb55-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-99"><a href="#cb55-99" aria-hidden="true" tabindex="-1"></a>TJ studies language development in children and often works with data with repeated child subjects. His typical models might look something like this, with observations grouped by child:</span>
<span id="cb55-100"><a href="#cb55-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-101"><a href="#cb55-101" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval=FALSE}</span></span>
<span id="cb55-102"><a href="#cb55-102" aria-hidden="true" tabindex="-1"></a><span class="in">tj_model &lt;- lmer(y ~ x1 + x2 + (1 | child),</span></span>
<span id="cb55-103"><a href="#cb55-103" aria-hidden="true" tabindex="-1"></a><span class="in">                 data = whatever)</span></span>
<span id="cb55-104"><a href="#cb55-104" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-105"><a href="#cb55-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-106"><a href="#cb55-106" aria-hidden="true" tabindex="-1"></a>His data has child-based clusters, since individual children have repeated observations over time. We can find two different kinds of effects given this type of multilevel model: we can look at the effect of <span class="in">`x1`</span> or <span class="in">`x2`</span> in one typical child, or we can look at the effect of <span class="in">`x1`</span> or <span class="in">`x2`</span> across all children on average. The confusingly-named terms "conditional effect" and "marginal effect" refer to each of these "flavors" of effect:</span>
<span id="cb55-107"><a href="#cb55-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-108"><a href="#cb55-108" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Conditional effect** = average child</span>
<span id="cb55-109"><a href="#cb55-109" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Marginal effect** = children on average</span>
<span id="cb55-110"><a href="#cb55-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-111"><a href="#cb55-111" aria-hidden="true" tabindex="-1"></a>If we have country random effects like <span class="in">`(1 | country)`</span> like I do in my own work, we can calculate the same two kinds of effects. Imagine a multilevel model like this:</span>
<span id="cb55-112"><a href="#cb55-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-113"><a href="#cb55-113" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval=FALSE}</span></span>
<span id="cb55-114"><a href="#cb55-114" aria-hidden="true" tabindex="-1"></a><span class="in">library(lme4)</span></span>
<span id="cb55-115"><a href="#cb55-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-116"><a href="#cb55-116" aria-hidden="true" tabindex="-1"></a><span class="in">some_multilevel_model &lt;- lmer(lifeExp ~ gdpPercap + (1 | country), </span></span>
<span id="cb55-117"><a href="#cb55-117" aria-hidden="true" tabindex="-1"></a><span class="in">                              data = gapminder)</span></span>
<span id="cb55-118"><a href="#cb55-118" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-119"><a href="#cb55-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-120"><a href="#cb55-120" aria-hidden="true" tabindex="-1"></a>Or more formally,</span>
<span id="cb55-121"><a href="#cb55-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-122"><a href="#cb55-122" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb55-123"><a href="#cb55-123" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb55-124"><a href="#cb55-124" aria-hidden="true" tabindex="-1"></a>\text{lifeExp} &amp;\sim \mathcal{N}(\mu_{i_j}, \sigma_y) &amp; \text{Life expectancy within countries } j <span class="sc">\\</span></span>
<span id="cb55-125"><a href="#cb55-125" aria-hidden="true" tabindex="-1"></a>\mu_{i_j} &amp;= (\beta_0 + b_{0_j}) + \beta_1\, \text{gdpPercap}_{i_j} &amp; \text{Model of within-country variation} <span class="sc">\\</span></span>
<span id="cb55-126"><a href="#cb55-126" aria-hidden="true" tabindex="-1"></a>b_{0_j} &amp;\sim \mathcal{N}(0, \sigma_0) &amp; \text{Random country offsets from global average}</span>
<span id="cb55-127"><a href="#cb55-127" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb55-128"><a href="#cb55-128" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb55-129"><a href="#cb55-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-130"><a href="#cb55-130" aria-hidden="true" tabindex="-1"></a>With this model, we can look at two different types of effects:</span>
<span id="cb55-131"><a href="#cb55-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-132"><a href="#cb55-132" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Conditional effect** = effect of <span class="in">`gdpPercap`</span> ($\beta_1$) in an average or typical country (where the random country offset $b_{0_j}$ is 0)</span>
<span id="cb55-133"><a href="#cb55-133" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Marginal effect** = average effect of <span class="in">`gdpPercap`</span> ($\beta_1$ again) across all countries (where the random country offset $b_{0_j}$ is dealt with… somehow…)</span>
<span id="cb55-134"><a href="#cb55-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-135"><a href="#cb55-135" aria-hidden="true" tabindex="-1"></a>This conditional vs. marginal distinction applies to any sort of hierarchical structure in multilevel models:</span>
<span id="cb55-136"><a href="#cb55-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-137"><a href="#cb55-137" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Conditional effect** = group-specific, subject-specific, cluster-specific, country-specific effect. We set all group-specific random offsets to 0 to find the effect for a *typical* group / subject / student / child / cluster / country / whatever.</span>
<span id="cb55-138"><a href="#cb55-138" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Marginal effect** = global population-level average effect, or global effect, where group-specific differences are averaged out or integrated out or held constant.</span>
<span id="cb55-139"><a href="#cb55-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-140"><a href="#cb55-140" aria-hidden="true" tabindex="-1"></a>Calculating these different effects can be tricky, even with OLS-like normal or Gaussian regression, and interpreting them can get extra complicated with generalized linear mixed models (GLMMs) where we use links like Poisson, negative binomial, logistic, or lognormal families. The math with GLMMs gets *complicated*—particularly with lognormal models. <span class="co">[</span><span class="ot">Kristoffer Magnusson has several incredible blog posts</span><span class="co">](https://rpsychologist.com/GLMM-part1-lognormal)</span> that explore the exact math behind each of these effects in a lognormal GLMM.</span>
<span id="cb55-141"><a href="#cb55-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-142"><a href="#cb55-142" aria-hidden="true" tabindex="-1"></a>Vincent Arel-Bundock's magisterial <span class="co">[</span><span class="ot">{marginaleffects}</span><span class="co">](https://vincentarelbundock.github.io/marginaleffects/)</span> R package can calculate both conditional and marginal effects automatically. I accidentally stumbled across the idea of multilevel marginal and conditional effects <span class="co">[</span><span class="ot">in an earlier blog post</span><span class="co">](https://www.andrewheiss.com/blog/2021/11/10/ame-bayes-re-guide/#overall-summary-of-different-approaches)</span>, but there I did everything with {emmeans} rather than {marginaleffects}, and <span class="co">[</span><span class="ot">as I explore here</span><span class="co">](https://www.andrewheiss.com/blog/2022/05/20/marginalia/)</span>, {marginaleffects} is great for calculating average marginal effects (AMEs) rather than marginal effects at the mean (MEMs). Also in that earlier guide, I don't really use this "conditional" vs. "marginal" distinction and just end up calling everything marginal. So everything here is more in line with the seemingly standard multilevel model ideas of "conditional" and "marginal" effects. </span>
<span id="cb55-143"><a href="#cb55-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-144"><a href="#cb55-144" aria-hidden="true" tabindex="-1"></a>Let's load some libraries, use some neat colors and a nice ggplot theme, and get started.</span>
<span id="cb55-145"><a href="#cb55-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-146"><a href="#cb55-146" aria-hidden="true" tabindex="-1"></a><span class="in">```{r libraries-graphics, warning=FALSE, message=FALSE}</span></span>
<span id="cb55-147"><a href="#cb55-147" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: show</span></span>
<span id="cb55-148"><a href="#cb55-148" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidyverse)</span></span>
<span id="cb55-149"><a href="#cb55-149" aria-hidden="true" tabindex="-1"></a><span class="in">library(brms)</span></span>
<span id="cb55-150"><a href="#cb55-150" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidybayes)</span></span>
<span id="cb55-151"><a href="#cb55-151" aria-hidden="true" tabindex="-1"></a><span class="in">library(marginaleffects)</span></span>
<span id="cb55-152"><a href="#cb55-152" aria-hidden="true" tabindex="-1"></a><span class="in">library(broom.mixed)</span></span>
<span id="cb55-153"><a href="#cb55-153" aria-hidden="true" tabindex="-1"></a><span class="in">library(kableExtra)</span></span>
<span id="cb55-154"><a href="#cb55-154" aria-hidden="true" tabindex="-1"></a><span class="in">library(scales)</span></span>
<span id="cb55-155"><a href="#cb55-155" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggtext)</span></span>
<span id="cb55-156"><a href="#cb55-156" aria-hidden="true" tabindex="-1"></a><span class="in">library(patchwork)</span></span>
<span id="cb55-157"><a href="#cb55-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-158"><a href="#cb55-158" aria-hidden="true" tabindex="-1"></a><span class="in"># Southern Utah colors</span></span>
<span id="cb55-159"><a href="#cb55-159" aria-hidden="true" tabindex="-1"></a><span class="in">clrs &lt;- NatParksPalettes::natparks.pals("BryceCanyon")</span></span>
<span id="cb55-160"><a href="#cb55-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-161"><a href="#cb55-161" aria-hidden="true" tabindex="-1"></a><span class="in"># Custom ggplot themes to make pretty plots</span></span>
<span id="cb55-162"><a href="#cb55-162" aria-hidden="true" tabindex="-1"></a><span class="in"># Get Noto Sans at https://fonts.google.com/specimen/Noto+Sans</span></span>
<span id="cb55-163"><a href="#cb55-163" aria-hidden="true" tabindex="-1"></a><span class="in">theme_nice &lt;- function() {</span></span>
<span id="cb55-164"><a href="#cb55-164" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_bw(base_family = "Noto Sans") +</span></span>
<span id="cb55-165"><a href="#cb55-165" aria-hidden="true" tabindex="-1"></a><span class="in">    theme(panel.grid.minor = element_blank(),</span></span>
<span id="cb55-166"><a href="#cb55-166" aria-hidden="true" tabindex="-1"></a><span class="in">          plot.background = element_rect(fill = "white", color = NA),</span></span>
<span id="cb55-167"><a href="#cb55-167" aria-hidden="true" tabindex="-1"></a><span class="in">          plot.title = element_text(face = "bold"),</span></span>
<span id="cb55-168"><a href="#cb55-168" aria-hidden="true" tabindex="-1"></a><span class="in">          strip.text = element_text(face = "bold"),</span></span>
<span id="cb55-169"><a href="#cb55-169" aria-hidden="true" tabindex="-1"></a><span class="in">          strip.background = element_rect(fill = "grey80", color = NA),</span></span>
<span id="cb55-170"><a href="#cb55-170" aria-hidden="true" tabindex="-1"></a><span class="in">          legend.title = element_text(face = "bold"))</span></span>
<span id="cb55-171"><a href="#cb55-171" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb55-172"><a href="#cb55-172" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-173"><a href="#cb55-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-176"><a href="#cb55-176" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb55-177"><a href="#cb55-177" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb55-178"><a href="#cb55-178" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">read_rds</span>(<span class="st">"df_example_lognormal.rds"</span>)</span>
<span id="cb55-179"><a href="#cb55-179" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">read_rds</span>(<span class="st">"manual_cache/m_example_lognormal.rds"</span>)</span>
<span id="cb55-180"><a href="#cb55-180" aria-hidden="true" tabindex="-1"></a><span class="fu">invisible</span>(<span class="fu">list2env</span>(<span class="fu">read_rds</span>(<span class="st">"manual_cache/mfx_example_lognormal.rds"</span>), .GlobalEnv))</span>
<span id="cb55-181"><a href="#cb55-181" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-182"><a href="#cb55-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-183"><a href="#cb55-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-184"><a href="#cb55-184" aria-hidden="true" tabindex="-1"></a><span class="fu"># Magnusson's data and model: the effect of a treatment on gambling losses</span></span>
<span id="cb55-185"><a href="#cb55-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-186"><a href="#cb55-186" aria-hidden="true" tabindex="-1"></a>To make sure I've translated <span class="co">[</span><span class="ot">Magnusson's math</span><span class="co">](https://rpsychologist.com/GLMM-part1-lognormal)</span> into the corresponding (and correct) {marginaleffects} syntax, I recreate his analysis here. He imagines some sort of intervention or treatment $\text{TX}$ that is designed to reduce the amount of dollars lost in gambling each week ($Y$). The individuals in this situation are grouped into some sort of clusters—perhaps neighborhoods, states, or countries, or even the same individuals over time if we have repeated longitudinal observations. The exact kind of cluster doesn't matter here—all that matters is that observations are nested in groups, and those groups have their own specific characteristics that influence individual-level outcomes. In this simulated data, there are 20 clusters, with 30 individuals in each cluster, with 600 total observations.</span>
<span id="cb55-187"><a href="#cb55-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-188"><a href="#cb55-188" aria-hidden="true" tabindex="-1"></a>To be more formal about the structure, we can say that every outcome $Y$ gets two subscripts for the cluster ($j$) and person inside each cluster ($i_j$). We thus have $Y_{i_j}$ where $i_j \in <span class="sc">\{</span>1, 2, \dots, 30<span class="sc">\}</span>$ and $j \in <span class="sc">\{</span>1, 2, \dots, 20<span class="sc">\}</span>$. The nested, hierarchical, multilevel nature of the data makes the structure look something like this:</span>
<span id="cb55-189"><a href="#cb55-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-190"><a href="#cb55-190" aria-hidden="true" tabindex="-1"></a><span class="in">```{r tikz-settings, include=FALSE}</span></span>
<span id="cb55-191"><a href="#cb55-191" aria-hidden="true" tabindex="-1"></a><span class="in"># tikz stuff</span></span>
<span id="cb55-192"><a href="#cb55-192" aria-hidden="true" tabindex="-1"></a><span class="in"># Necessary for using dvisvgm on macOS</span></span>
<span id="cb55-193"><a href="#cb55-193" aria-hidden="true" tabindex="-1"></a><span class="in"># See https://www.andrewheiss.com/blog/2021/08/27/tikz-knitr-html-svg-fun/</span></span>
<span id="cb55-194"><a href="#cb55-194" aria-hidden="true" tabindex="-1"></a><span class="in">Sys.setenv(LIBGS = "/usr/local/share/ghostscript/9.53.3/lib/libgs.dylib.9.53")</span></span>
<span id="cb55-195"><a href="#cb55-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-196"><a href="#cb55-196" aria-hidden="true" tabindex="-1"></a><span class="in">font_opts &lt;- list(dvisvgm.opts = "--font-format=woff")</span></span>
<span id="cb55-197"><a href="#cb55-197" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-198"><a href="#cb55-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-199"><a href="#cb55-199" aria-hidden="true" tabindex="-1"></a>::: {.column-body-outset}</span>
<span id="cb55-200"><a href="#cb55-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-201"><a href="#cb55-201" aria-hidden="true" tabindex="-1"></a><span class="in">```{tikz, clustered-structure, engine.opts=font_opts}</span></span>
<span id="cb55-202"><a href="#cb55-202" aria-hidden="true" tabindex="-1"></a><span class="in">#| echo: false</span></span>
<span id="cb55-203"><a href="#cb55-203" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: "Individuals grouped into clusters"</span></span>
<span id="cb55-204"><a href="#cb55-204" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-align: center</span></span>
<span id="cb55-205"><a href="#cb55-205" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-ext: svg</span></span>
<span id="cb55-206"><a href="#cb55-206" aria-hidden="true" tabindex="-1"></a><span class="in">#| out-width: 100%</span></span>
<span id="cb55-207"><a href="#cb55-207" aria-hidden="true" tabindex="-1"></a><span class="in">\usetikzlibrary{positioning}</span></span>
<span id="cb55-208"><a href="#cb55-208" aria-hidden="true" tabindex="-1"></a><span class="in">\usetikzlibrary{shapes.geometric}</span></span>
<span id="cb55-209"><a href="#cb55-209" aria-hidden="true" tabindex="-1"></a><span class="in">\begin{tikzpicture}[{every node/.append style}=draw]</span></span>
<span id="cb55-210"><a href="#cb55-210" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [rectangle] (cluster1) at (0, 2.5) {Cluster 1};</span></span>
<span id="cb55-211"><a href="#cb55-211" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [ellipse] (y11) at (-1.5, 1) {$Y_{1_1}$};</span></span>
<span id="cb55-212"><a href="#cb55-212" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [ellipse] (y21) at (0, 1) {$Y_{2_1}$};</span></span>
<span id="cb55-213"><a href="#cb55-213" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [ellipse] (yi1) at (1.5, 1) {$Y_{i_1}$};</span></span>
<span id="cb55-214"><a href="#cb55-214" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (cluster1) to (y11);</span></span>
<span id="cb55-215"><a href="#cb55-215" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (cluster1) to (y21);</span></span>
<span id="cb55-216"><a href="#cb55-216" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (cluster1) to (yi1);</span></span>
<span id="cb55-217"><a href="#cb55-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-218"><a href="#cb55-218" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [rectangle] (cluster2) at (4.5, 2.5) {Cluster 2};</span></span>
<span id="cb55-219"><a href="#cb55-219" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [ellipse] (y12) at (3, 1) {$Y_{1_2}$};</span></span>
<span id="cb55-220"><a href="#cb55-220" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [ellipse] (y22) at (4.5, 1) {$Y_{2_2}$};</span></span>
<span id="cb55-221"><a href="#cb55-221" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [ellipse] (yi2) at (6, 1) {$Y_{i_2}$};</span></span>
<span id="cb55-222"><a href="#cb55-222" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (cluster2) to (y12);</span></span>
<span id="cb55-223"><a href="#cb55-223" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (cluster2) to (y22);</span></span>
<span id="cb55-224"><a href="#cb55-224" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (cluster2) to (yi2);</span></span>
<span id="cb55-225"><a href="#cb55-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-226"><a href="#cb55-226" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [ellipse, draw=white] (dots_top) at (7.25, 2.5) {$\dots$};</span></span>
<span id="cb55-227"><a href="#cb55-227" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [ellipse, draw=white] (dots_bottom) at (7.25, 1) {$\dots$};</span></span>
<span id="cb55-228"><a href="#cb55-228" aria-hidden="true" tabindex="-1"></a><span class="in">    \draw [-latex] (dots_top) to (dots_bottom);</span></span>
<span id="cb55-229"><a href="#cb55-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-230"><a href="#cb55-230" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [rectangle] (clusterj) at (10, 2.5) {Cluster $j$};</span></span>
<span id="cb55-231"><a href="#cb55-231" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [ellipse] (y1j) at (8.5, 1) {$Y_{1_{j}}$};</span></span>
<span id="cb55-232"><a href="#cb55-232" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [ellipse] (y2j) at (10, 1) {$Y_{2_{j}}$};</span></span>
<span id="cb55-233"><a href="#cb55-233" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [ellipse] (yij) at (11.5, 1) {$Y_{i_{j}}$};</span></span>
<span id="cb55-234"><a href="#cb55-234" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (clusterj) to (y1j);</span></span>
<span id="cb55-235"><a href="#cb55-235" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (clusterj) to (y2j);</span></span>
<span id="cb55-236"><a href="#cb55-236" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (clusterj) to (yij);</span></span>
<span id="cb55-237"><a href="#cb55-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-238"><a href="#cb55-238" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [rectangle] (population) at (5, 4) {Population of all individuals};</span></span>
<span id="cb55-239"><a href="#cb55-239" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (population) to (cluster1);</span></span>
<span id="cb55-240"><a href="#cb55-240" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (population) to (cluster2);</span></span>
<span id="cb55-241"><a href="#cb55-241" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (population) to (dots_top);</span></span>
<span id="cb55-242"><a href="#cb55-242" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (population) to (clusterj);</span></span>
<span id="cb55-243"><a href="#cb55-243" aria-hidden="true" tabindex="-1"></a><span class="in">\end{tikzpicture}</span></span>
<span id="cb55-244"><a href="#cb55-244" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-245"><a href="#cb55-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-246"><a href="#cb55-246" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb55-247"><a href="#cb55-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-248"><a href="#cb55-248" aria-hidden="true" tabindex="-1"></a>\ </span>
<span id="cb55-249"><a href="#cb55-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-250"><a href="#cb55-250" aria-hidden="true" tabindex="-1"></a>I've included Magnusson's original code for generating this data here, but you can also <span class="co">[</span><span class="ot">download an `.rds` version of it here</span><span class="co">](df_example_lognormal.rds)</span>, or use the URL directly with <span class="in">`readr::read_rds()`</span>:</span>
<span id="cb55-251"><a href="#cb55-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-252"><a href="#cb55-252" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval=FALSE}</span></span>
<span id="cb55-253"><a href="#cb55-253" aria-hidden="true" tabindex="-1"></a><span class="in">d &lt;- readr::read_rds("https://www.andrewheiss.com/blog/2022/11/29/conditional-marginal-marginaleffects/df_example_lognormal.rds")</span></span>
<span id="cb55-254"><a href="#cb55-254" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-255"><a href="#cb55-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-256"><a href="#cb55-256" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval=FALSE}</span></span>
<span id="cb55-257"><a href="#cb55-257" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb55-258"><a href="#cb55-258" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-summary: "Kristoffer Magnusson's original data generation code"</span></span>
<span id="cb55-259"><a href="#cb55-259" aria-hidden="true" tabindex="-1"></a><span class="in">#' Generate lognormal data with a random intercept</span></span>
<span id="cb55-260"><a href="#cb55-260" aria-hidden="true" tabindex="-1"></a><span class="in">#'</span></span>
<span id="cb55-261"><a href="#cb55-261" aria-hidden="true" tabindex="-1"></a><span class="in">#' @param n1 patients per cluster</span></span>
<span id="cb55-262"><a href="#cb55-262" aria-hidden="true" tabindex="-1"></a><span class="in">#' @param n2 clusters per treatment</span></span>
<span id="cb55-263"><a href="#cb55-263" aria-hidden="true" tabindex="-1"></a><span class="in">#' @param B0 log intercept</span></span>
<span id="cb55-264"><a href="#cb55-264" aria-hidden="true" tabindex="-1"></a><span class="in">#' @param B1 log treatment effect</span></span>
<span id="cb55-265"><a href="#cb55-265" aria-hidden="true" tabindex="-1"></a><span class="in">#' @param sd_log log sd</span></span>
<span id="cb55-266"><a href="#cb55-266" aria-hidden="true" tabindex="-1"></a><span class="in">#' @param u0 SD of log intercepts (random intercept)</span></span>
<span id="cb55-267"><a href="#cb55-267" aria-hidden="true" tabindex="-1"></a><span class="in">#'</span></span>
<span id="cb55-268"><a href="#cb55-268" aria-hidden="true" tabindex="-1"></a><span class="in">#' @return a data.frame</span></span>
<span id="cb55-269"><a href="#cb55-269" aria-hidden="true" tabindex="-1"></a><span class="in">gen_data &lt;- function(n1, n2, B0, B1, sd_log, u0) {</span></span>
<span id="cb55-270"><a href="#cb55-270" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb55-271"><a href="#cb55-271" aria-hidden="true" tabindex="-1"></a><span class="in">  cluster &lt;- rep(1:(2 * n2), each = n1)</span></span>
<span id="cb55-272"><a href="#cb55-272" aria-hidden="true" tabindex="-1"></a><span class="in">  TX &lt;- rep(c(0, 1), each = n1 * n2)</span></span>
<span id="cb55-273"><a href="#cb55-273" aria-hidden="true" tabindex="-1"></a><span class="in">  u0 &lt;- rnorm(2 * n2, sd = u0)[cluster]</span></span>
<span id="cb55-274"><a href="#cb55-274" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb55-275"><a href="#cb55-275" aria-hidden="true" tabindex="-1"></a><span class="in">  mulog &lt;- (B0 + B1 * TX + u0)</span></span>
<span id="cb55-276"><a href="#cb55-276" aria-hidden="true" tabindex="-1"></a><span class="in">  y &lt;- rlnorm(2 * n1 * n2, meanlog = mulog, sdlog = sd_log)</span></span>
<span id="cb55-277"><a href="#cb55-277" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb55-278"><a href="#cb55-278" aria-hidden="true" tabindex="-1"></a><span class="in">  d &lt;- data.frame(cluster,</span></span>
<span id="cb55-279"><a href="#cb55-279" aria-hidden="true" tabindex="-1"></a><span class="in">                  TX,</span></span>
<span id="cb55-280"><a href="#cb55-280" aria-hidden="true" tabindex="-1"></a><span class="in">                  y)</span></span>
<span id="cb55-281"><a href="#cb55-281" aria-hidden="true" tabindex="-1"></a><span class="in">  d</span></span>
<span id="cb55-282"><a href="#cb55-282" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb55-283"><a href="#cb55-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-284"><a href="#cb55-284" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(4445)</span></span>
<span id="cb55-285"><a href="#cb55-285" aria-hidden="true" tabindex="-1"></a><span class="in">pars &lt;- list("n1" = 30, # observations per cluster</span></span>
<span id="cb55-286"><a href="#cb55-286" aria-hidden="true" tabindex="-1"></a><span class="in">             "n2" = 10, # clusters per treatment</span></span>
<span id="cb55-287"><a href="#cb55-287" aria-hidden="true" tabindex="-1"></a><span class="in">             "B0" = log(500),</span></span>
<span id="cb55-288"><a href="#cb55-288" aria-hidden="true" tabindex="-1"></a><span class="in">             "B1" = log(0.5),</span></span>
<span id="cb55-289"><a href="#cb55-289" aria-hidden="true" tabindex="-1"></a><span class="in">             "sd_log" = 0.5,</span></span>
<span id="cb55-290"><a href="#cb55-290" aria-hidden="true" tabindex="-1"></a><span class="in">             "u0" = 0.5)</span></span>
<span id="cb55-291"><a href="#cb55-291" aria-hidden="true" tabindex="-1"></a><span class="in">d &lt;- do.call(gen_data,</span></span>
<span id="cb55-292"><a href="#cb55-292" aria-hidden="true" tabindex="-1"></a><span class="in">             pars)</span></span>
<span id="cb55-293"><a href="#cb55-293" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-294"><a href="#cb55-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-295"><a href="#cb55-295" aria-hidden="true" tabindex="-1"></a>The model of the effect of $\text{TX}$ on gambling losses for individuals nested in clusters can be written formally like this, with cluster $j$-specific offsets to the $\beta_0$ intercept term (i.e. $b_{0_j}$, or cluster random effects):</span>
<span id="cb55-296"><a href="#cb55-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-297"><a href="#cb55-297" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb55-298"><a href="#cb55-298" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb55-299"><a href="#cb55-299" aria-hidden="true" tabindex="-1"></a>\log (Y_{i_j}) &amp;\sim \mathcal{N}(\mu_{i_j}, \sigma_y) &amp; \text{Gambling losses for individual $i$ within cluster } j <span class="sc">\\</span></span>
<span id="cb55-300"><a href="#cb55-300" aria-hidden="true" tabindex="-1"></a>\mu_{i_j} &amp;= (\beta_0 + b_{0_j}) + \beta_1\, \text{TX}_{i_j} &amp; \text{Model of within-cluster variation} <span class="sc">\\</span></span>
<span id="cb55-301"><a href="#cb55-301" aria-hidden="true" tabindex="-1"></a>b_{0_j} &amp;\sim \mathcal{N}(0, \sigma_0) &amp; \text{Random cluster offsets from global average}</span>
<span id="cb55-302"><a href="#cb55-302" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb55-303"><a href="#cb55-303" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb55-304"><a href="#cb55-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-305"><a href="#cb55-305" aria-hidden="true" tabindex="-1"></a>We can fit this model with {brms} (or <span class="in">`lme4::lmer()`</span> if you don't want to be Bayesian):</span>
<span id="cb55-306"><a href="#cb55-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-307"><a href="#cb55-307" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval=FALSE}</span></span>
<span id="cb55-308"><a href="#cb55-308" aria-hidden="true" tabindex="-1"></a><span class="in">fit &lt;- brm(</span></span>
<span id="cb55-309"><a href="#cb55-309" aria-hidden="true" tabindex="-1"></a><span class="in">  bf(y ~ 1 + TX + (1 | cluster)), </span></span>
<span id="cb55-310"><a href="#cb55-310" aria-hidden="true" tabindex="-1"></a><span class="in">  family = lognormal(), </span></span>
<span id="cb55-311"><a href="#cb55-311" aria-hidden="true" tabindex="-1"></a><span class="in">  data = d,</span></span>
<span id="cb55-312"><a href="#cb55-312" aria-hidden="true" tabindex="-1"></a><span class="in">  chains = 4, iter = 5000, warmup = 1000, seed = 4445</span></span>
<span id="cb55-313"><a href="#cb55-313" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb55-314"><a href="#cb55-314" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-315"><a href="#cb55-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-318"><a href="#cb55-318" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb55-319"><a href="#cb55-319" aria-hidden="true" tabindex="-1"></a>fit</span>
<span id="cb55-320"><a href="#cb55-320" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-321"><a href="#cb55-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-322"><a href="#cb55-322" aria-hidden="true" tabindex="-1"></a>There are four parameters that we care about in that huge wall of text. We'll pull them out as standalone objects (using <span class="co">[</span><span class="ot">TJ Mahr's neat model-to-list trick</span><span class="co">](https://www.tjmahr.com/lists-knitr-secret-weapon/)</span>) and show them in a table so we can keep track of everything easier.</span>
<span id="cb55-323"><a href="#cb55-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-326"><a href="#cb55-326" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb55-327"><a href="#cb55-327" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: show</span></span>
<span id="cb55-328"><a href="#cb55-328" aria-hidden="true" tabindex="-1"></a>r_fit <span class="ot">&lt;-</span> fit <span class="sc">%&gt;%</span> </span>
<span id="cb55-329"><a href="#cb55-329" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tidy</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb55-330"><a href="#cb55-330" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">term =</span> janitor<span class="sc">::</span><span class="fu">make_clean_names</span>(term)) <span class="sc">%&gt;%</span> </span>
<span id="cb55-331"><a href="#cb55-331" aria-hidden="true" tabindex="-1"></a>  <span class="fu">split</span>(<span class="sc">~</span>term)</span>
<span id="cb55-332"><a href="#cb55-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-333"><a href="#cb55-333" aria-hidden="true" tabindex="-1"></a>B0 <span class="ot">&lt;-</span> r_fit<span class="sc">$</span>intercept<span class="sc">$</span>estimate</span>
<span id="cb55-334"><a href="#cb55-334" aria-hidden="true" tabindex="-1"></a>B1 <span class="ot">&lt;-</span> r_fit<span class="sc">$</span>tx<span class="sc">$</span>estimate</span>
<span id="cb55-335"><a href="#cb55-335" aria-hidden="true" tabindex="-1"></a>sigma_y <span class="ot">&lt;-</span> r_fit<span class="sc">$</span>sd_observation<span class="sc">$</span>estimate</span>
<span id="cb55-336"><a href="#cb55-336" aria-hidden="true" tabindex="-1"></a>sigma_0 <span class="ot">&lt;-</span> r_fit<span class="sc">$</span>sd_intercept<span class="sc">$</span>estimate</span>
<span id="cb55-337"><a href="#cb55-337" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-338"><a href="#cb55-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-341"><a href="#cb55-341" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb55-342"><a href="#cb55-342" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb55-343"><a href="#cb55-343" aria-hidden="true" tabindex="-1"></a>fit <span class="sc">%&gt;%</span> </span>
<span id="cb55-344"><a href="#cb55-344" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tidy</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb55-345"><a href="#cb55-345" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Parameter =</span> <span class="fu">c</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">(</span><span class="sc">\\</span><span class="st">beta_0</span><span class="sc">\\</span><span class="st">)"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">(</span><span class="sc">\\</span><span class="st">beta_1</span><span class="sc">\\</span><span class="st">)"</span>, </span>
<span id="cb55-346"><a href="#cb55-346" aria-hidden="true" tabindex="-1"></a>                       <span class="st">"</span><span class="sc">\\</span><span class="st">(</span><span class="sc">\\</span><span class="st">sigma_0</span><span class="sc">\\</span><span class="st">)"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">(</span><span class="sc">\\</span><span class="st">sigma_y</span><span class="sc">\\</span><span class="st">)"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb55-347"><a href="#cb55-347" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Description =</span> <span class="fu">c</span>(<span class="st">"Global average gambling losses across all individuals"</span>,</span>
<span id="cb55-348"><a href="#cb55-348" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"Effect of treatment on gambling losses for all individuals"</span>,</span>
<span id="cb55-349"><a href="#cb55-349" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"Between-cluster variability of average gambling losses"</span>,</span>
<span id="cb55-350"><a href="#cb55-350" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"Within-cluster variability of gambling losses"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb55-351"><a href="#cb55-351" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">term =</span> glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"&lt;code&gt;{term}&lt;/code&gt;"</span>),</span>
<span id="cb55-352"><a href="#cb55-352" aria-hidden="true" tabindex="-1"></a>         <span class="at">estimate =</span> <span class="fu">round</span>(estimate, <span class="dv">3</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb55-353"><a href="#cb55-353" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Parameter, <span class="at">Term =</span> term, Description, <span class="at">Estimate =</span> estimate) <span class="sc">%&gt;%</span> </span>
<span id="cb55-354"><a href="#cb55-354" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">escape =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb55-355"><a href="#cb55-355" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb55-356"><a href="#cb55-356" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-357"><a href="#cb55-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-358"><a href="#cb55-358" aria-hidden="true" tabindex="-1"></a>There are a few problems with these estimates though: (1) they're on the log odds scale, which isn't very interpretable, and (2) neither the intercept term nor the $\text{TX}$ term incorporate any details about the cluster-level effects beyond <span class="co">[</span><span class="ot">the extra information we get through partial pooling</span><span class="co">](https://bayesf22-notebook.classes.andrewheiss.com/bayes-rules/16-chapter.html#shrinkage-and-the-bias-variance-tradeoff)</span>. So our goal here is to **transform these estimates into something interpretable that also incorporates group-level information**.</span>
<span id="cb55-359"><a href="#cb55-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-360"><a href="#cb55-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-361"><a href="#cb55-361" aria-hidden="true" tabindex="-1"></a><span class="fu"># Conditional effects, or effect of a variable in an average cluster</span></span>
<span id="cb55-362"><a href="#cb55-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-363"><a href="#cb55-363" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb55-364"><a href="#cb55-364" aria-hidden="true" tabindex="-1"></a><span class="fu">## Conditional effects</span></span>
<span id="cb55-365"><a href="#cb55-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-366"><a href="#cb55-366" aria-hidden="true" tabindex="-1"></a>Conditional effects = average or typical cluster; random offsets $b_{0_j}$ set to 0</span>
<span id="cb55-367"><a href="#cb55-367" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb55-368"><a href="#cb55-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-369"><a href="#cb55-369" aria-hidden="true" tabindex="-1"></a>**Conditional effects** refer to the effect of a variable in a  *typical* group—country, cluster, school, subject, or whatever else is in the <span class="in">`(1 | group)`</span> term in the model. "Typical" here means that the random offset $b_{0_j}$ is set to zero, or that there are no random effects involved.</span>
<span id="cb55-370"><a href="#cb55-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-371"><a href="#cb55-371" aria-hidden="true" tabindex="-1"></a><span class="fu">## Average outcomes for a typical cluster</span></span>
<span id="cb55-372"><a href="#cb55-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-373"><a href="#cb55-373" aria-hidden="true" tabindex="-1"></a>The average outcome $Y_{i_j}$ across the possible values of $\text{TX}$ for a typical cluster is formally defined as</span>
<span id="cb55-374"><a href="#cb55-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-375"><a href="#cb55-375" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb55-376"><a href="#cb55-376" aria-hidden="true" tabindex="-1"></a>\textbf{E}(Y_{i_j} \mid b_{0_j} = 0, \text{TX} = <span class="sc">\{</span>0, 1<span class="sc">\}</span>)</span>
<span id="cb55-377"><a href="#cb55-377" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb55-378"><a href="#cb55-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-379"><a href="#cb55-379" aria-hidden="true" tabindex="-1"></a>Exactly how you calculate this mathematically depends on the distribution family. For a lognormal distribution, it is this:</span>
<span id="cb55-380"><a href="#cb55-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-381"><a href="#cb55-381" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb55-382"><a href="#cb55-382" aria-hidden="true" tabindex="-1"></a>\textbf{E}(Y_{i_j} \mid b_{0_j} = 0, \text{TX} = <span class="sc">\{</span>0, 1<span class="sc">\}</span>) = </span>
<span id="cb55-383"><a href="#cb55-383" aria-hidden="true" tabindex="-1"></a>\exp \left((\beta_0 + b_{0_j}) + \beta_1 \text{TX}_i + \frac{\sigma_y^2}{2}\right)</span>
<span id="cb55-384"><a href="#cb55-384" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb55-385"><a href="#cb55-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-388"><a href="#cb55-388" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb55-389"><a href="#cb55-389" aria-hidden="true" tabindex="-1"></a>TXs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"0"</span> <span class="ot">=</span> <span class="dv">0</span>, <span class="st">"1"</span> <span class="ot">=</span> <span class="dv">1</span>)</span>
<span id="cb55-390"><a href="#cb55-390" aria-hidden="true" tabindex="-1"></a>b0j <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb55-391"><a href="#cb55-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-392"><a href="#cb55-392" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>((B0 <span class="sc">+</span> b0j) <span class="sc">+</span> (B1 <span class="sc">*</span> TXs) <span class="sc">+</span> (sigma_y<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>))</span>
<span id="cb55-393"><a href="#cb55-393" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-394"><a href="#cb55-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-395"><a href="#cb55-395" aria-hidden="true" tabindex="-1"></a>We can calculate this automatically with <span class="in">`marginaleffects::predictions()`</span> by setting <span class="in">`re_formula = NA`</span> to ignore all random effects, or to set all the random $b_{0_j}$ offsets to zero:</span>
<span id="cb55-396"><a href="#cb55-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-397"><a href="#cb55-397" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval=FALSE}</span></span>
<span id="cb55-398"><a href="#cb55-398" aria-hidden="true" tabindex="-1"></a><span class="in">predictions(</span></span>
<span id="cb55-399"><a href="#cb55-399" aria-hidden="true" tabindex="-1"></a><span class="in">  fit, </span></span>
<span id="cb55-400"><a href="#cb55-400" aria-hidden="true" tabindex="-1"></a><span class="in">  newdata = datagrid(TX = c(0, 1)), </span></span>
<span id="cb55-401"><a href="#cb55-401" aria-hidden="true" tabindex="-1"></a><span class="in">  by = "TX", </span></span>
<span id="cb55-402"><a href="#cb55-402" aria-hidden="true" tabindex="-1"></a><span class="in">  re_formula = NA</span></span>
<span id="cb55-403"><a href="#cb55-403" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb55-404"><a href="#cb55-404" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-405"><a href="#cb55-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-408"><a href="#cb55-408" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb55-409"><a href="#cb55-409" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb55-410"><a href="#cb55-410" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: false</span></span>
<span id="cb55-411"><a href="#cb55-411" aria-hidden="true" tabindex="-1"></a><span class="co">#| comment: "##"</span></span>
<span id="cb55-412"><a href="#cb55-412" aria-hidden="true" tabindex="-1"></a><span class="co">#| class-output: "r sourceCode"</span></span>
<span id="cb55-413"><a href="#cb55-413" aria-hidden="true" tabindex="-1"></a>conditional_preds <span class="sc">%&gt;%</span> </span>
<span id="cb55-414"><a href="#cb55-414" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(TX) <span class="sc">%&gt;%</span> </span>
<span id="cb55-415"><a href="#cb55-415" aria-hidden="true" tabindex="-1"></a>  <span class="fu">median_qi</span>(draw) <span class="sc">%&gt;%</span> </span>
<span id="cb55-416"><a href="#cb55-416" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">type =</span> <span class="st">"response"</span>,</span>
<span id="cb55-417"><a href="#cb55-417" aria-hidden="true" tabindex="-1"></a>         <span class="at">rowid =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb55-418"><a href="#cb55-418" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(rowid, type, TX, <span class="at">predicted =</span> draw, <span class="at">conf.low =</span> .lower, <span class="at">conf.high =</span> .upper)</span>
<span id="cb55-419"><a href="#cb55-419" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-420"><a href="#cb55-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-421"><a href="#cb55-421" aria-hidden="true" tabindex="-1"></a>Because we're working with Bayesian posteriors, we might as well do neat stuff with them instead of just collapsing them down to single-number point estimates. The <span class="in">`posteriordraws()`</span> function in {marginaleffects} lets us extract the modified/calculated MCMC draws, and then we can plot them with {tidybayes} / {ggdist}:</span>
<span id="cb55-422"><a href="#cb55-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-423"><a href="#cb55-423" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval=FALSE}</span></span>
<span id="cb55-424"><a href="#cb55-424" aria-hidden="true" tabindex="-1"></a><span class="in">conditional_preds &lt;- predictions(</span></span>
<span id="cb55-425"><a href="#cb55-425" aria-hidden="true" tabindex="-1"></a><span class="in">  fit, </span></span>
<span id="cb55-426"><a href="#cb55-426" aria-hidden="true" tabindex="-1"></a><span class="in">  newdata = datagrid(TX = c(0, 1)), </span></span>
<span id="cb55-427"><a href="#cb55-427" aria-hidden="true" tabindex="-1"></a><span class="in">  by = "TX", </span></span>
<span id="cb55-428"><a href="#cb55-428" aria-hidden="true" tabindex="-1"></a><span class="in">  re_formula = NA</span></span>
<span id="cb55-429"><a href="#cb55-429" aria-hidden="true" tabindex="-1"></a><span class="in">) %&gt;% </span></span>
<span id="cb55-430"><a href="#cb55-430" aria-hidden="true" tabindex="-1"></a><span class="in">  posteriordraws()</span></span>
<span id="cb55-431"><a href="#cb55-431" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-432"><a href="#cb55-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-433"><a href="#cb55-433" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-conditional-preds, fig.width=5.5, fig.height=3.75}</span></span>
<span id="cb55-434"><a href="#cb55-434" aria-hidden="true" tabindex="-1"></a><span class="in">#| warning: false</span></span>
<span id="cb55-435"><a href="#cb55-435" aria-hidden="true" tabindex="-1"></a><span class="in">p_conditional_preds &lt;- conditional_preds %&gt;% </span></span>
<span id="cb55-436"><a href="#cb55-436" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = draw, fill = factor(TX))) +</span></span>
<span id="cb55-437"><a href="#cb55-437" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye() +</span></span>
<span id="cb55-438"><a href="#cb55-438" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_manual(values = c(clrs[5], clrs[1])) +</span></span>
<span id="cb55-439"><a href="#cb55-439" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_dollar()) +</span></span>
<span id="cb55-440"><a href="#cb55-440" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Gambling losses", y = "Density", fill = "TX",</span></span>
<span id="cb55-441"><a href="#cb55-441" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "Conditional cluster-specific means",</span></span>
<span id="cb55-442"><a href="#cb55-442" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "Typical cluster where *b*&lt;sub&gt;0&lt;sub&gt;j&lt;/sub&gt;&lt;/sub&gt; = 0") +</span></span>
<span id="cb55-443"><a href="#cb55-443" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(xlim = c(100, 1000)) +</span></span>
<span id="cb55-444"><a href="#cb55-444" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice() +</span></span>
<span id="cb55-445"><a href="#cb55-445" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(plot.subtitle = element_markdown())</span></span>
<span id="cb55-446"><a href="#cb55-446" aria-hidden="true" tabindex="-1"></a><span class="in">p_conditional_preds</span></span>
<span id="cb55-447"><a href="#cb55-447" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-448"><a href="#cb55-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-449"><a href="#cb55-449" aria-hidden="true" tabindex="-1"></a>Neat.</span>
<span id="cb55-450"><a href="#cb55-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-451"><a href="#cb55-451" aria-hidden="true" tabindex="-1"></a><span class="fu">## ATE for a typical cluster</span></span>
<span id="cb55-452"><a href="#cb55-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-453"><a href="#cb55-453" aria-hidden="true" tabindex="-1"></a>The average treatment effect (ATE) for a binary treatment is the difference between the two averages when $\text{TX} = 1$ and $\text{TX} = 0$:</span>
<span id="cb55-454"><a href="#cb55-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-455"><a href="#cb55-455" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb55-456"><a href="#cb55-456" aria-hidden="true" tabindex="-1"></a>\textbf{E}(Y_{i_j} \mid b_{0_j} = 0, \text{TX} = 1) - \textbf{E}(Y_{i_j} \mid b_{0_j} = 0, \text{TX} = 0)</span>
<span id="cb55-457"><a href="#cb55-457" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb55-458"><a href="#cb55-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-459"><a href="#cb55-459" aria-hidden="true" tabindex="-1"></a>For a lognormal family, it's this:</span>
<span id="cb55-460"><a href="#cb55-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-461"><a href="#cb55-461" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb55-462"><a href="#cb55-462" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb55-463"><a href="#cb55-463" aria-hidden="true" tabindex="-1"></a>&amp;\textbf{E}(Y_{i_j} \mid b_{0_j} = 0, \text{TX} = 1) - \textbf{E}(Y_{i_j} \mid b_{0_j} = 0, \text{TX} = 0) = <span class="sc">\\</span></span>
<span id="cb55-464"><a href="#cb55-464" aria-hidden="true" tabindex="-1"></a>&amp;\qquad \exp \left((\beta_0 + b_{0_j}) + \beta_1 + \frac{\sigma_y^2}{2}\right) - \exp \left((\beta_0 + b_{0_j}) + \frac{\sigma_y^2}{2}\right)</span>
<span id="cb55-465"><a href="#cb55-465" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb55-466"><a href="#cb55-466" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb55-467"><a href="#cb55-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-470"><a href="#cb55-470" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb55-471"><a href="#cb55-471" aria-hidden="true" tabindex="-1"></a>TXs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"0"</span> <span class="ot">=</span> <span class="dv">0</span>, <span class="st">"1"</span> <span class="ot">=</span> <span class="dv">1</span>)</span>
<span id="cb55-472"><a href="#cb55-472" aria-hidden="true" tabindex="-1"></a>b0j <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb55-473"><a href="#cb55-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-474"><a href="#cb55-474" aria-hidden="true" tabindex="-1"></a>(<span class="fu">exp</span>((B0 <span class="sc">+</span> b0j) <span class="sc">+</span> (B1 <span class="sc">*</span> TXs[<span class="dv">2</span>]) <span class="sc">+</span> (sigma_y<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>)) <span class="sc">-</span> </span>
<span id="cb55-475"><a href="#cb55-475" aria-hidden="true" tabindex="-1"></a>    <span class="fu">exp</span>((B0 <span class="sc">+</span> b0j) <span class="sc">+</span> (B1 <span class="sc">*</span> TXs[<span class="dv">1</span>]) <span class="sc">+</span> (sigma_y<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb55-476"><a href="#cb55-476" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unname</span>()</span>
<span id="cb55-477"><a href="#cb55-477" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-478"><a href="#cb55-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-479"><a href="#cb55-479" aria-hidden="true" tabindex="-1"></a>We can again calculate this by setting <span class="in">`re_formula = NA`</span> in <span class="in">`marginaleffects::comparisons()`</span>:</span>
<span id="cb55-480"><a href="#cb55-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-481"><a href="#cb55-481" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval=FALSE}</span></span>
<span id="cb55-482"><a href="#cb55-482" aria-hidden="true" tabindex="-1"></a><span class="in"># Cluster-specific average treatment effect (when offset is 0)</span></span>
<span id="cb55-483"><a href="#cb55-483" aria-hidden="true" tabindex="-1"></a><span class="in">comparisons(</span></span>
<span id="cb55-484"><a href="#cb55-484" aria-hidden="true" tabindex="-1"></a><span class="in">  fit, </span></span>
<span id="cb55-485"><a href="#cb55-485" aria-hidden="true" tabindex="-1"></a><span class="in">  variables = "TX",</span></span>
<span id="cb55-486"><a href="#cb55-486" aria-hidden="true" tabindex="-1"></a><span class="in">  re_formula = NA</span></span>
<span id="cb55-487"><a href="#cb55-487" aria-hidden="true" tabindex="-1"></a><span class="in">) %&gt;% </span></span>
<span id="cb55-488"><a href="#cb55-488" aria-hidden="true" tabindex="-1"></a><span class="in">  tidy()</span></span>
<span id="cb55-489"><a href="#cb55-489" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-490"><a href="#cb55-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-493"><a href="#cb55-493" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb55-494"><a href="#cb55-494" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb55-495"><a href="#cb55-495" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb55-496"><a href="#cb55-496" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: false</span></span>
<span id="cb55-497"><a href="#cb55-497" aria-hidden="true" tabindex="-1"></a><span class="co">#| comment: "##"</span></span>
<span id="cb55-498"><a href="#cb55-498" aria-hidden="true" tabindex="-1"></a><span class="co">#| class-output: "r sourceCode"</span></span>
<span id="cb55-499"><a href="#cb55-499" aria-hidden="true" tabindex="-1"></a>conditional_ate <span class="sc">%&gt;%</span> </span>
<span id="cb55-500"><a href="#cb55-500" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(rowid <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb55-501"><a href="#cb55-501" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(term, contrast) <span class="sc">%&gt;%</span> </span>
<span id="cb55-502"><a href="#cb55-502" aria-hidden="true" tabindex="-1"></a>  <span class="fu">median_qi</span>(draw) <span class="sc">%&gt;%</span> </span>
<span id="cb55-503"><a href="#cb55-503" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">type =</span> <span class="st">"response"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb55-504"><a href="#cb55-504" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(type, term, contrast, <span class="at">estimate =</span> draw, <span class="at">conf.low =</span> .lower, <span class="at">conf.high =</span> .upper)</span>
<span id="cb55-505"><a href="#cb55-505" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-506"><a href="#cb55-506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-507"><a href="#cb55-507" aria-hidden="true" tabindex="-1"></a>And here's what the posterior of that conditional ATE looks like:</span>
<span id="cb55-508"><a href="#cb55-508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-509"><a href="#cb55-509" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval=FALSE}</span></span>
<span id="cb55-510"><a href="#cb55-510" aria-hidden="true" tabindex="-1"></a><span class="in">conditional_ate &lt;- comparisons(</span></span>
<span id="cb55-511"><a href="#cb55-511" aria-hidden="true" tabindex="-1"></a><span class="in">  fit, </span></span>
<span id="cb55-512"><a href="#cb55-512" aria-hidden="true" tabindex="-1"></a><span class="in">  variables = "TX",</span></span>
<span id="cb55-513"><a href="#cb55-513" aria-hidden="true" tabindex="-1"></a><span class="in">  re_formula = NA</span></span>
<span id="cb55-514"><a href="#cb55-514" aria-hidden="true" tabindex="-1"></a><span class="in">) %&gt;% </span></span>
<span id="cb55-515"><a href="#cb55-515" aria-hidden="true" tabindex="-1"></a><span class="in">  posteriordraws()</span></span>
<span id="cb55-516"><a href="#cb55-516" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-517"><a href="#cb55-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-518"><a href="#cb55-518" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-conditional-ate, fig.width=5.5, fig.height=3.75}</span></span>
<span id="cb55-519"><a href="#cb55-519" aria-hidden="true" tabindex="-1"></a><span class="in">p_conditional_ate &lt;- conditional_ate %&gt;% </span></span>
<span id="cb55-520"><a href="#cb55-520" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = draw)) +</span></span>
<span id="cb55-521"><a href="#cb55-521" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye(fill = clrs[3]) +</span></span>
<span id="cb55-522"><a href="#cb55-522" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_dollar(style_negative = "minus")) +</span></span>
<span id="cb55-523"><a href="#cb55-523" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "(TX = 1) − (TX = 0)", y = "Density", </span></span>
<span id="cb55-524"><a href="#cb55-524" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "Conditional cluster-specific ATE",</span></span>
<span id="cb55-525"><a href="#cb55-525" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "Typical cluster where *b*&lt;sub&gt;0&lt;sub&gt;j&lt;/sub&gt;&lt;/sub&gt; = 0") +</span></span>
<span id="cb55-526"><a href="#cb55-526" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(xlim = c(-900, 300)) +</span></span>
<span id="cb55-527"><a href="#cb55-527" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice() +</span></span>
<span id="cb55-528"><a href="#cb55-528" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(plot.subtitle = element_markdown())</span></span>
<span id="cb55-529"><a href="#cb55-529" aria-hidden="true" tabindex="-1"></a><span class="in">p_conditional_ate</span></span>
<span id="cb55-530"><a href="#cb55-530" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-531"><a href="#cb55-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-532"><a href="#cb55-532" aria-hidden="true" tabindex="-1"></a><span class="fu"># Marginal effects, or effect of a variable across clusters on average</span></span>
<span id="cb55-533"><a href="#cb55-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-534"><a href="#cb55-534" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb55-535"><a href="#cb55-535" aria-hidden="true" tabindex="-1"></a><span class="fu">## Marginal effects</span></span>
<span id="cb55-536"><a href="#cb55-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-537"><a href="#cb55-537" aria-hidden="true" tabindex="-1"></a>Marginal effects = global/population-level effect; clusters on average; random offsets $b_{0_j}$ are incorporated into the estimate</span>
<span id="cb55-538"><a href="#cb55-538" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb55-539"><a href="#cb55-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-540"><a href="#cb55-540" aria-hidden="true" tabindex="-1"></a>**Marginal effects** refer to the global- or population-level effect of a variable. In multilevel models, coefficients can have random group-specific offsets to a global mean. That's what the $b_{0_j}$ in $(\beta_0 + b_{0_j})$ is in the formal model we defined earlier:</span>
<span id="cb55-541"><a href="#cb55-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-542"><a href="#cb55-542" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb55-543"><a href="#cb55-543" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb55-544"><a href="#cb55-544" aria-hidden="true" tabindex="-1"></a>\mu_{i_j} &amp;= (\beta_0 + b_{0_j}) + \beta_1\, \text{TX}_i &amp; \text{Model of within-cluster variation} <span class="sc">\\</span></span>
<span id="cb55-545"><a href="#cb55-545" aria-hidden="true" tabindex="-1"></a>b_{0_j} &amp;\sim \mathcal{N}(0, \sigma_0) &amp; \text{Random cluster offsets}</span>
<span id="cb55-546"><a href="#cb55-546" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb55-547"><a href="#cb55-547" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb55-548"><a href="#cb55-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-549"><a href="#cb55-549" aria-hidden="true" tabindex="-1"></a>By definition, these offsets are distributed normally with a mean of 0 and a standard deviation of $\sigma_0$, or <span class="in">`sd__(Intercept)`</span> in {brms} output. We can visualize these cluster-specific offsets to get a better feel for how they work:</span>
<span id="cb55-550"><a href="#cb55-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-551"><a href="#cb55-551" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-offsets, fig.width=5.5, fig.height=4.25}</span></span>
<span id="cb55-552"><a href="#cb55-552" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb55-553"><a href="#cb55-553" aria-hidden="true" tabindex="-1"></a><span class="in">fit %&gt;% </span></span>
<span id="cb55-554"><a href="#cb55-554" aria-hidden="true" tabindex="-1"></a><span class="in">  linpred_draws(tibble(cluster = unique(d$cluster),</span></span>
<span id="cb55-555"><a href="#cb55-555" aria-hidden="true" tabindex="-1"></a><span class="in">                       TX = 0)) %&gt;% </span></span>
<span id="cb55-556"><a href="#cb55-556" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(offset = B0 - .linpred) %&gt;% </span></span>
<span id="cb55-557"><a href="#cb55-557" aria-hidden="true" tabindex="-1"></a><span class="in">  ungroup() %&gt;% </span></span>
<span id="cb55-558"><a href="#cb55-558" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(cluster = fct_reorder(factor(cluster), offset, .fun = mean)) %&gt;% </span></span>
<span id="cb55-559"><a href="#cb55-559" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = offset, y = cluster)) +</span></span>
<span id="cb55-560"><a href="#cb55-560" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0, color = clrs[2]) +</span></span>
<span id="cb55-561"><a href="#cb55-561" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_pointinterval(color = clrs[4]) +</span></span>
<span id="cb55-562"><a href="#cb55-562" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "*b*&lt;sub&gt;0&lt;/sub&gt; offset from β&lt;sub&gt;0&lt;/sub&gt;") +</span></span>
<span id="cb55-563"><a href="#cb55-563" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice() +</span></span>
<span id="cb55-564"><a href="#cb55-564" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(axis.title.x = element_markdown())</span></span>
<span id="cb55-565"><a href="#cb55-565" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-566"><a href="#cb55-566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-567"><a href="#cb55-567" aria-hidden="true" tabindex="-1"></a>The intercept for Cluster 1 here is basically the same as the global $\beta_0$ coefficient; Cluster 19 has a big positive offset, while Cluster 11 has a big negative offset.</span>
<span id="cb55-568"><a href="#cb55-568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-569"><a href="#cb55-569" aria-hidden="true" tabindex="-1"></a>The model parameters show the whole range of possible cluster-specific intercepts, or $\beta_0 \pm \sigma_0$:</span>
<span id="cb55-570"><a href="#cb55-570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-571"><a href="#cb55-571" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-offset-distribution, fig.width=5.5, fig.height=3.75}</span></span>
<span id="cb55-572"><a href="#cb55-572" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot() +</span></span>
<span id="cb55-573"><a href="#cb55-573" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_function(fun = ~dnorm(., mean = B0, sd = sigma_0^2),</span></span>
<span id="cb55-574"><a href="#cb55-574" aria-hidden="true" tabindex="-1"></a><span class="in">                geom = "area", fill = clrs[4]) +</span></span>
<span id="cb55-575"><a href="#cb55-575" aria-hidden="true" tabindex="-1"></a><span class="in">  xlim(4, 8) +</span></span>
<span id="cb55-576"><a href="#cb55-576" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Possible cluster-specific intercepts", y = "Density",</span></span>
<span id="cb55-577"><a href="#cb55-577" aria-hidden="true" tabindex="-1"></a><span class="in">       title = glue::glue("Normal(µ = {round(B0, 3)}, σ = {round(sigma_0, 3)}&lt;sup&gt;2&lt;/sup&gt;)")) +</span></span>
<span id="cb55-578"><a href="#cb55-578" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice() +</span></span>
<span id="cb55-579"><a href="#cb55-579" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(plot.title = element_markdown())</span></span>
<span id="cb55-580"><a href="#cb55-580" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-581"><a href="#cb55-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-582"><a href="#cb55-582" aria-hidden="true" tabindex="-1"></a>When generating population-level estimates, then, we need to somehow incorporate this range of possible cluster-specific intercepts into the population-level predictions. We can do this a couple different ways: we can (1) average, marginalize or integrate across them, or (2) integrate them out.</span>
<span id="cb55-583"><a href="#cb55-583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-584"><a href="#cb55-584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-585"><a href="#cb55-585" aria-hidden="true" tabindex="-1"></a><span class="fu">## Average population-level outcomes</span></span>
<span id="cb55-586"><a href="#cb55-586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-587"><a href="#cb55-587" aria-hidden="true" tabindex="-1"></a>The average outcome $Y_{i_j}$ across the possible values of $\text{TX}$ for all clusters together is formally defined as</span>
<span id="cb55-588"><a href="#cb55-588" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-589"><a href="#cb55-589" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb55-590"><a href="#cb55-590" aria-hidden="true" tabindex="-1"></a>\textbf{E}(Y_{i_j} \mid \text{TX} = <span class="sc">\{</span>0, 1<span class="sc">\}</span>)</span>
<span id="cb55-591"><a href="#cb55-591" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb55-592"><a href="#cb55-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-593"><a href="#cb55-593" aria-hidden="true" tabindex="-1"></a>As with the conditional effects, the equation for calculating this depends on the family you're using. For lognormal families, it's this incredibly scary formula:</span>
<span id="cb55-594"><a href="#cb55-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-595"><a href="#cb55-595" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb55-596"><a href="#cb55-596" aria-hidden="true" tabindex="-1"></a>\textbf{E}(Y_{i_j} \mid \text{TX} = <span class="sc">\{</span>0, 1<span class="sc">\}</span>) = \int \exp \left(x + \sigma_y^2 / 2 \right) \, f_{\texttt{dnorm}} \left(x, \left(\beta_0 + \beta_1 \text{TX} \right), \sigma_0^2 \right) \,dx</span>
<span id="cb55-597"><a href="#cb55-597" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb55-598"><a href="#cb55-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-599"><a href="#cb55-599" aria-hidden="true" tabindex="-1"></a>Wild. This is a mess because it integrates over the normally-distributed cluster-specific offsets, thus incorporating them all into the overall effect.</span>
<span id="cb55-600"><a href="#cb55-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-601"><a href="#cb55-601" aria-hidden="true" tabindex="-1"></a>We can calculate this integral in a few different ways. <span class="co">[</span><span class="ot">Kristoffer Magnusson shows three different ways</span><span class="co">](https://rpsychologist.com/GLMM-part1-lognormal#how-to-calculate-marginal-effects-on-the-data-scale)</span> to calculate this hairy integral in his original post:</span>
<span id="cb55-602"><a href="#cb55-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-603"><a href="#cb55-603" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Numeric integration** with <span class="in">`integrate()`</span>:</span>
<span id="cb55-604"><a href="#cb55-604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-605"><a href="#cb55-605" aria-hidden="true" tabindex="-1"></a><span class="in">```{r indent="   "}</span></span>
<span id="cb55-606"><a href="#cb55-606" aria-hidden="true" tabindex="-1"></a><span class="in">B_TXs &lt;- c(B0, B0 + B1) %&gt;% set_names(c("0", "1"))</span></span>
<span id="cb55-607"><a href="#cb55-607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-608"><a href="#cb55-608" aria-hidden="true" tabindex="-1"></a><span class="in">B_TXs %&gt;% </span></span>
<span id="cb55-609"><a href="#cb55-609" aria-hidden="true" tabindex="-1"></a><span class="in">  map(~{</span></span>
<span id="cb55-610"><a href="#cb55-610" aria-hidden="true" tabindex="-1"></a><span class="in">    integrate(</span></span>
<span id="cb55-611"><a href="#cb55-611" aria-hidden="true" tabindex="-1"></a><span class="in">      f = function(x) {</span></span>
<span id="cb55-612"><a href="#cb55-612" aria-hidden="true" tabindex="-1"></a><span class="in">        exp(x + sigma_y ^ 2 / 2) * dnorm(x, ., sd = sigma_0)</span></span>
<span id="cb55-613"><a href="#cb55-613" aria-hidden="true" tabindex="-1"></a><span class="in">      },</span></span>
<span id="cb55-614"><a href="#cb55-614" aria-hidden="true" tabindex="-1"></a><span class="in">      lower = B0 - 10 * sigma_0,</span></span>
<span id="cb55-615"><a href="#cb55-615" aria-hidden="true" tabindex="-1"></a><span class="in">      upper = B0 + 10 * sigma_0</span></span>
<span id="cb55-616"><a href="#cb55-616" aria-hidden="true" tabindex="-1"></a><span class="in">    )$value</span></span>
<span id="cb55-617"><a href="#cb55-617" aria-hidden="true" tabindex="-1"></a><span class="in">  })</span></span>
<span id="cb55-618"><a href="#cb55-618" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-619"><a href="#cb55-619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-620"><a href="#cb55-620" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>A magical <span class="co">[</span><span class="ot">**moment-generating function** for the lognormal distribution</span><span class="co">](https://en.wikipedia.org/wiki/Log-normal_distribution#Characteristic_function_and_moment_generating_function)</span>:</span>
<span id="cb55-621"><a href="#cb55-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-622"><a href="#cb55-622" aria-hidden="true" tabindex="-1"></a><span class="in">```{r indent="   "}</span></span>
<span id="cb55-623"><a href="#cb55-623" aria-hidden="true" tabindex="-1"></a><span class="in">exp(B_TXs + (sigma_0^2 + sigma_y^2)/2)</span></span>
<span id="cb55-624"><a href="#cb55-624" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-625"><a href="#cb55-625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-626"><a href="#cb55-626" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Brute force Monte Carlo integration**, where we create a bunch of hypothetical cluster offsets $b_{0_j}$ with a mean of 0 and a standard deviation of $\sigma_0$, calculate the average outcome, then take the average of all those hypothetical clusters:</span>
<span id="cb55-627"><a href="#cb55-627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-628"><a href="#cb55-628" aria-hidden="true" tabindex="-1"></a><span class="in">```{r indent="   "}</span></span>
<span id="cb55-629"><a href="#cb55-629" aria-hidden="true" tabindex="-1"></a><span class="in"># A bunch of hypothetical cluster offsets</span></span>
<span id="cb55-630"><a href="#cb55-630" aria-hidden="true" tabindex="-1"></a><span class="in">sigma_0_i &lt;- rnorm(1e5, 0, sigma_0)</span></span>
<span id="cb55-631"><a href="#cb55-631" aria-hidden="true" tabindex="-1"></a><span class="in">B_TXs %&gt;% </span></span>
<span id="cb55-632"><a href="#cb55-632" aria-hidden="true" tabindex="-1"></a><span class="in">  map(~{</span></span>
<span id="cb55-633"><a href="#cb55-633" aria-hidden="true" tabindex="-1"></a><span class="in">    mean(exp(. + sigma_0_i + sigma_y^2/2))</span></span>
<span id="cb55-634"><a href="#cb55-634" aria-hidden="true" tabindex="-1"></a><span class="in">  })</span></span>
<span id="cb55-635"><a href="#cb55-635" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-636"><a href="#cb55-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-637"><a href="#cb55-637" aria-hidden="true" tabindex="-1"></a>Those approaches are all great, but the math can get really complicated if there are interaction terms or splines or if you have more complex random effects structures (random slope offsets! nested groups!)</span>
<span id="cb55-638"><a href="#cb55-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-639"><a href="#cb55-639" aria-hidden="true" tabindex="-1"></a>So instead we can use {marginaleffects} to handle all that complexity for us.</span>
<span id="cb55-640"><a href="#cb55-640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-641"><a href="#cb55-641" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Average / marginalize / integrate across existing random effects**: Here we calculate predictions for $\text{TX} = <span class="sc">\{</span>0, 1<span class="sc">\}</span>$ within each of the existing clusters. We then collapse them into averages for each level of $\text{TX}$. The values here are not identical to what we found with the earlier approaches, though they're in the same general area. I'm not 100% why—I'm guessing it's because there aren't a lot of clusters to work with, so the averages aren't really stable.</span>
<span id="cb55-642"><a href="#cb55-642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-643"><a href="#cb55-643" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval=FALSE, indent="   "}</span></span>
<span id="cb55-644"><a href="#cb55-644" aria-hidden="true" tabindex="-1"></a><span class="in">predictions(</span></span>
<span id="cb55-645"><a href="#cb55-645" aria-hidden="true" tabindex="-1"></a><span class="in">  fit, </span></span>
<span id="cb55-646"><a href="#cb55-646" aria-hidden="true" tabindex="-1"></a><span class="in">  newdata = datagrid(TX = c(0, 1), </span></span>
<span id="cb55-647"><a href="#cb55-647" aria-hidden="true" tabindex="-1"></a><span class="in">                     cluster = unique), </span></span>
<span id="cb55-648"><a href="#cb55-648" aria-hidden="true" tabindex="-1"></a><span class="in">  by = "TX", </span></span>
<span id="cb55-649"><a href="#cb55-649" aria-hidden="true" tabindex="-1"></a><span class="in">  re_formula = NULL</span></span>
<span id="cb55-650"><a href="#cb55-650" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb55-651"><a href="#cb55-651" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-652"><a href="#cb55-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-653"><a href="#cb55-653" aria-hidden="true" tabindex="-1"></a><span class="in">```{r indent="   "}</span></span>
<span id="cb55-654"><a href="#cb55-654" aria-hidden="true" tabindex="-1"></a><span class="in">#| echo: false</span></span>
<span id="cb55-655"><a href="#cb55-655" aria-hidden="true" tabindex="-1"></a><span class="in">#| collapse: false</span></span>
<span id="cb55-656"><a href="#cb55-656" aria-hidden="true" tabindex="-1"></a><span class="in">#| comment: "##"</span></span>
<span id="cb55-657"><a href="#cb55-657" aria-hidden="true" tabindex="-1"></a><span class="in">#| class-output: "r sourceCode"</span></span>
<span id="cb55-658"><a href="#cb55-658" aria-hidden="true" tabindex="-1"></a><span class="in">marginal_preds %&gt;% </span></span>
<span id="cb55-659"><a href="#cb55-659" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(TX) %&gt;% </span></span>
<span id="cb55-660"><a href="#cb55-660" aria-hidden="true" tabindex="-1"></a><span class="in">  median_qi(draw) %&gt;% </span></span>
<span id="cb55-661"><a href="#cb55-661" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(type = "response") %&gt;% </span></span>
<span id="cb55-662"><a href="#cb55-662" aria-hidden="true" tabindex="-1"></a><span class="in">  select(type, TX, predicted = draw, conf.low = .lower, conf.high = .upper)</span></span>
<span id="cb55-663"><a href="#cb55-663" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-664"><a href="#cb55-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-665"><a href="#cb55-665" aria-hidden="true" tabindex="-1"></a>   We can visualize the posteriors too:</span>
<span id="cb55-666"><a href="#cb55-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-667"><a href="#cb55-667" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval=FALSE, indent="   "}</span></span>
<span id="cb55-668"><a href="#cb55-668" aria-hidden="true" tabindex="-1"></a><span class="in">marginal_preds &lt;- predictions(</span></span>
<span id="cb55-669"><a href="#cb55-669" aria-hidden="true" tabindex="-1"></a><span class="in">  fit, </span></span>
<span id="cb55-670"><a href="#cb55-670" aria-hidden="true" tabindex="-1"></a><span class="in">  newdata = datagrid(TX = c(0, 1), </span></span>
<span id="cb55-671"><a href="#cb55-671" aria-hidden="true" tabindex="-1"></a><span class="in">                     cluster = unique), </span></span>
<span id="cb55-672"><a href="#cb55-672" aria-hidden="true" tabindex="-1"></a><span class="in">  by = "TX", </span></span>
<span id="cb55-673"><a href="#cb55-673" aria-hidden="true" tabindex="-1"></a><span class="in">  re_formula = NULL</span></span>
<span id="cb55-674"><a href="#cb55-674" aria-hidden="true" tabindex="-1"></a><span class="in">) %&gt;% </span></span>
<span id="cb55-675"><a href="#cb55-675" aria-hidden="true" tabindex="-1"></a><span class="in">  posteriordraws()</span></span>
<span id="cb55-676"><a href="#cb55-676" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-677"><a href="#cb55-677" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-678"><a href="#cb55-678" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-marginal-preds, fig.width=5.5, fig.height=3.75, indent="   "}</span></span>
<span id="cb55-679"><a href="#cb55-679" aria-hidden="true" tabindex="-1"></a><span class="in">#| warning: false</span></span>
<span id="cb55-680"><a href="#cb55-680" aria-hidden="true" tabindex="-1"></a><span class="in">p_marginal_preds &lt;- marginal_preds %&gt;% </span></span>
<span id="cb55-681"><a href="#cb55-681" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = draw, fill = factor(TX))) +</span></span>
<span id="cb55-682"><a href="#cb55-682" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye() +</span></span>
<span id="cb55-683"><a href="#cb55-683" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_manual(values = colorspace::lighten(c(clrs[5], clrs[1]), 0.4)) +</span></span>
<span id="cb55-684"><a href="#cb55-684" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_dollar()) +</span></span>
<span id="cb55-685"><a href="#cb55-685" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Gambling losses", y = "Density", fill = "TX",</span></span>
<span id="cb55-686"><a href="#cb55-686" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "Marginal population-level means",</span></span>
<span id="cb55-687"><a href="#cb55-687" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "Random effects averaged / marginalized / integrated") +</span></span>
<span id="cb55-688"><a href="#cb55-688" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(xlim = c(100, 1500)) +</span></span>
<span id="cb55-689"><a href="#cb55-689" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice()</span></span>
<span id="cb55-690"><a href="#cb55-690" aria-hidden="true" tabindex="-1"></a><span class="in">p_marginal_preds</span></span>
<span id="cb55-691"><a href="#cb55-691" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-692"><a href="#cb55-692" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-693"><a href="#cb55-693" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**Integrate out random effects**: Instead of using the existing cluster intercepts, we can integrate out the random effects by generating predictions for a bunch of clusters (like 100), and then collapse those predictions into averages. This is similar to the intuition of brute force Monte Carlo integration in approach #3 earlier. *This takes a long time!* It results in the same estimates we found with the mathematical approaches in #1, #2, and #3 earlier.</span>
<span id="cb55-694"><a href="#cb55-694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-695"><a href="#cb55-695" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval=FALSE, indent="   "}</span></span>
<span id="cb55-696"><a href="#cb55-696" aria-hidden="true" tabindex="-1"></a><span class="in">predictions(fit, newdata = datagrid(TX = c(0, 1), cluster = c(-1:-100)),</span></span>
<span id="cb55-697"><a href="#cb55-697" aria-hidden="true" tabindex="-1"></a><span class="in">            allow_new_levels = TRUE,</span></span>
<span id="cb55-698"><a href="#cb55-698" aria-hidden="true" tabindex="-1"></a><span class="in">            sample_new_levels = "gaussian",</span></span>
<span id="cb55-699"><a href="#cb55-699" aria-hidden="true" tabindex="-1"></a><span class="in">            by = "TX")</span></span>
<span id="cb55-700"><a href="#cb55-700" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-701"><a href="#cb55-701" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-702"><a href="#cb55-702" aria-hidden="true" tabindex="-1"></a><span class="in">```{r indent="   "}</span></span>
<span id="cb55-703"><a href="#cb55-703" aria-hidden="true" tabindex="-1"></a><span class="in">#| echo: false</span></span>
<span id="cb55-704"><a href="#cb55-704" aria-hidden="true" tabindex="-1"></a><span class="in">#| collapse: false</span></span>
<span id="cb55-705"><a href="#cb55-705" aria-hidden="true" tabindex="-1"></a><span class="in">#| comment: "##"</span></span>
<span id="cb55-706"><a href="#cb55-706" aria-hidden="true" tabindex="-1"></a><span class="in">#| class-output: "r sourceCode"</span></span>
<span id="cb55-707"><a href="#cb55-707" aria-hidden="true" tabindex="-1"></a><span class="in">marginal_preds_int %&gt;% </span></span>
<span id="cb55-708"><a href="#cb55-708" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(TX) %&gt;% </span></span>
<span id="cb55-709"><a href="#cb55-709" aria-hidden="true" tabindex="-1"></a><span class="in">  median_qi(draw) %&gt;% </span></span>
<span id="cb55-710"><a href="#cb55-710" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(type = "response") %&gt;% </span></span>
<span id="cb55-711"><a href="#cb55-711" aria-hidden="true" tabindex="-1"></a><span class="in">  select(type, TX, predicted = draw, conf.low = .lower, conf.high = .upper)</span></span>
<span id="cb55-712"><a href="#cb55-712" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-713"><a href="#cb55-713" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-714"><a href="#cb55-714" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval=FALSE, indent="   "}</span></span>
<span id="cb55-715"><a href="#cb55-715" aria-hidden="true" tabindex="-1"></a><span class="in">marginal_preds_int &lt;- predictions(</span></span>
<span id="cb55-716"><a href="#cb55-716" aria-hidden="true" tabindex="-1"></a><span class="in">  fit, </span></span>
<span id="cb55-717"><a href="#cb55-717" aria-hidden="true" tabindex="-1"></a><span class="in">  newdata = datagrid(TX = c(0, 1), </span></span>
<span id="cb55-718"><a href="#cb55-718" aria-hidden="true" tabindex="-1"></a><span class="in">                     cluster = c(-1:-100)),</span></span>
<span id="cb55-719"><a href="#cb55-719" aria-hidden="true" tabindex="-1"></a><span class="in">  re_formula = NULL,</span></span>
<span id="cb55-720"><a href="#cb55-720" aria-hidden="true" tabindex="-1"></a><span class="in">  allow_new_levels = TRUE,</span></span>
<span id="cb55-721"><a href="#cb55-721" aria-hidden="true" tabindex="-1"></a><span class="in">  sample_new_levels = "gaussian",</span></span>
<span id="cb55-722"><a href="#cb55-722" aria-hidden="true" tabindex="-1"></a><span class="in">  by = "TX"</span></span>
<span id="cb55-723"><a href="#cb55-723" aria-hidden="true" tabindex="-1"></a><span class="in">) %&gt;% </span></span>
<span id="cb55-724"><a href="#cb55-724" aria-hidden="true" tabindex="-1"></a><span class="in">  posteriordraws()</span></span>
<span id="cb55-725"><a href="#cb55-725" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-726"><a href="#cb55-726" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-727"><a href="#cb55-727" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-marginal-preds-int, fig.width=5.5, fig.height=3.75, indent="   "}</span></span>
<span id="cb55-728"><a href="#cb55-728" aria-hidden="true" tabindex="-1"></a><span class="in">#| warning: false</span></span>
<span id="cb55-729"><a href="#cb55-729" aria-hidden="true" tabindex="-1"></a><span class="in">p_marginal_preds_int &lt;- marginal_preds_int %&gt;% </span></span>
<span id="cb55-730"><a href="#cb55-730" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = draw, fill = factor(TX))) +</span></span>
<span id="cb55-731"><a href="#cb55-731" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye() +</span></span>
<span id="cb55-732"><a href="#cb55-732" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_manual(values = colorspace::lighten(c(clrs[5], clrs[1]), 0.4)) +</span></span>
<span id="cb55-733"><a href="#cb55-733" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_dollar()) +</span></span>
<span id="cb55-734"><a href="#cb55-734" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Gambling losses", y = "Density", fill = "TX",</span></span>
<span id="cb55-735"><a href="#cb55-735" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "Marginal population-level means",</span></span>
<span id="cb55-736"><a href="#cb55-736" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "Random effects integrated out") +</span></span>
<span id="cb55-737"><a href="#cb55-737" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(xlim = c(100, 1500)) +</span></span>
<span id="cb55-738"><a href="#cb55-738" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice()</span></span>
<span id="cb55-739"><a href="#cb55-739" aria-hidden="true" tabindex="-1"></a><span class="in">p_marginal_preds_int</span></span>
<span id="cb55-740"><a href="#cb55-740" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-741"><a href="#cb55-741" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-742"><a href="#cb55-742" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-743"><a href="#cb55-743" aria-hidden="true" tabindex="-1"></a><span class="fu">## Population-level ATE</span></span>
<span id="cb55-744"><a href="#cb55-744" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-745"><a href="#cb55-745" aria-hidden="true" tabindex="-1"></a>The average treatment effect (ATE) for a binary treatment is the difference between the two averages when $\text{TX} = 1$ and $\text{TX} = 0$, after somehow incorporating all the random cluster-specific offsets:</span>
<span id="cb55-746"><a href="#cb55-746" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-747"><a href="#cb55-747" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb55-748"><a href="#cb55-748" aria-hidden="true" tabindex="-1"></a>\textbf{E}(Y_{i_j} \mid \text{TX} = 1) - \textbf{E}(Y_{i_j} \mid \text{TX} = 0)</span>
<span id="cb55-749"><a href="#cb55-749" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb55-750"><a href="#cb55-750" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-751"><a href="#cb55-751" aria-hidden="true" tabindex="-1"></a>For a lognormal family, it's this terrifying thing:</span>
<span id="cb55-752"><a href="#cb55-752" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-753"><a href="#cb55-753" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb55-754"><a href="#cb55-754" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb55-755"><a href="#cb55-755" aria-hidden="true" tabindex="-1"></a>&amp;\textbf{E}(Y_{i_j} \mid \text{TX} = 1) - \textbf{E}(Y_{i_j} \mid \text{TX} = 0) = <span class="sc">\\</span></span>
<span id="cb55-756"><a href="#cb55-756" aria-hidden="true" tabindex="-1"></a>&amp;\qquad \int \exp \left(x + \sigma_y^2 / 2 \right) \, f_{\texttt{dnorm}} \left(x, \left(\beta_0 + \beta_1 \right), \sigma_0^2 \right) \,dx \ - <span class="sc">\\</span></span>
<span id="cb55-757"><a href="#cb55-757" aria-hidden="true" tabindex="-1"></a>&amp;\qquad \int \exp \left(x + \sigma_y^2 / 2 \right) \, f_{\texttt{dnorm}} \left(x, \beta_0, \sigma_0^2 \right) \,dx</span>
<span id="cb55-758"><a href="#cb55-758" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb55-759"><a href="#cb55-759" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb55-760"><a href="#cb55-760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-761"><a href="#cb55-761" aria-hidden="true" tabindex="-1"></a>That looks scary, but really it's just the difference in the two estimates we found before: $\textbf{E}(Y_{i_j} \mid \text{TX} = 1)$ and $\textbf{E}(Y_{i_j} \mid \text{TX} = 0)$. We can use the same approaches from above and just subtract the two estimates, like this with the magical moment-generating function thing:</span>
<span id="cb55-762"><a href="#cb55-762" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-763"><a href="#cb55-763" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Population-level ATE with **moment-generating function**:</span>
<span id="cb55-764"><a href="#cb55-764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-765"><a href="#cb55-765" aria-hidden="true" tabindex="-1"></a><span class="in">```{r indent="   "}</span></span>
<span id="cb55-766"><a href="#cb55-766" aria-hidden="true" tabindex="-1"></a><span class="in">exp(B_TXs[2] + (sigma_0^2 + sigma_y^2)/2) - </span></span>
<span id="cb55-767"><a href="#cb55-767" aria-hidden="true" tabindex="-1"></a><span class="in">  exp(B_TXs[1] + (sigma_0^2 + sigma_y^2)/2)</span></span>
<span id="cb55-768"><a href="#cb55-768" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-769"><a href="#cb55-769" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-770"><a href="#cb55-770" aria-hidden="true" tabindex="-1"></a>We can do this with {marginaleffects} too, either by averaging / marginalizing / integrating across existing clusters (though again, this weirdly gives slightly different results) or by integrating out the random effects from a bunch of hypothetical clusters (which gives the same result as the more analytical / mathematical estimates):</span>
<span id="cb55-771"><a href="#cb55-771" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-772"><a href="#cb55-772" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Average / marginalize / integrate across existing random effects**:</span>
<span id="cb55-773"><a href="#cb55-773" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-774"><a href="#cb55-774" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval=FALSE, indent="   "}</span></span>
<span id="cb55-775"><a href="#cb55-775" aria-hidden="true" tabindex="-1"></a><span class="in"># Marginal treatment effect (or global population level effect)</span></span>
<span id="cb55-776"><a href="#cb55-776" aria-hidden="true" tabindex="-1"></a><span class="in">comparisons(</span></span>
<span id="cb55-777"><a href="#cb55-777" aria-hidden="true" tabindex="-1"></a><span class="in">  fit, </span></span>
<span id="cb55-778"><a href="#cb55-778" aria-hidden="true" tabindex="-1"></a><span class="in">  variables = "TX", </span></span>
<span id="cb55-779"><a href="#cb55-779" aria-hidden="true" tabindex="-1"></a><span class="in">  re_formula = NULL</span></span>
<span id="cb55-780"><a href="#cb55-780" aria-hidden="true" tabindex="-1"></a><span class="in">) %&gt;% </span></span>
<span id="cb55-781"><a href="#cb55-781" aria-hidden="true" tabindex="-1"></a><span class="in">  tidy()</span></span>
<span id="cb55-782"><a href="#cb55-782" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-783"><a href="#cb55-783" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-784"><a href="#cb55-784" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, indent="   "}</span></span>
<span id="cb55-785"><a href="#cb55-785" aria-hidden="true" tabindex="-1"></a><span class="in">#| echo: false</span></span>
<span id="cb55-786"><a href="#cb55-786" aria-hidden="true" tabindex="-1"></a><span class="in">#| message: false</span></span>
<span id="cb55-787"><a href="#cb55-787" aria-hidden="true" tabindex="-1"></a><span class="in">#| collapse: false</span></span>
<span id="cb55-788"><a href="#cb55-788" aria-hidden="true" tabindex="-1"></a><span class="in">#| comment: "##"</span></span>
<span id="cb55-789"><a href="#cb55-789" aria-hidden="true" tabindex="-1"></a><span class="in">#| class-output: "r sourceCode"</span></span>
<span id="cb55-790"><a href="#cb55-790" aria-hidden="true" tabindex="-1"></a><span class="in">marginal_ate %&gt;% </span></span>
<span id="cb55-791"><a href="#cb55-791" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(type, term, contrast, drawid) %&gt;%</span></span>
<span id="cb55-792"><a href="#cb55-792" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(draw = mean(draw)) %&gt;% </span></span>
<span id="cb55-793"><a href="#cb55-793" aria-hidden="true" tabindex="-1"></a><span class="in">  median_qi(draw) %&gt;% </span></span>
<span id="cb55-794"><a href="#cb55-794" aria-hidden="true" tabindex="-1"></a><span class="in">  select(type, term, contrast, estimate = draw, conf.low = .lower, conf.high = .upper)</span></span>
<span id="cb55-795"><a href="#cb55-795" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-796"><a href="#cb55-796" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-797"><a href="#cb55-797" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval=FALSE, indent="   "}</span></span>
<span id="cb55-798"><a href="#cb55-798" aria-hidden="true" tabindex="-1"></a><span class="in">marginal_ate &lt;- comparisons(</span></span>
<span id="cb55-799"><a href="#cb55-799" aria-hidden="true" tabindex="-1"></a><span class="in">  fit, </span></span>
<span id="cb55-800"><a href="#cb55-800" aria-hidden="true" tabindex="-1"></a><span class="in">  variables = "TX", </span></span>
<span id="cb55-801"><a href="#cb55-801" aria-hidden="true" tabindex="-1"></a><span class="in">  re_formula = NULL</span></span>
<span id="cb55-802"><a href="#cb55-802" aria-hidden="true" tabindex="-1"></a><span class="in">) %&gt;%</span></span>
<span id="cb55-803"><a href="#cb55-803" aria-hidden="true" tabindex="-1"></a><span class="in">  posteriordraws()</span></span>
<span id="cb55-804"><a href="#cb55-804" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-805"><a href="#cb55-805" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-806"><a href="#cb55-806" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-marginal-ate, fig.width=5.5, fig.height=3.75, indent="   "}</span></span>
<span id="cb55-807"><a href="#cb55-807" aria-hidden="true" tabindex="-1"></a><span class="in">p_marginal_ate &lt;- marginal_ate %&gt;% </span></span>
<span id="cb55-808"><a href="#cb55-808" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(drawid) %&gt;% </span></span>
<span id="cb55-809"><a href="#cb55-809" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(draw = mean(draw)) %&gt;% </span></span>
<span id="cb55-810"><a href="#cb55-810" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = draw)) +</span></span>
<span id="cb55-811"><a href="#cb55-811" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye(fill = colorspace::lighten(clrs[3], 0.4)) +</span></span>
<span id="cb55-812"><a href="#cb55-812" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_dollar(style_negative = "minus")) +</span></span>
<span id="cb55-813"><a href="#cb55-813" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "(TX = 1) − (TX = 0)", y = "Density", </span></span>
<span id="cb55-814"><a href="#cb55-814" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "Marginal population-level ATE",</span></span>
<span id="cb55-815"><a href="#cb55-815" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "Random effects averaged / marginalized / integrated") +</span></span>
<span id="cb55-816"><a href="#cb55-816" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(xlim = c(-900, 300)) +</span></span>
<span id="cb55-817"><a href="#cb55-817" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice()</span></span>
<span id="cb55-818"><a href="#cb55-818" aria-hidden="true" tabindex="-1"></a><span class="in">p_marginal_ate</span></span>
<span id="cb55-819"><a href="#cb55-819" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-820"><a href="#cb55-820" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-821"><a href="#cb55-821" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**Integrate out random effects**</span>
<span id="cb55-822"><a href="#cb55-822" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-823"><a href="#cb55-823" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval=FALSE, indent="   "}</span></span>
<span id="cb55-824"><a href="#cb55-824" aria-hidden="true" tabindex="-1"></a><span class="in"># This takes a *really* long time</span></span>
<span id="cb55-825"><a href="#cb55-825" aria-hidden="true" tabindex="-1"></a><span class="in">comparisons(</span></span>
<span id="cb55-826"><a href="#cb55-826" aria-hidden="true" tabindex="-1"></a><span class="in">  fit, </span></span>
<span id="cb55-827"><a href="#cb55-827" aria-hidden="true" tabindex="-1"></a><span class="in">  variables = "TX", </span></span>
<span id="cb55-828"><a href="#cb55-828" aria-hidden="true" tabindex="-1"></a><span class="in">  newdata = datagrid(cluster = c(-1:-100)),</span></span>
<span id="cb55-829"><a href="#cb55-829" aria-hidden="true" tabindex="-1"></a><span class="in">  re_formula = NULL,</span></span>
<span id="cb55-830"><a href="#cb55-830" aria-hidden="true" tabindex="-1"></a><span class="in">  allow_new_levels = TRUE,</span></span>
<span id="cb55-831"><a href="#cb55-831" aria-hidden="true" tabindex="-1"></a><span class="in">  sample_new_levels = "gaussian"</span></span>
<span id="cb55-832"><a href="#cb55-832" aria-hidden="true" tabindex="-1"></a><span class="in">) %&gt;% </span></span>
<span id="cb55-833"><a href="#cb55-833" aria-hidden="true" tabindex="-1"></a><span class="in">  tidy()</span></span>
<span id="cb55-834"><a href="#cb55-834" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-835"><a href="#cb55-835" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-836"><a href="#cb55-836" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, indent="   "}</span></span>
<span id="cb55-837"><a href="#cb55-837" aria-hidden="true" tabindex="-1"></a><span class="in">#| echo: false</span></span>
<span id="cb55-838"><a href="#cb55-838" aria-hidden="true" tabindex="-1"></a><span class="in">#| message: false</span></span>
<span id="cb55-839"><a href="#cb55-839" aria-hidden="true" tabindex="-1"></a><span class="in">#| collapse: false</span></span>
<span id="cb55-840"><a href="#cb55-840" aria-hidden="true" tabindex="-1"></a><span class="in">#| comment: "##"</span></span>
<span id="cb55-841"><a href="#cb55-841" aria-hidden="true" tabindex="-1"></a><span class="in">#| class-output: "r sourceCode"</span></span>
<span id="cb55-842"><a href="#cb55-842" aria-hidden="true" tabindex="-1"></a><span class="in">marginal_ate_int %&gt;% </span></span>
<span id="cb55-843"><a href="#cb55-843" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(type, term, contrast, drawid) %&gt;%</span></span>
<span id="cb55-844"><a href="#cb55-844" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(draw = mean(draw)) %&gt;% </span></span>
<span id="cb55-845"><a href="#cb55-845" aria-hidden="true" tabindex="-1"></a><span class="in">  median_qi(draw) %&gt;% </span></span>
<span id="cb55-846"><a href="#cb55-846" aria-hidden="true" tabindex="-1"></a><span class="in">  select(type, term, contrast, estimate = draw, conf.low = .lower, conf.high = .upper)</span></span>
<span id="cb55-847"><a href="#cb55-847" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-848"><a href="#cb55-848" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-849"><a href="#cb55-849" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval=FALSE, indent="   "}</span></span>
<span id="cb55-850"><a href="#cb55-850" aria-hidden="true" tabindex="-1"></a><span class="in">marginal_ate_int &lt;- comparisons(</span></span>
<span id="cb55-851"><a href="#cb55-851" aria-hidden="true" tabindex="-1"></a><span class="in">  fit, </span></span>
<span id="cb55-852"><a href="#cb55-852" aria-hidden="true" tabindex="-1"></a><span class="in">  variables = "TX", </span></span>
<span id="cb55-853"><a href="#cb55-853" aria-hidden="true" tabindex="-1"></a><span class="in">  newdata = datagrid(cluster = c(-1:-100)),</span></span>
<span id="cb55-854"><a href="#cb55-854" aria-hidden="true" tabindex="-1"></a><span class="in">  re_formula = NULL,</span></span>
<span id="cb55-855"><a href="#cb55-855" aria-hidden="true" tabindex="-1"></a><span class="in">  allow_new_levels = TRUE,</span></span>
<span id="cb55-856"><a href="#cb55-856" aria-hidden="true" tabindex="-1"></a><span class="in">  sample_new_levels = "gaussian"</span></span>
<span id="cb55-857"><a href="#cb55-857" aria-hidden="true" tabindex="-1"></a><span class="in">) %&gt;% </span></span>
<span id="cb55-858"><a href="#cb55-858" aria-hidden="true" tabindex="-1"></a><span class="in">  posteriordraws()</span></span>
<span id="cb55-859"><a href="#cb55-859" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-860"><a href="#cb55-860" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-861"><a href="#cb55-861" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-marginal-ate-int, fig.width=5.5, fig.height=3.75, indent="   "}</span></span>
<span id="cb55-862"><a href="#cb55-862" aria-hidden="true" tabindex="-1"></a><span class="in">p_marginal_ate_int &lt;- marginal_ate_int %&gt;% </span></span>
<span id="cb55-863"><a href="#cb55-863" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(drawid) %&gt;% </span></span>
<span id="cb55-864"><a href="#cb55-864" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(draw = mean(draw)) %&gt;% </span></span>
<span id="cb55-865"><a href="#cb55-865" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = draw)) +</span></span>
<span id="cb55-866"><a href="#cb55-866" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye(fill = colorspace::lighten(clrs[3], 0.4)) +</span></span>
<span id="cb55-867"><a href="#cb55-867" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_dollar(style_negative = "minus")) +</span></span>
<span id="cb55-868"><a href="#cb55-868" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "(TX = 1) − (TX = 0)", y = "Density", </span></span>
<span id="cb55-869"><a href="#cb55-869" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "Marginal population-level ATE",</span></span>
<span id="cb55-870"><a href="#cb55-870" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "Random effects integrated out") +</span></span>
<span id="cb55-871"><a href="#cb55-871" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(xlim = c(-900, 300)) +</span></span>
<span id="cb55-872"><a href="#cb55-872" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice()</span></span>
<span id="cb55-873"><a href="#cb55-873" aria-hidden="true" tabindex="-1"></a><span class="in">p_marginal_ate_int</span></span>
<span id="cb55-874"><a href="#cb55-874" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-875"><a href="#cb55-875" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-876"><a href="#cb55-876" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-877"><a href="#cb55-877" aria-hidden="true" tabindex="-1"></a><span class="fu"># Ratios and multiplicative effects</span></span>
<span id="cb55-878"><a href="#cb55-878" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-879"><a href="#cb55-879" aria-hidden="true" tabindex="-1"></a>Finally, we can work directly with the coefficients to get more slope-like effects, which is especially helpful when the coefficient of interest isn't for a binary variable. Typically with GLMs with log or logit links (like logit, Poisson, negative binomial, lognormal, etc.) we can exponentiate the coefficient to get it as an odds ratio or a multiplicative effect. That works here too:</span>
<span id="cb55-880"><a href="#cb55-880" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-883"><a href="#cb55-883" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb55-884"><a href="#cb55-884" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(B1)</span>
<span id="cb55-885"><a href="#cb55-885" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-886"><a href="#cb55-886" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-887"><a href="#cb55-887" aria-hidden="true" tabindex="-1"></a>A one-unit increase in $\text{TX}$ causes a 51% decrease (<span class="in">`exp(B1) - 1`</span>) in the outcome. Great.</span>
<span id="cb55-888"><a href="#cb55-888" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-889"><a href="#cb55-889" aria-hidden="true" tabindex="-1"></a>That's all fine here because the lognormal model doesn't have any weird nonlinearities or interactions, but in the case of logistic regression or anything with interaction terms, life gets more complicated, so it's better to work with <span class="in">`marginaleffects()`</span> instead of exponentiating things by hand. If we use <span class="in">`type = "link"`</span> we'll keep the results as logged odds, and then we can exponentiate them. All the other random effects options that we used before (<span class="in">`re_formula = NA`</span>, <span class="in">`re_formula = NULL`</span>, integrating effects out, and so on) work here too.</span>
<span id="cb55-890"><a href="#cb55-890" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-893"><a href="#cb55-893" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb55-894"><a href="#cb55-894" aria-hidden="true" tabindex="-1"></a><span class="fu">marginaleffects</span>(</span>
<span id="cb55-895"><a href="#cb55-895" aria-hidden="true" tabindex="-1"></a>  fit, </span>
<span id="cb55-896"><a href="#cb55-896" aria-hidden="true" tabindex="-1"></a>  <span class="at">variable =</span> <span class="st">"TX"</span>, </span>
<span id="cb55-897"><a href="#cb55-897" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"link"</span>,</span>
<span id="cb55-898"><a href="#cb55-898" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata =</span> <span class="fu">datagrid</span>(<span class="at">TX =</span> <span class="dv">0</span>)</span>
<span id="cb55-899"><a href="#cb55-899" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb55-900"><a href="#cb55-900" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(estimate, conf.low, conf.high), <span class="sc">~</span><span class="fu">exp</span>(.))) <span class="sc">%&gt;%</span> </span>
<span id="cb55-901"><a href="#cb55-901" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(rowid, term, estimate, conf.low, conf.high)</span>
<span id="cb55-902"><a href="#cb55-902" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-903"><a href="#cb55-903" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-904"><a href="#cb55-904" aria-hidden="true" tabindex="-1"></a>We can visualize the odds-ratio-scale posterior for fun:</span>
<span id="cb55-905"><a href="#cb55-905" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-906"><a href="#cb55-906" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig.width=5.5, fig.height=3.75}</span></span>
<span id="cb55-907"><a href="#cb55-907" aria-hidden="true" tabindex="-1"></a><span class="in">marginaleffects(</span></span>
<span id="cb55-908"><a href="#cb55-908" aria-hidden="true" tabindex="-1"></a><span class="in">  fit, </span></span>
<span id="cb55-909"><a href="#cb55-909" aria-hidden="true" tabindex="-1"></a><span class="in">  variable = "TX", </span></span>
<span id="cb55-910"><a href="#cb55-910" aria-hidden="true" tabindex="-1"></a><span class="in">  type = "link",</span></span>
<span id="cb55-911"><a href="#cb55-911" aria-hidden="true" tabindex="-1"></a><span class="in">  newdata = datagrid(TX = 0)</span></span>
<span id="cb55-912"><a href="#cb55-912" aria-hidden="true" tabindex="-1"></a><span class="in">) %&gt;% </span></span>
<span id="cb55-913"><a href="#cb55-913" aria-hidden="true" tabindex="-1"></a><span class="in">  posteriordraws() %&gt;% </span></span>
<span id="cb55-914"><a href="#cb55-914" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(draw = exp(draw) - 1) %&gt;% </span></span>
<span id="cb55-915"><a href="#cb55-915" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = draw)) +</span></span>
<span id="cb55-916"><a href="#cb55-916" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye(fill = colorspace::darken(clrs[3], 0.4)) +</span></span>
<span id="cb55-917"><a href="#cb55-917" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0) +</span></span>
<span id="cb55-918"><a href="#cb55-918" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_percent()) +</span></span>
<span id="cb55-919"><a href="#cb55-919" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Percent change in outcome", y = "Density") +</span></span>
<span id="cb55-920"><a href="#cb55-920" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice()</span></span>
<span id="cb55-921"><a href="#cb55-921" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-922"><a href="#cb55-922" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-923"><a href="#cb55-923" aria-hidden="true" tabindex="-1"></a>If we use <span class="in">`type = "response"`</span>, we can get slopes at specific values of the coefficient (which is less helpful here, since $\text{TX}$ can only be 0 or 1; but it's useful for continuous coefficients of interest).</span>
<span id="cb55-924"><a href="#cb55-924" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-925"><a href="#cb55-925" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-926"><a href="#cb55-926" aria-hidden="true" tabindex="-1"></a><span class="fu"># Summary</span></span>
<span id="cb55-927"><a href="#cb55-927" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-928"><a href="#cb55-928" aria-hidden="true" tabindex="-1"></a>Phew, that was a lot. Here's a summary table to reference to help keep things straight.</span>
<span id="cb55-929"><a href="#cb55-929" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-930"><a href="#cb55-930" aria-hidden="true" tabindex="-1"></a>:::{.column-page-right}</span>
<span id="cb55-931"><a href="#cb55-931" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-934"><a href="#cb55-934" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb55-935"><a href="#cb55-935" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb55-936"><a href="#cb55-936" aria-hidden="true" tabindex="-1"></a><span class="co">#| column: body-outset</span></span>
<span id="cb55-937"><a href="#cb55-937" aria-hidden="true" tabindex="-1"></a>wrap_r <span class="ot">&lt;-</span> <span class="cf">function</span>(x) glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">'&lt;div class="sourceCode cell-code"&gt;&lt;pre class="sourceCode r"&gt;&lt;code class="sourceCode r"&gt;{x}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;'</span>)</span>
<span id="cb55-938"><a href="#cb55-938" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-939"><a href="#cb55-939" aria-hidden="true" tabindex="-1"></a>conditional_out <span class="ot">&lt;-</span> r<span class="st">"{predictions(</span></span>
<span id="cb55-940"><a href="#cb55-940" aria-hidden="true" tabindex="-1"></a><span class="st">  fit, </span></span>
<span id="cb55-941"><a href="#cb55-941" aria-hidden="true" tabindex="-1"></a><span class="st">  newdata = datagrid(TX = c(0, 1)), </span></span>
<span id="cb55-942"><a href="#cb55-942" aria-hidden="true" tabindex="-1"></a><span class="st">  by = "</span>TX<span class="st">", </span></span>
<span id="cb55-943"><a href="#cb55-943" aria-hidden="true" tabindex="-1"></a><span class="st">  re_formula = NA</span></span>
<span id="cb55-944"><a href="#cb55-944" aria-hidden="true" tabindex="-1"></a><span class="st">)}"</span></span>
<span id="cb55-945"><a href="#cb55-945" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-946"><a href="#cb55-946" aria-hidden="true" tabindex="-1"></a>conditional_ate <span class="ot">&lt;-</span> r<span class="st">"{comparisons(</span></span>
<span id="cb55-947"><a href="#cb55-947" aria-hidden="true" tabindex="-1"></a><span class="st">  fit, </span></span>
<span id="cb55-948"><a href="#cb55-948" aria-hidden="true" tabindex="-1"></a><span class="st">  variables = "</span>TX<span class="st">",</span></span>
<span id="cb55-949"><a href="#cb55-949" aria-hidden="true" tabindex="-1"></a><span class="st">  re_formula = NA</span></span>
<span id="cb55-950"><a href="#cb55-950" aria-hidden="true" tabindex="-1"></a><span class="st">)}"</span></span>
<span id="cb55-951"><a href="#cb55-951" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-952"><a href="#cb55-952" aria-hidden="true" tabindex="-1"></a>marginal_out <span class="ot">&lt;-</span> r<span class="st">"{predictions(</span></span>
<span id="cb55-953"><a href="#cb55-953" aria-hidden="true" tabindex="-1"></a><span class="st">  fit, </span></span>
<span id="cb55-954"><a href="#cb55-954" aria-hidden="true" tabindex="-1"></a><span class="st">  newdata = datagrid(TX = c(0, 1), </span></span>
<span id="cb55-955"><a href="#cb55-955" aria-hidden="true" tabindex="-1"></a><span class="st">                     cluster = unique), </span></span>
<span id="cb55-956"><a href="#cb55-956" aria-hidden="true" tabindex="-1"></a><span class="st">  by = "</span>TX<span class="st">", </span></span>
<span id="cb55-957"><a href="#cb55-957" aria-hidden="true" tabindex="-1"></a><span class="st">  re_formula = NULL</span></span>
<span id="cb55-958"><a href="#cb55-958" aria-hidden="true" tabindex="-1"></a><span class="st">)}"</span></span>
<span id="cb55-959"><a href="#cb55-959" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-960"><a href="#cb55-960" aria-hidden="true" tabindex="-1"></a>marginal_out_int <span class="ot">&lt;-</span> r<span class="st">"{predictions(</span></span>
<span id="cb55-961"><a href="#cb55-961" aria-hidden="true" tabindex="-1"></a><span class="st">  fit, </span></span>
<span id="cb55-962"><a href="#cb55-962" aria-hidden="true" tabindex="-1"></a><span class="st">  newdata = datagrid(TX = c(0, 1), </span></span>
<span id="cb55-963"><a href="#cb55-963" aria-hidden="true" tabindex="-1"></a><span class="st">                     cluster = c(-1:-100)),</span></span>
<span id="cb55-964"><a href="#cb55-964" aria-hidden="true" tabindex="-1"></a><span class="st">  re_formula = NULL,</span></span>
<span id="cb55-965"><a href="#cb55-965" aria-hidden="true" tabindex="-1"></a><span class="st">  allow_new_levels = TRUE,</span></span>
<span id="cb55-966"><a href="#cb55-966" aria-hidden="true" tabindex="-1"></a><span class="st">  sample_new_levels = "</span>gaussian<span class="st">",</span></span>
<span id="cb55-967"><a href="#cb55-967" aria-hidden="true" tabindex="-1"></a><span class="st">  by = "</span>TX<span class="st">"</span></span>
<span id="cb55-968"><a href="#cb55-968" aria-hidden="true" tabindex="-1"></a><span class="st">)}"</span></span>
<span id="cb55-969"><a href="#cb55-969" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-970"><a href="#cb55-970" aria-hidden="true" tabindex="-1"></a>marginal_ate <span class="ot">&lt;-</span> r<span class="st">"{comparisons(</span></span>
<span id="cb55-971"><a href="#cb55-971" aria-hidden="true" tabindex="-1"></a><span class="st">  fit, </span></span>
<span id="cb55-972"><a href="#cb55-972" aria-hidden="true" tabindex="-1"></a><span class="st">  variables = "</span>TX<span class="st">", </span></span>
<span id="cb55-973"><a href="#cb55-973" aria-hidden="true" tabindex="-1"></a><span class="st">  re_formula = NULL</span></span>
<span id="cb55-974"><a href="#cb55-974" aria-hidden="true" tabindex="-1"></a><span class="st">) %&gt;% </span></span>
<span id="cb55-975"><a href="#cb55-975" aria-hidden="true" tabindex="-1"></a><span class="st">  tidy()</span></span>
<span id="cb55-976"><a href="#cb55-976" aria-hidden="true" tabindex="-1"></a><span class="st">}"</span></span>
<span id="cb55-977"><a href="#cb55-977" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-978"><a href="#cb55-978" aria-hidden="true" tabindex="-1"></a>marginal_ate_int <span class="ot">&lt;-</span> r<span class="st">"{comparisons(</span></span>
<span id="cb55-979"><a href="#cb55-979" aria-hidden="true" tabindex="-1"></a><span class="st">  fit, </span></span>
<span id="cb55-980"><a href="#cb55-980" aria-hidden="true" tabindex="-1"></a><span class="st">  variables = "</span>TX<span class="st">", </span></span>
<span id="cb55-981"><a href="#cb55-981" aria-hidden="true" tabindex="-1"></a><span class="st">  newdata = datagrid(cluster = c(-1:-100)),</span></span>
<span id="cb55-982"><a href="#cb55-982" aria-hidden="true" tabindex="-1"></a><span class="st">  re_formula = NULL,</span></span>
<span id="cb55-983"><a href="#cb55-983" aria-hidden="true" tabindex="-1"></a><span class="st">  allow_new_levels = TRUE,</span></span>
<span id="cb55-984"><a href="#cb55-984" aria-hidden="true" tabindex="-1"></a><span class="st">  sample_new_levels = "</span>gaussian<span class="st">"</span></span>
<span id="cb55-985"><a href="#cb55-985" aria-hidden="true" tabindex="-1"></a><span class="st">) %&gt;% </span></span>
<span id="cb55-986"><a href="#cb55-986" aria-hidden="true" tabindex="-1"></a><span class="st">  tidy()</span></span>
<span id="cb55-987"><a href="#cb55-987" aria-hidden="true" tabindex="-1"></a><span class="st">}"</span></span>
<span id="cb55-988"><a href="#cb55-988" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-989"><a href="#cb55-989" aria-hidden="true" tabindex="-1"></a><span class="fu">tribble</span>(</span>
<span id="cb55-990"><a href="#cb55-990" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>Effect, <span class="sc">~</span>Formula, <span class="sc">~</span><span class="st">`</span><span class="at">{marginaleffects} code</span><span class="st">`</span>,</span>
<span id="cb55-991"><a href="#cb55-991" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Average outcomes in typical group"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">(</span><span class="sc">\\</span><span class="st">textbf{E}(Y_{i_j} </span><span class="sc">\\</span><span class="st">mid b_{0_j} = 0, </span><span class="sc">\\</span><span class="st">text{TX} = </span><span class="sc">\\</span><span class="st">{0, 1</span><span class="sc">\\</span><span class="st">})</span><span class="sc">\\</span><span class="st">)"</span>, <span class="fu">wrap_r</span>(conditional_out),</span>
<span id="cb55-992"><a href="#cb55-992" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ATE in typical group"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">(</span><span class="sc">\\</span><span class="st">textbf{E}(Y_{i_j} </span><span class="sc">\\</span><span class="st">mid b_{0_j} = 0, </span><span class="sc">\\</span><span class="st">text{TX} = 1) -</span><span class="sc">\\</span><span class="st">)&lt;br&gt; </span><span class="sc">\\</span><span class="st">(</span><span class="sc">\\</span><span class="st">quad</span><span class="sc">\\</span><span class="st">textbf{E}(Y_{i_j} </span><span class="sc">\\</span><span class="st">mid b_{0_j} = 0, </span><span class="sc">\\</span><span class="st">text{TX} = 0)</span><span class="sc">\\</span><span class="st">)"</span>, <span class="fu">wrap_r</span>(conditional_ate),</span>
<span id="cb55-993"><a href="#cb55-993" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Average population-level outcomes (marginalized)"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">(</span><span class="sc">\\</span><span class="st">textbf{E}(Y_{i_j} </span><span class="sc">\\</span><span class="st">mid </span><span class="sc">\\</span><span class="st">text{TX} = </span><span class="sc">\\</span><span class="st">{0, 1</span><span class="sc">\\</span><span class="st">})</span><span class="sc">\\</span><span class="st">)"</span>, <span class="fu">wrap_r</span>(marginal_out),</span>
<span id="cb55-994"><a href="#cb55-994" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Average population-level outcomes (integrated out)"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">(</span><span class="sc">\\</span><span class="st">textbf{E}(Y_{i_j} </span><span class="sc">\\</span><span class="st">mid </span><span class="sc">\\</span><span class="st">text{TX} = </span><span class="sc">\\</span><span class="st">{0, 1</span><span class="sc">\\</span><span class="st">})</span><span class="sc">\\</span><span class="st">)"</span>, <span class="fu">wrap_r</span>(marginal_out_int),</span>
<span id="cb55-995"><a href="#cb55-995" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Population-level ATE (marginalized)"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">(</span><span class="sc">\\</span><span class="st">textbf{E}(Y_{i_j} </span><span class="sc">\\</span><span class="st">mid </span><span class="sc">\\</span><span class="st">text{TX} = 1) -</span><span class="sc">\\</span><span class="st">)&lt;br&gt; </span><span class="sc">\\</span><span class="st">(</span><span class="sc">\\</span><span class="st">quad</span><span class="sc">\\</span><span class="st">textbf{E}(Y_{i_j} </span><span class="sc">\\</span><span class="st">mid </span><span class="sc">\\</span><span class="st">text{TX} = 0)</span><span class="sc">\\</span><span class="st">)"</span>, <span class="fu">wrap_r</span>(marginal_ate),</span>
<span id="cb55-996"><a href="#cb55-996" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Population-level ATE (integrated out)"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">(</span><span class="sc">\\</span><span class="st">textbf{E}(Y_{i_j} </span><span class="sc">\\</span><span class="st">mid </span><span class="sc">\\</span><span class="st">text{TX} = 1) -</span><span class="sc">\\</span><span class="st">)&lt;br&gt; </span><span class="sc">\\</span><span class="st">(</span><span class="sc">\\</span><span class="st">quad</span><span class="sc">\\</span><span class="st">textbf{E}(Y_{i_j} </span><span class="sc">\\</span><span class="st">mid </span><span class="sc">\\</span><span class="st">text{TX} = 0)</span><span class="sc">\\</span><span class="st">)"</span>, <span class="fu">wrap_r</span>(marginal_ate_int)</span>
<span id="cb55-997"><a href="#cb55-997" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb55-998"><a href="#cb55-998" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">escape =</span> <span class="cn">FALSE</span>, <span class="at">align =</span> <span class="fu">c</span>(<span class="st">"l"</span>, <span class="st">"l"</span>, <span class="st">"l"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb55-999"><a href="#cb55-999" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">htmltable_class =</span> <span class="st">"table table-sm"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb55-1000"><a href="#cb55-1000" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pack_rows</span>(<span class="at">index =</span> <span class="fu">c</span>(<span class="st">"Conditional effects"</span> <span class="ot">=</span> <span class="dv">2</span>, <span class="st">"Marginal effects"</span> <span class="ot">=</span> <span class="dv">4</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb55-1001"><a href="#cb55-1001" aria-hidden="true" tabindex="-1"></a>  <span class="fu">column_spec</span>(<span class="dv">1</span>, <span class="at">width =</span> <span class="st">"25%"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb55-1002"><a href="#cb55-1002" aria-hidden="true" tabindex="-1"></a>  <span class="fu">column_spec</span>(<span class="dv">2</span>, <span class="at">width =</span> <span class="st">"35%"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb55-1003"><a href="#cb55-1003" aria-hidden="true" tabindex="-1"></a>  <span class="fu">column_spec</span>(<span class="dv">3</span>, <span class="at">width =</span> <span class="st">"40%"</span>)</span>
<span id="cb55-1004"><a href="#cb55-1004" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb55-1005"><a href="#cb55-1005" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-1006"><a href="#cb55-1006" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb55-1007"><a href="#cb55-1007" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-1008"><a href="#cb55-1008" aria-hidden="true" tabindex="-1"></a>And here are all the posteriors all together, for easier comparison:</span>
<span id="cb55-1009"><a href="#cb55-1009" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-1010"><a href="#cb55-1010" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-everything, fig.width=10, fig.height=8, message=FALSE}</span></span>
<span id="cb55-1011"><a href="#cb55-1011" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb55-1012"><a href="#cb55-1012" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page</span></span>
<span id="cb55-1013"><a href="#cb55-1013" aria-hidden="true" tabindex="-1"></a><span class="in">((p_conditional_preds + coord_cartesian(xlim = c(0, 1200))) | p_conditional_ate) /</span></span>
<span id="cb55-1014"><a href="#cb55-1014" aria-hidden="true" tabindex="-1"></a><span class="in">  ((p_marginal_preds + coord_cartesian(xlim = c(0, 1200))) | p_marginal_ate) /</span></span>
<span id="cb55-1015"><a href="#cb55-1015" aria-hidden="true" tabindex="-1"></a><span class="in">  ((p_marginal_preds_int + coord_cartesian(xlim = c(0, 1200))) | p_marginal_ate_int)</span></span>
<span id="cb55-1016"><a href="#cb55-1016" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p><span class="faux-block">Forked from <a href="https://www.andrewheiss.com/">Andrew Heiss</a></span> # <span class="faux-block"><a href="https://github.com/andrewheiss/ath-quarto">View the source at <i class="fa-brands fa-github" aria-label="github"></i> GitHub</a></span></p>
</div>
  </div>
</footer>


</body></html>