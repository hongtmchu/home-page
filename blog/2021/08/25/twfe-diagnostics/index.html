<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Andrew Heiss">
<meta name="description" content="Use R to explore possible biases that come from differential treatment timing in two-way fixed effects (TWFE) regression models">
<title>Exploring Pamela Jakiela’s simple TWFE diagnostics with R | Andrew Heiss – Andrew Heiss</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="../../../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../../../">
<link href="../../../../..//files/favicon-512.png" rel="icon" type="image/png">
<script src="../../../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../../../site_libs/quarto-html/quarto-syntax-highlighting-17c909d5fd25ae21b861c0c7a49b2096.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../../../site_libs/bootstrap/bootstrap-5cd0811f461c8271ae6bab49df9501be.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<link href="../../../../../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../../../../../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<script src="../../../../../site_libs/quarto-contrib/iconify-2.0.0/iconify-icon.min.js"></script><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script type="text/javascript">

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-527449-5', 'auto');

ga('send', {
  hitType: 'pageview',
  'anonymizeIp': true,
});
</script><style>

      .quarto-title-block .quarto-title-banner {
        background: #170C3A;
      }
</style>
<script src="../../../../../site_libs/kePrint-0.0.1/kePrint.js"></script><link href="../../../../../site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
<meta property="og:title" content="Exploring Pamela Jakiela’s simple TWFE diagnostics with R | Andrew Heiss">
<meta property="og:description" content="Use R to explore possible biases that come from differential treatment timing in two-way fixed effects (TWFE) regression models">
<meta property="og:image" content="https://www.andrewheiss.com/blog/2021/08/25/twfe-diagnostics/index_files/figure-html/show-weights-hist-1.png">
<meta property="og:site_name" content="Andrew Heiss">
<meta property="og:locale" content="en_US">
<meta property="og:image:height" content="1296">
<meta property="og:image:width" content="2304">
<meta name="twitter:title" content="Exploring Pamela Jakiela’s simple TWFE diagnostics with R | Andrew Heiss">
<meta name="twitter:description" content="Use R to explore possible biases that come from differential treatment timing in two-way fixed effects (TWFE) regression models">
<meta name="twitter:image" content="https://www.andrewheiss.com/blog/2021/08/25/twfe-diagnostics/index_files/figure-html/show-weights-hist-1.png">
<meta name="twitter:creator" content="@andrewheiss">
<meta name="twitter:site" content="@andrewheiss">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image-height" content="1296">
<meta name="twitter:image-width" content="2304">
</head>
<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../../../index.html">
    <span class="navbar-title">Andrew Heiss</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link" href="../../../../../index.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../cv/index.html"> 
<span class="menu-text">CV</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../blog/index.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../research/index.html"> 
<span class="menu-text">Research</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../teaching/index.html"> 
<span class="menu-text">Teaching</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../talks/index.html"> 
<span class="menu-text">Talks</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../now/index.html"> 
<span class="menu-text">Now</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../uses/index.html"> 
<span class="menu-text">Uses</span></a>
  </li>  
</ul>
<ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item">
    <a class="nav-link" href="../../../../../atom.xml"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:rss" style="font-size: 1.1em;" aria-label="Icon rss from bi Iconify.design set." title="RSS"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="mailto:aheiss@gsu.edu"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:envelope" style="font-size: 1.1em;" aria-label="Icon envelope from bi Iconify.design set." title="E-mail"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://bsky.app/profile/andrew.heiss.phd" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="fa6-brands:bluesky" style="font-size: 1.1em;" aria-label="Icon bluesky from fa6-brands Iconify.design set." title="Bluesky"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://fediscience.org/users/andrew/" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:mastodon" style="font-size: 1.1em;" aria-label="Icon mastodon from bi Iconify.design set." title="Mastodon"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/andrewheiss" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:github" style="font-size: 1.1em;" aria-label="Icon github from bi Iconify.design set." title="GitHub"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.youtube.com/andrewheiss" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:youtube" style="font-size: 1.1em;" aria-label="Icon youtube from bi Iconify.design set." title="YouTube"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.heissatopia.com/"> 
<span class="menu-text"><iconify-icon inline="" icon="fa6-brands:blogger" style="font-size: 1.15em;" aria-label="Icon blogger from fa6-brands Iconify.design set." title="Blogger"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.linkedin.com/in/andrewheiss" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:linkedin" style="font-size: 1.1em;" aria-label="Icon linkedin from bi Iconify.design set." title="LinkedIn"></iconify-icon></span></a>
  </li>  
</ul>
</div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><header id="title-block-header" class="quarto-title-block default blog-post page-columns page-full"><div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">Exploring Pamela Jakiela’s simple TWFE diagnostics with R</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
                  <div>
        <div class="description">
          Use R to explore possible biases that come from differential treatment timing in two-way fixed effects (TWFE) regression models
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">r</div>
                <div class="quarto-category">tidyverse</div>
                <div class="quarto-category">regression</div>
                <div class="quarto-category">statistics</div>
                <div class="quarto-category">data visualization</div>
                <div class="quarto-category">econometrics</div>
                <div class="quarto-category">panel data</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p><a href="https://www.andrewheiss.com/">Andrew Heiss</a> <a href="https://orcid.org/0000-0002-3948-3914" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">Wednesday, August 25, 2021</p>
      </div>
    </div>
    
      
      <div>
      <div class="quarto-title-meta-heading">Doi</div>
      <div class="quarto-title-meta-contents">
        <p class="doi">
          <a href="https://doi.org/10.59350/yrbym-m0y62">10.59350/yrbym-m0y62</a>
        </p>
      </div>
    </div>
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Contents</h2>
   
  <ul>
<li><a href="#a-different-way-of-thinking-about-ols-coefficients" id="toc-a-different-way-of-thinking-about-ols-coefficients" class="nav-link active" data-scroll-target="#a-different-way-of-thinking-about-ols-coefficients">A different way of thinking about OLS coefficients</a></li>
  <li>
<a href="#residualized-weights-with-twfe-models" id="toc-residualized-weights-with-twfe-models" class="nav-link" data-scroll-target="#residualized-weights-with-twfe-models">Residualized weights with TWFE models</a>
  <ul class="collapse">
<li><a href="#load-and-clean-data" id="toc-load-and-clean-data" class="nav-link" data-scroll-target="#load-and-clean-data">Load and clean data</a></li>
  <li><a href="#model-specification" id="toc-model-specification" class="nav-link" data-scroll-target="#model-specification">Model specification</a></li>
  <li><a href="#twfe-models-with-r" id="toc-twfe-models-with-r" class="nav-link" data-scroll-target="#twfe-models-with-r">TWFE models with R</a></li>
  <li><a href="#twfe-estimate-with-residualized-treatment-weights" id="toc-twfe-estimate-with-residualized-treatment-weights" class="nav-link" data-scroll-target="#twfe-estimate-with-residualized-treatment-weights">TWFE estimate with residualized treatment weights</a></li>
  </ul>
</li>
  <li>
<a href="#jakielas-diagnostics" id="toc-jakielas-diagnostics" class="nav-link" data-scroll-target="#jakielas-diagnostics">Jakiela’s diagnostics</a>
  <ul class="collapse">
<li><a href="#do-treated-observations-receive-negative-weights" id="toc-do-treated-observations-receive-negative-weights" class="nav-link" data-scroll-target="#do-treated-observations-receive-negative-weights">3.1: Do treated observations receive negative weights?</a></li>
  <li><a href="#testing-the-homogeneity-assumption-directly" id="toc-testing-the-homogeneity-assumption-directly" class="nav-link" data-scroll-target="#testing-the-homogeneity-assumption-directly">3.2: Testing the homogeneity assumption directly</a></li>
  </ul>
</li>
  <li>
<a href="#jakielas-robustness-checks" id="toc-jakielas-robustness-checks" class="nav-link" data-scroll-target="#jakielas-robustness-checks">Jakiela’s robustness checks</a>
  <ul class="collapse">
<li><a href="#exclude-later-years" id="toc-exclude-later-years" class="nav-link" data-scroll-target="#exclude-later-years">Exclude later years</a></li>
  <li><a href="#change-how-many-post-treatment-years-are-kept" id="toc-change-how-many-post-treatment-years-are-kept" class="nav-link" data-scroll-target="#change-how-many-post-treatment-years-are-kept">Change how many post-treatment years are kept</a></li>
  <li><a href="#exclude-individual-countries" id="toc-exclude-individual-countries" class="nav-link" data-scroll-target="#exclude-individual-countries">Exclude individual countries</a></li>
  </ul>
</li>
  <li><a href="#tldr-conclusion" id="toc-tldr-conclusion" class="nav-link" data-scroll-target="#tldr-conclusion">tl;dr: Conclusion</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul></nav>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content"><p>The world of econometrics has been roiled over the past couple years with a bunch of new papers showing how two-way fixed effects (TWFE; situations with nested levels of observations, like country-year, state-month, etc.) estimates of causal effects from difference-in-differences-based natural experiments can be biased when treatment is applied at different times. There are a ton of these papers, like <span class="citation" data-cites="de-ChaisemartindHaultfoeuille:2020">de Chaisemartin and d’Haultfoeuille (<a href="#ref-de-ChaisemartindHaultfoeuille:2020" role="doc-biblioref">2020</a>)</span>, <span class="citation" data-cites="Goodman-Bacon:2021">Goodman-Bacon (<a href="#ref-Goodman-Bacon:2021" role="doc-biblioref">2021</a>)</span>, <span class="citation" data-cites="SunAbraham:2020">Sun and Abraham (<a href="#ref-SunAbraham:2020" role="doc-biblioref">2020</a>)</span>, <span class="citation" data-cites="CallawaySantAnna:2020">Callaway and Sant’Anna (<a href="#ref-CallawaySantAnna:2020" role="doc-biblioref">2020</a>)</span>, and <span class="citation" data-cites="BakerLarckerWang:2021">Baker, Larcker, and Wang (<a href="#ref-BakerLarckerWang:2021" role="doc-biblioref">2021</a>)</span>. And they’re all really technical and scary.</p>
<p>I’ve been peripherally following these discussions on Twitter, since I teach a class on causal inference and include <a href="https://evalf21.classes.andrewheiss.com/example/diff-in-diff/">a couple sessions and assignments on difference-in-differences approaches</a>, and since I do lots of <a href="https://www.andrewheiss.com/research/articles/chaudhry-heiss-ngos-aid/">research with country-year panel data</a> (see <a href="https://www.andrewheiss.com/blog/tags/inverse-probability-weighting/">all my posts on marginal structural models</a> for more on that), but I’ve admittedly been lost in the mathy details of all these papers and I’ve been slightly terrified of trying to work through these papers and figuring out what this differential timing bias actually looks like in real life. I’m not a real economist or econometrician (I just teach microeconomics and econometrics lolz), so this world is still pretty intimidating for me.</p>
<p>But <a href="https://pjakiela.github.io/">Pamela Jakiela</a> recently posted <a href="https://arxiv.org/abs/2103.13229">a working paper called “Simple Diagnostics for Two-Way Fixed Effects”</a> <span class="citation" data-cites="Jakiela:2021">(<a href="#ref-Jakiela:2021" role="doc-biblioref">Jakiela 2021</a>)</span> where she presents an easy-to-follow example of all this newfangled TWFE work, so I figured I’d finally officially plunge into this new TWFE world and try to figure out what it all means. Her paper is fantastic—you should read it if you want a quick introduction to the issues of differential timing and TWFE and if you want some easy ways to see how bad these situations might bias causal estimates.</p>
<p>In the spirit of <a href="http://arelbundock.com/">Vincent Arel-Bundock</a>, who publicly codes through more technical papers to understand them better (see <a href="http://arelbundock.com/posts/frontdoor/">this</a> or <a href="http://arelbundock.com/posts/robustness_values/">this</a> or <a href="http://arelbundock.com/posts/marginal_structural_models/">this</a>), this post is my attempt at translating Jakiela’s paper from conceptual math and Stata code into R. Here we go!</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>     <span class="co"># For ggplot2, dplyr, and friends</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://haven.tidyverse.org">haven</a></span><span class="op">)</span>         <span class="co"># For reading Stata files</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lrberge.github.io/fixest/">fixest</a></span><span class="op">)</span>        <span class="co"># One way of doing fixed effects regression</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://declaredesign.org/r/estimatr/">estimatr</a></span><span class="op">)</span>      <span class="co"># Another way of doing fixed effects regression</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://broom.tidymodels.org/">broom</a></span><span class="op">)</span>         <span class="co"># For converting model objects to data frames</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://haozhu233.github.io/kableExtra/">kableExtra</a></span><span class="op">)</span>    <span class="co"># For pretty tables</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://modelsummary.com">modelsummary</a></span><span class="op">)</span>  <span class="co"># For pretty regression tables</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com">patchwork</a></span><span class="op">)</span>     <span class="co"># For combining plots</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://scales.r-lib.org">scales</a></span><span class="op">)</span>        <span class="co"># For nice formatting functions</span></span>
<span></span>
<span><span class="co"># Custom ggplot theme to make pretty plots</span></span>
<span><span class="co"># Get the font at https://fonts.google.com/specimen/Barlow+Semi+Condensed</span></span>
<span><span class="va">theme_clean</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span>base_family <span class="op">=</span> <span class="st">"Barlow Semi Condensed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">theme</span><span class="op">(</span>panel.grid.minor <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>          plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>          axis.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Barlow Semi Condensed Medium"</span><span class="op">)</span>,</span>
<span>          strip.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Barlow Semi Condensed"</span>,</span>
<span>                                    face <span class="op">=</span> <span class="st">"bold"</span>, size <span class="op">=</span> <span class="fu">rel</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, hjust <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>          strip.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"grey80"</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>,</span>
<span>          plot.caption <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="a-different-way-of-thinking-about-ols-coefficients" class="level2"><h2 class="anchored" data-anchor-id="a-different-way-of-thinking-about-ols-coefficients">A different way of thinking about OLS coefficients</h2>
<p>Before diving into the issues that come with TWFE estimation (and Jakiela’s proposed diagnostics), we first have to think about regression coefficients in a slightly different way (that was completely new to me!)</p>
<p>To do this, let’s make some simulated data to play with. We have two variables: (1) an outcome that ranges from ≈400–2000, and (2) a continuous treatment that ranges from ≈2–70. For the sake of simplicity, we’ll pretend that the outcome represents weekly income, and the treatment is some sort of social policy (test scores from some job training program? idk—imagine something neat here). We’ll also pretend that this treatment is experimental so we can talk about causation here.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span>  <span class="co"># For reproducibility</span></span>
<span></span>
<span><span class="va">n_rows</span> <span class="op">&lt;-</span> <span class="fl">500</span></span>
<span><span class="va">fake_data</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span>treatment <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html">rbeta</a></span><span class="op">(</span><span class="va">n_rows</span>, shape1 <span class="op">=</span> <span class="fl">3</span>, shape2 <span class="op">=</span> <span class="fl">7</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>treatment <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">treatment</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co"># Build the outcome based on some baseline level of outcome + a boost in</span></span>
<span>  <span class="co"># outcome that happens because of the treatment + some noise</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>outcome_baseline <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n_rows</span>, mean <span class="op">=</span> <span class="fl">800</span>, sd <span class="op">=</span> <span class="fl">200</span><span class="op">)</span>,</span>
<span>         treatment_boost <span class="op">=</span> <span class="fl">10</span> <span class="op">*</span> <span class="va">treatment</span>,</span>
<span>         outcome <span class="op">=</span> <span class="va">outcome_baseline</span> <span class="op">+</span> <span class="va">treatment_boost</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n_rows</span>, <span class="fl">200</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">outcome</span>, <span class="va">treatment</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">fake_data</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 6 × 2</span></span>
<span><span class="co">##   outcome treatment</span></span>
<span><span class="co">##     &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1    514.        13</span></span>
<span><span class="co">## 2   1550.        35</span></span>
<span><span class="co">## 3   1562.        52</span></span>
<span><span class="co">## 4   1037.         4</span></span>
<span><span class="co">## 5   1137.        38</span></span>
<span><span class="co">## 6   1277.        39</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For reference, here’s what the distributions of these variables look like, along with the relationship between treatment and outcome:</p>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hist_out</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">fake_data</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">outcome</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span>binwidth <span class="op">=</span> <span class="fl">100</span>, color <span class="op">=</span> <span class="st">"white"</span>,</span>
<span>                 boundary <span class="op">=</span> <span class="fl">0</span>, fill <span class="op">=</span> <span class="st">"#FFA615"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">dollar_format</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Distribution of outcome"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Outcome"</span>, y <span class="op">=</span> <span class="st">"Count"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">80</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_clean</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>panel.grid.major.x <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">hist_trt</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">fake_data</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">treatment</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span>binwidth <span class="op">=</span> <span class="fl">5</span>, color <span class="op">=</span> <span class="st">"white"</span>,</span>
<span>                 boundary <span class="op">=</span> <span class="fl">0</span>, fill <span class="op">=</span> <span class="st">"#A4BD0A"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Distribution of treatment"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Treatment"</span>, y <span class="op">=</span> <span class="st">"Count"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">80</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_clean</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>panel.grid.major.x <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_trt_out</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">fake_data</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">treatment</span>, y <span class="op">=</span> <span class="va">outcome</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.75</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_smooth</span><span class="op">(</span>method <span class="op">=</span> <span class="st">"lm"</span>, color <span class="op">=</span> <span class="st">"#0599B0"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">dollar_format</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Effect of treatment on outcome"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Treatment"</span>, y <span class="op">=</span> <span class="st">"Outcome"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_clean</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="va">hist_out</span> <span class="op">+</span> <span class="va">hist_trt</span><span class="op">)</span> <span class="op">/</span> <span class="fu">plot_spacer</span><span class="op">(</span><span class="op">)</span> <span class="op">/</span> <span class="va">plot_trt_out</span> <span class="op">+</span></span>
<span>  <span class="fu">plot_layout</span><span class="op">(</span>heights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.28</span>, <span class="fl">0.02</span>, <span class="fl">0.7</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/show-fake-data-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:75.0%"></p>
</figure>
</div>
</div>
</div>
<p>We can find the average treatment effect (ATE) of this imaginary program on the outcome using a simple univariate regression model:</p>
<p><span class="math display">\[
\color{gray}{\overbrace{\color{#FFA615}{Y}}^{\text{Outcome}}_{\underbrace{\color{#FFA615}{i}}_{\text{An individual}}}} \color{black}{=} \color{gray}{\overbrace{\color{black}{\alpha}}^{\text{Intercept}}} \color{black}{+} \color{gray}{\underbrace{\color{#0599B0}{\beta}}_{\text{ATE}}} \color{gray}{\overbrace{\color{#A4BD0A}{D_i}}^{\text{Treatment}}} \color{black}{+} \color{gray}{\overbrace{\color{black}{\epsilon_i}}^{\text{Error}}}
\]</span></p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_effect</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">outcome</span> <span class="op">~</span> <span class="va">treatment</span>, data <span class="op">=</span> <span class="va">fake_data</span><span class="op">)</span></span>
<span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_effect</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 2 × 5</span></span>
<span><span class="co">##   term        estimate std.error statistic   p.value</span></span>
<span><span class="co">##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 (Intercept)  1001.      22.5        44.6 5.70e-176</span></span>
<span><span class="co">## 2 treatment       9.69     0.672      14.4 1.26e- 39</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This is just regular old OLS regression. Based on this model, a 1-unit increase in treatment causes a $9.69 increase in the outcome. Lovely.</p>
<p><span class="citation" data-cites="Jakiela:2021">Jakiela (<a href="#ref-Jakiela:2021" role="doc-biblioref">2021, 4</a>)</span> shows an alternate way of calculating <span class="math inline">\(\beta\)</span>, though, based on the <a href="https://en.wikipedia.org/wiki/Frisch%E2%80%93Waugh%E2%80%93Lovell_theorem">Frisch-Waugh-Lovell theorem</a>, which is an econometrics idea that I’ve never heard of (since I’m defs not an economist). According to this theorem, we can rewrite the OLS estimate of <span class="math inline">\(\beta\)</span> based on the residuals (<span class="math inline">\(\tilde{D}_i\)</span>) of a model that predicts treatment:</p>
<p><span class="math display">\[
\color{#0599B0}{\beta}\ \color{black}{=}\ \sum_i \color{#FFA615}{Y_i} \color{black}\left( \frac{\color{#353D03}{\tilde{D}_i}}{\sum_i \color{#353D03}{\tilde{D}_i}^2} \right)
\]</span></p>
<p>Since this is a univariate model, the residuals here are really just the deviations from the average value of the treatment, or <span class="math inline">\(D_i - \bar{D}\)</span>. We can confirm this by running an intercept-only model and comparing it to <span class="math inline">\(D_i - \bar{D}\)</span>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">trt_resid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">treatment</span> <span class="op">~</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">fake_data</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fake_data_resid</span> <span class="op">&lt;-</span> <span class="va">fake_data</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>treatment_resid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span><span class="op">(</span><span class="va">trt_resid</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>mean_treat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">treatment</span><span class="op">)</span>,</span>
<span>         diff <span class="op">=</span> <span class="va">treatment</span> <span class="op">-</span> <span class="va">mean_treat</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">fake_data_resid</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 6 × 5</span></span>
<span><span class="co">##   outcome treatment treatment_resid mean_treat   diff</span></span>
<span><span class="co">##     &lt;dbl&gt;     &lt;dbl&gt;           &lt;dbl&gt;      &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span><span class="co">## 1    514.        13          -17.2        30.2 -17.2 </span></span>
<span><span class="co">## 2   1550.        35            4.82       30.2   4.82</span></span>
<span><span class="co">## 3   1562.        52           21.8        30.2  21.8 </span></span>
<span><span class="co">## 4   1037.         4          -26.2        30.2 -26.2 </span></span>
<span><span class="co">## 5   1137.        38            7.82       30.2   7.82</span></span>
<span><span class="co">## 6   1277.        39            8.82       30.2   8.82</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>treatment_resid</code> and <code>diff</code> columns here are identical. Now that we have <span class="math inline">\(\tilde{D}_i\)</span>, we can use that fancy rewritten formula and calculate <span class="math inline">\(\beta\)</span>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">fake_data_resid</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span>beta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">outcome</span> <span class="op">*</span> <span class="op">(</span><span class="va">treatment_resid</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">treatment_resid</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 1 × 1</span></span>
<span><span class="co">##    beta</span></span>
<span><span class="co">##   &lt;dbl&gt;</span></span>
<span><span class="co">## 1  9.69</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>WHAAAAAT it’s the same ATE that we get from running a regular OLS model! That’s magical!</p>
<p>The reason Jakiela reparameterizes <span class="math inline">\(\beta\)</span> this way is because looking at residuals like this creates inherent weights for each observation. Essentially, <span class="math inline">\(\beta\)</span> is a <strong>weighted sum of the outcome variable</strong>, with the weights calculated with <span class="math inline">\(\frac{\tilde{D}_{it}}{\sum_{it} \tilde{D}_{it}^2}\)</span>, or <code>(treatment_resid / sum(treatment_resid^2))</code>. We can calculate the weights for each observation:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">fake_data_with_weights</span> <span class="op">&lt;-</span> <span class="va">fake_data_resid</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>treatment_weight <span class="op">=</span> <span class="va">treatment_resid</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">treatment_resid</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">fake_data_with_weights</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 6 × 6</span></span>
<span><span class="co">##   outcome treatment treatment_resid mean_treat   diff treatment_weight</span></span>
<span><span class="co">##     &lt;dbl&gt;     &lt;dbl&gt;           &lt;dbl&gt;      &lt;dbl&gt;  &lt;dbl&gt;            &lt;dbl&gt;</span></span>
<span><span class="co">## 1    514.        13          -17.2        30.2 -17.2        -0.000168 </span></span>
<span><span class="co">## 2   1550.        35            4.82       30.2   4.82        0.0000471</span></span>
<span><span class="co">## 3   1562.        52           21.8        30.2  21.8         0.000213 </span></span>
<span><span class="co">## 4   1037.         4          -26.2        30.2 -26.2        -0.000255 </span></span>
<span><span class="co">## 5   1137.        38            7.82       30.2   7.82        0.0000764</span></span>
<span><span class="co">## 6   1277.        39            8.82       30.2   8.82        0.0000861</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In this case, given that this is overly perfect simulated data, the weights are really small. In theory, the weights should sum up to 0. Let’s check that really quick:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">fake_data_with_weights</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span>total_weights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">treatment_weight</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 1 × 1</span></span>
<span><span class="co">##   total_weights</span></span>
<span><span class="co">##           &lt;dbl&gt;</span></span>
<span><span class="co">## 1     -4.61e-19</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can visualize the distribution of weights too:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">fake_data_with_weights</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">treatment_weight</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span>binwidth <span class="op">=</span> <span class="fl">0.00005</span>, color <span class="op">=</span> <span class="st">"white"</span>,</span>
<span>                 boundary <span class="op">=</span> <span class="fl">0</span>, fill <span class="op">=</span> <span class="st">"#F6C848"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span>, color <span class="op">=</span> <span class="st">"#FF2E00"</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Residualized treatment weight"</span>, y <span class="op">=</span> <span class="st">"Count"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">comma_format</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_clean</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>panel.grid.major.x <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/show-weights-fake-data-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:75.0%"></p>
</figure>
</div>
</div>
</div>
<p>There’s a pattern to which observations get positive or negative weights. According to <span class="citation" data-cites="Jakiela:2021">Jakiela (<a href="#ref-Jakiela:2021" role="doc-biblioref">2021, 4</a>)</span>,</p>
<blockquote class="blockquote">
<p>As in any univariate OLS regression of an outcome on a continuous measure of treatment intensity, observations with below mean treatment intensity receive negative weight, and may be thought of as part of the comparison group.</p>
</blockquote>
<p>Since treatment here is continuous, there’s no clear division between treatment and control groups, so mathematically, that threshold becomes the average value of treatment: observations where the treatment value is less than the average (or <span class="math inline">\(D_i &lt; \bar{D}\)</span>) receive negative weight and can conceptually be considered part of the control/comparison group, while observations where <span class="math inline">\(D_i &gt; \bar{D}\)</span> are in the treatment group. That’s apparent in the data too. Look at the first few rows of <code>fake_data_with_weights</code> above—observations where <code>treatment_resid</code> is negative have negative weights.</p>
</section><section id="residualized-weights-with-twfe-models" class="level2"><h2 class="anchored" data-anchor-id="residualized-weights-with-twfe-models">Residualized weights with TWFE models</h2>
<p>This idea of weighting the outcome variable by treatment status (with treated units getting positive weight and untreated units getting negative weight) is central to the rest of Jakiela’s argument and diagnostics (as well as all the other neat new diff-in-diff papers). Fundamentally, the main reason TWFE estimates get weird and biased with differently-timed treatments is because of issues with weights—in TWFE settings, treated observations often get negative weights and vice versa. This isn’t always bad, and Jakiela explains why and when it’s okay. That’s essentially the whole point of her paper—she provides diagnostics to help determine if there are serious issues with these residualized treatment weights.</p>
<section id="load-and-clean-data" class="level3"><h3 class="anchored" data-anchor-id="load-and-clean-data">Load and clean data</h3>
<p>To demonstrate issues with TWFE models, weights, and differential timing, Jakiela looks at the effect of eliminating primary school fees on school enrollment in 15 African countries, based on data from the World Bank. You can get <a href="https://pjakiela.github.io/TWFE/">her data and Stata code at GitHub</a>. First let’s load the data and clean it up a little.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">fpe_raw</span> <span class="op">&lt;-</span> <span class="fu">read_dta</span><span class="op">(</span><span class="st">"WDI-FPE-data.dta"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Remove rows where primary school enrollment is missing</span></span>
<span><span class="va">fpe_primary</span> <span class="op">&lt;-</span> <span class="va">fpe_raw</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">primary</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Remove rows where secondary school enrollment is missing</span></span>
<span><span class="va">fpe_secondary</span> <span class="op">&lt;-</span> <span class="va">fpe_raw</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">secondary</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">fpe_primary</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 6 × 8</span></span>
<span><span class="co">##    year country ccode primary    id secondary fpe_year treatment</span></span>
<span><span class="co">##   &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1  1981 Benin   BEN      60.3     2      15.5     2006         0</span></span>
<span><span class="co">## 2  1982 Benin   BEN      64.7     2      18.5     2006         0</span></span>
<span><span class="co">## 3  1983 Benin   BEN      66.2     2      21.2     2006         0</span></span>
<span><span class="co">## 4  1984 Benin   BEN      64.2     2      20.1     2006         0</span></span>
<span><span class="co">## 5  1985 Benin   BEN      64.3     2      19.0     2006         0</span></span>
<span><span class="co">## 6  1986 Benin   BEN      62.4     2      16.3     2006         0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We have 8 columns to work with:</p>
<ul>
<li>
<code>year</code>: The year of the observation</li>
<li>
<code>country</code> &amp; <code>ccode</code> &amp; <code>id</code>: The country name, ISO3 country code, and id number for each country (Stata apparently struggles with string-based variables, so <code>id</code> works better as a country identifier there)</li>
<li>
<code>primary</code>: Gross enrollment in primary schools</li>
<li>
<code>secondary</code>: Gross enrollment in secondary schools</li>
<li>
<code>fpe_year</code>: Year the country eliminated fees for primary schools</li>
<li>
<code>treatment</code>: Indicator variable that is <code>1</code> when <code>year &gt; fpe_year</code> and <code>0</code> otherwise</li>
</ul></section><section id="model-specification" class="level3"><h3 class="anchored" data-anchor-id="model-specification">Model specification</h3>
<p>We can estimate the causal effect of eliminating primary school fees (<code>treatment</code>) on primary and secondary school enrollment (<code>primary</code> and <code>secondary</code>) treatment with a TWFE diff-in-diff model:</p>
<p><span class="math display">\[
\color{gray}{\overbrace{\color{#FFA615}{Y}}^{\text{Outcome}}_{\underbrace{\color{#FFA615}{it}}_{\substack{i: \text{ country} \\ t: \text{ year}}}}} \color{black} = \color{gray}{\overbrace{\color{black}{\alpha}}^{\text{Intercept}}} + \color{gray}{\overbrace{\color{black}{\lambda_i}}^{\substack{\text{Country} \\ \text{fixed} \\ \text{effects}}}} + \color{gray}{\overbrace{\color{black}{\gamma_t}}^{\substack{\text{Year} \\ \text{fixed} \\ \text{effects}}}} + \color{gray}{\underbrace{\color{#0599B0}{\beta}}_{\text{ATE}}} \color{gray}{\overbrace{\color{#A4BD0A}{D_{it}}}^{\text{Treatment}}} + \color{gray}{\overbrace{\color{black}{\epsilon_{it}}}^{\text{Error}}}
\]</span></p>
<p>Or without all the annotations:</p>
<p><span class="math display">\[
\color{#FFA615}{Y_{it}} \color{black}{\ = \alpha + \lambda_i + \gamma_t +} \color{#0599B0}{\beta} \color{#A4BD0A}{D_{it}} \color{black}{\ + \epsilon_{it}}
\]</span></p>
</section><section id="twfe-models-with-r" class="level3"><h3 class="anchored" data-anchor-id="twfe-models-with-r">TWFE models with R</h3>
<p>There are a few different ways to do fixed effects regression with clustered robust standard errors in R. In Stata you do this:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">reg</span> primary treatment i.<span class="fu">year</span> i.id, <span class="kw">cluster</span>(id)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In R, you can use the standard <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> function, but it treats country and year as regular explanatory variables, so it includes them in the results from <code><a href="https://rdrr.io/r/base/summary.html">summary()</a></code> or <code>tidy()</code>. If you don’t want overly long and detailed results tables, you have to filter those results out.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_lm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">primary</span> <span class="op">~</span> <span class="va">treatment</span> <span class="op">+</span> <span class="va">country</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span>,</span>
<span>               data <span class="op">=</span> <span class="va">fpe_primary</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_lm</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu">str_detect</span><span class="op">(</span><span class="va">term</span>, <span class="st">"country"</span><span class="op">)</span>, <span class="op">!</span><span class="fu">str_detect</span><span class="op">(</span><span class="va">term</span>, <span class="st">"year"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 2 × 5</span></span>
<span><span class="co">##   term        estimate std.error statistic  p.value</span></span>
<span><span class="co">##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">## 1 (Intercept)     72.4      4.63     15.6  4.23e-44</span></span>
<span><span class="co">## 2 treatment       20.4      2.75      7.43 5.82e-13</span></span>
<span><span class="fu">glance</span><span class="op">(</span><span class="va">model_lm</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 1 × 12</span></span>
<span><span class="co">##   r.squared adj.r.squared sigma statistic   p.value    df logLik   AIC   BIC deviance</span></span>
<span><span class="co">##       &lt;dbl&gt;         &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">## 1     0.768         0.742  14.7      29.8 1.30e-110    49 -1985. 4073. 4287.   94828.</span></span>
<span><span class="co">## # ℹ 2 more variables: df.residual &lt;int&gt;, nobs &lt;int&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>These observations are clustered by country, so we should probably <a href="https://theeffectbook.net/ch-StatisticalAdjustment.html#your-standard-errors-are-probably-wrong">cluster our standard errors to capture within-country errors</a>. Using <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> doesn’t let you automatically create robust or clustered standard errors. You can use <code>lmtest::coeftest()</code> to do that after the fact, though. We can copy Stata’s standard errors precisely if we (1) specify the variance-covariance matrix using the <code>vcovCl()</code> function from the <strong>sandwich</strong> library, and (2) specify the degrees of freedom to use, based on the number of countries in the data, minus 1.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df_primary</span> <span class="op">&lt;-</span> <span class="va">fpe_primary</span> <span class="op">%&gt;%</span> <span class="fu">distinct</span><span class="op">(</span><span class="va">country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_lm_clustered</span> <span class="op">&lt;-</span> <span class="fu">lmtest</span><span class="fu">::</span><span class="fu">coeftest</span><span class="op">(</span><span class="va">model_lm</span>,</span>
<span>                                       vcov <span class="op">=</span> <span class="fu">sandwich</span><span class="fu">::</span><span class="va">vcovCL</span>,</span>
<span>                                       cluster <span class="op">=</span> <span class="op">~</span><span class="va">country</span>,</span>
<span>                                       df <span class="op">=</span> <span class="va">df_primary</span> <span class="op">-</span> <span class="fl">1</span>,</span>
<span>                                       <span class="co"># Keep original model so modelsummary shows R2</span></span>
<span>                                       save <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_lm_clustered</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu">str_detect</span><span class="op">(</span><span class="va">term</span>, <span class="st">"country"</span><span class="op">)</span>, <span class="op">!</span><span class="fu">str_detect</span><span class="op">(</span><span class="va">term</span>, <span class="st">"year"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 2 × 5</span></span>
<span><span class="co">##   term        estimate std.error statistic       p.value</span></span>
<span><span class="co">##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;         &lt;dbl&gt;</span></span>
<span><span class="co">## 1 (Intercept)     72.4      5.83     12.4  0.00000000601</span></span>
<span><span class="co">## 2 treatment       20.4      9.12      2.24 0.0418</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You can also use fancier regression functions that can handle fixed effects more systematically. The <code>lm_robust()</code> function from <a href="https://declaredesign.org/r/estimatr/">the <strong>estimatr</strong> package</a> works really well for defining special fixed effects that are automatically omitted from results tables <em>and</em> returning robust and optionally clustered standard errors:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_lm_robust</span> <span class="op">&lt;-</span> <span class="fu">lm_robust</span><span class="op">(</span><span class="va">primary</span> <span class="op">~</span> <span class="va">treatment</span>,</span>
<span>                             fixed_effects <span class="op">=</span> <span class="op">~</span> <span class="va">country</span> <span class="op">+</span> <span class="va">year</span>,</span>
<span>                             data <span class="op">=</span> <span class="va">fpe_primary</span>,</span>
<span>                             clusters <span class="op">=</span> <span class="va">country</span>, se_type <span class="op">=</span> <span class="st">"stata"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_lm_robust</span><span class="op">)</span></span>
<span><span class="co">##        term estimate std.error statistic p.value conf.low conf.high df outcome</span></span>
<span><span class="co">## 1 treatment     20.4      9.12      2.24  0.0418    0.867        40 14 primary</span></span>
<span><span class="fu">glance</span><span class="op">(</span><span class="va">model_lm_robust</span><span class="op">)</span></span>
<span><span class="co">##   r.squared adj.r.squared statistic p.value df.residual nobs se_type</span></span>
<span><span class="co">## 1     0.768         0.742        NA      NA          14  490   stata</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>feols()</code> function from <a href="https://lrberge.github.io/fixest/">the <strong>fixest</strong> package</a> also works well, though you need to change one of the default settings to get the same SEs as Stata when you have a small sample with nested fixed effects like we have here. By default, <code>feols()</code> will nest the fixed effect errors (which is also what <a href="http://scorreia.com/software/reghdfe/">Stata’s <code>reghdfe</code> package</a> does), but you can tell it to use the full set of country and year fixed effect errors with the <code>dof</code> argument (thanks to <a href="https://grantmcdermott.com/">Grant McDermott</a> for pointing this out!):</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_feols</span> <span class="op">&lt;-</span> <span class="fu">feols</span><span class="op">(</span><span class="va">primary</span> <span class="op">~</span> <span class="va">treatment</span> <span class="op">|</span> <span class="va">country</span> <span class="op">+</span> <span class="va">year</span>,</span>
<span>                     data <span class="op">=</span> <span class="va">fpe_primary</span>,</span>
<span>                     cluster <span class="op">=</span> <span class="op">~</span> <span class="va">country</span>,</span>
<span>                     dof <span class="op">=</span> <span class="fu">dof</span><span class="op">(</span>fixef.K <span class="op">=</span> <span class="st">"full"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## Warning in dof(fixef.K = "full"): The function 'dof' is deprecated. Please use function</span></span>
<span><span class="co">## 'ssc' instead.</span></span>
<span><span class="co">## Warning: feols(fml = pri...: dof is not a valid argument for function feols.</span></span>
<span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_feols</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 1 × 5</span></span>
<span><span class="co">##   term      estimate std.error statistic p.value</span></span>
<span><span class="co">##   &lt;chr&gt;        &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;</span></span>
<span><span class="co">## 1 treatment     20.4      8.98      2.28  0.0391</span></span>
<span><span class="fu">glance</span><span class="op">(</span><span class="va">model_feols</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 1 × 9</span></span>
<span><span class="co">##   r.squared adj.r.squared within.r.squared pseudo.r.squared sigma  nobs   AIC   BIC logLik</span></span>
<span><span class="co">##       &lt;dbl&gt;         &lt;dbl&gt;            &lt;dbl&gt;            &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span><span class="co">## 1     0.768         0.742            0.111               NA  14.7   490 4071. 4280. -1985.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can show these all in a side-by-side table using <a href="https://vincentarelbundock.github.io/modelsummary/">the <strong>modelsummary</strong> package</a>. Conveniently, <code>modelsummary()</code> also lets you <a href="https://grantmcdermott.com/better-way-adjust-SEs/">adjust standard errors on the fly</a> with the <code>vcov</code> argument, so we could theoretically handle all the clustering here instead of inside <code>lmtest::coeftest()</code>, <code>lm_robust()</code>, or <code>feols()</code>. But since we already specified the clusters above, we’ll just use those.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Look at secondary schools too</span></span>
<span><span class="va">model_lm_sec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">secondary</span> <span class="op">~</span> <span class="va">treatment</span> <span class="op">+</span> <span class="va">country</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span>,</span>
<span>                   data <span class="op">=</span> <span class="va">fpe_secondary</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df_secondary</span> <span class="op">&lt;-</span> <span class="va">fpe_secondary</span> <span class="op">%&gt;%</span> <span class="fu">distinct</span><span class="op">(</span><span class="va">country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_lm_clustered_sec</span> <span class="op">&lt;-</span> <span class="fu">lmtest</span><span class="fu">::</span><span class="fu">coeftest</span><span class="op">(</span><span class="va">model_lm_sec</span>,</span>
<span>                                           vcov <span class="op">=</span> <span class="fu">sandwich</span><span class="fu">::</span><span class="va">vcovCL</span>,</span>
<span>                                           cluster <span class="op">=</span> <span class="op">~</span><span class="va">country</span>,</span>
<span>                                           df <span class="op">=</span> <span class="va">df_secondary</span> <span class="op">-</span> <span class="fl">1</span>,</span>
<span>                                           save <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_lm_robust_sec</span> <span class="op">&lt;-</span> <span class="fu">lm_robust</span><span class="op">(</span><span class="va">secondary</span> <span class="op">~</span> <span class="va">treatment</span>,</span>
<span>                                 fixed_effects <span class="op">=</span> <span class="op">~</span> <span class="va">country</span> <span class="op">+</span> <span class="va">year</span>,</span>
<span>                                 data <span class="op">=</span> <span class="va">fpe_secondary</span>,</span>
<span>                                 clusters <span class="op">=</span> <span class="va">country</span>, se_type <span class="op">=</span> <span class="st">"stata"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_feols_sec</span> <span class="op">&lt;-</span> <span class="fu">feols</span><span class="op">(</span><span class="va">secondary</span> <span class="op">~</span> <span class="va">treatment</span> <span class="op">|</span> <span class="va">country</span> <span class="op">+</span> <span class="va">year</span>,</span>
<span>                         data <span class="op">=</span> <span class="va">fpe_secondary</span>,</span>
<span>                         cluster <span class="op">=</span> <span class="op">~</span> <span class="va">country</span>,</span>
<span>                         dof <span class="op">=</span> <span class="fu">dof</span><span class="op">(</span>fixef.K <span class="op">=</span> <span class="st">"full"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define the goodness-of-fit stats to include</span></span>
<span><span class="va">gof_stuff</span> <span class="op">&lt;-</span> <span class="fu">tribble</span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">raw</span>, <span class="op">~</span><span class="va">clean</span>, <span class="op">~</span><span class="va">fmt</span>,</span>
<span>  <span class="st">"nobs"</span>, <span class="st">"N"</span>, <span class="fl">0</span>,</span>
<span>  <span class="st">"r.squared"</span>, <span class="st">"R²"</span>, <span class="fl">3</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define extra rows at the end of the table</span></span>
<span><span class="va">extra_rows</span> <span class="op">&lt;-</span> <span class="fu">tribble</span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">term</span>, <span class="op">~</span><span class="va">a</span>, <span class="op">~</span><span class="va">b</span>, <span class="op">~</span><span class="va">c</span>, <span class="op">~</span><span class="va">d</span>, <span class="op">~</span><span class="va">e</span>, <span class="op">~</span><span class="va">f</span>,</span>
<span>  <span class="st">"Country fixed effects"</span>, <span class="st">"•"</span>, <span class="st">"•"</span>, <span class="st">"•"</span>, <span class="st">"•"</span>, <span class="st">"•"</span>, <span class="st">"•"</span>,</span>
<span>  <span class="st">"Year fixed effects"</span>, <span class="st">"•"</span>, <span class="st">"•"</span>, <span class="st">"•"</span>, <span class="st">"•"</span>, <span class="st">"•"</span>, <span class="st">"•"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">modelsummary</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"&lt;code&gt;lm()&lt;/code&gt;"</span> <span class="op">=</span> <span class="va">model_lm_clustered</span>,</span>
<span>                  <span class="st">"&lt;code&gt;lm_robust()&lt;/code&gt;"</span> <span class="op">=</span> <span class="va">model_lm_robust</span>,</span>
<span>                  <span class="st">"&lt;code&gt;feols()&lt;/code&gt;"</span> <span class="op">=</span> <span class="va">model_feols</span>,</span>
<span>                  <span class="st">"&lt;code&gt;lm()&lt;/code&gt;"</span> <span class="op">=</span> <span class="va">model_lm_clustered_sec</span>,</span>
<span>                  <span class="st">"&lt;code&gt;lm_robust()&lt;/code&gt;"</span> <span class="op">=</span> <span class="va">model_lm_robust_sec</span>,</span>
<span>                  <span class="st">"&lt;code&gt;feols()&lt;/code&gt;"</span> <span class="op">=</span> <span class="va">model_feols_sec</span><span class="op">)</span>,</span>
<span>             coef_rename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"treatment"</span> <span class="op">=</span> <span class="st">"Treatment"</span><span class="op">)</span>,</span>
<span>             estimate <span class="op">=</span> <span class="st">"{estimate}"</span>,</span>
<span>             statistic <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"s.e. = {std.error}"</span>, <span class="st">"p = {p.value}"</span><span class="op">)</span>,</span>
<span>             coef_omit <span class="op">=</span> <span class="st">"^country|^factor|Intercept"</span>,</span>
<span>             gof_map <span class="op">=</span> <span class="va">gof_stuff</span>,</span>
<span>             add_rows <span class="op">=</span> <span class="va">extra_rows</span>,</span>
<span>             escape <span class="op">=</span> <span class="cn">FALSE</span>, output <span class="op">=</span> <span class="st">"kableExtra"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">add_header_above</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">" "</span> <span class="op">=</span> <span class="fl">1</span>, <span class="st">"Primary enrollment"</span> <span class="op">=</span> <span class="fl">3</span>, <span class="st">"Secondary enrollment"</span> <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">kable_styling</span><span class="op">(</span>htmltable_class <span class="op">=</span> <span class="st">"table table-sm"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<table class="table table-sm caption-top table-striped small" data-quarto-postprocess="true">
<colgroup>
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
</colgroup>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th" style="text-align: left; empty-cells: hide; border-bottom: hidden;"></th>
<th colspan="3" data-quarto-table-cell-role="th" style="text-align: center; border-bottom: hidden; padding-bottom: 0; padding-left: 3px; padding-right: 3px;"><div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
Primary enrollment
</div></th>
<th colspan="3" data-quarto-table-cell-role="th" style="text-align: center; border-bottom: hidden; padding-bottom: 0; padding-left: 3px; padding-right: 3px;"><div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
Secondary enrollment
</div></th>
</tr>
<tr class="even">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: center;" data-quarto-table-cell-role="th"><code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code></th>
<th style="text-align: center;" data-quarto-table-cell-role="th"><code>lm_robust()</code></th>
<th style="text-align: center;" data-quarto-table-cell-role="th"><code>feols()</code></th>
<th style="text-align: center;" data-quarto-table-cell-role="th"><code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code></th>
<th style="text-align: center;" data-quarto-table-cell-role="th"><code>lm_robust()</code></th>
<th style="text-align: center;" data-quarto-table-cell-role="th"><code>feols()</code></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Treatment</td>
<td style="text-align: center;">20.428</td>
<td style="text-align: center;">20.428</td>
<td style="text-align: center;">20.428</td>
<td style="text-align: center;">−0.468</td>
<td style="text-align: center;">−0.468</td>
<td style="text-align: center;">−0.468</td>
</tr>
<tr class="even">
<td style="text-align: left;"></td>
<td style="text-align: center;">s.e. = 9.120</td>
<td style="text-align: center;">s.e. = 9.120</td>
<td style="text-align: center;">s.e. = 8.979</td>
<td style="text-align: center;">s.e. = 3.081</td>
<td style="text-align: center;">s.e. = 3.081</td>
<td style="text-align: center;">s.e. = 3.016</td>
</tr>
<tr class="odd">
<td style="text-align: left; box-shadow: 0px 1.5px;"></td>
<td style="text-align: center; box-shadow: 0px 1.5px;">p = 0.042</td>
<td style="text-align: center; box-shadow: 0px 1.5px;">p = 0.026</td>
<td style="text-align: center; box-shadow: 0px 1.5px;">p = 0.039</td>
<td style="text-align: center; box-shadow: 0px 1.5px;">p = 0.881</td>
<td style="text-align: center; box-shadow: 0px 1.5px;">p = 0.879</td>
<td style="text-align: center; box-shadow: 0px 1.5px;">p = 0.879</td>
</tr>
<tr class="even">
<td style="text-align: left;">N</td>
<td style="text-align: center;">490</td>
<td style="text-align: center;">490</td>
<td style="text-align: center;">490</td>
<td style="text-align: center;">369</td>
<td style="text-align: center;">369</td>
<td style="text-align: center;">369</td>
</tr>
<tr class="odd">
<td style="text-align: left;">R²</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">0.768</td>
<td style="text-align: center;">0.768</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">0.942</td>
<td style="text-align: center;">0.942</td>
</tr>
<tr class="even">
<td style="text-align: left;">Country fixed effects</td>
<td style="text-align: center;">•</td>
<td style="text-align: center;">•</td>
<td style="text-align: center;">•</td>
<td style="text-align: center;">•</td>
<td style="text-align: center;">•</td>
<td style="text-align: center;">•</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Year fixed effects</td>
<td style="text-align: center;">•</td>
<td style="text-align: center;">•</td>
<td style="text-align: center;">•</td>
<td style="text-align: center;">•</td>
<td style="text-align: center;">•</td>
<td style="text-align: center;">•</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>All these models show the same result: <strong>eliminating primary school fees caused primary school enrollment to increase by 20.4 percentage points.</strong> That’s astounding! Removing these fees doesn’t have any effect on secondary enrollment though.</p>
</section><section id="twfe-estimate-with-residualized-treatment-weights" class="level3"><h3 class="anchored" data-anchor-id="twfe-estimate-with-residualized-treatment-weights">TWFE estimate with residualized treatment weights</h3>
<p>These regressions are simple enough to run with <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> or <code>lm_robust()</code>, but there’s an issue with differential timing here. These 15 countries each passed laws eliminating fees in different years:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">plot_fpe_start</span> <span class="op">&lt;-</span> <span class="va">fpe_raw</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">year</span> <span class="op">==</span> <span class="va">fpe_year</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="va">fpe_year</span>, <span class="va">country</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>country <span class="op">=</span> <span class="fu">fct_inorder</span><span class="op">(</span><span class="va">country</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">plot_fpe_start</span>, <span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="fu">fct_rev</span><span class="op">(</span><span class="va">country</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_segment</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">fpe_year</span>, xend <span class="op">=</span> <span class="fl">2015</span>, yend <span class="op">=</span> <span class="va">country</span><span class="op">)</span>,</span>
<span>               size <span class="op">=</span> <span class="fl">3</span>, color <span class="op">=</span> <span class="st">"#D6EB52"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_text</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">fpe_year</span> <span class="op">+</span> <span class="fl">0.2</span><span class="op">)</span>, label <span class="op">=</span> <span class="st">"▶"</span>, family <span class="op">=</span> <span class="st">"Arial Unicode MS"</span>,</span>
<span>            size <span class="op">=</span> <span class="fl">8</span>, color <span class="op">=</span> <span class="st">"#A4BD0A"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Year free primary education implemented"</span>, y <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_clean</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">## Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.</span></span>
<span><span class="co">## ℹ Please use `linewidth` instead.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/show-fpe-start-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:75.0%"></p>
</figure>
</div>
</div>
</div>
<p>This timing could cause problems. To see these issues, let’s calculate the ATE (<span class="math inline">\(\beta\)</span>) with that fancy schmancy Frisch-Waugh-Lovell theorem with residualized treatment weights. There’s one key difference here when calculating the residuals though. With the simple model earlier, the treatment residuals were just <span class="math inline">\(D_i - \bar{D}\)</span>, or the residuals from <code>lm(treatment ~ 1)</code>. In TWFE situations, though, treatment residuals need to account for both country and year fixed effects, or <code>lm(treatment ~ country + year)</code>:</p>
<p><span class="math display">\[
\color{#0599B0}{\beta^{\text{TWFE}}} \color{black}{= \sum_{it}} \color{#FFA615}{Y_{it}} \color{black} \left( \frac{\color{#353D03}{\tilde{D}_{it}}}{\sum_{it} \color{#353D03}{\tilde{D}_{it}}^2} \right)
\]</span></p>
<p>Or, with code:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">trt_resid_primary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">treatment</span> <span class="op">~</span> <span class="va">country</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">fpe_primary</span><span class="op">)</span></span>
<span><span class="va">trt_resid_secondary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">treatment</span> <span class="op">~</span> <span class="va">country</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">fpe_secondary</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fpe_primary_weights</span> <span class="op">&lt;-</span> <span class="va">fpe_primary</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>treatment_resid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span><span class="op">(</span><span class="va">trt_resid_primary</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>treatment_weight <span class="op">=</span> <span class="va">treatment_resid</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">treatment_resid</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fpe_secondary_weights</span> <span class="op">&lt;-</span> <span class="va">fpe_secondary</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>treatment_resid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span><span class="op">(</span><span class="va">trt_resid_secondary</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>treatment_weight <span class="op">=</span> <span class="va">treatment_resid</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">treatment_resid</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fpe_primary_weights</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span>twfe_beta_primary <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">primary</span> <span class="op">*</span> <span class="va">treatment_weight</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 1 × 1</span></span>
<span><span class="co">##   twfe_beta_primary</span></span>
<span><span class="co">##               &lt;dbl&gt;</span></span>
<span><span class="co">## 1              20.4</span></span>
<span></span>
<span><span class="va">fpe_secondary_weights</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span>twfe_beta_secondary <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">secondary</span> <span class="op">*</span> <span class="va">treatment_weight</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 1 × 1</span></span>
<span><span class="co">##   twfe_beta_secondary</span></span>
<span><span class="co">##                 &lt;dbl&gt;</span></span>
<span><span class="co">## 1              -0.468</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Whoa! It still works this way. This still blows my mind every time.</p>
</section></section><section id="jakielas-diagnostics" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="jakielas-diagnostics">Jakiela’s diagnostics</h2>
<p>However, because of the differential treatment timing, there are some issues with weighting. Remember from the simple example with fake data that observations in the treatment group typically have positive treatment weights, while those in the comparison/control group have negative weights. With TWFE, some observations’ weights switch directions. There are systematic reasons for this. According to <span class="citation" data-cites="Jakiela:2021">Jakiela (<a href="#ref-Jakiela:2021" role="doc-biblioref">2021, 5</a>)</span>, negative weights in treated observations are more likely in (1) early adopter countries, since the country-level treatment mean is high, and (2) later years, since the year-level treatment mean is higher.</p>
<p>Having negative weights on treated observations isn’t necessarily bad! It’s often just a mathematical artefact, and if you have (1) enough never-treated observations and (2) enough pre-treatment data, and if (3) the treatment effects are homogenous across all countries, it won’t be a problem. But if you don’t have enough data, your results will be biased and distorted for later years and for early adopters.</p>
<p>Starting in section 3 of her paper, Jakiela presents a set of diagnostics to see how bad these distortions might be. We need to answer two questions:</p>
<ol type="1">
<li>Do any treated units get negative weight when calculating <span class="math inline">\(\beta^{\text{TWFE}}\)</span>? Check this by looking at the weights</li>
<li>Can we reject the hypothesis that the treatment effects are homogenous? Check this by looking at the relationship between <span class="math inline">\(\tilde{Y}_{it}\)</span> and <span class="math inline">\(\tilde{D}_{it}\)</span>. The slope shouldn’t be different.</li>
</ol>
<section id="do-treated-observations-receive-negative-weights" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="do-treated-observations-receive-negative-weights">3.1: Do treated observations receive negative weights?</h3>
<p>For this first diagnostic, we need to investigate patterns in the residualized weights. Some of the treated country-year observations have negative weight:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Total treated in primary data</span></span>
<span><span class="va">n_treated_primary</span> <span class="op">&lt;-</span> <span class="va">fpe_primary_weights</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">treatment</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Total treated in secondary data</span></span>
<span><span class="va">n_treated_secondary</span> <span class="op">&lt;-</span> <span class="va">fpe_secondary_weights</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">treatment</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Negatively weighted treated observations in the primary data</span></span>
<span><span class="va">n_treated_negative_primary</span> <span class="op">&lt;-</span> <span class="va">fpe_primary_weights</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">treatment_weight</span> <span class="op">&lt;</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">treatment</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">n_treated_negative_primary</span></span>
<span><span class="co">## [1] 50</span></span>
<span><span class="va">n_treated_negative_primary</span> <span class="op">/</span> <span class="va">n_treated_primary</span></span>
<span><span class="co">## [1] 0.259</span></span>
<span></span>
<span><span class="co"># Negatively weighted treated observations in the secondary data</span></span>
<span><span class="va">n_treated_negative_secondary</span> <span class="op">&lt;-</span> <span class="va">fpe_secondary_weights</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">treatment_weight</span> <span class="op">&lt;</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">treatment</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">n_treated_negative_secondary</span></span>
<span><span class="co">## [1] 36</span></span>
<span><span class="va">n_treated_negative_secondary</span> <span class="op">/</span> <span class="va">n_treated_secondary</span></span>
<span><span class="co">## [1] 0.261</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Roughly a quarter of the treated observations in both the primary and secondary enrollment data are negatively weighted. That might be bad.</p>
<p>We can look at the distribution of these weights too:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">plot_weights_primary</span> <span class="op">&lt;-</span> <span class="va">fpe_primary_weights</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>treatment_fct <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">treatment</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Untreated"</span>, <span class="st">"Treated"</span><span class="op">)</span>, ordered <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>oh_no <span class="op">=</span> <span class="op">(</span><span class="va">treatment</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">treatment_weight</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">|</span> <span class="op">(</span><span class="va">treatment</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">treatment_weight</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_weights_secondary</span> <span class="op">&lt;-</span> <span class="va">fpe_secondary_weights</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>treatment_fct <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">treatment</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Untreated"</span>, <span class="st">"Treated"</span><span class="op">)</span>, ordered <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>oh_no <span class="op">=</span> <span class="op">(</span><span class="va">treatment</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">treatment_weight</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">|</span> <span class="op">(</span><span class="va">treatment</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">treatment_weight</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">hist_primary</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">plot_weights_primary</span>,</span>
<span>                       <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">treatment_weight</span>, fill <span class="op">=</span> <span class="va">treatment_fct</span>, alpha <span class="op">=</span> <span class="va">oh_no</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span>binwidth <span class="op">=</span> <span class="fl">0.002</span>, color <span class="op">=</span> <span class="st">"white"</span>, boundary <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                 position <span class="op">=</span> <span class="fu">position_identity</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span>, color <span class="op">=</span> <span class="st">"#FF4136"</span>, size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_alpha_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.6</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_d</span><span class="op">(</span>option <span class="op">=</span> <span class="st">"rocket"</span>, begin <span class="op">=</span> <span class="fl">0.2</span>, end <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Residualized treatment"</span>, y <span class="op">=</span> <span class="st">"Count"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"Primary school enrollment"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"none"</span>, alpha <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">treatment_fct</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_clean</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">hist_secondary</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">plot_weights_secondary</span>,</span>
<span>                         <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">treatment_weight</span>, fill <span class="op">=</span> <span class="va">treatment_fct</span>, alpha <span class="op">=</span> <span class="va">oh_no</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span>binwidth <span class="op">=</span> <span class="fl">0.002</span>, color <span class="op">=</span> <span class="st">"white"</span>, boundary <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                 position <span class="op">=</span> <span class="fu">position_identity</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span>, color <span class="op">=</span> <span class="st">"#FF4136"</span>, size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_alpha_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.6</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_d</span><span class="op">(</span>option <span class="op">=</span> <span class="st">"rocket"</span>, begin <span class="op">=</span> <span class="fl">0.2</span>, end <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Residualized treatment"</span>, y <span class="op">=</span> <span class="st">"Count"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"Secondary school enrollment"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"none"</span>, alpha <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">treatment_fct</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_clean</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">hist_primary</span> <span class="op">+</span> <span class="va">hist_secondary</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/show-weights-hist-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page-inset-right" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>These histograms confirm the proportions we found earlier—about 25% of the treated observations have negative weights.</p>
<p>Which treated country-years are getting these negative weights, though? According to Jakiela, early adopters and later years are more likely to have this switch happen. Let’s make another plot:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">plot_waffle_primary</span> <span class="op">&lt;-</span> <span class="va">fpe_primary_weights</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>weight_fill <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span></span>
<span>    <span class="va">treatment_resid</span> <span class="op">&lt;</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">treatment</span> <span class="op">~</span> <span class="st">"Treatment observations, negative weight"</span>,</span>
<span>    <span class="va">treatment_resid</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">treatment</span> <span class="op">~</span> <span class="st">"Treatment observations, positive weight"</span>,</span>
<span>    <span class="op">!</span><span class="va">treatment</span> <span class="op">~</span> <span class="st">"Comparison observations"</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="va">fpe_year</span><span class="op">)</span>, <span class="fu">desc</span><span class="op">(</span><span class="va">country</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>country <span class="op">=</span> <span class="fu">fct_inorder</span><span class="op">(</span><span class="va">country</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>weight_fill <span class="op">=</span> <span class="fu">fct_inorder</span><span class="op">(</span><span class="va">weight_fill</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_waffle_secondary</span> <span class="op">&lt;-</span> <span class="va">fpe_secondary_weights</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>weight_fill <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span></span>
<span>    <span class="va">treatment_resid</span> <span class="op">&lt;</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">treatment</span> <span class="op">~</span> <span class="st">"Treatment observations, negative weight"</span>,</span>
<span>    <span class="va">treatment_resid</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">treatment</span> <span class="op">~</span> <span class="st">"Treatment observations, positive weight"</span>,</span>
<span>    <span class="op">!</span><span class="va">treatment</span> <span class="op">~</span> <span class="st">"Comparison observations"</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="va">fpe_year</span><span class="op">)</span>, <span class="fu">desc</span><span class="op">(</span><span class="va">country</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>country <span class="op">=</span> <span class="fu">fct_inorder</span><span class="op">(</span><span class="va">country</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>weight_fill <span class="op">=</span> <span class="fu">fct_inorder</span><span class="op">(</span><span class="va">weight_fill</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">waffle_primary</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">plot_waffle_primary</span>,</span>
<span>                         <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span>, y <span class="op">=</span> <span class="va">country</span>, fill <span class="op">=</span> <span class="va">weight_fill</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_tile</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"white"</span>, size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"grey50"</span>, <span class="st">"#0074D9"</span>, <span class="st">"#FF4136"</span><span class="op">)</span>,</span>
<span>                    guide <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>reverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>                    name <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu">expansion</span><span class="op">(</span>add <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>                     breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1980</span>, <span class="fl">2015</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="cn">NULL</span>, y <span class="op">=</span> <span class="cn">NULL</span>, title <span class="op">=</span> <span class="st">"Primary school enrollment"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_equal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_clean</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>        panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>        legend.key.size <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0.8</span>, <span class="st">"lines"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">waffle_secondary</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">plot_waffle_secondary</span>,</span>
<span>                         <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span>, y <span class="op">=</span> <span class="va">country</span>, fill <span class="op">=</span> <span class="va">weight_fill</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_tile</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"white"</span>, size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"grey50"</span>, <span class="st">"#0074D9"</span>, <span class="st">"#FF4136"</span><span class="op">)</span>,</span>
<span>                    guide <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>reverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>                    name <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu">expansion</span><span class="op">(</span>add <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>                     breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1980</span>, <span class="fl">2015</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="cn">NULL</span>, y <span class="op">=</span> <span class="cn">NULL</span>, title <span class="op">=</span> <span class="st">"Secondary school enrollment"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_equal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_clean</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>        panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>        legend.key.size <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0.8</span>, <span class="st">"lines"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">waffle_primary</span> <span class="op">/</span> <span class="va">waffle_secondary</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/show-weight-waffle-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page-inset-right" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>And that is indeed the case! Malawi, Ethiopia, Ghana, Uganda, and Cameroon all eliminated fees before 2000, and they start getting negative weights after 2005.</p>
</section><section id="testing-the-homogeneity-assumption-directly" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="testing-the-homogeneity-assumption-directly">3.2: Testing the homogeneity assumption directly</h3>
<p>We thus have issues with negative weighting here for early adopting countries and later country-years. However, as long as the treatment effects are homogenous—or that the elimination of school fees has the same effect across time and country—this negative weighting isn’t an issue. If treatment effects are heterogenous—especially if the effects change over time within treated countries—the TWFE estimate will be severely biased.</p>
<p>Jakiela’s second diagnostic tests this assumption of homogeneity based on the mathematical relationship between the residuals of the outcome variable (<code>$\tilde{Y}_{it}$</code>) and the residuals of the treatment variable (<code>$\tilde{D}_{it}$</code>). Essentially, if there’s no difference in slopes across treated and untreated observations in a regression of <code>$\tilde{Y}_{it} = \tilde{D}_{it}$</code>, there’s no evidence for heterogeneity and all is well.</p>
<p>This wasn’t intuitive for me since I’m not a real econometrician, so I had to dig into the math to try to wrap my head around it, and I’m still only like 80% sure I’ve got it :)</p>
<p>We can think of the outcome <span class="math inline">\(Y_{it}\)</span> as a combination of three different moving parts: (1) an initial baseline value for each country, or <span class="math inline">\(\mu_{i}\)</span>, (2) a constant change in each additional year in the absence of treatment (i.e.&nbsp;what would naturally happen over time regardless of an intervention), or <span class="math inline">\(\eta_t\)</span>, and (3) a homogenous treatment effect, or <span class="math inline">\(\delta\)</span> (doesn’t have subscripts for <span class="math inline">\(i\)</span> or <span class="math inline">\(t\)</span>—it’s the same across year and country):</p>
<p><span class="math display">\[
\color{gray}{\overbrace{\color{#FFA615}{Y_{it}}}^{\text{Outcome}}} = \color{gray}{\overbrace{\color{black}{\mu_i}}^{\substack{\text{Baseline} \\ \text{outcome} \\ \text{at } t = 1}}} + \color{black} \sum_{\tau = 1}^t  \color{gray}{\overbrace{\color{black}{\eta_t}}^{\substack{\text{Global} \\ \text{time} \\ \text{trend}}}} + \color{gray}{\overbrace{\color{black}{\delta}}^{\substack{\text{Homogenous} \\ \text{treatment} \\ \text{effect}}}} \color{#A4BD0A}{D_{it}}
\]</span></p>
<p>This all makes perfect sense is is nice and intuitive. It’s how I typically generate fake data too (see the <code>outcome_baseline</code> up at the beginning of this post, for instance) and it’s a neat way of thinking about the separate components of a data generating process.</p>
<p>According to Jakiela, if the treatment effect <span class="math inline">\(\delta\)</span> is truly homogenous over time and country, the residuals of the outcome (i.e.&nbsp;the residuals from a model like <code>lm(outcome ~ country + year)</code>, or <span class="math inline">\(\tilde{Y}_{it}\)</span>) should have a linear relationship to the residualized treatment (i.e.&nbsp;the residuals from a model like <code>lm(treatment ~ country + year)</code>, or <span class="math inline">\(\delta\tilde{D}_{it}\)</span>).</p>
<p>Again, due to my non-econometricianness, this idea that <span class="math inline">\(\tilde{Y}_{it}\)</span> should be related to <span class="math inline">\(\delta\tilde{D}_{it}\)</span> didn’t click for me until I thought about this formula in more regression-y terms. Consider this pseudo-regression equation:</p>
<p><span class="math display">\[
\overbrace{Y_{it}}^{\text{Outcome}} = \overbrace{\alpha_i}^{\text{Intercept}} + \overbrace{\beta_t}^{\text{Slope / trend}} + \overbrace{\epsilon_{it}}^{\text{Residuals}}
\]</span></p>
<p>Here, if we run a regression like <code>lm(outcome ~ country + year)</code>, the intercept <span class="math inline">\(\alpha_i\)</span> is analogous to <span class="math inline">\(\mu_i\)</span>, the slope <span class="math inline">\(\beta_t\)</span> is like <span class="math inline">\(\eta_t\)</span>, and whatever’s leftover (i.e.&nbsp;<span class="math inline">\(\epsilon_{it}\)</span>, or the residualized outcome <span class="math inline">\(\tilde{Y}_{it}\)</span>) is similar to <span class="math inline">\(\delta D_{it}\)</span>. <span class="math inline">\(\delta D_{it}\)</span> isn’t the same as <span class="math inline">\(\delta \tilde{D}_{it}\)</span>, but we can calculate the residualized treatment the same way by removing country and year effects (like <code>lm(treatment ~ country + year)</code>). Basically, by residualizing both the treatment and outcome, and thus removing country and time effects (or the baseline country effect <span class="math inline">\(\mu_i\)</span> and the time trend <span class="math inline">\(\eta_t\)</span>) from each, the residuals that remain are related to <span class="math inline">\(\delta\)</span>.</p>
<p>As long as <span class="math inline">\(\delta\)</span> is constant across time and country—or as long as the effect is homogenous—it should show up equally in the residuals for both the outcome and treatment for both treated and untreated observations. (I THINK! I’M NOT SURE ABOUT THIS)</p>
<p>We already calculated the treatment residuals (or <span class="math inline">\(\tilde{D}_{it}\)</span>) when we looked at treatment weights earlier, so now we just need to calculate the outcome residuals (<span class="math inline">\(\tilde{Y}_{it}\)</span>). We can then see if the relationship between <span class="math inline">\(\tilde{D}_{it}\)</span> and <span class="math inline">\(\tilde{D}_{it}\)</span> looks the same for treated and untreated observations—the slopes in the two groups should be statistically indistinguishable from each other.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Build models for the residualized outcomes</span></span>
<span><span class="va">out_resid_primary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">primary</span> <span class="op">~</span> <span class="va">country</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">fpe_primary</span><span class="op">)</span></span>
<span><span class="va">out_resid_secondary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">secondary</span> <span class="op">~</span> <span class="va">country</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">fpe_secondary</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add residuals to data with weights</span></span>
<span><span class="va">fpe_primary_weights</span> <span class="op">&lt;-</span> <span class="va">fpe_primary_weights</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>out_resid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span><span class="op">(</span><span class="va">out_resid_primary</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fpe_secondary_weights</span> <span class="op">&lt;-</span> <span class="va">fpe_secondary_weights</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>out_resid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span><span class="op">(</span><span class="va">out_resid_secondary</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can check the similarity of these slopes a couple different ways. First, let’s plot the residuals:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">plot_out_trt_primary</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">fpe_primary_weights</span>,</span>
<span>                               <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">treatment_resid</span>, y <span class="op">=</span> <span class="va">out_resid</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">treatment</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.75</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_smooth</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>linetype <span class="op">=</span> <span class="st">"Loess"</span><span class="op">)</span>, method <span class="op">=</span> <span class="st">"loess"</span>, size <span class="op">=</span> <span class="fl">1</span>, se <span class="op">=</span> <span class="cn">FALSE</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_smooth</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>linetype <span class="op">=</span> <span class="st">"OLS"</span><span class="op">)</span>, method <span class="op">=</span> <span class="st">"lm"</span>, se <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_viridis_d</span><span class="op">(</span>option <span class="op">=</span> <span class="st">"rocket"</span>, begin <span class="op">=</span> <span class="fl">0.2</span>, end <span class="op">=</span> <span class="fl">0.8</span>,</span>
<span>                        labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Untreated"</span>, <span class="st">"Treated"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_linetype_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"OLS"</span> <span class="op">=</span> <span class="st">"solid"</span>, <span class="st">"Loess"</span> <span class="op">=</span> <span class="st">"21"</span><span class="op">)</span>,</span>
<span>                        guide <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"grey30"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Residualized treatment"</span>, y <span class="op">=</span> <span class="st">"Residualized outcome"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"Primary school enrollment"</span>, color <span class="op">=</span> <span class="cn">NULL</span>, linetype <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_clean</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_out_trt_secondary</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">fpe_secondary_weights</span>,</span>
<span>                                 <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">treatment_resid</span>, y <span class="op">=</span> <span class="va">out_resid</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">treatment</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.75</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_smooth</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>linetype <span class="op">=</span> <span class="st">"Loess"</span><span class="op">)</span>, method <span class="op">=</span> <span class="st">"loess"</span>, size <span class="op">=</span> <span class="fl">1</span>, se <span class="op">=</span> <span class="cn">FALSE</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_smooth</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>linetype <span class="op">=</span> <span class="st">"OLS"</span><span class="op">)</span>, method <span class="op">=</span> <span class="st">"lm"</span>, se <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_viridis_d</span><span class="op">(</span>option <span class="op">=</span> <span class="st">"rocket"</span>, begin <span class="op">=</span> <span class="fl">0.2</span>, end <span class="op">=</span> <span class="fl">0.8</span>,</span>
<span>                        labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Untreated"</span>, <span class="st">"Treated"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_linetype_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"OLS"</span> <span class="op">=</span> <span class="st">"solid"</span>, <span class="st">"Loess"</span> <span class="op">=</span> <span class="st">"21"</span><span class="op">)</span>,</span>
<span>                        guide <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"grey30"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Residualized treatment"</span>, y <span class="op">=</span> <span class="st">"Residualized outcome"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"Secondary school enrollment"</span>, color <span class="op">=</span> <span class="cn">NULL</span>, linetype <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_clean</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_out_trt_primary</span> <span class="op">|</span> <span class="va">plot_out_trt_secondary</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/show-outcome-trt-resid-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page-inset-right" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>For primary enrollment, the lines for treated and untreated observations look like they have similar slopes. When using Loess lines, the two groups don’t align perfectly, and the relationship between residualized treatment and residualized outcome doesn’t look perfectly linear. When secondary enrollment is the outcome, the lines for the treated and untreated groups seem to switch directions—the slope is negative for untreated observations but positive for treated. This is a bad sign for the homogeneity assumption.</p>
<p>We can statistically test if the slopes in two groups are the same or not by using an interaction term in a regression model:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">check_slopes_primary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">out_resid</span> <span class="op">~</span> <span class="va">treatment_resid</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">treatment</span><span class="op">)</span>,</span>
<span>                           data <span class="op">=</span> <span class="va">fpe_primary_weights</span><span class="op">)</span></span>
<span></span>
<span><span class="va">check_slopes_secondary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">out_resid</span> <span class="op">~</span> <span class="va">treatment_resid</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">treatment</span><span class="op">)</span>,</span>
<span>                           data <span class="op">=</span> <span class="va">fpe_secondary_weights</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">modelsummary</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"Primary enrollment"</span> <span class="op">=</span> <span class="va">check_slopes_primary</span>,</span>
<span>                  <span class="st">"Secondary enrollment"</span> <span class="op">=</span> <span class="va">check_slopes_secondary</span><span class="op">)</span>,</span>
<span>             coef_rename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"treatment_resid"</span> <span class="op">=</span> <span class="st">"Residualized treatment"</span>,</span>
<span>                             <span class="st">"factor(treatment)1"</span> <span class="op">=</span> <span class="st">"Treatment group"</span>,</span>
<span>                             <span class="st">"treatment_resid:factor(treatment)1"</span> <span class="op">=</span> <span class="st">"Treatment group × residualized treatment"</span>,</span>
<span>                             <span class="st">"(Intercept)"</span> <span class="op">=</span> <span class="st">"Intercept"</span><span class="op">)</span>,</span>
<span>             estimate <span class="op">=</span> <span class="st">"{estimate}"</span>,</span>
<span>             statistic <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"s.e. = {std.error}"</span>, <span class="st">"p = {p.value}"</span><span class="op">)</span>,</span>
<span>             gof_map <span class="op">=</span> <span class="fu">tribble</span><span class="op">(</span></span>
<span>               <span class="op">~</span><span class="va">raw</span>, <span class="op">~</span><span class="va">clean</span>, <span class="op">~</span><span class="va">fmt</span>,</span>
<span>               <span class="st">"nobs"</span>, <span class="st">"N"</span>, <span class="fl">0</span>,</span>
<span>               <span class="st">"r.squared"</span>, <span class="st">"R²"</span>, <span class="fl">3</span></span>
<span>             <span class="op">)</span>,</span>
<span>             escape <span class="op">=</span> <span class="cn">FALSE</span>, output <span class="op">=</span> <span class="st">"kableExtra"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">kable_styling</span><span class="op">(</span>htmltable_class <span class="op">=</span> <span class="st">"table table-sm"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm caption-top table-striped small" data-quarto-postprocess="true">
<thead><tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Primary enrollment</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Secondary enrollment</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Intercept</td>
<td style="text-align: center;">0.320</td>
<td style="text-align: center;">−0.202</td>
</tr>
<tr class="even">
<td style="text-align: left;"></td>
<td style="text-align: center;">s.e. = 0.894</td>
<td style="text-align: center;">s.e. = 0.276</td>
</tr>
<tr class="odd">
<td style="text-align: left;"></td>
<td style="text-align: center;">p = 0.721</td>
<td style="text-align: center;">p = 0.466</td>
</tr>
<tr class="even">
<td style="text-align: left;">Residualized treatment</td>
<td style="text-align: center;">23.761</td>
<td style="text-align: center;">−2.902</td>
</tr>
<tr class="odd">
<td style="text-align: left;"></td>
<td style="text-align: center;">s.e. = 3.968</td>
<td style="text-align: center;">s.e. = 1.357</td>
</tr>
<tr class="even">
<td style="text-align: left;"></td>
<td style="text-align: center;">p =</td>
<td style="text-align: center;">p = 0.033</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Treatment group</td>
<td style="text-align: center;">0.341</td>
<td style="text-align: center;">−0.189</td>
</tr>
<tr class="even">
<td style="text-align: left;"></td>
<td style="text-align: center;">s.e. = 1.506</td>
<td style="text-align: center;">s.e. = 0.473</td>
</tr>
<tr class="odd">
<td style="text-align: left;"></td>
<td style="text-align: center;">p = 0.821</td>
<td style="text-align: center;">p = 0.690</td>
</tr>
<tr class="even">
<td style="text-align: left;">Treatment group × residualized treatment</td>
<td style="text-align: center;">−7.806</td>
<td style="text-align: center;">5.248</td>
</tr>
<tr class="odd">
<td style="text-align: left;"></td>
<td style="text-align: center;">s.e. = 6.073</td>
<td style="text-align: center;">s.e. = 1.993</td>
</tr>
<tr class="even">
<td style="text-align: left; box-shadow: 0px 1.5px;"></td>
<td style="text-align: center; box-shadow: 0px 1.5px;">p = 0.199</td>
<td style="text-align: center; box-shadow: 0px 1.5px;">p = 0.009</td>
</tr>
<tr class="odd">
<td style="text-align: left;">N</td>
<td style="text-align: center;">490</td>
<td style="text-align: center;">369</td>
</tr>
<tr class="even">
<td style="text-align: left;">R²</td>
<td style="text-align: center;">0.114</td>
<td style="text-align: center;">0.019</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The coefficient for “Treatment group × residualized treatment” shows the change in slope between the two groups. For primary enrollment, being in the treatment group reduces the slope by 7.8 (so from 23.761 to 15.961), but the standard errors around that change are huge and the p-value is not significant (p = 0.199). For secondary enrollment, though, being in the treatment group increases the slope by 5.3 (from -2.9 to positive 2.4), and that change is statistically significant (p = 0.009).</p>
<p>So for primary enrollment, there’s not enough evidence to reject the hypothesis that the slopes are the same (or the hypothesis that the effect is homogenous), so we’ll treat the effect as homogenous. Yay! That means we don’t need to worry so much about the negatively-weighted treated country-years. For secondary enrollment, though, there’s pretty strong evidence that the slopes aren’t the same, which means the treatment effect is likely heterogenous, which also means that the treated country-years with negative weights are biasing the results substantially and we should thus be worried.</p>
<p>When there are heterogenous treatment effects, we don’t need to give up! This is what <span class="citation" data-cites="CallawaySantAnna:2020">Callaway and Sant’Anna (<a href="#ref-CallawaySantAnna:2020" role="doc-biblioref">2020</a>)</span> and <span class="citation" data-cites="SunAbraham:2020">Sun and Abraham (<a href="#ref-SunAbraham:2020" role="doc-biblioref">2020</a>)</span> show how to do in their papers (and see <span class="citation" data-cites="BakerLarckerWang:2021">Baker, Larcker, and Wang (<a href="#ref-BakerLarckerWang:2021" role="doc-biblioref">2021</a>)</span> for a general overview of those approaches). If treatment effects are indeed homogenous, there’s no need to turn to these fancier TWFE estimators—but if they are heterogenous, there are new tools that help.</p>
</section></section><section id="jakielas-robustness-checks" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="jakielas-robustness-checks">Jakiela’s robustness checks</h2>
<p>Now that we’ve run those two diagnostics (checked for negative weights in treated units and checked for treatment effect homogeneity), we can do some neat robustness checks to see how badly these negative weight issues bias the TWFE estimate.</p>
<p>As long as we assume that treatment effects are homogenous (remember that <span class="math inline">\(\delta\)</span> in the equation above doesn’t have subscripts for country or year), we can safely drop some observations from the data and still find the same result. We can also strategically drop observations to check if negative treatment weights influence the results. Jakiela presents three different robustness checks that all involve dropping different categories of observations:</p>
<ul>
<li>Exclude later years</li>
<li>Limit how many post-treatment years are kept</li>
<li>Exclude individual countries</li>
</ul>
<section id="exclude-later-years" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="exclude-later-years">Exclude later years</h3>
<p>Since negative treatment weights for treated country-years are more likely to appear in later years in the data, we can drop those later years and see how the treatment effect changes.</p>
<p>For primary schools, if we cut the data off at 2000, the treatment effect is 31.8 instead of the 20.4 we’ve been seeing with the full data. That estimate is higher, but it also has wider errors. Both the coefficient and the errors shrink as we add more years to the data, and the estimate eventually settles on ≈20 by 2005, which is also when negatively weighted treated rows start appearing.</p>
<p>For secondary schools, the treatment effect hovers around 0 is never statistically significant regardless of the cutoff year.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">different_max_years_primary</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span>end_year <span class="op">=</span> <span class="fl">2000</span><span class="op">:</span><span class="fl">2015</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co"># Nest a filtered dataset in a cell for each year</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>data <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">end_year</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">fpe_primary</span>, <span class="va">year</span> <span class="op">&lt;=</span> <span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co"># Calculate the TWFE estimate for each dataset</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>model <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">data</span>, <span class="op">~</span><span class="fu">lm_robust</span><span class="op">(</span><span class="va">primary</span> <span class="op">~</span> <span class="va">treatment</span>,</span>
<span>                                      fixed_effects <span class="op">=</span> <span class="op">~</span> <span class="va">country</span> <span class="op">+</span> <span class="va">year</span>,</span>
<span>                                      data <span class="op">=</span> <span class="va">.</span>,</span>
<span>                                      clusters <span class="op">=</span> <span class="va">country</span>, se_type <span class="op">=</span> <span class="st">"stata"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co"># Extract a data frame of the results</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>tidied <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">model</span>, <span class="op">~</span><span class="fu">tidy</span><span class="op">(</span><span class="va">.</span>, conf.int <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co"># Calculate residuals and treatment weights</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>model_resid <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">data</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">treatment</span> <span class="op">~</span> <span class="va">country</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">.</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         treatment_resid <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">model_resid</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         treatment_weight <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">treatment_resid</span>, <span class="op">~</span> <span class="va">.</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">.</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate how many treated observations have negative weights</span></span>
<span><span class="va">prop_negative_primary</span> <span class="op">&lt;-</span> <span class="va">different_max_years_primary</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">unnest</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">treatment_resid</span>, <span class="va">treatment_weight</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">end_year</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span>n_treated_negative_weight <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">treatment_weight</span> <span class="op">&lt;</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">treatment</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>            n_treated <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">treatment</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>            prop_treated_negative_weight <span class="op">=</span> <span class="va">n_treated_negative_weight</span> <span class="op">/</span> <span class="va">n_treated</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>prop_nice <span class="op">=</span> <span class="fu">percent</span><span class="op">(</span><span class="va">prop_treated_negative_weight</span>, accuracy <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract tidied results for plotting</span></span>
<span><span class="va">coefs_to_plot_primary</span> <span class="op">&lt;-</span> <span class="va">different_max_years_primary</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">unnest</span><span class="op">(</span><span class="va">tidied</span><span class="op">)</span></span>
<span></span>
<span><span class="va">different_max_years_secondary</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span>end_year <span class="op">=</span> <span class="fl">2000</span><span class="op">:</span><span class="fl">2015</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>data <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">end_year</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">fpe_secondary</span>, <span class="va">year</span> <span class="op">&lt;=</span> <span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>model <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">data</span>, <span class="op">~</span><span class="fu">lm_robust</span><span class="op">(</span><span class="va">secondary</span> <span class="op">~</span> <span class="va">treatment</span>,</span>
<span>                                      fixed_effects <span class="op">=</span> <span class="op">~</span> <span class="va">country</span> <span class="op">+</span> <span class="va">year</span>,</span>
<span>                                      data <span class="op">=</span> <span class="va">.</span>,</span>
<span>                                      clusters <span class="op">=</span> <span class="va">country</span>, se_type <span class="op">=</span> <span class="st">"stata"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>tidied <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">model</span>, <span class="op">~</span><span class="fu">tidy</span><span class="op">(</span><span class="va">.</span>, conf.int <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>model_resid <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">data</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">treatment</span> <span class="op">~</span> <span class="va">country</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">.</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         treatment_resid <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">model_resid</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         treatment_weight <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">treatment_resid</span>, <span class="op">~</span> <span class="va">.</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">.</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">prop_negative_secondary</span> <span class="op">&lt;-</span> <span class="va">different_max_years_secondary</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">unnest</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">treatment_resid</span>, <span class="va">treatment_weight</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">end_year</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span>n_treated_negative_weight <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">treatment_weight</span> <span class="op">&lt;</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">treatment</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>            n_treated <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">treatment</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>            prop_treated_negative_weight <span class="op">=</span> <span class="va">n_treated_negative_weight</span> <span class="op">/</span> <span class="va">n_treated</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>prop_nice <span class="op">=</span> <span class="fu">percent</span><span class="op">(</span><span class="va">prop_treated_negative_weight</span>, accuracy <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">coefs_to_plot_secondary</span> <span class="op">&lt;-</span> <span class="va">different_max_years_secondary</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">unnest</span><span class="op">(</span><span class="va">tidied</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Coefficient plot</span></span>
<span><span class="va">ate_primary</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">coefs_to_plot_primary</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">end_year</span>, y <span class="op">=</span> <span class="va">estimate</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, color <span class="op">=</span> <span class="st">"#FF2E00"</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_pointrange</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">conf.low</span>, ymax <span class="op">=</span> <span class="va">conf.high</span><span class="op">)</span>,</span>
<span>                  color <span class="op">=</span> <span class="st">"#0599B0"</span>, size <span class="op">=</span> <span class="fl">1</span>, fatten <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="cn">NULL</span>, y <span class="op">=</span> <span class="st">"TWFE-based treatment effect"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"Primary school enrollment"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_clean</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>axis.title.x <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.text.x <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ate_secondary</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">coefs_to_plot_secondary</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">end_year</span>, y <span class="op">=</span> <span class="va">estimate</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, color <span class="op">=</span> <span class="st">"#FF2E00"</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_pointrange</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">conf.low</span>, ymax <span class="op">=</span> <span class="va">conf.high</span><span class="op">)</span>,</span>
<span>                  color <span class="op">=</span> <span class="st">"#0599B0"</span>, size <span class="op">=</span> <span class="fl">1</span>, fatten <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="cn">NULL</span>, y <span class="op">=</span> <span class="st">"TWFE-based treatment effect"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"Secondary school enrollment"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_clean</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>axis.title.x <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.text.x <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Bar plot</span></span>
<span><span class="va">prop_neg_primary</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">prop_negative_primary</span>,</span>
<span>                                  <span class="va">prop_treated_negative_weight</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>                           <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">end_year</span>, y <span class="op">=</span> <span class="va">prop_treated_negative_weight</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_col</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"#FF4136"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_text</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">prop_nice</span><span class="op">)</span>,</span>
<span>            nudge_y <span class="op">=</span> <span class="fl">0.02</span>, size <span class="op">=</span> <span class="fl">2.5</span>,</span>
<span>            family <span class="op">=</span> <span class="st">"Barlow Semi Condensed Bold"</span>, color <span class="op">=</span> <span class="st">"#FF4136"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2000</span>, <span class="fl">2015</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Last year included in data"</span>, y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"% of treated observations with negative weight"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_clean</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>panel.grid.major.y <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.text.y <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">prop_neg_secondary</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">prop_negative_secondary</span>,</span>
<span>                                    <span class="va">prop_treated_negative_weight</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>                             <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">end_year</span>, y <span class="op">=</span> <span class="va">prop_treated_negative_weight</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_col</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"#FF4136"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_text</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">prop_nice</span><span class="op">)</span>,</span>
<span>            nudge_y <span class="op">=</span> <span class="fl">0.02</span>, size <span class="op">=</span> <span class="fl">2.5</span>,</span>
<span>            family <span class="op">=</span> <span class="st">"Barlow Semi Condensed Bold"</span>, color <span class="op">=</span> <span class="st">"#FF4136"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2000</span>, <span class="fl">2015</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Last year included in data"</span>, y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"% of treated observations with negative weight"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_clean</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>panel.grid.major.y <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.text.y <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="op">(</span><span class="va">ate_primary</span> <span class="op">/</span> <span class="va">prop_neg_primary</span><span class="op">)</span> <span class="op">+</span> <span class="fu">plot_layout</span><span class="op">(</span>heights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.8</span>, <span class="fl">0.2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|</span></span>
<span>  <span class="op">(</span><span class="op">(</span><span class="va">ate_secondary</span> <span class="op">/</span> <span class="va">prop_neg_secondary</span><span class="op">)</span> <span class="op">+</span> <span class="fu">plot_layout</span><span class="op">(</span>heights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.8</span>, <span class="fl">0.2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/robust-exclude-later-years-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page-inset-right" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section><section id="change-how-many-post-treatment-years-are-kept" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="change-how-many-post-treatment-years-are-kept">Change how many post-treatment years are kept</h3>
<p>Dropping rows based on end years like this is neat, but it doesn’t take into account the differential treatment timing. Countries like Mozambique, which eliminated its fees in 2005, don’t even show up in the first few models of exclude-later-years robustness check, since those models end in 2000–2004. As an alternative, we can keep specific numbers of years post-treatment for each country. For instance, we can look at Mozambique 2, 3, 4, or 5 (and so on) years after treatment. Doing this centers all countries at <span class="math inline">\(t = 0\)</span>, rather than <span class="math inline">\(t = \text{start year}\)</span>.</p>
<p>For primary schools in this situation, the effect is smaller and not significant when only a few post-treatment years are kept, but it stabilizes at around 20 after only 5 post-treatment years, which suggests that <span class="math inline">\(\delta\)</span> is indeed homogenous—we don’t need a ton of post-treatment data to find it. For secondary schools, though, the effect remains negative and insigificant throughout every specification.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">fpe_primary_years_since</span> <span class="op">&lt;-</span> <span class="va">fpe_primary</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>years_after <span class="op">=</span> <span class="va">year</span> <span class="op">-</span> <span class="va">fpe_year</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fpe_secondary_years_since</span> <span class="op">&lt;-</span> <span class="va">fpe_secondary</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>years_after <span class="op">=</span> <span class="va">year</span> <span class="op">-</span> <span class="va">fpe_year</span><span class="op">)</span></span>
<span></span>
<span><span class="va">different_years_after_primary</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span>post_trt_years <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">22</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co"># Nest a filtered dataset in a cell for each year</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>data <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">post_trt_years</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">fpe_primary_years_since</span>, <span class="va">years_after</span> <span class="op">&lt;=</span> <span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co"># Calculate the TWFE estimate for each dataset</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>model <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">data</span>, <span class="op">~</span><span class="fu">lm_robust</span><span class="op">(</span><span class="va">primary</span> <span class="op">~</span> <span class="va">treatment</span>,</span>
<span>                                      fixed_effects <span class="op">=</span> <span class="op">~</span> <span class="va">country</span> <span class="op">+</span> <span class="va">year</span>,</span>
<span>                                      data <span class="op">=</span> <span class="va">.</span>,</span>
<span>                                      clusters <span class="op">=</span> <span class="va">country</span>, se_type <span class="op">=</span> <span class="st">"stata"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co"># Extract a data frame of the results</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>tidied <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">model</span>, <span class="op">~</span><span class="fu">tidy</span><span class="op">(</span><span class="va">.</span>, conf.int <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co"># Calculate residuals and treatment weights</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>model_resid <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">data</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">treatment</span> <span class="op">~</span> <span class="va">country</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">.</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         treatment_resid <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">model_resid</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         treatment_weight <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">treatment_resid</span>, <span class="op">~</span> <span class="va">.</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">.</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate how many treated observations have negative weights</span></span>
<span><span class="va">prop_negative_primary</span> <span class="op">&lt;-</span> <span class="va">different_years_after_primary</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">unnest</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">treatment_resid</span>, <span class="va">treatment_weight</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">post_trt_years</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span>n_treated_negative_weight <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">treatment_weight</span> <span class="op">&lt;</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">treatment</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>            n_treated <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">treatment</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>            prop_treated_negative_weight <span class="op">=</span> <span class="va">n_treated_negative_weight</span> <span class="op">/</span> <span class="va">n_treated</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>prop_nice <span class="op">=</span> <span class="fu">percent</span><span class="op">(</span><span class="va">prop_treated_negative_weight</span>, accuracy <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract tidied results for plotting</span></span>
<span><span class="va">coefs_to_plot_primary</span> <span class="op">&lt;-</span> <span class="va">different_years_after_primary</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">unnest</span><span class="op">(</span><span class="va">tidied</span><span class="op">)</span></span>
<span></span>
<span><span class="va">different_years_after_secondary</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span>post_trt_years <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">22</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>data <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">post_trt_years</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">fpe_secondary_years_since</span>, <span class="va">years_after</span> <span class="op">&lt;=</span> <span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>model <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">data</span>, <span class="op">~</span><span class="fu">lm_robust</span><span class="op">(</span><span class="va">secondary</span> <span class="op">~</span> <span class="va">treatment</span>,</span>
<span>                                      fixed_effects <span class="op">=</span> <span class="op">~</span> <span class="va">country</span> <span class="op">+</span> <span class="va">year</span>,</span>
<span>                                      data <span class="op">=</span> <span class="va">.</span>,</span>
<span>                                      clusters <span class="op">=</span> <span class="va">country</span>, se_type <span class="op">=</span> <span class="st">"stata"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>tidied <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">model</span>, <span class="op">~</span><span class="fu">tidy</span><span class="op">(</span><span class="va">.</span>, conf.int <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>model_resid <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">data</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">treatment</span> <span class="op">~</span> <span class="va">country</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">.</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         treatment_resid <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">model_resid</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         treatment_weight <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">treatment_resid</span>, <span class="op">~</span> <span class="va">.</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">.</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">prop_negative_secondary</span> <span class="op">&lt;-</span> <span class="va">different_years_after_secondary</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">unnest</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">treatment_resid</span>, <span class="va">treatment_weight</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">post_trt_years</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span>n_treated_negative_weight <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">treatment_weight</span> <span class="op">&lt;</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">treatment</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>            n_treated <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">treatment</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>            prop_treated_negative_weight <span class="op">=</span> <span class="va">n_treated_negative_weight</span> <span class="op">/</span> <span class="va">n_treated</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>prop_nice <span class="op">=</span> <span class="fu">percent</span><span class="op">(</span><span class="va">prop_treated_negative_weight</span>, accuracy <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">coefs_to_plot_secondary</span> <span class="op">&lt;-</span> <span class="va">different_years_after_secondary</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">unnest</span><span class="op">(</span><span class="va">tidied</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Coefficient plot</span></span>
<span><span class="va">ate_primary</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">coefs_to_plot_primary</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">post_trt_years</span>, y <span class="op">=</span> <span class="va">estimate</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, color <span class="op">=</span> <span class="st">"#FF2E00"</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_pointrange</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">conf.low</span>, ymax <span class="op">=</span> <span class="va">conf.high</span><span class="op">)</span>,</span>
<span>                  color <span class="op">=</span> <span class="st">"#0599B0"</span>, size <span class="op">=</span> <span class="fl">1</span>, fatten <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="cn">NULL</span>, y <span class="op">=</span> <span class="st">"TWFE-based treatment effect"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"Primary school enrollment"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_clean</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>axis.title.x <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.text.x <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ate_secondary</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">coefs_to_plot_secondary</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">post_trt_years</span>, y <span class="op">=</span> <span class="va">estimate</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, color <span class="op">=</span> <span class="st">"#FF2E00"</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_pointrange</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">conf.low</span>, ymax <span class="op">=</span> <span class="va">conf.high</span><span class="op">)</span>,</span>
<span>                  color <span class="op">=</span> <span class="st">"#0599B0"</span>, size <span class="op">=</span> <span class="fl">1</span>, fatten <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="cn">NULL</span>, y <span class="op">=</span> <span class="st">"TWFE-based treatment effect"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"Secondary school enrollment"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_clean</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>axis.title.x <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.text.x <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Bar plot</span></span>
<span><span class="va">prop_neg_primary</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">prop_negative_primary</span>,</span>
<span>                                  <span class="va">prop_treated_negative_weight</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>                           <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">post_trt_years</span>, y <span class="op">=</span> <span class="va">prop_treated_negative_weight</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_col</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"#FF4136"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_text</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">prop_nice</span><span class="op">)</span>,</span>
<span>            nudge_y <span class="op">=</span> <span class="fl">0.02</span>, size <span class="op">=</span> <span class="fl">2.5</span>,</span>
<span>            family <span class="op">=</span> <span class="st">"Barlow Semi Condensed Bold"</span>, color <span class="op">=</span> <span class="st">"#FF4136"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">22</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Post-treatment years included"</span>, y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"% of treated observations with negative weight"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_clean</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>panel.grid.major.y <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.text.y <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">prop_neg_secondary</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">prop_negative_secondary</span>,</span>
<span>                                    <span class="va">prop_treated_negative_weight</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>                             <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">post_trt_years</span>, y <span class="op">=</span> <span class="va">prop_treated_negative_weight</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_col</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"#FF4136"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_text</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">prop_nice</span><span class="op">)</span>,</span>
<span>            nudge_y <span class="op">=</span> <span class="fl">0.02</span>, size <span class="op">=</span> <span class="fl">2.5</span>,</span>
<span>            family <span class="op">=</span> <span class="st">"Barlow Semi Condensed Bold"</span>, color <span class="op">=</span> <span class="st">"#FF4136"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">22</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Last year included in data"</span>, y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"% of treated observations with negative weight"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_clean</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>panel.grid.major.y <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.text.y <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="op">(</span><span class="va">ate_primary</span> <span class="op">/</span> <span class="va">prop_neg_primary</span><span class="op">)</span> <span class="op">+</span> <span class="fu">plot_layout</span><span class="op">(</span>heights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.8</span>, <span class="fl">0.2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|</span></span>
<span>  <span class="op">(</span><span class="op">(</span><span class="va">ate_secondary</span> <span class="op">/</span> <span class="va">prop_neg_secondary</span><span class="op">)</span> <span class="op">+</span> <span class="fu">plot_layout</span><span class="op">(</span>heights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.8</span>, <span class="fl">0.2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/robust-post-treatment-years-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page-inset-right" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section><section id="exclude-individual-countries" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="exclude-individual-countries">Exclude individual countries</h3>
<p>Finally, since early adopter countries are more likely to have negative treatment weights, we can remove individual countries from the panel to see what their omission does to the overall TWFE estimate. For primary school enrollment, the ATE remains positive and significant across most specifications, except when Malawi, Uganda, or Namibia are excluded. But Malawi and Uganda were early adopters and thus have negatively weighted treatment observations in later years, as we saw earlier, which give them strange leverage in the the overall TWFE ATE calculation. For secondary schools, the effect remains basically zero and insignificant across all specifications except when Malawi is omitted, but that’s again because Malawi was an early adopter.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">fpe_omit_countries_primary</span> <span class="op">&lt;-</span> <span class="va">fpe_primary</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="va">fpe_year</span>, <span class="va">country</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>country_start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">country</span>, <span class="st">" ("</span>, <span class="va">fpe_year</span>, <span class="st">")"</span><span class="op">)</span>,</span>
<span>         country_start <span class="op">=</span> <span class="fu">fct_inorder</span><span class="op">(</span><span class="va">country_start</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">distinct</span><span class="op">(</span><span class="va">country</span>, <span class="va">country_start</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>data <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">country</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">fpe_primary</span>, <span class="va">country</span> <span class="op">!=</span> <span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>model <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">data</span>, <span class="op">~</span><span class="fu">lm_robust</span><span class="op">(</span><span class="va">primary</span> <span class="op">~</span> <span class="va">treatment</span>,</span>
<span>                                      fixed_effects <span class="op">=</span> <span class="op">~</span> <span class="va">country</span> <span class="op">+</span> <span class="va">year</span>,</span>
<span>                                      data <span class="op">=</span> <span class="va">.</span>,</span>
<span>                                      clusters <span class="op">=</span> <span class="va">country</span>, se_type <span class="op">=</span> <span class="st">"stata"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>tidied <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">model</span>, <span class="op">~</span><span class="fu">tidy</span><span class="op">(</span><span class="va">.</span>, conf.int <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">coefs_to_plot_primary</span> <span class="op">&lt;-</span> <span class="va">fpe_omit_countries_primary</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">unnest</span><span class="op">(</span><span class="va">tidied</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fpe_omit_countries_secondary</span> <span class="op">&lt;-</span> <span class="va">fpe_secondary</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="va">fpe_year</span>, <span class="va">country</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>country_start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">country</span>, <span class="st">" ("</span>, <span class="va">fpe_year</span>, <span class="st">")"</span><span class="op">)</span>,</span>
<span>         country_start <span class="op">=</span> <span class="fu">fct_inorder</span><span class="op">(</span><span class="va">country_start</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">distinct</span><span class="op">(</span><span class="va">country</span>, <span class="va">country_start</span><span class="op">)</span>  <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>data <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">country</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">fpe_secondary</span>, <span class="va">country</span> <span class="op">!=</span> <span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>model <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">data</span>, <span class="op">~</span><span class="fu">lm_robust</span><span class="op">(</span><span class="va">secondary</span> <span class="op">~</span> <span class="va">treatment</span>,</span>
<span>                                      fixed_effects <span class="op">=</span> <span class="op">~</span> <span class="va">country</span> <span class="op">+</span> <span class="va">year</span>,</span>
<span>                                      data <span class="op">=</span> <span class="va">.</span>,</span>
<span>                                      clusters <span class="op">=</span> <span class="va">country</span>, se_type <span class="op">=</span> <span class="st">"stata"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>tidied <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">model</span>, <span class="op">~</span><span class="fu">tidy</span><span class="op">(</span><span class="va">.</span>, conf.int <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">coefs_to_plot_secondary</span> <span class="op">&lt;-</span> <span class="va">fpe_omit_countries_secondary</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">unnest</span><span class="op">(</span><span class="va">tidied</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ate_primary</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">coefs_to_plot_primary</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">estimate</span>, y <span class="op">=</span> <span class="fu">fct_rev</span><span class="op">(</span><span class="va">country_start</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span>, color <span class="op">=</span> <span class="st">"#FF2E00"</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_pointrange</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xmin <span class="op">=</span> <span class="va">conf.low</span>, xmax <span class="op">=</span> <span class="va">conf.high</span><span class="op">)</span>,</span>
<span>                  color <span class="op">=</span> <span class="st">"#0599B0"</span>, size <span class="op">=</span> <span class="fl">1</span>, fatten <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"TWFE-based treatment effect"</span>, y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"Primary school enrollment"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Each point represents the ATE when omitting the specified country"</span>,</span>
<span>       caption <span class="op">=</span> <span class="st">"Year that fees were eliminated is shown in parentheses"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">10</span>, <span class="fl">50</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_clean</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>panel.grid.major.y <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ate_secondary</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">coefs_to_plot_secondary</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">estimate</span>, y <span class="op">=</span> <span class="fu">fct_rev</span><span class="op">(</span><span class="va">country_start</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span>, color <span class="op">=</span> <span class="st">"#FF2E00"</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_pointrange</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xmin <span class="op">=</span> <span class="va">conf.low</span>, xmax <span class="op">=</span> <span class="va">conf.high</span><span class="op">)</span>,</span>
<span>                  color <span class="op">=</span> <span class="st">"#0599B0"</span>, size <span class="op">=</span> <span class="fl">1</span>, fatten <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"TWFE-based treatment effect"</span>, y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"Secondary school enrollment"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">10</span>, <span class="fl">50</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_clean</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>panel.grid.major.y <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ate_primary</span> <span class="op">|</span> <span class="va">ate_secondary</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/robust-drop-countries-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page-inset-right" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section></section><section id="tldr-conclusion" class="level2"><h2 class="anchored" data-anchor-id="tldr-conclusion">tl;dr: Conclusion</h2>
<p><strong><em>Phew.</em></strong> That was a ton of code, but coding my way through this paper and translating Jakiela’s diagnostics and robustness checks from math into R was incredibly helpful for me to start understanding all this new TWFE stuff.</p>
<p>Here are the main tl;dr takeaways from her paper:</p>
<ul>
<li>We can think of OLS as a weighted sum of outcome values - these weights are typically negative for untreated observations and positive for treated observations</li>
<li>In TWFE situations, these weights take country and year into account</li>
<li>Because of mathy reasons, treated observations can actually get negative weights—especially countries that are early adopters, and country-year observations in later years</li>
<li>We can see if these negative weights on treated observations are an issue by using a couple simple diagnostics: see how many and which treated observations have negative weights, and see if the treatment effect is homogenous across treated countries</li>
<li>We can look at which treated observations have negative weights by making some plots and exploring the data</li>
<li>We can check for the homogeniety of the treatment effect by running a regression that uses the residualized treatment and treatment status to explain the residualized outcome. If the slopes for treated and comparison observations are indistinguishable, we can safely assume treatment homogeneity.</li>
<li>Finally, we can check how robust the TWFE estimate is to negative treatment weights and the assumption of homogeneity by dropping specific types of observations and checking the ATE across these modified datasets</li>
</ul></section><section id="references" class="level2">


<!-- -->


</section><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-BakerLarckerWang:2021" class="csl-entry" role="listitem">
Baker, Andrew, David F. Larcker, and Charles C. Y. Wang. 2021. <span>“How Much Should We Trust Staggered Difference-in-Differences Estimates?”</span> Working paper 246. Rock Center for Corporate Governance at Stanford University. <a href="https://doi.org/10.2139/ssrn.3794018">https://doi.org/10.2139/ssrn.3794018</a>.
</div>
<div id="ref-CallawaySantAnna:2020" class="csl-entry" role="listitem">
Callaway, Brantly, and Pedro H. C. Sant’Anna. 2020. <span>“Difference-in-Differences with Multiple Time Periods.”</span> <em>Journal of Econometrics</em>, December. <a href="https://doi.org/10.1016/j.jeconom.2020.12.001">https://doi.org/10.1016/j.jeconom.2020.12.001</a>.
</div>
<div id="ref-de-ChaisemartindHaultfoeuille:2020" class="csl-entry" role="listitem">
de Chaisemartin, Clément, and Xavier d’Haultfoeuille. 2020. <span>“Two-Way Fixed Effects Estimators with Heterogeneous Treatment Effects.”</span> <em>American Economic Review</em> 110 (9): 2964–96. <a href="https://doi.org/10.1257/aer.20181169">https://doi.org/10.1257/aer.20181169</a>.
</div>
<div id="ref-Goodman-Bacon:2021" class="csl-entry" role="listitem">
Goodman-Bacon, Andrew. 2021. <span>“Difference-in-Differences with Variation in Treatment Timing.”</span> <em>Journal of Econometrics</em>, June. <a href="https://doi.org/10.1016/j.jeconom.2021.03.014">https://doi.org/10.1016/j.jeconom.2021.03.014</a>.
</div>
<div id="ref-Jakiela:2021" class="csl-entry" role="listitem">
Jakiela, Pamela. 2021. <span>“Simple Diagnostics for Two-Way Fixed Effects,”</span> March. <a href="https://arxiv.org/abs/2103.13229">https://arxiv.org/abs/2103.13229</a>.
</div>
<div id="ref-SunAbraham:2020" class="csl-entry" role="listitem">
Sun, Liyang, and Sarah Abraham. 2020. <span>“Estimating Dynamic Treatment Effects in Event Studies with Heterogeneous Treatment Effects.”</span> <em>Journal of Econometrics</em>, December. <a href="https://doi.org/10.1016/j.jeconom.2020.09.006">https://doi.org/10.1016/j.jeconom.2020.09.006</a>.
</div>
</div></section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{heiss2021,
  author = {Heiss, Andrew},
  title = {Exploring {Pamela} {Jakiela’s} Simple {TWFE} Diagnostics with
    {R}},
  date = {2021-08-25},
  url = {https://www.andrewheiss.com/blog/2021/08/25/twfe-diagnostics/},
  doi = {10.59350/yrbym-m0y62},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-heiss2021" class="csl-entry quarto-appendix-citeas" role="listitem">
Heiss, Andrew. 2021. <span>“Exploring Pamela Jakiela’s Simple TWFE
Diagnostics with R.”</span> August 25, 2021. <a href="https://doi.org/10.59350/yrbym-m0y62">https://doi.org/10.59350/yrbym-m0y62</a>.
</div></div></section></div></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/www\.andrewheiss\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><script src="https://giscus.app/client.js" data-repo="andrewheiss/ath-quarto" data-repo-id="R_kgDOIg6EJQ" data-category="Blog comments" data-category-id="DIC_kwDOIg6EJc4CSz92" data-mapping="pathname" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script><input type="hidden" id="giscus-base-theme" value="light"><input type="hidden" id="giscus-alt-theme" value="dark"><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb28" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Exploring Pamela Jakiela's simple TWFE diagnostics with R"</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> 2021-08-25</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="an">description:</span><span class="co"> "Use R to explore possible biases that come from differential treatment timing in two-way fixed effects (TWFE) regression models"</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="an">image:</span><span class="co"> index_files/figure-html/show-weights-hist-1.png</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="co">  - r</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="co">  - tidyverse</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="co">  - regression</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="co">  - statistics</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="co">  - data visualization</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a><span class="co">  - econometrics</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a><span class="co">  - panel data</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a><span class="an">doi:</span><span class="co"> 10.59350/yrbym-m0y62</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a><span class="an">citation:</span><span class="co"> true</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setup, include=FALSE}</span></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::opts_chunk$set(fig.align = "center", fig.retina = 3,</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a><span class="in">                      fig.width = 6, fig.height = (6 * 0.618),</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a><span class="in">                      out.width = "75%", collapse = TRUE)</span></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a><span class="in">options(digits = 3, width = 90)</span></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>The world of econometrics has been roiled over the past couple years with a bunch of new papers showing how two-way fixed effects (TWFE; situations with nested levels of observations, like country-year, state-month, etc.) estimates of causal effects from difference-in-differences-based natural experiments can be biased when treatment is applied at different times. There are a ton of these papers, like @de-ChaisemartindHaultfoeuille:2020, @Goodman-Bacon:2021, @SunAbraham:2020, @CallawaySantAnna:2020, and @BakerLarckerWang:2021. And they're all really technical and scary.</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>I've been peripherally following these discussions on Twitter, since I teach a class on causal inference and include <span class="co">[</span><span class="ot">a couple sessions and assignments on difference-in-differences approaches</span><span class="co">](https://evalf21.classes.andrewheiss.com/example/diff-in-diff/)</span>, and since I do lots of <span class="co">[</span><span class="ot">research with country-year panel data</span><span class="co">](https://www.andrewheiss.com/research/articles/chaudhry-heiss-ngos-aid/)</span> (see <span class="co">[</span><span class="ot">all my posts on marginal structural models</span><span class="co">](https://www.andrewheiss.com/blog/tags/inverse-probability-weighting/)</span> for more on that), but I've admittedly been lost in the mathy details of all these papers and I've been slightly terrified of trying to work through these papers and figuring out what this differential timing bias actually looks like in real life. I'm not a real economist or econometrician (I just teach microeconomics and econometrics lolz), so this world is still pretty intimidating for me.</span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>But <span class="co">[</span><span class="ot">Pamela Jakiela</span><span class="co">](https://pjakiela.github.io/)</span> recently posted <span class="co">[</span><span class="ot">a working paper called "Simple Diagnostics for Two-Way Fixed Effects"</span><span class="co">](https://arxiv.org/abs/2103.13229)</span> <span class="co">[</span><span class="ot">@Jakiela:2021</span><span class="co">]</span> where she presents an easy-to-follow example of all this newfangled TWFE work, so I figured I'd finally officially plunge into this new TWFE world and try to figure out what it all means. Her paper is fantastic—you should read it if you want a quick introduction to the issues of differential timing and TWFE and if you want some easy ways to see how bad these situations might bias causal estimates.</span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>In the spirit of <span class="co">[</span><span class="ot">Vincent Arel-Bundock</span><span class="co">](http://arelbundock.com/)</span>, who publicly codes through more technical papers to understand them better (see <span class="co">[</span><span class="ot">this</span><span class="co">](http://arelbundock.com/posts/frontdoor/)</span> or <span class="co">[</span><span class="ot">this</span><span class="co">](http://arelbundock.com/posts/robustness_values/)</span> or <span class="co">[</span><span class="ot">this</span><span class="co">](http://arelbundock.com/posts/marginal_structural_models/)</span>), this post is my attempt at translating Jakiela's paper from conceptual math and Stata code into R. Here we go!</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a><span class="in">```{r libraries-data, warning=FALSE, message=FALSE}</span></span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidyverse)     # For ggplot2, dplyr, and friends</span></span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a><span class="in">library(haven)         # For reading Stata files</span></span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a><span class="in">library(fixest)        # One way of doing fixed effects regression</span></span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a><span class="in">library(estimatr)      # Another way of doing fixed effects regression</span></span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a><span class="in">library(broom)         # For converting model objects to data frames</span></span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a><span class="in">library(kableExtra)    # For pretty tables</span></span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a><span class="in">library(modelsummary)  # For pretty regression tables</span></span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a><span class="in">library(patchwork)     # For combining plots</span></span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a><span class="in">library(scales)        # For nice formatting functions</span></span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a><span class="in"># Custom ggplot theme to make pretty plots</span></span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a><span class="in"># Get the font at https://fonts.google.com/specimen/Barlow+Semi+Condensed</span></span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a><span class="in">theme_clean &lt;- function() {</span></span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_minimal(base_family = "Barlow Semi Condensed") +</span></span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a><span class="in">    theme(panel.grid.minor = element_blank(),</span></span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a><span class="in">          plot.title = element_text(face = "bold"),</span></span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a><span class="in">          axis.title = element_text(family = "Barlow Semi Condensed Medium"),</span></span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true" tabindex="-1"></a><span class="in">          strip.text = element_text(family = "Barlow Semi Condensed",</span></span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true" tabindex="-1"></a><span class="in">                                    face = "bold", size = rel(1), hjust = 0),</span></span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a><span class="in">          strip.background = element_rect(fill = "grey80", color = NA),</span></span>
<span id="cb28-54"><a href="#cb28-54" aria-hidden="true" tabindex="-1"></a><span class="in">          plot.caption = element_text(hjust = 0))</span></span>
<span id="cb28-55"><a href="#cb28-55" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb28-56"><a href="#cb28-56" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-57"><a href="#cb28-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-58"><a href="#cb28-58" aria-hidden="true" tabindex="-1"></a><span class="fu">## A different way of thinking about OLS coefficients</span></span>
<span id="cb28-59"><a href="#cb28-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-60"><a href="#cb28-60" aria-hidden="true" tabindex="-1"></a>Before diving into the issues that come with TWFE estimation (and Jakiela's proposed diagnostics), we first have to think about regression coefficients in a slightly different way (that was completely new to me!)</span>
<span id="cb28-61"><a href="#cb28-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-62"><a href="#cb28-62" aria-hidden="true" tabindex="-1"></a>To do this, let's make some simulated data to play with. We have two variables: (1) an outcome that ranges from ≈400–2000, and (2) a continuous treatment that ranges from ≈2–70. For the sake of simplicity, we'll pretend that the outcome represents weekly income, and the treatment is some sort of social policy (test scores from some job training program? idk—imagine something neat here). We'll also pretend that this treatment is experimental so we can talk about causation here.</span>
<span id="cb28-63"><a href="#cb28-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-64"><a href="#cb28-64" aria-hidden="true" tabindex="-1"></a><span class="in">```{r create-fake-data}</span></span>
<span id="cb28-65"><a href="#cb28-65" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(1234)  # For reproducibility</span></span>
<span id="cb28-66"><a href="#cb28-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-67"><a href="#cb28-67" aria-hidden="true" tabindex="-1"></a><span class="in">n_rows &lt;- 500</span></span>
<span id="cb28-68"><a href="#cb28-68" aria-hidden="true" tabindex="-1"></a><span class="in">fake_data &lt;- tibble(treatment = rbeta(n_rows, shape1 = 3, shape2 = 7)) %&gt;%</span></span>
<span id="cb28-69"><a href="#cb28-69" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(treatment = round(treatment * 100)) %&gt;%</span></span>
<span id="cb28-70"><a href="#cb28-70" aria-hidden="true" tabindex="-1"></a><span class="in">  # Build the outcome based on some baseline level of outcome + a boost in</span></span>
<span id="cb28-71"><a href="#cb28-71" aria-hidden="true" tabindex="-1"></a><span class="in">  # outcome that happens because of the treatment + some noise</span></span>
<span id="cb28-72"><a href="#cb28-72" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(outcome_baseline = rnorm(n_rows, mean = 800, sd = 200),</span></span>
<span id="cb28-73"><a href="#cb28-73" aria-hidden="true" tabindex="-1"></a><span class="in">         treatment_boost = 10 * treatment,</span></span>
<span id="cb28-74"><a href="#cb28-74" aria-hidden="true" tabindex="-1"></a><span class="in">         outcome = outcome_baseline + treatment_boost + rnorm(n_rows, 200, 100)) %&gt;%</span></span>
<span id="cb28-75"><a href="#cb28-75" aria-hidden="true" tabindex="-1"></a><span class="in">  select(outcome, treatment)</span></span>
<span id="cb28-76"><a href="#cb28-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-77"><a href="#cb28-77" aria-hidden="true" tabindex="-1"></a><span class="in">head(fake_data)</span></span>
<span id="cb28-78"><a href="#cb28-78" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-79"><a href="#cb28-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-80"><a href="#cb28-80" aria-hidden="true" tabindex="-1"></a>For reference, here's what the distributions of these variables look like, along with the relationship between treatment and outcome:</span>
<span id="cb28-81"><a href="#cb28-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-82"><a href="#cb28-82" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-fake-data, fig.width=7, fig.height=5, message=FALSE}</span></span>
<span id="cb28-83"><a href="#cb28-83" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb28-84"><a href="#cb28-84" aria-hidden="true" tabindex="-1"></a><span class="in">hist_out &lt;- ggplot(fake_data, aes(x = outcome)) +</span></span>
<span id="cb28-85"><a href="#cb28-85" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_histogram(binwidth = 100, color = "white",</span></span>
<span id="cb28-86"><a href="#cb28-86" aria-hidden="true" tabindex="-1"></a><span class="in">                 boundary = 0, fill = "#FFA615") +</span></span>
<span id="cb28-87"><a href="#cb28-87" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = dollar_format()) +</span></span>
<span id="cb28-88"><a href="#cb28-88" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(title = "Distribution of outcome",</span></span>
<span id="cb28-89"><a href="#cb28-89" aria-hidden="true" tabindex="-1"></a><span class="in">       x = "Outcome", y = "Count") +</span></span>
<span id="cb28-90"><a href="#cb28-90" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(ylim = c(0, 80)) +</span></span>
<span id="cb28-91"><a href="#cb28-91" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_clean() +</span></span>
<span id="cb28-92"><a href="#cb28-92" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(panel.grid.major.x = element_blank())</span></span>
<span id="cb28-93"><a href="#cb28-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-94"><a href="#cb28-94" aria-hidden="true" tabindex="-1"></a><span class="in">hist_trt &lt;- ggplot(fake_data, aes(x = treatment)) +</span></span>
<span id="cb28-95"><a href="#cb28-95" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_histogram(binwidth = 5, color = "white",</span></span>
<span id="cb28-96"><a href="#cb28-96" aria-hidden="true" tabindex="-1"></a><span class="in">                 boundary = 0, fill = "#A4BD0A") +</span></span>
<span id="cb28-97"><a href="#cb28-97" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(title = "Distribution of treatment",</span></span>
<span id="cb28-98"><a href="#cb28-98" aria-hidden="true" tabindex="-1"></a><span class="in">       x = "Treatment", y = "Count") +</span></span>
<span id="cb28-99"><a href="#cb28-99" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(ylim = c(0, 80)) +</span></span>
<span id="cb28-100"><a href="#cb28-100" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_clean() +</span></span>
<span id="cb28-101"><a href="#cb28-101" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(panel.grid.major.x = element_blank())</span></span>
<span id="cb28-102"><a href="#cb28-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-103"><a href="#cb28-103" aria-hidden="true" tabindex="-1"></a><span class="in">plot_trt_out &lt;- ggplot(fake_data, aes(x = treatment, y = outcome)) +</span></span>
<span id="cb28-104"><a href="#cb28-104" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(size = 0.75) +</span></span>
<span id="cb28-105"><a href="#cb28-105" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_smooth(method = "lm", color = "#0599B0") +</span></span>
<span id="cb28-106"><a href="#cb28-106" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_y_continuous(labels = dollar_format()) +</span></span>
<span id="cb28-107"><a href="#cb28-107" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(title = "Effect of treatment on outcome",</span></span>
<span id="cb28-108"><a href="#cb28-108" aria-hidden="true" tabindex="-1"></a><span class="in">       x = "Treatment", y = "Outcome") +</span></span>
<span id="cb28-109"><a href="#cb28-109" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_clean()</span></span>
<span id="cb28-110"><a href="#cb28-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-111"><a href="#cb28-111" aria-hidden="true" tabindex="-1"></a><span class="in">(hist_out + hist_trt) / plot_spacer() / plot_trt_out +</span></span>
<span id="cb28-112"><a href="#cb28-112" aria-hidden="true" tabindex="-1"></a><span class="in">  plot_layout(heights = c(0.28, 0.02, 0.7))</span></span>
<span id="cb28-113"><a href="#cb28-113" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-114"><a href="#cb28-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-115"><a href="#cb28-115" aria-hidden="true" tabindex="-1"></a>We can find the average treatment effect (ATE) of this imaginary program on the outcome using a simple univariate regression model:</span>
<span id="cb28-116"><a href="#cb28-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-117"><a href="#cb28-117" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-118"><a href="#cb28-118" aria-hidden="true" tabindex="-1"></a>\color{gray}{\overbrace{\color{#FFA615}{Y}}^{\text{Outcome}}_{\underbrace{\color{#FFA615}{i}}_{\text{An individual}}}} \color{black}{=} \color{gray}{\overbrace{\color{black}{\alpha}}^{\text{Intercept}}} \color{black}{+} \color{gray}{\underbrace{\color{#0599B0}{\beta}}_{\text{ATE}}} \color{gray}{\overbrace{\color{#A4BD0A}{D_i}}^{\text{Treatment}}} \color{black}{+} \color{gray}{\overbrace{\color{black}{\epsilon_i}}^{\text{Error}}}</span>
<span id="cb28-119"><a href="#cb28-119" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-120"><a href="#cb28-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-121"><a href="#cb28-121" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fake-ate-ols}</span></span>
<span id="cb28-122"><a href="#cb28-122" aria-hidden="true" tabindex="-1"></a><span class="in">model_effect &lt;- lm(outcome ~ treatment, data = fake_data)</span></span>
<span id="cb28-123"><a href="#cb28-123" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_effect)</span></span>
<span id="cb28-124"><a href="#cb28-124" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-125"><a href="#cb28-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-126"><a href="#cb28-126" aria-hidden="true" tabindex="-1"></a>This is just regular old OLS regression. Based on this model, a 1-unit increase in treatment causes a \$9.69 increase in the outcome. Lovely.</span>
<span id="cb28-127"><a href="#cb28-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-128"><a href="#cb28-128" aria-hidden="true" tabindex="-1"></a>@Jakiela:2021 <span class="co">[</span><span class="ot">4</span><span class="co">]</span> shows an alternate way of calculating $\beta$, though, based on the <span class="co">[</span><span class="ot">Frisch-Waugh-Lovell theorem</span><span class="co">](https://en.wikipedia.org/wiki/Frisch%E2%80%93Waugh%E2%80%93Lovell_theorem)</span>, which is an econometrics idea that I've never heard of (since I'm defs not an economist). According to this theorem, we can rewrite the OLS estimate of $\beta$ based on the residuals ($\tilde{D}_i$) of a model that predicts treatment:</span>
<span id="cb28-129"><a href="#cb28-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-130"><a href="#cb28-130" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-131"><a href="#cb28-131" aria-hidden="true" tabindex="-1"></a>\color{#0599B0}{\beta}\ \color{black}{=}\ \sum_i \color{#FFA615}{Y_i} \color{black}\left( \frac{\color{#353D03}{\tilde{D}_i}}{\sum_i \color{#353D03}{\tilde{D}_i}^2} \right)</span>
<span id="cb28-132"><a href="#cb28-132" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-133"><a href="#cb28-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-134"><a href="#cb28-134" aria-hidden="true" tabindex="-1"></a>Since this is a univariate model, the residuals here are really just the deviations from the average value of the treatment, or $D_i - \bar{D}$. We can confirm this by running an intercept-only model and comparing it to $D_i - \bar{D}$:</span>
<span id="cb28-135"><a href="#cb28-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-136"><a href="#cb28-136" aria-hidden="true" tabindex="-1"></a><span class="in">```{r add-residuals-fake-data}</span></span>
<span id="cb28-137"><a href="#cb28-137" aria-hidden="true" tabindex="-1"></a><span class="in">trt_resid &lt;- lm(treatment ~ 1, data = fake_data)</span></span>
<span id="cb28-138"><a href="#cb28-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-139"><a href="#cb28-139" aria-hidden="true" tabindex="-1"></a><span class="in">fake_data_resid &lt;- fake_data %&gt;%</span></span>
<span id="cb28-140"><a href="#cb28-140" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(treatment_resid = residuals(trt_resid)) %&gt;%</span></span>
<span id="cb28-141"><a href="#cb28-141" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(mean_treat = mean(treatment),</span></span>
<span id="cb28-142"><a href="#cb28-142" aria-hidden="true" tabindex="-1"></a><span class="in">         diff = treatment - mean_treat)</span></span>
<span id="cb28-143"><a href="#cb28-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-144"><a href="#cb28-144" aria-hidden="true" tabindex="-1"></a><span class="in">head(fake_data_resid)</span></span>
<span id="cb28-145"><a href="#cb28-145" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-146"><a href="#cb28-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-147"><a href="#cb28-147" aria-hidden="true" tabindex="-1"></a>The <span class="in">`treatment_resid`</span> and <span class="in">`diff`</span> columns here are identical. Now that we have $\tilde{D}_i$, we can use that fancy rewritten formula and calculate $\beta$:</span>
<span id="cb28-148"><a href="#cb28-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-149"><a href="#cb28-149" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fwl-beta}</span></span>
<span id="cb28-150"><a href="#cb28-150" aria-hidden="true" tabindex="-1"></a><span class="in">fake_data_resid %&gt;%</span></span>
<span id="cb28-151"><a href="#cb28-151" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(beta = sum(outcome * (treatment_resid / sum(treatment_resid^2))))</span></span>
<span id="cb28-152"><a href="#cb28-152" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-153"><a href="#cb28-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-154"><a href="#cb28-154" aria-hidden="true" tabindex="-1"></a>WHAAAAAT it's the same ATE that we get from running a regular OLS model! That's magical!</span>
<span id="cb28-155"><a href="#cb28-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-156"><a href="#cb28-156" aria-hidden="true" tabindex="-1"></a>The reason Jakiela reparameterizes $\beta$ this way is because looking at residuals like this creates inherent weights for each observation. Essentially, $\beta$ is a **weighted sum of the outcome variable**, with the weights calculated with $\frac{\tilde{D}_{it}}{\sum_{it} \tilde{D}_{it}^2}$, or <span class="in">`(treatment_resid / sum(treatment_resid^2))`</span>. We can calculate the weights for each observation:</span>
<span id="cb28-157"><a href="#cb28-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-158"><a href="#cb28-158" aria-hidden="true" tabindex="-1"></a><span class="in">```{r add-weights-fake-data}</span></span>
<span id="cb28-159"><a href="#cb28-159" aria-hidden="true" tabindex="-1"></a><span class="in">fake_data_with_weights &lt;- fake_data_resid %&gt;%</span></span>
<span id="cb28-160"><a href="#cb28-160" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(treatment_weight = treatment_resid / sum(treatment_resid^2))</span></span>
<span id="cb28-161"><a href="#cb28-161" aria-hidden="true" tabindex="-1"></a><span class="in">head(fake_data_with_weights)</span></span>
<span id="cb28-162"><a href="#cb28-162" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-163"><a href="#cb28-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-164"><a href="#cb28-164" aria-hidden="true" tabindex="-1"></a>In this case, given that this is overly perfect simulated data, the weights are really small. In theory, the weights should sum up to 0. Let's check that really quick:</span>
<span id="cb28-165"><a href="#cb28-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-166"><a href="#cb28-166" aria-hidden="true" tabindex="-1"></a><span class="in">```{r sum-weights-fake-data}</span></span>
<span id="cb28-167"><a href="#cb28-167" aria-hidden="true" tabindex="-1"></a><span class="in">fake_data_with_weights %&gt;%</span></span>
<span id="cb28-168"><a href="#cb28-168" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(total_weights = sum(treatment_weight))</span></span>
<span id="cb28-169"><a href="#cb28-169" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-170"><a href="#cb28-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-171"><a href="#cb28-171" aria-hidden="true" tabindex="-1"></a>We can visualize the distribution of weights too:</span>
<span id="cb28-172"><a href="#cb28-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-173"><a href="#cb28-173" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-weights-fake-data}</span></span>
<span id="cb28-174"><a href="#cb28-174" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(fake_data_with_weights, aes(x = treatment_weight)) +</span></span>
<span id="cb28-175"><a href="#cb28-175" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_histogram(binwidth = 0.00005, color = "white",</span></span>
<span id="cb28-176"><a href="#cb28-176" aria-hidden="true" tabindex="-1"></a><span class="in">                 boundary = 0, fill = "#F6C848") +</span></span>
<span id="cb28-177"><a href="#cb28-177" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0, color = "#FF2E00", linewidth = 1) +</span></span>
<span id="cb28-178"><a href="#cb28-178" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Residualized treatment weight", y = "Count") +</span></span>
<span id="cb28-179"><a href="#cb28-179" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = comma_format()) +</span></span>
<span id="cb28-180"><a href="#cb28-180" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_clean() +</span></span>
<span id="cb28-181"><a href="#cb28-181" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(panel.grid.major.x = element_blank())</span></span>
<span id="cb28-182"><a href="#cb28-182" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-183"><a href="#cb28-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-184"><a href="#cb28-184" aria-hidden="true" tabindex="-1"></a>There's a pattern to which observations get positive or negative weights. According to @Jakiela:2021 <span class="co">[</span><span class="ot">p. 4</span><span class="co">]</span>,</span>
<span id="cb28-185"><a href="#cb28-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-186"><a href="#cb28-186" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; As in any univariate OLS regression of an outcome on a continuous measure of treatment intensity, observations with below mean treatment intensity receive negative weight, and may be thought of as part of the comparison group.</span></span>
<span id="cb28-187"><a href="#cb28-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-188"><a href="#cb28-188" aria-hidden="true" tabindex="-1"></a>Since treatment here is continuous, there's no clear division between treatment and control groups, so mathematically, that threshold becomes the average value of treatment: observations where the treatment value is less than the average (or $D_i &lt; \bar{D}$) receive negative weight and can conceptually be considered part of the control/comparison group, while observations where $D_i &gt; \bar{D}$ are in the treatment group. That's apparent in the data too. Look at the first few rows of <span class="in">`fake_data_with_weights`</span> above—observations where <span class="in">`treatment_resid`</span> is negative have negative weights.</span>
<span id="cb28-189"><a href="#cb28-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-190"><a href="#cb28-190" aria-hidden="true" tabindex="-1"></a><span class="fu">## Residualized weights with TWFE models</span></span>
<span id="cb28-191"><a href="#cb28-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-192"><a href="#cb28-192" aria-hidden="true" tabindex="-1"></a>This idea of weighting the outcome variable by treatment status (with treated units getting positive weight and untreated units getting negative weight) is central to the rest of Jakiela's argument and diagnostics (as well as all the other neat new diff-in-diff papers). Fundamentally, the main reason TWFE estimates get weird and biased with differently-timed treatments is because of issues with weights—in TWFE settings, treated observations often get negative weights and vice versa. This isn't always bad, and Jakiela explains why and when it's okay. That's essentially the whole point of her paper—she provides diagnostics to help determine if there are serious issues with these residualized treatment weights.</span>
<span id="cb28-193"><a href="#cb28-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-194"><a href="#cb28-194" aria-hidden="true" tabindex="-1"></a><span class="fu">### Load and clean data</span></span>
<span id="cb28-195"><a href="#cb28-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-196"><a href="#cb28-196" aria-hidden="true" tabindex="-1"></a>To demonstrate issues with TWFE models, weights, and differential timing, Jakiela looks at the effect of eliminating primary school fees on school enrollment in 15 African countries, based on data from the World Bank. You can get <span class="co">[</span><span class="ot">her data and Stata code at GitHub</span><span class="co">](https://pjakiela.github.io/TWFE/)</span>. First let's load the data and clean it up a little.</span>
<span id="cb28-197"><a href="#cb28-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-198"><a href="#cb28-198" aria-hidden="true" tabindex="-1"></a><span class="in">```{r load-fpe-dat}</span></span>
<span id="cb28-199"><a href="#cb28-199" aria-hidden="true" tabindex="-1"></a><span class="in">fpe_raw &lt;- read_dta("WDI-FPE-data.dta")</span></span>
<span id="cb28-200"><a href="#cb28-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-201"><a href="#cb28-201" aria-hidden="true" tabindex="-1"></a><span class="in"># Remove rows where primary school enrollment is missing</span></span>
<span id="cb28-202"><a href="#cb28-202" aria-hidden="true" tabindex="-1"></a><span class="in">fpe_primary &lt;- fpe_raw %&gt;%</span></span>
<span id="cb28-203"><a href="#cb28-203" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(!is.na(primary))</span></span>
<span id="cb28-204"><a href="#cb28-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-205"><a href="#cb28-205" aria-hidden="true" tabindex="-1"></a><span class="in"># Remove rows where secondary school enrollment is missing</span></span>
<span id="cb28-206"><a href="#cb28-206" aria-hidden="true" tabindex="-1"></a><span class="in">fpe_secondary &lt;- fpe_raw %&gt;%</span></span>
<span id="cb28-207"><a href="#cb28-207" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(!is.na(secondary))</span></span>
<span id="cb28-208"><a href="#cb28-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-209"><a href="#cb28-209" aria-hidden="true" tabindex="-1"></a><span class="in">head(fpe_primary)</span></span>
<span id="cb28-210"><a href="#cb28-210" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-211"><a href="#cb28-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-212"><a href="#cb28-212" aria-hidden="true" tabindex="-1"></a>We have 8 columns to work with:</span>
<span id="cb28-213"><a href="#cb28-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-214"><a href="#cb28-214" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`year`</span>: The year of the observation</span>
<span id="cb28-215"><a href="#cb28-215" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`country`</span> &amp; <span class="in">`ccode`</span> &amp; <span class="in">`id`</span>: The country name, ISO3 country code, and id number for each country (Stata apparently struggles with string-based variables, so <span class="in">`id`</span> works better as a country identifier there)</span>
<span id="cb28-216"><a href="#cb28-216" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`primary`</span>: Gross enrollment in primary schools</span>
<span id="cb28-217"><a href="#cb28-217" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`secondary`</span>: Gross enrollment in secondary schools</span>
<span id="cb28-218"><a href="#cb28-218" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`fpe_year`</span>: Year the country eliminated fees for primary schools</span>
<span id="cb28-219"><a href="#cb28-219" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`treatment`</span>: Indicator variable that is <span class="in">`1`</span> when <span class="in">`year &gt; fpe_year`</span> and <span class="in">`0`</span> otherwise</span>
<span id="cb28-220"><a href="#cb28-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-221"><a href="#cb28-221" aria-hidden="true" tabindex="-1"></a><span class="fu">### Model specification</span></span>
<span id="cb28-222"><a href="#cb28-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-223"><a href="#cb28-223" aria-hidden="true" tabindex="-1"></a>We can estimate the causal effect of eliminating primary school fees (<span class="in">`treatment`</span>) on primary and secondary school enrollment (<span class="in">`primary`</span> and <span class="in">`secondary`</span>) treatment with a TWFE diff-in-diff model:</span>
<span id="cb28-224"><a href="#cb28-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-225"><a href="#cb28-225" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-226"><a href="#cb28-226" aria-hidden="true" tabindex="-1"></a>\color{gray}{\overbrace{\color{#FFA615}{Y}}^{\text{Outcome}}_{\underbrace{\color{#FFA615}{it}}_{\substack{i: \text{ country} \\ t: \text{ year}}}}} \color{black} = \color{gray}{\overbrace{\color{black}{\alpha}}^{\text{Intercept}}} + \color{gray}{\overbrace{\color{black}{\lambda_i}}^{\substack{\text{Country} \\ \text{fixed} \\ \text{effects}}}} + \color{gray}{\overbrace{\color{black}{\gamma_t}}^{\substack{\text{Year} \\ \text{fixed} \\ \text{effects}}}} + \color{gray}{\underbrace{\color{#0599B0}{\beta}}_{\text{ATE}}} \color{gray}{\overbrace{\color{#A4BD0A}{D_{it}}}^{\text{Treatment}}} + \color{gray}{\overbrace{\color{black}{\epsilon_{it}}}^{\text{Error}}}</span>
<span id="cb28-227"><a href="#cb28-227" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-228"><a href="#cb28-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-229"><a href="#cb28-229" aria-hidden="true" tabindex="-1"></a>Or without all the annotations:</span>
<span id="cb28-230"><a href="#cb28-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-231"><a href="#cb28-231" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-232"><a href="#cb28-232" aria-hidden="true" tabindex="-1"></a>\color{#FFA615}{Y_{it}} \color{black}{\ = \alpha + \lambda_i + \gamma_t +} \color{#0599B0}{\beta} \color{#A4BD0A}{D_{it}} \color{black}{\ + \epsilon_{it}}</span>
<span id="cb28-233"><a href="#cb28-233" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-234"><a href="#cb28-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-235"><a href="#cb28-235" aria-hidden="true" tabindex="-1"></a><span class="fu">### TWFE models with R</span></span>
<span id="cb28-236"><a href="#cb28-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-237"><a href="#cb28-237" aria-hidden="true" tabindex="-1"></a>There are a few different ways to do fixed effects regression with clustered robust standard errors in R. In Stata you do this:</span>
<span id="cb28-238"><a href="#cb28-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-239"><a href="#cb28-239" aria-hidden="true" tabindex="-1"></a><span class="in">```stata</span></span>
<span id="cb28-240"><a href="#cb28-240" aria-hidden="true" tabindex="-1"></a><span class="in">reg primary treatment i.year i.id, cluster(id)</span></span>
<span id="cb28-241"><a href="#cb28-241" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-242"><a href="#cb28-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-243"><a href="#cb28-243" aria-hidden="true" tabindex="-1"></a>In R, you can use the standard <span class="in">`lm()`</span> function, but it treats country and year as regular explanatory variables, so it includes them in the results from <span class="in">`summary()`</span> or <span class="in">`tidy()`</span>. If you don't want overly long and detailed results tables, you have to filter those results out.</span>
<span id="cb28-244"><a href="#cb28-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-245"><a href="#cb28-245" aria-hidden="true" tabindex="-1"></a><span class="in">```{r twfe-lm}</span></span>
<span id="cb28-246"><a href="#cb28-246" aria-hidden="true" tabindex="-1"></a><span class="in">model_lm &lt;- lm(primary ~ treatment + country + factor(year),</span></span>
<span id="cb28-247"><a href="#cb28-247" aria-hidden="true" tabindex="-1"></a><span class="in">               data = fpe_primary)</span></span>
<span id="cb28-248"><a href="#cb28-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-249"><a href="#cb28-249" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_lm) %&gt;%</span></span>
<span id="cb28-250"><a href="#cb28-250" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(!str_detect(term, "country"), !str_detect(term, "year"))</span></span>
<span id="cb28-251"><a href="#cb28-251" aria-hidden="true" tabindex="-1"></a><span class="in">glance(model_lm)</span></span>
<span id="cb28-252"><a href="#cb28-252" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-253"><a href="#cb28-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-254"><a href="#cb28-254" aria-hidden="true" tabindex="-1"></a>These observations are clustered by country, so we should probably <span class="co">[</span><span class="ot">cluster our standard errors to capture within-country errors</span><span class="co">](https://theeffectbook.net/ch-StatisticalAdjustment.html#your-standard-errors-are-probably-wrong)</span>. Using <span class="in">`lm()`</span> doesn't let you automatically create robust or clustered standard errors. You can use <span class="in">`lmtest::coeftest()`</span> to do that after the fact, though. We can copy Stata's standard errors precisely if we (1) specify the variance-covariance matrix using the <span class="in">`vcovCl()`</span> function from the **sandwich** library, and (2) specify the degrees of freedom to use, based on the number of countries in the data, minus 1.</span>
<span id="cb28-255"><a href="#cb28-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-256"><a href="#cb28-256" aria-hidden="true" tabindex="-1"></a><span class="in">```{r twfe-lm-coeftest}</span></span>
<span id="cb28-257"><a href="#cb28-257" aria-hidden="true" tabindex="-1"></a><span class="in">df_primary &lt;- fpe_primary %&gt;% distinct(country) %&gt;% nrow()</span></span>
<span id="cb28-258"><a href="#cb28-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-259"><a href="#cb28-259" aria-hidden="true" tabindex="-1"></a><span class="in">model_lm_clustered &lt;- lmtest::coeftest(model_lm,</span></span>
<span id="cb28-260"><a href="#cb28-260" aria-hidden="true" tabindex="-1"></a><span class="in">                                       vcov = sandwich::vcovCL,</span></span>
<span id="cb28-261"><a href="#cb28-261" aria-hidden="true" tabindex="-1"></a><span class="in">                                       cluster = ~country,</span></span>
<span id="cb28-262"><a href="#cb28-262" aria-hidden="true" tabindex="-1"></a><span class="in">                                       df = df_primary - 1,</span></span>
<span id="cb28-263"><a href="#cb28-263" aria-hidden="true" tabindex="-1"></a><span class="in">                                       # Keep original model so modelsummary shows R2</span></span>
<span id="cb28-264"><a href="#cb28-264" aria-hidden="true" tabindex="-1"></a><span class="in">                                       save = TRUE)</span></span>
<span id="cb28-265"><a href="#cb28-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-266"><a href="#cb28-266" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_lm_clustered) %&gt;%</span></span>
<span id="cb28-267"><a href="#cb28-267" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(!str_detect(term, "country"), !str_detect(term, "year"))</span></span>
<span id="cb28-268"><a href="#cb28-268" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-269"><a href="#cb28-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-270"><a href="#cb28-270" aria-hidden="true" tabindex="-1"></a>You can also use fancier regression functions that can handle fixed effects more systematically. The <span class="in">`lm_robust()`</span> function from <span class="co">[</span><span class="ot">the **estimatr** package</span><span class="co">](https://declaredesign.org/r/estimatr/)</span> works really well for defining special fixed effects that are automatically omitted from results tables *and* returning robust and optionally clustered standard errors:</span>
<span id="cb28-271"><a href="#cb28-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-272"><a href="#cb28-272" aria-hidden="true" tabindex="-1"></a><span class="in">```{r twfe-lm-robust}</span></span>
<span id="cb28-273"><a href="#cb28-273" aria-hidden="true" tabindex="-1"></a><span class="in">model_lm_robust &lt;- lm_robust(primary ~ treatment,</span></span>
<span id="cb28-274"><a href="#cb28-274" aria-hidden="true" tabindex="-1"></a><span class="in">                             fixed_effects = ~ country + year,</span></span>
<span id="cb28-275"><a href="#cb28-275" aria-hidden="true" tabindex="-1"></a><span class="in">                             data = fpe_primary,</span></span>
<span id="cb28-276"><a href="#cb28-276" aria-hidden="true" tabindex="-1"></a><span class="in">                             clusters = country, se_type = "stata")</span></span>
<span id="cb28-277"><a href="#cb28-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-278"><a href="#cb28-278" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_lm_robust)</span></span>
<span id="cb28-279"><a href="#cb28-279" aria-hidden="true" tabindex="-1"></a><span class="in">glance(model_lm_robust)</span></span>
<span id="cb28-280"><a href="#cb28-280" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-281"><a href="#cb28-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-282"><a href="#cb28-282" aria-hidden="true" tabindex="-1"></a>The <span class="in">`feols()`</span> function from <span class="co">[</span><span class="ot">the **fixest** package</span><span class="co">](https://lrberge.github.io/fixest/)</span> also works well, though you need to change one of the default settings to get the same SEs as Stata when you have a small sample with nested fixed effects like we have here. By default, <span class="in">`feols()`</span> will nest the fixed effect errors (which is also what <span class="co">[</span><span class="ot">Stata's `reghdfe` package</span><span class="co">](http://scorreia.com/software/reghdfe/)</span> does), but you can tell it to use the full set of country and year fixed effect errors with the <span class="in">`dof`</span> argument (thanks to <span class="co">[</span><span class="ot">Grant McDermott</span><span class="co">](https://grantmcdermott.com/)</span> for pointing this out!):</span>
<span id="cb28-283"><a href="#cb28-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-284"><a href="#cb28-284" aria-hidden="true" tabindex="-1"></a><span class="in">```{r twfe-feols}</span></span>
<span id="cb28-285"><a href="#cb28-285" aria-hidden="true" tabindex="-1"></a><span class="in">model_feols &lt;- feols(primary ~ treatment | country + year,</span></span>
<span id="cb28-286"><a href="#cb28-286" aria-hidden="true" tabindex="-1"></a><span class="in">                     data = fpe_primary,</span></span>
<span id="cb28-287"><a href="#cb28-287" aria-hidden="true" tabindex="-1"></a><span class="in">                     cluster = ~ country,</span></span>
<span id="cb28-288"><a href="#cb28-288" aria-hidden="true" tabindex="-1"></a><span class="in">                     dof = dof(fixef.K = "full"))</span></span>
<span id="cb28-289"><a href="#cb28-289" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_feols)</span></span>
<span id="cb28-290"><a href="#cb28-290" aria-hidden="true" tabindex="-1"></a><span class="in">glance(model_feols)</span></span>
<span id="cb28-291"><a href="#cb28-291" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-292"><a href="#cb28-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-293"><a href="#cb28-293" aria-hidden="true" tabindex="-1"></a>We can show these all in a side-by-side table using <span class="co">[</span><span class="ot">the **modelsummary** package</span><span class="co">](https://vincentarelbundock.github.io/modelsummary/)</span>. Conveniently, <span class="in">`modelsummary()`</span> also lets you <span class="co">[</span><span class="ot">adjust standard errors on the fly</span><span class="co">](https://grantmcdermott.com/better-way-adjust-SEs/)</span> with the <span class="in">`vcov`</span> argument, so we could theoretically handle all the clustering here instead of inside <span class="in">`lmtest::coeftest()`</span>, <span class="in">`lm_robust()`</span>, or <span class="in">`feols()`</span>. But since we already specified the clusters above, we'll just use those.</span>
<span id="cb28-294"><a href="#cb28-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-295"><a href="#cb28-295" aria-hidden="true" tabindex="-1"></a><span class="in">```{r twfe-modelsummary, warning=FALSE}</span></span>
<span id="cb28-296"><a href="#cb28-296" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb28-297"><a href="#cb28-297" aria-hidden="true" tabindex="-1"></a><span class="in"># Look at secondary schools too</span></span>
<span id="cb28-298"><a href="#cb28-298" aria-hidden="true" tabindex="-1"></a><span class="in">model_lm_sec &lt;- lm(secondary ~ treatment + country + factor(year),</span></span>
<span id="cb28-299"><a href="#cb28-299" aria-hidden="true" tabindex="-1"></a><span class="in">                   data = fpe_secondary)</span></span>
<span id="cb28-300"><a href="#cb28-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-301"><a href="#cb28-301" aria-hidden="true" tabindex="-1"></a><span class="in">df_secondary &lt;- fpe_secondary %&gt;% distinct(country) %&gt;% nrow()</span></span>
<span id="cb28-302"><a href="#cb28-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-303"><a href="#cb28-303" aria-hidden="true" tabindex="-1"></a><span class="in">model_lm_clustered_sec &lt;- lmtest::coeftest(model_lm_sec,</span></span>
<span id="cb28-304"><a href="#cb28-304" aria-hidden="true" tabindex="-1"></a><span class="in">                                           vcov = sandwich::vcovCL,</span></span>
<span id="cb28-305"><a href="#cb28-305" aria-hidden="true" tabindex="-1"></a><span class="in">                                           cluster = ~country,</span></span>
<span id="cb28-306"><a href="#cb28-306" aria-hidden="true" tabindex="-1"></a><span class="in">                                           df = df_secondary - 1,</span></span>
<span id="cb28-307"><a href="#cb28-307" aria-hidden="true" tabindex="-1"></a><span class="in">                                           save = TRUE)</span></span>
<span id="cb28-308"><a href="#cb28-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-309"><a href="#cb28-309" aria-hidden="true" tabindex="-1"></a><span class="in">model_lm_robust_sec &lt;- lm_robust(secondary ~ treatment,</span></span>
<span id="cb28-310"><a href="#cb28-310" aria-hidden="true" tabindex="-1"></a><span class="in">                                 fixed_effects = ~ country + year,</span></span>
<span id="cb28-311"><a href="#cb28-311" aria-hidden="true" tabindex="-1"></a><span class="in">                                 data = fpe_secondary,</span></span>
<span id="cb28-312"><a href="#cb28-312" aria-hidden="true" tabindex="-1"></a><span class="in">                                 clusters = country, se_type = "stata")</span></span>
<span id="cb28-313"><a href="#cb28-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-314"><a href="#cb28-314" aria-hidden="true" tabindex="-1"></a><span class="in">model_feols_sec &lt;- feols(secondary ~ treatment | country + year,</span></span>
<span id="cb28-315"><a href="#cb28-315" aria-hidden="true" tabindex="-1"></a><span class="in">                         data = fpe_secondary,</span></span>
<span id="cb28-316"><a href="#cb28-316" aria-hidden="true" tabindex="-1"></a><span class="in">                         cluster = ~ country,</span></span>
<span id="cb28-317"><a href="#cb28-317" aria-hidden="true" tabindex="-1"></a><span class="in">                         dof = dof(fixef.K = "full"))</span></span>
<span id="cb28-318"><a href="#cb28-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-319"><a href="#cb28-319" aria-hidden="true" tabindex="-1"></a><span class="in"># Define the goodness-of-fit stats to include</span></span>
<span id="cb28-320"><a href="#cb28-320" aria-hidden="true" tabindex="-1"></a><span class="in">gof_stuff &lt;- tribble(</span></span>
<span id="cb28-321"><a href="#cb28-321" aria-hidden="true" tabindex="-1"></a><span class="in">  ~raw, ~clean, ~fmt,</span></span>
<span id="cb28-322"><a href="#cb28-322" aria-hidden="true" tabindex="-1"></a><span class="in">  "nobs", "N", 0,</span></span>
<span id="cb28-323"><a href="#cb28-323" aria-hidden="true" tabindex="-1"></a><span class="in">  "r.squared", "R²", 3</span></span>
<span id="cb28-324"><a href="#cb28-324" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb28-325"><a href="#cb28-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-326"><a href="#cb28-326" aria-hidden="true" tabindex="-1"></a><span class="in"># Define extra rows at the end of the table</span></span>
<span id="cb28-327"><a href="#cb28-327" aria-hidden="true" tabindex="-1"></a><span class="in">extra_rows &lt;- tribble(</span></span>
<span id="cb28-328"><a href="#cb28-328" aria-hidden="true" tabindex="-1"></a><span class="in">  ~term, ~a, ~b, ~c, ~d, ~e, ~f,</span></span>
<span id="cb28-329"><a href="#cb28-329" aria-hidden="true" tabindex="-1"></a><span class="in">  "Country fixed effects", "•", "•", "•", "•", "•", "•",</span></span>
<span id="cb28-330"><a href="#cb28-330" aria-hidden="true" tabindex="-1"></a><span class="in">  "Year fixed effects", "•", "•", "•", "•", "•", "•"</span></span>
<span id="cb28-331"><a href="#cb28-331" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb28-332"><a href="#cb28-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-333"><a href="#cb28-333" aria-hidden="true" tabindex="-1"></a><span class="in">modelsummary(list("&lt;code&gt;lm()&lt;/code&gt;" = model_lm_clustered,</span></span>
<span id="cb28-334"><a href="#cb28-334" aria-hidden="true" tabindex="-1"></a><span class="in">                  "&lt;code&gt;lm_robust()&lt;/code&gt;" = model_lm_robust,</span></span>
<span id="cb28-335"><a href="#cb28-335" aria-hidden="true" tabindex="-1"></a><span class="in">                  "&lt;code&gt;feols()&lt;/code&gt;" = model_feols,</span></span>
<span id="cb28-336"><a href="#cb28-336" aria-hidden="true" tabindex="-1"></a><span class="in">                  "&lt;code&gt;lm()&lt;/code&gt;" = model_lm_clustered_sec,</span></span>
<span id="cb28-337"><a href="#cb28-337" aria-hidden="true" tabindex="-1"></a><span class="in">                  "&lt;code&gt;lm_robust()&lt;/code&gt;" = model_lm_robust_sec,</span></span>
<span id="cb28-338"><a href="#cb28-338" aria-hidden="true" tabindex="-1"></a><span class="in">                  "&lt;code&gt;feols()&lt;/code&gt;" = model_feols_sec),</span></span>
<span id="cb28-339"><a href="#cb28-339" aria-hidden="true" tabindex="-1"></a><span class="in">             coef_rename = c("treatment" = "Treatment"),</span></span>
<span id="cb28-340"><a href="#cb28-340" aria-hidden="true" tabindex="-1"></a><span class="in">             estimate = "{estimate}",</span></span>
<span id="cb28-341"><a href="#cb28-341" aria-hidden="true" tabindex="-1"></a><span class="in">             statistic = c("s.e. = {std.error}", "p = {p.value}"),</span></span>
<span id="cb28-342"><a href="#cb28-342" aria-hidden="true" tabindex="-1"></a><span class="in">             coef_omit = "^country|^factor|Intercept",</span></span>
<span id="cb28-343"><a href="#cb28-343" aria-hidden="true" tabindex="-1"></a><span class="in">             gof_map = gof_stuff,</span></span>
<span id="cb28-344"><a href="#cb28-344" aria-hidden="true" tabindex="-1"></a><span class="in">             add_rows = extra_rows,</span></span>
<span id="cb28-345"><a href="#cb28-345" aria-hidden="true" tabindex="-1"></a><span class="in">             escape = FALSE, output = "kableExtra") %&gt;%</span></span>
<span id="cb28-346"><a href="#cb28-346" aria-hidden="true" tabindex="-1"></a><span class="in">  add_header_above(c(" " = 1, "Primary enrollment" = 3, "Secondary enrollment" = 3)) %&gt;%</span></span>
<span id="cb28-347"><a href="#cb28-347" aria-hidden="true" tabindex="-1"></a><span class="in">  kable_styling(htmltable_class = "table table-sm")</span></span>
<span id="cb28-348"><a href="#cb28-348" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-349"><a href="#cb28-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-350"><a href="#cb28-350" aria-hidden="true" tabindex="-1"></a>All these models show the same result: **eliminating primary school fees caused primary school enrollment to increase by 20.4 percentage points.** That's astounding! Removing these fees doesn't have any effect on secondary enrollment though.</span>
<span id="cb28-351"><a href="#cb28-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-352"><a href="#cb28-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-353"><a href="#cb28-353" aria-hidden="true" tabindex="-1"></a><span class="fu">### TWFE estimate with residualized treatment weights</span></span>
<span id="cb28-354"><a href="#cb28-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-355"><a href="#cb28-355" aria-hidden="true" tabindex="-1"></a>These regressions are simple enough to run with <span class="in">`lm()`</span> or <span class="in">`lm_robust()`</span>, but there's an issue with differential timing here. These 15 countries each passed laws eliminating fees in different years:</span>
<span id="cb28-356"><a href="#cb28-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-357"><a href="#cb28-357" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-fpe-start}</span></span>
<span id="cb28-358"><a href="#cb28-358" aria-hidden="true" tabindex="-1"></a><span class="in">plot_fpe_start &lt;- fpe_raw %&gt;%</span></span>
<span id="cb28-359"><a href="#cb28-359" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(year == fpe_year) %&gt;%</span></span>
<span id="cb28-360"><a href="#cb28-360" aria-hidden="true" tabindex="-1"></a><span class="in">  arrange(fpe_year, country) %&gt;%</span></span>
<span id="cb28-361"><a href="#cb28-361" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(country = fct_inorder(country))</span></span>
<span id="cb28-362"><a href="#cb28-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-363"><a href="#cb28-363" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(plot_fpe_start, aes(y = fct_rev(country))) +</span></span>
<span id="cb28-364"><a href="#cb28-364" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_segment(aes(x = fpe_year, xend = 2015, yend = country),</span></span>
<span id="cb28-365"><a href="#cb28-365" aria-hidden="true" tabindex="-1"></a><span class="in">               size = 3, color = "#D6EB52") +</span></span>
<span id="cb28-366"><a href="#cb28-366" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_text(aes(x = fpe_year + 0.2), label = "▶", family = "Arial Unicode MS",</span></span>
<span id="cb28-367"><a href="#cb28-367" aria-hidden="true" tabindex="-1"></a><span class="in">            size = 8, color = "#A4BD0A") +</span></span>
<span id="cb28-368"><a href="#cb28-368" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Year free primary education implemented", y = NULL) +</span></span>
<span id="cb28-369"><a href="#cb28-369" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_clean()</span></span>
<span id="cb28-370"><a href="#cb28-370" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-371"><a href="#cb28-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-372"><a href="#cb28-372" aria-hidden="true" tabindex="-1"></a>This timing could cause problems. To see these issues, let's calculate the ATE ($\beta$) with that fancy schmancy Frisch-Waugh-Lovell theorem with residualized treatment weights. There's one key difference here when calculating the residuals though. With the simple model earlier, the treatment residuals were just $D_i - \bar{D}$, or the residuals from <span class="in">`lm(treatment ~ 1)`</span>. In TWFE situations, though, treatment residuals need to account for both country and year fixed effects, or <span class="in">`lm(treatment ~ country + year)`</span>:</span>
<span id="cb28-373"><a href="#cb28-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-374"><a href="#cb28-374" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-375"><a href="#cb28-375" aria-hidden="true" tabindex="-1"></a>\color{#0599B0}{\beta^{\text{TWFE}}} \color{black}{= \sum_{it}} \color{#FFA615}{Y_{it}} \color{black} \left( \frac{\color{#353D03}{\tilde{D}_{it}}}{\sum_{it} \color{#353D03}{\tilde{D}_{it}}^2} \right)</span>
<span id="cb28-376"><a href="#cb28-376" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-377"><a href="#cb28-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-378"><a href="#cb28-378" aria-hidden="true" tabindex="-1"></a>Or, with code:</span>
<span id="cb28-379"><a href="#cb28-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-380"><a href="#cb28-380" aria-hidden="true" tabindex="-1"></a><span class="in">```{r calc-treatment-weights}</span></span>
<span id="cb28-381"><a href="#cb28-381" aria-hidden="true" tabindex="-1"></a><span class="in">trt_resid_primary &lt;- lm(treatment ~ country + factor(year), data = fpe_primary)</span></span>
<span id="cb28-382"><a href="#cb28-382" aria-hidden="true" tabindex="-1"></a><span class="in">trt_resid_secondary &lt;- lm(treatment ~ country + factor(year), data = fpe_secondary)</span></span>
<span id="cb28-383"><a href="#cb28-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-384"><a href="#cb28-384" aria-hidden="true" tabindex="-1"></a><span class="in">fpe_primary_weights &lt;- fpe_primary %&gt;%</span></span>
<span id="cb28-385"><a href="#cb28-385" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(treatment_resid = residuals(trt_resid_primary)) %&gt;%</span></span>
<span id="cb28-386"><a href="#cb28-386" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(treatment_weight = treatment_resid / sum(treatment_resid^2))</span></span>
<span id="cb28-387"><a href="#cb28-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-388"><a href="#cb28-388" aria-hidden="true" tabindex="-1"></a><span class="in">fpe_secondary_weights &lt;- fpe_secondary %&gt;%</span></span>
<span id="cb28-389"><a href="#cb28-389" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(treatment_resid = residuals(trt_resid_secondary)) %&gt;%</span></span>
<span id="cb28-390"><a href="#cb28-390" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(treatment_weight = treatment_resid / sum(treatment_resid^2))</span></span>
<span id="cb28-391"><a href="#cb28-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-392"><a href="#cb28-392" aria-hidden="true" tabindex="-1"></a><span class="in">fpe_primary_weights %&gt;%</span></span>
<span id="cb28-393"><a href="#cb28-393" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(twfe_beta_primary = sum(primary * treatment_weight))</span></span>
<span id="cb28-394"><a href="#cb28-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-395"><a href="#cb28-395" aria-hidden="true" tabindex="-1"></a><span class="in">fpe_secondary_weights %&gt;%</span></span>
<span id="cb28-396"><a href="#cb28-396" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(twfe_beta_secondary = sum(secondary * treatment_weight))</span></span>
<span id="cb28-397"><a href="#cb28-397" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-398"><a href="#cb28-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-399"><a href="#cb28-399" aria-hidden="true" tabindex="-1"></a>Whoa! It still works this way. This still blows my mind every time.</span>
<span id="cb28-400"><a href="#cb28-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-401"><a href="#cb28-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-402"><a href="#cb28-402" aria-hidden="true" tabindex="-1"></a><span class="fu">## Jakiela's diagnostics</span></span>
<span id="cb28-403"><a href="#cb28-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-404"><a href="#cb28-404" aria-hidden="true" tabindex="-1"></a>However, because of the differential treatment timing, there are some issues with weighting. Remember from the simple example with fake data that observations in the treatment group typically have positive treatment weights, while those in the comparison/control group have negative weights. With TWFE, some observations' weights switch directions. There are systematic reasons for this. According to @Jakiela:2021 <span class="co">[</span><span class="ot">p. 5</span><span class="co">]</span>, negative weights in treated observations are more likely in (1) early adopter countries, since the country-level treatment mean is high, and (2) later years, since the year-level treatment mean is higher. </span>
<span id="cb28-405"><a href="#cb28-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-406"><a href="#cb28-406" aria-hidden="true" tabindex="-1"></a>Having negative weights on treated observations isn't necessarily bad! It's often just a mathematical artefact, and if you have (1) enough never-treated observations and (2) enough pre-treatment data, and if (3) the treatment effects are homogenous across all countries, it won't be a problem. But if you don't have enough data, your results will be biased and distorted for later years and for early adopters.</span>
<span id="cb28-407"><a href="#cb28-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-408"><a href="#cb28-408" aria-hidden="true" tabindex="-1"></a>Starting in section 3 of her paper, Jakiela presents a set of diagnostics to see how bad these distortions might be. We need to answer two questions:</span>
<span id="cb28-409"><a href="#cb28-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-410"><a href="#cb28-410" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Do any treated units get negative weight when calculating $\beta^{\text{TWFE}}$? Check this by looking at the weights</span>
<span id="cb28-411"><a href="#cb28-411" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Can we reject the hypothesis that the treatment effects are homogenous? Check this by looking at the relationship between $\tilde{Y}_{it}$ and $\tilde{D}_{it}$. The slope shouldn't be different.</span>
<span id="cb28-412"><a href="#cb28-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-413"><a href="#cb28-413" aria-hidden="true" tabindex="-1"></a><span class="fu">### 3.1: Do treated observations receive negative weights?</span></span>
<span id="cb28-414"><a href="#cb28-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-415"><a href="#cb28-415" aria-hidden="true" tabindex="-1"></a>For this first diagnostic, we need to investigate patterns in the residualized weights. Some of the treated country-year observations have negative weight:</span>
<span id="cb28-416"><a href="#cb28-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-417"><a href="#cb28-417" aria-hidden="true" tabindex="-1"></a><span class="in">```{r calc-treated-negative}</span></span>
<span id="cb28-418"><a href="#cb28-418" aria-hidden="true" tabindex="-1"></a><span class="in"># Total treated in primary data</span></span>
<span id="cb28-419"><a href="#cb28-419" aria-hidden="true" tabindex="-1"></a><span class="in">n_treated_primary &lt;- fpe_primary_weights %&gt;%</span></span>
<span id="cb28-420"><a href="#cb28-420" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(treatment == 1) %&gt;%</span></span>
<span id="cb28-421"><a href="#cb28-421" aria-hidden="true" tabindex="-1"></a><span class="in">  nrow()</span></span>
<span id="cb28-422"><a href="#cb28-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-423"><a href="#cb28-423" aria-hidden="true" tabindex="-1"></a><span class="in"># Total treated in secondary data</span></span>
<span id="cb28-424"><a href="#cb28-424" aria-hidden="true" tabindex="-1"></a><span class="in">n_treated_secondary &lt;- fpe_secondary_weights %&gt;%</span></span>
<span id="cb28-425"><a href="#cb28-425" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(treatment == 1) %&gt;%</span></span>
<span id="cb28-426"><a href="#cb28-426" aria-hidden="true" tabindex="-1"></a><span class="in">  nrow()</span></span>
<span id="cb28-427"><a href="#cb28-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-428"><a href="#cb28-428" aria-hidden="true" tabindex="-1"></a><span class="in"># Negatively weighted treated observations in the primary data</span></span>
<span id="cb28-429"><a href="#cb28-429" aria-hidden="true" tabindex="-1"></a><span class="in">n_treated_negative_primary &lt;- fpe_primary_weights %&gt;%</span></span>
<span id="cb28-430"><a href="#cb28-430" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(treatment_weight &lt; 0 &amp; treatment == 1) %&gt;%</span></span>
<span id="cb28-431"><a href="#cb28-431" aria-hidden="true" tabindex="-1"></a><span class="in">  nrow()</span></span>
<span id="cb28-432"><a href="#cb28-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-433"><a href="#cb28-433" aria-hidden="true" tabindex="-1"></a><span class="in">n_treated_negative_primary</span></span>
<span id="cb28-434"><a href="#cb28-434" aria-hidden="true" tabindex="-1"></a><span class="in">n_treated_negative_primary / n_treated_primary</span></span>
<span id="cb28-435"><a href="#cb28-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-436"><a href="#cb28-436" aria-hidden="true" tabindex="-1"></a><span class="in"># Negatively weighted treated observations in the secondary data</span></span>
<span id="cb28-437"><a href="#cb28-437" aria-hidden="true" tabindex="-1"></a><span class="in">n_treated_negative_secondary &lt;- fpe_secondary_weights %&gt;%</span></span>
<span id="cb28-438"><a href="#cb28-438" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(treatment_weight &lt; 0 &amp; treatment == 1) %&gt;%</span></span>
<span id="cb28-439"><a href="#cb28-439" aria-hidden="true" tabindex="-1"></a><span class="in">  nrow()</span></span>
<span id="cb28-440"><a href="#cb28-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-441"><a href="#cb28-441" aria-hidden="true" tabindex="-1"></a><span class="in">n_treated_negative_secondary</span></span>
<span id="cb28-442"><a href="#cb28-442" aria-hidden="true" tabindex="-1"></a><span class="in">n_treated_negative_secondary / n_treated_secondary</span></span>
<span id="cb28-443"><a href="#cb28-443" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-444"><a href="#cb28-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-445"><a href="#cb28-445" aria-hidden="true" tabindex="-1"></a>Roughly a quarter of the treated observations in both the primary and secondary enrollment data are negatively weighted. That might be bad.</span>
<span id="cb28-446"><a href="#cb28-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-447"><a href="#cb28-447" aria-hidden="true" tabindex="-1"></a>We can look at the distribution of these weights too:</span>
<span id="cb28-448"><a href="#cb28-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-449"><a href="#cb28-449" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-weights-hist, fig.width=8, fig.height=4.5, out.width="100%"}</span></span>
<span id="cb28-450"><a href="#cb28-450" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb28-451"><a href="#cb28-451" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-inset-right</span></span>
<span id="cb28-452"><a href="#cb28-452" aria-hidden="true" tabindex="-1"></a><span class="in">plot_weights_primary &lt;- fpe_primary_weights %&gt;%</span></span>
<span id="cb28-453"><a href="#cb28-453" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(treatment_fct = factor(treatment, labels = c("Untreated", "Treated"), ordered = TRUE)) %&gt;%</span></span>
<span id="cb28-454"><a href="#cb28-454" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(oh_no = (treatment == 1 &amp; treatment_weight &lt; 0) | (treatment == 0 &amp; treatment_weight &gt; 0))</span></span>
<span id="cb28-455"><a href="#cb28-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-456"><a href="#cb28-456" aria-hidden="true" tabindex="-1"></a><span class="in">plot_weights_secondary &lt;- fpe_secondary_weights %&gt;%</span></span>
<span id="cb28-457"><a href="#cb28-457" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(treatment_fct = factor(treatment, labels = c("Untreated", "Treated"), ordered = TRUE)) %&gt;%</span></span>
<span id="cb28-458"><a href="#cb28-458" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(oh_no = (treatment == 1 &amp; treatment_weight &lt; 0) | (treatment == 0 &amp; treatment_weight &gt; 0))</span></span>
<span id="cb28-459"><a href="#cb28-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-460"><a href="#cb28-460" aria-hidden="true" tabindex="-1"></a><span class="in">hist_primary &lt;- ggplot(plot_weights_primary,</span></span>
<span id="cb28-461"><a href="#cb28-461" aria-hidden="true" tabindex="-1"></a><span class="in">                       aes(x = treatment_weight, fill = treatment_fct, alpha = oh_no)) +</span></span>
<span id="cb28-462"><a href="#cb28-462" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_histogram(binwidth = 0.002, color = "white", boundary = 0,</span></span>
<span id="cb28-463"><a href="#cb28-463" aria-hidden="true" tabindex="-1"></a><span class="in">                 position = position_identity()) +</span></span>
<span id="cb28-464"><a href="#cb28-464" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0, color = "#FF4136", size = 0.5) +</span></span>
<span id="cb28-465"><a href="#cb28-465" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_alpha_manual(values = c(0.6, 1)) +</span></span>
<span id="cb28-466"><a href="#cb28-466" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_viridis_d(option = "rocket", begin = 0.2, end = 0.8) +</span></span>
<span id="cb28-467"><a href="#cb28-467" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Residualized treatment", y = "Count",</span></span>
<span id="cb28-468"><a href="#cb28-468" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "Primary school enrollment") +</span></span>
<span id="cb28-469"><a href="#cb28-469" aria-hidden="true" tabindex="-1"></a><span class="in">  guides(fill = "none", alpha = "none") +</span></span>
<span id="cb28-470"><a href="#cb28-470" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(vars(treatment_fct), ncol = 1) +</span></span>
<span id="cb28-471"><a href="#cb28-471" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_clean()</span></span>
<span id="cb28-472"><a href="#cb28-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-473"><a href="#cb28-473" aria-hidden="true" tabindex="-1"></a><span class="in">hist_secondary &lt;- ggplot(plot_weights_secondary,</span></span>
<span id="cb28-474"><a href="#cb28-474" aria-hidden="true" tabindex="-1"></a><span class="in">                         aes(x = treatment_weight, fill = treatment_fct, alpha = oh_no)) +</span></span>
<span id="cb28-475"><a href="#cb28-475" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_histogram(binwidth = 0.002, color = "white", boundary = 0,</span></span>
<span id="cb28-476"><a href="#cb28-476" aria-hidden="true" tabindex="-1"></a><span class="in">                 position = position_identity()) +</span></span>
<span id="cb28-477"><a href="#cb28-477" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0, color = "#FF4136", size = 0.5) +</span></span>
<span id="cb28-478"><a href="#cb28-478" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_alpha_manual(values = c(0.6, 1)) +</span></span>
<span id="cb28-479"><a href="#cb28-479" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_viridis_d(option = "rocket", begin = 0.2, end = 0.8) +</span></span>
<span id="cb28-480"><a href="#cb28-480" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Residualized treatment", y = "Count",</span></span>
<span id="cb28-481"><a href="#cb28-481" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "Secondary school enrollment") +</span></span>
<span id="cb28-482"><a href="#cb28-482" aria-hidden="true" tabindex="-1"></a><span class="in">  guides(fill = "none", alpha = "none") +</span></span>
<span id="cb28-483"><a href="#cb28-483" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(vars(treatment_fct), ncol = 1) +</span></span>
<span id="cb28-484"><a href="#cb28-484" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_clean()</span></span>
<span id="cb28-485"><a href="#cb28-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-486"><a href="#cb28-486" aria-hidden="true" tabindex="-1"></a><span class="in">hist_primary + hist_secondary</span></span>
<span id="cb28-487"><a href="#cb28-487" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-488"><a href="#cb28-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-489"><a href="#cb28-489" aria-hidden="true" tabindex="-1"></a>These histograms confirm the proportions we found earlier—about 25% of the treated observations have negative weights.</span>
<span id="cb28-490"><a href="#cb28-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-491"><a href="#cb28-491" aria-hidden="true" tabindex="-1"></a>Which treated country-years are getting these negative weights, though? According to Jakiela, early adopters and later years are more likely to have this switch happen. Let's make another plot:</span>
<span id="cb28-492"><a href="#cb28-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-493"><a href="#cb28-493" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-weight-waffle, fig.width=7, fig.height=8, out.width="100%"}</span></span>
<span id="cb28-494"><a href="#cb28-494" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb28-495"><a href="#cb28-495" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-inset-right</span></span>
<span id="cb28-496"><a href="#cb28-496" aria-hidden="true" tabindex="-1"></a><span class="in">plot_waffle_primary &lt;- fpe_primary_weights %&gt;%</span></span>
<span id="cb28-497"><a href="#cb28-497" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(weight_fill = case_when(</span></span>
<span id="cb28-498"><a href="#cb28-498" aria-hidden="true" tabindex="-1"></a><span class="in">    treatment_resid &lt; 0 &amp; treatment ~ "Treatment observations, negative weight",</span></span>
<span id="cb28-499"><a href="#cb28-499" aria-hidden="true" tabindex="-1"></a><span class="in">    treatment_resid &gt; 0 &amp; treatment ~ "Treatment observations, positive weight",</span></span>
<span id="cb28-500"><a href="#cb28-500" aria-hidden="true" tabindex="-1"></a><span class="in">    !treatment ~ "Comparison observations"</span></span>
<span id="cb28-501"><a href="#cb28-501" aria-hidden="true" tabindex="-1"></a><span class="in">  )) %&gt;%</span></span>
<span id="cb28-502"><a href="#cb28-502" aria-hidden="true" tabindex="-1"></a><span class="in">  arrange(desc(fpe_year), desc(country)) %&gt;%</span></span>
<span id="cb28-503"><a href="#cb28-503" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(country = fct_inorder(country)) %&gt;%</span></span>
<span id="cb28-504"><a href="#cb28-504" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(weight_fill = fct_inorder(weight_fill))</span></span>
<span id="cb28-505"><a href="#cb28-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-506"><a href="#cb28-506" aria-hidden="true" tabindex="-1"></a><span class="in">plot_waffle_secondary &lt;- fpe_secondary_weights %&gt;%</span></span>
<span id="cb28-507"><a href="#cb28-507" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(weight_fill = case_when(</span></span>
<span id="cb28-508"><a href="#cb28-508" aria-hidden="true" tabindex="-1"></a><span class="in">    treatment_resid &lt; 0 &amp; treatment ~ "Treatment observations, negative weight",</span></span>
<span id="cb28-509"><a href="#cb28-509" aria-hidden="true" tabindex="-1"></a><span class="in">    treatment_resid &gt; 0 &amp; treatment ~ "Treatment observations, positive weight",</span></span>
<span id="cb28-510"><a href="#cb28-510" aria-hidden="true" tabindex="-1"></a><span class="in">    !treatment ~ "Comparison observations"</span></span>
<span id="cb28-511"><a href="#cb28-511" aria-hidden="true" tabindex="-1"></a><span class="in">  )) %&gt;%</span></span>
<span id="cb28-512"><a href="#cb28-512" aria-hidden="true" tabindex="-1"></a><span class="in">  arrange(desc(fpe_year), desc(country)) %&gt;%</span></span>
<span id="cb28-513"><a href="#cb28-513" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(country = fct_inorder(country)) %&gt;%</span></span>
<span id="cb28-514"><a href="#cb28-514" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(weight_fill = fct_inorder(weight_fill))</span></span>
<span id="cb28-515"><a href="#cb28-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-516"><a href="#cb28-516" aria-hidden="true" tabindex="-1"></a><span class="in">waffle_primary &lt;- ggplot(plot_waffle_primary,</span></span>
<span id="cb28-517"><a href="#cb28-517" aria-hidden="true" tabindex="-1"></a><span class="in">                         aes(x = year, y = country, fill = weight_fill)) +</span></span>
<span id="cb28-518"><a href="#cb28-518" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_tile(color = "white", size = 0.5) +</span></span>
<span id="cb28-519"><a href="#cb28-519" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_manual(values = c("grey50", "#0074D9", "#FF4136"),</span></span>
<span id="cb28-520"><a href="#cb28-520" aria-hidden="true" tabindex="-1"></a><span class="in">                    guide = guide_legend(reverse = TRUE),</span></span>
<span id="cb28-521"><a href="#cb28-521" aria-hidden="true" tabindex="-1"></a><span class="in">                    name = NULL) +</span></span>
<span id="cb28-522"><a href="#cb28-522" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(expand = expansion(add = 0.5),</span></span>
<span id="cb28-523"><a href="#cb28-523" aria-hidden="true" tabindex="-1"></a><span class="in">                     breaks = seq(1980, 2015, 5)) +</span></span>
<span id="cb28-524"><a href="#cb28-524" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = NULL, y = NULL, title = "Primary school enrollment") +</span></span>
<span id="cb28-525"><a href="#cb28-525" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_equal() +</span></span>
<span id="cb28-526"><a href="#cb28-526" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_clean() +</span></span>
<span id="cb28-527"><a href="#cb28-527" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = "bottom",</span></span>
<span id="cb28-528"><a href="#cb28-528" aria-hidden="true" tabindex="-1"></a><span class="in">        panel.grid = element_blank(),</span></span>
<span id="cb28-529"><a href="#cb28-529" aria-hidden="true" tabindex="-1"></a><span class="in">        legend.key.size = unit(0.8, "lines"))</span></span>
<span id="cb28-530"><a href="#cb28-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-531"><a href="#cb28-531" aria-hidden="true" tabindex="-1"></a><span class="in">waffle_secondary &lt;- ggplot(plot_waffle_secondary,</span></span>
<span id="cb28-532"><a href="#cb28-532" aria-hidden="true" tabindex="-1"></a><span class="in">                         aes(x = year, y = country, fill = weight_fill)) +</span></span>
<span id="cb28-533"><a href="#cb28-533" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_tile(color = "white", size = 0.5) +</span></span>
<span id="cb28-534"><a href="#cb28-534" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_manual(values = c("grey50", "#0074D9", "#FF4136"),</span></span>
<span id="cb28-535"><a href="#cb28-535" aria-hidden="true" tabindex="-1"></a><span class="in">                    guide = guide_legend(reverse = TRUE),</span></span>
<span id="cb28-536"><a href="#cb28-536" aria-hidden="true" tabindex="-1"></a><span class="in">                    name = NULL) +</span></span>
<span id="cb28-537"><a href="#cb28-537" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(expand = expansion(add = 0.5),</span></span>
<span id="cb28-538"><a href="#cb28-538" aria-hidden="true" tabindex="-1"></a><span class="in">                     breaks = seq(1980, 2015, 5)) +</span></span>
<span id="cb28-539"><a href="#cb28-539" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = NULL, y = NULL, title = "Secondary school enrollment") +</span></span>
<span id="cb28-540"><a href="#cb28-540" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_equal() +</span></span>
<span id="cb28-541"><a href="#cb28-541" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_clean() +</span></span>
<span id="cb28-542"><a href="#cb28-542" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = "bottom",</span></span>
<span id="cb28-543"><a href="#cb28-543" aria-hidden="true" tabindex="-1"></a><span class="in">        panel.grid = element_blank(),</span></span>
<span id="cb28-544"><a href="#cb28-544" aria-hidden="true" tabindex="-1"></a><span class="in">        legend.key.size = unit(0.8, "lines"))</span></span>
<span id="cb28-545"><a href="#cb28-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-546"><a href="#cb28-546" aria-hidden="true" tabindex="-1"></a><span class="in">waffle_primary / waffle_secondary</span></span>
<span id="cb28-547"><a href="#cb28-547" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-548"><a href="#cb28-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-549"><a href="#cb28-549" aria-hidden="true" tabindex="-1"></a>And that is indeed the case! Malawi, Ethiopia, Ghana, Uganda, and Cameroon all eliminated fees before 2000, and they start getting negative weights after 2005. </span>
<span id="cb28-550"><a href="#cb28-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-551"><a href="#cb28-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-552"><a href="#cb28-552" aria-hidden="true" tabindex="-1"></a><span class="fu">### 3.2: Testing the homogeneity assumption directly</span></span>
<span id="cb28-553"><a href="#cb28-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-554"><a href="#cb28-554" aria-hidden="true" tabindex="-1"></a>We thus have issues with negative weighting here for early adopting countries and later country-years. However, as long as the treatment effects are homogenous—or that the elimination of school fees has the same effect across time and country—this negative weighting isn't an issue. If treatment effects are heterogenous—especially if the effects change over time within treated countries—the TWFE estimate will be severely biased.</span>
<span id="cb28-555"><a href="#cb28-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-556"><a href="#cb28-556" aria-hidden="true" tabindex="-1"></a>Jakiela's second diagnostic tests this assumption of homogeneity based on the mathematical relationship between the residuals of the outcome variable (<span class="in">`$\tilde{Y}_{it}$`</span>) and the residuals of the treatment variable (<span class="in">`$\tilde{D}_{it}$`</span>). Essentially, if there's no difference in slopes across treated and untreated observations in a regression of <span class="in">`$\tilde{Y}_{it} = \tilde{D}_{it}$`</span>, there's no evidence for heterogeneity and all is well.</span>
<span id="cb28-557"><a href="#cb28-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-558"><a href="#cb28-558" aria-hidden="true" tabindex="-1"></a>This wasn't intuitive for me since I'm not a real econometrician, so I had to dig into the math to try to wrap my head around it, and I'm still only like 80% sure I've got it :) </span>
<span id="cb28-559"><a href="#cb28-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-560"><a href="#cb28-560" aria-hidden="true" tabindex="-1"></a>We can think of the outcome $Y_{it}$ as a combination of three different moving parts: (1) an initial baseline value for each country, or $\mu_{i}$, (2) a constant change in each additional year in the absence of treatment (i.e. what would naturally happen over time regardless of an intervention), or $\eta_t$, and (3) a homogenous treatment effect, or $\delta$ (doesn't have subscripts for $i$ or $t$—it's the same across year and country):</span>
<span id="cb28-561"><a href="#cb28-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-562"><a href="#cb28-562" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-563"><a href="#cb28-563" aria-hidden="true" tabindex="-1"></a>\color{gray}{\overbrace{\color{#FFA615}{Y_{it}}}^{\text{Outcome}}} = \color{gray}{\overbrace{\color{black}{\mu_i}}^{\substack{\text{Baseline} <span class="sc">\\</span> \text{outcome} <span class="sc">\\</span> \text{at } t = 1}}} + \color{black} \sum_{\tau = 1}^t  \color{gray}{\overbrace{\color{black}{\eta_t}}^{\substack{\text{Global} <span class="sc">\\</span> \text{time} <span class="sc">\\</span> \text{trend}}}} + \color{gray}{\overbrace{\color{black}{\delta}}^{\substack{\text{Homogenous} <span class="sc">\\</span> \text{treatment} <span class="sc">\\</span> \text{effect}}}} \color{#A4BD0A}{D_{it}}</span>
<span id="cb28-564"><a href="#cb28-564" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-565"><a href="#cb28-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-566"><a href="#cb28-566" aria-hidden="true" tabindex="-1"></a>This all makes perfect sense is is nice and intuitive. It's how I typically generate fake data too (see the <span class="in">`outcome_baseline`</span> up at the beginning of this post, for instance) and it's a neat way of thinking about the separate components of a data generating process.</span>
<span id="cb28-567"><a href="#cb28-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-568"><a href="#cb28-568" aria-hidden="true" tabindex="-1"></a>According to Jakiela, if the treatment effect $\delta$ is truly homogenous over time and country, the residuals of the outcome (i.e. the residuals from a model like <span class="in">`lm(outcome ~ country + year)`</span>, or $\tilde{Y}_{it}$) should have a linear relationship to the residualized treatment (i.e. the residuals from a model like `lm(treatment ~ country + year)`, or $\delta\tilde{D}_{it}$).</span>
<span id="cb28-569"><a href="#cb28-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-570"><a href="#cb28-570" aria-hidden="true" tabindex="-1"></a>Again, due to my non-econometricianness, this idea that $\tilde{Y}_{it}$ should be related to $\delta\tilde{D}_{it}$ didn't click for me until I thought about this formula in more regression-y terms. Consider this pseudo-regression equation:</span>
<span id="cb28-571"><a href="#cb28-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-572"><a href="#cb28-572" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-573"><a href="#cb28-573" aria-hidden="true" tabindex="-1"></a>\overbrace{Y_{it}}^{\text{Outcome}} = \overbrace{\alpha_i}^{\text{Intercept}} + \overbrace{\beta_t}^{\text{Slope / trend}} + \overbrace{\epsilon_{it}}^{\text{Residuals}}</span>
<span id="cb28-574"><a href="#cb28-574" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-575"><a href="#cb28-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-576"><a href="#cb28-576" aria-hidden="true" tabindex="-1"></a>Here, if we run a regression like <span class="in">`lm(outcome ~ country + year)`</span>, the intercept $\alpha_i$ is analogous to $\mu_i$, the slope $\beta_t$ is like $\eta_t$, and whatever's leftover (i.e. $\epsilon_{it}$, or the residualized outcome $\tilde{Y}_{it}$) is similar to $\delta D_{it}$. $\delta D_{it}$ isn't the same as $\delta \tilde{D}_{it}$, but we can calculate the residualized treatment the same way by removing country and year effects (like <span class="in">`lm(treatment ~ country + year)`</span>). Basically, by residualizing both the treatment and outcome, and thus removing country and time effects (or the baseline country effect $\mu_i$ and the time trend $\eta_t$) from each, the residuals that remain are related to $\delta$.</span>
<span id="cb28-577"><a href="#cb28-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-578"><a href="#cb28-578" aria-hidden="true" tabindex="-1"></a>As long as $\delta$ is constant across time and country—or as long as the effect is homogenous—it should show up equally in the residuals for both the outcome and treatment for both treated and untreated observations. (I THINK! I'M NOT SURE ABOUT THIS)</span>
<span id="cb28-579"><a href="#cb28-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-580"><a href="#cb28-580" aria-hidden="true" tabindex="-1"></a>We already calculated the treatment residuals (or $\tilde{D}_{it}$) when we looked at treatment weights earlier, so now we just need to calculate the outcome residuals ($\tilde{Y}_{it}$). We can then see if the relationship between $\tilde{D}_{it}$ and $\tilde{D}_{it}$ looks the same for treated and untreated observations—the slopes in the two groups should be statistically indistinguishable from each other.</span>
<span id="cb28-581"><a href="#cb28-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-582"><a href="#cb28-582" aria-hidden="true" tabindex="-1"></a><span class="in">```{r calc-outcome-resid}</span></span>
<span id="cb28-583"><a href="#cb28-583" aria-hidden="true" tabindex="-1"></a><span class="in"># Build models for the residualized outcomes</span></span>
<span id="cb28-584"><a href="#cb28-584" aria-hidden="true" tabindex="-1"></a><span class="in">out_resid_primary &lt;- lm(primary ~ country + factor(year), data = fpe_primary)</span></span>
<span id="cb28-585"><a href="#cb28-585" aria-hidden="true" tabindex="-1"></a><span class="in">out_resid_secondary &lt;- lm(secondary ~ country + factor(year), data = fpe_secondary)</span></span>
<span id="cb28-586"><a href="#cb28-586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-587"><a href="#cb28-587" aria-hidden="true" tabindex="-1"></a><span class="in"># Add residuals to data with weights</span></span>
<span id="cb28-588"><a href="#cb28-588" aria-hidden="true" tabindex="-1"></a><span class="in">fpe_primary_weights &lt;- fpe_primary_weights %&gt;%</span></span>
<span id="cb28-589"><a href="#cb28-589" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(out_resid = residuals(out_resid_primary))</span></span>
<span id="cb28-590"><a href="#cb28-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-591"><a href="#cb28-591" aria-hidden="true" tabindex="-1"></a><span class="in">fpe_secondary_weights &lt;- fpe_secondary_weights %&gt;%</span></span>
<span id="cb28-592"><a href="#cb28-592" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(out_resid = residuals(out_resid_secondary))</span></span>
<span id="cb28-593"><a href="#cb28-593" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-594"><a href="#cb28-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-595"><a href="#cb28-595" aria-hidden="true" tabindex="-1"></a>We can check the similarity of these slopes a couple different ways. First, let's plot the residuals:</span>
<span id="cb28-596"><a href="#cb28-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-597"><a href="#cb28-597" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-outcome-trt-resid, message=FALSE, fig.width=8, fig.height=4.5, out.width="100%"}</span></span>
<span id="cb28-598"><a href="#cb28-598" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb28-599"><a href="#cb28-599" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-inset-right</span></span>
<span id="cb28-600"><a href="#cb28-600" aria-hidden="true" tabindex="-1"></a><span class="in">plot_out_trt_primary &lt;- ggplot(fpe_primary_weights,</span></span>
<span id="cb28-601"><a href="#cb28-601" aria-hidden="true" tabindex="-1"></a><span class="in">                               aes(x = treatment_resid, y = out_resid, color = factor(treatment))) +</span></span>
<span id="cb28-602"><a href="#cb28-602" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(size = 0.75, alpha = 0.5) +</span></span>
<span id="cb28-603"><a href="#cb28-603" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_smooth(aes(linetype = "Loess"), method = "loess", size = 1, se = FALSE, alpha = 0.5) +</span></span>
<span id="cb28-604"><a href="#cb28-604" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_smooth(aes(linetype = "OLS"), method = "lm", se = FALSE) +</span></span>
<span id="cb28-605"><a href="#cb28-605" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_color_viridis_d(option = "rocket", begin = 0.2, end = 0.8,</span></span>
<span id="cb28-606"><a href="#cb28-606" aria-hidden="true" tabindex="-1"></a><span class="in">                        labels = c("Untreated", "Treated")) +</span></span>
<span id="cb28-607"><a href="#cb28-607" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_linetype_manual(values = c("OLS" = "solid", "Loess" = "21"),</span></span>
<span id="cb28-608"><a href="#cb28-608" aria-hidden="true" tabindex="-1"></a><span class="in">                        guide = guide_legend(override.aes = list(color = "grey30"))) +</span></span>
<span id="cb28-609"><a href="#cb28-609" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Residualized treatment", y = "Residualized outcome",</span></span>
<span id="cb28-610"><a href="#cb28-610" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "Primary school enrollment", color = NULL, linetype = NULL) +</span></span>
<span id="cb28-611"><a href="#cb28-611" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_clean() +</span></span>
<span id="cb28-612"><a href="#cb28-612" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = "bottom")</span></span>
<span id="cb28-613"><a href="#cb28-613" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-614"><a href="#cb28-614" aria-hidden="true" tabindex="-1"></a><span class="in">plot_out_trt_secondary &lt;- ggplot(fpe_secondary_weights,</span></span>
<span id="cb28-615"><a href="#cb28-615" aria-hidden="true" tabindex="-1"></a><span class="in">                                 aes(x = treatment_resid, y = out_resid, color = factor(treatment))) +</span></span>
<span id="cb28-616"><a href="#cb28-616" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(size = 0.75, alpha = 0.5) +</span></span>
<span id="cb28-617"><a href="#cb28-617" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_smooth(aes(linetype = "Loess"), method = "loess", size = 1, se = FALSE, alpha = 0.5) +</span></span>
<span id="cb28-618"><a href="#cb28-618" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_smooth(aes(linetype = "OLS"), method = "lm", se = FALSE) +</span></span>
<span id="cb28-619"><a href="#cb28-619" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_color_viridis_d(option = "rocket", begin = 0.2, end = 0.8,</span></span>
<span id="cb28-620"><a href="#cb28-620" aria-hidden="true" tabindex="-1"></a><span class="in">                        labels = c("Untreated", "Treated")) +</span></span>
<span id="cb28-621"><a href="#cb28-621" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_linetype_manual(values = c("OLS" = "solid", "Loess" = "21"),</span></span>
<span id="cb28-622"><a href="#cb28-622" aria-hidden="true" tabindex="-1"></a><span class="in">                        guide = guide_legend(override.aes = list(color = "grey30"))) +</span></span>
<span id="cb28-623"><a href="#cb28-623" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Residualized treatment", y = "Residualized outcome",</span></span>
<span id="cb28-624"><a href="#cb28-624" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "Secondary school enrollment", color = NULL, linetype = NULL) +</span></span>
<span id="cb28-625"><a href="#cb28-625" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_clean() +</span></span>
<span id="cb28-626"><a href="#cb28-626" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = "bottom")</span></span>
<span id="cb28-627"><a href="#cb28-627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-628"><a href="#cb28-628" aria-hidden="true" tabindex="-1"></a><span class="in">plot_out_trt_primary | plot_out_trt_secondary</span></span>
<span id="cb28-629"><a href="#cb28-629" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-630"><a href="#cb28-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-631"><a href="#cb28-631" aria-hidden="true" tabindex="-1"></a>For primary enrollment, the lines for treated and untreated observations look like they have similar slopes. When using Loess lines, the two groups don't align perfectly, and the relationship between residualized treatment and residualized outcome doesn't look perfectly linear. When secondary enrollment is the outcome, the lines for the treated and untreated groups seem to switch directions—the slope is negative for untreated observations but positive for treated. This is a bad sign for the homogeneity assumption.</span>
<span id="cb28-632"><a href="#cb28-632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-633"><a href="#cb28-633" aria-hidden="true" tabindex="-1"></a>We can statistically test if the slopes in two groups are the same or not by using an interaction term in a regression model:</span>
<span id="cb28-634"><a href="#cb28-634" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-635"><a href="#cb28-635" aria-hidden="true" tabindex="-1"></a><span class="in">```{r check-slopes}</span></span>
<span id="cb28-636"><a href="#cb28-636" aria-hidden="true" tabindex="-1"></a><span class="in">check_slopes_primary &lt;- lm(out_resid ~ treatment_resid * factor(treatment),</span></span>
<span id="cb28-637"><a href="#cb28-637" aria-hidden="true" tabindex="-1"></a><span class="in">                           data = fpe_primary_weights)</span></span>
<span id="cb28-638"><a href="#cb28-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-639"><a href="#cb28-639" aria-hidden="true" tabindex="-1"></a><span class="in">check_slopes_secondary &lt;- lm(out_resid ~ treatment_resid * factor(treatment),</span></span>
<span id="cb28-640"><a href="#cb28-640" aria-hidden="true" tabindex="-1"></a><span class="in">                           data = fpe_secondary_weights)</span></span>
<span id="cb28-641"><a href="#cb28-641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-642"><a href="#cb28-642" aria-hidden="true" tabindex="-1"></a><span class="in">modelsummary(list("Primary enrollment" = check_slopes_primary,</span></span>
<span id="cb28-643"><a href="#cb28-643" aria-hidden="true" tabindex="-1"></a><span class="in">                  "Secondary enrollment" = check_slopes_secondary),</span></span>
<span id="cb28-644"><a href="#cb28-644" aria-hidden="true" tabindex="-1"></a><span class="in">             coef_rename = c("treatment_resid" = "Residualized treatment",</span></span>
<span id="cb28-645"><a href="#cb28-645" aria-hidden="true" tabindex="-1"></a><span class="in">                             "factor(treatment)1" = "Treatment group",</span></span>
<span id="cb28-646"><a href="#cb28-646" aria-hidden="true" tabindex="-1"></a><span class="in">                             "treatment_resid:factor(treatment)1" = "Treatment group × residualized treatment",</span></span>
<span id="cb28-647"><a href="#cb28-647" aria-hidden="true" tabindex="-1"></a><span class="in">                             "(Intercept)" = "Intercept"),</span></span>
<span id="cb28-648"><a href="#cb28-648" aria-hidden="true" tabindex="-1"></a><span class="in">             estimate = "{estimate}",</span></span>
<span id="cb28-649"><a href="#cb28-649" aria-hidden="true" tabindex="-1"></a><span class="in">             statistic = c("s.e. = {std.error}", "p = {p.value}"),</span></span>
<span id="cb28-650"><a href="#cb28-650" aria-hidden="true" tabindex="-1"></a><span class="in">             gof_map = tribble(</span></span>
<span id="cb28-651"><a href="#cb28-651" aria-hidden="true" tabindex="-1"></a><span class="in">               ~raw, ~clean, ~fmt,</span></span>
<span id="cb28-652"><a href="#cb28-652" aria-hidden="true" tabindex="-1"></a><span class="in">               "nobs", "N", 0,</span></span>
<span id="cb28-653"><a href="#cb28-653" aria-hidden="true" tabindex="-1"></a><span class="in">               "r.squared", "R²", 3</span></span>
<span id="cb28-654"><a href="#cb28-654" aria-hidden="true" tabindex="-1"></a><span class="in">             ),</span></span>
<span id="cb28-655"><a href="#cb28-655" aria-hidden="true" tabindex="-1"></a><span class="in">             escape = FALSE, output = "kableExtra") %&gt;%</span></span>
<span id="cb28-656"><a href="#cb28-656" aria-hidden="true" tabindex="-1"></a><span class="in">  kable_styling(htmltable_class = "table table-sm")</span></span>
<span id="cb28-657"><a href="#cb28-657" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-658"><a href="#cb28-658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-659"><a href="#cb28-659" aria-hidden="true" tabindex="-1"></a>The coefficient for "Treatment group × residualized treatment" shows the change in slope between the two groups. For primary enrollment, being in the treatment group reduces the slope by 7.8 (so from 23.761 to 15.961), but the standard errors around that change are huge and the p-value is not significant (p = 0.199). For secondary enrollment, though, being in the treatment group increases the slope by 5.3 (from -2.9 to positive 2.4), and that change is statistically significant (p = 0.009). </span>
<span id="cb28-660"><a href="#cb28-660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-661"><a href="#cb28-661" aria-hidden="true" tabindex="-1"></a>So for primary enrollment, there's not enough evidence to reject the hypothesis that the slopes are the same (or the hypothesis that the effect is homogenous), so we'll treat the effect as homogenous. Yay! That means we don't need to worry so much about the negatively-weighted treated country-years. For secondary enrollment, though, there's pretty strong evidence that the slopes aren't the same, which means the treatment effect is likely heterogenous, which also means that the treated country-years with negative weights are biasing the results substantially and we should thus be worried.</span>
<span id="cb28-662"><a href="#cb28-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-663"><a href="#cb28-663" aria-hidden="true" tabindex="-1"></a>When there are heterogenous treatment effects, we don't need to give up! This is what @CallawaySantAnna:2020 and @SunAbraham:2020 show how to do in their papers (and see @BakerLarckerWang:2021 for a general overview of those approaches). If treatment effects are indeed homogenous, there's no need to turn to these fancier TWFE estimators—but if they are heterogenous, there are new tools that help.</span>
<span id="cb28-664"><a href="#cb28-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-665"><a href="#cb28-665" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-666"><a href="#cb28-666" aria-hidden="true" tabindex="-1"></a><span class="fu">## Jakiela's robustness checks</span></span>
<span id="cb28-667"><a href="#cb28-667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-668"><a href="#cb28-668" aria-hidden="true" tabindex="-1"></a>Now that we've run those two diagnostics (checked for negative weights in treated units and checked for treatment effect homogeneity), we can do some neat robustness checks to see how badly these negative weight issues bias the TWFE estimate.</span>
<span id="cb28-669"><a href="#cb28-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-670"><a href="#cb28-670" aria-hidden="true" tabindex="-1"></a>As long as we assume that treatment effects are homogenous (remember that $\delta$ in the equation above doesn't have subscripts for country or year), we can safely drop some observations from the data and still find the same result. We can also strategically drop observations to check if negative treatment weights influence the results. Jakiela presents three different robustness checks that all involve dropping different categories of observations:</span>
<span id="cb28-671"><a href="#cb28-671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-672"><a href="#cb28-672" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Exclude later years</span>
<span id="cb28-673"><a href="#cb28-673" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Limit how many post-treatment years are kept</span>
<span id="cb28-674"><a href="#cb28-674" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Exclude individual countries</span>
<span id="cb28-675"><a href="#cb28-675" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-676"><a href="#cb28-676" aria-hidden="true" tabindex="-1"></a><span class="fu">### Exclude later years</span></span>
<span id="cb28-677"><a href="#cb28-677" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-678"><a href="#cb28-678" aria-hidden="true" tabindex="-1"></a>Since negative treatment weights for treated country-years are more likely to appear in later years in the data, we can drop those later years and see how the treatment effect changes. </span>
<span id="cb28-679"><a href="#cb28-679" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-680"><a href="#cb28-680" aria-hidden="true" tabindex="-1"></a>For primary schools, if we cut the data off at 2000, the treatment effect is 31.8 instead of the 20.4 we've been seeing with the full data. That estimate is higher, but it also has wider errors. Both the coefficient and the errors shrink as we add more years to the data, and the estimate eventually settles on ≈20 by 2005, which is also when negatively weighted treated rows start appearing.</span>
<span id="cb28-681"><a href="#cb28-681" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-682"><a href="#cb28-682" aria-hidden="true" tabindex="-1"></a>For secondary schools, the treatment effect hovers around 0 is never statistically significant regardless of the cutoff year.</span>
<span id="cb28-683"><a href="#cb28-683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-684"><a href="#cb28-684" aria-hidden="true" tabindex="-1"></a><span class="in">```{r robust-exclude-later-years, fig.width=12, fig.height=5, out.width="100%"}</span></span>
<span id="cb28-685"><a href="#cb28-685" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb28-686"><a href="#cb28-686" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-inset-right</span></span>
<span id="cb28-687"><a href="#cb28-687" aria-hidden="true" tabindex="-1"></a><span class="in">different_max_years_primary &lt;- tibble(end_year = 2000:2015) %&gt;%</span></span>
<span id="cb28-688"><a href="#cb28-688" aria-hidden="true" tabindex="-1"></a><span class="in">  # Nest a filtered dataset in a cell for each year</span></span>
<span id="cb28-689"><a href="#cb28-689" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(data = map(end_year, ~filter(fpe_primary, year &lt;= .))) %&gt;%</span></span>
<span id="cb28-690"><a href="#cb28-690" aria-hidden="true" tabindex="-1"></a><span class="in">  # Calculate the TWFE estimate for each dataset</span></span>
<span id="cb28-691"><a href="#cb28-691" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(model = map(data, ~lm_robust(primary ~ treatment,</span></span>
<span id="cb28-692"><a href="#cb28-692" aria-hidden="true" tabindex="-1"></a><span class="in">                                      fixed_effects = ~ country + year,</span></span>
<span id="cb28-693"><a href="#cb28-693" aria-hidden="true" tabindex="-1"></a><span class="in">                                      data = .,</span></span>
<span id="cb28-694"><a href="#cb28-694" aria-hidden="true" tabindex="-1"></a><span class="in">                                      clusters = country, se_type = "stata"))) %&gt;%</span></span>
<span id="cb28-695"><a href="#cb28-695" aria-hidden="true" tabindex="-1"></a><span class="in">  # Extract a data frame of the results</span></span>
<span id="cb28-696"><a href="#cb28-696" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(tidied = map(model, ~tidy(., conf.int = TRUE))) %&gt;%</span></span>
<span id="cb28-697"><a href="#cb28-697" aria-hidden="true" tabindex="-1"></a><span class="in">  # Calculate residuals and treatment weights</span></span>
<span id="cb28-698"><a href="#cb28-698" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(model_resid = map(data, ~lm(treatment ~ country + factor(year), data = .)),</span></span>
<span id="cb28-699"><a href="#cb28-699" aria-hidden="true" tabindex="-1"></a><span class="in">         treatment_resid = map(model_resid, ~residuals(.)),</span></span>
<span id="cb28-700"><a href="#cb28-700" aria-hidden="true" tabindex="-1"></a><span class="in">         treatment_weight = map(treatment_resid, ~ . / sum(.^2)))</span></span>
<span id="cb28-701"><a href="#cb28-701" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-702"><a href="#cb28-702" aria-hidden="true" tabindex="-1"></a><span class="in"># Calculate how many treated observations have negative weights</span></span>
<span id="cb28-703"><a href="#cb28-703" aria-hidden="true" tabindex="-1"></a><span class="in">prop_negative_primary &lt;- different_max_years_primary %&gt;%</span></span>
<span id="cb28-704"><a href="#cb28-704" aria-hidden="true" tabindex="-1"></a><span class="in">  unnest(c(data, treatment_resid, treatment_weight)) %&gt;%</span></span>
<span id="cb28-705"><a href="#cb28-705" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(end_year) %&gt;%</span></span>
<span id="cb28-706"><a href="#cb28-706" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(n_treated_negative_weight = sum(treatment_weight &lt; 0 &amp; treatment == 1),</span></span>
<span id="cb28-707"><a href="#cb28-707" aria-hidden="true" tabindex="-1"></a><span class="in">            n_treated = sum(treatment == 1),</span></span>
<span id="cb28-708"><a href="#cb28-708" aria-hidden="true" tabindex="-1"></a><span class="in">            prop_treated_negative_weight = n_treated_negative_weight / n_treated) %&gt;%</span></span>
<span id="cb28-709"><a href="#cb28-709" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(prop_nice = percent(prop_treated_negative_weight, accuracy = 1))</span></span>
<span id="cb28-710"><a href="#cb28-710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-711"><a href="#cb28-711" aria-hidden="true" tabindex="-1"></a><span class="in"># Extract tidied results for plotting</span></span>
<span id="cb28-712"><a href="#cb28-712" aria-hidden="true" tabindex="-1"></a><span class="in">coefs_to_plot_primary &lt;- different_max_years_primary %&gt;%</span></span>
<span id="cb28-713"><a href="#cb28-713" aria-hidden="true" tabindex="-1"></a><span class="in">  unnest(tidied)</span></span>
<span id="cb28-714"><a href="#cb28-714" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-715"><a href="#cb28-715" aria-hidden="true" tabindex="-1"></a><span class="in">different_max_years_secondary &lt;- tibble(end_year = 2000:2015) %&gt;%</span></span>
<span id="cb28-716"><a href="#cb28-716" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(data = map(end_year, ~filter(fpe_secondary, year &lt;= .))) %&gt;%</span></span>
<span id="cb28-717"><a href="#cb28-717" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(model = map(data, ~lm_robust(secondary ~ treatment,</span></span>
<span id="cb28-718"><a href="#cb28-718" aria-hidden="true" tabindex="-1"></a><span class="in">                                      fixed_effects = ~ country + year,</span></span>
<span id="cb28-719"><a href="#cb28-719" aria-hidden="true" tabindex="-1"></a><span class="in">                                      data = .,</span></span>
<span id="cb28-720"><a href="#cb28-720" aria-hidden="true" tabindex="-1"></a><span class="in">                                      clusters = country, se_type = "stata"))) %&gt;%</span></span>
<span id="cb28-721"><a href="#cb28-721" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(tidied = map(model, ~tidy(., conf.int = TRUE))) %&gt;%</span></span>
<span id="cb28-722"><a href="#cb28-722" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(model_resid = map(data, ~lm(treatment ~ country + factor(year), data = .)),</span></span>
<span id="cb28-723"><a href="#cb28-723" aria-hidden="true" tabindex="-1"></a><span class="in">         treatment_resid = map(model_resid, ~residuals(.)),</span></span>
<span id="cb28-724"><a href="#cb28-724" aria-hidden="true" tabindex="-1"></a><span class="in">         treatment_weight = map(treatment_resid, ~ . / sum(.^2)))</span></span>
<span id="cb28-725"><a href="#cb28-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-726"><a href="#cb28-726" aria-hidden="true" tabindex="-1"></a><span class="in">prop_negative_secondary &lt;- different_max_years_secondary %&gt;%</span></span>
<span id="cb28-727"><a href="#cb28-727" aria-hidden="true" tabindex="-1"></a><span class="in">  unnest(c(data, treatment_resid, treatment_weight)) %&gt;%</span></span>
<span id="cb28-728"><a href="#cb28-728" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(end_year) %&gt;%</span></span>
<span id="cb28-729"><a href="#cb28-729" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(n_treated_negative_weight = sum(treatment_weight &lt; 0 &amp; treatment == 1),</span></span>
<span id="cb28-730"><a href="#cb28-730" aria-hidden="true" tabindex="-1"></a><span class="in">            n_treated = sum(treatment == 1),</span></span>
<span id="cb28-731"><a href="#cb28-731" aria-hidden="true" tabindex="-1"></a><span class="in">            prop_treated_negative_weight = n_treated_negative_weight / n_treated) %&gt;%</span></span>
<span id="cb28-732"><a href="#cb28-732" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(prop_nice = percent(prop_treated_negative_weight, accuracy = 1))</span></span>
<span id="cb28-733"><a href="#cb28-733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-734"><a href="#cb28-734" aria-hidden="true" tabindex="-1"></a><span class="in">coefs_to_plot_secondary &lt;- different_max_years_secondary %&gt;%</span></span>
<span id="cb28-735"><a href="#cb28-735" aria-hidden="true" tabindex="-1"></a><span class="in">  unnest(tidied)</span></span>
<span id="cb28-736"><a href="#cb28-736" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-737"><a href="#cb28-737" aria-hidden="true" tabindex="-1"></a><span class="in"># Coefficient plot</span></span>
<span id="cb28-738"><a href="#cb28-738" aria-hidden="true" tabindex="-1"></a><span class="in">ate_primary &lt;- ggplot(coefs_to_plot_primary, aes(x = end_year, y = estimate)) +</span></span>
<span id="cb28-739"><a href="#cb28-739" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_hline(yintercept = 0, color = "#FF2E00", size = 1) +</span></span>
<span id="cb28-740"><a href="#cb28-740" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_pointrange(aes(ymin = conf.low, ymax = conf.high),</span></span>
<span id="cb28-741"><a href="#cb28-741" aria-hidden="true" tabindex="-1"></a><span class="in">                  color = "#0599B0", size = 1, fatten = 2) +</span></span>
<span id="cb28-742"><a href="#cb28-742" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = NULL, y = "TWFE-based treatment effect",</span></span>
<span id="cb28-743"><a href="#cb28-743" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "Primary school enrollment") +</span></span>
<span id="cb28-744"><a href="#cb28-744" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_clean() +</span></span>
<span id="cb28-745"><a href="#cb28-745" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(axis.title.x = element_blank(),</span></span>
<span id="cb28-746"><a href="#cb28-746" aria-hidden="true" tabindex="-1"></a><span class="in">        axis.text.x = element_blank())</span></span>
<span id="cb28-747"><a href="#cb28-747" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-748"><a href="#cb28-748" aria-hidden="true" tabindex="-1"></a><span class="in">ate_secondary &lt;- ggplot(coefs_to_plot_secondary, aes(x = end_year, y = estimate)) +</span></span>
<span id="cb28-749"><a href="#cb28-749" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_hline(yintercept = 0, color = "#FF2E00", size = 1) +</span></span>
<span id="cb28-750"><a href="#cb28-750" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_pointrange(aes(ymin = conf.low, ymax = conf.high),</span></span>
<span id="cb28-751"><a href="#cb28-751" aria-hidden="true" tabindex="-1"></a><span class="in">                  color = "#0599B0", size = 1, fatten = 2) +</span></span>
<span id="cb28-752"><a href="#cb28-752" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = NULL, y = "TWFE-based treatment effect",</span></span>
<span id="cb28-753"><a href="#cb28-753" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "Secondary school enrollment") +</span></span>
<span id="cb28-754"><a href="#cb28-754" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_clean() +</span></span>
<span id="cb28-755"><a href="#cb28-755" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(axis.title.x = element_blank(),</span></span>
<span id="cb28-756"><a href="#cb28-756" aria-hidden="true" tabindex="-1"></a><span class="in">        axis.text.x = element_blank())</span></span>
<span id="cb28-757"><a href="#cb28-757" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-758"><a href="#cb28-758" aria-hidden="true" tabindex="-1"></a><span class="in"># Bar plot</span></span>
<span id="cb28-759"><a href="#cb28-759" aria-hidden="true" tabindex="-1"></a><span class="in">prop_neg_primary &lt;- ggplot(filter(prop_negative_primary,</span></span>
<span id="cb28-760"><a href="#cb28-760" aria-hidden="true" tabindex="-1"></a><span class="in">                                  prop_treated_negative_weight &gt; 0),</span></span>
<span id="cb28-761"><a href="#cb28-761" aria-hidden="true" tabindex="-1"></a><span class="in">                           aes(x = end_year, y = prop_treated_negative_weight)) +</span></span>
<span id="cb28-762"><a href="#cb28-762" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_col(fill = "#FF4136") +</span></span>
<span id="cb28-763"><a href="#cb28-763" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_text(aes(label = prop_nice),</span></span>
<span id="cb28-764"><a href="#cb28-764" aria-hidden="true" tabindex="-1"></a><span class="in">            nudge_y = 0.02, size = 2.5,</span></span>
<span id="cb28-765"><a href="#cb28-765" aria-hidden="true" tabindex="-1"></a><span class="in">            family = "Barlow Semi Condensed Bold", color = "#FF4136") +</span></span>
<span id="cb28-766"><a href="#cb28-766" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(xlim = c(2000, 2015)) +</span></span>
<span id="cb28-767"><a href="#cb28-767" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Last year included in data", y = NULL,</span></span>
<span id="cb28-768"><a href="#cb28-768" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "% of treated observations with negative weight") +</span></span>
<span id="cb28-769"><a href="#cb28-769" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_clean() +</span></span>
<span id="cb28-770"><a href="#cb28-770" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(panel.grid.major.y = element_blank(),</span></span>
<span id="cb28-771"><a href="#cb28-771" aria-hidden="true" tabindex="-1"></a><span class="in">        axis.text.y = element_blank())</span></span>
<span id="cb28-772"><a href="#cb28-772" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-773"><a href="#cb28-773" aria-hidden="true" tabindex="-1"></a><span class="in">prop_neg_secondary &lt;- ggplot(filter(prop_negative_secondary,</span></span>
<span id="cb28-774"><a href="#cb28-774" aria-hidden="true" tabindex="-1"></a><span class="in">                                    prop_treated_negative_weight &gt; 0),</span></span>
<span id="cb28-775"><a href="#cb28-775" aria-hidden="true" tabindex="-1"></a><span class="in">                             aes(x = end_year, y = prop_treated_negative_weight)) +</span></span>
<span id="cb28-776"><a href="#cb28-776" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_col(fill = "#FF4136") +</span></span>
<span id="cb28-777"><a href="#cb28-777" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_text(aes(label = prop_nice),</span></span>
<span id="cb28-778"><a href="#cb28-778" aria-hidden="true" tabindex="-1"></a><span class="in">            nudge_y = 0.02, size = 2.5,</span></span>
<span id="cb28-779"><a href="#cb28-779" aria-hidden="true" tabindex="-1"></a><span class="in">            family = "Barlow Semi Condensed Bold", color = "#FF4136") +</span></span>
<span id="cb28-780"><a href="#cb28-780" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(xlim = c(2000, 2015)) +</span></span>
<span id="cb28-781"><a href="#cb28-781" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Last year included in data", y = NULL,</span></span>
<span id="cb28-782"><a href="#cb28-782" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "% of treated observations with negative weight") +</span></span>
<span id="cb28-783"><a href="#cb28-783" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_clean() +</span></span>
<span id="cb28-784"><a href="#cb28-784" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(panel.grid.major.y = element_blank(),</span></span>
<span id="cb28-785"><a href="#cb28-785" aria-hidden="true" tabindex="-1"></a><span class="in">        axis.text.y = element_blank())</span></span>
<span id="cb28-786"><a href="#cb28-786" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-787"><a href="#cb28-787" aria-hidden="true" tabindex="-1"></a><span class="in">((ate_primary / prop_neg_primary) + plot_layout(heights = c(0.8, 0.2))) |</span></span>
<span id="cb28-788"><a href="#cb28-788" aria-hidden="true" tabindex="-1"></a><span class="in">  ((ate_secondary / prop_neg_secondary) + plot_layout(heights = c(0.8, 0.2)))</span></span>
<span id="cb28-789"><a href="#cb28-789" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-790"><a href="#cb28-790" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-791"><a href="#cb28-791" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-792"><a href="#cb28-792" aria-hidden="true" tabindex="-1"></a><span class="fu">### Change how many post-treatment years are kept</span></span>
<span id="cb28-793"><a href="#cb28-793" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-794"><a href="#cb28-794" aria-hidden="true" tabindex="-1"></a>Dropping rows based on end years like this is neat, but it doesn't take into account the differential treatment timing. Countries like Mozambique, which eliminated its fees in 2005, don't even show up in the first few models of exclude-later-years robustness check, since those models end in 2000–2004. As an alternative, we can keep specific numbers of years post-treatment for each country. For instance, we can look at Mozambique 2, 3, 4, or 5 (and so on) years after treatment. Doing this centers all countries at $t = 0$, rather than $t = \text{start year}$.</span>
<span id="cb28-795"><a href="#cb28-795" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-796"><a href="#cb28-796" aria-hidden="true" tabindex="-1"></a>For primary schools in this situation, the effect is smaller and not significant when only a few post-treatment years are kept, but it stabilizes at around 20 after only 5 post-treatment years, which suggests that $\delta$ is indeed homogenous—we don't need a ton of post-treatment data to find it. For secondary schools, though, the effect remains negative and insigificant throughout every specification.</span>
<span id="cb28-797"><a href="#cb28-797" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-798"><a href="#cb28-798" aria-hidden="true" tabindex="-1"></a><span class="in">```{r robust-post-treatment-years, fig.width=12, fig.height=5, out.width="100%"}</span></span>
<span id="cb28-799"><a href="#cb28-799" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb28-800"><a href="#cb28-800" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-inset-right</span></span>
<span id="cb28-801"><a href="#cb28-801" aria-hidden="true" tabindex="-1"></a><span class="in">fpe_primary_years_since &lt;- fpe_primary %&gt;%</span></span>
<span id="cb28-802"><a href="#cb28-802" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(years_after = year - fpe_year)</span></span>
<span id="cb28-803"><a href="#cb28-803" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-804"><a href="#cb28-804" aria-hidden="true" tabindex="-1"></a><span class="in">fpe_secondary_years_since &lt;- fpe_secondary %&gt;%</span></span>
<span id="cb28-805"><a href="#cb28-805" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(years_after = year - fpe_year)</span></span>
<span id="cb28-806"><a href="#cb28-806" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-807"><a href="#cb28-807" aria-hidden="true" tabindex="-1"></a><span class="in">different_years_after_primary &lt;- tibble(post_trt_years = 2:22) %&gt;%</span></span>
<span id="cb28-808"><a href="#cb28-808" aria-hidden="true" tabindex="-1"></a><span class="in">  # Nest a filtered dataset in a cell for each year</span></span>
<span id="cb28-809"><a href="#cb28-809" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(data = map(post_trt_years, ~filter(fpe_primary_years_since, years_after &lt;= .))) %&gt;%</span></span>
<span id="cb28-810"><a href="#cb28-810" aria-hidden="true" tabindex="-1"></a><span class="in">  # Calculate the TWFE estimate for each dataset</span></span>
<span id="cb28-811"><a href="#cb28-811" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(model = map(data, ~lm_robust(primary ~ treatment,</span></span>
<span id="cb28-812"><a href="#cb28-812" aria-hidden="true" tabindex="-1"></a><span class="in">                                      fixed_effects = ~ country + year,</span></span>
<span id="cb28-813"><a href="#cb28-813" aria-hidden="true" tabindex="-1"></a><span class="in">                                      data = .,</span></span>
<span id="cb28-814"><a href="#cb28-814" aria-hidden="true" tabindex="-1"></a><span class="in">                                      clusters = country, se_type = "stata"))) %&gt;%</span></span>
<span id="cb28-815"><a href="#cb28-815" aria-hidden="true" tabindex="-1"></a><span class="in">  # Extract a data frame of the results</span></span>
<span id="cb28-816"><a href="#cb28-816" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(tidied = map(model, ~tidy(., conf.int = TRUE))) %&gt;%</span></span>
<span id="cb28-817"><a href="#cb28-817" aria-hidden="true" tabindex="-1"></a><span class="in">  # Calculate residuals and treatment weights</span></span>
<span id="cb28-818"><a href="#cb28-818" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(model_resid = map(data, ~lm(treatment ~ country + factor(year), data = .)),</span></span>
<span id="cb28-819"><a href="#cb28-819" aria-hidden="true" tabindex="-1"></a><span class="in">         treatment_resid = map(model_resid, ~residuals(.)),</span></span>
<span id="cb28-820"><a href="#cb28-820" aria-hidden="true" tabindex="-1"></a><span class="in">         treatment_weight = map(treatment_resid, ~ . / sum(.^2)))</span></span>
<span id="cb28-821"><a href="#cb28-821" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-822"><a href="#cb28-822" aria-hidden="true" tabindex="-1"></a><span class="in"># Calculate how many treated observations have negative weights</span></span>
<span id="cb28-823"><a href="#cb28-823" aria-hidden="true" tabindex="-1"></a><span class="in">prop_negative_primary &lt;- different_years_after_primary %&gt;%</span></span>
<span id="cb28-824"><a href="#cb28-824" aria-hidden="true" tabindex="-1"></a><span class="in">  unnest(c(data, treatment_resid, treatment_weight)) %&gt;%</span></span>
<span id="cb28-825"><a href="#cb28-825" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(post_trt_years) %&gt;%</span></span>
<span id="cb28-826"><a href="#cb28-826" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(n_treated_negative_weight = sum(treatment_weight &lt; 0 &amp; treatment == 1),</span></span>
<span id="cb28-827"><a href="#cb28-827" aria-hidden="true" tabindex="-1"></a><span class="in">            n_treated = sum(treatment == 1),</span></span>
<span id="cb28-828"><a href="#cb28-828" aria-hidden="true" tabindex="-1"></a><span class="in">            prop_treated_negative_weight = n_treated_negative_weight / n_treated) %&gt;%</span></span>
<span id="cb28-829"><a href="#cb28-829" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(prop_nice = percent(prop_treated_negative_weight, accuracy = 1))</span></span>
<span id="cb28-830"><a href="#cb28-830" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-831"><a href="#cb28-831" aria-hidden="true" tabindex="-1"></a><span class="in"># Extract tidied results for plotting</span></span>
<span id="cb28-832"><a href="#cb28-832" aria-hidden="true" tabindex="-1"></a><span class="in">coefs_to_plot_primary &lt;- different_years_after_primary %&gt;%</span></span>
<span id="cb28-833"><a href="#cb28-833" aria-hidden="true" tabindex="-1"></a><span class="in">  unnest(tidied)</span></span>
<span id="cb28-834"><a href="#cb28-834" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-835"><a href="#cb28-835" aria-hidden="true" tabindex="-1"></a><span class="in">different_years_after_secondary &lt;- tibble(post_trt_years = 2:22) %&gt;%</span></span>
<span id="cb28-836"><a href="#cb28-836" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(data = map(post_trt_years, ~filter(fpe_secondary_years_since, years_after &lt;= .))) %&gt;%</span></span>
<span id="cb28-837"><a href="#cb28-837" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(model = map(data, ~lm_robust(secondary ~ treatment,</span></span>
<span id="cb28-838"><a href="#cb28-838" aria-hidden="true" tabindex="-1"></a><span class="in">                                      fixed_effects = ~ country + year,</span></span>
<span id="cb28-839"><a href="#cb28-839" aria-hidden="true" tabindex="-1"></a><span class="in">                                      data = .,</span></span>
<span id="cb28-840"><a href="#cb28-840" aria-hidden="true" tabindex="-1"></a><span class="in">                                      clusters = country, se_type = "stata"))) %&gt;%</span></span>
<span id="cb28-841"><a href="#cb28-841" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(tidied = map(model, ~tidy(., conf.int = TRUE))) %&gt;%</span></span>
<span id="cb28-842"><a href="#cb28-842" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(model_resid = map(data, ~lm(treatment ~ country + factor(year), data = .)),</span></span>
<span id="cb28-843"><a href="#cb28-843" aria-hidden="true" tabindex="-1"></a><span class="in">         treatment_resid = map(model_resid, ~residuals(.)),</span></span>
<span id="cb28-844"><a href="#cb28-844" aria-hidden="true" tabindex="-1"></a><span class="in">         treatment_weight = map(treatment_resid, ~ . / sum(.^2)))</span></span>
<span id="cb28-845"><a href="#cb28-845" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-846"><a href="#cb28-846" aria-hidden="true" tabindex="-1"></a><span class="in">prop_negative_secondary &lt;- different_years_after_secondary %&gt;%</span></span>
<span id="cb28-847"><a href="#cb28-847" aria-hidden="true" tabindex="-1"></a><span class="in">  unnest(c(data, treatment_resid, treatment_weight)) %&gt;%</span></span>
<span id="cb28-848"><a href="#cb28-848" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(post_trt_years) %&gt;%</span></span>
<span id="cb28-849"><a href="#cb28-849" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(n_treated_negative_weight = sum(treatment_weight &lt; 0 &amp; treatment == 1),</span></span>
<span id="cb28-850"><a href="#cb28-850" aria-hidden="true" tabindex="-1"></a><span class="in">            n_treated = sum(treatment == 1),</span></span>
<span id="cb28-851"><a href="#cb28-851" aria-hidden="true" tabindex="-1"></a><span class="in">            prop_treated_negative_weight = n_treated_negative_weight / n_treated) %&gt;%</span></span>
<span id="cb28-852"><a href="#cb28-852" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(prop_nice = percent(prop_treated_negative_weight, accuracy = 1))</span></span>
<span id="cb28-853"><a href="#cb28-853" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-854"><a href="#cb28-854" aria-hidden="true" tabindex="-1"></a><span class="in">coefs_to_plot_secondary &lt;- different_years_after_secondary %&gt;%</span></span>
<span id="cb28-855"><a href="#cb28-855" aria-hidden="true" tabindex="-1"></a><span class="in">  unnest(tidied)</span></span>
<span id="cb28-856"><a href="#cb28-856" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-857"><a href="#cb28-857" aria-hidden="true" tabindex="-1"></a><span class="in"># Coefficient plot</span></span>
<span id="cb28-858"><a href="#cb28-858" aria-hidden="true" tabindex="-1"></a><span class="in">ate_primary &lt;- ggplot(coefs_to_plot_primary, aes(x = post_trt_years, y = estimate)) +</span></span>
<span id="cb28-859"><a href="#cb28-859" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_hline(yintercept = 0, color = "#FF2E00", size = 1) +</span></span>
<span id="cb28-860"><a href="#cb28-860" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_pointrange(aes(ymin = conf.low, ymax = conf.high),</span></span>
<span id="cb28-861"><a href="#cb28-861" aria-hidden="true" tabindex="-1"></a><span class="in">                  color = "#0599B0", size = 1, fatten = 2) +</span></span>
<span id="cb28-862"><a href="#cb28-862" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = NULL, y = "TWFE-based treatment effect",</span></span>
<span id="cb28-863"><a href="#cb28-863" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "Primary school enrollment") +</span></span>
<span id="cb28-864"><a href="#cb28-864" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_clean() +</span></span>
<span id="cb28-865"><a href="#cb28-865" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(axis.title.x = element_blank(),</span></span>
<span id="cb28-866"><a href="#cb28-866" aria-hidden="true" tabindex="-1"></a><span class="in">        axis.text.x = element_blank())</span></span>
<span id="cb28-867"><a href="#cb28-867" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-868"><a href="#cb28-868" aria-hidden="true" tabindex="-1"></a><span class="in">ate_secondary &lt;- ggplot(coefs_to_plot_secondary, aes(x = post_trt_years, y = estimate)) +</span></span>
<span id="cb28-869"><a href="#cb28-869" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_hline(yintercept = 0, color = "#FF2E00", size = 1) +</span></span>
<span id="cb28-870"><a href="#cb28-870" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_pointrange(aes(ymin = conf.low, ymax = conf.high),</span></span>
<span id="cb28-871"><a href="#cb28-871" aria-hidden="true" tabindex="-1"></a><span class="in">                  color = "#0599B0", size = 1, fatten = 2) +</span></span>
<span id="cb28-872"><a href="#cb28-872" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = NULL, y = "TWFE-based treatment effect",</span></span>
<span id="cb28-873"><a href="#cb28-873" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "Secondary school enrollment") +</span></span>
<span id="cb28-874"><a href="#cb28-874" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_clean() +</span></span>
<span id="cb28-875"><a href="#cb28-875" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(axis.title.x = element_blank(),</span></span>
<span id="cb28-876"><a href="#cb28-876" aria-hidden="true" tabindex="-1"></a><span class="in">        axis.text.x = element_blank())</span></span>
<span id="cb28-877"><a href="#cb28-877" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-878"><a href="#cb28-878" aria-hidden="true" tabindex="-1"></a><span class="in"># Bar plot</span></span>
<span id="cb28-879"><a href="#cb28-879" aria-hidden="true" tabindex="-1"></a><span class="in">prop_neg_primary &lt;- ggplot(filter(prop_negative_primary,</span></span>
<span id="cb28-880"><a href="#cb28-880" aria-hidden="true" tabindex="-1"></a><span class="in">                                  prop_treated_negative_weight &gt; 0),</span></span>
<span id="cb28-881"><a href="#cb28-881" aria-hidden="true" tabindex="-1"></a><span class="in">                           aes(x = post_trt_years, y = prop_treated_negative_weight)) +</span></span>
<span id="cb28-882"><a href="#cb28-882" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_col(fill = "#FF4136") +</span></span>
<span id="cb28-883"><a href="#cb28-883" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_text(aes(label = prop_nice),</span></span>
<span id="cb28-884"><a href="#cb28-884" aria-hidden="true" tabindex="-1"></a><span class="in">            nudge_y = 0.02, size = 2.5,</span></span>
<span id="cb28-885"><a href="#cb28-885" aria-hidden="true" tabindex="-1"></a><span class="in">            family = "Barlow Semi Condensed Bold", color = "#FF4136") +</span></span>
<span id="cb28-886"><a href="#cb28-886" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(xlim = c(2, 22)) +</span></span>
<span id="cb28-887"><a href="#cb28-887" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Post-treatment years included", y = NULL,</span></span>
<span id="cb28-888"><a href="#cb28-888" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "% of treated observations with negative weight") +</span></span>
<span id="cb28-889"><a href="#cb28-889" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_clean() +</span></span>
<span id="cb28-890"><a href="#cb28-890" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(panel.grid.major.y = element_blank(),</span></span>
<span id="cb28-891"><a href="#cb28-891" aria-hidden="true" tabindex="-1"></a><span class="in">        axis.text.y = element_blank())</span></span>
<span id="cb28-892"><a href="#cb28-892" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-893"><a href="#cb28-893" aria-hidden="true" tabindex="-1"></a><span class="in">prop_neg_secondary &lt;- ggplot(filter(prop_negative_secondary,</span></span>
<span id="cb28-894"><a href="#cb28-894" aria-hidden="true" tabindex="-1"></a><span class="in">                                    prop_treated_negative_weight &gt; 0),</span></span>
<span id="cb28-895"><a href="#cb28-895" aria-hidden="true" tabindex="-1"></a><span class="in">                             aes(x = post_trt_years, y = prop_treated_negative_weight)) +</span></span>
<span id="cb28-896"><a href="#cb28-896" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_col(fill = "#FF4136") +</span></span>
<span id="cb28-897"><a href="#cb28-897" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_text(aes(label = prop_nice),</span></span>
<span id="cb28-898"><a href="#cb28-898" aria-hidden="true" tabindex="-1"></a><span class="in">            nudge_y = 0.02, size = 2.5,</span></span>
<span id="cb28-899"><a href="#cb28-899" aria-hidden="true" tabindex="-1"></a><span class="in">            family = "Barlow Semi Condensed Bold", color = "#FF4136") +</span></span>
<span id="cb28-900"><a href="#cb28-900" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(xlim = c(2, 22)) +</span></span>
<span id="cb28-901"><a href="#cb28-901" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Last year included in data", y = NULL,</span></span>
<span id="cb28-902"><a href="#cb28-902" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "% of treated observations with negative weight") +</span></span>
<span id="cb28-903"><a href="#cb28-903" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_clean() +</span></span>
<span id="cb28-904"><a href="#cb28-904" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(panel.grid.major.y = element_blank(),</span></span>
<span id="cb28-905"><a href="#cb28-905" aria-hidden="true" tabindex="-1"></a><span class="in">        axis.text.y = element_blank())</span></span>
<span id="cb28-906"><a href="#cb28-906" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-907"><a href="#cb28-907" aria-hidden="true" tabindex="-1"></a><span class="in">((ate_primary / prop_neg_primary) + plot_layout(heights = c(0.8, 0.2))) |</span></span>
<span id="cb28-908"><a href="#cb28-908" aria-hidden="true" tabindex="-1"></a><span class="in">  ((ate_secondary / prop_neg_secondary) + plot_layout(heights = c(0.8, 0.2)))</span></span>
<span id="cb28-909"><a href="#cb28-909" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-910"><a href="#cb28-910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-911"><a href="#cb28-911" aria-hidden="true" tabindex="-1"></a><span class="fu">### Exclude individual countries</span></span>
<span id="cb28-912"><a href="#cb28-912" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-913"><a href="#cb28-913" aria-hidden="true" tabindex="-1"></a>Finally, since early adopter countries are more likely to have negative treatment weights, we can remove individual countries from the panel to see what their omission does to the overall TWFE estimate. For primary school enrollment, the ATE remains positive and significant across most specifications, except when Malawi, Uganda, or Namibia are excluded. But Malawi and Uganda were early adopters and thus have negatively weighted treatment observations in later years, as we saw earlier, which give them strange leverage in the the overall TWFE ATE calculation. For secondary schools, the effect remains basically zero and insignificant across all specifications except when Malawi is omitted, but that's again because Malawi was an early adopter.</span>
<span id="cb28-914"><a href="#cb28-914" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-915"><a href="#cb28-915" aria-hidden="true" tabindex="-1"></a><span class="in">```{r robust-drop-countries, fig.width=9.5, fig.height=4.5, out.width="100%"}</span></span>
<span id="cb28-916"><a href="#cb28-916" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb28-917"><a href="#cb28-917" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-inset-right</span></span>
<span id="cb28-918"><a href="#cb28-918" aria-hidden="true" tabindex="-1"></a><span class="in">fpe_omit_countries_primary &lt;- fpe_primary %&gt;%</span></span>
<span id="cb28-919"><a href="#cb28-919" aria-hidden="true" tabindex="-1"></a><span class="in">  arrange(fpe_year, country) %&gt;%</span></span>
<span id="cb28-920"><a href="#cb28-920" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(country_start = paste0(country, " (", fpe_year, ")"),</span></span>
<span id="cb28-921"><a href="#cb28-921" aria-hidden="true" tabindex="-1"></a><span class="in">         country_start = fct_inorder(country_start)) %&gt;%</span></span>
<span id="cb28-922"><a href="#cb28-922" aria-hidden="true" tabindex="-1"></a><span class="in">  distinct(country, country_start) %&gt;%</span></span>
<span id="cb28-923"><a href="#cb28-923" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(data = map(country, ~filter(fpe_primary, country != .))) %&gt;%</span></span>
<span id="cb28-924"><a href="#cb28-924" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(model = map(data, ~lm_robust(primary ~ treatment,</span></span>
<span id="cb28-925"><a href="#cb28-925" aria-hidden="true" tabindex="-1"></a><span class="in">                                      fixed_effects = ~ country + year,</span></span>
<span id="cb28-926"><a href="#cb28-926" aria-hidden="true" tabindex="-1"></a><span class="in">                                      data = .,</span></span>
<span id="cb28-927"><a href="#cb28-927" aria-hidden="true" tabindex="-1"></a><span class="in">                                      clusters = country, se_type = "stata"))) %&gt;%</span></span>
<span id="cb28-928"><a href="#cb28-928" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(tidied = map(model, ~tidy(., conf.int = TRUE)))</span></span>
<span id="cb28-929"><a href="#cb28-929" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-930"><a href="#cb28-930" aria-hidden="true" tabindex="-1"></a><span class="in">coefs_to_plot_primary &lt;- fpe_omit_countries_primary %&gt;%</span></span>
<span id="cb28-931"><a href="#cb28-931" aria-hidden="true" tabindex="-1"></a><span class="in">  unnest(tidied)</span></span>
<span id="cb28-932"><a href="#cb28-932" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-933"><a href="#cb28-933" aria-hidden="true" tabindex="-1"></a><span class="in">fpe_omit_countries_secondary &lt;- fpe_secondary %&gt;%</span></span>
<span id="cb28-934"><a href="#cb28-934" aria-hidden="true" tabindex="-1"></a><span class="in">  arrange(fpe_year, country) %&gt;%</span></span>
<span id="cb28-935"><a href="#cb28-935" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(country_start = paste0(country, " (", fpe_year, ")"),</span></span>
<span id="cb28-936"><a href="#cb28-936" aria-hidden="true" tabindex="-1"></a><span class="in">         country_start = fct_inorder(country_start)) %&gt;%</span></span>
<span id="cb28-937"><a href="#cb28-937" aria-hidden="true" tabindex="-1"></a><span class="in">  distinct(country, country_start)  %&gt;%</span></span>
<span id="cb28-938"><a href="#cb28-938" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(data = map(country, ~filter(fpe_secondary, country != .))) %&gt;%</span></span>
<span id="cb28-939"><a href="#cb28-939" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(model = map(data, ~lm_robust(secondary ~ treatment,</span></span>
<span id="cb28-940"><a href="#cb28-940" aria-hidden="true" tabindex="-1"></a><span class="in">                                      fixed_effects = ~ country + year,</span></span>
<span id="cb28-941"><a href="#cb28-941" aria-hidden="true" tabindex="-1"></a><span class="in">                                      data = .,</span></span>
<span id="cb28-942"><a href="#cb28-942" aria-hidden="true" tabindex="-1"></a><span class="in">                                      clusters = country, se_type = "stata"))) %&gt;%</span></span>
<span id="cb28-943"><a href="#cb28-943" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(tidied = map(model, ~tidy(., conf.int = TRUE)))</span></span>
<span id="cb28-944"><a href="#cb28-944" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-945"><a href="#cb28-945" aria-hidden="true" tabindex="-1"></a><span class="in">coefs_to_plot_secondary &lt;- fpe_omit_countries_secondary %&gt;%</span></span>
<span id="cb28-946"><a href="#cb28-946" aria-hidden="true" tabindex="-1"></a><span class="in">  unnest(tidied)</span></span>
<span id="cb28-947"><a href="#cb28-947" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-948"><a href="#cb28-948" aria-hidden="true" tabindex="-1"></a><span class="in">ate_primary &lt;- ggplot(coefs_to_plot_primary, aes(x = estimate, y = fct_rev(country_start))) +</span></span>
<span id="cb28-949"><a href="#cb28-949" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0, color = "#FF2E00", size = 1) +</span></span>
<span id="cb28-950"><a href="#cb28-950" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_pointrange(aes(xmin = conf.low, xmax = conf.high),</span></span>
<span id="cb28-951"><a href="#cb28-951" aria-hidden="true" tabindex="-1"></a><span class="in">                  color = "#0599B0", size = 1, fatten = 2) +</span></span>
<span id="cb28-952"><a href="#cb28-952" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "TWFE-based treatment effect", y = NULL,</span></span>
<span id="cb28-953"><a href="#cb28-953" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "Primary school enrollment",</span></span>
<span id="cb28-954"><a href="#cb28-954" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "Each point represents the ATE when omitting the specified country",</span></span>
<span id="cb28-955"><a href="#cb28-955" aria-hidden="true" tabindex="-1"></a><span class="in">       caption = "Year that fees were eliminated is shown in parentheses") +</span></span>
<span id="cb28-956"><a href="#cb28-956" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(xlim = c(-10, 50)) +</span></span>
<span id="cb28-957"><a href="#cb28-957" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_clean() +</span></span>
<span id="cb28-958"><a href="#cb28-958" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(panel.grid.major.y = element_blank())</span></span>
<span id="cb28-959"><a href="#cb28-959" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-960"><a href="#cb28-960" aria-hidden="true" tabindex="-1"></a><span class="in">ate_secondary &lt;- ggplot(coefs_to_plot_secondary, aes(x = estimate, y = fct_rev(country_start))) +</span></span>
<span id="cb28-961"><a href="#cb28-961" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0, color = "#FF2E00", size = 1) +</span></span>
<span id="cb28-962"><a href="#cb28-962" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_pointrange(aes(xmin = conf.low, xmax = conf.high),</span></span>
<span id="cb28-963"><a href="#cb28-963" aria-hidden="true" tabindex="-1"></a><span class="in">                  color = "#0599B0", size = 1, fatten = 2) +</span></span>
<span id="cb28-964"><a href="#cb28-964" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "TWFE-based treatment effect", y = NULL,</span></span>
<span id="cb28-965"><a href="#cb28-965" aria-hidden="true" tabindex="-1"></a><span class="in">       title = "Secondary school enrollment") +</span></span>
<span id="cb28-966"><a href="#cb28-966" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(xlim = c(-10, 50)) +</span></span>
<span id="cb28-967"><a href="#cb28-967" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_clean() +</span></span>
<span id="cb28-968"><a href="#cb28-968" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(panel.grid.major.y = element_blank())</span></span>
<span id="cb28-969"><a href="#cb28-969" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-970"><a href="#cb28-970" aria-hidden="true" tabindex="-1"></a><span class="in">ate_primary | ate_secondary</span></span>
<span id="cb28-971"><a href="#cb28-971" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-972"><a href="#cb28-972" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-973"><a href="#cb28-973" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-974"><a href="#cb28-974" aria-hidden="true" tabindex="-1"></a><span class="fu">## tl;dr: Conclusion</span></span>
<span id="cb28-975"><a href="#cb28-975" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-976"><a href="#cb28-976" aria-hidden="true" tabindex="-1"></a>***Phew.*** That was a ton of code, but coding my way through this paper and translating Jakiela's diagnostics and robustness checks from math into R was incredibly helpful for me to start understanding all this new TWFE stuff.</span>
<span id="cb28-977"><a href="#cb28-977" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-978"><a href="#cb28-978" aria-hidden="true" tabindex="-1"></a>Here are the main tl;dr takeaways from her paper:</span>
<span id="cb28-979"><a href="#cb28-979" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-980"><a href="#cb28-980" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>We can think of OLS as a weighted sum of outcome values - these weights are typically negative for untreated observations and positive for treated observations</span>
<span id="cb28-981"><a href="#cb28-981" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>In TWFE situations, these weights take country and year into account</span>
<span id="cb28-982"><a href="#cb28-982" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Because of mathy reasons, treated observations can actually get negative weights—especially countries that are early adopters, and country-year observations in later years</span>
<span id="cb28-983"><a href="#cb28-983" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>We can see if these negative weights on treated observations are an issue by using a couple simple diagnostics: see how many and which treated observations have negative weights, and see if the treatment effect is homogenous across treated countries</span>
<span id="cb28-984"><a href="#cb28-984" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>We can look at which treated observations have negative weights by making some plots and exploring the data</span>
<span id="cb28-985"><a href="#cb28-985" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>We can check for the homogeniety of the treatment effect by running a regression that uses the residualized treatment and treatment status to</span>
<span id="cb28-986"><a href="#cb28-986" aria-hidden="true" tabindex="-1"></a>explain the residualized outcome. If the slopes for treated and comparison observations are indistinguishable, we can safely assume treatment homogeneity.</span>
<span id="cb28-987"><a href="#cb28-987" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Finally, we can check how robust the TWFE estimate is to negative treatment weights and the assumption of homogeneity by dropping specific types of observations and checking the ATE across these modified datasets</span>
<span id="cb28-988"><a href="#cb28-988" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-989"><a href="#cb28-989" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-990"><a href="#cb28-990" aria-hidden="true" tabindex="-1"></a><span class="fu">## References</span></span></code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
<p><span class="faux-block"><i class="fa-brands fa-creative-commons" aria-label="creative-commons"></i> 2007–2024 Andrew Heiss</span> <span class="faux-block">All content licensed under<br><a href="https://creativecommons.org/licenses/by/4.0/"><i class="fa-brands fa-creative-commons" aria-label="creative-commons"></i> <i class="fa-brands fa-creative-commons-by" aria-label="creative-commons-by"></i> Creative Commons CC BY 4.0</a></span></p>
</div>   
    <div class="nav-footer-center">
<p><span class="faux-block"><i class="fa-brands fa-orcid" aria-label="orcid"></i> <strong>ORCID</strong> <a href="https://orcid.org/0000-0002-3948-3914">0000-0002-3948-3914</a></span> <span class="faux-block"><i class="fa-solid fa-key" aria-label="key"></i> <a href="../../../../../pgp_ath.asc.txt">PGP public key</a>   <i class="fa-solid fa-fingerprint" aria-label="fingerprint"></i> Fingerprint:<br><span class="fingerprint">4AA2 FA83 A8B2 05A4 E30F<br> 610D 1382 6216 9178 36AB</span></span></p>
</div>
    <div class="nav-footer-right">
<p><span class="faux-block">Made with <i class="fa-brands fa-r-project" aria-label="r-project"></i> and <a href="https://quarto.org/">Quarto</a></span> <span class="faux-block"><a href="https://github.com/andrewheiss/ath-quarto">View the source at <i class="fa-brands fa-github" aria-label="github"></i> GitHub</a></span></p>
</div>
  </div>
</footer>


</body></html>