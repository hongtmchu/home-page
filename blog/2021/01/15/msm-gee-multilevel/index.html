<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Hong T.M. Chu">
<meta name="description" content="Use R to correctly close backdoor confounding in panel data with marginal structural models and inverse probability weights with both GEE and multilevel models">
<title>Marginal structural models for panel data with GEE and multilevel models | Hong T.M. Chu – Hong T.M. Chu</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="../../../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../../../">
<link href="../../../../..//files/favicon-512.png" rel="icon" type="image/png">
<script src="../../../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../../../site_libs/quarto-html/quarto-syntax-highlighting-17c909d5fd25ae21b861c0c7a49b2096.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../../../site_libs/bootstrap/bootstrap-5cd0811f461c8271ae6bab49df9501be.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<link href="../../../../../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../../../../../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<script src="../../../../../site_libs/quarto-contrib/iconify-2.0.0/iconify-icon.min.js"></script><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script type="text/javascript">

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-527449-5', 'auto');

ga('send', {
  hitType: 'pageview',
  'anonymizeIp': true,
});
</script><style>

      .quarto-title-block .quarto-title-banner {
        background: #170C3A;
      }
</style>
<script src="../../../../../site_libs/kePrint-0.0.1/kePrint.js"></script><link href="../../../../../site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
<meta property="og:title" content="Marginal structural models for panel data with GEE and multilevel models | Hong T.M. Chu">
<meta property="og:description" content="Use R to correctly close backdoor confounding in panel data with marginal structural models and inverse probability weights with both GEE and multilevel models">
<meta property="og:image" content="https://www.andrewheiss.com/blog/2021/01/15/msm-gee-multilevel/index_files/figure-html/depression-dag-1.png">
<meta property="og:site_name" content="Hong T.M. Chu">
<meta property="og:locale" content="en_US">
<meta property="og:image:height" content="720">
<meta property="og:image:width" content="1728">
<meta name="twitter:title" content="Marginal structural models for panel data with GEE and multilevel models | Hong T.M. Chu">
<meta name="twitter:description" content="Use R to correctly close backdoor confounding in panel data with marginal structural models and inverse probability weights with both GEE and multilevel models">
<meta name="twitter:image" content="https://www.andrewheiss.com/blog/2021/01/15/msm-gee-multilevel/index_files/figure-html/depression-dag-1.png">
<meta name="twitter:creator" content="@andrewheiss">
<meta name="twitter:site" content="@andrewheiss">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image-height" content="720">
<meta name="twitter:image-width" content="1728">
</head>
<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../../../index.html">
    <span class="navbar-title">Hong T.M. Chu</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link" href="../../../../../index.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../cv/index.html"> 
<span class="menu-text">CV</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../research/index.html"> 
<span class="menu-text">Research</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../teaching/index.html"> 
<span class="menu-text">Teaching</span></a>
  </li>  
</ul>
<ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item">
    <a class="nav-link" href="mailto:hong.ctm@vinuni.edu.vn"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:envelope" style="font-size: 1.1em;" aria-label="Icon envelope from bi Iconify.design set." title="E-mail"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/andrewheiss" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:github" style="font-size: 1.1em;" aria-label="Icon github from bi Iconify.design set." title="GitHub"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.linkedin.com/in/hongtmchu" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:linkedin" style="font-size: 1.1em;" aria-label="Icon linkedin from bi Iconify.design set." title="LinkedIn"></iconify-icon></span></a>
  </li>  
</ul>
</div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><header id="title-block-header" class="quarto-title-block default blog-post page-columns page-full"><div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">Marginal structural models for panel data with GEE and multilevel models</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
                  <div>
        <div class="description">
          Use R to correctly close backdoor confounding in panel data with marginal structural models and inverse probability weights with both GEE and multilevel models
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">r</div>
                <div class="quarto-category">tidyverse</div>
                <div class="quarto-category">causal inference</div>
                <div class="quarto-category">DAGs</div>
                <div class="quarto-category">do calculus</div>
                <div class="quarto-category">inverse probability weighting</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p><a href="https://www.andrewheiss.com/">Andrew Heiss</a> <a href="https://orcid.org/0000-0002-3948-3914" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">Friday, January 15, 2021</p>
      </div>
    </div>
    
      
      <div>
      <div class="quarto-title-meta-heading">Doi</div>
      <div class="quarto-title-meta-contents">
        <p class="doi">
          <a href="https://doi.org/10.59350/yqs5b-36r77">10.59350/yqs5b-36r77</a>
        </p>
      </div>
    </div>
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Contents</h2>
   
  <ul>
<li><a href="#synthetic-data-overview" id="toc-synthetic-data-overview" class="nav-link active" data-scroll-target="#synthetic-data-overview">Synthetic data overview</a></li>
  <li><a href="#original-two-period-thoemmes-and-ong-results" id="toc-original-two-period-thoemmes-and-ong-results" class="nav-link" data-scroll-target="#original-two-period-thoemmes-and-ong-results">Original two-period Thoemmes and Ong results</a></li>
  <li><a href="#tidier-two-period-results" id="toc-tidier-two-period-results" class="nav-link" data-scroll-target="#tidier-two-period-results">Tidier two-period results</a></li>
  <li>
<a href="#expansion-to-multiple-period-data" id="toc-expansion-to-multiple-period-data" class="nav-link" data-scroll-target="#expansion-to-multiple-period-data">Expansion to multiple-period data</a>
  <ul class="collapse">
<li><a href="#tricky-interdependent-data-generating-process" id="toc-tricky-interdependent-data-generating-process" class="nav-link" data-scroll-target="#tricky-interdependent-data-generating-process">Tricky interdependent data generating process</a></li>
  <li><a href="#multiple-period-marginal-structural-models" id="toc-multiple-period-marginal-structural-models" class="nav-link" data-scroll-target="#multiple-period-marginal-structural-models">Multiple-period marginal structural models</a></li>
  </ul>
</li>
  <li><a href="#questions-for-the-future" id="toc-questions-for-the-future" class="nav-link" data-scroll-target="#questions-for-the-future">Questions for the future</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul></nav>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content"><p>Since my last two blog posts on <a href="https://www.andrewheiss.com/blog/2020/12/01/ipw-binary-continuous/">binary and continuous inverse probability weights (IPWs)</a> and <a href="https://www.andrewheiss.com/blog/2020/12/03/ipw-tscs-msm/">marginal structural models (MSMs) for time-series cross-sectional (TSCS) panel data</a>, I’ve spent a ton of time trying to figure out why I couldn’t recover the exact causal effect I had built in to those examples when using panel data. It was a mystery, and it took weeks to figure out what was happening.</p>
<p>After poring through all sorts of articles on MSMs and TSCS data like <span class="citation" data-cites="ThoemmesOng:2016">Thoemmes and Ong (<a href="#ref-ThoemmesOng:2016" role="doc-biblioref">2016</a>)</span> and <span class="citation" data-cites="BlackwellGlynn:2018">Blackwell and Glynn (<a href="#ref-BlackwellGlynn:2018" role="doc-biblioref">2018</a>)</span>, along with all sorts of articles on the differences between <a href="https://en.wikipedia.org/wiki/Generalized_estimating_equation">generalized estimating equations (GEEs)</a>, which the epidemiology world (and everyone who does MSMs) seems to love, and multilevel models (which I find a lot more intuitive, and which can be done Bayesianly with <strong>brms</strong>), I <em>finally</em> figured out what was wrong and how to calculate correct IPWs for panel data.</p>
<p>The main issue lies in the synthetic data I had created for those earlier blog posts. <a href="https://www.andrewheiss.com/blog/2020/12/03/ipw-tscs-msm/#simulated-time-series-cross-sectional-data">There, I used the <strong>fabricatr</strong> package to create a country-year panel</a>, which seemed correct and great. However, it didn’t exactly match the data-generating process in situations where the value in one time period (like <span class="math inline">\(X_t\)</span>) depends on the value from the previous time period (or <span class="math inline">\(X_{t-1}\)</span>), or autocorrelation. As such, I couldn’t quite get the correct causal effects out (since the data didn’t show interdepdency across time).</p>
<p>After lots of struggle, though, I finally figured out a way to explicitly build this autocorrelation in. And thanks to this delightfully accessible article by <span class="citation" data-cites="ThoemmesOng:2016">Thoemmes and Ong (<a href="#ref-ThoemmesOng:2016" role="doc-biblioref">2016</a>)</span> (<a href="https://anthonyongphd.files.wordpress.com/2016/02/emerging-adulthood-2016-thoemmes-40-59.pdf">ungated free version here</a>), I found clear code for MSMs that I could expand to test on more complex panel data.</p>
<p>In this post, I’ll do a few things: (1) recreate the two-time-period example from Thoemmes and Ong’s appendix (which is stuck in a PDF and really hard to copy/paste out), (2) redo their two-period example with a tidier approach, and (3) expand their two-period approach to multiple years and replace GEEs with multilevel models.</p>
<p>Here we go!</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://broom.tidymodels.org/">broom</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-causal/ggdag">ggdag</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://www.dagitty.net">dagitty</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">ipw</span><span class="op">)</span>  <span class="co"># For automatically calculating IPWs</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">geepack</span><span class="op">)</span>  <span class="co"># For GEE models</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lme4/lme4/">lme4</a></span><span class="op">)</span>  <span class="co"># For mixed/multilevel models</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bbolker/broom.mixed">broom.mixed</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://haozhu233.github.io/kableExtra/">kableExtra</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="synthetic-data-overview" class="level2"><h2 class="anchored" data-anchor-id="synthetic-data-overview">Synthetic data overview</h2>
<p>In their paper, Thoemmes and Ong create simulated data based on this DAG, with a time-varying treatment, a non-time-varying confounder, and a time-varying outcome (depression):</p>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># I generally prefer the easier-to-read formula syntax in dagify() (i.e. D1 ~ T1</span></span>
<span><span class="co"># + C, etc.), but it doesn't work with subscripted numbers like T[1], so we have</span></span>
<span><span class="co"># to use this dagitty syntax instead</span></span>
<span><span class="va">depression_dag</span> <span class="op">&lt;-</span> <span class="fu">dagitty</span><span class="op">(</span><span class="st">'dag {</span></span>
<span><span class="st">"C" [pos="2.5,2"]</span></span>
<span><span class="st">"T[1]" [pos="1,1"]</span></span>
<span><span class="st">"D[1]" [pos="2,1"]</span></span>
<span><span class="st">"T[2]" [pos="3,1"]</span></span>
<span><span class="st">"D[2]" [pos="4,1"]</span></span>
<span><span class="st">"C" -&gt; "D[1]"</span></span>
<span><span class="st">"C" -&gt; "D[2]"</span></span>
<span><span class="st">"C" -&gt; "T[1]"</span></span>
<span><span class="st">"C" -&gt; "T[2]"</span></span>
<span><span class="st">"D[1]" -&gt; "T[2]"</span></span>
<span><span class="st">"T[1]" -&gt; "D[1]"</span></span>
<span><span class="st">"T[2]" -&gt; "D[2]"</span></span>
<span><span class="st">}'</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">tidy_dagitty</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">depression_dag</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, xend <span class="op">=</span> <span class="va">xend</span>, yend <span class="op">=</span> <span class="va">yend</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_dag_edges</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_dag_point</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"grey80"</span>, size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_dag_text</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"black"</span>, size <span class="op">=</span> <span class="fl">5</span>, parse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_dag</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/depression-dag-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:75.0%"></p>
</figure>
</div>
</div>
</div>
<p>Essentially earlier treatment (<span class="math inline">\(T_1\)</span>) causes some level of depression (<span class="math inline">\(D_1\)</span>), which causes later treatment (<span class="math inline">\(T_2\)</span>), which causes later depression (<span class="math inline">\(D_2\)</span>). This whole chain is influenced by some non-varying confounder (<span class="math inline">\(C\)</span>).</p>
</section><section id="original-two-period-thoemmes-and-ong-results" class="level2"><h2 class="anchored" data-anchor-id="original-two-period-thoemmes-and-ong-results">Original two-period Thoemmes and Ong results</h2>
<p>Here’s the original code from the appendix of <span class="citation" data-cites="ThoemmesOng:2016">Thoemmes and Ong (<a href="#ref-ThoemmesOng:2016" role="doc-biblioref">2016</a>)</span> for data with a time-varying continuous treatment and a confounder. It explicitly creates columns for <code>t1</code>, <code>d1</code>, <code>t2</code>, and <code>d2</code>, so it is easy to mathematically make it so that <code>t2</code> is caused by <code>d1</code>.</p>
<p>Because it’s only two time periods, they calculate the inverse probability weights in two formulas and then multiply them together:</p>
<ul>
<li>
<p>Weights for the first time period:</p>
<p><span class="math display">\[
  w_1 = \frac{\phi(T_{i1})}{\phi(T_{i1}\ |\ C)}
  \]</span></p>
</li>
<li>
<p>Weights for the second time period:</p>
<p><span class="math display">\[
  w_2 = \frac{\phi(T_{i2}\ |\ T_{i1})}{\phi(T_{i2}\ |\ C, T_{i1}, D_{i1})}
  \]</span></p>
</li>
<li>
<p>Final weights:</p>
<p><span class="math display">\[
  w = w_1 \cdot w_2
  \]</span></p>
</li>
</ul>
<p>Here’s their code:</p>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">##################################################################### </span></span>
<span><span class="co"># iptw demo with time-varying continuous treatment and confounder</span></span>
<span><span class="co">#####################################################################</span></span>
<span><span class="co"># Felix Thoemmes, October, 2015 </span></span>
<span><span class="co">#####################################################################</span></span>
<span></span>
<span><span class="co">#set seed to replicate results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">12345</span><span class="op">)</span></span>
<span><span class="co">#define sample size</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">2000</span></span>
<span><span class="co">#define confounder c</span></span>
<span><span class="va">c</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#define treatment at time 1 as function of confounder</span></span>
<span><span class="va">t1</span> <span class="op">&lt;-</span> <span class="fl">.1</span><span class="op">*</span><span class="va">c</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span>,<span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fl">.99</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#define depression at time 1 as function of confounder and treat1</span></span>
<span><span class="va">d1</span> <span class="op">&lt;-</span> <span class="fl">.1</span><span class="op">*</span><span class="va">c</span> <span class="op">+</span> <span class="fl">.4</span><span class="op">*</span><span class="va">t1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span>,<span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fl">.822</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#define treatment at time 2 as function of confounder and dep1</span></span>
<span><span class="va">t2</span> <span class="op">&lt;-</span> <span class="fl">.1</span><span class="op">*</span><span class="va">c</span> <span class="op">+</span> <span class="fl">.4</span><span class="op">*</span><span class="va">d1</span> <span class="op">+</span> <span class="fl">.4</span><span class="op">*</span><span class="va">t1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span>,<span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fl">.5196</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#define outcome depression at time 2 as function of confounder, treat1, and dep1 </span></span>
<span><span class="va">d2</span> <span class="op">&lt;-</span> <span class="fl">.1</span><span class="op">*</span><span class="va">c</span> <span class="op">+</span> <span class="fl">.4</span><span class="op">*</span><span class="va">t2</span> <span class="op">+</span> <span class="fl">.4</span><span class="op">*</span><span class="va">d1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span>,<span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fl">.4582</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#add ID variable to do mixed effects models later</span></span>
<span><span class="va">id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">c</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">c</span>, <span class="va">t1</span>, <span class="va">d1</span>, <span class="va">t2</span>, <span class="va">d2</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#compute the weights for timepoint 1</span></span>
<span><span class="co">#this is a continuous treatment</span></span>
<span><span class="co">#therefore we use densities of normal distributions</span></span>
<span><span class="co">#weights at time 1</span></span>
<span><span class="va">w1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">df1</span><span class="op">$</span><span class="va">t1</span>, <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">t1</span> <span class="op">~</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">t1</span> <span class="op">~</span> <span class="fl">1</span><span class="op">)</span><span class="op">$</span><span class="va">residuals</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">df1</span><span class="op">$</span><span class="va">t1</span>, <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">t1</span> <span class="op">~</span> <span class="va">c</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">t1</span> <span class="op">~</span> <span class="va">c</span><span class="op">)</span><span class="op">$</span><span class="va">residuals</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#weights at time 2</span></span>
<span><span class="va">w2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">df1</span><span class="op">$</span><span class="va">t2</span>, <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">t2</span> <span class="op">~</span> <span class="va">t1</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">t2</span> <span class="op">~</span> <span class="va">t1</span><span class="op">)</span><span class="op">$</span><span class="va">residuals</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">df1</span><span class="op">$</span><span class="va">t2</span>, <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">t2</span> <span class="op">~</span> <span class="va">c</span> <span class="op">+</span> <span class="va">d1</span> <span class="op">+</span> <span class="va">t1</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">t2</span> <span class="op">~</span> <span class="va">c</span> <span class="op">+</span> <span class="va">d1</span> <span class="op">+</span> <span class="va">t1</span><span class="op">)</span><span class="op">$</span><span class="va">residuals</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="co">#total weights are a product of all time-varying weights</span></span>
<span><span class="va">w</span> <span class="op">&lt;-</span> <span class="va">w1</span><span class="op">*</span><span class="va">w2</span></span>
<span></span>
<span><span class="co">#truncate weights at 5%</span></span>
<span><span class="va">tw1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">w</span> <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">w</span>, probs <span class="op">=</span> <span class="fl">.05</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">w</span>, probs <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span>, <span class="va">w</span><span class="op">)</span></span>
<span><span class="va">tw1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">w</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">w</span>, probs <span class="op">=</span> <span class="fl">.95</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">w</span>, probs <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span>, <span class="va">tw1</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#truncate weights at 1%</span></span>
<span><span class="va">tw2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">w</span> <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">w</span>, probs <span class="op">=</span> <span class="fl">.01</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">w</span>, probs <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span>, <span class="va">w</span><span class="op">)</span></span>
<span><span class="va">tw2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">w</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">w</span>, probs <span class="op">=</span> <span class="fl">.99</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">w</span>, probs <span class="op">=</span> <span class="fl">0.99</span><span class="op">)</span>, <span class="va">tw2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>They they run a bunch of different outcome models with <code>geeglm()</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">only_t1</span> <span class="op">&lt;-</span> <span class="fu">geeglm</span><span class="op">(</span><span class="va">d2</span> <span class="op">~</span> <span class="va">t1</span>, data <span class="op">=</span> <span class="va">df1</span>, id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">df1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">only_t2</span> <span class="op">&lt;-</span> <span class="fu">geeglm</span><span class="op">(</span><span class="va">d2</span> <span class="op">~</span> <span class="va">t2</span>, data <span class="op">=</span> <span class="va">df1</span>, id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">df1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">both_t</span> <span class="op">&lt;-</span> <span class="fu">geeglm</span><span class="op">(</span><span class="va">d2</span> <span class="op">~</span> <span class="va">t1</span> <span class="op">+</span> <span class="va">t2</span>, data <span class="op">=</span> <span class="va">df1</span>, id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">df1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">both_t_c</span> <span class="op">&lt;-</span> <span class="fu">geeglm</span><span class="op">(</span><span class="va">d2</span> <span class="op">~</span> <span class="va">t1</span> <span class="op">+</span> <span class="va">t2</span> <span class="op">+</span> <span class="va">c</span> <span class="op">+</span> <span class="va">d1</span>, data <span class="op">=</span> <span class="va">df1</span>, id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">df1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">stab_ipw</span> <span class="op">&lt;-</span> <span class="fu">geeglm</span><span class="op">(</span><span class="va">d2</span> <span class="op">~</span> <span class="va">t1</span> <span class="op">+</span> <span class="va">t2</span>, data <span class="op">=</span> <span class="va">df1</span>, id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">df1</span><span class="op">)</span>, weights <span class="op">=</span> <span class="va">w</span><span class="op">)</span></span>
<span><span class="va">stab_ipw_1p</span> <span class="op">&lt;-</span> <span class="fu">geeglm</span><span class="op">(</span><span class="va">d2</span> <span class="op">~</span> <span class="va">t1</span> <span class="op">+</span> <span class="va">t2</span>, data <span class="op">=</span> <span class="va">df1</span>, id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">df1</span><span class="op">)</span>, weights <span class="op">=</span> <span class="va">tw2</span><span class="op">)</span></span>
<span><span class="va">stab_ipw_5p</span> <span class="op">&lt;-</span> <span class="fu">geeglm</span><span class="op">(</span><span class="va">d2</span> <span class="op">~</span> <span class="va">t1</span> <span class="op">+</span> <span class="va">t2</span>, data <span class="op">=</span> <span class="va">df1</span>, id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">df1</span><span class="op">)</span>, weights <span class="op">=</span> <span class="va">tw1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu">tribble</span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">`Method`</span>, <span class="op">~</span><span class="va">`T&lt;sub&gt;1&lt;/sub&gt; effect`</span>, <span class="op">~</span><span class="va">`T&lt;sub&gt;2&lt;/sub&gt; effect`</span>,</span>
<span>  <span class="st">"True effect"</span>, <span class="fl">0.160</span>, <span class="fl">0.400</span>,</span>
<span>  <span class="st">"Naive, only T1"</span>, <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu">tidy</span><span class="op">(</span><span class="va">only_t1</span><span class="op">)</span>, <span class="va">term</span> <span class="op">==</span> <span class="st">"t1"</span><span class="op">)</span><span class="op">$</span><span class="va">estimate</span>, <span class="cn">NA</span>,</span>
<span>  <span class="st">"Naive, only T2"</span>, <span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu">tidy</span><span class="op">(</span><span class="va">only_t2</span><span class="op">)</span>, <span class="va">term</span> <span class="op">==</span> <span class="st">"t2"</span><span class="op">)</span><span class="op">$</span><span class="va">estimate</span>,</span>
<span>  <span class="st">"Naive, both"</span>, <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu">tidy</span><span class="op">(</span><span class="va">both_t</span><span class="op">)</span>, <span class="va">term</span> <span class="op">==</span> <span class="st">"t1"</span><span class="op">)</span><span class="op">$</span><span class="va">estimate</span>, <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu">tidy</span><span class="op">(</span><span class="va">both_t</span><span class="op">)</span>, <span class="va">term</span> <span class="op">==</span> <span class="st">"t2"</span><span class="op">)</span><span class="op">$</span><span class="va">estimate</span>,</span>
<span>  <span class="st">"Naive, both + controls"</span>, <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu">tidy</span><span class="op">(</span><span class="va">both_t_c</span><span class="op">)</span>, <span class="va">term</span> <span class="op">==</span> <span class="st">"t1"</span><span class="op">)</span><span class="op">$</span><span class="va">estimate</span>, <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu">tidy</span><span class="op">(</span><span class="va">both_t_c</span><span class="op">)</span>, <span class="va">term</span> <span class="op">==</span> <span class="st">"t2"</span><span class="op">)</span><span class="op">$</span><span class="va">estimate</span>,</span>
<span>  <span class="st">"IPW"</span>, <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu">tidy</span><span class="op">(</span><span class="va">stab_ipw</span><span class="op">)</span>, <span class="va">term</span> <span class="op">==</span> <span class="st">"t1"</span><span class="op">)</span><span class="op">$</span><span class="va">estimate</span>, <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu">tidy</span><span class="op">(</span><span class="va">stab_ipw</span><span class="op">)</span>, <span class="va">term</span> <span class="op">==</span> <span class="st">"t2"</span><span class="op">)</span><span class="op">$</span><span class="va">estimate</span>,</span>
<span>  <span class="st">"IPW, 1% truncated"</span>, <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu">tidy</span><span class="op">(</span><span class="va">stab_ipw_1p</span><span class="op">)</span>, <span class="va">term</span> <span class="op">==</span> <span class="st">"t1"</span><span class="op">)</span><span class="op">$</span><span class="va">estimate</span>, <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu">tidy</span><span class="op">(</span><span class="va">stab_ipw_1p</span><span class="op">)</span>, <span class="va">term</span> <span class="op">==</span> <span class="st">"t2"</span><span class="op">)</span><span class="op">$</span><span class="va">estimate</span>,</span>
<span>  <span class="st">"IPW, 5% truncated"</span>, <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu">tidy</span><span class="op">(</span><span class="va">stab_ipw_5p</span><span class="op">)</span>, <span class="va">term</span> <span class="op">==</span> <span class="st">"t1"</span><span class="op">)</span><span class="op">$</span><span class="va">estimate</span>, <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu">tidy</span><span class="op">(</span><span class="va">stab_ipw_5p</span><span class="op">)</span>, <span class="va">term</span> <span class="op">==</span> <span class="st">"t2"</span><span class="op">)</span><span class="op">$</span><span class="va">estimate</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<table class="table table-sm caption-top table-striped small" data-quarto-postprocess="true">
<thead><tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Method</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">T<sub>1</sub> effect</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">T<sub>2</sub> effect</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">True effect</td>
<td style="text-align: right;">0.160</td>
<td style="text-align: right;">0.400</td>
</tr>
<tr class="even">
<td style="text-align: left;">Naive, only T1</td>
<td style="text-align: right;">0.423</td>
<td style="text-align: right;">—</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Naive, only T2</td>
<td style="text-align: right;">—</td>
<td style="text-align: right;">0.649</td>
</tr>
<tr class="even">
<td style="text-align: left;">Naive, both</td>
<td style="text-align: right;">0.048</td>
<td style="text-align: right;">0.623</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Naive, both + controls</td>
<td style="text-align: right;">0.011</td>
<td style="text-align: right;">0.399</td>
</tr>
<tr class="even">
<td style="text-align: left;">IPW</td>
<td style="text-align: right;">0.157</td>
<td style="text-align: right;">0.421</td>
</tr>
<tr class="odd">
<td style="text-align: left;">IPW, 1% truncated</td>
<td style="text-align: right;">0.154</td>
<td style="text-align: right;">0.434</td>
</tr>
<tr class="even">
<td style="text-align: left;">IPW, 5% truncated</td>
<td style="text-align: right;">0.131</td>
<td style="text-align: right;">0.480</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>And here’s all that compared to what they have in the paper:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="ThoemmesOng-Table2.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:70.0%"></p>
</figure>
</div>
</div>
</div>
<p>It’s identical! I’m chalking any tiny differences up to the fact that <code><a href="https://rdrr.io/r/base/Random.html">set.seed()</a></code> changed with R 4.0 and they used R 3.x in their paper. (Also the T2-only model is wrong, but that’s probably a typo—the “estimated scale parameter” from that model is 0.574 with an sd of 0.018, which lines up perfectly with the coefficient in the published table, so I think maybe the published paper has the wrong number in the table.)</p>
<p>Also, there seems to be another typo in that table. The true effect of T1 in the table is 0.140, but in the text of the paper, it says the effect should be 0.160, which makes sense—that’s the product of 0.4 × 0.4, or each of the treatment coefficients (<span class="math inline">\(0.4 \times 0.4 = 0.16\)</span>).</p>
<p>Regardless of those super tiny insignificant typos, we did it! We have their exact results using marginal structural models and inverse probability weights.</p>
</section><section id="tidier-two-period-results" class="level2"><h2 class="anchored" data-anchor-id="tidier-two-period-results">Tidier two-period results</h2>
<p>The code to generate that data isn’t very tidyverse-friendly and it creates a ton of intermediate vectors. Here’s a cleaner version with <strong>dplyr</strong>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">12345</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">2000</span></span>
<span></span>
<span><span class="va">df_nice</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span>id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span>,</span>
<span>                  c <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>t1 <span class="op">=</span> <span class="op">(</span><span class="fl">0.1</span> <span class="op">*</span> <span class="va">c</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fl">0.99</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         d1 <span class="op">=</span> <span class="op">(</span><span class="fl">0.1</span> <span class="op">*</span> <span class="va">c</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">0.4</span> <span class="op">*</span> <span class="va">t1</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fl">0.822</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         t2 <span class="op">=</span> <span class="op">(</span><span class="fl">0.1</span> <span class="op">*</span> <span class="va">c</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">0.4</span> <span class="op">*</span> <span class="va">d1</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">0.4</span> <span class="op">*</span> <span class="va">t1</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fl">0.5196</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         d2 <span class="op">=</span> <span class="op">(</span><span class="fl">0.1</span> <span class="op">*</span> <span class="va">c</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">0.4</span> <span class="op">*</span> <span class="va">t2</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">0.4</span> <span class="op">*</span> <span class="va">d1</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fl">0.4582</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Also, this original data is wide, with explicit columns for each time period. Let’s make it tidy and pretend the time periods are years (<code>y</code>) and add some lagged columns:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df_tidy</span> <span class="op">&lt;-</span> <span class="va">df_nice</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">pivot_longer</span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">t1</span>, <span class="va">d1</span>, <span class="va">t2</span>, <span class="va">d2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">separate</span><span class="op">(</span><span class="va">name</span>, into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"variable"</span>, <span class="st">"y"</span><span class="op">)</span>, sep <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="st">"variable"</span>, values_from <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">t</span>, <span class="va">d</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>lag <span class="op">=</span> <span class="va">lag</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">df_tidy</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 6 × 7</span></span>
<span><span class="co">##      id      c y           t       d  t_lag   d_lag</span></span>
<span><span class="co">##   &lt;int&gt;  &lt;dbl&gt; &lt;chr&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;</span></span>
<span><span class="co">## 1     1  0.586 1     -0.546  -1.11   NA     NA     </span></span>
<span><span class="co">## 2     1  0.586 2     -0.853  -1.73   -0.546 -1.11  </span></span>
<span><span class="co">## 3     2  0.709 1      1.14    0.361  NA     NA     </span></span>
<span><span class="co">## 4     2  0.709 2     -0.0673 -1.30    1.14   0.361 </span></span>
<span><span class="co">## 5     3 -0.109 1     -0.584  -0.0822 NA     NA     </span></span>
<span><span class="co">## 6     3 -0.109 2     -0.932   0.535  -0.584 -0.0822</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This is how panel data is typically structured, with rows repeated for each time period. This is good because we can figure out how to structure the weight models and outcome model in a way that uses this structure and compare it to the original <code>t1</code>, <code>d1</code>, etc. models.</p>
<p>Because there are only two time periods, the lagged columns here are missing a ton of data (since you can’t see what the value is for year 0), but it’ll still work.</p>
<p>With the data like this, we can find the weights. We’ll do it both manually and with the <strong>ipw</strong> package.</p>
<p>Manually, we need to fit two models (a numerator and denominator) and then take the cumulative product of their probability distributions:</p>
<p><span class="math display">\[
w = \prod^t_{t = 1} \frac{\phi(T_{it} | T_{i, t-1}, C_i)}{\phi(T_{it} | T_{i, t-1}, D_{i, t-1}, C_i)}
\]</span></p>
<p>Here we go!</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Remove NAs since ipwpoint() will complain</span></span>
<span><span class="va">df_tidy_sans_na</span> <span class="op">&lt;-</span> <span class="va">df_tidy</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">t_lag</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Manually</span></span>
<span><span class="co"># Numerator is lagged treatment + non-varying confounders</span></span>
<span><span class="va">model_num</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">t</span> <span class="op">~</span> <span class="va">t_lag</span> <span class="op">+</span> <span class="va">c</span>,</span>
<span>                data <span class="op">=</span> <span class="va">df_tidy_sans_na</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Denominator is lagged treatment, lagged outcome, time-varying confounders +</span></span>
<span><span class="co"># non-varying confounders</span></span>
<span><span class="va">model_denom</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">t</span> <span class="op">~</span> <span class="va">t_lag</span> <span class="op">+</span> <span class="va">d_lag</span> <span class="op">+</span> <span class="va">c</span>, </span>
<span>                  data <span class="op">=</span> <span class="va">df_tidy_sans_na</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Probability distributions</span></span>
<span><span class="va">num</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">df_tidy_sans_na</span><span class="op">$</span><span class="va">t</span>,</span>
<span>             <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">model_num</span><span class="op">)</span>,</span>
<span>             <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span><span class="op">(</span><span class="va">model_num</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">den</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">df_tidy_sans_na</span><span class="op">$</span><span class="va">t</span>,</span>
<span>             <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">model_denom</span><span class="op">)</span>,</span>
<span>             <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span><span class="op">(</span><span class="va">model_denom</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Make num/den fraction and find cumulative product within each id</span></span>
<span><span class="va">df_weights_manual</span> <span class="op">&lt;-</span> <span class="va">df_tidy_sans_na</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>weights_no_time <span class="op">=</span> <span class="va">num</span> <span class="op">/</span> <span class="va">den</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>ipw <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumprod</a></span><span class="op">(</span><span class="va">weights_no_time</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Automatically find weights with ipw::ipwpoint()</span></span>
<span><span class="va">tidy_weights_auto</span> <span class="op">&lt;-</span> <span class="fu">ipwpoint</span><span class="op">(</span></span>
<span>  exposure <span class="op">=</span> <span class="va">t</span>,</span>
<span>  family <span class="op">=</span> <span class="st">"gaussian"</span>, </span>
<span>  numerator <span class="op">=</span> <span class="op">~</span> <span class="va">t_lag</span> <span class="op">+</span> <span class="va">c</span>, </span>
<span>  denominator <span class="op">=</span> <span class="op">~</span> <span class="va">t_lag</span> <span class="op">+</span> <span class="va">d_lag</span> <span class="op">+</span> <span class="va">c</span>, </span>
<span>  data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">df_tidy_sans_na</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df_weights_auto</span> <span class="op">&lt;-</span> <span class="va">df_tidy_sans_na</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>ipw <span class="op">=</span> <span class="va">tidy_weights_auto</span><span class="op">$</span><span class="va">ipw.weights</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can use these new weights in the outcome model:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_lags_manual</span> <span class="op">&lt;-</span> <span class="fu">geeglm</span><span class="op">(</span><span class="va">d</span> <span class="op">~</span> <span class="va">t</span> <span class="op">+</span> <span class="va">t_lag</span>, data <span class="op">=</span> <span class="va">df_weights_manual</span>,</span>
<span>                            id <span class="op">=</span> <span class="va">id</span>, weights <span class="op">=</span> <span class="va">ipw</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_lags_auto</span> <span class="op">&lt;-</span> <span class="fu">geeglm</span><span class="op">(</span><span class="va">d</span> <span class="op">~</span> <span class="va">t</span> <span class="op">+</span> <span class="va">t_lag</span>, data <span class="op">=</span> <span class="va">df_weights_auto</span>, </span>
<span>                          id <span class="op">=</span> <span class="va">id</span>, weights <span class="op">=</span> <span class="va">ipw</span><span class="op">)</span></span>
<span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu">tribble</span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">`Method`</span>, <span class="op">~</span><span class="va">`T&lt;sub&gt;1&lt;/sub&gt; effect`</span>, <span class="op">~</span><span class="va">`T&lt;sub&gt;2&lt;/sub&gt; effect`</span>,</span>
<span>  <span class="st">"True effect"</span>, <span class="fl">0.160</span>, <span class="fl">0.400</span>,</span>
<span>  <span class="st">"IPW, original"</span>, <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu">tidy</span><span class="op">(</span><span class="va">stab_ipw</span><span class="op">)</span>, <span class="va">term</span> <span class="op">==</span> <span class="st">"t1"</span><span class="op">)</span><span class="op">$</span><span class="va">estimate</span>, <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu">tidy</span><span class="op">(</span><span class="va">stab_ipw</span><span class="op">)</span>, <span class="va">term</span> <span class="op">==</span> <span class="st">"t2"</span><span class="op">)</span><span class="op">$</span><span class="va">estimate</span>,</span>
<span>  <span class="st">"IPW, lagged, manual"</span>, <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_lags_manual</span><span class="op">)</span>, <span class="va">term</span> <span class="op">==</span> <span class="st">"t_lag"</span><span class="op">)</span><span class="op">$</span><span class="va">estimate</span>, <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_lags_manual</span><span class="op">)</span>, <span class="va">term</span> <span class="op">==</span> <span class="st">"t"</span><span class="op">)</span><span class="op">$</span><span class="va">estimate</span>,</span>
<span>  <span class="st">"IPW, lagged, automatic"</span>, <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_lags_auto</span><span class="op">)</span>, <span class="va">term</span> <span class="op">==</span> <span class="st">"t_lag"</span><span class="op">)</span><span class="op">$</span><span class="va">estimate</span>, <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_lags_auto</span><span class="op">)</span>, <span class="va">term</span> <span class="op">==</span> <span class="st">"t"</span><span class="op">)</span><span class="op">$</span><span class="va">estimate</span></span>
<span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">3</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"%.3f"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">.</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">add_row</span><span class="op">(</span>`T&lt;sub&gt;1&lt;/sub&gt; effect` <span class="op">=</span> <span class="st">"&lt;b&gt;lag(T) effect&lt;/b&gt;"</span>, </span>
<span>          `T&lt;sub&gt;2&lt;/sub&gt; effect` <span class="op">=</span> <span class="st">"&lt;b&gt;T effect&lt;/b&gt;"</span>, </span>
<span>          .after <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<table class="table table-sm caption-top table-striped small" data-quarto-postprocess="true">
<thead><tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Method</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">T<sub>1</sub> effect</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">T<sub>2</sub> effect</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">True effect</td>
<td style="text-align: left;">0.160</td>
<td style="text-align: left;">0.400</td>
</tr>
<tr class="even">
<td style="text-align: left;">IPW, original</td>
<td style="text-align: left;">0.157</td>
<td style="text-align: left;">0.421</td>
</tr>
<tr class="odd">
<td style="text-align: left;">—</td>
<td style="text-align: left;"><strong>lag(T) effect</strong></td>
<td style="text-align: left;"><strong>T effect</strong></td>
</tr>
<tr class="even">
<td style="text-align: left;">IPW, lagged, manual</td>
<td style="text-align: left;">0.150</td>
<td style="text-align: left;">0.441</td>
</tr>
<tr class="odd">
<td style="text-align: left;">IPW, lagged, automatic</td>
<td style="text-align: left;">0.150</td>
<td style="text-align: left;">0.441</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Those results aren’t identical (I don’t know why!), but they’re close-ish, so whatever. It worked! Instead of using explicit <code>t1</code>, <code>d1</code>, etc. columns, we can do the same marginal structural model with just <code>t</code> and <code>d</code> in a long data frame.</p>
</section><section id="expansion-to-multiple-period-data" class="level2"><h2 class="anchored" data-anchor-id="expansion-to-multiple-period-data">Expansion to multiple-period data</h2>
<p>Since that’s all working, now we can do something a little/lot trickier—instead of manually specifying <span class="math inline">\(T_1\)</span> and <span class="math inline">\(T_2\)</span>, which isn’t really easily scalable to more time periods, we’ll construct the data more generally for any number of years</p>
<section id="tricky-interdependent-data-generating-process" class="level3"><h3 class="anchored" data-anchor-id="tricky-interdependent-data-generating-process">Tricky interdependent data generating process</h3>
<p>The trick here is that we want to have any number of time periods, but also maintain the same DAG relationships. In the small data, these are the two general relationships:</p>
<ul>
<li><span class="math inline">\(\text{treatment}_t = (0.1 \cdot \text{confounder}) + (0.4 \cdot \text{depression}_{t-1}) + (0.4 \cdot \text{treatment}_{t-1}) + \text{noise}\)</span></li>
<li><span class="math inline">\(\text{depression}_t = (0.1 \cdot \text{confounder}) + (0.4 \cdot \text{treatment}_{t}) + (0.4 \cdot \text{depression}_{t-1}) + \text{noise}\)</span></li>
</ul>
<p>Or in code:</p>
<ul>
<li><code>t = (0.1 * c) + (0.4 * lag(d)) + (0.4 * lag(t)) + rnorm(n, 0, sqrt(0.5196))</code></li>
<li><code>d = (0.1 * c) + (0.4 * t) + (0.4 * lag(d)) + rnorm(n, 0, sqrt(0.4582))</code></li>
</ul>
<p>Generating this data in a tidy <strong>dplyr</strong> way is super tricky, since the <code>t</code> and <code>d</code> columns are interdependent—the data has to be generated rowwise, but we also have to be able to look back a row to get the lagged values of <code>t</code> and <code>d</code>. I’ve seen people like <span class="citation" data-cites="BlackwellGlynn:2018">Blackwell and Glynn (<a href="#ref-BlackwellGlynn:2018" role="doc-biblioref">2018</a>)</span> get around this by using a <code>for</code> loop to build the data, but I have an aversion to for loops in R <a href="https://r4ds.had.co.nz/iteration.html#for-loops-vs.-functionals">since <strong>purrr</strong> exists</a>, so I spent way too much time trying to figure out a <strong>purrr</strong>-based way to do this. Others have tried this (like <a href="https://community.rstudio.com/t/row-wise-iteration-in-a-dataframe-with-interdependent-variables/38778">this RStudio Community post</a>), and I <a href="https://twitter.com/andrewheiss/status/1347780639714664448">asked about it on Twitter</a>, where I got a few cool solutions using <code>purrr::accumulate()</code> and <code>purrr::reduce()</code>, like <a href="https://twitter.com/ianmoran011/status/1347849678696574977">this fancy <code>accumutate()</code> function from Ian Moran</a> and <a href="https://gist.github.com/andrewheiss/89ae26a7a4682aff0ee9b7db1e92c326#gistcomment-3587810">these solutions from Miles McBain</a>.</p>
<p>There are no loops involved in those solutions, but phew that accumulate/reduce syntax is wonky and I can’t fully wrap my head around it (plus it makes it hard to carry over non-accumulated variables). So I resorted to a loop. Oooof.</p>
<p>It works, though! Let’s test it on just one ID. We’ll generate just one row with <code>t1</code>, <code>t2</code>, <code>d1</code>, and <code>d2</code>, and we’ll remove the noise from each of the columns:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">12345</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span></span>
<span><span class="co"># Remove all noise so that we can compare this with the function version</span></span>
<span><span class="va">df_example</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span>id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span>,</span>
<span>                     c <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>t1 <span class="op">=</span> <span class="op">(</span><span class="fl">0.1</span> <span class="op">*</span> <span class="va">c</span><span class="op">)</span>,</span>
<span>         d1 <span class="op">=</span> <span class="op">(</span><span class="fl">0.1</span> <span class="op">*</span> <span class="va">c</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">0.4</span> <span class="op">*</span> <span class="va">t1</span><span class="op">)</span>,</span>
<span>         t2 <span class="op">=</span> <span class="op">(</span><span class="fl">0.1</span> <span class="op">*</span> <span class="va">c</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">0.4</span> <span class="op">*</span> <span class="va">d1</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">0.4</span> <span class="op">*</span> <span class="va">t1</span><span class="op">)</span>,</span>
<span>         d2 <span class="op">=</span> <span class="op">(</span><span class="fl">0.1</span> <span class="op">*</span> <span class="va">c</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">0.4</span> <span class="op">*</span> <span class="va">t2</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">0.4</span> <span class="op">*</span> <span class="va">d1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">df_example</span></span>
<span><span class="co">## # A tibble: 1 × 6</span></span>
<span><span class="co">##      id     c     t1     d1    t2    d2</span></span>
<span><span class="co">##   &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">## 1     1 0.586 0.0586 0.0820 0.115 0.137</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This isn’t tidy data, so technically there are two years here. We’ll keep <code>t1</code> and <code>d1</code> as the initial values for year 1, then generate values for 5 years. If we do this right, the <code>t</code> and <code>d</code> values for year 2 should be identical to <code>t2</code> and <code>d2</code> here.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Add a bunch of extra years with empty cells for t and d</span></span>
<span><span class="va">df_multiple_years_empty</span> <span class="op">&lt;-</span> <span class="va">df_example</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>y <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">id</span>, <span class="va">y</span>, t <span class="op">=</span> <span class="va">t1</span>, d <span class="op">=</span> <span class="va">d1</span>, <span class="va">c</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">add_row</span><span class="op">(</span>y <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># c doesn't vary across time</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>id <span class="op">=</span> <span class="fl">1</span>, </span>
<span>         c <span class="op">=</span> <span class="va">df_example</span><span class="op">$</span><span class="va">c</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">df_multiple_years_empty</span></span>
<span><span class="co">## # A tibble: 5 × 5</span></span>
<span><span class="co">##      id     y       t       d     c</span></span>
<span><span class="co">##   &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">## 1     1     1  0.0586  0.0820 0.586</span></span>
<span><span class="co">## 2     1     2 NA      NA      0.586</span></span>
<span><span class="co">## 3     1     3 NA      NA      0.586</span></span>
<span><span class="co">## 4     1     4 NA      NA      0.586</span></span>
<span><span class="co">## 5     1     5 NA      NA      0.586</span></span>
<span></span>
<span><span class="co"># Now we need to build the interdependent values for t and d with &lt;gasp&gt; a loop</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># The loop is inside this function---it skips the initial row and then</span></span>
<span><span class="co"># iteratively adds new rows. We can't use neat things like lag(t), so instead</span></span>
<span><span class="co"># we use df$t[i - 1]</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># We omit the extra noise for now</span></span>
<span><span class="va">dgp</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">df</span><span class="op">$</span><span class="va">t</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">0.1</span> <span class="op">*</span> <span class="va">df</span><span class="op">$</span><span class="va">c</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">0.4</span> <span class="op">*</span> <span class="va">df</span><span class="op">$</span><span class="va">d</span><span class="op">[</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">0.4</span> <span class="op">*</span> <span class="va">df</span><span class="op">$</span><span class="va">t</span><span class="op">[</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">df</span><span class="op">$</span><span class="va">d</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">0.1</span> <span class="op">*</span> <span class="va">df</span><span class="op">$</span><span class="va">c</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">0.4</span> <span class="op">*</span> <span class="va">df</span><span class="op">$</span><span class="va">t</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">0.4</span> <span class="op">*</span> <span class="va">df</span><span class="op">$</span><span class="va">d</span><span class="op">[</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">df</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Generate all 5 years</span></span>
<span><span class="va">df_multiple_years_empty</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">dgp</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 5 × 5</span></span>
<span><span class="co">##      id     y      t      d     c</span></span>
<span><span class="co">##   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">## 1     1     1 0.0586 0.0820 0.586</span></span>
<span><span class="co">## 2     1     2 0.115  0.137  0.586</span></span>
<span><span class="co">## 3     1     3 0.159  0.177  0.586</span></span>
<span><span class="co">## 4     1     4 0.193  0.207  0.586</span></span>
<span><span class="co">## 5     1     5 0.219  0.229  0.586</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If this worked, the <code>t</code> and <code>d</code> values for year 2 should be the same as <code>t2</code> and <code>d2</code> here:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df_example</span></span>
<span><span class="co">## # A tibble: 1 × 6</span></span>
<span><span class="co">##      id     c     t1     d1    t2    d2</span></span>
<span><span class="co">##   &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">## 1     1 0.586 0.0586 0.0820 0.115 0.137</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>They are!</p>
<p>Since we know it works, let’s generate a big dataset for playing with multi-year MSMs, this time with noise:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Make data for the first year</span></span>
<span><span class="va">df_first_year</span> <span class="op">&lt;-</span> <span class="fu">expand_grid</span><span class="op">(</span>id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2000</span>, y <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>c <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>         t <span class="op">=</span> <span class="op">(</span><span class="fl">0.1</span> <span class="op">*</span> <span class="va">c</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span>, <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fl">0.99</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         d <span class="op">=</span> <span class="op">(</span><span class="fl">0.1</span> <span class="op">*</span> <span class="va">c</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">0.4</span> <span class="op">*</span> <span class="va">t</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span>, <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fl">0.822</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">df_first_year</span></span>
<span><span class="co">## # A tibble: 2,000 × 5</span></span>
<span><span class="co">##       id     y      c        t       d</span></span>
<span><span class="co">##    &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;</span></span>
<span><span class="co">##  1     1     1 -1.21  -1.09    -1.43  </span></span>
<span><span class="co">##  2     2     1  0.277 -0.0714  -0.739 </span></span>
<span><span class="co">##  3     3     1  1.08  -0.00174 -0.0686</span></span>
<span><span class="co">##  4     4     1 -2.35   0.952    1.88  </span></span>
<span><span class="co">##  5     5     1  0.429 -1.60     0.0373</span></span>
<span><span class="co">##  6     6     1  0.506 -0.990    0.535 </span></span>
<span><span class="co">##  7     7     1 -0.575 -1.79    -0.889 </span></span>
<span><span class="co">##  8     8     1 -0.547  0.456   -1.14  </span></span>
<span><span class="co">##  9     9     1 -0.564 -0.500    0.386 </span></span>
<span><span class="co">## 10    10     1 -0.890 -1.92    -1.04  </span></span>
<span><span class="co">## # ℹ 1,990 more rows</span></span>
<span></span>
<span><span class="co"># Add empty years 2-5</span></span>
<span><span class="va">df_panel_empty</span> <span class="op">&lt;-</span> <span class="va">df_first_year</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">bind_rows</span><span class="op">(</span><span class="fu">expand_grid</span><span class="op">(</span>id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2000</span>, y <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="va">id</span>, <span class="va">y</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">df_panel_empty</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 10 × 5</span></span>
<span><span class="co">##       id     y      c       t      d</span></span>
<span><span class="co">##    &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span><span class="co">##  1     1     1 -1.21  -1.09   -1.43 </span></span>
<span><span class="co">##  2     1     2 NA     NA      NA    </span></span>
<span><span class="co">##  3     1     3 NA     NA      NA    </span></span>
<span><span class="co">##  4     1     4 NA     NA      NA    </span></span>
<span><span class="co">##  5     1     5 NA     NA      NA    </span></span>
<span><span class="co">##  6     2     1  0.277 -0.0714 -0.739</span></span>
<span><span class="co">##  7     2     2 NA     NA      NA    </span></span>
<span><span class="co">##  8     2     3 NA     NA      NA    </span></span>
<span><span class="co">##  9     2     4 NA     NA      NA    </span></span>
<span><span class="co">## 10     2     5 NA     NA      NA</span></span>
<span></span>
<span><span class="co"># Add noise to the fancy dgp() function</span></span>
<span><span class="va">dgp</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">df</span><span class="op">$</span><span class="va">t</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">0.1</span> <span class="op">*</span> <span class="va">df</span><span class="op">$</span><span class="va">c</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">0.4</span> <span class="op">*</span> <span class="va">df</span><span class="op">$</span><span class="va">d</span><span class="op">[</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">0.4</span> <span class="op">*</span> <span class="va">df</span><span class="op">$</span><span class="va">t</span><span class="op">[</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fl">0.5196</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">df</span><span class="op">$</span><span class="va">d</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">0.1</span> <span class="op">*</span> <span class="va">df</span><span class="op">$</span><span class="va">c</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">0.4</span> <span class="op">*</span> <span class="va">df</span><span class="op">$</span><span class="va">t</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">0.4</span> <span class="op">*</span> <span class="va">df</span><span class="op">$</span><span class="va">d</span><span class="op">[</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fl">0.4582</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">df</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Run dgp() within each id</span></span>
<span><span class="va">df_panel</span> <span class="op">&lt;-</span> <span class="va">df_panel_empty</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># This doesn't vary with time, so repeat it across all the years</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>c <span class="op">=</span> <span class="va">c</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Nest the data into a single cell in each row</span></span>
<span>  <span class="fu">nest</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Run dgp() on the nested cell (in a column named "data")</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>dgp <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">data</span>, <span class="va">dgp</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">data</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Unnest the nested dgp()-ed cells</span></span>
<span>  <span class="fu">unnest</span><span class="op">(</span><span class="va">dgp</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Add some lags</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">t</span>, <span class="va">d</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>lag <span class="op">=</span> <span class="va">lag</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">df_panel</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 10 × 7</span></span>
<span><span class="co">##       id     y      c       t      d   t_lag  d_lag</span></span>
<span><span class="co">##    &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span><span class="co">##  1     1     1 -1.21  -1.09   -1.43  NA      NA    </span></span>
<span><span class="co">##  2     1     2 -1.21  -1.11   -1.28  -1.09   -1.43 </span></span>
<span><span class="co">##  3     1     3 -1.21  -1.83   -1.35  -1.11   -1.28 </span></span>
<span><span class="co">##  4     1     4 -1.21  -1.62   -1.20  -1.83   -1.35 </span></span>
<span><span class="co">##  5     1     5 -1.21  -1.62   -0.981 -1.62   -1.20 </span></span>
<span><span class="co">##  6     2     1  0.277 -0.0714 -0.739 NA      NA    </span></span>
<span><span class="co">##  7     2     2  0.277  1.09    0.116 -0.0714 -0.739</span></span>
<span><span class="co">##  8     2     3  0.277  1.43    0.562  1.09    0.116</span></span>
<span><span class="co">##  9     2     4  0.277  0.584  -0.606  1.43    0.562</span></span>
<span><span class="co">## 10     2     5  0.277 -0.881   0.603  0.584  -0.606</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="multiple-period-marginal-structural-models" class="level3"><h3 class="anchored" data-anchor-id="multiple-period-marginal-structural-models">Multiple-period marginal structural models</h3>
<p>Cool cool cool. We have multi-period data where variables depend on their lagged values and other interdependent columns. Let’s build some MSMs!</p>
<p>We’re going to build weights two different ways here. Because the data has a time-series cross-sectional structure (with multiple individuals across multiple years), the weight models need to account for that structure. Everywhere I’ve seen elsewhere uses generalized estimating equations (GEEs) for these models (and that’s what the <strong>ipw</strong> package uses behind the scenes), but I’m a fan of multilevel models, so I’ll make weights with both to compare their results.</p>
<p>We’ll use the same equation as before—the cumulative product of the ratio of two probability distributions:</p>
<p><span class="math display">\[
w = \prod^t_{t = 1} \frac{\phi(T_{it} | T_{i, t-1}, C_i)}{\phi(T_{it} | T_{i, t-1}, D_{i, t-1}, C_i)}
\]</span></p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Again, ipw complains about missing values, so get rid of them (i.e. all year 1)</span></span>
<span><span class="va">df_panel_sans_na</span> <span class="op">&lt;-</span> <span class="va">df_panel</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">t_lag</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Manually</span></span>
<span><span class="co"># Numerator is lagged treatment + non-varying confounders</span></span>
<span><span class="co"># ipw uses GEE models to account for panel structure, so use them here too</span></span>
<span><span class="va">model_num_gee</span> <span class="op">&lt;-</span> <span class="fu">geeglm</span><span class="op">(</span><span class="va">t</span> <span class="op">~</span> <span class="va">t_lag</span> <span class="op">+</span> <span class="va">c</span>, </span>
<span>                        id <span class="op">=</span> <span class="va">id</span>, waves <span class="op">=</span> <span class="va">y</span>, corstr <span class="op">=</span> <span class="st">"ar1"</span>,</span>
<span>                        data <span class="op">=</span> <span class="va">df_panel_sans_na</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># But we can also use mixed models with lmer</span></span>
<span><span class="va">model_num_multi</span> <span class="op">&lt;-</span> <span class="fu">lmer</span><span class="op">(</span><span class="va">t</span> <span class="op">~</span> <span class="va">t_lag</span> <span class="op">+</span> <span class="va">c</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">id</span><span class="op">)</span>,</span>
<span>                        data <span class="op">=</span> <span class="va">df_panel_sans_na</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Denominator is lagged treatment, lagged outcome, time-varying confounders +</span></span>
<span><span class="co"># non-varying confounders</span></span>
<span><span class="va">model_denom_gee</span> <span class="op">&lt;-</span> <span class="fu">geeglm</span><span class="op">(</span><span class="va">t</span> <span class="op">~</span> <span class="va">t_lag</span> <span class="op">+</span> <span class="va">d_lag</span> <span class="op">+</span> <span class="va">c</span>, </span>
<span>                          id <span class="op">=</span> <span class="va">id</span>, waves <span class="op">=</span> <span class="va">y</span>, corstr <span class="op">=</span> <span class="st">"ar1"</span>,</span>
<span>                          data <span class="op">=</span> <span class="va">df_panel_sans_na</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_denom_multi</span> <span class="op">&lt;-</span> <span class="fu">lmer</span><span class="op">(</span><span class="va">t</span> <span class="op">~</span> <span class="va">t_lag</span> <span class="op">+</span> <span class="va">d_lag</span> <span class="op">+</span> <span class="va">c</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">id</span><span class="op">)</span>,</span>
<span>                          data <span class="op">=</span> <span class="va">df_panel_sans_na</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Probability distributions</span></span>
<span><span class="va">num_gee</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">df_panel_sans_na</span><span class="op">$</span><span class="va">t</span>,</span>
<span>             <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">model_num_gee</span><span class="op">)</span>,</span>
<span>             <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span><span class="op">(</span><span class="va">model_num_gee</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">den_gee</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">df_panel_sans_na</span><span class="op">$</span><span class="va">t</span>,</span>
<span>                 <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">model_denom_gee</span><span class="op">)</span>,</span>
<span>                 <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span><span class="op">(</span><span class="va">model_denom_gee</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">num_multi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">df_panel_sans_na</span><span class="op">$</span><span class="va">t</span>,</span>
<span>                   <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">model_num_multi</span><span class="op">)</span>,</span>
<span>                   <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span><span class="op">(</span><span class="va">model_num_multi</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">den_multi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">df_panel_sans_na</span><span class="op">$</span><span class="va">t</span>,</span>
<span>                   <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">model_denom_multi</span><span class="op">)</span>,</span>
<span>                   <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span><span class="op">(</span><span class="va">model_denom_multi</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df_panel_weights_manual</span> <span class="op">&lt;-</span> <span class="va">df_panel_sans_na</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>weights_no_time_gee <span class="op">=</span> <span class="va">num_gee</span> <span class="op">/</span> <span class="va">den_gee</span>,</span>
<span>         weights_no_time_multi <span class="op">=</span> <span class="va">num_multi</span> <span class="op">/</span> <span class="va">den_multi</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>ipw_gee <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumprod</a></span><span class="op">(</span><span class="va">weights_no_time_gee</span><span class="op">)</span>,</span>
<span>         ipw_multi <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumprod</a></span><span class="op">(</span><span class="va">weights_no_time_multi</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Automatically with ipwtm()</span></span>
<span><span class="va">panel_weights_auto</span> <span class="op">&lt;-</span> <span class="fu">ipwtm</span><span class="op">(</span></span>
<span>  exposure <span class="op">=</span> <span class="va">t</span>,</span>
<span>  family <span class="op">=</span> <span class="st">"gaussian"</span>, </span>
<span>  numerator <span class="op">=</span> <span class="op">~</span> <span class="va">t_lag</span> <span class="op">+</span> <span class="va">c</span>, </span>
<span>  denominator <span class="op">=</span> <span class="op">~</span> <span class="va">t_lag</span> <span class="op">+</span> <span class="va">d_lag</span> <span class="op">+</span> <span class="va">c</span>, </span>
<span>  id <span class="op">=</span> <span class="va">id</span>,</span>
<span>  timevar <span class="op">=</span> <span class="va">y</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"all"</span>,</span>
<span>  corstr <span class="op">=</span> <span class="st">"ar1"</span>,</span>
<span>  data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">df_panel_sans_na</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df_panel_weights_auto</span> <span class="op">&lt;-</span> <span class="va">df_panel_sans_na</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>ipw <span class="op">=</span> <span class="va">panel_weights_auto</span><span class="op">$</span><span class="va">ipw.weights</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can build the outcome models, using both GEE and multilevel models.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">m_manual_gee</span> <span class="op">&lt;-</span> <span class="fu">geeglm</span><span class="op">(</span><span class="va">d</span> <span class="op">~</span> <span class="va">t</span> <span class="op">+</span> <span class="va">t_lag</span>, </span>
<span>                       data <span class="op">=</span> <span class="va">df_panel_weights_manual</span>,</span>
<span>                       id <span class="op">=</span> <span class="va">id</span>, waves <span class="op">=</span> <span class="va">y</span>, </span>
<span>                       weights <span class="op">=</span> <span class="va">ipw_gee</span><span class="op">)</span></span>
<span></span>
<span><span class="va">m_auto_gee</span> <span class="op">&lt;-</span> <span class="fu">geeglm</span><span class="op">(</span><span class="va">d</span> <span class="op">~</span> <span class="va">t</span> <span class="op">+</span> <span class="va">t_lag</span>, </span>
<span>                     data <span class="op">=</span> <span class="va">df_panel_weights_auto</span>, </span>
<span>                     id <span class="op">=</span> <span class="va">id</span>, waves <span class="op">=</span> <span class="va">y</span>, </span>
<span>                     weights <span class="op">=</span> <span class="va">ipw</span><span class="op">)</span></span>
<span></span>
<span><span class="va">m_lmer_manual_gee_wt</span> <span class="op">&lt;-</span> <span class="fu">lmer</span><span class="op">(</span><span class="va">d</span> <span class="op">~</span> <span class="va">t</span> <span class="op">+</span> <span class="va">t_lag</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">id</span><span class="op">)</span>, </span>
<span>                             data <span class="op">=</span> <span class="va">df_panel_weights_manual</span>, </span>
<span>                             weights <span class="op">=</span> <span class="va">ipw_gee</span><span class="op">)</span></span>
<span></span>
<span><span class="va">m_lmer_auto_gee_wt</span> <span class="op">&lt;-</span> <span class="fu">lmer</span><span class="op">(</span><span class="va">d</span> <span class="op">~</span> <span class="va">t</span> <span class="op">+</span> <span class="va">t_lag</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">id</span><span class="op">)</span>, </span>
<span>                           data <span class="op">=</span> <span class="va">df_panel_weights_auto</span>, </span>
<span>                           weights <span class="op">=</span> <span class="va">ipw</span><span class="op">)</span></span>
<span></span>
<span><span class="va">m_lmer_manual_multi_wt</span> <span class="op">&lt;-</span> <span class="fu">lmer</span><span class="op">(</span><span class="va">d</span> <span class="op">~</span> <span class="va">t</span> <span class="op">+</span> <span class="va">t_lag</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">id</span><span class="op">)</span>, </span>
<span>                               data <span class="op">=</span> <span class="va">df_panel_weights_manual</span>, </span>
<span>                               weights <span class="op">=</span> <span class="va">ipw_multi</span><span class="op">)</span></span>
<span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu">tribble</span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">`Method`</span>, <span class="op">~</span><span class="va">`Weights`</span>, <span class="op">~</span><span class="va">`lag(T) effect`</span>, <span class="op">~</span><span class="va">`T effect`</span>,</span>
<span>  <span class="st">"True effect"</span>, <span class="cn">NA</span>, <span class="fl">0.160</span>, <span class="fl">0.400</span>,</span>
<span>  <span class="st">"Panel with GEE"</span>, <span class="st">"Manual GEE weights"</span>, <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu">tidy</span><span class="op">(</span><span class="va">m_manual_gee</span><span class="op">)</span>, <span class="va">term</span> <span class="op">==</span> <span class="st">"t_lag"</span><span class="op">)</span><span class="op">$</span><span class="va">estimate</span>, <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu">tidy</span><span class="op">(</span><span class="va">m_manual_gee</span><span class="op">)</span>, <span class="va">term</span> <span class="op">==</span> <span class="st">"t"</span><span class="op">)</span><span class="op">$</span><span class="va">estimate</span>,</span>
<span>  <span class="st">"Panel with GEE"</span>, <span class="st">"Automatic GEE weights"</span>, <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu">tidy</span><span class="op">(</span><span class="va">m_auto_gee</span><span class="op">)</span>, <span class="va">term</span> <span class="op">==</span> <span class="st">"t_lag"</span><span class="op">)</span><span class="op">$</span><span class="va">estimate</span>, <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu">tidy</span><span class="op">(</span><span class="va">m_auto_gee</span><span class="op">)</span>, <span class="va">term</span> <span class="op">==</span> <span class="st">"t"</span><span class="op">)</span><span class="op">$</span><span class="va">estimate</span>,</span>
<span>  <span class="st">"Panel with multilevel model"</span>, <span class="st">"Manual GEE weights"</span>, <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu">tidy</span><span class="op">(</span><span class="va">m_lmer_manual_gee_wt</span><span class="op">)</span>, <span class="va">term</span> <span class="op">==</span> <span class="st">"t_lag"</span><span class="op">)</span><span class="op">$</span><span class="va">estimate</span>, <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu">tidy</span><span class="op">(</span><span class="va">m_lmer_manual_gee_wt</span><span class="op">)</span>, <span class="va">term</span> <span class="op">==</span> <span class="st">"t"</span><span class="op">)</span><span class="op">$</span><span class="va">estimate</span>,</span>
<span>  <span class="st">"Panel with multilevel model"</span>, <span class="st">"Automatic GEE weights"</span>, <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu">tidy</span><span class="op">(</span><span class="va">m_lmer_auto_gee_wt</span><span class="op">)</span>, <span class="va">term</span> <span class="op">==</span> <span class="st">"t_lag"</span><span class="op">)</span><span class="op">$</span><span class="va">estimate</span>, <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu">tidy</span><span class="op">(</span><span class="va">m_lmer_auto_gee_wt</span><span class="op">)</span>, <span class="va">term</span> <span class="op">==</span> <span class="st">"t"</span><span class="op">)</span><span class="op">$</span><span class="va">estimate</span>,</span>
<span>  <span class="st">"Panel with multilevel model"</span>, <span class="st">"Manual multilevel weights"</span>, <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu">tidy</span><span class="op">(</span><span class="va">m_lmer_manual_multi_wt</span><span class="op">)</span>, <span class="va">term</span> <span class="op">==</span> <span class="st">"t_lag"</span><span class="op">)</span><span class="op">$</span><span class="va">estimate</span>, <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu">tidy</span><span class="op">(</span><span class="va">m_lmer_manual_multi_wt</span><span class="op">)</span>, <span class="va">term</span> <span class="op">==</span> <span class="st">"t"</span><span class="op">)</span><span class="op">$</span><span class="va">estimate</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<table class="table table-sm caption-top table-striped small" data-quarto-postprocess="true">
<thead><tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Method</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Weights</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">lag(T) effect</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">T effect</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">True effect</td>
<td style="text-align: left;">—</td>
<td style="text-align: right;">0.160</td>
<td style="text-align: right;">0.400</td>
</tr>
<tr class="even">
<td style="text-align: left;">Panel with GEE</td>
<td style="text-align: left;">Manual GEE weights</td>
<td style="text-align: right;">0.230</td>
<td style="text-align: right;">0.429</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Panel with GEE</td>
<td style="text-align: left;">Automatic GEE weights</td>
<td style="text-align: right;">0.230</td>
<td style="text-align: right;">0.429</td>
</tr>
<tr class="even">
<td style="text-align: left;">Panel with multilevel model</td>
<td style="text-align: left;">Manual GEE weights</td>
<td style="text-align: right;">0.195</td>
<td style="text-align: right;">0.408</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Panel with multilevel model</td>
<td style="text-align: left;">Automatic GEE weights</td>
<td style="text-align: right;">0.195</td>
<td style="text-align: right;">0.408</td>
</tr>
<tr class="even">
<td style="text-align: left;">Panel with multilevel model</td>
<td style="text-align: left;">Manual multilevel weights</td>
<td style="text-align: right;">0.196</td>
<td style="text-align: right;">0.414</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Phew.</p>
<p>All of the models here are relatively close to the true effect for <span class="math inline">\(T_t\)</span>! (Though they’re all sizably off for <span class="math inline">\(T_{t-1}\)</span>, but I don’t know why).</p>
<p>Importantly, it seems that mixed models work just fine for both weights and outcome models, which means there’s probably no need to use GEE (and this can all be done Bayesianly with <code>brms()</code>!).</p>
<p>It works!</p>
</section></section><section id="questions-for-the-future" class="level2"><h2 class="anchored" data-anchor-id="questions-for-the-future">Questions for the future</h2>
<p>I still have some lingering things to check (forthcoming in a future blog post):</p>
<ul>
<li><p><code>y</code> isn’t any any of the models: weights numerator, weights denominator, or outcome. If I include it in any of the models, the there’s perfect fit. That may be because there are no time-varying confounders? I think year might need to be in there somewhere, but I’m not sure. <span class="citation" data-cites="BlackwellGlynn:2018">Blackwell and Glynn (<a href="#ref-BlackwellGlynn:2018" role="doc-biblioref">2018</a>)</span> include year in the numerator and denominator for weights in their Swank Steinmo replication, but not in their Burgoon replication.</p></li>
<li><p>This example has no time-varying confounders. I need to see how this all works with those.</p></li>
<li><p>This DAG for this example is pretty simple. I need to see what happens when there are <em>also</em> direct arrows from <span class="math inline">\(T_{t-1} \rightarrow T_{t}\)</span> and <span class="math inline">\(D_{t-1} \rightarrow D_{t}\)</span>.</p></li>
</ul></section><section id="references" class="level2">


<!-- -->


</section><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-BlackwellGlynn:2018" class="csl-entry" role="listitem">
Blackwell, Matthew, and Adam N. Glynn. 2018. <span>“How to Make Causal Inferences with Time-Series Cross-Sectional Data Under Selection on Observables.”</span> <em>American Political Science Review</em> 112 (4): 1067–82. <a href="https://doi.org/10.1017/s0003055418000357">https://doi.org/10.1017/s0003055418000357</a>.
</div>
<div id="ref-ThoemmesOng:2016" class="csl-entry" role="listitem">
Thoemmes, Felix, and Anthony D. Ong. 2016. <span>“A Primer on Inverse Probability of Treatment Weighting and Marginal Structural Models.”</span> <em>Emerging Adulthood</em> 4 (1): 40–59. <a href="https://doi.org/10.1177/2167696815621645">https://doi.org/10.1177/2167696815621645</a>.
</div>
</div></section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{heiss2021,
  author = {Heiss, Andrew},
  title = {Marginal Structural Models for Panel Data with {GEE} and
    Multilevel Models},
  date = {2021-01-15},
  url = {https://www.andrewheiss.com/blog/2021/01/15/msm-gee-multilevel/},
  doi = {10.59350/yqs5b-36r77},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-heiss2021" class="csl-entry quarto-appendix-citeas" role="listitem">
Heiss, Andrew. 2021. <span>“Marginal Structural Models for Panel Data
with GEE and Multilevel Models.”</span> January 15, 2021. <a href="https://doi.org/10.59350/yqs5b-36r77">https://doi.org/10.59350/yqs5b-36r77</a>.
</div></div></section></div></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/www\.andrewheiss\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><script src="https://giscus.app/client.js" data-repo="andrewheiss/ath-quarto" data-repo-id="R_kgDOIg6EJQ" data-category="Blog comments" data-category-id="DIC_kwDOIg6EJc4CSz92" data-mapping="pathname" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script><input type="hidden" id="giscus-base-theme" value="light"><input type="hidden" id="giscus-alt-theme" value="dark"><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb15" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Marginal structural models for panel data with GEE and multilevel models"</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> 2021-01-15</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="an">description:</span><span class="co"> "Use R to correctly close backdoor confounding in panel data with marginal structural models and inverse probability weights with both GEE and multilevel models"</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="an">image:</span><span class="co"> index_files/figure-html/depression-dag-1.png</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span><span class="co"> </span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co">  - r</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co">  - tidyverse</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="co">  - causal inference</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="co">  - DAGs</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="co">  - do calculus</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="co">  - inverse probability weighting</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="an">doi:</span><span class="co"> 10.59350/yqs5b-36r77</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="an">citation:</span><span class="co"> true</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, include=FALSE}</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::opts_chunk$set(fig.width = 6, fig.asp = 0.618, fig.align = "center", </span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a><span class="in">                      fig.retina = 3, out.width = "75%", collapse = TRUE)</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a><span class="in">options(digits = 3, width = 90, knitr.kable.NA = "—")</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a><span class="in">options(dplyr.summarise.inform = FALSE)</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>Since my last two blog posts on <span class="co">[</span><span class="ot">binary and continuous inverse probability weights (IPWs)</span><span class="co">](https://www.andrewheiss.com/blog/2020/12/01/ipw-binary-continuous/)</span> and <span class="co">[</span><span class="ot">marginal structural models (MSMs) for time-series cross-sectional (TSCS) panel data</span><span class="co">](https://www.andrewheiss.com/blog/2020/12/03/ipw-tscs-msm/)</span>, I've spent a ton of time trying to figure out why I couldn't recover the exact causal effect I had built in to those examples when using panel data. It was a mystery, and it took weeks to figure out what was happening. </span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>After poring through all sorts of articles on MSMs and TSCS data like @ThoemmesOng:2016 and @BlackwellGlynn:2018, along with all sorts of articles on the differences between <span class="co">[</span><span class="ot">generalized estimating equations (GEEs)</span><span class="co">](https://en.wikipedia.org/wiki/Generalized_estimating_equation)</span>, which the epidemiology world (and everyone who does MSMs) seems to love, and multilevel models (which I find a lot more intuitive, and which can be done Bayesianly with **brms**), I *finally* figured out what was wrong and how to calculate correct IPWs for panel data.</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>The main issue lies in the synthetic data I had created for those earlier blog posts. <span class="co">[</span><span class="ot">There, I used the **fabricatr** package to create a country-year panel</span><span class="co">](https://www.andrewheiss.com/blog/2020/12/03/ipw-tscs-msm/#simulated-time-series-cross-sectional-data)</span>, which seemed correct and great. However, it didn't exactly match the data-generating process in situations where the value in one time period (like $X_t$) depends on the value from the previous time period (or $X_{t-1}$), or autocorrelation. As such, I couldn't quite get the correct causal effects out (since the data didn't show interdepdency across time). </span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>After lots of struggle, though, I finally figured out a way to explicitly build this autocorrelation in. And thanks to this delightfully accessible article by @ThoemmesOng:2016 (<span class="co">[</span><span class="ot">ungated free version here</span><span class="co">](https://anthonyongphd.files.wordpress.com/2016/02/emerging-adulthood-2016-thoemmes-40-59.pdf)</span>), I found clear code for MSMs that I could expand to test on more complex panel data. </span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>In this post, I'll do a few things: (1) recreate the two-time-period example from Thoemmes and Ong's appendix (which is stuck in a PDF and really hard to copy/paste out), (2) redo their two-period example with a tidier approach, and (3) expand their two-period approach to multiple years and replace GEEs with multilevel models.</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>Here we go!</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a><span class="in">```{r load-packages, warning=FALSE, message=FALSE}</span></span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidyverse)</span></span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a><span class="in">library(broom)</span></span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggdag)</span></span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a><span class="in">library(dagitty)</span></span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a><span class="in">library(ipw)  # For automatically calculating IPWs</span></span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a><span class="in">library(geepack)  # For GEE models</span></span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a><span class="in">library(lme4)  # For mixed/multilevel models</span></span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a><span class="in">library(broom.mixed)</span></span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a><span class="in">library(kableExtra)</span></span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a><span class="fu">## Synthetic data overview</span></span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a>In their paper, Thoemmes and Ong create simulated data based on this DAG, with a time-varying treatment, a non-time-varying confounder, and a time-varying outcome (depression):</span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a><span class="in">```{r depression-dag, fig.height=2.5, fig.asp=NULL}</span></span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a><span class="in"># I generally prefer the easier-to-read formula syntax in dagify() (i.e. D1 ~ T1</span></span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a><span class="in"># + C, etc.), but it doesn't work with subscripted numbers like T[1], so we have</span></span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a><span class="in"># to use this dagitty syntax instead</span></span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a><span class="in">depression_dag &lt;- dagitty('dag {</span></span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a><span class="in">"C" [pos="2.5,2"]</span></span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a><span class="in">"T[1]" [pos="1,1"]</span></span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a><span class="in">"D[1]" [pos="2,1"]</span></span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a><span class="in">"T[2]" [pos="3,1"]</span></span>
<span id="cb15-63"><a href="#cb15-63" aria-hidden="true" tabindex="-1"></a><span class="in">"D[2]" [pos="4,1"]</span></span>
<span id="cb15-64"><a href="#cb15-64" aria-hidden="true" tabindex="-1"></a><span class="in">"C" -&gt; "D[1]"</span></span>
<span id="cb15-65"><a href="#cb15-65" aria-hidden="true" tabindex="-1"></a><span class="in">"C" -&gt; "D[2]"</span></span>
<span id="cb15-66"><a href="#cb15-66" aria-hidden="true" tabindex="-1"></a><span class="in">"C" -&gt; "T[1]"</span></span>
<span id="cb15-67"><a href="#cb15-67" aria-hidden="true" tabindex="-1"></a><span class="in">"C" -&gt; "T[2]"</span></span>
<span id="cb15-68"><a href="#cb15-68" aria-hidden="true" tabindex="-1"></a><span class="in">"D[1]" -&gt; "T[2]"</span></span>
<span id="cb15-69"><a href="#cb15-69" aria-hidden="true" tabindex="-1"></a><span class="in">"T[1]" -&gt; "D[1]"</span></span>
<span id="cb15-70"><a href="#cb15-70" aria-hidden="true" tabindex="-1"></a><span class="in">"T[2]" -&gt; "D[2]"</span></span>
<span id="cb15-71"><a href="#cb15-71" aria-hidden="true" tabindex="-1"></a><span class="in">}') %&gt;% </span></span>
<span id="cb15-72"><a href="#cb15-72" aria-hidden="true" tabindex="-1"></a><span class="in">  tidy_dagitty()</span></span>
<span id="cb15-73"><a href="#cb15-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-74"><a href="#cb15-74" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(depression_dag, aes(x = x, y = y, xend = xend, yend = yend)) +</span></span>
<span id="cb15-75"><a href="#cb15-75" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_dag_edges() +</span></span>
<span id="cb15-76"><a href="#cb15-76" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_dag_point(color = "grey80", size = 12) +</span></span>
<span id="cb15-77"><a href="#cb15-77" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_dag_text(color = "black", size = 5, parse = TRUE) +</span></span>
<span id="cb15-78"><a href="#cb15-78" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_dag()</span></span>
<span id="cb15-79"><a href="#cb15-79" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-80"><a href="#cb15-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-81"><a href="#cb15-81" aria-hidden="true" tabindex="-1"></a>Essentially earlier treatment ($T_1$) causes some level of depression ($D_1$), which causes later treatment ($T_2$), which causes later depression ($D_2$). This whole chain is influenced by some non-varying confounder ($C$).</span>
<span id="cb15-82"><a href="#cb15-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-83"><a href="#cb15-83" aria-hidden="true" tabindex="-1"></a><span class="fu">## Original two-period Thoemmes and Ong results</span></span>
<span id="cb15-84"><a href="#cb15-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-85"><a href="#cb15-85" aria-hidden="true" tabindex="-1"></a>Here's the original code from the appendix of @ThoemmesOng:2016 for data with a time-varying continuous treatment and a confounder. It explicitly creates columns for <span class="in">`t1`</span>, <span class="in">`d1`</span>, <span class="in">`t2`</span>, and <span class="in">`d2`</span>, so it is easy to mathematically make it so that <span class="in">`t2`</span> is caused by <span class="in">`d1`</span>.</span>
<span id="cb15-86"><a href="#cb15-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-87"><a href="#cb15-87" aria-hidden="true" tabindex="-1"></a>Because it's only two time periods, they calculate the inverse probability weights in two formulas and then multiply them together:</span>
<span id="cb15-88"><a href="#cb15-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-89"><a href="#cb15-89" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Weights for the first time period:</span>
<span id="cb15-90"><a href="#cb15-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-91"><a href="#cb15-91" aria-hidden="true" tabindex="-1"></a>    $$</span>
<span id="cb15-92"><a href="#cb15-92" aria-hidden="true" tabindex="-1"></a>    w_1 = \frac{\phi(T_{i1})}{\phi(T_{i1}\ |\ C)}</span>
<span id="cb15-93"><a href="#cb15-93" aria-hidden="true" tabindex="-1"></a>    $$</span>
<span id="cb15-94"><a href="#cb15-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-95"><a href="#cb15-95" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Weights for the second time period:</span>
<span id="cb15-96"><a href="#cb15-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-97"><a href="#cb15-97" aria-hidden="true" tabindex="-1"></a>    $$</span>
<span id="cb15-98"><a href="#cb15-98" aria-hidden="true" tabindex="-1"></a>    w_2 = \frac{\phi(T_{i2}\ |\ T_{i1})}{\phi(T_{i2}\ |\ C, T_{i1}, D_{i1})}</span>
<span id="cb15-99"><a href="#cb15-99" aria-hidden="true" tabindex="-1"></a>    $$</span>
<span id="cb15-100"><a href="#cb15-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-101"><a href="#cb15-101" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Final weights:</span>
<span id="cb15-102"><a href="#cb15-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-103"><a href="#cb15-103" aria-hidden="true" tabindex="-1"></a>    $$</span>
<span id="cb15-104"><a href="#cb15-104" aria-hidden="true" tabindex="-1"></a>    w = w_1 \cdot w_2</span>
<span id="cb15-105"><a href="#cb15-105" aria-hidden="true" tabindex="-1"></a>    $$</span>
<span id="cb15-106"><a href="#cb15-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-107"><a href="#cb15-107" aria-hidden="true" tabindex="-1"></a>Here's their code:</span>
<span id="cb15-108"><a href="#cb15-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-109"><a href="#cb15-109" aria-hidden="true" tabindex="-1"></a><span class="in">```{r original-code}</span></span>
<span id="cb15-110"><a href="#cb15-110" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb15-111"><a href="#cb15-111" aria-hidden="true" tabindex="-1"></a><span class="in">##################################################################### </span></span>
<span id="cb15-112"><a href="#cb15-112" aria-hidden="true" tabindex="-1"></a><span class="in"># iptw demo with time-varying continuous treatment and confounder</span></span>
<span id="cb15-113"><a href="#cb15-113" aria-hidden="true" tabindex="-1"></a><span class="in">#####################################################################</span></span>
<span id="cb15-114"><a href="#cb15-114" aria-hidden="true" tabindex="-1"></a><span class="in"># Felix Thoemmes, October, 2015 </span></span>
<span id="cb15-115"><a href="#cb15-115" aria-hidden="true" tabindex="-1"></a><span class="in">#####################################################################</span></span>
<span id="cb15-116"><a href="#cb15-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-117"><a href="#cb15-117" aria-hidden="true" tabindex="-1"></a><span class="in">#set seed to replicate results</span></span>
<span id="cb15-118"><a href="#cb15-118" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(12345)</span></span>
<span id="cb15-119"><a href="#cb15-119" aria-hidden="true" tabindex="-1"></a><span class="in">#define sample size</span></span>
<span id="cb15-120"><a href="#cb15-120" aria-hidden="true" tabindex="-1"></a><span class="in">n &lt;- 2000</span></span>
<span id="cb15-121"><a href="#cb15-121" aria-hidden="true" tabindex="-1"></a><span class="in">#define confounder c</span></span>
<span id="cb15-122"><a href="#cb15-122" aria-hidden="true" tabindex="-1"></a><span class="in">c &lt;- rnorm(n,0,1)</span></span>
<span id="cb15-123"><a href="#cb15-123" aria-hidden="true" tabindex="-1"></a><span class="in">#define treatment at time 1 as function of confounder</span></span>
<span id="cb15-124"><a href="#cb15-124" aria-hidden="true" tabindex="-1"></a><span class="in">t1 &lt;- .1*c + rnorm(n,0, sqrt(.99))</span></span>
<span id="cb15-125"><a href="#cb15-125" aria-hidden="true" tabindex="-1"></a><span class="in">#define depression at time 1 as function of confounder and treat1</span></span>
<span id="cb15-126"><a href="#cb15-126" aria-hidden="true" tabindex="-1"></a><span class="in">d1 &lt;- .1*c + .4*t1 + rnorm(n,0, sqrt(.822))</span></span>
<span id="cb15-127"><a href="#cb15-127" aria-hidden="true" tabindex="-1"></a><span class="in">#define treatment at time 2 as function of confounder and dep1</span></span>
<span id="cb15-128"><a href="#cb15-128" aria-hidden="true" tabindex="-1"></a><span class="in">t2 &lt;- .1*c + .4*d1 + .4*t1 + rnorm(n,0, sqrt(.5196))</span></span>
<span id="cb15-129"><a href="#cb15-129" aria-hidden="true" tabindex="-1"></a><span class="in">#define outcome depression at time 2 as function of confounder, treat1, and dep1 </span></span>
<span id="cb15-130"><a href="#cb15-130" aria-hidden="true" tabindex="-1"></a><span class="in">d2 &lt;- .1*c + .4*t2 + .4*d1 + rnorm(n,0, sqrt(.4582))</span></span>
<span id="cb15-131"><a href="#cb15-131" aria-hidden="true" tabindex="-1"></a><span class="in">#add ID variable to do mixed effects models later</span></span>
<span id="cb15-132"><a href="#cb15-132" aria-hidden="true" tabindex="-1"></a><span class="in">id &lt;- rep(1:length(c))</span></span>
<span id="cb15-133"><a href="#cb15-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-134"><a href="#cb15-134" aria-hidden="true" tabindex="-1"></a><span class="in">df1 &lt;- data.frame(id, c, t1, d1, t2, d2)</span></span>
<span id="cb15-135"><a href="#cb15-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-136"><a href="#cb15-136" aria-hidden="true" tabindex="-1"></a><span class="in">#compute the weights for timepoint 1</span></span>
<span id="cb15-137"><a href="#cb15-137" aria-hidden="true" tabindex="-1"></a><span class="in">#this is a continuous treatment</span></span>
<span id="cb15-138"><a href="#cb15-138" aria-hidden="true" tabindex="-1"></a><span class="in">#therefore we use densities of normal distributions</span></span>
<span id="cb15-139"><a href="#cb15-139" aria-hidden="true" tabindex="-1"></a><span class="in">#weights at time 1</span></span>
<span id="cb15-140"><a href="#cb15-140" aria-hidden="true" tabindex="-1"></a><span class="in">w1 &lt;- dnorm(df1$t1, predict(lm(t1 ~ 1)), sd(lm(t1 ~ 1)$residuals)) / </span></span>
<span id="cb15-141"><a href="#cb15-141" aria-hidden="true" tabindex="-1"></a><span class="in">  dnorm(df1$t1, predict(lm(t1 ~ c)), sd(lm(t1 ~ c)$residuals))</span></span>
<span id="cb15-142"><a href="#cb15-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-143"><a href="#cb15-143" aria-hidden="true" tabindex="-1"></a><span class="in">#weights at time 2</span></span>
<span id="cb15-144"><a href="#cb15-144" aria-hidden="true" tabindex="-1"></a><span class="in">w2 &lt;- dnorm(df1$t2, predict(lm(t2 ~ t1)), sd(lm(t2 ~ t1)$residuals)) / </span></span>
<span id="cb15-145"><a href="#cb15-145" aria-hidden="true" tabindex="-1"></a><span class="in">  dnorm(df1$t2, predict(lm(t2 ~ c + d1 + t1)), sd(lm(t2 ~ c + d1 + t1)$residuals)) </span></span>
<span id="cb15-146"><a href="#cb15-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-147"><a href="#cb15-147" aria-hidden="true" tabindex="-1"></a><span class="in">#total weights are a product of all time-varying weights</span></span>
<span id="cb15-148"><a href="#cb15-148" aria-hidden="true" tabindex="-1"></a><span class="in">w &lt;- w1*w2</span></span>
<span id="cb15-149"><a href="#cb15-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-150"><a href="#cb15-150" aria-hidden="true" tabindex="-1"></a><span class="in">#truncate weights at 5%</span></span>
<span id="cb15-151"><a href="#cb15-151" aria-hidden="true" tabindex="-1"></a><span class="in">tw1 &lt;- ifelse(w &lt; quantile(w, probs = .05), quantile(w, probs = 0.05), w)</span></span>
<span id="cb15-152"><a href="#cb15-152" aria-hidden="true" tabindex="-1"></a><span class="in">tw1 &lt;- ifelse(w &gt; quantile(w, probs = .95), quantile(w, probs = 0.95), tw1)</span></span>
<span id="cb15-153"><a href="#cb15-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-154"><a href="#cb15-154" aria-hidden="true" tabindex="-1"></a><span class="in">#truncate weights at 1%</span></span>
<span id="cb15-155"><a href="#cb15-155" aria-hidden="true" tabindex="-1"></a><span class="in">tw2 &lt;- ifelse(w &lt; quantile(w, probs = .01), quantile(w, probs = 0.01), w)</span></span>
<span id="cb15-156"><a href="#cb15-156" aria-hidden="true" tabindex="-1"></a><span class="in">tw2 &lt;- ifelse(w &gt; quantile(w, probs = .99), quantile(w, probs = 0.99), tw2)</span></span>
<span id="cb15-157"><a href="#cb15-157" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-158"><a href="#cb15-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-159"><a href="#cb15-159" aria-hidden="true" tabindex="-1"></a>They they run a bunch of different outcome models with <span class="in">`geeglm()`</span>:</span>
<span id="cb15-160"><a href="#cb15-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-161"><a href="#cb15-161" aria-hidden="true" tabindex="-1"></a><span class="in">```{r original-models}</span></span>
<span id="cb15-162"><a href="#cb15-162" aria-hidden="true" tabindex="-1"></a><span class="in">only_t1 &lt;- geeglm(d2 ~ t1, data = df1, id = rownames(df1))</span></span>
<span id="cb15-163"><a href="#cb15-163" aria-hidden="true" tabindex="-1"></a><span class="in">only_t2 &lt;- geeglm(d2 ~ t2, data = df1, id = rownames(df1))</span></span>
<span id="cb15-164"><a href="#cb15-164" aria-hidden="true" tabindex="-1"></a><span class="in">both_t &lt;- geeglm(d2 ~ t1 + t2, data = df1, id = rownames(df1))</span></span>
<span id="cb15-165"><a href="#cb15-165" aria-hidden="true" tabindex="-1"></a><span class="in">both_t_c &lt;- geeglm(d2 ~ t1 + t2 + c + d1, data = df1, id = rownames(df1))</span></span>
<span id="cb15-166"><a href="#cb15-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-167"><a href="#cb15-167" aria-hidden="true" tabindex="-1"></a><span class="in">stab_ipw &lt;- geeglm(d2 ~ t1 + t2, data = df1, id = rownames(df1), weights = w)</span></span>
<span id="cb15-168"><a href="#cb15-168" aria-hidden="true" tabindex="-1"></a><span class="in">stab_ipw_1p &lt;- geeglm(d2 ~ t1 + t2, data = df1, id = rownames(df1), weights = tw2)</span></span>
<span id="cb15-169"><a href="#cb15-169" aria-hidden="true" tabindex="-1"></a><span class="in">stab_ipw_5p &lt;- geeglm(d2 ~ t1 + t2, data = df1, id = rownames(df1), weights = tw1)</span></span>
<span id="cb15-170"><a href="#cb15-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-171"><a href="#cb15-171" aria-hidden="true" tabindex="-1"></a><span class="in">results &lt;- tribble(</span></span>
<span id="cb15-172"><a href="#cb15-172" aria-hidden="true" tabindex="-1"></a><span class="in">  ~`Method`, ~`T&lt;sub&gt;1&lt;/sub&gt; effect`, ~`T&lt;sub&gt;2&lt;/sub&gt; effect`,</span></span>
<span id="cb15-173"><a href="#cb15-173" aria-hidden="true" tabindex="-1"></a><span class="in">  "True effect", 0.160, 0.400,</span></span>
<span id="cb15-174"><a href="#cb15-174" aria-hidden="true" tabindex="-1"></a><span class="in">  "Naive, only T1", filter(tidy(only_t1), term == "t1")$estimate, NA,</span></span>
<span id="cb15-175"><a href="#cb15-175" aria-hidden="true" tabindex="-1"></a><span class="in">  "Naive, only T2", NA, filter(tidy(only_t2), term == "t2")$estimate,</span></span>
<span id="cb15-176"><a href="#cb15-176" aria-hidden="true" tabindex="-1"></a><span class="in">  "Naive, both", filter(tidy(both_t), term == "t1")$estimate, filter(tidy(both_t), term == "t2")$estimate,</span></span>
<span id="cb15-177"><a href="#cb15-177" aria-hidden="true" tabindex="-1"></a><span class="in">  "Naive, both + controls", filter(tidy(both_t_c), term == "t1")$estimate, filter(tidy(both_t_c), term == "t2")$estimate,</span></span>
<span id="cb15-178"><a href="#cb15-178" aria-hidden="true" tabindex="-1"></a><span class="in">  "IPW", filter(tidy(stab_ipw), term == "t1")$estimate, filter(tidy(stab_ipw), term == "t2")$estimate,</span></span>
<span id="cb15-179"><a href="#cb15-179" aria-hidden="true" tabindex="-1"></a><span class="in">  "IPW, 1% truncated", filter(tidy(stab_ipw_1p), term == "t1")$estimate, filter(tidy(stab_ipw_1p), term == "t2")$estimate,</span></span>
<span id="cb15-180"><a href="#cb15-180" aria-hidden="true" tabindex="-1"></a><span class="in">  "IPW, 5% truncated", filter(tidy(stab_ipw_5p), term == "t1")$estimate, filter(tidy(stab_ipw_5p), term == "t2")$estimate</span></span>
<span id="cb15-181"><a href="#cb15-181" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb15-182"><a href="#cb15-182" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-183"><a href="#cb15-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-184"><a href="#cb15-184" aria-hidden="true" tabindex="-1"></a><span class="in">```{r original-results-table, echo=FALSE}</span></span>
<span id="cb15-185"><a href="#cb15-185" aria-hidden="true" tabindex="-1"></a><span class="in">kbl(results, digits = 3, format = "html", table.attr = "style='width:70%;'", escape = FALSE) %&gt;% </span></span>
<span id="cb15-186"><a href="#cb15-186" aria-hidden="true" tabindex="-1"></a><span class="in">  kable_styling(htmltable_class = "table table-sm")</span></span>
<span id="cb15-187"><a href="#cb15-187" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-188"><a href="#cb15-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-189"><a href="#cb15-189" aria-hidden="true" tabindex="-1"></a>And here's all that compared to what they have in the paper:</span>
<span id="cb15-190"><a href="#cb15-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-191"><a href="#cb15-191" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=FALSE, out.width="70%", fig.align="center"}</span></span>
<span id="cb15-192"><a href="#cb15-192" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::include_graphics("ThoemmesOng-Table2.png")</span></span>
<span id="cb15-193"><a href="#cb15-193" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-194"><a href="#cb15-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-195"><a href="#cb15-195" aria-hidden="true" tabindex="-1"></a>It's identical! I'm chalking any tiny differences up to the fact that <span class="in">`set.seed()`</span> changed with R 4.0 and they used R 3.x in their paper. (Also the T2-only model is wrong, but that's probably a typo—the "estimated scale parameter" from that model is 0.574 with an sd of 0.018, which lines up perfectly with the coefficient in the published table, so I think maybe the published paper has the wrong number in the table.)</span>
<span id="cb15-196"><a href="#cb15-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-197"><a href="#cb15-197" aria-hidden="true" tabindex="-1"></a>Also, there seems to be another typo in that table. The true effect of T1 in the table is 0.140, but in the text of the paper, it says the effect should be 0.160, which makes sense—that's the product of 0.4 × 0.4, or each of the treatment coefficients ($0.4 \times 0.4 = 0.16$).</span>
<span id="cb15-198"><a href="#cb15-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-199"><a href="#cb15-199" aria-hidden="true" tabindex="-1"></a>Regardless of those super tiny insignificant typos, we did it! We have their exact results using marginal structural models and inverse probability weights.</span>
<span id="cb15-200"><a href="#cb15-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-201"><a href="#cb15-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-202"><a href="#cb15-202" aria-hidden="true" tabindex="-1"></a><span class="fu">## Tidier two-period results</span></span>
<span id="cb15-203"><a href="#cb15-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-204"><a href="#cb15-204" aria-hidden="true" tabindex="-1"></a>The code to generate that data isn't very tidyverse-friendly and it creates a ton of intermediate vectors. Here's a cleaner version with **dplyr**:</span>
<span id="cb15-205"><a href="#cb15-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-206"><a href="#cb15-206" aria-hidden="true" tabindex="-1"></a><span class="in">```{r original-dplyr}</span></span>
<span id="cb15-207"><a href="#cb15-207" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(12345)</span></span>
<span id="cb15-208"><a href="#cb15-208" aria-hidden="true" tabindex="-1"></a><span class="in">n &lt;- 2000</span></span>
<span id="cb15-209"><a href="#cb15-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-210"><a href="#cb15-210" aria-hidden="true" tabindex="-1"></a><span class="in">df_nice &lt;- tibble(id = 1:n,</span></span>
<span id="cb15-211"><a href="#cb15-211" aria-hidden="true" tabindex="-1"></a><span class="in">                  c = rnorm(n, 0, 1)) %&gt;% </span></span>
<span id="cb15-212"><a href="#cb15-212" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(t1 = (0.1 * c) + rnorm(n, 0, sqrt(0.99)),</span></span>
<span id="cb15-213"><a href="#cb15-213" aria-hidden="true" tabindex="-1"></a><span class="in">         d1 = (0.1 * c) + (0.4 * t1) + rnorm(n, 0, sqrt(0.822)),</span></span>
<span id="cb15-214"><a href="#cb15-214" aria-hidden="true" tabindex="-1"></a><span class="in">         t2 = (0.1 * c) + (0.4 * d1) + (0.4 * t1) + rnorm(n, 0, sqrt(0.5196)),</span></span>
<span id="cb15-215"><a href="#cb15-215" aria-hidden="true" tabindex="-1"></a><span class="in">         d2 = (0.1 * c) + (0.4 * t2) + (0.4 * d1) + rnorm(n, 0, sqrt(0.4582)))</span></span>
<span id="cb15-216"><a href="#cb15-216" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-217"><a href="#cb15-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-218"><a href="#cb15-218" aria-hidden="true" tabindex="-1"></a>Also, this original data is wide, with explicit columns for each time period. Let's make it tidy and pretend the time periods are years (<span class="in">`y`</span>) and add some lagged columns:</span>
<span id="cb15-219"><a href="#cb15-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-220"><a href="#cb15-220" aria-hidden="true" tabindex="-1"></a><span class="in">```{r original-tidy}</span></span>
<span id="cb15-221"><a href="#cb15-221" aria-hidden="true" tabindex="-1"></a><span class="in">df_tidy &lt;- df_nice %&gt;% </span></span>
<span id="cb15-222"><a href="#cb15-222" aria-hidden="true" tabindex="-1"></a><span class="in">  pivot_longer(cols = c(t1, d1, t2, d2)) %&gt;% </span></span>
<span id="cb15-223"><a href="#cb15-223" aria-hidden="true" tabindex="-1"></a><span class="in">  separate(name, into = c("variable", "y"), sep = 1) %&gt;% </span></span>
<span id="cb15-224"><a href="#cb15-224" aria-hidden="true" tabindex="-1"></a><span class="in">  pivot_wider(names_from = "variable", values_from = "value") %&gt;% </span></span>
<span id="cb15-225"><a href="#cb15-225" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(id) %&gt;% </span></span>
<span id="cb15-226"><a href="#cb15-226" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(across(c(t, d), list(lag = lag))) %&gt;% </span></span>
<span id="cb15-227"><a href="#cb15-227" aria-hidden="true" tabindex="-1"></a><span class="in">  ungroup()</span></span>
<span id="cb15-228"><a href="#cb15-228" aria-hidden="true" tabindex="-1"></a><span class="in">head(df_tidy)</span></span>
<span id="cb15-229"><a href="#cb15-229" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-230"><a href="#cb15-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-231"><a href="#cb15-231" aria-hidden="true" tabindex="-1"></a>This is how panel data is typically structured, with rows repeated for each time period. This is good because we can figure out how to structure the weight models and outcome model in a way that uses this structure and compare it to the original <span class="in">`t1`</span>, <span class="in">`d1`</span>, etc. models. </span>
<span id="cb15-232"><a href="#cb15-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-233"><a href="#cb15-233" aria-hidden="true" tabindex="-1"></a>Because there are only two time periods, the lagged columns here are missing a ton of data (since you can't see what the value is for year 0), but it'll still work.</span>
<span id="cb15-234"><a href="#cb15-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-235"><a href="#cb15-235" aria-hidden="true" tabindex="-1"></a>With the data like this, we can find the weights. We'll do it both manually and with the **ipw** package.</span>
<span id="cb15-236"><a href="#cb15-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-237"><a href="#cb15-237" aria-hidden="true" tabindex="-1"></a>Manually, we need to fit two models (a numerator and denominator) and then take the cumulative product of their probability distributions:</span>
<span id="cb15-238"><a href="#cb15-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-239"><a href="#cb15-239" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb15-240"><a href="#cb15-240" aria-hidden="true" tabindex="-1"></a>w = \prod^t_{t = 1} \frac{\phi(T_{it} | T_{i, t-1}, C_i)}{\phi(T_{it} | T_{i, t-1}, D_{i, t-1}, C_i)}</span>
<span id="cb15-241"><a href="#cb15-241" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb15-242"><a href="#cb15-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-243"><a href="#cb15-243" aria-hidden="true" tabindex="-1"></a>Here we go!</span>
<span id="cb15-244"><a href="#cb15-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-245"><a href="#cb15-245" aria-hidden="true" tabindex="-1"></a><span class="in">```{r find-tidy-weights}</span></span>
<span id="cb15-246"><a href="#cb15-246" aria-hidden="true" tabindex="-1"></a><span class="in"># Remove NAs since ipwpoint() will complain</span></span>
<span id="cb15-247"><a href="#cb15-247" aria-hidden="true" tabindex="-1"></a><span class="in">df_tidy_sans_na &lt;- df_tidy %&gt;%</span></span>
<span id="cb15-248"><a href="#cb15-248" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(!is.na(t_lag))</span></span>
<span id="cb15-249"><a href="#cb15-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-250"><a href="#cb15-250" aria-hidden="true" tabindex="-1"></a><span class="in"># Manually</span></span>
<span id="cb15-251"><a href="#cb15-251" aria-hidden="true" tabindex="-1"></a><span class="in"># Numerator is lagged treatment + non-varying confounders</span></span>
<span id="cb15-252"><a href="#cb15-252" aria-hidden="true" tabindex="-1"></a><span class="in">model_num &lt;- lm(t ~ t_lag + c,</span></span>
<span id="cb15-253"><a href="#cb15-253" aria-hidden="true" tabindex="-1"></a><span class="in">                data = df_tidy_sans_na)</span></span>
<span id="cb15-254"><a href="#cb15-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-255"><a href="#cb15-255" aria-hidden="true" tabindex="-1"></a><span class="in"># Denominator is lagged treatment, lagged outcome, time-varying confounders +</span></span>
<span id="cb15-256"><a href="#cb15-256" aria-hidden="true" tabindex="-1"></a><span class="in"># non-varying confounders</span></span>
<span id="cb15-257"><a href="#cb15-257" aria-hidden="true" tabindex="-1"></a><span class="in">model_denom &lt;- lm(t ~ t_lag + d_lag + c, </span></span>
<span id="cb15-258"><a href="#cb15-258" aria-hidden="true" tabindex="-1"></a><span class="in">                  data = df_tidy_sans_na)</span></span>
<span id="cb15-259"><a href="#cb15-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-260"><a href="#cb15-260" aria-hidden="true" tabindex="-1"></a><span class="in"># Probability distributions</span></span>
<span id="cb15-261"><a href="#cb15-261" aria-hidden="true" tabindex="-1"></a><span class="in">num &lt;- dnorm(df_tidy_sans_na$t,</span></span>
<span id="cb15-262"><a href="#cb15-262" aria-hidden="true" tabindex="-1"></a><span class="in">             predict(model_num),</span></span>
<span id="cb15-263"><a href="#cb15-263" aria-hidden="true" tabindex="-1"></a><span class="in">             sd(residuals(model_num)))</span></span>
<span id="cb15-264"><a href="#cb15-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-265"><a href="#cb15-265" aria-hidden="true" tabindex="-1"></a><span class="in">den &lt;- dnorm(df_tidy_sans_na$t,</span></span>
<span id="cb15-266"><a href="#cb15-266" aria-hidden="true" tabindex="-1"></a><span class="in">             predict(model_denom),</span></span>
<span id="cb15-267"><a href="#cb15-267" aria-hidden="true" tabindex="-1"></a><span class="in">             sd(residuals(model_denom)))</span></span>
<span id="cb15-268"><a href="#cb15-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-269"><a href="#cb15-269" aria-hidden="true" tabindex="-1"></a><span class="in"># Make num/den fraction and find cumulative product within each id</span></span>
<span id="cb15-270"><a href="#cb15-270" aria-hidden="true" tabindex="-1"></a><span class="in">df_weights_manual &lt;- df_tidy_sans_na %&gt;% </span></span>
<span id="cb15-271"><a href="#cb15-271" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(weights_no_time = num / den) %&gt;% </span></span>
<span id="cb15-272"><a href="#cb15-272" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(id) %&gt;% </span></span>
<span id="cb15-273"><a href="#cb15-273" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(ipw = cumprod(weights_no_time)) %&gt;% </span></span>
<span id="cb15-274"><a href="#cb15-274" aria-hidden="true" tabindex="-1"></a><span class="in">  ungroup()</span></span>
<span id="cb15-275"><a href="#cb15-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-276"><a href="#cb15-276" aria-hidden="true" tabindex="-1"></a><span class="in"># Automatically find weights with ipw::ipwpoint()</span></span>
<span id="cb15-277"><a href="#cb15-277" aria-hidden="true" tabindex="-1"></a><span class="in">tidy_weights_auto &lt;- ipwpoint(</span></span>
<span id="cb15-278"><a href="#cb15-278" aria-hidden="true" tabindex="-1"></a><span class="in">  exposure = t,</span></span>
<span id="cb15-279"><a href="#cb15-279" aria-hidden="true" tabindex="-1"></a><span class="in">  family = "gaussian", </span></span>
<span id="cb15-280"><a href="#cb15-280" aria-hidden="true" tabindex="-1"></a><span class="in">  numerator = ~ t_lag + c, </span></span>
<span id="cb15-281"><a href="#cb15-281" aria-hidden="true" tabindex="-1"></a><span class="in">  denominator = ~ t_lag + d_lag + c, </span></span>
<span id="cb15-282"><a href="#cb15-282" aria-hidden="true" tabindex="-1"></a><span class="in">  data = as.data.frame(df_tidy_sans_na))</span></span>
<span id="cb15-283"><a href="#cb15-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-284"><a href="#cb15-284" aria-hidden="true" tabindex="-1"></a><span class="in">df_weights_auto &lt;- df_tidy_sans_na %&gt;% </span></span>
<span id="cb15-285"><a href="#cb15-285" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(ipw = tidy_weights_auto$ipw.weights)</span></span>
<span id="cb15-286"><a href="#cb15-286" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-287"><a href="#cb15-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-288"><a href="#cb15-288" aria-hidden="true" tabindex="-1"></a>Now we can use these new weights in the outcome model:</span>
<span id="cb15-289"><a href="#cb15-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-290"><a href="#cb15-290" aria-hidden="true" tabindex="-1"></a><span class="in">```{r tidier-models}</span></span>
<span id="cb15-291"><a href="#cb15-291" aria-hidden="true" tabindex="-1"></a><span class="in">model_lags_manual &lt;- geeglm(d ~ t + t_lag, data = df_weights_manual,</span></span>
<span id="cb15-292"><a href="#cb15-292" aria-hidden="true" tabindex="-1"></a><span class="in">                            id = id, weights = ipw)</span></span>
<span id="cb15-293"><a href="#cb15-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-294"><a href="#cb15-294" aria-hidden="true" tabindex="-1"></a><span class="in">model_lags_auto &lt;- geeglm(d ~ t + t_lag, data = df_weights_auto, </span></span>
<span id="cb15-295"><a href="#cb15-295" aria-hidden="true" tabindex="-1"></a><span class="in">                          id = id, weights = ipw)</span></span>
<span id="cb15-296"><a href="#cb15-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-297"><a href="#cb15-297" aria-hidden="true" tabindex="-1"></a><span class="in">results &lt;- tribble(</span></span>
<span id="cb15-298"><a href="#cb15-298" aria-hidden="true" tabindex="-1"></a><span class="in">  ~`Method`, ~`T&lt;sub&gt;1&lt;/sub&gt; effect`, ~`T&lt;sub&gt;2&lt;/sub&gt; effect`,</span></span>
<span id="cb15-299"><a href="#cb15-299" aria-hidden="true" tabindex="-1"></a><span class="in">  "True effect", 0.160, 0.400,</span></span>
<span id="cb15-300"><a href="#cb15-300" aria-hidden="true" tabindex="-1"></a><span class="in">  "IPW, original", filter(tidy(stab_ipw), term == "t1")$estimate, filter(tidy(stab_ipw), term == "t2")$estimate,</span></span>
<span id="cb15-301"><a href="#cb15-301" aria-hidden="true" tabindex="-1"></a><span class="in">  "IPW, lagged, manual", filter(tidy(model_lags_manual), term == "t_lag")$estimate, filter(tidy(model_lags_manual), term == "t")$estimate,</span></span>
<span id="cb15-302"><a href="#cb15-302" aria-hidden="true" tabindex="-1"></a><span class="in">  "IPW, lagged, automatic", filter(tidy(model_lags_auto), term == "t_lag")$estimate, filter(tidy(model_lags_auto), term == "t")$estimate</span></span>
<span id="cb15-303"><a href="#cb15-303" aria-hidden="true" tabindex="-1"></a><span class="in">) %&gt;% </span></span>
<span id="cb15-304"><a href="#cb15-304" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(across(2:3, ~sprintf("%.3f", round(., 3)))) %&gt;% </span></span>
<span id="cb15-305"><a href="#cb15-305" aria-hidden="true" tabindex="-1"></a><span class="in">  add_row(`T&lt;sub&gt;1&lt;/sub&gt; effect` = "&lt;b&gt;lag(T) effect&lt;/b&gt;", </span></span>
<span id="cb15-306"><a href="#cb15-306" aria-hidden="true" tabindex="-1"></a><span class="in">          `T&lt;sub&gt;2&lt;/sub&gt; effect` = "&lt;b&gt;T effect&lt;/b&gt;", </span></span>
<span id="cb15-307"><a href="#cb15-307" aria-hidden="true" tabindex="-1"></a><span class="in">          .after = 2)</span></span>
<span id="cb15-308"><a href="#cb15-308" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-309"><a href="#cb15-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-310"><a href="#cb15-310" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-tidier-results, echo=FALSE}</span></span>
<span id="cb15-311"><a href="#cb15-311" aria-hidden="true" tabindex="-1"></a><span class="in">kbl(results, format = "html", table.attr = "style='width:70%;'", escape = FALSE) %&gt;% </span></span>
<span id="cb15-312"><a href="#cb15-312" aria-hidden="true" tabindex="-1"></a><span class="in">  kable_styling(htmltable_class = "table table-sm")</span></span>
<span id="cb15-313"><a href="#cb15-313" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-314"><a href="#cb15-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-315"><a href="#cb15-315" aria-hidden="true" tabindex="-1"></a>Those results aren't identical (I don't know why!), but they're close-ish, so whatever. It worked! Instead of using explicit <span class="in">`t1`</span>, <span class="in">`d1`</span>, etc. columns, we can do the same marginal structural model with just <span class="in">`t`</span> and <span class="in">`d`</span> in a long data frame.</span>
<span id="cb15-316"><a href="#cb15-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-317"><a href="#cb15-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-318"><a href="#cb15-318" aria-hidden="true" tabindex="-1"></a><span class="fu">## Expansion to multiple-period data</span></span>
<span id="cb15-319"><a href="#cb15-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-320"><a href="#cb15-320" aria-hidden="true" tabindex="-1"></a>Since that's all working, now we can do something a little/lot trickier—instead of manually specifying $T_1$ and $T_2$, which isn't really easily scalable to more time periods, we'll construct the data more generally for any number of years</span>
<span id="cb15-321"><a href="#cb15-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-322"><a href="#cb15-322" aria-hidden="true" tabindex="-1"></a><span class="fu">### Tricky interdependent data generating process</span></span>
<span id="cb15-323"><a href="#cb15-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-324"><a href="#cb15-324" aria-hidden="true" tabindex="-1"></a>The trick here is that we want to have any number of time periods, but also maintain the same DAG relationships. In the small data, these are the two general relationships:</span>
<span id="cb15-325"><a href="#cb15-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-326"><a href="#cb15-326" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\text{treatment}_t = (0.1 \cdot \text{confounder}) + (0.4 \cdot \text{depression}_{t-1}) + (0.4 \cdot \text{treatment}_{t-1}) + \text{noise}$</span>
<span id="cb15-327"><a href="#cb15-327" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\text{depression}_t = (0.1 \cdot \text{confounder}) + (0.4 \cdot \text{treatment}_{t}) + (0.4 \cdot \text{depression}_{t-1}) + \text{noise}$</span>
<span id="cb15-328"><a href="#cb15-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-329"><a href="#cb15-329" aria-hidden="true" tabindex="-1"></a>Or in code:</span>
<span id="cb15-330"><a href="#cb15-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-331"><a href="#cb15-331" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`t = (0.1 * c) + (0.4 * lag(d)) + (0.4 * lag(t)) + rnorm(n, 0, sqrt(0.5196))`</span></span>
<span id="cb15-332"><a href="#cb15-332" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`d = (0.1 * c) + (0.4 * t) + (0.4 * lag(d)) + rnorm(n, 0, sqrt(0.4582))`</span></span>
<span id="cb15-333"><a href="#cb15-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-334"><a href="#cb15-334" aria-hidden="true" tabindex="-1"></a>Generating this data in a tidy **dplyr** way is super tricky, since the `t` and `d` columns are interdependent—the data has to be generated rowwise, but we also have to be able to look back a row to get the lagged values of `t` and `d`. I've seen people like @BlackwellGlynn:2018 get around this by using a `for` loop to build the data, but I have an aversion to for loops in R [since **purrr** exists](https://r4ds.had.co.nz/iteration.html#for-loops-vs.-functionals), so I spent way too much time trying to figure out a **purrr**-based way to do this. Others have tried this (like <span class="co">[</span><span class="ot">this RStudio Community post</span><span class="co">](https://community.rstudio.com/t/row-wise-iteration-in-a-dataframe-with-interdependent-variables/38778)</span>), and I <span class="co">[</span><span class="ot">asked about it on Twitter</span><span class="co">](https://twitter.com/andrewheiss/status/1347780639714664448)</span>, where I got a few cool solutions using <span class="in">`purrr::accumulate()`</span> and <span class="in">`purrr::reduce()`</span>, like <span class="co">[</span><span class="ot">this fancy `accumutate()` function from Ian Moran</span><span class="co">](https://twitter.com/ianmoran011/status/1347849678696574977)</span> and <span class="co">[</span><span class="ot">these solutions from Miles McBain</span><span class="co">](https://gist.github.com/andrewheiss/89ae26a7a4682aff0ee9b7db1e92c326#gistcomment-3587810)</span>. </span>
<span id="cb15-335"><a href="#cb15-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-336"><a href="#cb15-336" aria-hidden="true" tabindex="-1"></a>There are no loops involved in those solutions, but phew that accumulate/reduce syntax is wonky and I can't fully wrap my head around it (plus it makes it hard to carry over non-accumulated variables). So I resorted to a loop. Oooof.</span>
<span id="cb15-337"><a href="#cb15-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-338"><a href="#cb15-338" aria-hidden="true" tabindex="-1"></a>It works, though! Let's test it on just one ID. We'll generate just one row with <span class="in">`t1`</span>, <span class="in">`t2`</span>, <span class="in">`d1`</span>, and <span class="in">`d2`</span>, and we'll remove the noise from each of the columns:</span>
<span id="cb15-339"><a href="#cb15-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-342"><a href="#cb15-342" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb15-343"><a href="#cb15-343" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb15-344"><a href="#cb15-344" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb15-345"><a href="#cb15-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-346"><a href="#cb15-346" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove all noise so that we can compare this with the function version</span></span>
<span id="cb15-347"><a href="#cb15-347" aria-hidden="true" tabindex="-1"></a>df_example <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span>n,</span>
<span id="cb15-348"><a href="#cb15-348" aria-hidden="true" tabindex="-1"></a>                     <span class="at">c =</span> <span class="fu">rnorm</span>(n, <span class="dv">0</span>, <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb15-349"><a href="#cb15-349" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">t1 =</span> (<span class="fl">0.1</span> <span class="sc">*</span> c),</span>
<span id="cb15-350"><a href="#cb15-350" aria-hidden="true" tabindex="-1"></a>         <span class="at">d1 =</span> (<span class="fl">0.1</span> <span class="sc">*</span> c) <span class="sc">+</span> (<span class="fl">0.4</span> <span class="sc">*</span> t1),</span>
<span id="cb15-351"><a href="#cb15-351" aria-hidden="true" tabindex="-1"></a>         <span class="at">t2 =</span> (<span class="fl">0.1</span> <span class="sc">*</span> c) <span class="sc">+</span> (<span class="fl">0.4</span> <span class="sc">*</span> d1) <span class="sc">+</span> (<span class="fl">0.4</span> <span class="sc">*</span> t1),</span>
<span id="cb15-352"><a href="#cb15-352" aria-hidden="true" tabindex="-1"></a>         <span class="at">d2 =</span> (<span class="fl">0.1</span> <span class="sc">*</span> c) <span class="sc">+</span> (<span class="fl">0.4</span> <span class="sc">*</span> t2) <span class="sc">+</span> (<span class="fl">0.4</span> <span class="sc">*</span> d1))</span>
<span id="cb15-353"><a href="#cb15-353" aria-hidden="true" tabindex="-1"></a>df_example</span>
<span id="cb15-354"><a href="#cb15-354" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-355"><a href="#cb15-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-356"><a href="#cb15-356" aria-hidden="true" tabindex="-1"></a>This isn't tidy data, so technically there are two years here. We'll keep <span class="in">`t1`</span> and <span class="in">`d1`</span> as the initial values for year 1, then generate values for 5 years. If we do this right, the <span class="in">`t`</span> and <span class="in">`d`</span> values for year 2 should be identical to <span class="in">`t2`</span> and <span class="in">`d2`</span> here.</span>
<span id="cb15-357"><a href="#cb15-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-358"><a href="#cb15-358" aria-hidden="true" tabindex="-1"></a><span class="in">```{r example-loop}</span></span>
<span id="cb15-359"><a href="#cb15-359" aria-hidden="true" tabindex="-1"></a><span class="in"># Add a bunch of extra years with empty cells for t and d</span></span>
<span id="cb15-360"><a href="#cb15-360" aria-hidden="true" tabindex="-1"></a><span class="in">df_multiple_years_empty &lt;- df_example %&gt;% </span></span>
<span id="cb15-361"><a href="#cb15-361" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(y = 1) %&gt;% </span></span>
<span id="cb15-362"><a href="#cb15-362" aria-hidden="true" tabindex="-1"></a><span class="in">  select(id, y, t = t1, d = d1, c) %&gt;% </span></span>
<span id="cb15-363"><a href="#cb15-363" aria-hidden="true" tabindex="-1"></a><span class="in">  add_row(y = 2:5) %&gt;% </span></span>
<span id="cb15-364"><a href="#cb15-364" aria-hidden="true" tabindex="-1"></a><span class="in">  # c doesn't vary across time</span></span>
<span id="cb15-365"><a href="#cb15-365" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(id = 1, </span></span>
<span id="cb15-366"><a href="#cb15-366" aria-hidden="true" tabindex="-1"></a><span class="in">         c = df_example$c[1])</span></span>
<span id="cb15-367"><a href="#cb15-367" aria-hidden="true" tabindex="-1"></a><span class="in">df_multiple_years_empty</span></span>
<span id="cb15-368"><a href="#cb15-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-369"><a href="#cb15-369" aria-hidden="true" tabindex="-1"></a><span class="in"># Now we need to build the interdependent values for t and d with &lt;gasp&gt; a loop</span></span>
<span id="cb15-370"><a href="#cb15-370" aria-hidden="true" tabindex="-1"></a><span class="in">#</span></span>
<span id="cb15-371"><a href="#cb15-371" aria-hidden="true" tabindex="-1"></a><span class="in"># The loop is inside this function---it skips the initial row and then</span></span>
<span id="cb15-372"><a href="#cb15-372" aria-hidden="true" tabindex="-1"></a><span class="in"># iteratively adds new rows. We can't use neat things like lag(t), so instead</span></span>
<span id="cb15-373"><a href="#cb15-373" aria-hidden="true" tabindex="-1"></a><span class="in"># we use df$t[i - 1]</span></span>
<span id="cb15-374"><a href="#cb15-374" aria-hidden="true" tabindex="-1"></a><span class="in"># </span></span>
<span id="cb15-375"><a href="#cb15-375" aria-hidden="true" tabindex="-1"></a><span class="in"># We omit the extra noise for now</span></span>
<span id="cb15-376"><a href="#cb15-376" aria-hidden="true" tabindex="-1"></a><span class="in">dgp &lt;- function(df) {</span></span>
<span id="cb15-377"><a href="#cb15-377" aria-hidden="true" tabindex="-1"></a><span class="in">  for (i in 2:nrow(df)) {</span></span>
<span id="cb15-378"><a href="#cb15-378" aria-hidden="true" tabindex="-1"></a><span class="in">    df$t[i] &lt;- (0.1 * df$c[i]) + (0.4 * df$d[i - 1]) + (0.4 * df$t[i - 1])</span></span>
<span id="cb15-379"><a href="#cb15-379" aria-hidden="true" tabindex="-1"></a><span class="in">    df$d[i] &lt;- (0.1 * df$c[i]) + (0.4 * df$t[i]) + (0.4 * df$d[i - 1])</span></span>
<span id="cb15-380"><a href="#cb15-380" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb15-381"><a href="#cb15-381" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb15-382"><a href="#cb15-382" aria-hidden="true" tabindex="-1"></a><span class="in">  df</span></span>
<span id="cb15-383"><a href="#cb15-383" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb15-384"><a href="#cb15-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-385"><a href="#cb15-385" aria-hidden="true" tabindex="-1"></a><span class="in"># Generate all 5 years</span></span>
<span id="cb15-386"><a href="#cb15-386" aria-hidden="true" tabindex="-1"></a><span class="in">df_multiple_years_empty %&gt;% </span></span>
<span id="cb15-387"><a href="#cb15-387" aria-hidden="true" tabindex="-1"></a><span class="in">  dgp()</span></span>
<span id="cb15-388"><a href="#cb15-388" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-389"><a href="#cb15-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-390"><a href="#cb15-390" aria-hidden="true" tabindex="-1"></a>If this worked, the <span class="in">`t`</span> and <span class="in">`d`</span> values for year 2 should be the same as <span class="in">`t2`</span> and <span class="in">`d2`</span> here:</span>
<span id="cb15-391"><a href="#cb15-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-392"><a href="#cb15-392" aria-hidden="true" tabindex="-1"></a><span class="in">```{r check-example-loop}</span></span>
<span id="cb15-393"><a href="#cb15-393" aria-hidden="true" tabindex="-1"></a><span class="in">df_example</span></span>
<span id="cb15-394"><a href="#cb15-394" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-395"><a href="#cb15-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-396"><a href="#cb15-396" aria-hidden="true" tabindex="-1"></a>They are!</span>
<span id="cb15-397"><a href="#cb15-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-398"><a href="#cb15-398" aria-hidden="true" tabindex="-1"></a>Since we know it works, let's generate a big dataset for playing with multi-year MSMs, this time with noise:</span>
<span id="cb15-399"><a href="#cb15-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-400"><a href="#cb15-400" aria-hidden="true" tabindex="-1"></a><span class="in">```{r big-msm-data}</span></span>
<span id="cb15-401"><a href="#cb15-401" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(1234)</span></span>
<span id="cb15-402"><a href="#cb15-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-403"><a href="#cb15-403" aria-hidden="true" tabindex="-1"></a><span class="in"># Make data for the first year</span></span>
<span id="cb15-404"><a href="#cb15-404" aria-hidden="true" tabindex="-1"></a><span class="in">df_first_year &lt;- expand_grid(id = 1:2000, y = 1) %&gt;% </span></span>
<span id="cb15-405"><a href="#cb15-405" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(c = rnorm(n(), 0, 1),</span></span>
<span id="cb15-406"><a href="#cb15-406" aria-hidden="true" tabindex="-1"></a><span class="in">         t = (0.1 * c) + rnorm(n(), 0, sqrt(0.99)),</span></span>
<span id="cb15-407"><a href="#cb15-407" aria-hidden="true" tabindex="-1"></a><span class="in">         d = (0.1 * c) + (0.4 * t) + rnorm(n(), 0, sqrt(0.822)))</span></span>
<span id="cb15-408"><a href="#cb15-408" aria-hidden="true" tabindex="-1"></a><span class="in">df_first_year</span></span>
<span id="cb15-409"><a href="#cb15-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-410"><a href="#cb15-410" aria-hidden="true" tabindex="-1"></a><span class="in"># Add empty years 2-5</span></span>
<span id="cb15-411"><a href="#cb15-411" aria-hidden="true" tabindex="-1"></a><span class="in">df_panel_empty &lt;- df_first_year %&gt;% </span></span>
<span id="cb15-412"><a href="#cb15-412" aria-hidden="true" tabindex="-1"></a><span class="in">  bind_rows(expand_grid(id = 1:2000, y = 2:5)) %&gt;% </span></span>
<span id="cb15-413"><a href="#cb15-413" aria-hidden="true" tabindex="-1"></a><span class="in">  arrange(id, y)</span></span>
<span id="cb15-414"><a href="#cb15-414" aria-hidden="true" tabindex="-1"></a><span class="in">head(df_panel_empty, 10)</span></span>
<span id="cb15-415"><a href="#cb15-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-416"><a href="#cb15-416" aria-hidden="true" tabindex="-1"></a><span class="in"># Add noise to the fancy dgp() function</span></span>
<span id="cb15-417"><a href="#cb15-417" aria-hidden="true" tabindex="-1"></a><span class="in">dgp &lt;- function(df) {</span></span>
<span id="cb15-418"><a href="#cb15-418" aria-hidden="true" tabindex="-1"></a><span class="in">  for (i in 2:nrow(df)) {</span></span>
<span id="cb15-419"><a href="#cb15-419" aria-hidden="true" tabindex="-1"></a><span class="in">    df$t[i] &lt;- (0.1 * df$c[i]) + (0.4 * df$d[i - 1]) + (0.4 * df$t[i - 1]) + rnorm(1, 0, sqrt(0.5196))</span></span>
<span id="cb15-420"><a href="#cb15-420" aria-hidden="true" tabindex="-1"></a><span class="in">    df$d[i] &lt;- (0.1 * df$c[i]) + (0.4 * df$t[i]) + (0.4 * df$d[i - 1]) + rnorm(1, 0, sqrt(0.4582))</span></span>
<span id="cb15-421"><a href="#cb15-421" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb15-422"><a href="#cb15-422" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb15-423"><a href="#cb15-423" aria-hidden="true" tabindex="-1"></a><span class="in">  df</span></span>
<span id="cb15-424"><a href="#cb15-424" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb15-425"><a href="#cb15-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-426"><a href="#cb15-426" aria-hidden="true" tabindex="-1"></a><span class="in"># Run dgp() within each id</span></span>
<span id="cb15-427"><a href="#cb15-427" aria-hidden="true" tabindex="-1"></a><span class="in">df_panel &lt;- df_panel_empty %&gt;% </span></span>
<span id="cb15-428"><a href="#cb15-428" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(id) %&gt;% </span></span>
<span id="cb15-429"><a href="#cb15-429" aria-hidden="true" tabindex="-1"></a><span class="in">  # This doesn't vary with time, so repeat it across all the years</span></span>
<span id="cb15-430"><a href="#cb15-430" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(c = c[1]) %&gt;% </span></span>
<span id="cb15-431"><a href="#cb15-431" aria-hidden="true" tabindex="-1"></a><span class="in">  # Nest the data into a single cell in each row</span></span>
<span id="cb15-432"><a href="#cb15-432" aria-hidden="true" tabindex="-1"></a><span class="in">  nest() %&gt;% </span></span>
<span id="cb15-433"><a href="#cb15-433" aria-hidden="true" tabindex="-1"></a><span class="in">  # Run dgp() on the nested cell (in a column named "data")</span></span>
<span id="cb15-434"><a href="#cb15-434" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(dgp = map(data, dgp)) %&gt;% </span></span>
<span id="cb15-435"><a href="#cb15-435" aria-hidden="true" tabindex="-1"></a><span class="in">  select(-data) %&gt;% </span></span>
<span id="cb15-436"><a href="#cb15-436" aria-hidden="true" tabindex="-1"></a><span class="in">  # Unnest the nested dgp()-ed cells</span></span>
<span id="cb15-437"><a href="#cb15-437" aria-hidden="true" tabindex="-1"></a><span class="in">  unnest(dgp) %&gt;% </span></span>
<span id="cb15-438"><a href="#cb15-438" aria-hidden="true" tabindex="-1"></a><span class="in">  # Add some lags</span></span>
<span id="cb15-439"><a href="#cb15-439" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(across(c(t, d), list(lag = lag))) %&gt;% </span></span>
<span id="cb15-440"><a href="#cb15-440" aria-hidden="true" tabindex="-1"></a><span class="in">  ungroup()</span></span>
<span id="cb15-441"><a href="#cb15-441" aria-hidden="true" tabindex="-1"></a><span class="in">head(df_panel, 10)</span></span>
<span id="cb15-442"><a href="#cb15-442" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-443"><a href="#cb15-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-444"><a href="#cb15-444" aria-hidden="true" tabindex="-1"></a><span class="fu">### Multiple-period marginal structural models</span></span>
<span id="cb15-445"><a href="#cb15-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-446"><a href="#cb15-446" aria-hidden="true" tabindex="-1"></a>Cool cool cool. We have multi-period data where variables depend on their lagged values and other interdependent columns. Let's build some MSMs!</span>
<span id="cb15-447"><a href="#cb15-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-448"><a href="#cb15-448" aria-hidden="true" tabindex="-1"></a>We're going to build weights two different ways here. Because the data has a time-series cross-sectional structure (with multiple individuals across multiple years), the weight models need to account for that structure. Everywhere I've seen elsewhere uses generalized estimating equations (GEEs) for these models (and that's what the **ipw** package uses behind the scenes), but I'm a fan of multilevel models, so I'll make weights with both to compare their results.</span>
<span id="cb15-449"><a href="#cb15-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-450"><a href="#cb15-450" aria-hidden="true" tabindex="-1"></a>We'll use the same equation as before—the cumulative product of the ratio of two probability distributions:</span>
<span id="cb15-451"><a href="#cb15-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-452"><a href="#cb15-452" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb15-453"><a href="#cb15-453" aria-hidden="true" tabindex="-1"></a>w = \prod^t_{t = 1} \frac{\phi(T_{it} | T_{i, t-1}, C_i)}{\phi(T_{it} | T_{i, t-1}, D_{i, t-1}, C_i)}</span>
<span id="cb15-454"><a href="#cb15-454" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb15-455"><a href="#cb15-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-456"><a href="#cb15-456" aria-hidden="true" tabindex="-1"></a><span class="in">```{r build-panel-weights, warning=FALSE, message=FALSE}</span></span>
<span id="cb15-457"><a href="#cb15-457" aria-hidden="true" tabindex="-1"></a><span class="in"># Again, ipw complains about missing values, so get rid of them (i.e. all year 1)</span></span>
<span id="cb15-458"><a href="#cb15-458" aria-hidden="true" tabindex="-1"></a><span class="in">df_panel_sans_na &lt;- df_panel %&gt;%</span></span>
<span id="cb15-459"><a href="#cb15-459" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(!is.na(t_lag)) %&gt;% </span></span>
<span id="cb15-460"><a href="#cb15-460" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(y = as.numeric(y))</span></span>
<span id="cb15-461"><a href="#cb15-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-462"><a href="#cb15-462" aria-hidden="true" tabindex="-1"></a><span class="in"># Manually</span></span>
<span id="cb15-463"><a href="#cb15-463" aria-hidden="true" tabindex="-1"></a><span class="in"># Numerator is lagged treatment + non-varying confounders</span></span>
<span id="cb15-464"><a href="#cb15-464" aria-hidden="true" tabindex="-1"></a><span class="in"># ipw uses GEE models to account for panel structure, so use them here too</span></span>
<span id="cb15-465"><a href="#cb15-465" aria-hidden="true" tabindex="-1"></a><span class="in">model_num_gee &lt;- geeglm(t ~ t_lag + c, </span></span>
<span id="cb15-466"><a href="#cb15-466" aria-hidden="true" tabindex="-1"></a><span class="in">                        id = id, waves = y, corstr = "ar1",</span></span>
<span id="cb15-467"><a href="#cb15-467" aria-hidden="true" tabindex="-1"></a><span class="in">                        data = df_panel_sans_na)</span></span>
<span id="cb15-468"><a href="#cb15-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-469"><a href="#cb15-469" aria-hidden="true" tabindex="-1"></a><span class="in"># But we can also use mixed models with lmer</span></span>
<span id="cb15-470"><a href="#cb15-470" aria-hidden="true" tabindex="-1"></a><span class="in">model_num_multi &lt;- lmer(t ~ t_lag + c + (1 | id),</span></span>
<span id="cb15-471"><a href="#cb15-471" aria-hidden="true" tabindex="-1"></a><span class="in">                        data = df_panel_sans_na)</span></span>
<span id="cb15-472"><a href="#cb15-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-473"><a href="#cb15-473" aria-hidden="true" tabindex="-1"></a><span class="in"># Denominator is lagged treatment, lagged outcome, time-varying confounders +</span></span>
<span id="cb15-474"><a href="#cb15-474" aria-hidden="true" tabindex="-1"></a><span class="in"># non-varying confounders</span></span>
<span id="cb15-475"><a href="#cb15-475" aria-hidden="true" tabindex="-1"></a><span class="in">model_denom_gee &lt;- geeglm(t ~ t_lag + d_lag + c, </span></span>
<span id="cb15-476"><a href="#cb15-476" aria-hidden="true" tabindex="-1"></a><span class="in">                          id = id, waves = y, corstr = "ar1",</span></span>
<span id="cb15-477"><a href="#cb15-477" aria-hidden="true" tabindex="-1"></a><span class="in">                          data = df_panel_sans_na)</span></span>
<span id="cb15-478"><a href="#cb15-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-479"><a href="#cb15-479" aria-hidden="true" tabindex="-1"></a><span class="in">model_denom_multi &lt;- lmer(t ~ t_lag + d_lag + c + (1 | id),</span></span>
<span id="cb15-480"><a href="#cb15-480" aria-hidden="true" tabindex="-1"></a><span class="in">                          data = df_panel_sans_na)</span></span>
<span id="cb15-481"><a href="#cb15-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-482"><a href="#cb15-482" aria-hidden="true" tabindex="-1"></a><span class="in"># Probability distributions</span></span>
<span id="cb15-483"><a href="#cb15-483" aria-hidden="true" tabindex="-1"></a><span class="in">num_gee &lt;- dnorm(df_panel_sans_na$t,</span></span>
<span id="cb15-484"><a href="#cb15-484" aria-hidden="true" tabindex="-1"></a><span class="in">             predict(model_num_gee),</span></span>
<span id="cb15-485"><a href="#cb15-485" aria-hidden="true" tabindex="-1"></a><span class="in">             sd(residuals(model_num_gee)))</span></span>
<span id="cb15-486"><a href="#cb15-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-487"><a href="#cb15-487" aria-hidden="true" tabindex="-1"></a><span class="in">den_gee &lt;- dnorm(df_panel_sans_na$t,</span></span>
<span id="cb15-488"><a href="#cb15-488" aria-hidden="true" tabindex="-1"></a><span class="in">                 predict(model_denom_gee),</span></span>
<span id="cb15-489"><a href="#cb15-489" aria-hidden="true" tabindex="-1"></a><span class="in">                 sd(residuals(model_denom_gee)))</span></span>
<span id="cb15-490"><a href="#cb15-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-491"><a href="#cb15-491" aria-hidden="true" tabindex="-1"></a><span class="in">num_multi &lt;- dnorm(df_panel_sans_na$t,</span></span>
<span id="cb15-492"><a href="#cb15-492" aria-hidden="true" tabindex="-1"></a><span class="in">                   predict(model_num_multi),</span></span>
<span id="cb15-493"><a href="#cb15-493" aria-hidden="true" tabindex="-1"></a><span class="in">                   sd(residuals(model_num_multi)))</span></span>
<span id="cb15-494"><a href="#cb15-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-495"><a href="#cb15-495" aria-hidden="true" tabindex="-1"></a><span class="in">den_multi &lt;- dnorm(df_panel_sans_na$t,</span></span>
<span id="cb15-496"><a href="#cb15-496" aria-hidden="true" tabindex="-1"></a><span class="in">                   predict(model_denom_multi),</span></span>
<span id="cb15-497"><a href="#cb15-497" aria-hidden="true" tabindex="-1"></a><span class="in">                   sd(residuals(model_denom_multi)))</span></span>
<span id="cb15-498"><a href="#cb15-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-499"><a href="#cb15-499" aria-hidden="true" tabindex="-1"></a><span class="in">df_panel_weights_manual &lt;- df_panel_sans_na %&gt;% </span></span>
<span id="cb15-500"><a href="#cb15-500" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(weights_no_time_gee = num_gee / den_gee,</span></span>
<span id="cb15-501"><a href="#cb15-501" aria-hidden="true" tabindex="-1"></a><span class="in">         weights_no_time_multi = num_multi / den_multi) %&gt;% </span></span>
<span id="cb15-502"><a href="#cb15-502" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(id) %&gt;% </span></span>
<span id="cb15-503"><a href="#cb15-503" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(ipw_gee = cumprod(weights_no_time_gee),</span></span>
<span id="cb15-504"><a href="#cb15-504" aria-hidden="true" tabindex="-1"></a><span class="in">         ipw_multi = cumprod(weights_no_time_multi)) %&gt;% </span></span>
<span id="cb15-505"><a href="#cb15-505" aria-hidden="true" tabindex="-1"></a><span class="in">  ungroup()</span></span>
<span id="cb15-506"><a href="#cb15-506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-507"><a href="#cb15-507" aria-hidden="true" tabindex="-1"></a><span class="in"># Automatically with ipwtm()</span></span>
<span id="cb15-508"><a href="#cb15-508" aria-hidden="true" tabindex="-1"></a><span class="in">panel_weights_auto &lt;- ipwtm(</span></span>
<span id="cb15-509"><a href="#cb15-509" aria-hidden="true" tabindex="-1"></a><span class="in">  exposure = t,</span></span>
<span id="cb15-510"><a href="#cb15-510" aria-hidden="true" tabindex="-1"></a><span class="in">  family = "gaussian", </span></span>
<span id="cb15-511"><a href="#cb15-511" aria-hidden="true" tabindex="-1"></a><span class="in">  numerator = ~ t_lag + c, </span></span>
<span id="cb15-512"><a href="#cb15-512" aria-hidden="true" tabindex="-1"></a><span class="in">  denominator = ~ t_lag + d_lag + c, </span></span>
<span id="cb15-513"><a href="#cb15-513" aria-hidden="true" tabindex="-1"></a><span class="in">  id = id,</span></span>
<span id="cb15-514"><a href="#cb15-514" aria-hidden="true" tabindex="-1"></a><span class="in">  timevar = y,</span></span>
<span id="cb15-515"><a href="#cb15-515" aria-hidden="true" tabindex="-1"></a><span class="in">  type = "all",</span></span>
<span id="cb15-516"><a href="#cb15-516" aria-hidden="true" tabindex="-1"></a><span class="in">  corstr = "ar1",</span></span>
<span id="cb15-517"><a href="#cb15-517" aria-hidden="true" tabindex="-1"></a><span class="in">  data = as.data.frame(df_panel_sans_na))</span></span>
<span id="cb15-518"><a href="#cb15-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-519"><a href="#cb15-519" aria-hidden="true" tabindex="-1"></a><span class="in">df_panel_weights_auto &lt;- df_panel_sans_na %&gt;% </span></span>
<span id="cb15-520"><a href="#cb15-520" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(ipw = panel_weights_auto$ipw.weights)</span></span>
<span id="cb15-521"><a href="#cb15-521" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-522"><a href="#cb15-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-523"><a href="#cb15-523" aria-hidden="true" tabindex="-1"></a>Now we can build the outcome models, using both GEE and multilevel models.</span>
<span id="cb15-524"><a href="#cb15-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-525"><a href="#cb15-525" aria-hidden="true" tabindex="-1"></a><span class="in">```{r panel-outcome-models}</span></span>
<span id="cb15-526"><a href="#cb15-526" aria-hidden="true" tabindex="-1"></a><span class="in">m_manual_gee &lt;- geeglm(d ~ t + t_lag, </span></span>
<span id="cb15-527"><a href="#cb15-527" aria-hidden="true" tabindex="-1"></a><span class="in">                       data = df_panel_weights_manual,</span></span>
<span id="cb15-528"><a href="#cb15-528" aria-hidden="true" tabindex="-1"></a><span class="in">                       id = id, waves = y, </span></span>
<span id="cb15-529"><a href="#cb15-529" aria-hidden="true" tabindex="-1"></a><span class="in">                       weights = ipw_gee)</span></span>
<span id="cb15-530"><a href="#cb15-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-531"><a href="#cb15-531" aria-hidden="true" tabindex="-1"></a><span class="in">m_auto_gee &lt;- geeglm(d ~ t + t_lag, </span></span>
<span id="cb15-532"><a href="#cb15-532" aria-hidden="true" tabindex="-1"></a><span class="in">                     data = df_panel_weights_auto, </span></span>
<span id="cb15-533"><a href="#cb15-533" aria-hidden="true" tabindex="-1"></a><span class="in">                     id = id, waves = y, </span></span>
<span id="cb15-534"><a href="#cb15-534" aria-hidden="true" tabindex="-1"></a><span class="in">                     weights = ipw)</span></span>
<span id="cb15-535"><a href="#cb15-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-536"><a href="#cb15-536" aria-hidden="true" tabindex="-1"></a><span class="in">m_lmer_manual_gee_wt &lt;- lmer(d ~ t + t_lag + (1 | id), </span></span>
<span id="cb15-537"><a href="#cb15-537" aria-hidden="true" tabindex="-1"></a><span class="in">                             data = df_panel_weights_manual, </span></span>
<span id="cb15-538"><a href="#cb15-538" aria-hidden="true" tabindex="-1"></a><span class="in">                             weights = ipw_gee)</span></span>
<span id="cb15-539"><a href="#cb15-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-540"><a href="#cb15-540" aria-hidden="true" tabindex="-1"></a><span class="in">m_lmer_auto_gee_wt &lt;- lmer(d ~ t + t_lag + (1 | id), </span></span>
<span id="cb15-541"><a href="#cb15-541" aria-hidden="true" tabindex="-1"></a><span class="in">                           data = df_panel_weights_auto, </span></span>
<span id="cb15-542"><a href="#cb15-542" aria-hidden="true" tabindex="-1"></a><span class="in">                           weights = ipw)</span></span>
<span id="cb15-543"><a href="#cb15-543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-544"><a href="#cb15-544" aria-hidden="true" tabindex="-1"></a><span class="in">m_lmer_manual_multi_wt &lt;- lmer(d ~ t + t_lag + (1 | id), </span></span>
<span id="cb15-545"><a href="#cb15-545" aria-hidden="true" tabindex="-1"></a><span class="in">                               data = df_panel_weights_manual, </span></span>
<span id="cb15-546"><a href="#cb15-546" aria-hidden="true" tabindex="-1"></a><span class="in">                               weights = ipw_multi)</span></span>
<span id="cb15-547"><a href="#cb15-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-548"><a href="#cb15-548" aria-hidden="true" tabindex="-1"></a><span class="in">results &lt;- tribble(</span></span>
<span id="cb15-549"><a href="#cb15-549" aria-hidden="true" tabindex="-1"></a><span class="in">  ~`Method`, ~`Weights`, ~`lag(T) effect`, ~`T effect`,</span></span>
<span id="cb15-550"><a href="#cb15-550" aria-hidden="true" tabindex="-1"></a><span class="in">  "True effect", NA, 0.160, 0.400,</span></span>
<span id="cb15-551"><a href="#cb15-551" aria-hidden="true" tabindex="-1"></a><span class="in">  "Panel with GEE", "Manual GEE weights", filter(tidy(m_manual_gee), term == "t_lag")$estimate, filter(tidy(m_manual_gee), term == "t")$estimate,</span></span>
<span id="cb15-552"><a href="#cb15-552" aria-hidden="true" tabindex="-1"></a><span class="in">  "Panel with GEE", "Automatic GEE weights", filter(tidy(m_auto_gee), term == "t_lag")$estimate, filter(tidy(m_auto_gee), term == "t")$estimate,</span></span>
<span id="cb15-553"><a href="#cb15-553" aria-hidden="true" tabindex="-1"></a><span class="in">  "Panel with multilevel model", "Manual GEE weights", filter(tidy(m_lmer_manual_gee_wt), term == "t_lag")$estimate, filter(tidy(m_lmer_manual_gee_wt), term == "t")$estimate,</span></span>
<span id="cb15-554"><a href="#cb15-554" aria-hidden="true" tabindex="-1"></a><span class="in">  "Panel with multilevel model", "Automatic GEE weights", filter(tidy(m_lmer_auto_gee_wt), term == "t_lag")$estimate, filter(tidy(m_lmer_auto_gee_wt), term == "t")$estimate,</span></span>
<span id="cb15-555"><a href="#cb15-555" aria-hidden="true" tabindex="-1"></a><span class="in">  "Panel with multilevel model", "Manual multilevel weights", filter(tidy(m_lmer_manual_multi_wt), term == "t_lag")$estimate, filter(tidy(m_lmer_manual_multi_wt), term == "t")$estimate</span></span>
<span id="cb15-556"><a href="#cb15-556" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb15-557"><a href="#cb15-557" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-558"><a href="#cb15-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-559"><a href="#cb15-559" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-panel-results, echo=FALSE}</span></span>
<span id="cb15-560"><a href="#cb15-560" aria-hidden="true" tabindex="-1"></a><span class="in">kbl(results, digits = 3, format = "html", table.attr = "style='width:90%;'") %&gt;% </span></span>
<span id="cb15-561"><a href="#cb15-561" aria-hidden="true" tabindex="-1"></a><span class="in">  kable_styling(htmltable_class = "table table-sm")</span></span>
<span id="cb15-562"><a href="#cb15-562" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-563"><a href="#cb15-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-564"><a href="#cb15-564" aria-hidden="true" tabindex="-1"></a>Phew.</span>
<span id="cb15-565"><a href="#cb15-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-566"><a href="#cb15-566" aria-hidden="true" tabindex="-1"></a>All of the models here are relatively close to the true effect for $T_t$! (Though they're all sizably off for $T_{t-1}$, but I don't know why). </span>
<span id="cb15-567"><a href="#cb15-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-568"><a href="#cb15-568" aria-hidden="true" tabindex="-1"></a>Importantly, it seems that mixed models work just fine for both weights and outcome models, which means there's probably no need to use GEE (and this can all be done Bayesianly with <span class="in">`brms()`</span>!). </span>
<span id="cb15-569"><a href="#cb15-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-570"><a href="#cb15-570" aria-hidden="true" tabindex="-1"></a>It works!</span>
<span id="cb15-571"><a href="#cb15-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-572"><a href="#cb15-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-573"><a href="#cb15-573" aria-hidden="true" tabindex="-1"></a><span class="fu">## Questions for the future</span></span>
<span id="cb15-574"><a href="#cb15-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-575"><a href="#cb15-575" aria-hidden="true" tabindex="-1"></a>I still have some lingering things to check (forthcoming in a future blog post):</span>
<span id="cb15-576"><a href="#cb15-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-577"><a href="#cb15-577" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`y`</span> isn't any any of the models: weights numerator, weights denominator, or outcome. If I include it in any of the models, the there's perfect fit. That may be because there are no time-varying confounders? I think year might need to be in there somewhere, but I'm not sure. @BlackwellGlynn:2018 include year in the numerator and denominator for weights in their Swank Steinmo replication, but not in their Burgoon replication.</span>
<span id="cb15-578"><a href="#cb15-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-579"><a href="#cb15-579" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>This example has no time-varying confounders. I need to see how this all works with those.</span>
<span id="cb15-580"><a href="#cb15-580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-581"><a href="#cb15-581" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>This DAG for this example is pretty simple. I need to see what happens when there are *also* direct arrows from $T_{t-1} \rightarrow T_{t}$ and $D_{t-1} \rightarrow D_{t}$.</span>
<span id="cb15-582"><a href="#cb15-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-583"><a href="#cb15-583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-584"><a href="#cb15-584" aria-hidden="true" tabindex="-1"></a><span class="fu">## References</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p><span class="faux-block">Forked from <a href="https://www.andrewheiss.com/">Andrew Heiss</a></span> # <span class="faux-block"><a href="https://github.com/andrewheiss/ath-quarto">View the source at <i class="fa-brands fa-github" aria-label="github"></i> GitHub</a></span></p>
</div>
  </div>
</footer>


</body></html>