<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Andrew Heiss">
<meta name="description" content="Use a posterior distribution of inverse probability weights in a Bayesian outcome model to conduct (nearly) fully Bayesian causal inference with R, brms, and Stan">
<title>How to create a(n almost) fully Bayesian outcome model with inverse probability weights | Andrew Heiss – Andrew Heiss</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="../../../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../../../">
<link href="../../../../..//files/favicon-512.png" rel="icon" type="image/png">
<script src="../../../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../../../site_libs/quarto-html/quarto-syntax-highlighting-17c909d5fd25ae21b861c0c7a49b2096.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../../../site_libs/bootstrap/bootstrap-5cd0811f461c8271ae6bab49df9501be.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<link href="../../../../../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../../../../../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<script src="../../../../../site_libs/quarto-contrib/iconify-2.0.0/iconify-icon.min.js"></script><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script type="text/javascript">

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-527449-5', 'auto');

ga('send', {
  hitType: 'pageview',
  'anonymizeIp': true,
});
</script><style>

      .quarto-title-block .quarto-title-banner {
        background: #170C3A;
      }
</style>
<script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
<meta property="og:title" content="How to create a(n almost) fully Bayesian outcome model with inverse probability weights | Andrew Heiss">
<meta property="og:description" content="Use a posterior distribution of inverse probability weights in a Bayesian outcome model to conduct (nearly) fully Bayesian causal inference with R, brms, and Stan">
<meta property="og:image" content="https://www.andrewheiss.com/blog/2021/12/20/fully-bayesian-ate-iptw/index_files/figure-html/plot-ate-posterior-1.png">
<meta property="og:site_name" content="Andrew Heiss">
<meta property="og:locale" content="en_US">
<meta property="og:image:height" content="1067">
<meta property="og:image:width" content="1728">
<meta name="twitter:title" content="How to create a(n almost) fully Bayesian outcome model with inverse probability weights | Andrew Heiss">
<meta name="twitter:description" content="Use a posterior distribution of inverse probability weights in a Bayesian outcome model to conduct (nearly) fully Bayesian causal inference with R, brms, and Stan">
<meta name="twitter:image" content="https://www.andrewheiss.com/blog/2021/12/20/fully-bayesian-ate-iptw/index_files/figure-html/plot-ate-posterior-1.png">
<meta name="twitter:creator" content="@andrewheiss">
<meta name="twitter:site" content="@andrewheiss">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image-height" content="1067">
<meta name="twitter:image-width" content="1728">
</head>
<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../../../index.html">
    <span class="navbar-title">Andrew Heiss</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link" href="../../../../../index.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../cv/index.html"> 
<span class="menu-text">CV</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../blog/index.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../research/index.html"> 
<span class="menu-text">Research</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../teaching/index.html"> 
<span class="menu-text">Teaching</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../talks/index.html"> 
<span class="menu-text">Talks</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../now/index.html"> 
<span class="menu-text">Now</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../uses/index.html"> 
<span class="menu-text">Uses</span></a>
  </li>  
</ul>
<ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item">
    <a class="nav-link" href="../../../../../atom.xml"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:rss" style="font-size: 1.1em;" aria-label="Icon rss from bi Iconify.design set." title="RSS"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="mailto:aheiss@gsu.edu"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:envelope" style="font-size: 1.1em;" aria-label="Icon envelope from bi Iconify.design set." title="E-mail"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://bsky.app/profile/andrew.heiss.phd" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="fa6-brands:bluesky" style="font-size: 1.1em;" aria-label="Icon bluesky from fa6-brands Iconify.design set." title="Bluesky"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://fediscience.org/users/andrew/" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:mastodon" style="font-size: 1.1em;" aria-label="Icon mastodon from bi Iconify.design set." title="Mastodon"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/andrewheiss" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:github" style="font-size: 1.1em;" aria-label="Icon github from bi Iconify.design set." title="GitHub"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.youtube.com/andrewheiss" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:youtube" style="font-size: 1.1em;" aria-label="Icon youtube from bi Iconify.design set." title="YouTube"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.heissatopia.com/"> 
<span class="menu-text"><iconify-icon inline="" icon="fa6-brands:blogger" style="font-size: 1.15em;" aria-label="Icon blogger from fa6-brands Iconify.design set." title="Blogger"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.linkedin.com/in/andrewheiss" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:linkedin" style="font-size: 1.1em;" aria-label="Icon linkedin from bi Iconify.design set." title="LinkedIn"></iconify-icon></span></a>
  </li>  
</ul>
</div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><header id="title-block-header" class="quarto-title-block default blog-post page-columns page-full"><div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">How to create a(n almost) fully Bayesian outcome model with inverse probability weights</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
                  <div>
        <div class="description">
          Use a posterior distribution of inverse probability weights in a Bayesian outcome model to conduct (nearly) fully Bayesian causal inference with R, brms, and Stan
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">r</div>
                <div class="quarto-category">tidyverse</div>
                <div class="quarto-category">regression</div>
                <div class="quarto-category">statistics</div>
                <div class="quarto-category">data visualization</div>
                <div class="quarto-category">causal inference</div>
                <div class="quarto-category">do calculus</div>
                <div class="quarto-category">DAGs</div>
                <div class="quarto-category">bayes</div>
                <div class="quarto-category">brms</div>
                <div class="quarto-category">stan</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p><a href="https://www.andrewheiss.com/">Andrew Heiss</a> <a href="https://orcid.org/0000-0002-3948-3914" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">Monday, December 20, 2021</p>
      </div>
    </div>
    
      
      <div>
      <div class="quarto-title-meta-heading">Doi</div>
      <div class="quarto-title-meta-contents">
        <p class="doi">
          <a href="https://doi.org/10.59350/gyvjk-hrx68">10.59350/gyvjk-hrx68</a>
        </p>
      </div>
    </div>
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Contents</h2>
   
  <ul>
<li><a href="#the-intuition" id="toc-the-intuition" class="nav-link active" data-scroll-target="#the-intuition">The intuition</a></li>
  <li>
<a href="#using-a-matrix-of-weights-with-raw-stan-code" id="toc-using-a-matrix-of-weights-with-raw-stan-code" class="nav-link" data-scroll-target="#using-a-matrix-of-weights-with-raw-stan-code">Using a matrix of weights with raw Stan code</a>
  <ul class="collapse">
<li><a href="#export-starter-stan-code" id="toc-export-starter-stan-code" class="nav-link" data-scroll-target="#export-starter-stan-code">Export starter Stan code</a></li>
  <li><a href="#adjust-the-stan-code-slightly" id="toc-adjust-the-stan-code-slightly" class="nav-link" data-scroll-target="#adjust-the-stan-code-slightly">Adjust the Stan code slightly</a></li>
  <li><a href="#define-c-functions-for-the-counter" id="toc-define-c-functions-for-the-counter" class="nav-link" data-scroll-target="#define-c-functions-for-the-counter">Define C++ functions for the counter</a></li>
  <li><a href="#compile-the-stan-code" id="toc-compile-the-stan-code" class="nav-link" data-scroll-target="#compile-the-stan-code">Compile the Stan code</a></li>
  <li><a href="#run-the-model" id="toc-run-the-model" class="nav-link" data-scroll-target="#run-the-model">Run the model</a></li>
  </ul>
</li>
  <li><a href="#analyze-the-results" id="toc-analyze-the-results" class="nav-link" data-scroll-target="#analyze-the-results">Analyze the results</a></li>
  <li><a href="#using-the-results-with-brms" id="toc-using-the-results-with-brms" class="nav-link" data-scroll-target="#using-the-results-with-brms">Using the results with <strong>brms</strong></a></li>
  <li><a href="#only-tiny-downside" id="toc-only-tiny-downside" class="nav-link" data-scroll-target="#only-tiny-downside">Only tiny downside</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul></nav>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content"><div class="cell">
<style type="text/css">
.first-block {
    padding-right: 10px;
}
</style>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Read the previous post first!
</div>
</div>
<div class="callout-body-container callout-body">
<p>This post is a sequel to <a href="https://www.andrewheiss.com/blog/2021/12/18/bayesian-propensity-scores-weights/">the previous one on Bayesian propensity scores</a> and won’t make a lot of sense without reading that one first. Read that one first!</p>
</div>
</div>
<p>In <a href="https://www.andrewheiss.com/blog/2021/12/18/bayesian-propensity-scores-weights/">my previous post about how to create Bayesian propensity scores</a> and how to legally use them in a second stage outcome model, I ended up using <a href="https://www.andrewheiss.com/blog/2021/12/18/bayesian-propensity-scores-weights/#a-legal-way-to-use-weights-bayesianly">frequentist models for the outcome stage</a>. I did this for the sake of computational efficiency—running 2,000 models with <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> is way faster than running 2,000 individual Bayesian models with <code>brm()</code> from <strong>brms</strong> (like, creating 2,000 Bayesian models could take hours or days or weeks!)</p>
<p>I concluded with <a href="https://www.andrewheiss.com/blog/2021/12/18/bayesian-propensity-scores-weights/#things-i-dont-know-yet-but-want-to-know">this paragraph</a>:</p>
<blockquote class="blockquote">
<p>We could technically run a Bayesian outcome model with <code>brm()</code>, but we’d have to run it 2,000 times—one model per set of weights—and that would take literally forever and might melt my computer. There could be a way to only run a single outcome model once and use one set of weights for each of the iterations (i.e.&nbsp;use the first column of propensity scores for the first iteration of the outcome model, the second for the second, and so on), but that goes beyond my skills with <strong>brms</strong>.</p>
</blockquote>
<p><a href="https://twitter.com/adamjnafa">Jordan Nafa</a> took on this challenge, though, and figured out a way to do exactly this with Stan!! He has a <a href="https://github.com/ajnafa/Bayesian-IPW">super well-documented example at GitHub</a>, and I’ve adapted and borrowed liberally from his code for this post. <strong>Check out his example for additional updates and even more fantastic explanation!</strong></p>
<section id="the-intuition" class="level2"><h2 class="anchored" data-anchor-id="the-intuition">The intuition</h2>
<p>After creating a treatment model in the design stage (i.e.&nbsp;predicting net usage based on the confounders), we generate a matrix of propensity scores or inverse probability weights (<span class="math inline">\(\nu\)</span> in <span class="citation" data-cites="LiaoZigler:2020">Liao and Zigler (<a href="#ref-LiaoZigler:2020" role="doc-biblioref">2020</a>)</span>’s approach). Each column of this matrix contains one posterior draw of propensity scores or weights.</p>
<p><a href="https://www.andrewheiss.com/blog/2021/12/18/bayesian-propensity-scores-weights/#a-legal-way-to-use-weights-bayesianly">In my original post</a>, we generated 2,000 sets of propensity scores and then ran 2,000 outcome models with <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> to calculate the average treatment effect (ATE).</p>
<p><strong>brms</strong> allows you to use weights with a slightly different syntax from <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code>:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">brm</span><span class="op">(</span><span class="fu">bf</span><span class="op">(</span><span class="va">outcome</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/stats/weights.html">weights</a></span><span class="op">(</span><span class="va">iptw</span><span class="op">)</span> <span class="op">~</span> <span class="va">treatment</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">whatever</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The argument we feed to <code><a href="https://rdrr.io/r/stats/weights.html">weights()</a></code> needs to be a column in the data that we’re working with (like <code>iptw</code> here for the inverse probability weights).</p>
<p>Since it’s not really feasible to run thousands of separate Bayesian models, we can instead run the outcome model once and feed one set of weights for each MCMC iteration. Conceptually, we want to do something like this:</p>
<ul>
<li>Outcome model posterior draw 1: <code>bf(outcome | weights(iptw[,1]) ~ treatment)</code>
</li>
<li>Outcome model posterior draw 2: <code>bf(outcome | weights(iptw[,2]) ~ treatment)</code>
</li>
<li>Outcome model posterior draw 3: <code>bf(outcome | weights(iptw[,3]) ~ treatment)</code>
</li>
<li>(and so on)</li>
</ul>
<p>Each posterior draw thus gets its own set of weights, and all the draws are combined in the end as a single posterior distribution of the average treatment effect.</p>
</section><section id="using-a-matrix-of-weights-with-raw-stan-code" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="using-a-matrix-of-weights-with-raw-stan-code">Using a matrix of weights with raw Stan code</h2>
<p>Unfortunately <strong>brms</strong> <a href="https://discourse.mc-stan.org/t/how-to-update-a-brmsfit-object-with-a-modified-brms-generated-stan-model-marginalizing-over-a-distribution-of-weights/7567">can’t handle a matrix of weights</a>. The <code><a href="https://rdrr.io/r/stats/weights.html">weights()</a></code> term in the model formula can only take a single column—it can’t iterate through a bunch of columns in a matrix. This is sad because it means we have to leave the comfort and convenience of <strong>brms</strong> and work with Stan code directly.</p>
<p>Fortunately, <strong>brms</strong> makes it easy to work with raw Stan and does most of the hard work for us. The <code>make_stancode()</code> function will convert a <code>brms</code>-based model into Stan code that we can then edit and tinker with.</p>
<p>Here’s how we can do it (again with heavily annotated code from <a href="https://github.com/ajnafa/Bayesian-IPW">Jordan Nafa’s phenomenal example of how this all works</a>):</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>    <span class="co"># ggplot2, dplyr, %&gt;%, and friends</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/paul-buerkner/brms">brms</a></span><span class="op">)</span>         <span class="co"># Nice interface for Bayesian models through Stan</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/rstan/">rstan</a></span><span class="op">)</span>        <span class="co"># For running Stan through R</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mjskay.github.io/tidybayes/">tidybayes</a></span><span class="op">)</span>    <span class="co"># For dealing with MCMC draws in a tidy way</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mjskay.github.io/ggdist/">ggdist</a></span><span class="op">)</span>       <span class="co"># For distribution-related geoms</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bbolker/broom.mixed">broom.mixed</a></span><span class="op">)</span>  <span class="co"># For converting Stan-based model results to data frames</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://here.r-lib.org/">here</a></span><span class="op">)</span>         <span class="co"># Convenient way for locating files</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">6348</span><span class="op">)</span>  <span class="co"># From random.org</span></span>
<span></span>
<span><span class="co"># Use the Egypt palette from the MetBrewer package</span></span>
<span><span class="va">egypt</span> <span class="op">&lt;-</span> <span class="fu">MetBrewer</span><span class="fu">::</span><span class="fu">met.brewer</span><span class="op">(</span><span class="st">"Egypt"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Custom ggplot theme to make pretty plots</span></span>
<span><span class="co"># Get Archivo Narrow at https://fonts.google.com/specimen/Archivo+Narrow</span></span>
<span><span class="va">theme_nice</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span>base_family <span class="op">=</span> <span class="st">"Archivo Narrow"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">theme</span><span class="op">(</span>panel.grid.minor <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>          plot.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"white"</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>,</span>
<span>          plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>          axis.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>          strip.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span>, size <span class="op">=</span> <span class="fu">rel</span><span class="op">(</span><span class="fl">0.8</span><span class="op">)</span>, hjust <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>          strip.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"grey80"</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>,</span>
<span>          legend.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Use this theme on all plots</span></span>
<span><span class="fu">theme_set</span><span class="op">(</span></span>
<span>  <span class="fu">theme_nice</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Make all labels use Archivo by default</span></span>
<span><span class="fu">update_geom_defaults</span><span class="op">(</span><span class="st">"label"</span>,</span>
<span>                     <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Archivo Narrow"</span>,</span>
<span>                          fontface <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>First we’ll load the data (see the <a href="https://www.andrewheiss.com/blog/2021/12/18/bayesian-propensity-scores-weights/#basic-frequentist-example">previous post</a> or <a href="https://evalf21.classes.andrewheiss.com/example/matching-ipw/">my class example on inverse probability weighting</a> for more details about what these columns are). <strong>Our main question here is the effect of mosquito net usage on malaria risk.</strong></p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">nets</span> <span class="op">&lt;-</span> <span class="fu">read_csv</span><span class="op">(</span><span class="st">"https://evalf21.classes.andrewheiss.com/data/mosquito_nets.csv"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’ll then create a model that predicts whether people self-select into using a mosquito net, based on our confounders of income, health status, and nighttime temperatures.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/model-treatment_6b4f35cb5714b96e044335d90b61511d">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># First stage model predicting net usage with the confounders</span></span>
<span><span class="va">model_treatment</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span></span>
<span>  <span class="fu">bf</span><span class="op">(</span><span class="va">net</span> <span class="op">~</span> <span class="va">income</span> <span class="op">+</span> <span class="va">temperature</span> <span class="op">+</span> <span class="va">health</span>,</span>
<span>     decomp <span class="op">=</span> <span class="st">"QR"</span><span class="op">)</span>,  <span class="co"># QR decomposition handles scaling and unscaling for us</span></span>
<span>  family <span class="op">=</span> <span class="fu">bernoulli</span><span class="op">(</span><span class="op">)</span>,  <span class="co"># Logistic regression</span></span>
<span>  data <span class="op">=</span> <span class="va">nets</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">8</span>, cores <span class="op">=</span> <span class="fl">8</span>, iter <span class="op">=</span> <span class="fl">2000</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">1234</span>, backend <span class="op">=</span> <span class="st">"cmdstanr"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">## Start sampling</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’ll the extract the predicted probabilities / propensity scores from the model and calculate inverse probability weights in each posterior draw for each person in the dataset:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/create-iptws_8bc6bffa54d58b4cfe137ecb9c1171b9">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Extract posterior predicted propensity scores</span></span>
<span><span class="va">pred_probs_chains</span> <span class="op">&lt;-</span> <span class="fu">posterior_epred</span><span class="op">(</span><span class="va">model_treatment</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Rows are posterior draws, columns are original rows in dataset</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">pred_probs_chains</span><span class="op">)</span></span>
<span><span class="co">## [1] 8000 1752</span></span>
<span></span>
<span><span class="co"># Create a matrix of weights where each column is a posterior draw</span></span>
<span><span class="co"># Transpose the matrix so that columns are posterior draws</span></span>
<span><span class="va">ipw_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">pred_probs_chains</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">as_tibble</span><span class="op">(</span>.name_repair <span class="op">=</span> <span class="st">"universal"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Add treatment column so we can calculate weights</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>net_num <span class="op">=</span> <span class="va">nets</span><span class="op">$</span><span class="va">net_num</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Calculate weights</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu">starts_with</span><span class="op">(</span><span class="st">"..."</span><span class="op">)</span>,</span>
<span>                <span class="op">~</span> <span class="op">(</span><span class="va">net_num</span> <span class="op">/</span> <span class="va">.x</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">net_num</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">.x</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Get rid of treatment column</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">net_num</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Rows are original rows in data and columns are posterior draws</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">ipw_matrix</span><span class="op">)</span></span>
<span><span class="co">## [1] 1752 8000</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">ipw_matrix</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 5 × 10</span></span>
<span><span class="co">##    ...1  ...2  ...3  ...4  ...5  ...6  ...7  ...8  ...9 ...10</span></span>
<span><span class="co">##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">## 1  2.49  3.01  2.50  2.62  2.66  2.78  2.73  2.74  2.60  2.70</span></span>
<span><span class="co">## 2  1.70  1.57  1.70  1.61  1.62  1.65  1.64  1.63  1.69  1.63</span></span>
<span><span class="co">## 3  1.22  1.16  1.22  1.17  1.21  1.17  1.14  1.14  1.22  1.20</span></span>
<span><span class="co">## 4  3.64  4.02  3.63  4.03  3.68  3.92  4.16  4.17  3.26  3.64</span></span>
<span><span class="co">## 5  1.44  1.44  1.45  1.41  1.45  1.44  1.43  1.43  1.58  1.47</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="export-starter-stan-code" class="level3"><h3 class="anchored" data-anchor-id="export-starter-stan-code">Export starter Stan code</h3>
<p>Next we need to use these weights in an outcome model using the neat trick of using one column of weights for each iteration of the outcome model, which requires actual Stan code (which I haven’t really written since <a href="https://www.andrewheiss.com/blog/2019/01/29/diff-means-half-dozen-ways/#bayesian-analysis-directly-with-stan">this blog post</a> or <a href="https://www.andrewheiss.com/research/articles/chaudhry-heiss-ngos-philanthropy/">this research project</a> (<a href="https://github.com/andrewheiss/ngo-crackdowns-philanthropy/tree/master/inst/stan">see here</a>)).</p>
<p>To simplify life and make it so we don’t have to really write any raw Stan code, we’ll create the skeleton of our Bayesian outcome model with <strong>brms</strong>, but we don’t actually run it—instead we’ll pass the formula and priors to <code>make_stancode()</code> and save the underlying Stan code as a new file.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Outcome model</span></span>
<span><span class="co"># We can just use a placeholder weights(1) since the nets data doesn't have any</span></span>
<span><span class="co"># actual weights in it. It's okay bc we'll never actually run this model.</span></span>
<span><span class="va">outcome_formula</span> <span class="op">&lt;-</span> <span class="fu">bf</span><span class="op">(</span><span class="va">malaria_risk</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/stats/weights.html">weights</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">~</span> <span class="va">net</span>,</span>
<span>                      family <span class="op">=</span> <span class="va">gaussian</span><span class="op">)</span></span>
<span></span>
<span><span class="va">outcome_priors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu">prior</span><span class="op">(</span><span class="st">"student_t(3, 0, 2.5)"</span>, class <span class="op">=</span> <span class="st">"Intercept"</span><span class="op">)</span>,</span>
<span>                    <span class="fu">prior</span><span class="op">(</span><span class="st">"normal(0, 2.5)"</span>, class <span class="op">=</span> <span class="st">"b"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate Stan code for the outcome model</span></span>
<span><span class="fu">make_stancode</span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">outcome_formula</span>,</span>
<span>  data <span class="op">=</span> <span class="va">nets</span>,</span>
<span>  prior <span class="op">=</span> <span class="va">outcome_priors</span>,</span>
<span>  save_model <span class="op">=</span> <span class="st">"original_stan_code.stan"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="adjust-the-stan-code-slightly" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="adjust-the-stan-code-slightly">Adjust the Stan code slightly</h3>
<p>Next we need to make some minor adjustments to the Stan code. You can also download a complete version of all these changes in this .zip file:</p>
<ul>
<li><a href="modified-stan-stuff.zip"><i class="fas fa-file-archive"></i> <code>modified-stan-stuff.zip</code></a></li>
</ul>
<p>Here’s what needs to change:</p>
<p><strong>Change 1</strong>: Declare two functions in the <code>functions</code> block. <strong>The actual code for these two functions will live in a separate C++ file that we’ll look at and make in just a minute.</strong> These will let us keep track of the current iteration number of the MCMC chains. <a href="https://discourse.mc-stan.org/t/is-it-possible-to-access-the-iteration-step-number-inside-a-stan-program/1871/8">By design, Stan doesn’t let you see the current iteration number</a> (Stan code is designed to be stateless and not dependent on specific iteration numbers) but these two functions allow us to keep track of this ourselves. (These functions were originally <a href="https://discourse.mc-stan.org/t/is-it-possible-to-access-the-iteration-step-number-inside-a-stan-program/1871/23">written by Louis at the Stan forum</a>; <a href="https://stackoverflow.com/a/68901076/120898">this StackOverflow answer</a> shows another example of them working in the wild)</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you’re editing this file in RStudio, you’ll likely see a syntax error after this block, with the complaint “Function declared, but not defined.” That’s okay. We’ll officially define these functions in an external file and inject it into this Stan code when compiling. You can ignore the error.</p>
</div>
</div>
<div class="columns column-page-inset-right">
<div class="column first-block" style="width:45%;">
<div class="sourceCode" id="cb7"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Original block</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="kw">functions</span> {</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div><div class="column" style="width:45%;">
<div class="sourceCode" id="cb8"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Modified block</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co">// ADD 2 NEW LINES</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="kw">functions</span> {</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> add_iter();  <span class="co">// ~*~THIS IS NEW~*~</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> get_iter();  <span class="co">// ~*~THIS IS NEW~*~</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p><strong>Change 2</strong>: Remove the declaration for the <code>weights</code> variable from the <code>data</code> block and add new declarations for two new variables: <code>L</code> for keeping track of the number of columns in the weights matrix, and <code>IPW</code> for the weights matrix:</p>
<div class="columns column-screen-inset-right">
<div class="column first-block" style="width:45%;">
<div class="sourceCode" id="cb9"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Original block</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> {</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; N;  <span class="co">// total number of observations</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] Y;  <span class="co">// response variable</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt;[N] weights;  <span class="co">// model weights</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; K;  <span class="co">// number of population-level effects</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">matrix</span>[N, K] X;  <span class="co">// population-level design matrix</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> prior_only;  <span class="co">// should the likelihood be ignored?</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div><div class="column" style="width:45%;">
<div class="sourceCode" id="cb10"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Modified block</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co">// REMOVE 1 LINE; ADD 2 NEW LINES</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> {</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; N;  <span class="co">// total number of observations</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] Y;  <span class="co">// response variable</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">//vector&lt;lower=0&gt;[N] weights;  // model weights -- ~*~REMOVE THIS~*~</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; K;  <span class="co">// number of population-level effects</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">matrix</span>[N, K] X;  <span class="co">// population-level design matrix</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> prior_only;  <span class="co">// should the likelihood be ignored?</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> L;  <span class="co">// number of columns in the weights matrix -- ~*~THIS IS NEW~*~</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">matrix</span>[N, L] IPW;  <span class="co">// weights matrix -- ~*~THIS IS NEW~*~</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p><strong>Change 3</strong>: In the <code>model</code> block, add the ability to keep track of the current iteration with <code>get_iter()</code>. And—most importantly—modify the actual model so that it uses a column from the weights matrix <code>IPW[n, M]</code> rather than the single <code>weights[n]</code> vector.</p>
<div class="columns column-screen-inset-right">
<div class="column first-block" style="width:45%;">
<div class="sourceCode" id="cb11"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Original block</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// likelihood including constants</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (!prior_only) {</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// initialize linear predictor term</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vector</span>[N] mu = Intercept + Xc * b;</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span>:N) {</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>      <span class="kw">target +=</span> weights[n] * (normal_lpdf(Y[n] | mu[n], sigma));</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// priors including constants</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> normal_lpdf(b | <span class="dv">0</span>, <span class="fl">2.5</span>);</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> student_t_lpdf(Intercept | <span class="dv">3</span>, <span class="dv">0</span>, <span class="fl">2.5</span>);</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> student_t_lpdf(sigma | <span class="dv">3</span>, <span class="dv">0</span>, <span class="fl">14.8</span>)</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    - <span class="dv">1</span> * student_t_lccdf(<span class="dv">0</span> | <span class="dv">3</span>, <span class="dv">0</span>, <span class="fl">14.8</span>);</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div><div class="column" style="width:45%;">
<div class="sourceCode" id="cb12"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Modified block</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co">// ADD 2 LINES</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// likelihood including constants</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (!prior_only) {</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// initialize linear predictor term</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vector</span>[N] mu = Intercept + Xc * b;</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> M = get_iter();  <span class="co">// get the current iteration -- ~*~THIS IS NEW~*~</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vector</span>[N] weights = IPW[, M];  <span class="co">// get the weights for this iteration -- ~*~THIS IS NEW~*~</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span>:N) {</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>      <span class="kw">target +=</span> weights[n] * (normal_lpdf(Y[n] | mu[n], sigma));</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// priors including constants</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> normal_lpdf(b | <span class="dv">0</span>, <span class="fl">2.5</span>);</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> student_t_lpdf(Intercept | <span class="dv">3</span>, <span class="dv">0</span>, <span class="fl">2.5</span>);</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> student_t_lpdf(sigma | <span class="dv">3</span>, <span class="dv">0</span>, <span class="fl">14.8</span>)</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    - <span class="dv">1</span> * student_t_lccdf(<span class="dv">0</span> | <span class="dv">3</span>, <span class="dv">0</span>, <span class="fl">14.8</span>);</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p><strong>Change 4</strong>: And finally in the <code>generated quantities</code> block, add the <code>add_iter()</code> function so that the iteration counter increases by one at the end of the draw.</p>
<div class="columns column-screen-inset-right">
<div class="column first-block" style="width:45%;">
<div class="sourceCode" id="cb13"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Original block</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="kw">generated quantities</span> {</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// actual population-level intercept</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> b_Intercept = Intercept - dot_product(means_X, b);</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div><div class="column" style="width:45%;">
<div class="sourceCode" id="cb14"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Modified block</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co">// ADD 1 LINE</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="kw">generated quantities</span> {</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// actual population-level intercept</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> b_Intercept = Intercept - dot_product(means_X, b);</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  add_iter();  <span class="co">// update the counter each iteration --  ~*~THIS IS NEW~*~</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section><section id="define-c-functions-for-the-counter" class="level3"><h3 class="anchored" data-anchor-id="define-c-functions-for-the-counter">Define C++ functions for the counter</h3>
<p>Before compiling this and running our shiny new model, we need to officially define our two new functions for keeping track of the MCMC iteration: <code>add_iter()</code> and <code>get_iter()</code>. We need to do this with C++ (But don’t worry if you’ve never touched C++ before! This is my first time using it too!). Create a file named <code>iterfuns.hpp</code> (or whatever you want to call it) with this in it:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>iterfuns.hpp</strong></pre>
</div>
<div class="sourceCode" id="cb15" data-filename="iterfuns.hpp"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Declare an integer to keep track of the iteration count</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="at">static</span> <span class="dt">int</span> itct <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Increment the counter</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="kw">inline</span> <span class="dt">void</span> add_iter<span class="op">(</span><span class="bu">std::</span>ostream<span class="op">*</span> <span class="va">pstream__</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  itct <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Retrieve the current count</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="kw">inline</span> <span class="dt">int</span> get_iter<span class="op">(</span><span class="bu">std::</span>ostream<span class="op">*</span> <span class="va">pstream__</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> itct<span class="op">;</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>When we compile the Stan code, we’ll inject this C++ code into it and our <code>add_iter()</code> and <code>get_iter()</code> functions will work.</p>
</section><section id="compile-the-stan-code" class="level3"><h3 class="anchored" data-anchor-id="compile-the-stan-code">Compile the Stan code</h3>
<p>Before running the model and creating a bunch of MCMC chains, we need to compile this Stan code into a binary program that we can then use for MCMC. This is the same thing that happens when you use <code>brms()</code> and wait for a few seconds while it says <code>Compiling Stan program...</code>.</p>
<p>Technically we can do this by passing the file name of our modified Stan code to <code>stan_model()</code>, but <strong>rstan</strong> and/or Stan does stuff behind the scenes (storing compiled programs in <code>/tmp</code> or as hidden files somewhere on the computer) for caching purposes, and it can store older (and incorrect) versions of compiled models that can be hard to track down and get rid of. According to the documentation of <code>stan_model()</code>, we can force Stan to recompile the model every time and avoid this caching headache (it’s seriously a headache!) by first explicitly converting the Stan code to C++ with <code>stanc()</code>, and then passing <em>that</em> code to <code>stan_model()</code>.</p>
<p>So to avoid caching issues, we’ll do this in two steps. First we’ll convert our modified Stan code to C++. The <code>allow_undefined = TRUE</code> option here is necessary because <code>add_iter()</code> and <code>get_iter()</code> are defined in an external file and Stan will complain because they’re not formally defined here (similar to why RStudio complains).</p>
<p>Then we’ll feed this converted code to <code>stan_model()</code> and inject the C++ file with the counter functions in it. To reference an external file in C++, we have to include a line that looks like this:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">"/full/path/to/iterfuns.hpp"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Instead of hand-typing that, we’ll use <code>here()</code> from the <strong>here</strong> package to automatically generate the absolute path, along with some extra newlines (<code>\n</code>).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Convert the modified Stan code to C++</span></span>
<span><span class="va">outcome_c</span> <span class="op">&lt;-</span> <span class="fu">stanc</span><span class="op">(</span><span class="st">"modified_stan_code.stan"</span>,</span>
<span>                   allow_undefined <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compile C++ified Stan to a binary model object</span></span>
<span><span class="va">outcome_model</span> <span class="op">&lt;-</span> <span class="fu">stan_model</span><span class="op">(</span></span>
<span>  stanc_ret <span class="op">=</span> <span class="va">outcome_c</span>, </span>
<span>  includes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">'\n#include "'</span>, <span class="fu">here</span><span class="op">(</span><span class="st">'iterfuns.hpp'</span><span class="op">)</span>, <span class="st">'"\n'</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>After a few seconds, we should have a new <code>outcome_model</code> object. This doesn’t contain any results or chains or anything. This is essentially a mini standalone program that’s designed to take our nets data, our weights, and the priors that we specified.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Fun fact
</div>
</div>
<div class="callout-body-container callout-body">
<p>This is essentially the difference between <strong>brms</strong> and <strong>rstanarm</strong>. <strong>rstanarm</strong> comes with a bunch of pre-compiled model programs like <code>stan_glm()</code>, so you don’t have to compile anything yourself ever—you don’t need to wait for the <code>Compiling Stan program...</code> message to finish like you do with <strong>brms</strong>. But that extra pre-compiled speed comes at the cost of flexibility—you can’t run as many models or do as many neat extra things with <strong>rstanarm</strong> as you can with <strong>brms</strong>.</p>
</div>
</div>
</section><section id="run-the-model" class="level3"><h3 class="anchored" data-anchor-id="run-the-model">Run the model</h3>
<p>Finally, we can feed our data into the <code>outcome_model</code> object and run the MCMC chains. Unlike <strong>brms</strong>, we can’t just feed it a formula and a data frame. Instead, we need to feed this model a list with each of the variables we declared in the data block of our code. The syntax is a little wonky, and the best way to get a feel for how this list needs to be structured is to use <code>make_standata()</code> and follow the same structure.</p>
<p>Importantly, we need to use at least the same number of posterior chains as we have weights for (i.e.&nbsp;we can’t have 2,000 sets of weights and use 8,000 chains in the outcome model since we’ll run out of weights). Here we’ll use the same amount (2,000 per chain, only 1,000 of which are kept due to the warmup phase).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Make a dataset of all the covariates and an intercept column</span></span>
<span><span class="va">outcome_covariates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">net_num</span>, data <span class="op">=</span> <span class="va">nets</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">outcome_covariates</span><span class="op">)</span></span>
<span><span class="co">##   (Intercept) net_num</span></span>
<span><span class="co">## 1           1       1</span></span>
<span><span class="co">## 2           1       0</span></span>
<span><span class="co">## 3           1       0</span></span>
<span><span class="co">## 4           1       1</span></span>
<span><span class="co">## 5           1       0</span></span>
<span><span class="co">## 6           1       0</span></span>
<span></span>
<span><span class="co"># Make a list of all the required pieces for the data block in the Stan model</span></span>
<span><span class="va">outcome_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  N <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">nets</span><span class="op">)</span>,</span>
<span>  Y <span class="op">=</span> <span class="va">nets</span><span class="op">$</span><span class="va">malaria_risk</span>,</span>
<span>  K <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">outcome_covariates</span><span class="op">)</span>,</span>
<span>  X <span class="op">=</span> <span class="va">outcome_covariates</span>,</span>
<span>  L <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">ipw_matrix</span><span class="op">)</span>,</span>
<span>  IPW <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">ipw_matrix</span><span class="op">)</span>,</span>
<span>  prior_only <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">outcome_data</span><span class="op">)</span></span>
<span><span class="co">## List of 7</span></span>
<span><span class="co">##  $ N         : int 1752</span></span>
<span><span class="co">##  $ Y         : num [1:1752] 33 42 80 34 44 25 19 35 32 40 ...</span></span>
<span><span class="co">##  $ K         : int 2</span></span>
<span><span class="co">##  $ X         : num [1:1752, 1:2] 1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">##   ..- attr(*, "dimnames")=List of 2</span></span>
<span><span class="co">##   .. ..$ : chr [1:1752] "1" "2" "3" "4" ...</span></span>
<span><span class="co">##   .. ..$ : chr [1:2] "(Intercept)" "net_num"</span></span>
<span><span class="co">##   ..- attr(*, "assign")= int [1:2] 0 1</span></span>
<span><span class="co">##  $ L         : int 8000</span></span>
<span><span class="co">##  $ IPW       : num [1:1752, 1:8000] 2.49 1.7 1.22 3.64 1.44 ...</span></span>
<span><span class="co">##   ..- attr(*, "dimnames")=List of 2</span></span>
<span><span class="co">##   .. ..$ : NULL</span></span>
<span><span class="co">##   .. ..$ : chr [1:8000] "...1" "...2" "...3" "...4" ...</span></span>
<span><span class="co">##  $ prior_only: num 0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/run-final-model_af43c27a26530509f9dffb10c3f13c69">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># FINALLY run the model!</span></span>
<span><span class="va">outcome_samples</span> <span class="op">&lt;-</span> <span class="fu">sampling</span><span class="op">(</span></span>
<span>  <span class="va">outcome_model</span>, </span>
<span>  data <span class="op">=</span> <span class="va">outcome_data</span>, </span>
<span>  chains <span class="op">=</span> <span class="fl">8</span>, </span>
<span>  iter <span class="op">=</span> <span class="fl">2000</span>,</span>
<span>  cores <span class="op">=</span> <span class="fl">8</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">1234</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="analyze-the-results" class="level2"><h2 class="anchored" data-anchor-id="analyze-the-results">Analyze the results</h2>
<p>The results from <code>rstan::sampling()</code> behave pretty similarly to the output from <strong>rstanarm</strong> or <strong>brms</strong> (which isn’t surprising, since both of those packages are just fancier frontends for Stan). We can print the results, for instance:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">outcome_samples</span><span class="op">)</span></span>
<span><span class="co">## Inference for Stan model: modified_stan_code.</span></span>
<span><span class="co">## 8 chains, each with iter=2000; warmup=1000; thin=1; </span></span>
<span><span class="co">## post-warmup draws per chain=1000, total post-warmup draws=8000.</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##                 mean se_mean     sd     2.5%      25%      50%       75%     97.5% n_eff Rhat</span></span>
<span><span class="co">## b[1]            -9.8    0.01   1.06    -12.0    -10.4     -9.8     -9.16     -7.66  8120    1</span></span>
<span><span class="co">## Intercept       35.7    0.00   0.25     35.2     35.5     35.7     35.87     36.19  3020    1</span></span>
<span><span class="co">## sigma           13.8    0.00   0.22     13.4     13.7     13.8     13.92     14.22  3991    1</span></span>
<span><span class="co">## b_Intercept     39.5    0.01   0.47     38.6     39.2     39.5     39.81     40.46  5295    1</span></span>
<span><span class="co">## lp__        -14315.3    2.01 183.11 -14727.6 -14418.5 -14298.7 -14185.22 -14009.48  8325    1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Samples were drawn using NUTS(diag_e) at Mon Nov 28 15:17:32 2022.</span></span>
<span><span class="co">## For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">## and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">## convergence, Rhat=1).</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Or we can use <code>tidy()</code> from <strong>broom.mixed</strong>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tidy</span><span class="op">(</span><span class="va">outcome_samples</span>, conf.int <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 4 × 5</span></span>
<span><span class="co">##   term        estimate std.error conf.low conf.high</span></span>
<span><span class="co">##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 b[1]           -9.80     1.06     -12.0     -7.66</span></span>
<span><span class="co">## 2 Intercept      35.7      0.253     35.2     36.2 </span></span>
<span><span class="co">## 3 sigma          13.8      0.216     13.4     14.2 </span></span>
<span><span class="co">## 4 b_Intercept    39.5      0.470     38.6     40.5</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The coefficients aren’t nicely named and separated into fixed and random effects like they are in <strong>brms</strong> output, but we can still get the results out (and <a href="https://discourse.mc-stan.org/t/recovering-coefficient-names/12598">we could rename them in the model if we wanted</a>, or we can do that on our own as we work with the data). The main coefficient we care about here is the one for <code>net</code>, or <code>b[1]</code>. Based on this Bayesian outcome model, after incorporating the uncertainty from the posterior distribution of inverse probability weights, the ATE of using a net is -9.8, with an error of 1.06.</p>
<p>This is so cool! At the end of the previous post, after running 2,000 frequentist models and combining the ATEs and standard errors, we ended up with these results:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># ----------------------------------------------------------------------------------------------</span></span>
<span><span class="co"># Excerpt from https://www.andrewheiss.com/blog/2021/12/18/bayesian-propensity-scores-weights/</span></span>
<span><span class="co"># ----------------------------------------------------------------------------------------------</span></span>
<span><span class="co"># Combined average treatment effect</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">outcome_models</span><span class="op">$</span><span class="va">ate</span><span class="op">)</span></span>
<span><span class="co">## [1] -10.1</span></span>
<span></span>
<span><span class="co"># Combined standard errors with Rubin's rules (this is correct)</span></span>
<span><span class="fu">rubin_se</span><span class="op">(</span><span class="va">outcome_models</span><span class="op">$</span><span class="va">ate</span>, <span class="va">outcome_models</span><span class="op">$</span><span class="va">ate_se</span><span class="op">)</span></span>
<span><span class="co">## [1] 1.01</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We get comparable results with this Bayesian outcome model, only now we get to do fun Bayesian inference with the results!</p>
<p>Instead of confidence intervals, we have credible intervals: given the data we have, there’s a 95% chance that the ATE is between -12.01 and -7.66. We can see this in the posterior distribution of the ATE:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Make a long, tidy data frame of the posterior draws</span></span>
<span><span class="va">outcome_tidy</span> <span class="op">&lt;-</span> <span class="va">outcome_samples</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">tidy_draws</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">rename</span><span class="op">(</span>ate <span class="op">=</span> <span class="va">`b[1]`</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">outcome_tidy</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">ate</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_slab</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill_ramp <span class="op">=</span> <span class="fu">after_stat</span><span class="op">(</span><span class="fu">cut_cdf_qi</span><span class="op">(</span><span class="va">cdf</span>, .width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.02</span>, <span class="fl">0.8</span>, <span class="fl">0.95</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            fill <span class="op">=</span> <span class="va">egypt</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_ramp_discrete</span><span class="op">(</span>range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.2</span><span class="op">)</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Average treatment effect of using a mosquito net"</span>, y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>       caption <span class="op">=</span> <span class="st">"Median shown with vertical line; 80% and 95% credible intervals shown with shading"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-ate-posterior-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>We can calculate the proportion of this posterior distribution that is less than zero to find the <a href="https://easystats.github.io/bayestestR/articles/probability_of_direction.html"><em>probability of direction</em></a>, or the probability that the ATE is negative:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Find the proportion of posterior draws that are less than 0</span></span>
<span><span class="va">outcome_tidy</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>prop_lessthan_0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">ate</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">/</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 1 × 1</span></span>
<span><span class="co">##   prop_lessthan_0</span></span>
<span><span class="co">##             &lt;dbl&gt;</span></span>
<span><span class="co">## 1               1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Not surprisingly, given the distribution we saw above, there’s a 100% chance that the ATE is negative.</p>
<p>We can also calculate the proportion of the posterior distribution that falls within a <a href="https://easystats.github.io/bayestestR/articles/region_of_practical_equivalence.html"><em>region of practical equivalence</em> (or ROPE)</a>. We can think of this as a “dead zone” of sorts. If the ATE is 0, we know for sure that there’s no effect. If the ATE is something small like -0.51 or 0.73, we probably don’t actually care—that’s not a huge effect and could just be because of measurement error. If the ATE is sizable and far away from this “dead zone” / ROPE, we can be pretty confident of the substantiality of the effect.</p>
<p>There are a lot of ways to determine the size of the ROPE. You can base it on experience with the phenomenon (e.g.&nbsp;you’re an expert in public health and know that a 1-2 point change in malaria risk scores is small, while a 10+ change is big), or you can base it on the data you have (like <code>0.1 * sd(outcome)</code>, <a href="https://easystats.github.io/bayestestR/articles/region_of_practical_equivalence.html#how-to-define-the-rope-range-">which is a common approach</a>).</p>
<p>For this example, we’ll pretend that any effect between −7 and 7 doesn’t matter—for an expert, values like 2.4 or −6 would be negligible. This is a <strong><em>huge</em></strong> ROPE, by the way! If we follow the 0.1 × the standard deviation of the outcome rule, the ROPE should only be ±<code>0.1 * sd(nets$malaria_risk)</code>, or ±1.546. I’m using ±7 here just for the sake of illustration—I want to see the ROPE on the plot :)</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Find the proportion of posterior draws that are less than 0</span></span>
<span><span class="va">prop_outside</span> <span class="op">&lt;-</span> <span class="va">outcome_tidy</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>prop_outside_rope <span class="op">=</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">ate</span> <span class="op">&gt;=</span> <span class="op">-</span><span class="fl">7</span> <span class="op">&amp;</span> <span class="va">ate</span> <span class="op">&lt;=</span> <span class="fl">7</span><span class="op">)</span> <span class="op">/</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">prop_outside</span></span>
<span><span class="co">## # A tibble: 1 × 1</span></span>
<span><span class="co">##   prop_outside_rope</span></span>
<span><span class="co">##               &lt;dbl&gt;</span></span>
<span><span class="co">## 1             0.992</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">outcome_tidy</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">ate</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill_ramp <span class="op">=</span> <span class="fu">after_stat</span><span class="op">(</span><span class="va">x</span> <span class="op">&gt;=</span> <span class="fl">7</span> <span class="op">|</span> <span class="va">x</span> <span class="op">&lt;=</span> <span class="op">-</span><span class="fl">7</span><span class="op">)</span><span class="op">)</span>, </span>
<span>               fill <span class="op">=</span> <span class="va">egypt</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, .width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.95</span>, <span class="fl">0.8</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_ramp_discrete</span><span class="op">(</span>from <span class="op">=</span> <span class="va">egypt</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">annotate</span><span class="op">(</span>geom <span class="op">=</span> <span class="st">"rect"</span>, xmin <span class="op">=</span> <span class="op">-</span><span class="fl">7</span>, xmax <span class="op">=</span> <span class="fl">0</span>, ymin <span class="op">=</span> <span class="op">-</span><span class="cn">Inf</span>, ymax <span class="op">=</span> <span class="cn">Inf</span>, </span>
<span>           fill <span class="op">=</span> <span class="va">egypt</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">annotate</span><span class="op">(</span>geom <span class="op">=</span> <span class="st">"label"</span>, x <span class="op">=</span> <span class="op">-</span><span class="fl">3.5</span>, y <span class="op">=</span> <span class="fl">0.75</span>, label <span class="op">=</span> <span class="st">"ROPE\n(dead zone)\n0 ± 7"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Average treatment effect of using a mosquito net"</span>, y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>       caption <span class="op">=</span> <span class="st">"Median shown with point; 80% and 95% credible intervals shown with black bars"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-rope-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>Using a gigantic ROPE of 0±7 malaria risk points, we can see that 99.2% of the posterior distribution lies outside the region of practical equivalence, which provides pretty strong evidence of a nice big ATE. This program definitely has an effect! (It’s fake data! I made sure it had an effect!)</p>
</section><section id="using-the-results-with-brms" class="level2"><h2 class="anchored" data-anchor-id="using-the-results-with-brms">Using the results with <strong>brms</strong>
</h2>
<p>One issue with using <code>rstan::sampling()</code> instead of <strong>brms</strong> is that we can’t do nice things like automatic extraction of posterior expectations or predictions, since the MCMC samples we have are a <code>stanfit</code> object and not a <code>stanreg</code> object (which is what both <strong>rstanarm</strong> and <strong>brms</strong> produce):</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">posterior_epred</span><span class="op">(</span><span class="va">outcome_samples</span><span class="op">)</span></span>
<span><span class="co">## Error in UseMethod("posterior_epred"): no applicable method for 'posterior_epred' applied to an object of class "stanfit"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>However, it is possible to <a href="https://github.com/paul-buerkner/brms/issues/682#issuecomment-501304142">create an empty <strong>brms</strong> object and stick the MCMC samples we made</a> with <code>rstan::sampling()</code> into it, which then allows us to do anything a regular <strong>brms</strong> model can do! This <a href="https://discourse.mc-stan.org/t/creating-a-brmsfit-object-with-a-modified-brms-generated-stan-model/6840/2">only works when making minimal changes to the Stan code</a>—we can’t modify the likelihood (or the <code>target</code> part of the <code>model</code> block of the Stan code). We didn’t touch this part, though, so we can safely stick these samples into a <strong>brms</strong> object.</p>
<p>To do this, we first have to create an empty model by using the <code>empty = TRUE</code> argument. We also have to create a placeholder weights column, even though we’re not actually fitting the model—<strong>brms</strong> will complain otherwise.</p>
<p>We can then assign the <code>outcome_samples</code> object to the <code>$fit</code> slot of the empty model. Finally, we have to change the coefficient names to be nicer and compatible with <strong>brms</strong>. Note how earlier the coefficient for <code>net_num</code> was named <code>b[1]</code>, which was inconvenient. By using <code>brms::rename_pars()</code>, we can change those subscripted/indexed names into nice names again.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Placeholder outcome model</span></span>
<span><span class="va">outcome_brms</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span><span class="fu">bf</span><span class="op">(</span><span class="va">malaria_risk</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/stats/weights.html">weights</a></span><span class="op">(</span><span class="va">iptw</span><span class="op">)</span> <span class="op">~</span> <span class="va">net_num</span><span class="op">)</span>,</span>
<span>    <span class="co"># brms needs a column for the weights, even though we're not</span></span>
<span>    <span class="co"># fitting the model, so create a placeholder column of 1s</span></span>
<span>    data <span class="op">=</span> <span class="va">nets</span> <span class="op">%&gt;%</span> <span class="fu">mutate</span><span class="op">(</span>iptw <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>    empty <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add the samples from rstan::sampling() into the empty brms object and fix the</span></span>
<span><span class="co"># coefficient names (i.e. b[1] → b_net_num)</span></span>
<span><span class="va">outcome_brms</span><span class="op">$</span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="va">outcome_samples</span></span>
<span><span class="va">outcome_brms</span> <span class="op">&lt;-</span> <span class="fu">rename_pars</span><span class="op">(</span><span class="va">outcome_brms</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>outcome_brms</code> object is now just like any regular <strong>brms</strong> model, and everything works with it:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># It works!</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">outcome_brms</span><span class="op">)</span></span>
<span><span class="co">##  Family: gaussian </span></span>
<span><span class="co">##   Links: mu = identity; sigma = identity </span></span>
<span><span class="co">## Formula: malaria_risk | weights(iptw) ~ net_num </span></span>
<span><span class="co">##    Data: nets %&gt;% mutate(iptw = 1) (Number of observations: 1752) </span></span>
<span><span class="co">##   Draws: 8 chains, each with iter = 2000; warmup = 1000; thin = 1;</span></span>
<span><span class="co">##          total post-warmup draws = 8000</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Population-Level Effects: </span></span>
<span><span class="co">##           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span><span class="co">## Intercept    39.51      0.47    38.59    40.46 1.00     5341     6208</span></span>
<span><span class="co">## net_num      -9.80      1.06   -12.01    -7.66 1.00     8048     6964</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Family Specific Parameters: </span></span>
<span><span class="co">##       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span><span class="co">## sigma    13.79      0.22    13.37    14.22 1.00     3986     4864</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS</span></span>
<span><span class="co">## and Tail_ESS are effective sample size measures, and Rhat is the potential</span></span>
<span><span class="co">## scale reduction factor on split chains (at convergence, Rhat = 1).</span></span>
<span></span>
<span><span class="co"># Predicted values work</span></span>
<span><span class="va">epreds</span> <span class="op">&lt;-</span> <span class="fu">posterior_epred</span><span class="op">(</span><span class="va">outcome_brms</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">epreds</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">##      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10]</span></span>
<span><span class="co">## [1,] 30.3 39.1 39.1 30.3 39.1 39.1 30.3 39.1 39.1  39.1</span></span>
<span><span class="co">## [2,] 30.1 39.1 39.1 30.1 39.1 39.1 30.1 39.1 39.1  39.1</span></span>
<span><span class="co">## [3,] 30.1 39.2 39.2 30.1 39.2 39.2 30.1 39.2 39.2  39.2</span></span>
<span><span class="co">## [4,] 29.5 39.8 39.8 29.5 39.8 39.8 29.5 39.8 39.8  39.8</span></span>
<span><span class="co">## [5,] 30.0 39.4 39.4 30.0 39.4 39.4 30.0 39.4 39.4  39.4</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># posterior predictive checks work!</span></span>
<span><span class="fu">pp_check</span><span class="op">(</span><span class="va">outcome_brms</span><span class="op">)</span></span>
<span><span class="co">## Using 10 posterior draws for ppc type 'dens_overlay' by default.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/ppcheck-brms-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># emmeans works too!</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rvlenth.github.io/emmeans/">emmeans</a></span><span class="op">)</span></span>
<span><span class="va">outcome_brms</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">emtrends</span><span class="op">(</span><span class="op">~</span><span class="va">net_num</span>, var <span class="op">=</span> <span class="st">"net_num"</span><span class="op">)</span></span>
<span><span class="co">##  net_num net_num.trend lower.HPD upper.HPD</span></span>
<span><span class="co">##        0          -9.8       -12     -7.65</span></span>
<span><span class="co">##        1          -9.8       -12     -7.65</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Point estimate displayed: median </span></span>
<span><span class="co">## HPD interval probability: 0.95</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="only-tiny-downside" class="level2"><h2 class="anchored" data-anchor-id="only-tiny-downside">Only tiny downside</h2>
<p>There’s just one minor issue with this approach: all the sampling has to be done with <strong>rstan</strong>. For whatever reason, <strong>cmdstanr</strong> doesn’t like the iteration tracking functions and it crashes. This might be because <a href="https://discourse.mc-stan.org/t/custom-c-using-cmdstanr/19528/7"><strong>cmdstanr</strong> is pickier about C++ namespaces</a>? I’m not sure. If it did work, the code would look something like this:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">cmdstanr</span><span class="op">)</span></span>
<span></span>
<span><span class="va">outcome_model_cmdstanr</span> <span class="op">&lt;-</span> <span class="fu">cmdstan_model</span><span class="op">(</span></span>
<span>  stan_file <span class="op">=</span> <span class="st">"modified_stan_code.stan"</span>,</span>
<span>  cpp_options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>USER_HEADER <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">'iterfuns.hpp'</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  stanc_options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"allow-undefined"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">outcome_samples_cmdstanr</span> <span class="op">&lt;-</span> <span class="va">outcome_model_cmdstanr</span><span class="op">$</span><span class="fu">sample</span><span class="op">(</span>data <span class="op">=</span> <span class="va">outcome_data</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In spite of this, being able to use Bayesian models in both the treatment/design stage and the outcome/analysis stage is incredibly powerful!</p>
</section><section id="references" class="level2">


<!-- -->


</section><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-LiaoZigler:2020" class="csl-entry" role="listitem">
Liao, Shirley X., and Corwin M. Zigler. 2020. <span>“Uncertainty in the Design Stage of Two-Stage Bayesian Propensity Score Analysis.”</span> <em>Statistics in Medicine</em> 39 (17): 2265–90. <a href="https://doi.org/10.1002/sim.8486">https://doi.org/10.1002/sim.8486</a>.
</div>
</div></section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{heiss2021,
  author = {Heiss, Andrew},
  title = {How to Create a(n Almost) Fully {Bayesian} Outcome Model with
    Inverse Probability Weights},
  date = {2021-12-20},
  url = {https://www.andrewheiss.com/blog/2021/12/20/fully-bayesian-ate-iptw/},
  doi = {10.59350/gyvjk-hrx68},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-heiss2021" class="csl-entry quarto-appendix-citeas" role="listitem">
Heiss, Andrew. 2021. <span>“How to Create a(n Almost) Fully Bayesian
Outcome Model with Inverse Probability Weights.”</span> December 20,
2021. <a href="https://doi.org/10.59350/gyvjk-hrx68">https://doi.org/10.59350/gyvjk-hrx68</a>.
</div></div></section></div></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/www\.andrewheiss\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><script src="https://giscus.app/client.js" data-repo="andrewheiss/ath-quarto" data-repo-id="R_kgDOIg6EJQ" data-category="Blog comments" data-category-id="DIC_kwDOIg6EJc4CSz92" data-mapping="pathname" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script><input type="hidden" id="giscus-base-theme" value="light"><input type="hidden" id="giscus-alt-theme" value="dark"><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb34" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "How to create a(n almost) fully Bayesian outcome model with inverse probability weights"</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> 2021-12-20</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="an">description:</span><span class="co"> "Use a posterior distribution of inverse probability weights in a Bayesian outcome model to conduct (nearly) fully Bayesian causal inference with R, brms, and Stan"</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="an">image:</span><span class="co"> index_files/figure-html/plot-ate-posterior-1.png</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="an">engine:</span><span class="co"> knitr</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="co">  - r</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a><span class="co">  - tidyverse</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a><span class="co">  - regression</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a><span class="co">  - statistics</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a><span class="co">  - data visualization</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a><span class="co">  - causal inference</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a><span class="co">  - do calculus</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a><span class="co">  - DAGs</span></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a><span class="co">  - bayes</span></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a><span class="co">  - brms</span></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a><span class="co">  - stan</span></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a><span class="an">doi:</span><span class="co"> 10.59350/gyvjk-hrx68</span></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a><span class="an">citation:</span><span class="co"> true</span></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a><span class="in">```{css, echo=FALSE}</span></span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a><span class="in">.first-block {</span></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a><span class="in">    padding-right: 10px;</span></span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setup, include=FALSE}</span></span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::opts_chunk$set(fig.align = "center", fig.retina = 3,</span></span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a><span class="in">                      fig.width = 6, fig.height = (6 * 0.618),</span></span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a><span class="in">                      out.width = "90%", collapse = TRUE)</span></span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a><span class="in">options(digits = 3, width = 110)</span></span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true" tabindex="-1"></a>::: {.callout-important}</span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true" tabindex="-1"></a><span class="fu">### Read the previous post first!</span></span>
<span id="cb34-38"><a href="#cb34-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-39"><a href="#cb34-39" aria-hidden="true" tabindex="-1"></a>This post is a sequel to &lt;a href="https://www.andrewheiss.com/blog/2021/12/18/bayesian-propensity-scores-weights/"&gt;the previous one on Bayesian propensity scores&lt;/a&gt; and won't make a lot of sense without reading that one first. Read that one first!</span>
<span id="cb34-40"><a href="#cb34-40" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb34-41"><a href="#cb34-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-42"><a href="#cb34-42" aria-hidden="true" tabindex="-1"></a>In <span class="co">[</span><span class="ot">my previous post about how to create Bayesian propensity scores</span><span class="co">](https://www.andrewheiss.com/blog/2021/12/18/bayesian-propensity-scores-weights/)</span> and how to legally use them in a second stage outcome model, I ended up using <span class="co">[</span><span class="ot">frequentist models for the outcome stage</span><span class="co">](https://www.andrewheiss.com/blog/2021/12/18/bayesian-propensity-scores-weights/#a-legal-way-to-use-weights-bayesianly)</span>. I did this for the sake of computational efficiency—running 2,000 models with <span class="in">`lm()`</span> is way faster than running 2,000 individual Bayesian models with <span class="in">`brm()`</span> from **brms** (like, creating 2,000 Bayesian models could take hours or days or weeks!)</span>
<span id="cb34-43"><a href="#cb34-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-44"><a href="#cb34-44" aria-hidden="true" tabindex="-1"></a>I concluded with <span class="co">[</span><span class="ot">this paragraph</span><span class="co">](https://www.andrewheiss.com/blog/2021/12/18/bayesian-propensity-scores-weights/#things-i-dont-know-yet-but-want-to-know)</span>:</span>
<span id="cb34-45"><a href="#cb34-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-46"><a href="#cb34-46" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; We could technically run a Bayesian outcome model with </span><span class="in">`brm()`</span><span class="at">, but we'd have to run it 2,000 times—one model per set of weights—and that would take literally forever and might melt my computer. There could be a way to only run a single outcome model once and use one set of weights for each of the iterations (i.e. use the first column of propensity scores for the first iteration of the outcome model, the second for the second, and so on), but that goes beyond my skills with **brms**.</span></span>
<span id="cb34-47"><a href="#cb34-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-48"><a href="#cb34-48" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">Jordan Nafa</span><span class="co">](https://twitter.com/adamjnafa)</span> took on this challenge, though, and figured out a way to do exactly this with Stan!! He has a <span class="co">[</span><span class="ot">super well-documented example at GitHub</span><span class="co">](https://github.com/ajnafa/Bayesian-IPW)</span>, and I've adapted and borrowed liberally from his code for this post. **Check out his example for additional updates and even more fantastic explanation!**</span>
<span id="cb34-49"><a href="#cb34-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-50"><a href="#cb34-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-51"><a href="#cb34-51" aria-hidden="true" tabindex="-1"></a><span class="fu">## The intuition</span></span>
<span id="cb34-52"><a href="#cb34-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-53"><a href="#cb34-53" aria-hidden="true" tabindex="-1"></a>After creating a treatment model in the design stage (i.e. predicting net usage based on the confounders), we generate a matrix of propensity scores or inverse probability weights ($\nu$ in @LiaoZigler:2020's approach). Each column of this matrix contains one posterior draw of propensity scores or weights. </span>
<span id="cb34-54"><a href="#cb34-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-55"><a href="#cb34-55" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">In my original post</span><span class="co">](https://www.andrewheiss.com/blog/2021/12/18/bayesian-propensity-scores-weights/#a-legal-way-to-use-weights-bayesianly)</span>, we generated 2,000 sets of propensity scores and then ran 2,000 outcome models with <span class="in">`lm()`</span> to calculate the average treatment effect (ATE).</span>
<span id="cb34-56"><a href="#cb34-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-57"><a href="#cb34-57" aria-hidden="true" tabindex="-1"></a>**brms** allows you to use weights with a slightly different syntax from <span class="in">`lm()`</span>: </span>
<span id="cb34-58"><a href="#cb34-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-59"><a href="#cb34-59" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb34-60"><a href="#cb34-60" aria-hidden="true" tabindex="-1"></a><span class="fu">brm</span>(<span class="fu">bf</span>(outcome <span class="sc">|</span> <span class="fu">weights</span>(iptw) <span class="sc">~</span> treatment), <span class="at">data =</span> whatever)</span>
<span id="cb34-61"><a href="#cb34-61" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb34-62"><a href="#cb34-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-63"><a href="#cb34-63" aria-hidden="true" tabindex="-1"></a>The argument we feed to <span class="in">`weights()`</span> needs to be a column in the data that we're working with (like <span class="in">`iptw`</span> here for the inverse probability weights).</span>
<span id="cb34-64"><a href="#cb34-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-65"><a href="#cb34-65" aria-hidden="true" tabindex="-1"></a>Since it's not really feasible to run thousands of separate Bayesian models, we can instead run the outcome model once and feed one set of weights for each MCMC iteration. Conceptually, we want to do something like this:</span>
<span id="cb34-66"><a href="#cb34-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-67"><a href="#cb34-67" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Outcome model posterior draw 1: <span class="in">`bf(outcome | weights(iptw[,1]) ~ treatment)`</span></span>
<span id="cb34-68"><a href="#cb34-68" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Outcome model posterior draw 2: <span class="in">`bf(outcome | weights(iptw[,2]) ~ treatment)`</span></span>
<span id="cb34-69"><a href="#cb34-69" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Outcome model posterior draw 3: <span class="in">`bf(outcome | weights(iptw[,3]) ~ treatment)`</span></span>
<span id="cb34-70"><a href="#cb34-70" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>(and so on)</span>
<span id="cb34-71"><a href="#cb34-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-72"><a href="#cb34-72" aria-hidden="true" tabindex="-1"></a>Each posterior draw thus gets its own set of weights, and all the draws are combined in the end as a single posterior distribution of the average treatment effect.</span>
<span id="cb34-73"><a href="#cb34-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-74"><a href="#cb34-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-75"><a href="#cb34-75" aria-hidden="true" tabindex="-1"></a><span class="fu">## Using a matrix of weights with raw Stan code</span></span>
<span id="cb34-76"><a href="#cb34-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-77"><a href="#cb34-77" aria-hidden="true" tabindex="-1"></a>Unfortunately **brms** [can't handle a matrix of weights](https://discourse.mc-stan.org/t/how-to-update-a-brmsfit-object-with-a-modified-brms-generated-stan-model-marginalizing-over-a-distribution-of-weights/7567). The `weights()` term in the model formula can only take a single column—it can't iterate through a bunch of columns in a matrix. This is sad because it means we have to leave the comfort and convenience of **brms** and work with Stan code directly.</span>
<span id="cb34-78"><a href="#cb34-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-79"><a href="#cb34-79" aria-hidden="true" tabindex="-1"></a>Fortunately, **brms** makes it easy to work with raw Stan and does most of the hard work for us. The <span class="in">`make_stancode()`</span> function will convert a <span class="in">`brms`</span>-based model into Stan code that we can then edit and tinker with.</span>
<span id="cb34-80"><a href="#cb34-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-81"><a href="#cb34-81" aria-hidden="true" tabindex="-1"></a>Here's how we can do it (again with heavily annotated code from <span class="co">[</span><span class="ot">Jordan Nafa's phenomenal example of how this all works</span><span class="co">](https://github.com/ajnafa/Bayesian-IPW)</span>):</span>
<span id="cb34-82"><a href="#cb34-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-83"><a href="#cb34-83" aria-hidden="true" tabindex="-1"></a><span class="in">```{r libraries-functions, warning=FALSE, message=FALSE}</span></span>
<span id="cb34-84"><a href="#cb34-84" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidyverse)    # ggplot2, dplyr, %&gt;%, and friends</span></span>
<span id="cb34-85"><a href="#cb34-85" aria-hidden="true" tabindex="-1"></a><span class="in">library(brms)         # Nice interface for Bayesian models through Stan</span></span>
<span id="cb34-86"><a href="#cb34-86" aria-hidden="true" tabindex="-1"></a><span class="in">library(rstan)        # For running Stan through R</span></span>
<span id="cb34-87"><a href="#cb34-87" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidybayes)    # For dealing with MCMC draws in a tidy way</span></span>
<span id="cb34-88"><a href="#cb34-88" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggdist)       # For distribution-related geoms</span></span>
<span id="cb34-89"><a href="#cb34-89" aria-hidden="true" tabindex="-1"></a><span class="in">library(broom.mixed)  # For converting Stan-based model results to data frames</span></span>
<span id="cb34-90"><a href="#cb34-90" aria-hidden="true" tabindex="-1"></a><span class="in">library(here)         # Convenient way for locating files</span></span>
<span id="cb34-91"><a href="#cb34-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-92"><a href="#cb34-92" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(6348)  # From random.org</span></span>
<span id="cb34-93"><a href="#cb34-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-94"><a href="#cb34-94" aria-hidden="true" tabindex="-1"></a><span class="in"># Use the Egypt palette from the MetBrewer package</span></span>
<span id="cb34-95"><a href="#cb34-95" aria-hidden="true" tabindex="-1"></a><span class="in">egypt &lt;- MetBrewer::met.brewer("Egypt")</span></span>
<span id="cb34-96"><a href="#cb34-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-97"><a href="#cb34-97" aria-hidden="true" tabindex="-1"></a><span class="in"># Custom ggplot theme to make pretty plots</span></span>
<span id="cb34-98"><a href="#cb34-98" aria-hidden="true" tabindex="-1"></a><span class="in"># Get Archivo Narrow at https://fonts.google.com/specimen/Archivo+Narrow</span></span>
<span id="cb34-99"><a href="#cb34-99" aria-hidden="true" tabindex="-1"></a><span class="in">theme_nice &lt;- function() {</span></span>
<span id="cb34-100"><a href="#cb34-100" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_minimal(base_family = "Archivo Narrow") +</span></span>
<span id="cb34-101"><a href="#cb34-101" aria-hidden="true" tabindex="-1"></a><span class="in">    theme(panel.grid.minor = element_blank(),</span></span>
<span id="cb34-102"><a href="#cb34-102" aria-hidden="true" tabindex="-1"></a><span class="in">          plot.background = element_rect(fill = "white", color = NA),</span></span>
<span id="cb34-103"><a href="#cb34-103" aria-hidden="true" tabindex="-1"></a><span class="in">          plot.title = element_text(face = "bold"),</span></span>
<span id="cb34-104"><a href="#cb34-104" aria-hidden="true" tabindex="-1"></a><span class="in">          axis.title = element_text(face = "bold"),</span></span>
<span id="cb34-105"><a href="#cb34-105" aria-hidden="true" tabindex="-1"></a><span class="in">          strip.text = element_text(face = "bold", size = rel(0.8), hjust = 0),</span></span>
<span id="cb34-106"><a href="#cb34-106" aria-hidden="true" tabindex="-1"></a><span class="in">          strip.background = element_rect(fill = "grey80", color = NA),</span></span>
<span id="cb34-107"><a href="#cb34-107" aria-hidden="true" tabindex="-1"></a><span class="in">          legend.title = element_text(face = "bold"))</span></span>
<span id="cb34-108"><a href="#cb34-108" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb34-109"><a href="#cb34-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-110"><a href="#cb34-110" aria-hidden="true" tabindex="-1"></a><span class="in"># Use this theme on all plots</span></span>
<span id="cb34-111"><a href="#cb34-111" aria-hidden="true" tabindex="-1"></a><span class="in">theme_set(</span></span>
<span id="cb34-112"><a href="#cb34-112" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice()</span></span>
<span id="cb34-113"><a href="#cb34-113" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb34-114"><a href="#cb34-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-115"><a href="#cb34-115" aria-hidden="true" tabindex="-1"></a><span class="in"># Make all labels use Archivo by default</span></span>
<span id="cb34-116"><a href="#cb34-116" aria-hidden="true" tabindex="-1"></a><span class="in">update_geom_defaults("label",</span></span>
<span id="cb34-117"><a href="#cb34-117" aria-hidden="true" tabindex="-1"></a><span class="in">                     list(family = "Archivo Narrow",</span></span>
<span id="cb34-118"><a href="#cb34-118" aria-hidden="true" tabindex="-1"></a><span class="in">                          fontface = "bold"))</span></span>
<span id="cb34-119"><a href="#cb34-119" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb34-120"><a href="#cb34-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-121"><a href="#cb34-121" aria-hidden="true" tabindex="-1"></a>First we'll load the data (see the <span class="co">[</span><span class="ot">previous post</span><span class="co">](https://www.andrewheiss.com/blog/2021/12/18/bayesian-propensity-scores-weights/#basic-frequentist-example)</span> or <span class="co">[</span><span class="ot">my class example on inverse probability weighting</span><span class="co">](https://evalf21.classes.andrewheiss.com/example/matching-ipw/)</span> for more details about what these columns are). **Our main question here is the effect of mosquito net usage on malaria risk.**</span>
<span id="cb34-122"><a href="#cb34-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-123"><a href="#cb34-123" aria-hidden="true" tabindex="-1"></a><span class="in">```{r load-data-fake, eval=FALSE}</span></span>
<span id="cb34-124"><a href="#cb34-124" aria-hidden="true" tabindex="-1"></a><span class="in">nets &lt;- read_csv("https://evalf21.classes.andrewheiss.com/data/mosquito_nets.csv")</span></span>
<span id="cb34-125"><a href="#cb34-125" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb34-126"><a href="#cb34-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-127"><a href="#cb34-127" aria-hidden="true" tabindex="-1"></a><span class="in">```{r load-data-real, include=FALSE, warning=FALSE, message=FALSE}</span></span>
<span id="cb34-128"><a href="#cb34-128" aria-hidden="true" tabindex="-1"></a><span class="in">nets &lt;- read_csv("mosquito_nets.csv")</span></span>
<span id="cb34-129"><a href="#cb34-129" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb34-130"><a href="#cb34-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-131"><a href="#cb34-131" aria-hidden="true" tabindex="-1"></a>We'll then create a model that predicts whether people self-select into using a mosquito net, based on our confounders of income, health status, and nighttime temperatures.</span>
<span id="cb34-132"><a href="#cb34-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-133"><a href="#cb34-133" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-treatment, warning=FALSE, results="hide", cache=TRUE}</span></span>
<span id="cb34-134"><a href="#cb34-134" aria-hidden="true" tabindex="-1"></a><span class="in"># First stage model predicting net usage with the confounders</span></span>
<span id="cb34-135"><a href="#cb34-135" aria-hidden="true" tabindex="-1"></a><span class="in">model_treatment &lt;- brm(</span></span>
<span id="cb34-136"><a href="#cb34-136" aria-hidden="true" tabindex="-1"></a><span class="in">  bf(net ~ income + temperature + health,</span></span>
<span id="cb34-137"><a href="#cb34-137" aria-hidden="true" tabindex="-1"></a><span class="in">     decomp = "QR"),  # QR decomposition handles scaling and unscaling for us</span></span>
<span id="cb34-138"><a href="#cb34-138" aria-hidden="true" tabindex="-1"></a><span class="in">  family = bernoulli(),  # Logistic regression</span></span>
<span id="cb34-139"><a href="#cb34-139" aria-hidden="true" tabindex="-1"></a><span class="in">  data = nets,</span></span>
<span id="cb34-140"><a href="#cb34-140" aria-hidden="true" tabindex="-1"></a><span class="in">  chains = 8, cores = 8, iter = 2000,</span></span>
<span id="cb34-141"><a href="#cb34-141" aria-hidden="true" tabindex="-1"></a><span class="in">  seed = 1234, backend = "cmdstanr"</span></span>
<span id="cb34-142"><a href="#cb34-142" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb34-143"><a href="#cb34-143" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb34-144"><a href="#cb34-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-145"><a href="#cb34-145" aria-hidden="true" tabindex="-1"></a>We'll the extract the predicted probabilities / propensity scores from the model and calculate inverse probability weights in each posterior draw for each person in the dataset:</span>
<span id="cb34-146"><a href="#cb34-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-147"><a href="#cb34-147" aria-hidden="true" tabindex="-1"></a><span class="in">```{r create-iptws, cache=TRUE, warning=FALSE, message=FALSE}</span></span>
<span id="cb34-148"><a href="#cb34-148" aria-hidden="true" tabindex="-1"></a><span class="in"># Extract posterior predicted propensity scores</span></span>
<span id="cb34-149"><a href="#cb34-149" aria-hidden="true" tabindex="-1"></a><span class="in">pred_probs_chains &lt;- posterior_epred(model_treatment)</span></span>
<span id="cb34-150"><a href="#cb34-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-151"><a href="#cb34-151" aria-hidden="true" tabindex="-1"></a><span class="in"># Rows are posterior draws, columns are original rows in dataset</span></span>
<span id="cb34-152"><a href="#cb34-152" aria-hidden="true" tabindex="-1"></a><span class="in">dim(pred_probs_chains)</span></span>
<span id="cb34-153"><a href="#cb34-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-154"><a href="#cb34-154" aria-hidden="true" tabindex="-1"></a><span class="in"># Create a matrix of weights where each column is a posterior draw</span></span>
<span id="cb34-155"><a href="#cb34-155" aria-hidden="true" tabindex="-1"></a><span class="in"># Transpose the matrix so that columns are posterior draws</span></span>
<span id="cb34-156"><a href="#cb34-156" aria-hidden="true" tabindex="-1"></a><span class="in">ipw_matrix &lt;- t(pred_probs_chains) %&gt;%</span></span>
<span id="cb34-157"><a href="#cb34-157" aria-hidden="true" tabindex="-1"></a><span class="in">  as_tibble(.name_repair = "universal") %&gt;% </span></span>
<span id="cb34-158"><a href="#cb34-158" aria-hidden="true" tabindex="-1"></a><span class="in">  # Add treatment column so we can calculate weights</span></span>
<span id="cb34-159"><a href="#cb34-159" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(net_num = nets$net_num) %&gt;% </span></span>
<span id="cb34-160"><a href="#cb34-160" aria-hidden="true" tabindex="-1"></a><span class="in">  # Calculate weights</span></span>
<span id="cb34-161"><a href="#cb34-161" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(across(starts_with("..."),</span></span>
<span id="cb34-162"><a href="#cb34-162" aria-hidden="true" tabindex="-1"></a><span class="in">                ~ (net_num / .x) + ((1 - net_num) / (1 - .x))</span></span>
<span id="cb34-163"><a href="#cb34-163" aria-hidden="true" tabindex="-1"></a><span class="in">  )) %&gt;% </span></span>
<span id="cb34-164"><a href="#cb34-164" aria-hidden="true" tabindex="-1"></a><span class="in">  # Get rid of treatment column</span></span>
<span id="cb34-165"><a href="#cb34-165" aria-hidden="true" tabindex="-1"></a><span class="in">  select(-net_num)</span></span>
<span id="cb34-166"><a href="#cb34-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-167"><a href="#cb34-167" aria-hidden="true" tabindex="-1"></a><span class="in"># Rows are original rows in data and columns are posterior draws</span></span>
<span id="cb34-168"><a href="#cb34-168" aria-hidden="true" tabindex="-1"></a><span class="in">dim(ipw_matrix)</span></span>
<span id="cb34-169"><a href="#cb34-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-170"><a href="#cb34-170" aria-hidden="true" tabindex="-1"></a><span class="in">head(ipw_matrix, c(5, 10))</span></span>
<span id="cb34-171"><a href="#cb34-171" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb34-172"><a href="#cb34-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-173"><a href="#cb34-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-174"><a href="#cb34-174" aria-hidden="true" tabindex="-1"></a><span class="fu">### Export starter Stan code</span></span>
<span id="cb34-175"><a href="#cb34-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-176"><a href="#cb34-176" aria-hidden="true" tabindex="-1"></a>Next we need to use these weights in an outcome model using the neat trick of using one column of weights for each iteration of the outcome model, which requires actual Stan code (which I haven't really written since <span class="co">[</span><span class="ot">this blog post</span><span class="co">](https://www.andrewheiss.com/blog/2019/01/29/diff-means-half-dozen-ways/#bayesian-analysis-directly-with-stan)</span> or <span class="co">[</span><span class="ot">this research project</span><span class="co">](https://www.andrewheiss.com/research/articles/chaudhry-heiss-ngos-philanthropy/)</span> (<span class="co">[</span><span class="ot">see here</span><span class="co">](https://github.com/andrewheiss/ngo-crackdowns-philanthropy/tree/master/inst/stan)</span>)).</span>
<span id="cb34-177"><a href="#cb34-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-178"><a href="#cb34-178" aria-hidden="true" tabindex="-1"></a>To simplify life and make it so we don't have to really write any raw Stan code, we'll create the skeleton of our Bayesian outcome model with **brms**, but we don't actually run it—instead we'll pass the formula and priors to <span class="in">`make_stancode()`</span> and save the underlying Stan code as a new file.</span>
<span id="cb34-179"><a href="#cb34-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-180"><a href="#cb34-180" aria-hidden="true" tabindex="-1"></a><span class="in">```{r save-outcome-stan, results="hide"}</span></span>
<span id="cb34-181"><a href="#cb34-181" aria-hidden="true" tabindex="-1"></a><span class="in"># Outcome model</span></span>
<span id="cb34-182"><a href="#cb34-182" aria-hidden="true" tabindex="-1"></a><span class="in"># We can just use a placeholder weights(1) since the nets data doesn't have any</span></span>
<span id="cb34-183"><a href="#cb34-183" aria-hidden="true" tabindex="-1"></a><span class="in"># actual weights in it. It's okay bc we'll never actually run this model.</span></span>
<span id="cb34-184"><a href="#cb34-184" aria-hidden="true" tabindex="-1"></a><span class="in">outcome_formula &lt;- bf(malaria_risk | weights(1) ~ net,</span></span>
<span id="cb34-185"><a href="#cb34-185" aria-hidden="true" tabindex="-1"></a><span class="in">                      family = gaussian)</span></span>
<span id="cb34-186"><a href="#cb34-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-187"><a href="#cb34-187" aria-hidden="true" tabindex="-1"></a><span class="in">outcome_priors &lt;- c(prior("student_t(3, 0, 2.5)", class = "Intercept"),</span></span>
<span id="cb34-188"><a href="#cb34-188" aria-hidden="true" tabindex="-1"></a><span class="in">                    prior("normal(0, 2.5)", class = "b"))</span></span>
<span id="cb34-189"><a href="#cb34-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-190"><a href="#cb34-190" aria-hidden="true" tabindex="-1"></a><span class="in"># Generate Stan code for the outcome model</span></span>
<span id="cb34-191"><a href="#cb34-191" aria-hidden="true" tabindex="-1"></a><span class="in">make_stancode(</span></span>
<span id="cb34-192"><a href="#cb34-192" aria-hidden="true" tabindex="-1"></a><span class="in">  formula = outcome_formula,</span></span>
<span id="cb34-193"><a href="#cb34-193" aria-hidden="true" tabindex="-1"></a><span class="in">  data = nets,</span></span>
<span id="cb34-194"><a href="#cb34-194" aria-hidden="true" tabindex="-1"></a><span class="in">  prior = outcome_priors,</span></span>
<span id="cb34-195"><a href="#cb34-195" aria-hidden="true" tabindex="-1"></a><span class="in">  save_model = "original_stan_code.stan"</span></span>
<span id="cb34-196"><a href="#cb34-196" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb34-197"><a href="#cb34-197" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb34-198"><a href="#cb34-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-199"><a href="#cb34-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-200"><a href="#cb34-200" aria-hidden="true" tabindex="-1"></a><span class="fu">### Adjust the Stan code slightly</span></span>
<span id="cb34-201"><a href="#cb34-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-202"><a href="#cb34-202" aria-hidden="true" tabindex="-1"></a>Next we need to make some minor adjustments to the Stan code. You can also download a complete version of all these changes in this .zip file:</span>
<span id="cb34-203"><a href="#cb34-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-204"><a href="#cb34-204" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">&lt;i class="fas fa-file-archive"&gt;&lt;/i&gt;&amp;ensp;`modified-stan-stuff.zip`</span><span class="co">](modified-stan-stuff.zip)</span></span>
<span id="cb34-205"><a href="#cb34-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-206"><a href="#cb34-206" aria-hidden="true" tabindex="-1"></a>Here's what needs to change:</span>
<span id="cb34-207"><a href="#cb34-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-208"><a href="#cb34-208" aria-hidden="true" tabindex="-1"></a>**Change 1**: Declare two functions in the `functions` block. **The actual code for these two functions will live in a separate C++ file that we'll look at and make in just a minute.** These will let us keep track of the current iteration number of the MCMC chains. <span class="co">[</span><span class="ot">By design, Stan doesn't let you see the current iteration number</span><span class="co">](https://discourse.mc-stan.org/t/is-it-possible-to-access-the-iteration-step-number-inside-a-stan-program/1871/8)</span> (Stan code is designed to be stateless and not dependent on specific iteration numbers) but these two functions allow us to keep track of this ourselves. (These functions were originally <span class="co">[</span><span class="ot">written by Louis at the Stan forum</span><span class="co">](https://discourse.mc-stan.org/t/is-it-possible-to-access-the-iteration-step-number-inside-a-stan-program/1871/23)</span>; <span class="co">[</span><span class="ot">this StackOverflow answer</span><span class="co">](https://stackoverflow.com/a/68901076/120898)</span> shows another example of them working in the wild)</span>
<span id="cb34-209"><a href="#cb34-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-210"><a href="#cb34-210" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb34-211"><a href="#cb34-211" aria-hidden="true" tabindex="-1"></a>If you're editing this file in RStudio, you'll likely see a syntax error after this block, with the complaint "Function declared, but not defined." That's okay. We'll officially define these functions in an external file and inject it into this Stan code when compiling. You can ignore the error.</span>
<span id="cb34-212"><a href="#cb34-212" aria-hidden="true" tabindex="-1"></a>::: </span>
<span id="cb34-213"><a href="#cb34-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-214"><a href="#cb34-214" aria-hidden="true" tabindex="-1"></a>:::: {.columns .column-page-inset-right}</span>
<span id="cb34-215"><a href="#cb34-215" aria-hidden="true" tabindex="-1"></a>::: {.column .first-block width="45%"}</span>
<span id="cb34-216"><a href="#cb34-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-217"><a href="#cb34-217" aria-hidden="true" tabindex="-1"></a><span class="in">```{.stan}</span></span>
<span id="cb34-218"><a href="#cb34-218" aria-hidden="true" tabindex="-1"></a><span class="in">// Original block</span></span>
<span id="cb34-219"><a href="#cb34-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-220"><a href="#cb34-220" aria-hidden="true" tabindex="-1"></a><span class="in">functions {</span></span>
<span id="cb34-221"><a href="#cb34-221" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb34-222"><a href="#cb34-222" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb34-223"><a href="#cb34-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-224"><a href="#cb34-224" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb34-225"><a href="#cb34-225" aria-hidden="true" tabindex="-1"></a>::: {.column width="45%"}</span>
<span id="cb34-226"><a href="#cb34-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-227"><a href="#cb34-227" aria-hidden="true" tabindex="-1"></a><span class="in">```{.stan}</span></span>
<span id="cb34-228"><a href="#cb34-228" aria-hidden="true" tabindex="-1"></a><span class="in">// Modified block</span></span>
<span id="cb34-229"><a href="#cb34-229" aria-hidden="true" tabindex="-1"></a><span class="in">// ADD 2 NEW LINES</span></span>
<span id="cb34-230"><a href="#cb34-230" aria-hidden="true" tabindex="-1"></a><span class="in">functions {</span></span>
<span id="cb34-231"><a href="#cb34-231" aria-hidden="true" tabindex="-1"></a><span class="in">  void add_iter();  // ~*~THIS IS NEW~*~</span></span>
<span id="cb34-232"><a href="#cb34-232" aria-hidden="true" tabindex="-1"></a><span class="in">  int get_iter();  // ~*~THIS IS NEW~*~</span></span>
<span id="cb34-233"><a href="#cb34-233" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb34-234"><a href="#cb34-234" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb34-235"><a href="#cb34-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-236"><a href="#cb34-236" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb34-237"><a href="#cb34-237" aria-hidden="true" tabindex="-1"></a>::::</span>
<span id="cb34-238"><a href="#cb34-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-239"><a href="#cb34-239" aria-hidden="true" tabindex="-1"></a>**Change 2**: Remove the declaration for the <span class="in">`weights`</span> variable from the <span class="in">`data`</span> block and add new declarations for two new variables: <span class="in">`L`</span> for keeping track of the number of columns in the weights matrix, and <span class="in">`IPW`</span> for the weights matrix:</span>
<span id="cb34-240"><a href="#cb34-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-241"><a href="#cb34-241" aria-hidden="true" tabindex="-1"></a>:::: {.columns .column-screen-inset-right}</span>
<span id="cb34-242"><a href="#cb34-242" aria-hidden="true" tabindex="-1"></a>::: {.column .first-block width="45%"}</span>
<span id="cb34-243"><a href="#cb34-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-244"><a href="#cb34-244" aria-hidden="true" tabindex="-1"></a><span class="in">```{.stan}</span></span>
<span id="cb34-245"><a href="#cb34-245" aria-hidden="true" tabindex="-1"></a><span class="in">// Original block</span></span>
<span id="cb34-246"><a href="#cb34-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-247"><a href="#cb34-247" aria-hidden="true" tabindex="-1"></a><span class="in">data {</span></span>
<span id="cb34-248"><a href="#cb34-248" aria-hidden="true" tabindex="-1"></a><span class="in">  int&lt;lower=1&gt; N;  // total number of observations</span></span>
<span id="cb34-249"><a href="#cb34-249" aria-hidden="true" tabindex="-1"></a><span class="in">  vector[N] Y;  // response variable</span></span>
<span id="cb34-250"><a href="#cb34-250" aria-hidden="true" tabindex="-1"></a><span class="in">  vector&lt;lower=0&gt;[N] weights;  // model weights</span></span>
<span id="cb34-251"><a href="#cb34-251" aria-hidden="true" tabindex="-1"></a><span class="in">  int&lt;lower=1&gt; K;  // number of population-level effects</span></span>
<span id="cb34-252"><a href="#cb34-252" aria-hidden="true" tabindex="-1"></a><span class="in">  matrix[N, K] X;  // population-level design matrix</span></span>
<span id="cb34-253"><a href="#cb34-253" aria-hidden="true" tabindex="-1"></a><span class="in">  int prior_only;  // should the likelihood be ignored?</span></span>
<span id="cb34-254"><a href="#cb34-254" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb34-255"><a href="#cb34-255" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb34-256"><a href="#cb34-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-257"><a href="#cb34-257" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb34-258"><a href="#cb34-258" aria-hidden="true" tabindex="-1"></a>::: {.column width="45%"}</span>
<span id="cb34-259"><a href="#cb34-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-260"><a href="#cb34-260" aria-hidden="true" tabindex="-1"></a><span class="in">```{.stan}</span></span>
<span id="cb34-261"><a href="#cb34-261" aria-hidden="true" tabindex="-1"></a><span class="in">// Modified block</span></span>
<span id="cb34-262"><a href="#cb34-262" aria-hidden="true" tabindex="-1"></a><span class="in">// REMOVE 1 LINE; ADD 2 NEW LINES</span></span>
<span id="cb34-263"><a href="#cb34-263" aria-hidden="true" tabindex="-1"></a><span class="in">data {</span></span>
<span id="cb34-264"><a href="#cb34-264" aria-hidden="true" tabindex="-1"></a><span class="in">  int&lt;lower=1&gt; N;  // total number of observations</span></span>
<span id="cb34-265"><a href="#cb34-265" aria-hidden="true" tabindex="-1"></a><span class="in">  vector[N] Y;  // response variable</span></span>
<span id="cb34-266"><a href="#cb34-266" aria-hidden="true" tabindex="-1"></a><span class="in">  //vector&lt;lower=0&gt;[N] weights;  // model weights -- ~*~REMOVE THIS~*~</span></span>
<span id="cb34-267"><a href="#cb34-267" aria-hidden="true" tabindex="-1"></a><span class="in">  int&lt;lower=1&gt; K;  // number of population-level effects</span></span>
<span id="cb34-268"><a href="#cb34-268" aria-hidden="true" tabindex="-1"></a><span class="in">  matrix[N, K] X;  // population-level design matrix</span></span>
<span id="cb34-269"><a href="#cb34-269" aria-hidden="true" tabindex="-1"></a><span class="in">  int prior_only;  // should the likelihood be ignored?</span></span>
<span id="cb34-270"><a href="#cb34-270" aria-hidden="true" tabindex="-1"></a><span class="in">  int L;  // number of columns in the weights matrix -- ~*~THIS IS NEW~*~</span></span>
<span id="cb34-271"><a href="#cb34-271" aria-hidden="true" tabindex="-1"></a><span class="in">  matrix[N, L] IPW;  // weights matrix -- ~*~THIS IS NEW~*~</span></span>
<span id="cb34-272"><a href="#cb34-272" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb34-273"><a href="#cb34-273" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb34-274"><a href="#cb34-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-275"><a href="#cb34-275" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb34-276"><a href="#cb34-276" aria-hidden="true" tabindex="-1"></a>::::</span>
<span id="cb34-277"><a href="#cb34-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-278"><a href="#cb34-278" aria-hidden="true" tabindex="-1"></a>**Change 3**: In the <span class="in">`model`</span> block, add the ability to keep track of the current iteration with <span class="in">`get_iter()`</span>. And—most importantly—modify the actual model so that it uses a column from the weights matrix <span class="in">`IPW[n, M]`</span> rather than the single <span class="in">`weights[n]`</span> vector. </span>
<span id="cb34-279"><a href="#cb34-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-280"><a href="#cb34-280" aria-hidden="true" tabindex="-1"></a>:::: {.columns .column-screen-inset-right}</span>
<span id="cb34-281"><a href="#cb34-281" aria-hidden="true" tabindex="-1"></a>::: {.column .first-block width="45%"}</span>
<span id="cb34-282"><a href="#cb34-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-283"><a href="#cb34-283" aria-hidden="true" tabindex="-1"></a><span class="in">```{.stan}</span></span>
<span id="cb34-284"><a href="#cb34-284" aria-hidden="true" tabindex="-1"></a><span class="in">// Original block</span></span>
<span id="cb34-285"><a href="#cb34-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-286"><a href="#cb34-286" aria-hidden="true" tabindex="-1"></a><span class="in">model {</span></span>
<span id="cb34-287"><a href="#cb34-287" aria-hidden="true" tabindex="-1"></a><span class="in">  // likelihood including constants</span></span>
<span id="cb34-288"><a href="#cb34-288" aria-hidden="true" tabindex="-1"></a><span class="in">  if (!prior_only) {</span></span>
<span id="cb34-289"><a href="#cb34-289" aria-hidden="true" tabindex="-1"></a><span class="in">    // initialize linear predictor term</span></span>
<span id="cb34-290"><a href="#cb34-290" aria-hidden="true" tabindex="-1"></a><span class="in">    vector[N] mu = Intercept + Xc * b;</span></span>
<span id="cb34-291"><a href="#cb34-291" aria-hidden="true" tabindex="-1"></a><span class="in">    for (n in 1:N) {</span></span>
<span id="cb34-292"><a href="#cb34-292" aria-hidden="true" tabindex="-1"></a><span class="in">      target += weights[n] * (normal_lpdf(Y[n] | mu[n], sigma));</span></span>
<span id="cb34-293"><a href="#cb34-293" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb34-294"><a href="#cb34-294" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb34-295"><a href="#cb34-295" aria-hidden="true" tabindex="-1"></a><span class="in">  // priors including constants</span></span>
<span id="cb34-296"><a href="#cb34-296" aria-hidden="true" tabindex="-1"></a><span class="in">  target += normal_lpdf(b | 0, 2.5);</span></span>
<span id="cb34-297"><a href="#cb34-297" aria-hidden="true" tabindex="-1"></a><span class="in">  target += student_t_lpdf(Intercept | 3, 0, 2.5);</span></span>
<span id="cb34-298"><a href="#cb34-298" aria-hidden="true" tabindex="-1"></a><span class="in">  target += student_t_lpdf(sigma | 3, 0, 14.8)</span></span>
<span id="cb34-299"><a href="#cb34-299" aria-hidden="true" tabindex="-1"></a><span class="in">    - 1 * student_t_lccdf(0 | 3, 0, 14.8);</span></span>
<span id="cb34-300"><a href="#cb34-300" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb34-301"><a href="#cb34-301" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb34-302"><a href="#cb34-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-303"><a href="#cb34-303" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb34-304"><a href="#cb34-304" aria-hidden="true" tabindex="-1"></a>::: {.column width="45%"}</span>
<span id="cb34-305"><a href="#cb34-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-306"><a href="#cb34-306" aria-hidden="true" tabindex="-1"></a><span class="in">```{.stan}</span></span>
<span id="cb34-307"><a href="#cb34-307" aria-hidden="true" tabindex="-1"></a><span class="in">// Modified block</span></span>
<span id="cb34-308"><a href="#cb34-308" aria-hidden="true" tabindex="-1"></a><span class="in">// ADD 2 LINES</span></span>
<span id="cb34-309"><a href="#cb34-309" aria-hidden="true" tabindex="-1"></a><span class="in">model {</span></span>
<span id="cb34-310"><a href="#cb34-310" aria-hidden="true" tabindex="-1"></a><span class="in">  // likelihood including constants</span></span>
<span id="cb34-311"><a href="#cb34-311" aria-hidden="true" tabindex="-1"></a><span class="in">  if (!prior_only) {</span></span>
<span id="cb34-312"><a href="#cb34-312" aria-hidden="true" tabindex="-1"></a><span class="in">    // initialize linear predictor term</span></span>
<span id="cb34-313"><a href="#cb34-313" aria-hidden="true" tabindex="-1"></a><span class="in">    vector[N] mu = Intercept + Xc * b;</span></span>
<span id="cb34-314"><a href="#cb34-314" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb34-315"><a href="#cb34-315" aria-hidden="true" tabindex="-1"></a><span class="in">    int M = get_iter();  // get the current iteration -- ~*~THIS IS NEW~*~</span></span>
<span id="cb34-316"><a href="#cb34-316" aria-hidden="true" tabindex="-1"></a><span class="in">    vector[N] weights = IPW[, M];  // get the weights for this iteration -- ~*~THIS IS NEW~*~</span></span>
<span id="cb34-317"><a href="#cb34-317" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb34-318"><a href="#cb34-318" aria-hidden="true" tabindex="-1"></a><span class="in">    for (n in 1:N) {</span></span>
<span id="cb34-319"><a href="#cb34-319" aria-hidden="true" tabindex="-1"></a><span class="in">      target += weights[n] * (normal_lpdf(Y[n] | mu[n], sigma));</span></span>
<span id="cb34-320"><a href="#cb34-320" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb34-321"><a href="#cb34-321" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb34-322"><a href="#cb34-322" aria-hidden="true" tabindex="-1"></a><span class="in">  // priors including constants</span></span>
<span id="cb34-323"><a href="#cb34-323" aria-hidden="true" tabindex="-1"></a><span class="in">  target += normal_lpdf(b | 0, 2.5);</span></span>
<span id="cb34-324"><a href="#cb34-324" aria-hidden="true" tabindex="-1"></a><span class="in">  target += student_t_lpdf(Intercept | 3, 0, 2.5);</span></span>
<span id="cb34-325"><a href="#cb34-325" aria-hidden="true" tabindex="-1"></a><span class="in">  target += student_t_lpdf(sigma | 3, 0, 14.8)</span></span>
<span id="cb34-326"><a href="#cb34-326" aria-hidden="true" tabindex="-1"></a><span class="in">    - 1 * student_t_lccdf(0 | 3, 0, 14.8);</span></span>
<span id="cb34-327"><a href="#cb34-327" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb34-328"><a href="#cb34-328" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb34-329"><a href="#cb34-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-330"><a href="#cb34-330" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb34-331"><a href="#cb34-331" aria-hidden="true" tabindex="-1"></a>::::</span>
<span id="cb34-332"><a href="#cb34-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-333"><a href="#cb34-333" aria-hidden="true" tabindex="-1"></a>**Change 4**: And finally in the <span class="in">`generated quantities`</span> block, add the <span class="in">`add_iter()`</span> function so that the iteration counter increases by one at the end of the draw.</span>
<span id="cb34-334"><a href="#cb34-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-335"><a href="#cb34-335" aria-hidden="true" tabindex="-1"></a>:::: {.columns .column-screen-inset-right}</span>
<span id="cb34-336"><a href="#cb34-336" aria-hidden="true" tabindex="-1"></a>::: {.column .first-block width="45%"}</span>
<span id="cb34-337"><a href="#cb34-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-338"><a href="#cb34-338" aria-hidden="true" tabindex="-1"></a><span class="in">```{.stan}</span></span>
<span id="cb34-339"><a href="#cb34-339" aria-hidden="true" tabindex="-1"></a><span class="in">// Original block</span></span>
<span id="cb34-340"><a href="#cb34-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-341"><a href="#cb34-341" aria-hidden="true" tabindex="-1"></a><span class="in">generated quantities {</span></span>
<span id="cb34-342"><a href="#cb34-342" aria-hidden="true" tabindex="-1"></a><span class="in">  // actual population-level intercept</span></span>
<span id="cb34-343"><a href="#cb34-343" aria-hidden="true" tabindex="-1"></a><span class="in">  real b_Intercept = Intercept - dot_product(means_X, b);</span></span>
<span id="cb34-344"><a href="#cb34-344" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb34-345"><a href="#cb34-345" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb34-346"><a href="#cb34-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-347"><a href="#cb34-347" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb34-348"><a href="#cb34-348" aria-hidden="true" tabindex="-1"></a>::: {.column width="45%"}</span>
<span id="cb34-349"><a href="#cb34-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-350"><a href="#cb34-350" aria-hidden="true" tabindex="-1"></a><span class="in">```{.stan}</span></span>
<span id="cb34-351"><a href="#cb34-351" aria-hidden="true" tabindex="-1"></a><span class="in">// Modified block</span></span>
<span id="cb34-352"><a href="#cb34-352" aria-hidden="true" tabindex="-1"></a><span class="in">// ADD 1 LINE</span></span>
<span id="cb34-353"><a href="#cb34-353" aria-hidden="true" tabindex="-1"></a><span class="in">generated quantities {</span></span>
<span id="cb34-354"><a href="#cb34-354" aria-hidden="true" tabindex="-1"></a><span class="in">  // actual population-level intercept</span></span>
<span id="cb34-355"><a href="#cb34-355" aria-hidden="true" tabindex="-1"></a><span class="in">  real b_Intercept = Intercept - dot_product(means_X, b);</span></span>
<span id="cb34-356"><a href="#cb34-356" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb34-357"><a href="#cb34-357" aria-hidden="true" tabindex="-1"></a><span class="in">  add_iter();  // update the counter each iteration --  ~*~THIS IS NEW~*~</span></span>
<span id="cb34-358"><a href="#cb34-358" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb34-359"><a href="#cb34-359" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb34-360"><a href="#cb34-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-361"><a href="#cb34-361" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb34-362"><a href="#cb34-362" aria-hidden="true" tabindex="-1"></a>::::</span>
<span id="cb34-363"><a href="#cb34-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-364"><a href="#cb34-364" aria-hidden="true" tabindex="-1"></a><span class="fu">### Define C++ functions for the counter</span></span>
<span id="cb34-365"><a href="#cb34-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-366"><a href="#cb34-366" aria-hidden="true" tabindex="-1"></a>Before compiling this and running our shiny new model, we need to officially define our two new functions for keeping track of the MCMC iteration: <span class="in">`add_iter()`</span> and <span class="in">`get_iter()`</span>. We need to do this with C++ (But don't worry if you've never touched C++ before! This is my first time using it too!). Create a file named <span class="in">`iterfuns.hpp`</span> (or whatever you want to call it) with this in it:</span>
<span id="cb34-367"><a href="#cb34-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-368"><a href="#cb34-368" aria-hidden="true" tabindex="-1"></a><span class="in">```{.cpp filename="iterfuns.hpp"}</span></span>
<span id="cb34-369"><a href="#cb34-369" aria-hidden="true" tabindex="-1"></a><span class="in">// Declare an integer to keep track of the iteration count</span></span>
<span id="cb34-370"><a href="#cb34-370" aria-hidden="true" tabindex="-1"></a><span class="in">static int itct = 1;</span></span>
<span id="cb34-371"><a href="#cb34-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-372"><a href="#cb34-372" aria-hidden="true" tabindex="-1"></a><span class="in">// Increment the counter</span></span>
<span id="cb34-373"><a href="#cb34-373" aria-hidden="true" tabindex="-1"></a><span class="in">inline void add_iter(std::ostream* pstream__) {</span></span>
<span id="cb34-374"><a href="#cb34-374" aria-hidden="true" tabindex="-1"></a><span class="in">  itct += 1;</span></span>
<span id="cb34-375"><a href="#cb34-375" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb34-376"><a href="#cb34-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-377"><a href="#cb34-377" aria-hidden="true" tabindex="-1"></a><span class="in">// Retrieve the current count</span></span>
<span id="cb34-378"><a href="#cb34-378" aria-hidden="true" tabindex="-1"></a><span class="in">inline int get_iter(std::ostream* pstream__) {</span></span>
<span id="cb34-379"><a href="#cb34-379" aria-hidden="true" tabindex="-1"></a><span class="in">  return itct;</span></span>
<span id="cb34-380"><a href="#cb34-380" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb34-381"><a href="#cb34-381" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb34-382"><a href="#cb34-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-383"><a href="#cb34-383" aria-hidden="true" tabindex="-1"></a>When we compile the Stan code, we'll inject this C++ code into it and our <span class="in">`add_iter()`</span> and <span class="in">`get_iter()`</span> functions will work.</span>
<span id="cb34-384"><a href="#cb34-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-385"><a href="#cb34-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-386"><a href="#cb34-386" aria-hidden="true" tabindex="-1"></a><span class="fu">### Compile the Stan code</span></span>
<span id="cb34-387"><a href="#cb34-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-388"><a href="#cb34-388" aria-hidden="true" tabindex="-1"></a>Before running the model and creating a bunch of MCMC chains, we need to compile this Stan code into a binary program that we can then use for MCMC. This is the same thing that happens when you use <span class="in">`brms()`</span> and wait for a few seconds while it says <span class="in">`Compiling Stan program...`</span>.</span>
<span id="cb34-389"><a href="#cb34-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-390"><a href="#cb34-390" aria-hidden="true" tabindex="-1"></a>Technically we can do this by passing the file name of our modified Stan code to <span class="in">`stan_model()`</span>, but **rstan** and/or Stan does stuff behind the scenes (storing compiled programs in <span class="in">`/tmp`</span> or as hidden files somewhere on the computer) for caching purposes, and it can store older (and incorrect) versions of compiled models that can be hard to track down and get rid of. According to the documentation of <span class="in">`stan_model()`</span>, we can force Stan to recompile the model every time and avoid this caching headache (it's seriously a headache!) by first explicitly converting the Stan code to C++ with <span class="in">`stanc()`</span>, and then passing *that* code to <span class="in">`stan_model()`</span>.</span>
<span id="cb34-391"><a href="#cb34-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-392"><a href="#cb34-392" aria-hidden="true" tabindex="-1"></a>So to avoid caching issues, we'll do this in two steps. First we'll convert our modified Stan code to C++. The <span class="in">`allow_undefined = TRUE`</span> option here is necessary because <span class="in">`add_iter()`</span> and <span class="in">`get_iter()`</span> are defined in an external file and Stan will complain because they're not formally defined here (similar to why RStudio complains). </span>
<span id="cb34-393"><a href="#cb34-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-394"><a href="#cb34-394" aria-hidden="true" tabindex="-1"></a>Then we'll feed this converted code to <span class="in">`stan_model()`</span> and inject the C++ file with the counter functions in it. To reference an external file in C++, we have to include a line that looks like this:</span>
<span id="cb34-395"><a href="#cb34-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-396"><a href="#cb34-396" aria-hidden="true" tabindex="-1"></a><span class="in">```cpp</span></span>
<span id="cb34-397"><a href="#cb34-397" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">"/full/path/to/iterfuns.hpp"</span></span>
<span id="cb34-398"><a href="#cb34-398" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb34-399"><a href="#cb34-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-400"><a href="#cb34-400" aria-hidden="true" tabindex="-1"></a>Instead of hand-typing that, we'll use <span class="in">`here()`</span> from the **here** package to automatically generate the absolute path, along with some extra newlines (<span class="in">`\n`</span>).</span>
<span id="cb34-401"><a href="#cb34-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-402"><a href="#cb34-402" aria-hidden="true" tabindex="-1"></a><span class="in">```{r compile-stan-model-fake, eval=FALSE}</span></span>
<span id="cb34-403"><a href="#cb34-403" aria-hidden="true" tabindex="-1"></a><span class="in"># Convert the modified Stan code to C++</span></span>
<span id="cb34-404"><a href="#cb34-404" aria-hidden="true" tabindex="-1"></a><span class="in">outcome_c &lt;- stanc("modified_stan_code.stan",</span></span>
<span id="cb34-405"><a href="#cb34-405" aria-hidden="true" tabindex="-1"></a><span class="in">                   allow_undefined = TRUE)</span></span>
<span id="cb34-406"><a href="#cb34-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-407"><a href="#cb34-407" aria-hidden="true" tabindex="-1"></a><span class="in"># Compile C++ified Stan to a binary model object</span></span>
<span id="cb34-408"><a href="#cb34-408" aria-hidden="true" tabindex="-1"></a><span class="in">outcome_model &lt;- stan_model(</span></span>
<span id="cb34-409"><a href="#cb34-409" aria-hidden="true" tabindex="-1"></a><span class="in">  stanc_ret = outcome_c, </span></span>
<span id="cb34-410"><a href="#cb34-410" aria-hidden="true" tabindex="-1"></a><span class="in">  includes = paste0('\n#include "', here('iterfuns.hpp'), '"\n')</span></span>
<span id="cb34-411"><a href="#cb34-411" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb34-412"><a href="#cb34-412" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb34-413"><a href="#cb34-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-414"><a href="#cb34-414" aria-hidden="true" tabindex="-1"></a><span class="in">```{r compile-stan-model, include=FALSE, results="hide", warning=FALSE, message=FALSE}</span></span>
<span id="cb34-415"><a href="#cb34-415" aria-hidden="true" tabindex="-1"></a><span class="in"># Convert the modified Stan code to C++</span></span>
<span id="cb34-416"><a href="#cb34-416" aria-hidden="true" tabindex="-1"></a><span class="in">outcome_c &lt;- stanc("modified_stan_code.stan",</span></span>
<span id="cb34-417"><a href="#cb34-417" aria-hidden="true" tabindex="-1"></a><span class="in">                   allow_undefined = TRUE)</span></span>
<span id="cb34-418"><a href="#cb34-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-419"><a href="#cb34-419" aria-hidden="true" tabindex="-1"></a><span class="in"># Compile C++ified Stan to a binary model object</span></span>
<span id="cb34-420"><a href="#cb34-420" aria-hidden="true" tabindex="-1"></a><span class="in">outcome_model &lt;- stan_model(</span></span>
<span id="cb34-421"><a href="#cb34-421" aria-hidden="true" tabindex="-1"></a><span class="in">  stanc_ret = outcome_c, </span></span>
<span id="cb34-422"><a href="#cb34-422" aria-hidden="true" tabindex="-1"></a><span class="in">  includes = paste0('\n#include "', file.path(getwd(), "iterfuns.hpp"), '"\n')</span></span>
<span id="cb34-423"><a href="#cb34-423" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb34-424"><a href="#cb34-424" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb34-425"><a href="#cb34-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-426"><a href="#cb34-426" aria-hidden="true" tabindex="-1"></a>After a few seconds, we should have a new <span class="in">`outcome_model`</span> object. This doesn't contain any results or chains or anything. This is essentially a mini standalone program that's designed to take our nets data, our weights, and the priors that we specified.</span>
<span id="cb34-427"><a href="#cb34-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-428"><a href="#cb34-428" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb34-429"><a href="#cb34-429" aria-hidden="true" tabindex="-1"></a><span class="fu">### Fun fact</span></span>
<span id="cb34-430"><a href="#cb34-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-431"><a href="#cb34-431" aria-hidden="true" tabindex="-1"></a>This is essentially the difference between **brms** and **rstanarm**. **rstanarm** comes with a bunch of pre-compiled model programs like `stan_glm()`, so you don't have to compile anything yourself ever—you don't need to wait for the `Compiling Stan program...` message to finish like you do with **brms**. But that extra pre-compiled speed comes at the cost of flexibility—you can't run as many models or do as many neat extra things with **rstanarm** as you can with **brms**.</span>
<span id="cb34-432"><a href="#cb34-432" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb34-433"><a href="#cb34-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-434"><a href="#cb34-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-435"><a href="#cb34-435" aria-hidden="true" tabindex="-1"></a><span class="fu">### Run the model</span></span>
<span id="cb34-436"><a href="#cb34-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-437"><a href="#cb34-437" aria-hidden="true" tabindex="-1"></a>Finally, we can feed our data into the <span class="in">`outcome_model`</span> object and run the MCMC chains. Unlike **brms**, we can't just feed it a formula and a data frame. Instead, we need to feed this model a list with each of the variables we declared in the data block of our code. The syntax is a little wonky, and the best way to get a feel for how this list needs to be structured is to use <span class="in">`make_standata()`</span> and follow the same structure.</span>
<span id="cb34-438"><a href="#cb34-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-439"><a href="#cb34-439" aria-hidden="true" tabindex="-1"></a>Importantly, we need to use at least the same number of posterior chains as we have weights for (i.e. we can't have 2,000 sets of weights and use 8,000 chains in the outcome model since we'll run out of weights). Here we'll use the same amount (2,000 per chain, only 1,000 of which are kept due to the warmup phase).</span>
<span id="cb34-440"><a href="#cb34-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-441"><a href="#cb34-441" aria-hidden="true" tabindex="-1"></a><span class="in">```{r build-final-model-pieces}</span></span>
<span id="cb34-442"><a href="#cb34-442" aria-hidden="true" tabindex="-1"></a><span class="in"># Make a dataset of all the covariates and an intercept column</span></span>
<span id="cb34-443"><a href="#cb34-443" aria-hidden="true" tabindex="-1"></a><span class="in">outcome_covariates &lt;- model.matrix(~ net_num, data = nets)</span></span>
<span id="cb34-444"><a href="#cb34-444" aria-hidden="true" tabindex="-1"></a><span class="in">head(outcome_covariates)</span></span>
<span id="cb34-445"><a href="#cb34-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-446"><a href="#cb34-446" aria-hidden="true" tabindex="-1"></a><span class="in"># Make a list of all the required pieces for the data block in the Stan model</span></span>
<span id="cb34-447"><a href="#cb34-447" aria-hidden="true" tabindex="-1"></a><span class="in">outcome_data &lt;- list(</span></span>
<span id="cb34-448"><a href="#cb34-448" aria-hidden="true" tabindex="-1"></a><span class="in">  N = nrow(nets),</span></span>
<span id="cb34-449"><a href="#cb34-449" aria-hidden="true" tabindex="-1"></a><span class="in">  Y = nets$malaria_risk,</span></span>
<span id="cb34-450"><a href="#cb34-450" aria-hidden="true" tabindex="-1"></a><span class="in">  K = ncol(outcome_covariates),</span></span>
<span id="cb34-451"><a href="#cb34-451" aria-hidden="true" tabindex="-1"></a><span class="in">  X = outcome_covariates,</span></span>
<span id="cb34-452"><a href="#cb34-452" aria-hidden="true" tabindex="-1"></a><span class="in">  L = ncol(ipw_matrix),</span></span>
<span id="cb34-453"><a href="#cb34-453" aria-hidden="true" tabindex="-1"></a><span class="in">  IPW = as.matrix(ipw_matrix),</span></span>
<span id="cb34-454"><a href="#cb34-454" aria-hidden="true" tabindex="-1"></a><span class="in">  prior_only = 0</span></span>
<span id="cb34-455"><a href="#cb34-455" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb34-456"><a href="#cb34-456" aria-hidden="true" tabindex="-1"></a><span class="in">str(outcome_data)</span></span>
<span id="cb34-457"><a href="#cb34-457" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb34-458"><a href="#cb34-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-459"><a href="#cb34-459" aria-hidden="true" tabindex="-1"></a><span class="in">```{r run-final-model, cache=TRUE, results="hide", warning=FALSE, message=FALSE}</span></span>
<span id="cb34-460"><a href="#cb34-460" aria-hidden="true" tabindex="-1"></a><span class="in"># FINALLY run the model!</span></span>
<span id="cb34-461"><a href="#cb34-461" aria-hidden="true" tabindex="-1"></a><span class="in">outcome_samples &lt;- sampling(</span></span>
<span id="cb34-462"><a href="#cb34-462" aria-hidden="true" tabindex="-1"></a><span class="in">  outcome_model, </span></span>
<span id="cb34-463"><a href="#cb34-463" aria-hidden="true" tabindex="-1"></a><span class="in">  data = outcome_data, </span></span>
<span id="cb34-464"><a href="#cb34-464" aria-hidden="true" tabindex="-1"></a><span class="in">  chains = 8, </span></span>
<span id="cb34-465"><a href="#cb34-465" aria-hidden="true" tabindex="-1"></a><span class="in">  iter = 2000,</span></span>
<span id="cb34-466"><a href="#cb34-466" aria-hidden="true" tabindex="-1"></a><span class="in">  cores = 8,</span></span>
<span id="cb34-467"><a href="#cb34-467" aria-hidden="true" tabindex="-1"></a><span class="in">  seed = 1234</span></span>
<span id="cb34-468"><a href="#cb34-468" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb34-469"><a href="#cb34-469" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb34-470"><a href="#cb34-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-471"><a href="#cb34-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-472"><a href="#cb34-472" aria-hidden="true" tabindex="-1"></a><span class="fu">## Analyze the results</span></span>
<span id="cb34-473"><a href="#cb34-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-474"><a href="#cb34-474" aria-hidden="true" tabindex="-1"></a>The results from <span class="in">`rstan::sampling()`</span> behave pretty similarly to the output from **rstanarm** or **brms** (which isn't surprising, since both of those packages are just fancier frontends for Stan). We can print the results, for instance:</span>
<span id="cb34-475"><a href="#cb34-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-476"><a href="#cb34-476" aria-hidden="true" tabindex="-1"></a><span class="in">```{r print-results}</span></span>
<span id="cb34-477"><a href="#cb34-477" aria-hidden="true" tabindex="-1"></a><span class="in">print(outcome_samples)</span></span>
<span id="cb34-478"><a href="#cb34-478" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb34-479"><a href="#cb34-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-480"><a href="#cb34-480" aria-hidden="true" tabindex="-1"></a>Or we can use <span class="in">`tidy()`</span> from **broom.mixed**:</span>
<span id="cb34-481"><a href="#cb34-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-482"><a href="#cb34-482" aria-hidden="true" tabindex="-1"></a><span class="in">```{r tidy-results}</span></span>
<span id="cb34-483"><a href="#cb34-483" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(outcome_samples, conf.int = TRUE)</span></span>
<span id="cb34-484"><a href="#cb34-484" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb34-485"><a href="#cb34-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-486"><a href="#cb34-486" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-results, include=FALSE}</span></span>
<span id="cb34-487"><a href="#cb34-487" aria-hidden="true" tabindex="-1"></a><span class="in">results &lt;- tidy(outcome_samples, conf.int = TRUE) %&gt;% </span></span>
<span id="cb34-488"><a href="#cb34-488" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(term = janitor::make_clean_names(term)) %&gt;%</span></span>
<span id="cb34-489"><a href="#cb34-489" aria-hidden="true" tabindex="-1"></a><span class="in">  split(~term)</span></span>
<span id="cb34-490"><a href="#cb34-490" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb34-491"><a href="#cb34-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-492"><a href="#cb34-492" aria-hidden="true" tabindex="-1"></a>The coefficients aren't nicely named and separated into fixed and random effects like they are in **brms** output, but we can still get the results out (and <span class="co">[</span><span class="ot">we could rename them in the model if we wanted</span><span class="co">](https://discourse.mc-stan.org/t/recovering-coefficient-names/12598)</span>, or we can do that on our own as we work with the data). The main coefficient we care about here is the one for <span class="in">`net`</span>, or <span class="in">`b[1]`</span>. Based on this Bayesian outcome model, after incorporating the uncertainty from the posterior distribution of inverse probability weights, the ATE of using a net is <span class="in">`r round(results$b_1$estimate, 2)`</span>, with an error of <span class="in">`r round(results$b_1$std.error, 2)`</span>.</span>
<span id="cb34-493"><a href="#cb34-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-494"><a href="#cb34-494" aria-hidden="true" tabindex="-1"></a>This is so cool! At the end of the previous post, after running 2,000 frequentist models and combining the ATEs and standard errors, we ended up with these results:</span>
<span id="cb34-495"><a href="#cb34-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-496"><a href="#cb34-496" aria-hidden="true" tabindex="-1"></a><span class="in">```{r past-results, eval=FALSE}</span></span>
<span id="cb34-497"><a href="#cb34-497" aria-hidden="true" tabindex="-1"></a><span class="in"># ----------------------------------------------------------------------------------------------</span></span>
<span id="cb34-498"><a href="#cb34-498" aria-hidden="true" tabindex="-1"></a><span class="in"># Excerpt from https://www.andrewheiss.com/blog/2021/12/18/bayesian-propensity-scores-weights/</span></span>
<span id="cb34-499"><a href="#cb34-499" aria-hidden="true" tabindex="-1"></a><span class="in"># ----------------------------------------------------------------------------------------------</span></span>
<span id="cb34-500"><a href="#cb34-500" aria-hidden="true" tabindex="-1"></a><span class="in"># Combined average treatment effect</span></span>
<span id="cb34-501"><a href="#cb34-501" aria-hidden="true" tabindex="-1"></a><span class="in">mean(outcome_models$ate)</span></span>
<span id="cb34-502"><a href="#cb34-502" aria-hidden="true" tabindex="-1"></a><span class="in">## [1] -10.1</span></span>
<span id="cb34-503"><a href="#cb34-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-504"><a href="#cb34-504" aria-hidden="true" tabindex="-1"></a><span class="in"># Combined standard errors with Rubin's rules (this is correct)</span></span>
<span id="cb34-505"><a href="#cb34-505" aria-hidden="true" tabindex="-1"></a><span class="in">rubin_se(outcome_models$ate, outcome_models$ate_se)</span></span>
<span id="cb34-506"><a href="#cb34-506" aria-hidden="true" tabindex="-1"></a><span class="in">## [1] 1.01</span></span>
<span id="cb34-507"><a href="#cb34-507" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb34-508"><a href="#cb34-508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-509"><a href="#cb34-509" aria-hidden="true" tabindex="-1"></a>We get comparable results with this Bayesian outcome model, only now we get to do fun Bayesian inference with the results!</span>
<span id="cb34-510"><a href="#cb34-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-511"><a href="#cb34-511" aria-hidden="true" tabindex="-1"></a>Instead of confidence intervals, we have credible intervals: given the data we have, there's a 95% chance that the ATE is between <span class="in">`r round(results$b_1$conf.low, 2)`</span> and <span class="in">`r round(results$b_1$conf.high, 2)`</span>. We can see this in the posterior distribution of the ATE:</span>
<span id="cb34-512"><a href="#cb34-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-513"><a href="#cb34-513" aria-hidden="true" tabindex="-1"></a><span class="in">```{r make-tidy-posterior}</span></span>
<span id="cb34-514"><a href="#cb34-514" aria-hidden="true" tabindex="-1"></a><span class="in"># Make a long, tidy data frame of the posterior draws</span></span>
<span id="cb34-515"><a href="#cb34-515" aria-hidden="true" tabindex="-1"></a><span class="in">outcome_tidy &lt;- outcome_samples %&gt;% </span></span>
<span id="cb34-516"><a href="#cb34-516" aria-hidden="true" tabindex="-1"></a><span class="in">  tidy_draws() %&gt;% </span></span>
<span id="cb34-517"><a href="#cb34-517" aria-hidden="true" tabindex="-1"></a><span class="in">  rename(ate = `b[1]`)</span></span>
<span id="cb34-518"><a href="#cb34-518" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb34-519"><a href="#cb34-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-520"><a href="#cb34-520" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-ate-posterior}</span></span>
<span id="cb34-521"><a href="#cb34-521" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(outcome_tidy, aes(x = ate)) +</span></span>
<span id="cb34-522"><a href="#cb34-522" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_slab(aes(fill_ramp = after_stat(cut_cdf_qi(cdf, .width = c(0.02, 0.8, 0.95, 1)))),</span></span>
<span id="cb34-523"><a href="#cb34-523" aria-hidden="true" tabindex="-1"></a><span class="in">            fill = egypt[2]) +</span></span>
<span id="cb34-524"><a href="#cb34-524" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_ramp_discrete(range = c(1, 0.2), guide = "none") +</span></span>
<span id="cb34-525"><a href="#cb34-525" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Average treatment effect of using a mosquito net", y = NULL,</span></span>
<span id="cb34-526"><a href="#cb34-526" aria-hidden="true" tabindex="-1"></a><span class="in">       caption = "Median shown with vertical line; 80% and 95% credible intervals shown with shading")</span></span>
<span id="cb34-527"><a href="#cb34-527" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb34-528"><a href="#cb34-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-529"><a href="#cb34-529" aria-hidden="true" tabindex="-1"></a>We can calculate the proportion of this posterior distribution that is less than zero to find the <span class="co">[</span><span class="ot">*probability of direction*</span><span class="co">](https://easystats.github.io/bayestestR/articles/probability_of_direction.html)</span>, or the probability that the ATE is negative:</span>
<span id="cb34-530"><a href="#cb34-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-531"><a href="#cb34-531" aria-hidden="true" tabindex="-1"></a><span class="in">```{r prob-direction}</span></span>
<span id="cb34-532"><a href="#cb34-532" aria-hidden="true" tabindex="-1"></a><span class="in"># Find the proportion of posterior draws that are less than 0</span></span>
<span id="cb34-533"><a href="#cb34-533" aria-hidden="true" tabindex="-1"></a><span class="in">outcome_tidy %&gt;% </span></span>
<span id="cb34-534"><a href="#cb34-534" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(prop_lessthan_0 = sum(ate &lt; 0) / n())</span></span>
<span id="cb34-535"><a href="#cb34-535" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb34-536"><a href="#cb34-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-537"><a href="#cb34-537" aria-hidden="true" tabindex="-1"></a>Not surprisingly, given the distribution we saw above, there's a 100% chance that the ATE is negative.</span>
<span id="cb34-538"><a href="#cb34-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-539"><a href="#cb34-539" aria-hidden="true" tabindex="-1"></a>We can also calculate the proportion of the posterior distribution that falls within a <span class="co">[</span><span class="ot">*region of practical equivalence* (or ROPE)</span><span class="co">](https://easystats.github.io/bayestestR/articles/region_of_practical_equivalence.html)</span>. We can think of this as a "dead zone" of sorts. If the ATE is 0, we know for sure that there's no effect. If the ATE is something small like -0.51 or 0.73, we probably don't actually care—that's not a huge effect and could just be because of measurement error. If the ATE is sizable and far away from this "dead zone" / ROPE, we can be pretty confident of the substantiality of the effect.</span>
<span id="cb34-540"><a href="#cb34-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-541"><a href="#cb34-541" aria-hidden="true" tabindex="-1"></a>There are a lot of ways to determine the size of the ROPE. You can base it on experience with the phenomenon (e.g. you're an expert in public health and know that a 1-2 point change in malaria risk scores is small, while a 10+ change is big), or you can base it on the data you have (like <span class="in">`0.1 * sd(outcome)`</span>, <span class="co">[</span><span class="ot">which is a common approach</span><span class="co">](https://easystats.github.io/bayestestR/articles/region_of_practical_equivalence.html#how-to-define-the-rope-range-)</span>). </span>
<span id="cb34-542"><a href="#cb34-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-543"><a href="#cb34-543" aria-hidden="true" tabindex="-1"></a>For this example, we'll pretend that any effect between −7 and 7 doesn't matter—for an expert, values like 2.4 or −6 would be negligible. This is a ***huge*** ROPE, by the way! If we follow the 0.1 × the standard deviation of the outcome rule, the ROPE should only be ±<span class="in">`0.1 * sd(nets$malaria_risk)`</span>, or ±<span class="in">`r 0.1 * sd(nets$malaria_risk)`</span>. I'm using ±7 here just for the sake of illustration—I want to see the ROPE on the plot :)</span>
<span id="cb34-544"><a href="#cb34-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-545"><a href="#cb34-545" aria-hidden="true" tabindex="-1"></a><span class="in">```{r prop-rope}</span></span>
<span id="cb34-546"><a href="#cb34-546" aria-hidden="true" tabindex="-1"></a><span class="in"># Find the proportion of posterior draws that are less than 0</span></span>
<span id="cb34-547"><a href="#cb34-547" aria-hidden="true" tabindex="-1"></a><span class="in">prop_outside &lt;- outcome_tidy %&gt;% </span></span>
<span id="cb34-548"><a href="#cb34-548" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(prop_outside_rope = 1 - sum(ate &gt;= -7 &amp; ate &lt;= 7) / n())</span></span>
<span id="cb34-549"><a href="#cb34-549" aria-hidden="true" tabindex="-1"></a><span class="in">prop_outside</span></span>
<span id="cb34-550"><a href="#cb34-550" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb34-551"><a href="#cb34-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-552"><a href="#cb34-552" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-rope, warning=FALSE}</span></span>
<span id="cb34-553"><a href="#cb34-553" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(outcome_tidy, aes(x = ate)) +</span></span>
<span id="cb34-554"><a href="#cb34-554" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye(aes(fill_ramp = after_stat(x &gt;= 7 | x &lt;= -7)), </span></span>
<span id="cb34-555"><a href="#cb34-555" aria-hidden="true" tabindex="-1"></a><span class="in">               fill = egypt[2], .width = c(0.95, 0.8)) +</span></span>
<span id="cb34-556"><a href="#cb34-556" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_ramp_discrete(from = egypt[1], guide = "none") +</span></span>
<span id="cb34-557"><a href="#cb34-557" aria-hidden="true" tabindex="-1"></a><span class="in">  annotate(geom = "rect", xmin = -7, xmax = 0, ymin = -Inf, ymax = Inf, </span></span>
<span id="cb34-558"><a href="#cb34-558" aria-hidden="true" tabindex="-1"></a><span class="in">           fill = egypt[1], alpha = 0.3) +</span></span>
<span id="cb34-559"><a href="#cb34-559" aria-hidden="true" tabindex="-1"></a><span class="in">  annotate(geom = "label", x = -3.5, y = 0.75, label = "ROPE\n(dead zone)\n0 ± 7") +</span></span>
<span id="cb34-560"><a href="#cb34-560" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Average treatment effect of using a mosquito net", y = NULL,</span></span>
<span id="cb34-561"><a href="#cb34-561" aria-hidden="true" tabindex="-1"></a><span class="in">       caption = "Median shown with point; 80% and 95% credible intervals shown with black bars")</span></span>
<span id="cb34-562"><a href="#cb34-562" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb34-563"><a href="#cb34-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-564"><a href="#cb34-564" aria-hidden="true" tabindex="-1"></a>Using a gigantic ROPE of 0±7 malaria risk points, we can see that <span class="in">`r scales::percent(prop_outside$prop_outside_rope, accuracy = 0.1)`</span> of the posterior distribution lies outside the region of practical equivalence, which provides pretty strong evidence of a nice big ATE. This program definitely has an effect! (It's fake data! I made sure it had an effect!)</span>
<span id="cb34-565"><a href="#cb34-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-566"><a href="#cb34-566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-567"><a href="#cb34-567" aria-hidden="true" tabindex="-1"></a><span class="fu">## Using the results with **brms**</span></span>
<span id="cb34-568"><a href="#cb34-568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-569"><a href="#cb34-569" aria-hidden="true" tabindex="-1"></a>One issue with using <span class="in">`rstan::sampling()`</span> instead of **brms** is that we can't do nice things like automatic extraction of posterior expectations or predictions, since the MCMC samples we have are a `stanfit` object and not a `stanreg` object (which is what both **rstanarm** and **brms** produce):</span>
<span id="cb34-570"><a href="#cb34-570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-571"><a href="#cb34-571" aria-hidden="true" tabindex="-1"></a><span class="in">```{r epred-attempt, error=TRUE}</span></span>
<span id="cb34-572"><a href="#cb34-572" aria-hidden="true" tabindex="-1"></a><span class="in">posterior_epred(outcome_samples)</span></span>
<span id="cb34-573"><a href="#cb34-573" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb34-574"><a href="#cb34-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-575"><a href="#cb34-575" aria-hidden="true" tabindex="-1"></a>However, it is possible to <span class="co">[</span><span class="ot">create an empty **brms** object and stick the MCMC samples we made</span><span class="co">](https://github.com/paul-buerkner/brms/issues/682#issuecomment-501304142)</span> with <span class="in">`rstan::sampling()`</span> into it, which then allows us to do anything a regular **brms** model can do! This [only works when making minimal changes to the Stan code](https://discourse.mc-stan.org/t/creating-a-brmsfit-object-with-a-modified-brms-generated-stan-model/6840/2)—we can't modify the likelihood (or the `target` part of the `model` block of the Stan code). We didn't touch this part, though, so we can safely stick these samples into a **brms** object. </span>
<span id="cb34-576"><a href="#cb34-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-577"><a href="#cb34-577" aria-hidden="true" tabindex="-1"></a>To do this, we first have to create an empty model by using the <span class="in">`empty = TRUE`</span> argument. We also have to create a placeholder weights column, even though we're not actually fitting the model—**brms** will complain otherwise.</span>
<span id="cb34-578"><a href="#cb34-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-579"><a href="#cb34-579" aria-hidden="true" tabindex="-1"></a>We can then assign the <span class="in">`outcome_samples`</span> object to the <span class="in">`$fit`</span> slot of the empty model. Finally, we have to change the coefficient names to be nicer and compatible with **brms**. Note how earlier the coefficient for <span class="in">`net_num`</span> was named <span class="in">`b[1]`</span>, which was inconvenient. By using <span class="in">`brms::rename_pars()`</span>, we can change those subscripted/indexed names into nice names again.</span>
<span id="cb34-580"><a href="#cb34-580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-581"><a href="#cb34-581" aria-hidden="true" tabindex="-1"></a><span class="in">```{r make-brms-object}</span></span>
<span id="cb34-582"><a href="#cb34-582" aria-hidden="true" tabindex="-1"></a><span class="in"># Placeholder outcome model</span></span>
<span id="cb34-583"><a href="#cb34-583" aria-hidden="true" tabindex="-1"></a><span class="in">outcome_brms &lt;- brm(bf(malaria_risk | weights(iptw) ~ net_num),</span></span>
<span id="cb34-584"><a href="#cb34-584" aria-hidden="true" tabindex="-1"></a><span class="in">    # brms needs a column for the weights, even though we're not</span></span>
<span id="cb34-585"><a href="#cb34-585" aria-hidden="true" tabindex="-1"></a><span class="in">    # fitting the model, so create a placeholder column of 1s</span></span>
<span id="cb34-586"><a href="#cb34-586" aria-hidden="true" tabindex="-1"></a><span class="in">    data = nets %&gt;% mutate(iptw = 1),</span></span>
<span id="cb34-587"><a href="#cb34-587" aria-hidden="true" tabindex="-1"></a><span class="in">    empty = TRUE</span></span>
<span id="cb34-588"><a href="#cb34-588" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb34-589"><a href="#cb34-589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-590"><a href="#cb34-590" aria-hidden="true" tabindex="-1"></a><span class="in"># Add the samples from rstan::sampling() into the empty brms object and fix the</span></span>
<span id="cb34-591"><a href="#cb34-591" aria-hidden="true" tabindex="-1"></a><span class="in"># coefficient names (i.e. b[1] → b_net_num)</span></span>
<span id="cb34-592"><a href="#cb34-592" aria-hidden="true" tabindex="-1"></a><span class="in">outcome_brms$fit &lt;- outcome_samples</span></span>
<span id="cb34-593"><a href="#cb34-593" aria-hidden="true" tabindex="-1"></a><span class="in">outcome_brms &lt;- rename_pars(outcome_brms)</span></span>
<span id="cb34-594"><a href="#cb34-594" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb34-595"><a href="#cb34-595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-596"><a href="#cb34-596" aria-hidden="true" tabindex="-1"></a>The <span class="in">`outcome_brms`</span> object is now just like any regular **brms** model, and everything works with it:</span>
<span id="cb34-597"><a href="#cb34-597" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-598"><a href="#cb34-598" aria-hidden="true" tabindex="-1"></a><span class="in">```{r outcome-brms-results}</span></span>
<span id="cb34-599"><a href="#cb34-599" aria-hidden="true" tabindex="-1"></a><span class="in"># It works!</span></span>
<span id="cb34-600"><a href="#cb34-600" aria-hidden="true" tabindex="-1"></a><span class="in">summary(outcome_brms)</span></span>
<span id="cb34-601"><a href="#cb34-601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-602"><a href="#cb34-602" aria-hidden="true" tabindex="-1"></a><span class="in"># Predicted values work</span></span>
<span id="cb34-603"><a href="#cb34-603" aria-hidden="true" tabindex="-1"></a><span class="in">epreds &lt;- posterior_epred(outcome_brms)</span></span>
<span id="cb34-604"><a href="#cb34-604" aria-hidden="true" tabindex="-1"></a><span class="in">head(epreds, c(5, 10))</span></span>
<span id="cb34-605"><a href="#cb34-605" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb34-606"><a href="#cb34-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-607"><a href="#cb34-607" aria-hidden="true" tabindex="-1"></a><span class="in">```{r ppcheck-brms}</span></span>
<span id="cb34-608"><a href="#cb34-608" aria-hidden="true" tabindex="-1"></a><span class="in"># posterior predictive checks work!</span></span>
<span id="cb34-609"><a href="#cb34-609" aria-hidden="true" tabindex="-1"></a><span class="in">pp_check(outcome_brms)</span></span>
<span id="cb34-610"><a href="#cb34-610" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb34-611"><a href="#cb34-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-612"><a href="#cb34-612" aria-hidden="true" tabindex="-1"></a><span class="in">```{r emmeans, message=FALSE}</span></span>
<span id="cb34-613"><a href="#cb34-613" aria-hidden="true" tabindex="-1"></a><span class="in"># emmeans works too!</span></span>
<span id="cb34-614"><a href="#cb34-614" aria-hidden="true" tabindex="-1"></a><span class="in">library(emmeans)</span></span>
<span id="cb34-615"><a href="#cb34-615" aria-hidden="true" tabindex="-1"></a><span class="in">outcome_brms %&gt;%</span></span>
<span id="cb34-616"><a href="#cb34-616" aria-hidden="true" tabindex="-1"></a><span class="in">    emtrends(~net_num, var = "net_num")</span></span>
<span id="cb34-617"><a href="#cb34-617" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb34-618"><a href="#cb34-618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-619"><a href="#cb34-619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-620"><a href="#cb34-620" aria-hidden="true" tabindex="-1"></a><span class="fu">## Only tiny downside</span></span>
<span id="cb34-621"><a href="#cb34-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-622"><a href="#cb34-622" aria-hidden="true" tabindex="-1"></a>There's just one minor issue with this approach: all the sampling has to be done with **rstan**. For whatever reason, **cmdstanr** doesn't like the iteration tracking functions and it crashes. This might be because [**cmdstanr** is pickier about C++ namespaces](https://discourse.mc-stan.org/t/custom-c-using-cmdstanr/19528/7)? I'm not sure. If it did work, the code would look something like this:</span>
<span id="cb34-623"><a href="#cb34-623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-624"><a href="#cb34-624" aria-hidden="true" tabindex="-1"></a><span class="in">```{r cmdstanr-example, eval=FALSE}</span></span>
<span id="cb34-625"><a href="#cb34-625" aria-hidden="true" tabindex="-1"></a><span class="in">library(cmdstanr)</span></span>
<span id="cb34-626"><a href="#cb34-626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-627"><a href="#cb34-627" aria-hidden="true" tabindex="-1"></a><span class="in">outcome_model_cmdstanr &lt;- cmdstan_model(</span></span>
<span id="cb34-628"><a href="#cb34-628" aria-hidden="true" tabindex="-1"></a><span class="in">  stan_file = "modified_stan_code.stan",</span></span>
<span id="cb34-629"><a href="#cb34-629" aria-hidden="true" tabindex="-1"></a><span class="in">  cpp_options = list(USER_HEADER = here('iterfuns.hpp')),</span></span>
<span id="cb34-630"><a href="#cb34-630" aria-hidden="true" tabindex="-1"></a><span class="in">  stanc_options = list("allow-undefined")</span></span>
<span id="cb34-631"><a href="#cb34-631" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb34-632"><a href="#cb34-632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-633"><a href="#cb34-633" aria-hidden="true" tabindex="-1"></a><span class="in">outcome_samples_cmdstanr &lt;- outcome_model_cmdstanr$sample(data = outcome_data)</span></span>
<span id="cb34-634"><a href="#cb34-634" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb34-635"><a href="#cb34-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-636"><a href="#cb34-636" aria-hidden="true" tabindex="-1"></a>In spite of this, being able to use Bayesian models in both the treatment/design stage and the outcome/analysis stage is incredibly powerful!</span>
<span id="cb34-637"><a href="#cb34-637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-638"><a href="#cb34-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-639"><a href="#cb34-639" aria-hidden="true" tabindex="-1"></a><span class="fu">## References</span></span></code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
<p><span class="faux-block"><i class="fa-brands fa-creative-commons" aria-label="creative-commons"></i> 2007–2024 Andrew Heiss</span> <span class="faux-block">All content licensed under<br><a href="https://creativecommons.org/licenses/by/4.0/"><i class="fa-brands fa-creative-commons" aria-label="creative-commons"></i> <i class="fa-brands fa-creative-commons-by" aria-label="creative-commons-by"></i> Creative Commons CC BY 4.0</a></span></p>
</div>   
    <div class="nav-footer-center">
<p><span class="faux-block"><i class="fa-brands fa-orcid" aria-label="orcid"></i> <strong>ORCID</strong> <a href="https://orcid.org/0000-0002-3948-3914">0000-0002-3948-3914</a></span> <span class="faux-block"><i class="fa-solid fa-key" aria-label="key"></i> <a href="../../../../../pgp_ath.asc.txt">PGP public key</a>   <i class="fa-solid fa-fingerprint" aria-label="fingerprint"></i> Fingerprint:<br><span class="fingerprint">4AA2 FA83 A8B2 05A4 E30F<br> 610D 1382 6216 9178 36AB</span></span></p>
</div>
    <div class="nav-footer-right">
<p><span class="faux-block">Made with <i class="fa-brands fa-r-project" aria-label="r-project"></i> and <a href="https://quarto.org/">Quarto</a></span> <span class="faux-block"><a href="https://github.com/andrewheiss/ath-quarto">View the source at <i class="fa-brands fa-github" aria-label="github"></i> GitHub</a></span></p>
</div>
  </div>
</footer>


</body></html>