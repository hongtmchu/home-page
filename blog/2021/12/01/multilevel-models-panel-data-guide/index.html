<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Hong T.M. Chu">
<meta name="description" content="How to use multilevel models with R and brms to work with country-year panel data.">
<title>A guide to working with country-year panel data and Bayesian multilevel models | Hong T.M. Chu – Hong T.M. Chu</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../../../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../../../">
<link href="../../../../..//files/favicon-512.png" rel="icon" type="image/png">
<script src="../../../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../../../site_libs/quarto-html/quarto-syntax-highlighting-17c909d5fd25ae21b861c0c7a49b2096.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../../../site_libs/bootstrap/bootstrap-5cd0811f461c8271ae6bab49df9501be.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<link href="../../../../../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../../../../../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<script src="../../../../../site_libs/quarto-contrib/iconify-2.0.0/iconify-icon.min.js"></script><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script type="text/javascript">

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-527449-5', 'auto');

ga('send', {
  hitType: 'pageview',
  'anonymizeIp': true,
});
</script><style>

      .quarto-title-block .quarto-title-banner {
        background: #170C3A;
      }
</style>
<script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
<meta property="og:title" content="A guide to working with country-year panel data and Bayesian multilevel models | Hong T.M. Chu">
<meta property="og:description" content="How to use multilevel models with R and brms to work with country-year panel data.">
<meta property="og:image" content="https://www.andrewheiss.com/blog/2021/12/01/multilevel-models-panel-data-guide/index_files/figure-html/plot-global-hypothetical-year-year-1.png">
<meta property="og:site_name" content="Hong T.M. Chu">
<meta property="og:locale" content="en_US">
<meta property="og:image:height" content="1728">
<meta property="og:image:width" content="2592">
<meta name="twitter:title" content="A guide to working with country-year panel data and Bayesian multilevel models | Hong T.M. Chu">
<meta name="twitter:description" content="How to use multilevel models with R and brms to work with country-year panel data.">
<meta name="twitter:image" content="https://www.andrewheiss.com/blog/2021/12/01/multilevel-models-panel-data-guide/index_files/figure-html/plot-global-hypothetical-year-year-1.png">
<meta name="twitter:creator" content="@andrewheiss">
<meta name="twitter:site" content="@andrewheiss">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image-height" content="1728">
<meta name="twitter:image-width" content="2592">
</head>
<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../../../index.html">
    <span class="navbar-title">Hong T.M. Chu</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link" href="../../../../../index.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../cv/index.html"> 
<span class="menu-text">CV</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../research/index.html"> 
<span class="menu-text">Research</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../teaching/index.html"> 
<span class="menu-text">Teaching</span></a>
  </li>  
</ul>
<ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item">
    <a class="nav-link" href="mailto:hong.ctm@vinuni.edu.vn"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:envelope" style="font-size: 1.1em;" aria-label="Icon envelope from bi Iconify.design set." title="E-mail"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/andrewheiss" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:github" style="font-size: 1.1em;" aria-label="Icon github from bi Iconify.design set." title="GitHub"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.linkedin.com/in/hongtmchu" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:linkedin" style="font-size: 1.1em;" aria-label="Icon linkedin from bi Iconify.design set." title="LinkedIn"></iconify-icon></span></a>
  </li>  
</ul>
</div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><header id="title-block-header" class="quarto-title-block default blog-post page-columns page-full"><div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">A guide to working with country-year panel data and Bayesian multilevel models</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
                  <div>
        <div class="description">
          How to use multilevel models with R and brms to work with country-year panel data.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">r</div>
                <div class="quarto-category">tidyverse</div>
                <div class="quarto-category">regression</div>
                <div class="quarto-category">statistics</div>
                <div class="quarto-category">data visualization</div>
                <div class="quarto-category">bayes</div>
                <div class="quarto-category">brms</div>
                <div class="quarto-category">stan</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p><a href="https://www.andrewheiss.com/">Andrew Heiss</a> <a href="https://orcid.org/0000-0002-3948-3914" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">Wednesday, December 1, 2021</p>
      </div>
    </div>
    
      
      <div>
      <div class="quarto-title-meta-heading">Doi</div>
      <div class="quarto-title-meta-contents">
        <p class="doi">
          <a href="https://doi.org/10.59350/t19jz-ds665">10.59350/t19jz-ds665</a>
        </p>
      </div>
    </div>
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Contents</h2>
   
  <ul>
<li><a href="#who-this-guide-is-for" id="toc-who-this-guide-is-for" class="nav-link active" data-scroll-target="#who-this-guide-is-for">Who this guide is for</a></li>
  <li><a href="#example-data-health-and-wealth-over-time" id="toc-example-data-health-and-wealth-over-time" class="nav-link" data-scroll-target="#example-data-health-and-wealth-over-time">Example data: health and wealth over time</a></li>
  <li>
<a href="#the-effect-of-continent-country-and-time-on-life-expectancy" id="toc-the-effect-of-continent-country-and-time-on-life-expectancy" class="nav-link" data-scroll-target="#the-effect-of-continent-country-and-time-on-life-expectancy">The effect of continent, country, and time on life expectancy</a>
  <ul class="collapse">
<li><a href="#regular-regression" id="toc-regular-regression" class="nav-link" data-scroll-target="#regular-regression">Regular regression</a></li>
  <li><a href="#introduction-to-random-effects-intercepts-for-each-continent" id="toc-introduction-to-random-effects-intercepts-for-each-continent" class="nav-link" data-scroll-target="#introduction-to-random-effects-intercepts-for-each-continent">Introduction to random effects: Intercepts for each continent</a></li>
  <li><a href="#intercepts-for-each-country" id="toc-intercepts-for-each-country" class="nav-link" data-scroll-target="#intercepts-for-each-country">Intercepts for each country</a></li>
  <li><a href="#intercepts-and-slopes-for-each-country" id="toc-intercepts-and-slopes-for-each-country" class="nav-link" data-scroll-target="#intercepts-and-slopes-for-each-country">⭐ Intercepts and slopes for each country ⭐</a></li>
  <li><a href="#intercepts-and-slopes-for-each-country-account-for-year-specific-differences" id="toc-intercepts-and-slopes-for-each-country-account-for-year-specific-differences" class="nav-link" data-scroll-target="#intercepts-and-slopes-for-each-country-account-for-year-specific-differences">Intercepts and slopes for each country + account for year-specific differences</a></li>
  <li><a href="#intercepts-and-slopes-for-each-country-and-continent" id="toc-intercepts-and-slopes-for-each-country-and-continent" class="nav-link" data-scroll-target="#intercepts-and-slopes-for-each-country-and-continent">Intercepts and slopes for each country and continent</a></li>
  </ul>
</li>
  <li>
<a href="#quick-digression-on-logging-scaling-and-centering" id="toc-quick-digression-on-logging-scaling-and-centering" class="nav-link" data-scroll-target="#quick-digression-on-logging-scaling-and-centering">Quick digression on logging, scaling, and centering</a>
  <ul class="collapse">
<li><a href="#scaling-and-centering" id="toc-scaling-and-centering" class="nav-link" data-scroll-target="#scaling-and-centering">Scaling and centering</a></li>
  <li><a href="#logging" id="toc-logging" class="nav-link" data-scroll-target="#logging">Logging</a></li>
  </ul>
</li>
  <li>
<a href="#the-effect-of-wealth-on-health-accounting-for-country-and-time" id="toc-the-effect-of-wealth-on-health-accounting-for-country-and-time" class="nav-link" data-scroll-target="#the-effect-of-wealth-on-health-accounting-for-country-and-time">The effect of wealth on health, accounting for country and time</a>
  <ul class="collapse">
<li><a href="#regular-regression-1" id="toc-regular-regression-1" class="nav-link" data-scroll-target="#regular-regression-1">Regular regression</a></li>
  <li><a href="#each-country-gets-its-own-intercept-and-gdp-slope" id="toc-each-country-gets-its-own-intercept-and-gdp-slope" class="nav-link" data-scroll-target="#each-country-gets-its-own-intercept-and-gdp-slope">Each country gets its own intercept and GDP slope</a></li>
  <li><a href="#each-country-gets-its-own-intercept-and-gdp-and-year-slopes" id="toc-each-country-gets-its-own-intercept-and-gdp-and-year-slopes" class="nav-link" data-scroll-target="#each-country-gets-its-own-intercept-and-gdp-and-year-slopes">⭐ Each country gets its own intercept and GDP and year slopes ⭐</a></li>
  <li><a href="#each-country-gets-its-own-intercept-and-gdp-and-year-slopes-and-year-specific-offsets-in-the-gdp-slope" id="toc-each-country-gets-its-own-intercept-and-gdp-and-year-slopes-and-year-specific-offsets-in-the-gdp-slope" class="nav-link" data-scroll-target="#each-country-gets-its-own-intercept-and-gdp-and-year-slopes-and-year-specific-offsets-in-the-gdp-slope">Each country gets its own intercept and GDP and year slopes <em>and</em> year-specific offsets in the GDP slope</a></li>
  <li><a href="#each-continent-and-nested-country-gets-its-own-intercept-and-gdp-and-year-slopes" id="toc-each-continent-and-nested-country-gets-its-own-intercept-and-gdp-and-year-slopes" class="nav-link" data-scroll-target="#each-continent-and-nested-country-gets-its-own-intercept-and-gdp-and-year-slopes">Each continent and nested country gets its own intercept and GDP and year slopes</a></li>
  </ul>
</li>
  <li><a href="#other-ways-of-dealing-with-time" id="toc-other-ways-of-dealing-with-time" class="nav-link" data-scroll-target="#other-ways-of-dealing-with-time">Other ways of dealing with time</a></li>
  <li><a href="#tldr-holy-crap-this-was-so-long" id="toc-tldr-holy-crap-this-was-so-long" class="nav-link" data-scroll-target="#tldr-holy-crap-this-was-so-long">tl;dr holy crap this was so long</a></li>
  </ul></nav>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content"><p>In most of my research, I work with country-level panel data where each row is a country in a specific year (Afghanistan in 2010, Afghanistan in 2011, and so on), also known as time-series cross-sectional (TSCS) data. Building statistical models for TSCS panel data is tricky, and most introductory statistics classes don’t typically cover how to do it. Countries are repeated longitudinally over time, which means that time itself influences changes in the outcome variable. Countries also have internal trends and characteristics that influence the outcome—some might have a legacy of post-colonial civil war, for example. And to make it all more complex, countries are nested in continents and regions, and there might be regional trends that influence the outcome. Oh, and time-based trends can be different across countries and continents too. Working with all these different moving parts gets really difficult.</p>
<p>I have a few different past blog posts where I show some of the complexities of working with this kind of data, like <a href="https://www.andrewheiss.com/blog/2021/11/10/ame-bayes-re-guide/">calculating average marginal effects</a>, <a href="https://www.andrewheiss.com/blog/2020/12/03/ipw-tscs-msm/">generating inverse probability weights for panel data</a>, or <a href="https://www.andrewheiss.com/blog/2021/01/15/msm-gee-multilevel/">running marginal structural models on panel data</a>, and even one where I play with <a href="https://www.andrewheiss.com/blog/2021/08/25/twfe-diagnostics/">economists’ preferred approach to panel data: two-way fixed effects (TWFE)</a>. But I keep forgetting the basics of how to correctly structure multilevel models for country-year data, and all the examples I find online and in textbooks are about contexts I don’t work with (participants in an experimental sleep study!). When there are examples involving countries and years, they typically refer to individual people nested in countries nested in continents (like survey respondents) and not to whole countries, which trips me up when adapting their approaches.</p>
<p>So, as a service to future-me, here’s a basic guide to dealing with country-year panel data using Bayesian multilevel modeling!</p>
<p>This guide is hardly comprehensive or rigorous. I don’t use the intimidating math notation for nested random effects that everyone else uses. I don’t set any priors for the Bayesian models and instead just stick with the defaults, which are often inefficient. I don’t check any of the Bayesian model diagnostics (like <code>pp_check()</code>. In real life I do do all that, but this is just an overview of the practical mechanics of multilevel models, so I’m keeping it as basic and simple as possible.</p>
<p>There are a ton of other really helpful resources about multilevel models. I had all these open in tabs while building this guide:</p>
<ul>
<li>
<a href="https://bbolker.github.io/mixedmodels-misc/glmmFAQ.html#model-specification">Cheat sheet for the R syntax for nested models</a> (I refer to this <em>all the time</em>). <a href="https://stats.stackexchange.com/questions/13166/rs-lmer-cheat-sheet">The answers at this Cross Validated question</a> are also fantastic, especially for thinking about how to interpret the coefficients and think about which parts of which coefficients are fixed and random.</li>
<li>
<a href="https://m-clark.github.io/mixed-models-with-R/">Michael Clark’s guide to mixed models with R</a>, especially the <a href="https://m-clark.github.io/mixed-models-with-R/random_intercepts.html">mixed models</a>, <a href="https://m-clark.github.io/mixed-models-with-R/random_slopes.html">more random effects</a>, <a href="https://m-clark.github.io/mixed-models-with-R/extensions.html">common extensions</a>, and <a href="https://m-clark.github.io/mixed-models-with-R/bayesian.html">Bayesian approaches</a> sections.</li>
<li>Kristoffer Magnusson’s <a href="https://rpsychologist.com/r-guide-longitudinal-lme-lmer">“Using R and lme/lmer to fit different two- and three-level longitudinal models”</a>.</li>
<li>Solomon Kurz’s <a href="https://bookdown.org/ajkurz/Statistical_Rethinking_recoded/multilevel-models.html"><strong>tidyverse</strong>/<strong>brms</strong> translation of chapter 12 of Richard McElreath’s <em>Statistical Rethinking</em></a>.</li>
<li>Solomon Kurz’s <a href="https://bookdown.org/content/4253/"><strong>tidyverse</strong>/<strong>brms</strong> translation of Singer and Willett’s <em>Applied Longitudinal Data Analysis</em></a>, especially <a href="https://bookdown.org/content/4253/introducing-the-multilevel-model-for-change.html">chapter 3</a> and <a href="https://bookdown.org/content/4253/doing-data-analysis-with-the-multilevel-model-for-change.html">chapter 4</a>.</li>
<li>
<a href="https://www.nature.com/articles/nmeth.3137">This short <em>Nature</em> article</a> with a really neat graphic showing different types of nested and crossed random effects structures. <a href="https://yury-zablotski.netlify.app/post/mixed-effects-models-2/">Yury Zablotski’s post here</a> explores all of those types.</li>
<li>Sean Anderson’s <a href="https://github.com/seananderson/glmm-course">“Generalized Linear Mixed-Effects Modeling in R” workshop</a>, especially <a href="https://github.com/seananderson/glmm-course/blob/master/15-lmm-practice-gapminder.Rmd">section 15</a> which uses <strong>gapminder</strong> data.</li>
</ul>
<section id="who-this-guide-is-for" class="level2"><h2 class="anchored" data-anchor-id="who-this-guide-is-for">Who this guide is for</h2>
<p>Here’s what I assume you know:</p>
<ul>
<li><p>You’re familiar with <a href="https://www.r-project.org/">R</a> and the <a href="https://www.tidyverse.org/">tidyverse</a> (particularly <a href="https://dplyr.tidyverse.org/">dplyr</a> and <a href="https://ggplot2.tidyverse.org/">ggplot2</a>).</p></li>
<li><p>You’re familiar with <a href="https://paul-buerkner.github.io/brms/">brms</a> for running Bayesian regression models. See <a href="https://paul-buerkner.github.io/brms/articles/index.html">the vignettes here</a>, examples like <a href="https://www.rensvandeschoot.com/tutorials/brms-started/">this</a>, or <a href="https://evalf21.classes.andrewheiss.com/resource/bayes/#resources">resources like these</a> for an introduction.</p></li>
<li>
<p>You’re somewhat familiar with multilevel models. <a href="https://twitter.com/chelseaparlett/status/1458461737431146500">Confusingly</a>, these are also called mixed effect models, random effect models, and hierarchical models, among others! They’re all the same thing! (<small>image below by <a href="https://twitter.com/chelseaparlett/status/1458461737431146500">Chelsea Parlett-Pelleriti</a></small>)</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="chelsea-meme.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:60.0%"></p>
</figure>
</div>
</div>
</div>
<p>See examples like <a href="https://www.tjmahr.com/plotting-partial-pooling-in-mixed-effects-models/">this</a> or <a href="https://www.tjmahr.com/another-mixed-effects-model-visualization/">this</a> or <a href="https://www.rensvandeschoot.com/tutorials/lme4/">this</a> or <a href="https://rstudio-pubs-static.s3.amazonaws.com/63556_e35cc7e2dfb54a5bb551f3fa4b3ec4ae.html">this</a>. Basically Google “lme4 example” (lme4 is what you use for frequentist, non-Bayesian multilevel models with R) or “brms multilevel example” and you’ll find a bunch. For a more formal treatment, see chapter 12 in <a href="https://xcelab.net/rm/statistical-rethinking/">Richard McElreath’s <em>Statistcal Rethinking</em></a> book (or <a href="https://bookdown.org/content/3890/multilevel-models.html">this R translation of it</a> by Solomon Kurz).</p>
</li>
</ul>
<p>Let’s get started by loading all the libraries we’ll need (and creating a couple helper functions):</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>    <span class="co"># ggplot, dplyr, %&gt;%, and friends</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jennybc/gapminder">gapminder</a></span><span class="op">)</span>    <span class="co"># Country-year panel data from the Gapminder Project</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/paul-buerkner/brms">brms</a></span><span class="op">)</span>         <span class="co"># Bayesian modeling through Stan</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mjskay.github.io/tidybayes/">tidybayes</a></span><span class="op">)</span>    <span class="co"># Manipulate Stan objects in a tidy way</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://broom.tidymodels.org/">broom</a></span><span class="op">)</span>        <span class="co"># Convert model objects to data frames</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bbolker/broom.mixed">broom.mixed</a></span><span class="op">)</span>  <span class="co"># Convert brms model objects to data frames</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rvlenth.github.io/emmeans/">emmeans</a></span><span class="op">)</span>      <span class="co"># Calculate marginal effects in even fancier ways</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/teunbrand/ggh4x">ggh4x</a></span><span class="op">)</span>        <span class="co"># For nested facets in ggplot</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggrepel.slowkow.com/">ggrepel</a></span><span class="op">)</span>      <span class="co"># For nice non-overlapping labels in ggplot</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mjskay.github.io/ggdist/">ggdist</a></span><span class="op">)</span>       <span class="co"># For distribution-related ggplot geoms</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://scales.r-lib.org">scales</a></span><span class="op">)</span>       <span class="co"># For formatting numbers with comma(), dollar(), etc.</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com">patchwork</a></span><span class="op">)</span>    <span class="co"># For combining plots</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/malcolmbarrett/ggokabeito">ggokabeito</a></span><span class="op">)</span>   <span class="co"># Colorblind-friendly color palette</span></span>
<span></span>
<span><span class="co"># Make all the random draws reproducible</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Bayes stuff</span></span>
<span><span class="co"># Use the cmdstanr backend for Stan because it's faster and more modern than</span></span>
<span><span class="co"># the default rstan. You need to install the cmdstanr package first</span></span>
<span><span class="co"># (https://mc-stan.org/cmdstanr/) and then run cmdstanr::install_cmdstan() to</span></span>
<span><span class="co"># install cmdstan on your computer.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>mc.cores <span class="op">=</span> <span class="fl">4</span>,  <span class="co"># Use 4 cores</span></span>
<span>        brms.backend <span class="op">=</span> <span class="st">"cmdstanr"</span><span class="op">)</span></span>
<span><span class="va">bayes_seed</span> <span class="op">&lt;-</span> <span class="fl">1234</span></span>
<span></span>
<span><span class="co"># Custom ggplot theme to make pretty plots</span></span>
<span><span class="co"># Get Barlow Semi Condensed at https://fonts.google.com/specimen/Barlow+Semi+Condensed</span></span>
<span><span class="va">theme_clean</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span>base_family <span class="op">=</span> <span class="st">"Barlow Semi Condensed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">theme</span><span class="op">(</span>panel.grid.minor <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>          plot.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"white"</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>,</span>
<span>          plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>          axis.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>          strip.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span>, size <span class="op">=</span> <span class="fu">rel</span><span class="op">(</span><span class="fl">0.8</span><span class="op">)</span>, hjust <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>          strip.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"grey80"</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>,</span>
<span>          legend.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Make labels use Barlow by default</span></span>
<span><span class="fu">update_geom_defaults</span><span class="op">(</span><span class="st">"label_repel"</span>, </span>
<span>                     <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Barlow Semi Condensed"</span>,</span>
<span>                          fontface <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">update_geom_defaults</span><span class="op">(</span><span class="st">"label"</span>, </span>
<span>                     <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Barlow Semi Condensed"</span>,</span>
<span>                          fontface <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># The ggh4x paackage includes a `facet_nested()` function for nesting facets</span></span>
<span><span class="co"># (like countries in continents). Throughout this post, I want the</span></span>
<span><span class="co"># continent-level facets to use bolder text and a lighter gray strip. I don't</span></span>
<span><span class="co"># want to keep repeating all these settings, though, so I create a list of the</span></span>
<span><span class="co"># settings here with `strip_nested()` and feed it to `facet_nested_wrap()` later</span></span>
<span><span class="va">nested_settings</span> <span class="op">&lt;-</span> <span class="fu">strip_nested</span><span class="op">(</span></span>
<span>  text_x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu">element_text</span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Barlow Semi Condensed Black"</span>, </span>
<span>                             face <span class="op">=</span> <span class="st">"plain"</span><span class="op">)</span>, <span class="cn">NULL</span><span class="op">)</span>,</span>
<span>  background_x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu">element_rect</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"grey92"</span><span class="op">)</span>, <span class="cn">NULL</span><span class="op">)</span>,</span>
<span>  by_layer_x <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="example-data-health-and-wealth-over-time" class="level2"><h2 class="anchored" data-anchor-id="example-data-health-and-wealth-over-time">Example data: health and wealth over time</h2>
<p>Throughout this example, we’re going to use data from Hans Rosling’s <a href="https://www.gapminder.org/">Gapminder project</a> to explore the relationship between wealth (measured as GDP per capita, or average income per person) and health (measured as life expectancy). You may have seen Hans Rosling’s <a href="https://www.ted.com/talks/hans_rosling_shows_the_best_stats_you_ve_ever_seen">delightful TED talk</a> showing how global health and wealth have been increasing since 1800—he became internet famous because of this work. Sadly, Hans died in February 2017.</p>
<p>Before we start, watch this short 4-minute version of his famous health/wealth presentation. It’s the best overview of the complexities of the panel data we’re going to be working with:</p>
<div class="cell" data-layout-align="center">
<style type="text/css">
.video-container { position: relative; padding-bottom: 56.25%; padding-top: 30px; height: 0; overflow: hidden; margin-bottom: 1em;}

.video-container iframe, .video-container object, .video-container embed { position: absolute; top: 0; left: 0; width: 100%; height: 100%}
</style>
</div>
<div class="video-container">
<iframe src="https://www.youtube.com/embed/Z8t4k0Q8e8Y" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="">
</iframe>
</div>
<p>The original health/wealth data is all available at the <a href="https://www.gapminder.org/">Gapminder Project</a>, but Jenny Bryan has conveniently created <a href="https://github.com/jennybc/gapminder">an R package called <strong>gapminder</strong></a> with the data already cleaned and nicely structured, so we’ll use that. The data from <strong>gapminder</strong> includes observations from 142 different countries across 5 continents, and it ranges from 1952–2007 (skipping every five years, so there are observations for 1952, 1957, 1962, and so on). To simplify things, we’ll drop the Oceania continent (which includes only two countries: Australia and New Zealand), and we’ll choose two representative-ish countries in each of the remaining continents for the different country-specific trends we’ll be looking at throughout this guide.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Little dataset of 8 countries (2 for each of the 4 continents in the data)</span></span>
<span><span class="co"># that are good examples of different trends and intercepts</span></span>
<span><span class="va">countries</span> <span class="op">&lt;-</span> <span class="fu">tribble</span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">country</span>,       <span class="op">~</span><span class="va">continent</span>,</span>
<span>  <span class="st">"Egypt"</span>,        <span class="st">"Africa"</span>,</span>
<span>  <span class="st">"Sierra Leone"</span>, <span class="st">"Africa"</span>,</span>
<span>  <span class="st">"Pakistan"</span>,     <span class="st">"Asia"</span>,</span>
<span>  <span class="st">"Yemen, Rep."</span>,  <span class="st">"Asia"</span>,</span>
<span>  <span class="st">"Bolivia"</span>,      <span class="st">"Americas"</span>,</span>
<span>  <span class="st">"Canada"</span>,       <span class="st">"Americas"</span>,</span>
<span>  <span class="st">"Italy"</span>,        <span class="st">"Europe"</span>,</span>
<span>  <span class="st">"Portugal"</span>,     <span class="st">"Europe"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Clean up the gapminder data a little</span></span>
<span><span class="va">gapminder</span> <span class="op">&lt;-</span> <span class="fu">gapminder</span><span class="fu">::</span><span class="va">gapminder</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co"># Remove Oceania since there are only two countries there and we want bigger</span></span>
<span>  <span class="co"># continent clusters</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">continent</span> <span class="op">!=</span> <span class="st">"Oceania"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co"># Scale down GDP per capita so it's more interpretable ("a $1,000 increase in</span></span>
<span>  <span class="co"># GDP" vs. "a $1 increase in GDP")</span></span>
<span>  <span class="co"># Also log it</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>gdpPercap_1000 <span class="op">=</span> <span class="va">gdpPercap</span> <span class="op">/</span> <span class="fl">1000</span>,</span>
<span>         gdpPercap_log <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">gdpPercap</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu">starts_with</span><span class="op">(</span><span class="st">"gdp"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"z"</span> <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Make year centered on 1952 (so we're counting the years since 1952). This</span></span>
<span>  <span class="co"># (1) helps with interpretability, since the intercept will show the average</span></span>
<span>  <span class="co"># at 1952 instead of the average at 0 CE, and (2) helps with estimation speed</span></span>
<span>  <span class="co"># since brms/Stan likes to work with small numbers</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>year_orig <span class="op">=</span> <span class="va">year</span>,</span>
<span>         year <span class="op">=</span> <span class="va">year</span> <span class="op">-</span> <span class="fl">1952</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Indicator for the 8 countries we're focusing on</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>highlight <span class="op">=</span> <span class="va">country</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">countries</span><span class="op">$</span><span class="va">country</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract rows for the example countries</span></span>
<span><span class="va">original_points</span> <span class="op">&lt;-</span> <span class="va">gapminder</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">country</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">countries</span><span class="op">$</span><span class="va">country</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Use real years</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>year <span class="op">=</span> <span class="va">year_orig</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here’s what this cleaned up data looks like. Notice how the scaled and centered columns (the ones with the <code>_z</code> suffix) show up a little differently here (as one-column matrices)—we’ll see why that is later.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">glimpse</span><span class="op">(</span><span class="va">gapminder</span><span class="op">)</span></span>
<span><span class="co">## Rows: 1,680</span></span>
<span><span class="co">## Columns: 13</span></span>
<span><span class="co">## $ country          &lt;fct&gt; "Afghanistan", "Afghanistan", "Afghanistan", "Afghanistan", "Af…</span></span>
<span><span class="co">## $ continent        &lt;fct&gt; Asia, Asia, Asia, Asia, Asia, Asia, Asia, Asia, Asia, Asia, Asi…</span></span>
<span><span class="co">## $ year             &lt;dbl&gt; 0, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 0, 5, 10, 15, 20,…</span></span>
<span><span class="co">## $ lifeExp          &lt;dbl&gt; 28.8, 30.3, 32.0, 34.0, 36.1, 38.4, 39.9, 40.8, 41.7, 41.8, 42.…</span></span>
<span><span class="co">## $ pop              &lt;int&gt; 8425333, 9240934, 10267083, 11537966, 13079460, 14880372, 12881…</span></span>
<span><span class="co">## $ gdpPercap        &lt;dbl&gt; 779, 821, 853, 836, 740, 786, 978, 852, 649, 635, 727, 975, 160…</span></span>
<span><span class="co">## $ gdpPercap_1000   &lt;dbl&gt; 0.779, 0.821, 0.853, 0.836, 0.740, 0.786, 0.978, 0.852, 0.649, …</span></span>
<span><span class="co">## $ gdpPercap_log    &lt;dbl&gt; 6.66, 6.71, 6.75, 6.73, 6.61, 6.67, 6.89, 6.75, 6.48, 6.45, 6.5…</span></span>
<span><span class="co">## $ gdpPercap_z      &lt;dbl[,1]&gt; &lt;matrix[30 x 1]&gt;</span></span>
<span><span class="co">## $ gdpPercap_1000_z &lt;dbl[,1]&gt; &lt;matrix[30 x 1]&gt;</span></span>
<span><span class="co">## $ gdpPercap_log_z  &lt;dbl[,1]&gt; &lt;matrix[30 x 1]&gt;</span></span>
<span><span class="co">## $ year_orig        &lt;int&gt; 1952, 1957, 1962, 1967, 1972, 1977, 1982, 1987, 1992, 1997,…</span></span>
<span><span class="co">## $ highlight        &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FAL…</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="the-effect-of-continent-country-and-time-on-life-expectancy" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="the-effect-of-continent-country-and-time-on-life-expectancy">The effect of continent, country, and time on life expectancy</h2>
<p>Before we look at the relationship between wealth and health over time, it’s important to understand how multilevel modeling works, so we’ll simplify things and only look at the the relationship between life expectancy and time and how that relationship differs across continent and country.</p>
<p>As we saw in the video, pretty much every country’s life expectancy has increased over time. Countries all have different starting points or intercepts in 1952, and continent-specific differences influence those intercepts (e.g., Western Europe has much higher life expectancy than sub-Saharan Africa), and countries each have their own trends over time. Compare Egypt, which starts off fairly low and then rockets up fairly quickly from the 1970s to the 1990s, with Canada, which starts fairly high and ends really high. Some countries see negative trends over time, like Rwanda and Sierra Leone.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">gapminder</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">year_orig</span>, y <span class="op">=</span> <span class="va">lifeExp</span>, </span>
<span>                      group <span class="op">=</span> <span class="va">country</span>, color <span class="op">=</span> <span class="va">continent</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>size <span class="op">=</span> <span class="va">highlight</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_smooth</span><span class="op">(</span>method <span class="op">=</span> <span class="st">"lm"</span>, <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="cn">NULL</span>, group <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span>, </span>
<span>              color <span class="op">=</span> <span class="st">"grey60"</span>, size <span class="op">=</span> <span class="fl">1</span>, linetype <span class="op">=</span> <span class="st">"21"</span>,</span>
<span>              se <span class="op">=</span> <span class="cn">FALSE</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_label_repel</span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">gapminder</span>, <span class="va">year</span> <span class="op">==</span> <span class="fl">0</span>, <span class="va">highlight</span> <span class="op">==</span> <span class="cn">TRUE</span><span class="op">)</span>, </span>
<span>                   <span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">country</span><span class="op">)</span>, direction <span class="op">=</span> <span class="st">"y"</span>, size <span class="op">=</span> <span class="fl">3</span>, seed <span class="op">=</span> <span class="fl">1234</span>, </span>
<span>                   show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">annotate</span><span class="op">(</span>geom <span class="op">=</span> <span class="st">"label"</span>, label <span class="op">=</span> <span class="st">"Global trend"</span>, x <span class="op">=</span> <span class="fl">1952</span>, y <span class="op">=</span> <span class="fl">50</span>,</span>
<span>           size <span class="op">=</span> <span class="fl">3</span>, color <span class="op">=</span> <span class="st">"grey60"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_size_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.075</span>, <span class="fl">1</span><span class="op">)</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_okabe_ito</span><span class="op">(</span>order <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">6</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="cn">NULL</span>, y <span class="op">=</span> <span class="st">"Life expectancy"</span>, color <span class="op">=</span> <span class="st">"Continent"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_clean</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span>
<span><span class="co">## `geom_smooth()` using formula = 'y ~ x'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/plot-year-trends-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page-inset-right" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<section id="regular-regression" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="regular-regression">Regular regression</h3>
<p>To start, we’ll make a simple boring model that completely ignores continent- and country-level differences and only looks at how much life expectancy increases over time. This is the dotted gray line in the plot above.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/model-boring_278733751ad7f2f50f174e502252744f">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_boring</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span></span>
<span>  <span class="fu">bf</span><span class="op">(</span><span class="va">lifeExp</span> <span class="op">~</span> <span class="va">year</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">gapminder</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="va">bayes_seed</span></span>
<span><span class="op">)</span></span>
<span><span class="co">## Start sampling</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_boring</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 3 × 8</span></span>
<span><span class="co">##   effect   component group    term            estimate std.error conf.low conf.high</span></span>
<span><span class="co">##   &lt;chr&gt;    &lt;chr&gt;     &lt;chr&gt;    &lt;chr&gt;              &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 fixed    cond      &lt;NA&gt;     (Intercept)       50.3      0.530    49.2      51.3  </span></span>
<span><span class="co">## 2 fixed    cond      &lt;NA&gt;     year               0.327    0.0166    0.295     0.360</span></span>
<span><span class="co">## 3 ran_pars cond      Residual sd__Observation   11.6      0.197    11.2      12.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>When <code>year</code> is zero, or in 1952, the average life expectancy is 50.26 years, and it increases by 0.33 years each year after that.</p>
<p>That’s cool, I guess, but we’re ignoring the structure of the data. We’re not accounting for any of the country-specific or region-specific trends that might also influence life expectancy. This is apparent when we plot predictions from this model—each country has the same predicted trend and the same starting point. None of these lines fit any of the example countries at all.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pred_model_boring</span> <span class="op">&lt;-</span> <span class="va">model_boring</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">epred_draws</span><span class="op">(</span>newdata <span class="op">=</span> <span class="fu">expand_grid</span><span class="op">(</span>country <span class="op">=</span> <span class="va">countries</span><span class="op">$</span><span class="va">country</span>,</span>
<span>                                    year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">gapminder</span><span class="op">$</span><span class="va">year</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>year <span class="op">=</span> <span class="va">year</span> <span class="op">+</span> <span class="fl">1952</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">countries</span>, by <span class="op">=</span> <span class="st">"country"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">pred_model_boring</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span>, y <span class="op">=</span> <span class="va">.epred</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>data <span class="op">=</span> <span class="va">original_points</span>, <span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">lifeExp</span><span class="op">)</span>, </span>
<span>             color <span class="op">=</span> <span class="st">"grey50"</span>, size <span class="op">=</span> <span class="fl">3</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_lineribbon</span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.5</span>, size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_brewer</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Reds"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Global year trend with no country-based variation"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"lifeExp ~ year"</span>,</span>
<span>       x <span class="op">=</span> <span class="cn">NULL</span>, y <span class="op">=</span> <span class="st">"Predicted life expectancy"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_nested_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">continent</span>, <span class="va">country</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">2</span>, strip <span class="op">=</span> <span class="va">nested_settings</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_clean</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>        plot.subtitle <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Consolas"</span><span class="op">)</span>,</span>
<span>        axis.text.x <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">45</span>, hjust <span class="op">=</span> <span class="fl">0.5</span>, vjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/plot-preds-boring-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page-inset-right" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
</section><section id="introduction-to-random-effects-intercepts-for-each-continent" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="introduction-to-random-effects-intercepts-for-each-continent">Introduction to random effects: Intercepts for each continent</h3>
<p>For now, we’re interested in the effect of time on life expectancy: how much does life expectancy increase on average as time passes (or as <code>year</code> increases)? We already estimated this basic model:</p>
<p><span class="math display">\[
\text{Life expectancy} = \beta_0 + \beta_1 \text{Year} + \epsilon
\]</span></p>
<p>The year effect here is the <span class="math inline">\(\beta_1\)</span> coefficient, but this global estimate doesn’t account for continent- or country-specific differences, and that kind of variation is important—we don’t necessarily want to combine the trends in life expectancy across Western Europe and Latin America since they’re so different.</p>
<p>That <span class="math inline">\(\epsilon\)</span> error term is doing a lot of work. It represents all the variation in life expectancy that’s not explained by (1) the baseline global life expectancy when <code>year</code> is 0 (or 1952), and by (2) increases in <code>year</code>. All sorts of unmeasured things are hidden in that <span class="math inline">\(\epsilon\)</span>, like continent-level differences that might explain some additional variation in life expectancy. We can pull that continent-specific variation out of the error term to show that it exists:</p>
<p><span class="math display">\[
\text{Life expectancy} = \beta_0 + \beta_1 \text{Year} + (b_{\text{Continent}} + \epsilon)
\]</span></p>
<p>We use the Latin letter <span class="math inline">\(b\)</span> instead of the Greek <span class="math inline">\(\beta\)</span> to signal that it’s a different kind of parameter. The <span class="math inline">\(\beta\)</span> parameters are “fixed effects” (this gets <strong><em>so confusing</em></strong> since in the world of econometrics and political science, “fixed effects” typically refer to indicator variables, like when you control for state or country. That’s <em>not</em> the case here! Fixed effects here refer to population-level parameters that apply to all the observations in the data. Random effects refer to variations or deviations within subpopulations in the data (country, year, region, etc.)). Random effects, or <span class="math inline">\(b\)</span>, show the offset from specific fixed parameters.</p>
<p>Right now, this continent-level offset is hidden in the unestimated error term <span class="math inline">\(\epsilon\)</span>, but we can move it around and pair it with one of the fixed terms in the model: either the intercept or year. For now we’ll lump it in with the intercept and say that this continent random effect shifts the intercept up and down based on continent-level differences (we’ll lump it in with the year effect a little later). We can rewrite our model like this now:</p>
<p><span class="math display">\[
\text{Life expectancy} = (\beta_0 + b_{0, \text{Continent}}) + \beta_1 \text{Year} + \epsilon
\]</span></p>
<p>All we’ve really done is take <span class="math inline">\(b_{\text{Continent}}\)</span>, move it over next to the intercept term <span class="math inline">\(\beta_0\)</span>, and add a 0 subscript to show that it represents the offset or deviation from <span class="math inline">\(\beta_0\)</span> for each continent.</p>
<p>If you’ve ever worked with regular old OLS regression with <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code>, you might be thinking that this is basically just the same as including an indicator variable for continent. For instance, if you run a model like this…</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_super_boring</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">lifeExp</span> <span class="op">~</span> <span class="va">year</span> <span class="op">+</span> <span class="va">continent</span>, data <span class="op">=</span> <span class="va">gapminder</span><span class="op">)</span></span>
<span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_super_boring</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 5 × 5</span></span>
<span><span class="co">##   term              estimate std.error statistic   p.value</span></span>
<span><span class="co">##   &lt;chr&gt;                &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 (Intercept)         39.9      0.411       97.0 0        </span></span>
<span><span class="co">## 2 year                 0.328    0.0104      31.5 2.97e-171</span></span>
<span><span class="co">## 3 continentAmericas   15.8      0.517       30.5 3.47e-163</span></span>
<span><span class="co">## 4 continentAsia       11.2      0.473       23.7 3.69e-107</span></span>
<span><span class="co">## 5 continentEurope     23.0      0.487       47.3 9.85e-311</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>…you get coefficients for each of the continents (except Africa, which is the base case). You can then add these continent-specific coefficients to the intercept to get continent-specific intercepts. For example, the average life expectancy in Africa in 1952 (i.e.&nbsp;when <code>year</code> is 0, or the intercept) is 39.86 years. Europe’s average life expectancy in 1952 is 39.86 + 23.04, or 62.9 years, and so on.</p>
<p>So why use these random effects instead of using indicator variables like this?</p>
<p>One reason is that thinking about these group-specific offsets as random effects allows us to model them more richly. We can define the whole range of group offsets using a distribution. For example, we could say that the intercept offsets are normally distributed with a mean of 0 and a standard deviation of <span class="math inline">\(\tau\)</span> (note that we’re using Greek again—this <span class="math inline">\(\tau\)</span> variance is a population-level parameter and doesn’t vary by group). Some continents will have a positive offset; some will have a negative offset; in general the average of the offsets should be 0; and the variation in those offsets can be measured with <span class="math inline">\(\tau\)</span>.</p>
<p><span class="math display">\[
b_{0, \text{Continent}} \sim \mathcal{N}(0, \tau)
\]</span></p>
<p>Notice how we’re now working with a regression model with two parts: one part at a continent level where we estimate continent-specific offsets in the intercept, and one part at the observation level (which in this case is countries). That’s why this approach is often called “multilevel modeling”—we have multiple levels in our model:</p>
<p><span class="math display">\[
\begin{aligned}
\text{Life expectancy} &amp;= (\beta_0 + b_{0, \text{Continent}}) + \beta_1 \text{Year} + \epsilon \\
b_{0, \text{Continent}} &amp;\sim \mathcal{N}(0, \tau)
\end{aligned}
\]</span></p>
<section id="fixed-population-level-effects" class="level4"><h4 class="anchored" data-anchor-id="fixed-population-level-effects">Fixed (population-level) effects</h4>
<p>Here’s what this looks like in practice. We’ll take our boring basic model and add a <code>(1 | continent)</code> term, which means that we’re letting the intercept (or <code>1</code>) vary by continent. This is the code version of lumping the random continent effect with the intercept, or creating <span class="math inline">\((\beta_0 + b_{0, \text{Continent}})\)</span>.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/model-continent-only_72cf213decf099ee11d63f2a51668efb">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Each continent gets its own intercept</span></span>
<span><span class="va">model_continent_only</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span></span>
<span>  <span class="fu">bf</span><span class="op">(</span><span class="va">lifeExp</span> <span class="op">~</span> <span class="va">year</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">continent</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">gapminder</span>,</span>
<span>  control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>adapt_delta <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="va">bayes_seed</span></span>
<span><span class="op">)</span></span>
<span><span class="co">## Start sampling</span></span>
<span><span class="co">## Warning: 2 of 4000 (0.0%) transitions ended with a divergence.</span></span>
<span><span class="co">## See https://mc-stan.org/misc/warnings for details.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If we look at the results we find basically the same coefficients we found in the original boring model: average global life expectancy in 1952 is 52.4 years, and it increases by 0.33 each year after that, on average. We also have errors and credible intervals, like any regular <strong>brms</strong>-based regression model.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_continent_only</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 4 × 8</span></span>
<span><span class="co">##   effect   component group     term            estimate std.error conf.low conf.high</span></span>
<span><span class="co">##   &lt;chr&gt;    &lt;chr&gt;     &lt;chr&gt;     &lt;chr&gt;              &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 fixed    cond      &lt;NA&gt;      (Intercept)       52.4      5.83     40.8      64.3  </span></span>
<span><span class="co">## 2 fixed    cond      &lt;NA&gt;      year               0.328    0.0105    0.306     0.348</span></span>
<span><span class="co">## 3 ran_pars cond      continent sd__(Intercept)   12.4      5.52      5.67     27.3  </span></span>
<span><span class="co">## 4 ran_pars cond      Residual  sd__Observation    7.37     0.126     7.13      7.62</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>These <span class="math inline">\(\beta_0\)</span> and <span class="math inline">\(\beta_1\)</span> coefficients for the intercept and year are considered “fixed effects” (again, this is totally unrelated to the idea of indicator variables from econometrics, political science, and other social sciences!). These are population-level parameters that transcend continent-specific differences. The default results from <code><a href="https://rdrr.io/r/base/summary.html">summary()</a></code> make this distinction a little more clear and calls them “Population-Level Effects”:</p>
<div class="cell" data-layout-align="center" data-output.lines="[13,14,15,16]">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">model_continent_only</span><span class="op">)</span></span>
<span><span class="va">...</span></span>
<span><span class="co">## Population-Level Effects: </span></span>
<span><span class="co">##           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span><span class="co">## Intercept    52.40      5.83    40.78    64.29 1.01      865     1119</span></span>
<span><span class="co">## year          0.33      0.01     0.31     0.35 1.00     2351     2081</span></span>
<span><span class="va">...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can clean up the results from <code>tidy()</code> and show only these fixed effects with the <code>effects = "fixed"</code> argument:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_continent_only</span>, effects <span class="op">=</span> <span class="st">"fixed"</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 2 × 7</span></span>
<span><span class="co">##   effect component term        estimate std.error conf.low conf.high</span></span>
<span><span class="co">##   &lt;chr&gt;  &lt;chr&gt;     &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 fixed  cond      (Intercept)   52.4      5.83     40.8      64.3  </span></span>
<span><span class="co">## 2 fixed  cond      year           0.328    0.0105    0.306     0.348</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="continent-level-variance" class="level4"><h4 class="anchored" data-anchor-id="continent-level-variance">Continent-level variance</h4>
<p>The whole reason we’re using a multilevel model here instead of just using indicator variables is that we can use information about the variation in continents to improve our coefficient estimates and model accuracy. Notice that there were extra new parameters in the output from <code>tidy()</code>, which we can also see if we use the <code>effects = "ran_pars"</code> argument (these also show up in the output from <code><a href="https://rdrr.io/r/base/summary.html">summary()</a></code> as “Group-Level Effects”):</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_continent_only</span>, effects <span class="op">=</span> <span class="st">"ran_pars"</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 2 × 8</span></span>
<span><span class="co">##   effect   component group     term            estimate std.error conf.low conf.high</span></span>
<span><span class="co">##   &lt;chr&gt;    &lt;chr&gt;     &lt;chr&gt;     &lt;chr&gt;              &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 ran_pars cond      continent sd__(Intercept)    12.4      5.52      5.67     27.3 </span></span>
<span><span class="co">## 2 ran_pars cond      Residual  sd__Observation     7.37     0.126     7.13      7.62</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We have two extra random parameters here:</p>
<ol type="1">
<li>The estimated variance/standard deviation of the continent effect, or <span class="math inline">\(\tau\)</span> from our <span class="math inline">\(b_{0, \text{Continent}} \sim \mathcal{N}(0, \tau)\)</span> model level from before, represented with the <code>sd__(Intercept)</code> term in the <code>continent</code> group: <strong>12.4</strong>
</li>
<li>The total residual variation (i.e.&nbsp;unexplained variation in life expectancy), represented with the <code>sd__Observation</code> term in the <code>Residual</code> group: <strong>7.37</strong>
</li>
</ol>
<p>To borrow heavily from <a href="https://m-clark.github.io/mixed-models-with-R/random_intercepts.html#variance-components">Michael Clark’s excellent explanation of these variance components</a>, this <span class="math inline">\(\tau\)</span> parameter tells how much life expectancy bounces around as we move from continent to continent. We can predict life expectancy based on the year trend, but each continent has its own unique life expectancy offset, and this <span class="math inline">\(\tau\)</span> is the average deviation across all the continents. Practically speaking, there’s a substantial amount of cross-continent variation here: 12.4 years!</p>
<p>We can also think about this continent-level variance as a percentage of the total residual variance in the model. Continent-level variation contributes 63% (12.4 / (12.4 + 7.37)) of the total variance in life expectancy.</p>
</section><section id="continent-level-random-effects" class="level4"><h4 class="anchored" data-anchor-id="continent-level-random-effects">Continent-level random effects</h4>
<p>We can see these actual offsets with the <code>ranef()</code> function. By default this returns an unwieldy list with multi-dimensional arrays nested in it, so we’ll convert it to a nice data frame here so we can work with it later.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">continent_offsets</span> <span class="op">&lt;-</span> <span class="fu">ranef</span><span class="op">(</span><span class="va">model_continent_only</span><span class="op">)</span><span class="op">$</span><span class="va">continent</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">as_tibble</span><span class="op">(</span>rownames <span class="op">=</span> <span class="st">"continent"</span><span class="op">)</span></span>
<span><span class="va">continent_offsets</span></span>
<span><span class="co">## # A tibble: 4 × 5</span></span>
<span><span class="co">##   continent Estimate.Intercept Est.Error.Intercept Q2.5.Intercept Q97.5.Intercept</span></span>
<span><span class="co">##   &lt;chr&gt;                  &lt;dbl&gt;               &lt;dbl&gt;          &lt;dbl&gt;           &lt;dbl&gt;</span></span>
<span><span class="co">## 1 Africa                -12.5                 5.81         -24.3           -0.830</span></span>
<span><span class="co">## 2 Americas                3.24                5.81          -8.52          15.1  </span></span>
<span><span class="co">## 3 Asia                   -1.34                5.81         -13.1           10.5  </span></span>
<span><span class="co">## 4 Europe                 10.5                 5.82          -1.37          22.3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Each of these estimates represent the continent-specific offsets in the intercept, or <span class="math inline">\(b_{0, \text{Continent}}\)</span>. To help with the intuition, we can add these offsets to the global population-level intercept to see the actual intercept for each continent. Let’s plug these values into our model equation, with year set to 0 (or 1952):</p>
<p><span class="math display">\[
\begin{aligned}
\text{Life expectancy}_\text{general} &amp;= (\beta_0 + b_{0, \text{Continent}}) + \beta_1 \text{Year} + \epsilon \\
\text{Life expectancy}_\text{Africa} &amp;= (52.4 + -12.52) + (0.33 \times 0) = 39.87 \\
\text{Life expectancy}_\text{Americas} &amp;= (52.4 + 3.24) + (0.33 \times 0) = 55.64 \\
\text{Life expectancy}_\text{Asia} &amp;= (52.4 + -1.34) + (0.33 \times 0) = 51.06 \\
\text{Life expectancy}_\text{Europe} &amp;= (52.4 + 10.48) + (0.33 \times 0) = 62.88
\end{aligned}
\]</span></p>
<p>We don’t need to do this all by hand though. The <code><a href="https://rdrr.io/r/stats/coef.html">coef()</a></code> function will return these group-specific intercepts with the offsets already incorporated. Notice how the results are the same—each continent has its own intercept, while the <span class="math inline">\(\beta_1\)</span> coefficient for <code>year</code> is the same across continents:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">model_continent_only</span><span class="op">)</span><span class="op">$</span><span class="va">continent</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">as_tibble</span><span class="op">(</span>rownames <span class="op">=</span> <span class="st">"continent"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">continent</span>, <span class="fu">starts_with</span><span class="op">(</span><span class="st">"Estimate"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 4 × 3</span></span>
<span><span class="co">##   continent Estimate.Intercept Estimate.year</span></span>
<span><span class="co">##   &lt;chr&gt;                  &lt;dbl&gt;         &lt;dbl&gt;</span></span>
<span><span class="co">## 1 Africa                  39.9         0.328</span></span>
<span><span class="co">## 2 Americas                55.6         0.328</span></span>
<span><span class="co">## 3 Asia                    51.1         0.328</span></span>
<span><span class="co">## 4 Europe                  62.9         0.328</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Alternatively, we can also use the powerful <strong>emmeans</strong> package to calculate predicted values at different combinations of our model’s variables. In this case our model uses a Gaussian distribution so it works like regular OLS regression (which means we can just add coefficients together), but other models like logistic regression or beta regression require a lot more work to combine the coefficients correctly. The <code>emmeans()</code> function will calculate predicted values of life expectancy, while the <code>emtrends()</code> function will calculate coefficients, incorporating group-level effects as needed (that’s what the <code>re_formula = NULL</code> argument is doing here; see <a href="https://www.andrewheiss.com/blog/2021/11/10/ame-bayes-re-guide/">this post for more details about that</a>). These values should be the same that we found both manually with math and with <code><a href="https://rdrr.io/r/stats/coef.html">coef()</a></code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_continent_only</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">emmeans</span><span class="op">(</span><span class="op">~</span> <span class="va">continent</span> <span class="op">+</span> <span class="va">year</span>,</span>
<span>          at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,  <span class="co"># Look at predicted values for 1952</span></span>
<span>          epred <span class="op">=</span> <span class="cn">TRUE</span>,  <span class="co"># Use expected predictions from the posterior</span></span>
<span>          re_formula <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span>  <span class="co"># Incorporate random effects</span></span>
<span><span class="co">## Loading required namespace: rstanarm</span></span>
<span><span class="co">##  continent year emmean lower.HPD upper.HPD</span></span>
<span><span class="co">##  Africa       0   39.9      39.1      40.7</span></span>
<span><span class="co">##  Americas     0   55.6      54.7      56.7</span></span>
<span><span class="co">##  Asia         0   51.1      50.1      51.9</span></span>
<span><span class="co">##  Europe       0   62.9      61.9      63.8</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Point estimate displayed: median </span></span>
<span><span class="co">## HPD interval probability: 0.95</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="visualize-continent-specific-trends" class="level4 page-columns page-full"><h4 class="anchored" data-anchor-id="visualize-continent-specific-trends">Visualize continent-specific trends</h4>
<p>Finally, let’s visualize this continent-specific year trend. Each of these lines has the same slope, but the intercepts now shift up and down based on continent. The lines are substantially higher in Europe and substantially lower in Africa:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">newdata_country_continent</span> <span class="op">&lt;-</span> <span class="fu">expand_grid</span><span class="op">(</span>country <span class="op">=</span> <span class="va">countries</span><span class="op">$</span><span class="va">country</span>,</span>
<span>                                         year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">gapminder</span><span class="op">$</span><span class="va">year</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">countries</span>, by <span class="op">=</span> <span class="st">"country"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pred_model_continent_only</span> <span class="op">&lt;-</span> <span class="va">model_continent_only</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">epred_draws</span><span class="op">(</span><span class="va">newdata_country_continent</span>, re_formula <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>year <span class="op">=</span> <span class="va">year</span> <span class="op">+</span> <span class="fl">1952</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">pred_model_continent_only</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span>, y <span class="op">=</span> <span class="va">.epred</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>data <span class="op">=</span> <span class="va">original_points</span>, <span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">lifeExp</span><span class="op">)</span>,</span>
<span>             color <span class="op">=</span> <span class="st">"grey50"</span>, size <span class="op">=</span> <span class="fl">3</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_lineribbon</span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_brewer</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Reds"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Intercepts for year trend vary by continent"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"lifeExp ~ year + (1 | continent)"</span>,</span>
<span>       x <span class="op">=</span> <span class="cn">NULL</span>, y <span class="op">=</span> <span class="st">"Predicted life expectancy"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_nested_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">continent</span>, <span class="va">country</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">2</span>, strip <span class="op">=</span> <span class="va">nested_settings</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_clean</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>        plot.subtitle <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Consolas"</span><span class="op">)</span>,</span>
<span>        axis.text.x <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">45</span>, hjust <span class="op">=</span> <span class="fl">0.5</span>, vjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/plot-preds-continent-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page-inset-right" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section></section><section id="intercepts-for-each-country" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="intercepts-for-each-country">Intercepts for each country</h3>
<p>Continent-level effects are neat, but the predicted trends in the plot above still don’t really fit the data that well (except maybe in Europe). Instead of including random effects for continents, we can include country effects so that each country gets its own offset and intercept. Let’s make this model:</p>
<p><span class="math display">\[
\begin{aligned}
\text{Life expectancy} &amp;= (\beta_0 + b_{0, \text{Country}}) + \beta_1 \text{Year} + \epsilon \\
b_{0, \text{Country}} &amp;\sim \mathcal{N}(0, \tau)
\end{aligned}
\]</span></p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/model-country-only_c12f4c415f4ea8d41197eeeff8e6aedf">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Each country gets its own intercept</span></span>
<span><span class="va">model_country_only</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span></span>
<span>  <span class="fu">bf</span><span class="op">(</span><span class="va">lifeExp</span> <span class="op">~</span> <span class="va">year</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">country</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">gapminder</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="va">bayes_seed</span>,</span>
<span>  iter <span class="op">=</span> <span class="fl">4000</span>  <span class="co"># Double the number of iterations to help with convergence</span></span>
<span><span class="op">)</span></span>
<span><span class="co">## Start sampling</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_country_only</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 4 × 8</span></span>
<span><span class="co">##   effect   component group    term            estimate std.error conf.low conf.high</span></span>
<span><span class="co">##   &lt;chr&gt;    &lt;chr&gt;     &lt;chr&gt;    &lt;chr&gt;              &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 fixed    cond      &lt;NA&gt;     (Intercept)       50.3     0.909     48.5      52.0  </span></span>
<span><span class="co">## 2 fixed    cond      &lt;NA&gt;     year               0.328   0.00516    0.317     0.338</span></span>
<span><span class="co">## 3 ran_pars cond      country  sd__(Intercept)   11.1     0.655      9.93     12.5  </span></span>
<span><span class="co">## 4 ran_pars cond      Residual sd__Observation    3.60    0.0657     3.48      3.73</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="fixed-population-level-effects-1" class="level4"><h4 class="anchored" data-anchor-id="fixed-population-level-effects-1">Fixed (population-level) effects</h4>
<p>The global population-level coefficients (or “fixed effects”, but <strong><em>again</em></strong> these are not the same as indicator variables!) are roughly the same that we saw in both the original boring model and the model with continent effects: in 1952 (when <code>year</code> is 0) the average life expectancy is 50.3 years, and it increases by 0.33 years annually after that.</p>
</section><section id="country-level-variation" class="level4"><h4 class="anchored" data-anchor-id="country-level-variation">Country-level variation</h4>
<p>Because we’re using random effects, we have information about the <span class="math inline">\(\tau\)</span> parameter for the variance in country offsets, which shows us how much life expectancy bounces around from country to country. As with continents, we have a ton of cross-country variation: 11.07 years! Country-specific offsets are centered around 0 ± a huge standard deviation of 11.07. Accounting for country differences is going to be crucial for this model.</p>
<p>If we look at country-level variance as a percentage of the total residual variance, we can see that country differences are really important. Country-level variation contributes 75% (11.07 / (11.07 + 3.6)) of the total variance in life expectancy.</p>
</section><section id="country-level-random-effects" class="level4"><h4 class="anchored" data-anchor-id="country-level-random-effects">Country-level random effects</h4>
<p>We can look at country-level offsets for our eight example countries with <code>ranef()</code>. Canada, Italy, and Portugal have offsets that are substantially above the global average, while Yemen and Sierra Leone are substantially below it.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">country_offsets</span> <span class="op">&lt;-</span> <span class="fu">ranef</span><span class="op">(</span><span class="va">model_country_only</span><span class="op">)</span><span class="op">$</span><span class="va">country</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">as_tibble</span><span class="op">(</span>rownames <span class="op">=</span> <span class="st">"country"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">country</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">countries</span><span class="op">$</span><span class="va">country</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">country</span>, <span class="fu">starts_with</span><span class="op">(</span><span class="st">"Estimate"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">country_offsets</span></span>
<span><span class="co">## # A tibble: 8 × 2</span></span>
<span><span class="co">##   country      Estimate.Intercept</span></span>
<span><span class="co">##   &lt;chr&gt;                     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 Bolivia                   -6.76</span></span>
<span><span class="co">## 2 Canada                    15.5 </span></span>
<span><span class="co">## 3 Egypt                     -3.02</span></span>
<span><span class="co">## 4 Italy                     14.6 </span></span>
<span><span class="co">## 5 Pakistan                  -4.39</span></span>
<span><span class="co">## 6 Portugal                  11.0 </span></span>
<span><span class="co">## 7 Sierra Leone             -22.3 </span></span>
<span><span class="co">## 8 Yemen, Rep.              -12.4</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can see the actual country-specific intercepts too. Each of these intercepts represents the life expectancy in these countries in 1952. Note that the coefficient for <code>year</code> is the same in each—that’s because it’s a global population-level effect and isn’t country-specific.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">model_country_only</span><span class="op">)</span><span class="op">$</span><span class="va">country</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">as_tibble</span><span class="op">(</span>rownames <span class="op">=</span> <span class="st">"country"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">country</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">countries</span><span class="op">$</span><span class="va">country</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">country</span>, <span class="fu">starts_with</span><span class="op">(</span><span class="st">"Estimate"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 8 × 3</span></span>
<span><span class="co">##   country      Estimate.Intercept Estimate.year</span></span>
<span><span class="co">##   &lt;chr&gt;                     &lt;dbl&gt;         &lt;dbl&gt;</span></span>
<span><span class="co">## 1 Bolivia                    43.5         0.328</span></span>
<span><span class="co">## 2 Canada                     65.8         0.328</span></span>
<span><span class="co">## 3 Egypt                      47.3         0.328</span></span>
<span><span class="co">## 4 Italy                      64.9         0.328</span></span>
<span><span class="co">## 5 Pakistan                   45.9         0.328</span></span>
<span><span class="co">## 6 Portugal                   61.3         0.328</span></span>
<span><span class="co">## 7 Sierra Leone               28.0         0.328</span></span>
<span><span class="co">## 8 Yemen, Rep.                37.9         0.328</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="visualize-country-specific-trends" class="level4 page-columns page-full"><h4 class="anchored" data-anchor-id="visualize-country-specific-trends">Visualize country-specific trends</h4>
<p>With these country-specific intercepts, we can now see that the model fits a lot better across countries. Each predicted year trend still has the same slope, but the line is shifted up and down based on the country-specific offsets. Great!</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pred_model_country_only</span> <span class="op">&lt;-</span> <span class="va">model_country_only</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">epred_draws</span><span class="op">(</span>newdata <span class="op">=</span> <span class="fu">expand_grid</span><span class="op">(</span>country <span class="op">=</span> <span class="va">countries</span><span class="op">$</span><span class="va">country</span>,</span>
<span>                                    year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">gapminder</span><span class="op">$</span><span class="va">year</span><span class="op">)</span><span class="op">)</span>,</span>
<span>              re_formula <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>year <span class="op">=</span> <span class="va">year</span> <span class="op">+</span> <span class="fl">1952</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">countries</span>, by <span class="op">=</span> <span class="st">"country"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">pred_model_country_only</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span>, y <span class="op">=</span> <span class="va">.epred</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>data <span class="op">=</span> <span class="va">original_points</span>, <span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">lifeExp</span><span class="op">)</span>, </span>
<span>             color <span class="op">=</span> <span class="st">"grey50"</span>, size <span class="op">=</span> <span class="fl">3</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_lineribbon</span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_brewer</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Reds"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Intercepts for year trend vary by country"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"lifeExp ~ year + (1 | country)"</span>,</span>
<span>       x <span class="op">=</span> <span class="cn">NULL</span>, y <span class="op">=</span> <span class="st">"Predicted life expectancy"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_nested_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">continent</span>, <span class="va">country</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">2</span>, strip <span class="op">=</span> <span class="va">nested_settings</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_clean</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>        plot.subtitle <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Consolas"</span><span class="op">)</span>,</span>
<span>        axis.text.x <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">45</span>, hjust <span class="op">=</span> <span class="fl">0.5</span>, vjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/plot-preds-country-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page-inset-right" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section></section><section id="intercepts-and-slopes-for-each-country" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="intercepts-and-slopes-for-each-country">⭐ Intercepts and slopes for each country ⭐</h3>
<p>These country-level effects are cool and fit the data fairly well, but there are still some substantial errors. The predicted lines fit Italy and Portugal pretty well, but the year trend in Yemen, Egypt, and Bolivia is steeper than predicted, while the year trend in Sierra Leone is shallower. It would be neat if we could incorporate country-specific offsets into both the intercept <em>and</em> the year trend. Fortunately, multilevel modeling lets us do this!</p>
<p>We’d previously excised random country effects <span class="math inline">\(b_{\text{Country}}\)</span> from the error term <span class="math inline">\(\epsilon\)</span> and lumped them in with the fixed intercept term, creating country-specific offsets <span class="math inline">\(b_{0, \text{Country}}\)</span>. We can do a similar thing and add country-specific offsets to the fixed year term too. We’ll call this <span class="math inline">\(b_{1, \text{Country}}\)</span> (with a 1 subscript to show that it goes with <span class="math inline">\(\beta_1\)</span>). This random term also gets its own distribution of errors with its own variation. We’ll add subscripts to these <span class="math inline">\(\tau\)</span> terms so we can keep track of the intercept variance and the year trend variance.</p>
<p><span class="math display">\[
\begin{aligned}
\text{Life expectancy} &amp;= (\beta_0 + b_{0, \text{Country}}) + (\beta_1 + b_{1, \text{Country}}) \text{Year} + \epsilon \\
b_{0, \text{Country}} &amp;\sim \mathcal{N}(0, \tau_0) \\
b_{1, \text{Country}} &amp;\sim \mathcal{N}(0, \tau_1)
\end{aligned}
\]</span></p>
<p>The R syntax for this kind of random effects term is <code>(1 + year | country)</code>, which means that we’re letting both the intercept (<code>1</code>) and <code>year</code> vary by country.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/model-country-year_7a1c20273569ce0ac1f3ffc45e9dd13b">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Each country gets its own slope and intercept for the year trend</span></span>
<span><span class="va">model_country_year</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span></span>
<span>  <span class="fu">bf</span><span class="op">(</span><span class="va">lifeExp</span> <span class="op">~</span> <span class="va">year</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">year</span> <span class="op">|</span> <span class="va">country</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">gapminder</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="va">bayes_seed</span>,</span>
<span>  iter <span class="op">=</span> <span class="fl">4000</span>  <span class="co"># Double the number of iterations to help with convergence</span></span>
<span><span class="op">)</span></span>
<span><span class="co">## Start sampling</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_country_year</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 6 × 8</span></span>
<span><span class="co">##   effect   component group    term                  estimate std.error conf.low conf.high</span></span>
<span><span class="co">##   &lt;chr&gt;    &lt;chr&gt;     &lt;chr&gt;    &lt;chr&gt;                    &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 fixed    cond      &lt;NA&gt;     (Intercept)             50.3      1.08     48.1      52.3  </span></span>
<span><span class="co">## 2 fixed    cond      &lt;NA&gt;     year                     0.328    0.0139    0.301     0.355</span></span>
<span><span class="co">## 3 ran_pars cond      country  sd__(Intercept)         12.3      0.747    10.9      13.8  </span></span>
<span><span class="co">## 4 ran_pars cond      country  sd__year                 0.161    0.0103    0.142     0.182</span></span>
<span><span class="co">## 5 ran_pars cond      country  cor__(Intercept).year   -0.422    0.0710   -0.551    -0.274</span></span>
<span><span class="co">## 6 ran_pars cond      Residual sd__Observation          2.20     0.0414    2.12      2.28</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="fixed-population-level-effects-2" class="level4"><h4 class="anchored" data-anchor-id="fixed-population-level-effects-2">Fixed (population-level) effects</h4>
<p>The global population-level coefficients are once again basically the same that we’ve seen before: in 1952 the average life expectancy is 50.25 years, and it increases by 0.33 years annually after that.</p>
</section><section id="country-level-variation-1" class="level4"><h4 class="anchored" data-anchor-id="country-level-variation-1">Country-level variation</h4>
<p>We have a couple new rows in the random parameters part of our results, though. The variance for the intercept (<code>sd__(Intercept)</code>) corresponds to <span class="math inline">\(\tau_0\)</span> and still shows us how much life expectancy bounces around across countries. We have a new term for country-specific variation in the year effect (<code>sd__year</code>), which corresponds to <span class="math inline">\(\tau_1\)</span>. This is considerably smaller than the intercept variance, but that’s because the year trend is a slope that measures the increase or decrease in life expectancy as <code>year</code> increases. Recall that our global year trend is 0.33. Country-specific differences imply that our trend is something like 0.33 ± 0.16 standard deviations across countries.</p>
<p>Since we’re assuming a normal distribution of random offsets, the distribution of all country-specific year trends looks something like this. The year trend in most countries is positive, sometimes going as high as 0.8 years of life expectancy per year:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="fu">tibble</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.3</span>, <span class="fl">1</span>, by <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_function</span><span class="op">(</span>geom <span class="op">=</span> <span class="st">"area"</span>,</span>
<span>                fun <span class="op">=</span> <span class="va">dnorm</span>, args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fl">0.327</span>, sd <span class="op">=</span> <span class="fl">0.161</span><span class="op">)</span>,</span>
<span>                fill <span class="op">=</span> <span class="fu">palette_okabe_ito</span><span class="op">(</span>order <span class="op">=</span> <span class="fl">6</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Year trend across countries"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Annual increase in life expectancy"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_clean</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-year-slopes-country-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>The second new parameter we have is <code>cor__(Intercept).year</code>, which shows us the correlation of the country-specific intercepts and slopes. This is a correlation, so it ranges from −1 to 1, with 0 indicating no correlation. In this case, we see a correlation of -0.42, which is fairly strong. It indicates that countries with lower intercepts are associated with larger year trends. This makes sense—every country in the dataset sees increased life expectancy over time, and countries with a lower starting point have more room to grow and grow more quickly. Canada, for instance, starts off with high life expectancy and grows a little between 1952 and 2007, while Egypt starts off with low life expectancy and grows rapidly through 2007.</p>
</section><section id="country-level-random-effects-1" class="level4"><h4 class="anchored" data-anchor-id="country-level-random-effects-1">Country-level random effects</h4>
<p>We can look at the country-level offsets for both the intercept and the year slope now. As before, Canada, Italy, and Portugal have intercept offsets that are substantially above the global average, while Bolivia, Yemen, and Sierra Leone are substantially below it. We can also now look at country-specific slope offsets: Egypt and Yemen have much steeper slopes than the global average, while Canada’s is shallower than the global effect.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">country_year_offsets</span> <span class="op">&lt;-</span> <span class="fu">ranef</span><span class="op">(</span><span class="va">model_country_year</span><span class="op">)</span><span class="op">$</span><span class="va">country</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">as_tibble</span><span class="op">(</span>rownames <span class="op">=</span> <span class="st">"country"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">country</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">countries</span><span class="op">$</span><span class="va">country</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">country</span>, <span class="fu">starts_with</span><span class="op">(</span><span class="st">"Estimate"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">country_year_offsets</span></span>
<span><span class="co">## # A tibble: 8 × 3</span></span>
<span><span class="co">##   country      Estimate.Intercept Estimate.year</span></span>
<span><span class="co">##   &lt;chr&gt;                     &lt;dbl&gt;         &lt;dbl&gt;</span></span>
<span><span class="co">## 1 Bolivia                  -11.2        0.163  </span></span>
<span><span class="co">## 2 Canada                    18.5       -0.104  </span></span>
<span><span class="co">## 3 Egypt                     -8.96       0.216  </span></span>
<span><span class="co">## 4 Italy                     16.2       -0.0562 </span></span>
<span><span class="co">## 5 Pakistan                  -6.42       0.0746 </span></span>
<span><span class="co">## 6 Portugal                  10.9        0.00814</span></span>
<span><span class="co">## 7 Sierra Leone             -19.5       -0.107  </span></span>
<span><span class="co">## 8 Yemen, Rep.              -19.7        0.265</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can also look at the already-combined fixed effect + random offset for country-specific intercepts and slopes. Notice how both the intercept and the slope is different in each country. That’s magical!</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">model_country_year</span><span class="op">)</span><span class="op">$</span><span class="va">country</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">as_tibble</span><span class="op">(</span>rownames <span class="op">=</span> <span class="st">"country"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">country</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">countries</span><span class="op">$</span><span class="va">country</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">country</span>, <span class="fu">starts_with</span><span class="op">(</span><span class="st">"Estimate"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 8 × 3</span></span>
<span><span class="co">##   country      Estimate.Intercept Estimate.year</span></span>
<span><span class="co">##   &lt;chr&gt;                     &lt;dbl&gt;         &lt;dbl&gt;</span></span>
<span><span class="co">## 1 Bolivia                    39.0         0.491</span></span>
<span><span class="co">## 2 Canada                     68.7         0.224</span></span>
<span><span class="co">## 3 Egypt                      41.3         0.544</span></span>
<span><span class="co">## 4 Italy                      66.5         0.272</span></span>
<span><span class="co">## 5 Pakistan                   43.8         0.402</span></span>
<span><span class="co">## 6 Portugal                   61.1         0.336</span></span>
<span><span class="co">## 7 Sierra Leone               30.8         0.221</span></span>
<span><span class="co">## 8 Yemen, Rep.                30.5         0.592</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="visualize-country-specific-intercepts-and-slopes" class="level4 page-columns page-full"><h4 class="anchored" data-anchor-id="visualize-country-specific-intercepts-and-slopes">Visualize country-specific intercepts and slopes</h4>
<p>With country-specific intercepts <em>and</em> slopes, predicted life expectancy fits really well in each country over time. Each country has a different starting point <em>and</em> grows at different rates.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pred_model_country_year</span> <span class="op">&lt;-</span> <span class="va">model_country_year</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">epred_draws</span><span class="op">(</span>newdata <span class="op">=</span> <span class="fu">expand_grid</span><span class="op">(</span>country <span class="op">=</span> <span class="va">countries</span><span class="op">$</span><span class="va">country</span>,</span>
<span>                                    year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">gapminder</span><span class="op">$</span><span class="va">year</span><span class="op">)</span><span class="op">)</span>,</span>
<span>              re_formula <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>year <span class="op">=</span> <span class="va">year</span> <span class="op">+</span> <span class="fl">1952</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">countries</span>, by <span class="op">=</span> <span class="st">"country"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">pred_model_country_year</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span>, y <span class="op">=</span> <span class="va">.epred</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>data <span class="op">=</span> <span class="va">original_points</span>, <span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">lifeExp</span><span class="op">)</span>, </span>
<span>             color <span class="op">=</span> <span class="st">"grey50"</span>, size <span class="op">=</span> <span class="fl">3</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_lineribbon</span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_brewer</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Reds"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Intercepts and slopes for year trend vary by country"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"lifeExp ~ year + (1 + year | country)"</span>,</span>
<span>       x <span class="op">=</span> <span class="cn">NULL</span>, y <span class="op">=</span> <span class="st">"Predicted life expectancy"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_nested_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">continent</span>, <span class="va">country</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">2</span>, strip <span class="op">=</span> <span class="va">nested_settings</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_clean</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>        plot.subtitle <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Consolas"</span><span class="op">)</span>,</span>
<span>        axis.text.x <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">45</span>, hjust <span class="op">=</span> <span class="fl">0.5</span>, vjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/plot-preds-country-year-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page-inset-right" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section></section><section id="intercepts-and-slopes-for-each-country-account-for-year-specific-differences" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="intercepts-and-slopes-for-each-country-account-for-year-specific-differences">Intercepts and slopes for each country + account for year-specific differences</h3>
<p>Ordinarily, the <code>year + (1 + year | country)</code> approach is sufficient for working with panel data, since the population-level year effects gets their own country-specific intercepts and slopes. However, we can do a couple extra bonus things to make our model even richer.</p>
<p>First, we’ll add extra year-specific random effects. Theoretically we’d want to do this if something happens to observations at a year-level that is completely unrelated to country-specific trends. One way to think about this is as year-based shocks to life expectancy. At around <a href="https://www.youtube.com/watch?v=Z8t4k0Q8e8Y&amp;t=110s">1:50 in the video at the beginning of this post</a>, Hans Rosling slows down his animation to show the impact of World War I and the Spanish Flu epidemic on global life expectancy—tons of the country circles in his animation dropped dramatically. We might see something similar in the future with 2020–21 life expectancy levels too, given the COVID-19 pandemic. That sudden drop in life expectancy across all countries is an excellent example of a year-specific change that is arguably unrelated to trends in specific continents (kind of; despite its name, not all countries fought in WWI, and Spanish Flu didn’t have the same effects in all countries, but whatever; just go with it).</p>
<p>To do this, we’ll add independent year-based offsets to the intercept term, or <span class="math inline">\(b_{0, \text{Year}}\)</span>:</p>
<p><span class="math display">\[
\begin{aligned}
\text{Life expectancy} &amp;= (\beta_0 + b_{0, \text{Country}} + b_{0, \text{Year}}) + (\beta_1 + b_{1, \text{Country}}) \text{Year} + \epsilon \\
b_{0, \text{Country}} &amp;\sim \mathcal{N}(0, \tau_{0, \text{Country}}) \\
b_{1, \text{Country}} &amp;\sim \mathcal{N}(0, \tau_{1, \text{Country}}) \\
b_{0, \text{Year}} &amp;\sim \mathcal{N}(0, \tau_{0, \text{Year}})
\end{aligned}
\]</span></p>
<p>The code version of this random effects structure is <code>(1 | year) + (1 + year | country)</code>, which means that we’re letting the intercept (<code>1</code>) vary by year <em>and</em> letting both the intercept (<code>1</code>) and <code>year</code> vary by country. Let’s see how this model looks!</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/model-country-year-year_a39ab42842ddf5a0c5874240110ab570">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Each country gets its own slope and intercept for the year trend</span></span>
<span><span class="va">model_country_year_year</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span></span>
<span>  <span class="fu">bf</span><span class="op">(</span><span class="va">lifeExp</span> <span class="op">~</span> <span class="va">year</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">year</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">year</span> <span class="op">|</span> <span class="va">country</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">gapminder</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="va">bayes_seed</span>,</span>
<span>  iter <span class="op">=</span> <span class="fl">4000</span>  <span class="co"># Double the number of iterations to help with convergence</span></span>
<span><span class="op">)</span></span>
<span><span class="co">## Start sampling</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_country_year_year</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 7 × 8</span></span>
<span><span class="co">##   effect   component group    term                  estimate std.error conf.low conf.high</span></span>
<span><span class="co">##   &lt;chr&gt;    &lt;chr&gt;     &lt;chr&gt;    &lt;chr&gt;                    &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 fixed    cond      &lt;NA&gt;     (Intercept)             50.2     1.24      47.8      52.6  </span></span>
<span><span class="co">## 2 fixed    cond      &lt;NA&gt;     year                     0.328   0.0246     0.278     0.377</span></span>
<span><span class="co">## 3 ran_pars cond      country  sd__(Intercept)         12.3     0.738     11.0      13.8  </span></span>
<span><span class="co">## 4 ran_pars cond      country  sd__year                 0.161   0.00988    0.143     0.182</span></span>
<span><span class="co">## 5 ran_pars cond      year     sd__(Intercept)          1.21    0.333      0.749     2.00 </span></span>
<span><span class="co">## 6 ran_pars cond      country  cor__(Intercept).year   -0.421   0.0704    -0.550    -0.272</span></span>
<span><span class="co">## 7 ran_pars cond      Residual sd__Observation          1.93    0.0362     1.86      2.00</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="fixed-population-level-effects-3" class="level4"><h4 class="anchored" data-anchor-id="fixed-population-level-effects-3">Fixed (population-level) effects</h4>
<p>As always, the global population-level coefficients are the same that we’ve seen before: in 1952 the average life expectancy is 50.19 years, and it increases by 0.33 years annually after that.</p>
</section><section id="country-level-variation-2" class="level4"><h4 class="anchored" data-anchor-id="country-level-variation-2">Country-level variation</h4>
<p>The random effects section of our model results is getting longer and longer! We still have the variation in our country-based intercepts and year slopes, and we have the correlation between these country-based offsets. We also have a new term: <code>sd__(Intercept)</code> for the <code>year</code> group, which corresponds to <span class="math inline">\(\tau_{0, \text{Year}}\)</span> in the year-specific level of the model. This shows us how much life expectancy bounces around from year to year.</p>
</section><section id="year-level-random-effects" class="level4"><h4 class="anchored" data-anchor-id="year-level-random-effects">Year-level random effects</h4>
<p>We can look at these new year-level offsets for the intercept using <code>ranef()</code> (but this time extracting data from the <code>$year</code> slot of the results). For whatever reason, average life expectancy in 1952 is nearly 1.5 years lower than the population-level average, but more than 1 year higher in the 1980s. If the Gapminder data went back further in time to the 1910s, we’d probably see a huge negative offset due to World War I and the Spanish Flu.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">year_offsets</span> <span class="op">&lt;-</span> <span class="fu">ranef</span><span class="op">(</span><span class="va">model_country_year_year</span><span class="op">)</span><span class="op">$</span><span class="va">year</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">as_tibble</span><span class="op">(</span>rownames <span class="op">=</span> <span class="st">"year"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1952</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">year</span>, <span class="fu">starts_with</span><span class="op">(</span><span class="st">"Estimate"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">year_offsets</span></span>
<span><span class="co">## # A tibble: 12 × 2</span></span>
<span><span class="co">##     year Estimate.Intercept</span></span>
<span><span class="co">##    &lt;dbl&gt;              &lt;dbl&gt;</span></span>
<span><span class="co">##  1  1952             -1.44 </span></span>
<span><span class="co">##  2  1957             -0.623</span></span>
<span><span class="co">##  3  1962             -0.159</span></span>
<span><span class="co">##  4  1967              0.290</span></span>
<span><span class="co">##  5  1972              0.632</span></span>
<span><span class="co">##  6  1977              0.922</span></span>
<span><span class="co">##  7  1982              1.25 </span></span>
<span><span class="co">##  8  1987              1.29 </span></span>
<span><span class="co">##  9  1992              0.610</span></span>
<span><span class="co">## 10  1997             -0.168</span></span>
<span><span class="co">## 11  2002             -1.12 </span></span>
<span><span class="co">## 12  2007             -1.43</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Where this gets really interesting is when we incorporate these different year offsets into the overall model estimate of the year trend. We can use <code>emtrends()</code> to calculate the predicted year slope for each of our example countries in both 1952 and 1957 (<code>year = 0</code> and <code>year = 5</code>):</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_country_year_year</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">emtrends</span><span class="op">(</span><span class="op">~</span> <span class="va">year</span> <span class="op">+</span> <span class="va">country</span>,</span>
<span>           var <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>           at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">5</span><span class="op">)</span>, country <span class="op">=</span> <span class="va">countries</span><span class="op">$</span><span class="va">country</span><span class="op">)</span>,</span>
<span>           epred <span class="op">=</span> <span class="cn">TRUE</span>, re_formula <span class="op">=</span> <span class="cn">NULL</span>, allow_new_levels <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">##  year country      year.trend lower.HPD upper.HPD</span></span>
<span><span class="co">##     0 Egypt              28.0     -14.7      67.1</span></span>
<span><span class="co">##     5 Egypt              13.9     -24.4      52.2</span></span>
<span><span class="co">##     0 Sierra Leone       27.7     -14.9      66.8</span></span>
<span><span class="co">##     5 Sierra Leone       13.6     -24.7      51.8</span></span>
<span><span class="co">##     0 Pakistan           27.8     -14.8      67.0</span></span>
<span><span class="co">##     5 Pakistan           13.7     -24.5      52.1</span></span>
<span><span class="co">##     0 Yemen, Rep.        28.1     -14.5      67.2</span></span>
<span><span class="co">##     5 Yemen, Rep.        13.9     -24.3      52.3</span></span>
<span><span class="co">##     0 Bolivia            27.9     -14.7      67.1</span></span>
<span><span class="co">##     5 Bolivia            13.8     -24.4      52.1</span></span>
<span><span class="co">##     0 Canada             27.7     -14.9      66.8</span></span>
<span><span class="co">##     5 Canada             13.6     -24.7      51.9</span></span>
<span><span class="co">##     0 Italy              27.7     -14.8      66.9</span></span>
<span><span class="co">##     5 Italy              13.6     -24.7      52.0</span></span>
<span><span class="co">##     0 Portugal           27.8     -14.8      67.0</span></span>
<span><span class="co">##     5 Portugal           13.7     -24.5      52.0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Point estimate displayed: median </span></span>
<span><span class="co">## HPD interval probability: 0.95</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice how the slope of year now changes based on country <em>and</em> on year—it’s different (and sizably smaller) in 1957.</p>
</section><section id="visualize-country-specific-intercepts-and-slopes-and-year-specific-intercepts" class="level4 page-columns page-full"><h4 class="anchored" data-anchor-id="visualize-country-specific-intercepts-and-slopes-and-year-specific-intercepts">Visualize country-specific intercepts and slopes and year-specific intercepts</h4>
<p>These year shocks are apparent when we plot predicted life expectancy. Each country gets its own slope and intercept like before, but now the intercept is also shifted up and down in specific years. Note how all these lines start getting a little shallower in the 1990s—something happened worldwide to shift average life expectancy outside of continent-level effects.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pred_model_country_year_year</span> <span class="op">&lt;-</span> <span class="va">model_country_year_year</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">epred_draws</span><span class="op">(</span>newdata <span class="op">=</span> <span class="fu">expand_grid</span><span class="op">(</span>country <span class="op">=</span> <span class="va">countries</span><span class="op">$</span><span class="va">country</span>,</span>
<span>                                    year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">gapminder</span><span class="op">$</span><span class="va">year</span><span class="op">)</span><span class="op">)</span>,</span>
<span>              re_formula <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>year <span class="op">=</span> <span class="va">year</span> <span class="op">+</span> <span class="fl">1952</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">countries</span>, by <span class="op">=</span> <span class="st">"country"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">pred_model_country_year_year</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span>, y <span class="op">=</span> <span class="va">.epred</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>data <span class="op">=</span> <span class="va">original_points</span>, <span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">lifeExp</span><span class="op">)</span>, </span>
<span>             color <span class="op">=</span> <span class="st">"grey50"</span>, size <span class="op">=</span> <span class="fl">3</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_lineribbon</span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_brewer</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Reds"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Intercepts and slopes for year trend vary by country and intercepts vary by year"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"lifeExp ~ year + (1 | year) + (1 + year | country)"</span>,</span>
<span>       x <span class="op">=</span> <span class="cn">NULL</span>, y <span class="op">=</span> <span class="st">"Predicted life expectancy"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_nested_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">continent</span>, <span class="va">country</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">2</span>, strip <span class="op">=</span> <span class="va">nested_settings</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_clean</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>        plot.subtitle <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Consolas"</span><span class="op">)</span>,</span>
<span>        axis.text.x <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">45</span>, hjust <span class="op">=</span> <span class="fl">0.5</span>, vjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/plot-preds-country-year-year-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page-inset-right" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section></section><section id="intercepts-and-slopes-for-each-country-and-continent" class="level3"><h3 class="anchored" data-anchor-id="intercepts-and-slopes-for-each-country-and-continent">Intercepts and slopes for each country and continent</h3>
<p>For our second bonus extension, we can incorporate random continent effects, since countries are nested in continents. This is probably overkill for this example, but it would be helpful in other situations with nested data structures.</p>
<p>In this case, we’re adding continent-specific effects <em>and</em> country-specific effects that incorporate information about parent continents. We end up with four different <span class="math inline">\(b\)</span> terms:</p>
<ul>
<li>
<span class="math inline">\(b_{0, \text{Continent}}\)</span>: Continent-based shifts in the intercept</li>
<li>
<span class="math inline">\(b_{0, \text{Continent, Country}}\)</span>: Country-within-continent-based shifts in the intercept</li>
<li>
<span class="math inline">\(b_{1, \text{Continent}}\)</span>: Continent-based shifts in the year slope</li>
<li>
<span class="math inline">\(b_{1, \text{Continent, Country}}\)</span>: Country-within-continent-based shifts in the year slope</li>
</ul>
<p>Each of these group terms also has its own variance term (<span class="math inline">\(\tau\)</span>) like the other models—I’m not including them below, but pretend they exist.</p>
<p><span class="math display">\[
\begin{aligned}
\text{Life expectancy} =&amp;\ (\beta_0 + b_{0, \text{Continent}} + b_{0, \text{Continent, Country}}) + \\
&amp;\ (\beta_1 + b_{1, \text{Continent}} + b_{1, \text{Continent, Country}}) \text{Year} + \epsilon
\end{aligned}
\]</span></p>
<p>The code version of this nested random effects structure is <code>(1 + year | continent / country)</code>.</p>
<p><strong>However</strong>, we won’t actually fit this model here, since it takes 10+ minutes to run (likely because I’m using all the default priors). If we were fitting the model, the code would look like this:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># This takes a while! It also has a bunch of divergent transitions, and pretty</span></span>
<span><span class="co"># much all the chains hit the maximum treedepth limit, but this is just a toy</span></span>
<span><span class="co"># example, so whatever</span></span>
<span><span class="va">model_country_continent_year</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span></span>
<span>  <span class="fu">bf</span><span class="op">(</span><span class="va">lifeExp</span> <span class="op">~</span> <span class="va">year</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">year</span> <span class="op">|</span> <span class="va">continent</span> <span class="op">/</span> <span class="va">country</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">gapminder</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="va">bayes_seed</span>,</span>
<span>  iter <span class="op">=</span> <span class="fl">4000</span>  <span class="co"># Double the number of iterations to help with convergence</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># You'd use this to calculate the continent/country effects</span></span>
<span><span class="va">model_country_continent_year</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">emmeans</span><span class="op">(</span><span class="op">~</span> <span class="va">year</span> <span class="op">+</span> <span class="va">continent</span><span class="op">:</span><span class="va">country</span>,</span>
<span>          at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>, country <span class="op">=</span> <span class="va">countries</span><span class="op">$</span><span class="va">country</span><span class="op">)</span>,</span>
<span>          nesting <span class="op">=</span> <span class="st">"country %in% continent"</span>,</span>
<span>          epred <span class="op">=</span> <span class="cn">TRUE</span>, re_formula <span class="op">=</span> <span class="cn">NULL</span>, allow_new_levels <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The model results include a bunch of new group-level terms. We get estimates for all the group-specific variances (the <span class="math inline">\(\tau\)</span>s), listed as <code>sd__(Intercept)</code> and <code>sd__year</code> for both continent and country-in-continent. We also get the correlation between continent-level offsets and year <em>and</em> country-in-continent-level offsets and year.</p>
<p>Again, this kind of complexity is probably overkill for this situation, since country-specific offsets seem to work just fine on their own without needing broader continent-level trends. But it’s a neat approach to thinking about hierarchy in the model.</p>
</section></section><section id="quick-digression-on-logging-scaling-and-centering" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="quick-digression-on-logging-scaling-and-centering">Quick digression on logging, scaling, and centering</h2>
<p>Part of the reason the countries-nested-in-continents model takes so long to fit and runs into so many warnings and divergences is because the columns we used have values that are too large and that are distributed non-normally.</p>
<p>Bayesian sampling in Stan (through <strong>brms</strong>) works best and fastest when the ranges of covariates are small and centered around zero. We’ve been using year centered at 1952 (so that year 0 is 1952), and the max year in the data is 2007 (or 55), and even with that, we’re probably pushing the envelope of what Stan likes to work with.</p>
<p>For our main question, we want to know the relationship between GDP per capita and life expectancy. GDP per capita has a huge range with huge values. Some countries have a GDP per capita of \$1,000; some have \$40,000 or \$50,000. To make these models run quickly (and actually fit and converge), we need to shrink those values down.</p>
<p>We can do this in a few different ways, each with their own benefits and quirks of interpretation, which we’ll explore really quick.</p>
<ol type="1">
<li>
<strong>Divide by 1,000</strong> (or any amount, really)</li>
<li><strong>Scale and center</strong></li>
<li><strong>Log</strong></li>
<li><strong>Log + scale and center</strong></li>
</ol>
<p>Here’s what the distributions of these different scaling approaches look like. Notice how all the red GDP per capita distributions are identical. The per-1000 version is shrunken down so that most values are between 0 and 30 instead of 3 and 30,000, while the centered and scaled version ranges from ≈−0.5 and 8, with 0 in the middle of the distribution. The two logged versions are also identical—the original logged GDP per capita ranges from ≈5.5–11.5 (or <code>exp(5.5)</code> ($148) to <code>exp(11.5)</code> ($98,716)), while the centered and scaled version ranges from −2 to 3, centered at 0.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">different_gdps</span> <span class="op">&lt;-</span> <span class="va">gapminder</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">gdpPercap</span>, <span class="va">gdpPercap_1000</span>, <span class="va">gdpPercap_z</span>, <span class="va">gdpPercap_log</span>, <span class="va">gdpPercap_log_z</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">pivot_longer</span><span class="op">(</span><span class="fu">everything</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>name_nice <span class="op">=</span> <span class="fu">recode</span><span class="op">(</span></span>
<span>    <span class="va">name</span>, <span class="st">"gdpPercap"</span> <span class="op">=</span> <span class="st">"GDP per capita"</span>,</span>
<span>    <span class="st">"gdpPercap_1000"</span> <span class="op">=</span> <span class="st">"GDP per capita ($1,000)"</span>,</span>
<span>    <span class="st">"gdpPercap_z"</span> <span class="op">=</span> <span class="st">"GDP per capita (centered &amp; scaled by one standard deviation)"</span>,</span>
<span>    <span class="st">"gdpPercap_log"</span> <span class="op">=</span> <span class="st">"GDP per capita (logged)"</span>,</span>
<span>    <span class="st">"gdpPercap_log_z"</span> <span class="op">=</span> <span class="st">"GDP per capita (logged; centered &amp; scaled by one standard deviation)"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>name_nice <span class="op">=</span> <span class="fu">fct_inorder</span><span class="op">(</span><span class="va">name_nice</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu">str_detect</span><span class="op">(</span><span class="va">name</span>, <span class="st">"log"</span><span class="op">)</span>, <span class="st">"Logged"</span>, <span class="st">"Original scale"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>vline <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">name</span> <span class="op">==</span> <span class="st">"gdpPercap_log"</span>, <span class="cn">NA</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">different_gdps</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">value</span>, fill <span class="op">=</span> <span class="va">type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_density</span><span class="op">(</span>color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>data <span class="op">=</span> <span class="va">different_gdps</span> <span class="op">%&gt;%</span> <span class="fu">drop_na</span><span class="op">(</span><span class="va">vline</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>               <span class="fu">group_by</span><span class="op">(</span><span class="va">name_nice</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">slice</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>             <span class="fu">aes</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">vline</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_d</span><span class="op">(</span>option <span class="op">=</span> <span class="st">"rocket"</span>, begin <span class="op">=</span> <span class="fl">0.3</span>, end <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="cn">NULL</span>, y <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">name_nice</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">3</span>, scales <span class="op">=</span> <span class="st">"free"</span>, dir <span class="op">=</span> <span class="st">"v"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_clean</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/plot-different-scalings-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page-inset-right" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<section id="scaling-and-centering" class="level3"><h3 class="anchored" data-anchor-id="scaling-and-centering">Scaling and centering</h3>
<section id="divide-by-1000" class="level4"><h4 class="anchored" data-anchor-id="divide-by-1000">1: Divide by 1,000</h4>
<p>One quick and easy way to shrink the GDP values down is to divide them all by some arbitrary number like 1,000 so that we work with GDP per capita in thousands of dollars. A country with a GDP per capita of \$2,000 would thus have a value of 2, and so on. Often this kind of downscaling is enough to make Stan happy, and it makes for easily interpretable results. We can interpret coefficients by saying “A \$1,000 increase in GDP per capita is associated with a <span class="math inline">\(\beta\)</span> increase in life expectancy,” and if we really wanted, we could divide the coefficient by 1,000 to shrink it back down to the original scale and talk about \$1 increases in GDP per capita.</p>
</section><section id="scale-and-center" class="level4"><h4 class="anchored" data-anchor-id="scale-and-center">2: Scale and center</h4>
<p>A better alternative that requires a little bit more post-estimation finagling is to rescale the column by subtracting the mean so that it is centered at 0, and then dividing by the standard deviation. R’s built-in <code><a href="https://rdrr.io/r/base/scale.html">scale()</a></code> function does this for us. There’s no built-in <code>unscale()</code> function to back-transform the values to their original numbers, but we can use a little algebra to see how to unscale the values: multiply by the standard deviation and add the mean. As long as we have a mean and standard deviation, we can flip between scaled and original values:</p>
<p><span class="math display">\[
\begin{aligned}
\text{Scaled value}\ &amp;=\ \frac{\text{Original value} - \text{Mean}}{\text{Standard deviation}} \\\\
\text{Original value}\ &amp;=\ (\text{Scaled value } \times \text{ Standard deviation})\ + \text{Mean}
\end{aligned}
\]</span></p>
<p>The <code><a href="https://rdrr.io/r/base/scale.html">scale()</a></code> function in R doesn’t return a regular set of values. For convenience, it stores the mean and standard deviation of the values as a special kind of metadata called “attributes” in slots named <code>scaled:center</code> (for the mean) and <code>scaled:scale</code> (for the standard deviation):</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">some_numbers</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span></span>
<span><span class="va">scaled_numbers</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">some_numbers</span><span class="op">)</span></span>
<span><span class="va">scaled_numbers</span></span>
<span><span class="co">##        [,1]</span></span>
<span><span class="co">## [1,] -1.265</span></span>
<span><span class="co">## [2,] -0.632</span></span>
<span><span class="co">## [3,]  0.000</span></span>
<span><span class="co">## [4,]  0.632</span></span>
<span><span class="co">## [5,]  1.265</span></span>
<span><span class="co">## attr(,"scaled:center")</span></span>
<span><span class="co">## [1] 3</span></span>
<span><span class="co">## attr(,"scaled:scale")</span></span>
<span><span class="co">## [1] 1.58</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can access and extract those attributes with the <code>attributes</code> function, which converts them to a more easily accessible list. Note that when we reference <code>scaled:center</code> or <code>scaled:scale</code> we have to use backticks around the names—that’s because the <code>:</code> character isn’t normally allowed as an object name:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">scaled_numbers_mean_sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attributes.html">attributes</a></span><span class="op">(</span><span class="va">scaled_numbers</span><span class="op">)</span></span>
<span><span class="va">scaled_numbers_mean_sd</span></span>
<span><span class="co">## $dim</span></span>
<span><span class="co">## [1] 5 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $`scaled:center`</span></span>
<span><span class="co">## [1] 3</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $`scaled:scale`</span></span>
<span><span class="co">## [1] 1.58</span></span>
<span><span class="va">scaled_numbers_mean_sd</span><span class="op">$</span><span class="va">`scaled:center`</span></span>
<span><span class="co">## [1] 3</span></span>
<span><span class="va">scaled_numbers_mean_sd</span><span class="op">$</span><span class="va">`scaled:scale`</span></span>
<span><span class="co">## [1] 1.58</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To unscale <code>some_numbers</code>, we can multiply by the standard deviation and add the mean:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span><span class="va">scaled_numbers</span> <span class="op">*</span> <span class="va">scaled_numbers_mean_sd</span><span class="op">$</span><span class="va">`scaled:scale`</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">scaled_numbers_mean_sd</span><span class="op">$</span><span class="va">`scaled:center`</span></span>
<span><span class="co">##      [,1]</span></span>
<span><span class="co">## [1,]    1</span></span>
<span><span class="co">## [2,]    2</span></span>
<span><span class="co">## [3,]    3</span></span>
<span><span class="co">## [4,]    4</span></span>
<span><span class="co">## [5,]    5</span></span>
<span><span class="co">## attr(,"scaled:center")</span></span>
<span><span class="co">## [1] 3</span></span>
<span><span class="co">## attr(,"scaled:scale")</span></span>
<span><span class="co">## [1] 1.58</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The same thing works with the actual data. When we initially loaded and cleaned the data, we used <code><a href="https://rdrr.io/r/base/scale.html">scale()</a></code> to scale down all the different GDP columns to versions with a <code>_z</code> suffix, and we can see that they’re all a little different from the other columns:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">glimpse</span><span class="op">(</span><span class="va">gapminder</span><span class="op">)</span></span>
<span><span class="co">## Rows: 1,680</span></span>
<span><span class="co">## Columns: 13</span></span>
<span><span class="co">## $ country          &lt;fct&gt; "Afghanistan", "Afghanistan", "Afghanistan", "Afghanistan", "Af…</span></span>
<span><span class="co">## $ continent        &lt;fct&gt; Asia, Asia, Asia, Asia, Asia, Asia, Asia, Asia, Asia, Asia, Asi…</span></span>
<span><span class="co">## $ year             &lt;dbl&gt; 0, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 0, 5, 10, 15, 20,…</span></span>
<span><span class="co">## $ lifeExp          &lt;dbl&gt; 28.8, 30.3, 32.0, 34.0, 36.1, 38.4, 39.9, 40.8, 41.7, 41.8, 42.…</span></span>
<span><span class="co">## $ pop              &lt;int&gt; 8425333, 9240934, 10267083, 11537966, 13079460, 14880372, 12881…</span></span>
<span><span class="co">## $ gdpPercap        &lt;dbl&gt; 779, 821, 853, 836, 740, 786, 978, 852, 649, 635, 727, 975, 160…</span></span>
<span><span class="co">## $ gdpPercap_1000   &lt;dbl&gt; 0.779, 0.821, 0.853, 0.836, 0.740, 0.786, 0.978, 0.852, 0.649, …</span></span>
<span><span class="co">## $ gdpPercap_log    &lt;dbl&gt; 6.66, 6.71, 6.75, 6.73, 6.61, 6.67, 6.89, 6.75, 6.48, 6.45, 6.5…</span></span>
<span><span class="co">## $ gdpPercap_z      &lt;dbl[,1]&gt; &lt;matrix[30 x 1]&gt;</span></span>
<span><span class="co">## $ gdpPercap_1000_z &lt;dbl[,1]&gt; &lt;matrix[30 x 1]&gt;</span></span>
<span><span class="co">## $ gdpPercap_log_z  &lt;dbl[,1]&gt; &lt;matrix[30 x 1]&gt;</span></span>
<span><span class="co">## $ year_orig        &lt;int&gt; 1952, 1957, 1962, 1967, 1972, 1977, 1982, 1987, 1992, 1997,…</span></span>
<span><span class="co">## $ highlight        &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FAL…</span></span>
<span></span>
<span><span class="va">gapminder</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">country</span>, <span class="va">continent</span>, <span class="va">year_orig</span>, <span class="va">gdpPercap</span>, <span class="va">gdpPercap_z</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 6 × 5</span></span>
<span><span class="co">##   country     continent year_orig gdpPercap gdpPercap_z[,1]</span></span>
<span><span class="co">##   &lt;fct&gt;       &lt;fct&gt;         &lt;int&gt;     &lt;dbl&gt;           &lt;dbl&gt;</span></span>
<span><span class="co">## 1 Afghanistan Asia           1952      779.          -0.640</span></span>
<span><span class="co">## 2 Afghanistan Asia           1957      821.          -0.636</span></span>
<span><span class="co">## 3 Afghanistan Asia           1962      853.          -0.632</span></span>
<span><span class="co">## 4 Afghanistan Asia           1967      836.          -0.634</span></span>
<span><span class="co">## 5 Afghanistan Asia           1972      740.          -0.644</span></span>
<span><span class="co">## 6 Afghanistan Asia           1977      786.          -0.639</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>That’s because (1) <code><a href="https://rdrr.io/r/base/scale.html">scale()</a></code> returns values as a 1-column matrix for whatever reason, and (2) the special mean and standard deviation metadata attributes are stored in that matrix. We can access those attributes like normal:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">gdp_mean_sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attributes.html">attributes</a></span><span class="op">(</span><span class="va">gapminder</span><span class="op">$</span><span class="va">gdpPercap_z</span><span class="op">)</span></span>
<span><span class="va">gdp_mean_sd</span></span>
<span><span class="co">## $dim</span></span>
<span><span class="co">## [1] 1680    1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $`scaled:center`</span></span>
<span><span class="co">## [1] 7052</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $`scaled:scale`</span></span>
<span><span class="co">## [1] 9804</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Just for fun, we can verify that these values are the same as the average and standard deviation of GDP per capita:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">gapminder</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>avg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">gdpPercap</span><span class="op">)</span>,</span>
<span>            sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">gdpPercap</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 1 × 2</span></span>
<span><span class="co">##     avg    sd</span></span>
<span><span class="co">##   &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">## 1 7052. 9804.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>They’re the same!</p>
<p>To make sure that we really can scale and unscale this stuff, let’s look at the first few rows of the data and multiply the scaled <code>gdpPercap_z</code> column by the attributes we extracted:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">gapminder</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">slice</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">gdpPercap</span>, <span class="va">gdpPercap_z</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>unscaled <span class="op">=</span> <span class="va">gdpPercap_z</span> <span class="op">*</span> <span class="va">gdp_mean_sd</span><span class="op">$</span><span class="va">`scaled:scale`</span> <span class="op">+</span> <span class="va">gdp_mean_sd</span><span class="op">$</span><span class="va">`scaled:center`</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 5 × 3</span></span>
<span><span class="co">##   gdpPercap gdpPercap_z[,1] unscaled[,1]</span></span>
<span><span class="co">##       &lt;dbl&gt;           &lt;dbl&gt;        &lt;dbl&gt;</span></span>
<span><span class="co">## 1      779.          -0.640         779.</span></span>
<span><span class="co">## 2      821.          -0.636         821.</span></span>
<span><span class="co">## 3      853.          -0.632         853.</span></span>
<span><span class="co">## 4      836.          -0.634         836.</span></span>
<span><span class="co">## 5      740.          -0.644         740.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>They’re the same!</p>
<p>Unscaling regression coefficients is a little different. We don’t need to add the mean, since we’re working with marginal effects (i.e.&nbsp;the effect of adding one additional dollar of GDP per capita), and instead of multiplying by the standard deviation, we divide by it. Once again, just to make sure we can unscale correctly, we can run a couple models: one with GDP per capita in the thousands, and one with the scaled and centered GDP per capita. In theory, if we divide the coefficient from the second model by the standard deviation and multiply it by 1,000 (to scaled it up so it shows GDP per capita in the thousands), we’ll get the same value:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_super_simple</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">lifeExp</span> <span class="op">~</span> <span class="va">gdpPercap_1000</span>, data <span class="op">=</span> <span class="va">gapminder</span><span class="op">)</span></span>
<span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_super_simple</span><span class="op">)</span>  <span class="co"># 0.755</span></span>
<span><span class="co">## # A tibble: 2 × 5</span></span>
<span><span class="co">##   term           estimate std.error statistic   p.value</span></span>
<span><span class="co">##   &lt;chr&gt;             &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 (Intercept)      53.9      0.317      170.  0        </span></span>
<span><span class="co">## 2 gdpPercap_1000    0.755    0.0262      28.8 1.53e-148</span></span>
<span></span>
<span><span class="va">model_super_simple_z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">lifeExp</span> <span class="op">~</span> <span class="va">gdpPercap_z</span>, data <span class="op">=</span> <span class="va">gapminder</span><span class="op">)</span></span>
<span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_super_simple_z</span><span class="op">)</span>  <span class="co"># 7.41</span></span>
<span><span class="co">## # A tibble: 2 × 5</span></span>
<span><span class="co">##   term        estimate std.error statistic   p.value</span></span>
<span><span class="co">##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 (Intercept)    59.3      0.257     231.  0        </span></span>
<span><span class="co">## 2 gdpPercap_z     7.41     0.257      28.8 1.53e-148</span></span>
<span></span>
<span><span class="co"># Can we get the 7.41 coefficient from the centered/scaled model to turn into</span></span>
<span><span class="co"># 0.755 from the original model?</span></span>
<span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_super_simple_z</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">term</span> <span class="op">==</span> <span class="st">"gdpPercap_z"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>estimate_unscaled_1000 <span class="op">=</span> <span class="va">estimate</span> <span class="op">/</span> <span class="va">gdp_mean_sd</span><span class="op">$</span><span class="va">`scaled:scale`</span> <span class="op">*</span> <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 1 × 6</span></span>
<span><span class="co">##   term        estimate std.error statistic   p.value estimate_unscaled_1000</span></span>
<span><span class="co">##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;                  &lt;dbl&gt;</span></span>
<span><span class="co">## 1 gdpPercap_z     7.41     0.257      28.8 1.53e-148                  0.755</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>They’re the same!</p>
</section></section><section id="logging" class="level3"><h3 class="anchored" data-anchor-id="logging">Logging</h3>
<section id="log" class="level4"><h4 class="anchored" data-anchor-id="log">3: Log</h4>
<p>Stan also seems to like to work with more normally distributed variables. With GDP per capita, lots of countries have a low value, and a few have really high values, resulting in a skewed distribution that can sometimes cause issues when sampling. To address this, we can take the log of GDP per capita and think about changes in orders of magnitude (i.e.&nbsp;moving from \$300 to \$3,000 to \$30,000, and so on) rather than linear changes. Back-transforming logged values is easy—exponentiate the value (i.e.&nbsp;<span class="math inline">\(e^\text{logged value}\)</span>) if you’re using a natural log, which is what R does by default when you use <code><a href="https://rdrr.io/r/base/Log.html">log()</a></code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">5000</span><span class="op">)</span></span>
<span><span class="co">## [1] 8.52</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">5000</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## [1] 5000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can verify this works with our data:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">gapminder</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">slice</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">gdpPercap</span>, <span class="va">gdpPercap_log</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>unlogged <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">gdpPercap_log</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 5 × 3</span></span>
<span><span class="co">##   gdpPercap gdpPercap_log unlogged</span></span>
<span><span class="co">##       &lt;dbl&gt;         &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">## 1      779.          6.66     779.</span></span>
<span><span class="co">## 2      821.          6.71     821.</span></span>
<span><span class="co">## 3      853.          6.75     853.</span></span>
<span><span class="co">## 4      836.          6.73     836.</span></span>
<span><span class="co">## 5      740.          6.61     740.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Working with logged variables in regression, though, is a little trickier since there’s no consistent way to back-transform the logged effects to their original scale—with logs, we’re working with orders of magnitude, so the coefficient represents a different kind of change in the outcome. But it’s okay! We can interpret things using percent changes rather than actual values. <a href="https://stats.stackexchange.com/a/18639/3025">This response at Cross Validated</a> is my favorite resource for remembering how to interpret regression results with logs in them (<a href="https://data.library.virginia.edu/interpreting-log-transformations-in-a-linear-model/">this resource</a> is helpful too).</p>
<p>When we have a regression model with a logged predictor, we talk about percent increases in the predictor variables. In a model like this, for instance…</p>
<p><span class="math display">\[
\text{Outcome} = \beta_0 + \beta_1 \log(\text{Predictor}) + \epsilon
\]</span></p>
<p>…we’d say “A 1% increase in the predictor is associated with a (<span class="math inline">\(\beta_1\)</span> / 100) unit increase in the outcome.” If we want to think about larger increases in the predictor, like 10%, we can divide the <span class="math inline">\(\beta_1\)</span> coefficient by 10 instead.</p>
<p>Here’s what this looks like with logged GDP per capita:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_super_simple_log</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">lifeExp</span> <span class="op">~</span> <span class="va">gdpPercap_log</span>, data <span class="op">=</span> <span class="va">gapminder</span><span class="op">)</span></span>
<span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_super_simple_log</span><span class="op">)</span>  <span class="co"># 8.38</span></span>
<span><span class="co">## # A tibble: 2 × 5</span></span>
<span><span class="co">##   term          estimate std.error statistic  p.value</span></span>
<span><span class="co">##   &lt;chr&gt;            &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">## 1 (Intercept)      -8.94     1.25      -7.16 1.17e-12</span></span>
<span><span class="co">## 2 gdpPercap_log     8.38     0.152     55.3  0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In this model, a one-unit increase in logged GDP per capita is associated with a 8.38 year increase in life expectancy. But thinking about increases in logged values is weird—we can think about percent changes instead.</p>
<p>The 8.38 coefficient by itself shows the effect of a 100% increase in GDP per capita, which is huge, so we can scale it down to see the effect of a 1% increase (if we divide by 100) or a 10% increase (if we divide by 10). A 10% increase in income for country with a GDP per capita of \$1,000 would boost its income to $1,100 (<code>1000 * 1.1</code>), which is a \$100 change. For a country with a GDP per capita of \$10,000, a 10% increase would result in $11,000 (<code>10000 * 1.1</code>), or a \$1,000 boost. According to our model, both of those changes (\$100 for a poor country, \$1,000 for a wealthier country) should result in the same change in life expectancy.</p>
<p>We’ll consider 10% increases since those are more sizable (e.g., a 1% increase in a country with a GDP per capita of \$1,000 would lead to $1,010—that \$10 increase is hardly going to move the needle in life expectancy).</p>
<p>Thus, according to this not-very-great-at-all model, a 10% increase in GDP per capita is associated with a 0.838 (<code>8.38 / 10</code>) year increase in life expectancy, on average.</p>
</section><section id="log-scale-and-center" class="level4"><h4 class="anchored" data-anchor-id="log-scale-and-center">4: Log + scale and center</h4>
<p>And finally, since Stan likes working with centered variables, we can also scale and center logged values. If we want to interpret them we have to back-transform them by rescaling them up with the standard deviation. When we created the scaled version of logged GDP per capita at the beginning of this post, R stored the mean and standard deviation as metadata attributes. We can extract those and scale things back up as needed:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/attributes.html">attributes</a></span><span class="op">(</span><span class="va">gapminder</span><span class="op">$</span><span class="va">gdpPercap_log_z</span><span class="op">)</span></span>
<span><span class="co">## $dim</span></span>
<span><span class="co">## [1] 1680    1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $`scaled:center`</span></span>
<span><span class="co">## [1] 8.14</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $`scaled:scale`</span></span>
<span><span class="co">## [1] 1.23</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section></section><section id="the-effect-of-wealth-on-health-accounting-for-country-and-time" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="the-effect-of-wealth-on-health-accounting-for-country-and-time">The effect of wealth on health, accounting for country and time</h2>
<p>Okay, phew. So far we’ve looked at how to model time trends across countries and continents with multilevel models, and we’ve seen how to scale and unscale variables to work better with Stan and <strong>brms</strong>. We’re really actually interested in Hans Rosling’s and the Gapminder Project’s original question—what’s the relationship between wealth and health, or GDP per capita and life expectancy? This fancy multilevel structure so far lets us model the time relationships, but we can use that year trend to account for time in more complex models.</p>
<p>For instance, we know from the Gapminder video that life expectancy increases as wealth increases, but that relationship differs by country. Visualizing the across-time trajectories of each country in the data helps with the intuition here. Countries like Canada, Italy, and Portugal have fairly steady trajectories over time, while places like Bolivia, Egypt, and Yemen see really steep increases in life expectancy. Sierra Leone tragically backtracks in both income and life expectancy in the 1990s.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">gapminder</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">gdpPercap</span>, y <span class="op">=</span> <span class="va">lifeExp</span>, color <span class="op">=</span> <span class="va">continent</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.5</span>, alpha <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_smooth</span><span class="op">(</span>method <span class="op">=</span> <span class="st">"lm"</span>, <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"grey60"</span>, size <span class="op">=</span> <span class="fl">0.5</span>, </span>
<span>              se <span class="op">=</span> <span class="cn">FALSE</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">annotate</span><span class="op">(</span>geom <span class="op">=</span> <span class="st">"label"</span>, label <span class="op">=</span> <span class="st">"Global trend"</span>, x <span class="op">=</span> <span class="fl">64000</span>, y <span class="op">=</span> <span class="fl">84</span>, </span>
<span>           size <span class="op">=</span> <span class="fl">3</span>, color <span class="op">=</span> <span class="st">"grey60"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_path</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>group <span class="op">=</span> <span class="va">country</span>, size <span class="op">=</span> <span class="va">highlight</span><span class="op">)</span>,</span>
<span>            arrow <span class="op">=</span> <span class="fu">arrow</span><span class="op">(</span>type <span class="op">=</span> <span class="st">"open"</span>, angle <span class="op">=</span> <span class="fl">30</span>, length <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0.75</span>, <span class="st">"lines"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_label_repel</span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">gapminder</span>, <span class="va">year</span> <span class="op">==</span> <span class="fl">15</span>, <span class="va">highlight</span> <span class="op">==</span> <span class="cn">TRUE</span><span class="op">)</span>, </span>
<span>                   <span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">country</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">3</span>, seed <span class="op">=</span> <span class="fl">1234</span>, </span>
<span>                   show.legend <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                   family <span class="op">=</span> <span class="st">"Barlow Semi Condensed"</span>, fontface <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_size_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.075</span>, <span class="fl">1</span><span class="op">)</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_okabe_ito</span><span class="op">(</span>order <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">6</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>                        guide <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">3</span>, alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_log10</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">dollar_format</span><span class="op">(</span>accuracy <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, breaks <span class="op">=</span> <span class="fl">125</span> <span class="op">*</span> <span class="op">(</span><span class="fl">2</span><span class="op">^</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"GDP per capita (log)"</span>, y <span class="op">=</span> <span class="st">"Life expectancy"</span>, color <span class="op">=</span> <span class="st">"Continent"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_clean</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/plot-gdp-lifeexp-time-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page-inset-right" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>We’re interested in the effect of GDP per capita on life expectancy, but getting a single value for this is a little tricky. The grey line here shows the global trend—on average, health and wealth clearly move together. But that’s not a universal effect. Look at Italy, for instance—its slope is relatively constant over time. Egypt’s wealth slope gets steeper and shallower over time, while Sierra Leone reverses at some points. For the rest of this post, we’ll explore how to calculate and visualize these different country-specific and global effects.</p>
<p>In the first part of this guide, we cared about average life expectancy over time, so we plotted predicted life expectancy. Now, though, we care about the GDP effect, or the GDP coefficient in a model like <code>lifeExp ~ gdpPercap</code>, so we’ll work with and visualize that throughout the rest of this guide. We’ll look at the posterior distribution of this coefficient to see how much this wealth effect varies. We’ll use the <code>emtrends()</code> function from <strong>emmeans</strong> throughout, since it’s designed to calculate instantaneous average marginal effects (<a href="https://www.andrewheiss.com/blog/2021/11/10/ame-bayes-re-guide/#average-marginal-effects">see this for more on average marginal effects</a>).</p>
<p>We’ll use the centered version of GDP per capita to speed up model fitting, which means we’ll need to unscale coefficients to interpret them. We’ll also interpret coefficients using \$1,000 increases in GDP per capita (since a \$1 increase in wealth won’t lead to much of a difference in life expectancy). As these models get more complex, we’ll switch from regular GDP per capita to logged GDP per capita for the sake of computation.</p>
<p>Let’s extract the mean and standard deviation from both centered GDP per capita and centered logged GDP per capita so we can use them below:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">gdp_mean_sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attributes.html">attributes</a></span><span class="op">(</span><span class="va">gapminder</span><span class="op">$</span><span class="va">gdpPercap_z</span><span class="op">)</span></span>
<span><span class="va">gdp_mean</span> <span class="op">&lt;-</span> <span class="va">gdp_mean_sd</span><span class="op">$</span><span class="va">`scaled:center`</span></span>
<span><span class="va">gdp_sd</span> <span class="op">&lt;-</span> <span class="va">gdp_mean_sd</span><span class="op">$</span><span class="va">`scaled:scale`</span></span>
<span></span>
<span><span class="va">gdp_log_mean_sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attributes.html">attributes</a></span><span class="op">(</span><span class="va">gapminder</span><span class="op">$</span><span class="va">gdpPercap_log_z</span><span class="op">)</span></span>
<span><span class="va">gdp_log_mean</span> <span class="op">&lt;-</span> <span class="va">gdp_log_mean_sd</span><span class="op">$</span><span class="va">`scaled:center`</span></span>
<span><span class="va">gdp_log_sd</span> <span class="op">&lt;-</span> <span class="va">gdp_log_mean_sd</span><span class="op">$</span><span class="va">`scaled:scale`</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="regular-regression-1" class="level3"><h3 class="anchored" data-anchor-id="regular-regression-1">Regular regression</h3>
<p>Like we did when we looked at just year trends, we’ll start with a regular old non-multilevel regression model to help get our bearings. We’ll actually run two different models: one with scaled and centered GDP per capita and one with scaled and centered logged GDP per capita, mostly to get used to scaling the coefficients up. These simple models fit just fine in under a second, but as we add more complexity, the non-logged GDP per capita gets really unstable and unwieldy, so we’ll shift to the logged version.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/model-gdp-boring_9d76fe6e26d44660df1fa81baf4e52d2">
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_gdp_boring</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span></span>
<span>  <span class="fu">bf</span><span class="op">(</span><span class="va">lifeExp</span> <span class="op">~</span> <span class="va">gdpPercap_z</span> <span class="op">+</span> <span class="va">year</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">gapminder</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="va">bayes_seed</span></span>
<span><span class="op">)</span></span>
<span><span class="co">## Start sampling</span></span>
<span></span>
<span><span class="va">model_gdp_boring_log</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span></span>
<span>  <span class="fu">bf</span><span class="op">(</span><span class="va">lifeExp</span> <span class="op">~</span> <span class="va">gdpPercap_log_z</span> <span class="op">+</span> <span class="va">year</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">gapminder</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="va">bayes_seed</span></span>
<span><span class="op">)</span></span>
<span><span class="co">## Start sampling</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_gdp_boring</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 4 × 8</span></span>
<span><span class="co">##   effect   component group    term            estimate std.error conf.low conf.high</span></span>
<span><span class="co">##   &lt;chr&gt;    &lt;chr&gt;     &lt;chr&gt;    &lt;chr&gt;              &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 fixed    cond      &lt;NA&gt;     (Intercept)       52.6      0.453    51.7      53.4  </span></span>
<span><span class="co">## 2 fixed    cond      &lt;NA&gt;     gdpPercap_z        6.46     0.246     6.00      6.95 </span></span>
<span><span class="co">## 3 fixed    cond      &lt;NA&gt;     year               0.244    0.0138    0.217     0.271</span></span>
<span><span class="co">## 4 ran_pars cond      Residual sd__Observation    9.71     0.169     9.40     10.0</span></span>
<span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_gdp_boring_log</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 4 × 8</span></span>
<span><span class="co">##   effect   component group    term            estimate std.error conf.low conf.high</span></span>
<span><span class="co">##   &lt;chr&gt;    &lt;chr&gt;     &lt;chr&gt;    &lt;chr&gt;              &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 fixed    cond      &lt;NA&gt;     (Intercept)       53.8      0.323    53.2      54.5  </span></span>
<span><span class="co">## 2 fixed    cond      &lt;NA&gt;     gdpPercap_log_z    9.54     0.174     9.20      9.88 </span></span>
<span><span class="co">## 3 fixed    cond      &lt;NA&gt;     year               0.198    0.0101    0.178     0.218</span></span>
<span><span class="co">## 4 ran_pars cond      Residual sd__Observation    6.92     0.118     6.69      7.15</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can look at the results, but the coefficients for the scaled variables are a little tricky to interpret here. Technically they represent the increase in life expectancy that follows a 1 standard deviation increase in GDP per capita (not logged and logged), but I don’t think in standard deviations and I prefer to shift these coefficients back to their original scales. To do that we just need to divide by the standard deviation of the original columns. We’ll also multiply the GDP per capita coefficient by 1,000 so we can talk about changes in life expectancy that follow a \$1,000 increase in wealth, and we’ll divide the logged GDP per capita coefficient by 10 so we can talk about changes in life expectancy that follow a 10% increase in wealth. This neat combination of <code>across()</code> and <code><a href="https://rdrr.io/r/base/ifelse.html">ifelse()</a></code> inside <code>mutate()</code> lets us rescale multiple columns for just a single row, which is cool.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_gdp_boring</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">estimate</span>, <span class="va">std.error</span>, <span class="va">conf.low</span>, <span class="va">conf.high</span><span class="op">)</span>,</span>
<span>                <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">term</span> <span class="op">==</span> <span class="st">"gdpPercap_z"</span>, <span class="op">(</span><span class="va">.</span> <span class="op">/</span> <span class="va">gdp_sd</span><span class="op">)</span> <span class="op">*</span> <span class="fl">1000</span>, <span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 4 × 8</span></span>
<span><span class="co">##   effect   component group    term            estimate std.error conf.low conf.high</span></span>
<span><span class="co">##   &lt;chr&gt;    &lt;chr&gt;     &lt;chr&gt;    &lt;chr&gt;              &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 fixed    cond      &lt;NA&gt;     (Intercept)       52.6      0.453    51.7      53.4  </span></span>
<span><span class="co">## 2 fixed    cond      &lt;NA&gt;     gdpPercap_z        0.659    0.0251    0.612     0.709</span></span>
<span><span class="co">## 3 fixed    cond      &lt;NA&gt;     year               0.244    0.0138    0.217     0.271</span></span>
<span><span class="co">## 4 ran_pars cond      Residual sd__Observation    9.71     0.169     9.40     10.0</span></span>
<span></span>
<span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_gdp_boring_log</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">estimate</span>, <span class="va">std.error</span>, <span class="va">conf.low</span>, <span class="va">conf.high</span><span class="op">)</span>,</span>
<span>                <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">term</span> <span class="op">==</span> <span class="st">"gdpPercap_log_z"</span>, <span class="op">(</span><span class="va">.</span> <span class="op">/</span> <span class="va">gdp_log_sd</span><span class="op">)</span>, <span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 4 × 8</span></span>
<span><span class="co">##   effect   component group    term            estimate std.error conf.low conf.high</span></span>
<span><span class="co">##   &lt;chr&gt;    &lt;chr&gt;     &lt;chr&gt;    &lt;chr&gt;              &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 fixed    cond      &lt;NA&gt;     (Intercept)       53.8      0.323    53.2      54.5  </span></span>
<span><span class="co">## 2 fixed    cond      &lt;NA&gt;     gdpPercap_log_z    7.73     0.141     7.46      8.01 </span></span>
<span><span class="co">## 3 fixed    cond      &lt;NA&gt;     year               0.198    0.0101    0.178     0.218</span></span>
<span><span class="co">## 4 ran_pars cond      Residual sd__Observation    6.92     0.118     6.69      7.15</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Based on this model, when <code>year</code> is 0 (or in 1952) <em>and</em> when a country’s GDP per capita is \$0, the average life expectancy is 52.55 years on average. It increases by 0.24 years annually after that, holding income constant, and it increases by 0.66 years for every \$1,000 increase in wealth, holding time constant.</p>
<p>If we look at logged GDP per capita, we see a similar story: a 10% increase in GDP per capita is associated with a 0.773 (7.73 / 10) year increase in life expectancy, holding time constant.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ame_model_gdp_boring</span> <span class="op">&lt;-</span> <span class="va">model_gdp_boring</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">emtrends</span><span class="op">(</span><span class="op">~</span> <span class="fl">1</span>,</span>
<span>           var <span class="op">=</span> <span class="st">"gdpPercap_z"</span>,</span>
<span>           at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>           epred <span class="op">=</span> <span class="cn">TRUE</span>, re_formula <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pred_ame_model_gdp_boring</span> <span class="op">&lt;-</span> <span class="va">ame_model_gdp_boring</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">gather_emmeans_draws</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>.value <span class="op">=</span> <span class="va">.value</span> <span class="op">/</span> <span class="va">gdp_sd</span> <span class="op">*</span> <span class="fl">1000</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>fake_facet_title <span class="op">=</span> <span class="st">"GDP per capita"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_ame_gdp</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">pred_ame_model_gdp_boring</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">.value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span>fill <span class="op">=</span> <span class="fu">palette_okabe_ito</span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>,</span>
<span>               .width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.8</span>, <span class="fl">0.95</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Average marginal effect on life expectancy"</span>, <span class="st">"\n"</span>, </span>
<span>                  <span class="st">"of a $1,000 increase in GDP per capita"</span><span class="op">)</span>, </span>
<span>       y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">fake_facet_title</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_clean</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>strip.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fu">rel</span><span class="op">(</span><span class="fl">1.1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">ame_model_gdp_boring_log</span> <span class="op">&lt;-</span> <span class="va">model_gdp_boring_log</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">emtrends</span><span class="op">(</span><span class="op">~</span> <span class="fl">1</span>,</span>
<span>           var <span class="op">=</span> <span class="st">"gdpPercap_log_z"</span>,</span>
<span>           at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>           epred <span class="op">=</span> <span class="cn">TRUE</span>, re_formula <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pred_ame_model_gdp_boring_log</span> <span class="op">&lt;-</span> <span class="va">ame_model_gdp_boring_log</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">gather_emmeans_draws</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>.value <span class="op">=</span> <span class="va">.value</span> <span class="op">/</span> <span class="va">gdp_log_sd</span> <span class="op">/</span> <span class="fl">10</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>fake_facet_title <span class="op">=</span> <span class="st">"Logged GDP per capita"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_ame_gdp_log</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">pred_ame_model_gdp_boring_log</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">.value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span>fill <span class="op">=</span> <span class="fu">palette_okabe_ito</span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>,</span>
<span>               .width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.8</span>, <span class="fl">0.95</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Average marginal effect on life expectancy"</span>, <span class="st">"\n"</span>, </span>
<span>                  <span class="st">"of a 10% increase in GDP per capita"</span><span class="op">)</span>, </span>
<span>       y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">fake_facet_title</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_clean</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>strip.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fu">rel</span><span class="op">(</span><span class="fl">1.1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="va">plot_ame_gdp</span> <span class="op">+</span> <span class="va">plot_ame_gdp_log</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">plot_annotation</span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Average marginal effect of GDP per capita"</span>, <span class="st">"\n"</span>,</span>
<span>                                 <span class="st">"(includes year trend with no country-based variation)"</span><span class="op">)</span>, </span>
<span>                  subtitle <span class="op">=</span> <span class="st">"lifeExp ~ gdpPercap_log_z + year"</span>,</span>
<span>                  caption <span class="op">=</span> <span class="st">"80% and 95% credible intervals shown with error bar"</span>,</span>
<span>                  theme <span class="op">=</span> <span class="fu">theme_clean</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme</span><span class="op">(</span>plot.subtitle <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Consolas"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-ame-gdp-boring-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section><section id="each-country-gets-its-own-intercept-and-gdp-slope" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="each-country-gets-its-own-intercept-and-gdp-slope">Each country gets its own intercept and GDP slope</h3>
<p>As we saw in the plot with the different across-time trajectories, each country has a slightly different relationship between wealth and life expectancy. Using multilevel modeling, we can incorporate country-specific offsets into both the intercept (<span class="math inline">\(b_{0, \text{Country}}\)</span>) and the fixed GDP per capita effect (<span class="math inline">\(b_{1, \text{Country}}\)</span>). As always, each of these country-specific offsets has its own variation that we call <span class="math inline">\(\tau\)</span>.</p>
<p><span class="math display">\[
\begin{aligned}
\text{Life expectancy} &amp;= (\beta_0 + b_{0, \text{Country}}) + (\beta_1 + b_{1, \text{Country}}) \text{GDP} + \beta_2 \text{Year} + \epsilon \\
b_{0, \text{Country}} &amp;\sim \mathcal{N}(0, \tau_0) \\
b_{1, \text{Country}} &amp;\sim \mathcal{N}(0, \tau_1)
\end{aligned}
\]</span></p>
<p>The syntax for this random effects term is <code>(1 + gdpPercap_z | country)</code>—we’re letting both the intercept (<code>1</code>) and GDP per capita vary by country. We’ll use the scaled versions of both regular GDP per capita and logged GDP per capita.</p>
<p>Note the addition of the <code>decomp = "QR"</code> argument here—that tells <strong>brms</strong> to use QR decomposition for decorrelating highly correlated covariates (like year and GDP across country), and it can speed up computation (<a href="https://mc-stan.org/users/documentation/case-studies/qr_regression.html">see here for more about that</a>).</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/model-gdp-country_66e44abb15479f15183de08f5df94cf0">
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_gdp_country_only</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span></span>
<span>  <span class="fu">bf</span><span class="op">(</span><span class="va">lifeExp</span> <span class="op">~</span> <span class="va">gdpPercap_z</span> <span class="op">+</span> <span class="va">year</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">gdpPercap_z</span> <span class="op">|</span> <span class="va">country</span><span class="op">)</span>,</span>
<span>     decomp <span class="op">=</span> <span class="st">"QR"</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">gapminder</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="va">bayes_seed</span>,</span>
<span>  threads <span class="op">=</span> <span class="fu">threading</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>  <span class="co"># Two CPUs per chain to speed things up</span></span>
<span><span class="op">)</span></span>
<span><span class="co">## Start sampling</span></span>
<span></span>
<span><span class="va">model_gdp_country_only_log</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span></span>
<span>  <span class="fu">bf</span><span class="op">(</span><span class="va">lifeExp</span> <span class="op">~</span> <span class="va">gdpPercap_log_z</span> <span class="op">+</span> <span class="va">year</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">gdpPercap_log_z</span> <span class="op">|</span> <span class="va">country</span><span class="op">)</span>,</span>
<span>     decomp <span class="op">=</span> <span class="st">"QR"</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">gapminder</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="va">bayes_seed</span>,</span>
<span>  threads <span class="op">=</span> <span class="fu">threading</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>  <span class="co"># Two CPUs per chain to speed things up</span></span>
<span><span class="op">)</span></span>
<span><span class="co">## Start sampling</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Adding this country-level complexity starts slowing down the regular GDP version substantially—it takes twice as long to fit the model with <code>gdpPercap_z</code> than it does <code>gdpPercap_log_z</code>, and there are issues with divergent chains and model fit. This is a great example of <a href="https://statmodeling.stat.columbia.edu/2008/05/13/the_folk_theore/">Andrew Gelman’s folk theorem of statistical computing</a>: <strong>“when you have computational problems, often there’s a problem with your model.”</strong> We could fix this by using more specific priors, using more iterations in the chains, or adjusting some of Stan’s parameters like <code>adapt_delta</code>, but for the sake of this example, we won’t.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Model with regular GDP per capita</span></span>
<span><span class="fu">rstan</span><span class="fu">::</span><span class="fu">get_elapsed_time</span><span class="op">(</span><span class="va">model_gdp_country_only</span><span class="op">$</span><span class="va">fit</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">as_tibble</span><span class="op">(</span>rownames <span class="op">=</span> <span class="st">"chain"</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">mutate</span><span class="op">(</span>total_seconds <span class="op">=</span> <span class="va">warmup</span> <span class="op">+</span> <span class="va">sample</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 4 × 4</span></span>
<span><span class="co">##   chain   warmup sample total_seconds</span></span>
<span><span class="co">##   &lt;chr&gt;    &lt;dbl&gt;  &lt;dbl&gt;         &lt;dbl&gt;</span></span>
<span><span class="co">## 1 chain:1   27.6   30.3          57.8</span></span>
<span><span class="co">## 2 chain:2   31.9   27.9          59.9</span></span>
<span><span class="co">## 3 chain:3   28.3   28.5          56.9</span></span>
<span><span class="co">## 4 chain:4   29.4   28.1          57.5</span></span>
<span></span>
<span><span class="co"># Model with logged GDP per capita </span></span>
<span><span class="fu">rstan</span><span class="fu">::</span><span class="fu">get_elapsed_time</span><span class="op">(</span><span class="va">model_gdp_country_only_log</span><span class="op">$</span><span class="va">fit</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">as_tibble</span><span class="op">(</span>rownames <span class="op">=</span> <span class="st">"chain"</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">mutate</span><span class="op">(</span>total_seconds <span class="op">=</span> <span class="va">warmup</span> <span class="op">+</span> <span class="va">sample</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 4 × 4</span></span>
<span><span class="co">##   chain   warmup sample total_seconds</span></span>
<span><span class="co">##   &lt;chr&gt;    &lt;dbl&gt;  &lt;dbl&gt;         &lt;dbl&gt;</span></span>
<span><span class="co">## 1 chain:1   14.4   13.8          28.2</span></span>
<span><span class="co">## 2 chain:2   15.0   13.3          28.3</span></span>
<span><span class="co">## 3 chain:3   14.7   13.7          28.4</span></span>
<span><span class="co">## 4 chain:4   14.4   13.9          28.2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="fixed-population-level-effects-4" class="level4"><h4 class="anchored" data-anchor-id="fixed-population-level-effects-4">Fixed (population-level) effects</h4>
<p>The global population-level coefficients are similar to what we saw in the basic model without random country effects: holding year trends constant, life expectancy increases by 1.17 years for every \$1,000 increase in wealth and 0.34 years for every 10% increase in wealth, on average.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Unscale both the GDP coefficient and the GDP random variance coefficient</span></span>
<span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_gdp_country_only</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">estimate</span>, <span class="va">std.error</span>, <span class="va">conf.low</span>, <span class="va">conf.high</span><span class="op">)</span>,</span>
<span>                <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">term</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"gdpPercap_z"</span>, <span class="st">"sd__gdpPercap_z"</span><span class="op">)</span>, </span>
<span>                        <span class="op">(</span><span class="va">.</span> <span class="op">/</span> <span class="va">gdp_sd</span><span class="op">)</span> <span class="op">*</span> <span class="fl">1000</span>, <span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 7 × 8</span></span>
<span><span class="co">##   effect   component group    term                   estimate std.error conf.low conf.high</span></span>
<span><span class="co">##   &lt;chr&gt;    &lt;chr&gt;     &lt;chr&gt;    &lt;chr&gt;                     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 fixed    cond      &lt;NA&gt;     (Intercept)              57.1     1.22      54.8      59.5  </span></span>
<span><span class="co">## 2 fixed    cond      &lt;NA&gt;     gdpPercap_z               1.17    0.208      0.793     1.59 </span></span>
<span><span class="co">## 3 fixed    cond      &lt;NA&gt;     year                      0.310   0.00618    0.298     0.322</span></span>
<span><span class="co">## 4 ran_pars cond      country  sd__(Intercept)           9.94    0.918      8.35     11.9  </span></span>
<span><span class="co">## 5 ran_pars cond      country  sd__gdpPercap_z           1.73    0.210      1.33      2.14 </span></span>
<span><span class="co">## 6 ran_pars cond      country  cor__(Intercept).gdpP…    0.201   0.154     -0.118     0.477</span></span>
<span><span class="co">## 7 ran_pars cond      Residual sd__Observation           2.92    0.0584     2.81      3.04</span></span>
<span></span>
<span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_gdp_country_only_log</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">estimate</span>, <span class="va">std.error</span>, <span class="va">conf.low</span>, <span class="va">conf.high</span><span class="op">)</span>,</span>
<span>                <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">term</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"gdpPercap_log_z"</span>, <span class="st">"sd__gdpPercap_log_z"</span><span class="op">)</span>, </span>
<span>                        <span class="op">(</span><span class="va">.</span> <span class="op">/</span> <span class="va">gdp_log_sd</span><span class="op">)</span>, <span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 7 × 8</span></span>
<span><span class="co">##   effect   component group    term                   estimate std.error conf.low conf.high</span></span>
<span><span class="co">##   &lt;chr&gt;    &lt;chr&gt;     &lt;chr&gt;    &lt;chr&gt;                     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 fixed    cond      &lt;NA&gt;     (Intercept)              53.7     0.976     51.8     55.6   </span></span>
<span><span class="co">## 2 fixed    cond      &lt;NA&gt;     gdpPercap_log_z           3.40    0.576      2.27     4.52  </span></span>
<span><span class="co">## 3 fixed    cond      &lt;NA&gt;     year                      0.283   0.00628    0.270    0.295 </span></span>
<span><span class="co">## 4 ran_pars cond      country  sd__(Intercept)          11.2     0.759      9.80    12.8   </span></span>
<span><span class="co">## 5 ran_pars cond      country  sd__gdpPercap_log_z       5.69    0.443      4.88     6.62  </span></span>
<span><span class="co">## 6 ran_pars cond      country  cor__(Intercept).gdpP…   -0.277   0.101     -0.462   -0.0677</span></span>
<span><span class="co">## 7 ran_pars cond      Residual sd__Observation           2.76    0.0532     2.66     2.87</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="country-level-variation-3" class="level4"><h4 class="anchored" data-anchor-id="country-level-variation-3">Country-level variation</h4>
<p>We also have a few random effects terms that we can interpret. The variance for the intercept (<code>sd__(Intercept)</code>) corresponds to <span class="math inline">\(\tau_0\)</span> and shows us how much life expectancy bounces around across countries. We can also see what proportion this country-level variation contributes to the the total residual variation of the model. For the GDP per capita model, the country structure contributes 77% (9.94 / (9.94 + 2.92)) of the total variance in life expectancy, while it contributes 80% (11.16 / (11.16 + 2.76)) in the logged GDP per capita model.</p>
<p>The <code>sd__gdpPercap_z</code> term is <span class="math inline">\(\tau_1\)</span> and shows the country-specific variation in the GDP effect. This is smaller than the intercept variance, but that’s because the GDP effect is a slope that measures the <em>marginal change</em> in life expectancy as wealth increases by one unit (or $1,000 here), not life expectancy itself. (We unscaled the values for <code>sd__gdpPercap_z</code> and <code>sd__gdpPercap_log_z</code> here too, like we did their actual fixed coefficients.)</p>
<p>Finally, we have a term that shows the correlation of the country-specific intercepts and slopes. In the regular GDP per capita model, we see a correlation of 0.2, which means that countries with lower intercepts are associated with lower GDP effects—countries that start out poor in 1952 grow slower. This correlation reverses in the logged GDP per capita model, where we have a correlation of -0.28, which implies that countries with lower intercepts are associated with bigger GDP effects—countries that start out poor in 1952 grow faster. Why the reversal? Haha I don’t know. It could be because the two measures of GDP capture different things: the logged version shows changes in orders of magnitude, while the regular version shows changes in dollar amounts. Somehow that difference makes the correlation flip. Weird.</p>
</section><section id="country-level-random-effects-2" class="level4"><h4 class="anchored" data-anchor-id="country-level-random-effects-2">Country-level random effects</h4>
<p>For fun, we can look at the country-level offsets for the intercept and the GDP slope.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ranef</span><span class="op">(</span><span class="va">model_gdp_country_only</span><span class="op">)</span><span class="op">$</span><span class="va">country</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">as_tibble</span><span class="op">(</span>rownames <span class="op">=</span> <span class="st">"country"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">country</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">countries</span><span class="op">$</span><span class="va">country</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">country</span>, <span class="fu">starts_with</span><span class="op">(</span><span class="st">"Estimate"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Unscale the GDP offsets</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>Estimate.gdpPercap_z <span class="op">=</span> <span class="va">Estimate.gdpPercap_z</span> <span class="op">/</span> <span class="va">gdp_sd</span> <span class="op">*</span> <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 8 × 3</span></span>
<span><span class="co">##   country      Estimate.Intercept Estimate.gdpPercap_z</span></span>
<span><span class="co">##   &lt;chr&gt;                     &lt;dbl&gt;                &lt;dbl&gt;</span></span>
<span><span class="co">## 1 Bolivia                  -0.587                1.90 </span></span>
<span><span class="co">## 2 Canada                   11.7                 -1.34 </span></span>
<span><span class="co">## 3 Egypt                     1.85                 1.66 </span></span>
<span><span class="co">## 4 Italy                     8.92                -1.24 </span></span>
<span><span class="co">## 5 Pakistan                  0.895                0.912</span></span>
<span><span class="co">## 6 Portugal                  4.37                -1.09 </span></span>
<span><span class="co">## 7 Sierra Leone             -9.42                 2.07 </span></span>
<span><span class="co">## 8 Yemen, Rep.               9.64                 4.04</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can also look at the already-combined fixed effect + random offset for country-specific intercepts and slopes. The intercept and the slope are different in each country, while the <code>year</code> coefficient is the same, as expected:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">model_gdp_country_only</span><span class="op">)</span><span class="op">$</span><span class="va">country</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">as_tibble</span><span class="op">(</span>rownames <span class="op">=</span> <span class="st">"country"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">country</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">countries</span><span class="op">$</span><span class="va">country</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">country</span>, <span class="fu">starts_with</span><span class="op">(</span><span class="st">"Estimate"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Unscale the GDP offsets</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>Estimate.gdpPercap_z <span class="op">=</span> <span class="va">Estimate.gdpPercap_z</span> <span class="op">/</span> <span class="va">gdp_sd</span> <span class="op">*</span> <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 8 × 4</span></span>
<span><span class="co">##   country      Estimate.Intercept Estimate.gdpPercap_z Estimate.year</span></span>
<span><span class="co">##   &lt;chr&gt;                     &lt;dbl&gt;                &lt;dbl&gt;         &lt;dbl&gt;</span></span>
<span><span class="co">## 1 Bolivia                    56.5               3.07           0.310</span></span>
<span><span class="co">## 2 Canada                     68.8              -0.167          0.310</span></span>
<span><span class="co">## 3 Egypt                      59.0               2.83           0.310</span></span>
<span><span class="co">## 4 Italy                      66.1              -0.0712         0.310</span></span>
<span><span class="co">## 5 Pakistan                   58.0               2.08           0.310</span></span>
<span><span class="co">## 6 Portugal                   61.5               0.0801         0.310</span></span>
<span><span class="co">## 7 Sierra Leone               47.7               3.24           0.310</span></span>
<span><span class="co">## 8 Yemen, Rep.                66.8               5.21           0.310</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="visualize-results" class="level4 page-columns page-full"><h4 class="anchored" data-anchor-id="visualize-results">Visualize results</h4>
<p>We can see the full posterior distributions for these country-specific GDP effects to get a sense of their variation. Looking at regular GDP shows some interesting trends—and reveals some potential issues with the model. In all countries except Canada, Italy, and Portugal, a \$1,000 increase in GDP per capita—holding all other factors constant—is associated with a 2–5 year increase in life expectancy. This difference is “statistically significant” if we want to use that kind of frequentist language—the credible intervals for all these effects are fairly far from 0. Canada, Italy, and Portugal, however, see no practical GDP effect. Their slopes are essentially zero, and they’re precisely estimated around zero (hence those really tall peaks). This could be an artifact of the model—those three countries had already-high levels of income and Stan struggles with extremes like that.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ame_model_gdp_country_only</span> <span class="op">&lt;-</span> <span class="va">model_gdp_country_only</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">emtrends</span><span class="op">(</span><span class="op">~</span> <span class="va">country</span>,</span>
<span>           var <span class="op">=</span> <span class="st">"gdpPercap_z"</span>,</span>
<span>           at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fl">0</span>, country <span class="op">=</span> <span class="va">countries</span><span class="op">$</span><span class="va">country</span><span class="op">)</span>,</span>
<span>           epred <span class="op">=</span> <span class="cn">TRUE</span>, re_formula <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pred_ame_model_gdp_country_only</span> <span class="op">&lt;-</span> <span class="va">ame_model_gdp_country_only</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">gather_emmeans_draws</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>.value <span class="op">=</span> <span class="va">.value</span> <span class="op">/</span> <span class="va">gdp_sd</span> <span class="op">*</span> <span class="fl">1000</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">countries</span>, by <span class="op">=</span> <span class="st">"country"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">pred_ame_model_gdp_country_only</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">.value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">continent</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_okabe_ito</span><span class="op">(</span>order <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">6</span>, <span class="fl">1</span><span class="op">)</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Average marginal effect of GDP per capita"</span>, <span class="st">"\n"</span>,</span>
<span>                      <span class="st">"(intercepts and slope of GDP per capita by country)"</span><span class="op">)</span>, </span>
<span>       subtitle <span class="op">=</span> <span class="st">"lifeExp ~ gdpPercap_z + year + (1 + gdpPercap_z | country)"</span>,</span>
<span>       x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Average marginal effect on life expectancy"</span>, <span class="st">"\n"</span>, </span>
<span>                  <span class="st">"of a $1,000 increase in GDP per capita"</span><span class="op">)</span>, </span>
<span>       y <span class="op">=</span> <span class="st">"Density"</span>,</span>
<span>       caption <span class="op">=</span> <span class="st">"80% and 95% credible intervals shown with error bar"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_nested_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">continent</span>, <span class="va">country</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">2</span>, strip <span class="op">=</span> <span class="va">nested_settings</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_clean</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>plot.subtitle <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Consolas"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/plot-ame-gdp-country-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page-inset-right" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>We get some more normal looking distributions when looking at the effect of logged GDP per capita instead. Canada, Italy, and Portugal are all still apparent null effects, since their credible intervals include zero, while all other countries have positive effects. A 10% increase in GDP per capita is associated with a 0.5ish to 1.2ish year increase in life expectancy, on average.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ame_model_gdp_country_only_log</span> <span class="op">&lt;-</span> <span class="va">model_gdp_country_only_log</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">emtrends</span><span class="op">(</span><span class="op">~</span> <span class="va">country</span>,</span>
<span>           var <span class="op">=</span> <span class="st">"gdpPercap_log_z"</span>,</span>
<span>           at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fl">0</span>, country <span class="op">=</span> <span class="va">countries</span><span class="op">$</span><span class="va">country</span><span class="op">)</span>,</span>
<span>           epred <span class="op">=</span> <span class="cn">TRUE</span>, re_formula <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span><span class="va">ame_model_gdp_country_only_log</span></span>
<span><span class="co">##  country      gdpPercap_log_z.trend lower.HPD upper.HPD</span></span>
<span><span class="co">##  Egypt                        11.37      7.41     15.22</span></span>
<span><span class="co">##  Sierra Leone                  6.42      0.88     12.51</span></span>
<span><span class="co">##  Pakistan                      5.91      1.67      9.82</span></span>
<span><span class="co">##  Yemen, Rep.                  14.33     10.14     18.37</span></span>
<span><span class="co">##  Bolivia                      13.59      5.33     22.11</span></span>
<span><span class="co">##  Canada                       -1.90     -6.58      2.82</span></span>
<span><span class="co">##  Italy                         0.14     -3.38      3.43</span></span>
<span><span class="co">##  Portugal                      2.32     -0.67      5.33</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Point estimate displayed: median </span></span>
<span><span class="co">## HPD interval probability: 0.95</span></span>
<span></span>
<span><span class="va">pred_ame_model_gdp_country_only_log</span> <span class="op">&lt;-</span> <span class="va">ame_model_gdp_country_only_log</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">gather_emmeans_draws</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>.value <span class="op">=</span> <span class="va">.value</span> <span class="op">/</span> <span class="va">gdp_log_sd</span> <span class="op">/</span> <span class="fl">10</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">countries</span>, by <span class="op">=</span> <span class="st">"country"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">pred_ame_model_gdp_country_only_log</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">.value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">continent</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_okabe_ito</span><span class="op">(</span>order <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">6</span>, <span class="fl">1</span><span class="op">)</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Average marginal effect of GDP per capita"</span>, <span class="st">"\n"</span>,</span>
<span>                      <span class="st">"(intercepts and slope of GDP per capita by country)"</span><span class="op">)</span>, </span>
<span>       subtitle <span class="op">=</span> <span class="st">"lifeExp ~ gdpPercap_z + year + (1 + gdpPercap_z | country)"</span>,</span>
<span>       x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Average marginal effect on life expectancy"</span>, <span class="st">"\n"</span>, </span>
<span>                  <span class="st">"of a 10% increase in GDP per capita"</span><span class="op">)</span>, </span>
<span>       y <span class="op">=</span> <span class="st">"Density"</span>,</span>
<span>       caption <span class="op">=</span> <span class="st">"80% and 95% credible intervals shown with error bar"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_nested_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">continent</span>, <span class="va">country</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">2</span>, strip <span class="op">=</span> <span class="va">nested_settings</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_clean</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>plot.subtitle <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Consolas"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/plot-ame-gdp-country-log-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page-inset-right" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section></section><section id="each-country-gets-its-own-intercept-and-gdp-and-year-slopes" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="each-country-gets-its-own-intercept-and-gdp-and-year-slopes">⭐ Each country gets its own intercept and GDP and year slopes ⭐</h3>
<p>While it’s cool that GDP now varies by country, we saw earlier that year-based trends in life expectancy also vary across country. We should probably incorporate country-specific differences for both GDP <em>and</em> year. Once again, multilevel modeling makes this easy—we’ll allow <code>year</code> to vary by country too by adding country-specific offsets to the year slope with a <span class="math inline">\(b_{2, \text{Country}}\)</span> term:</p>
<p><span class="math display">\[
\begin{aligned}
\text{Life expectancy} &amp;= (\beta_0 + b_{0, \text{Country}}) + (\beta_1 + b_{1, \text{Country}}) \text{GDP} + (\beta_2 + b_{2, \text{Country}}) \text{Year} + \epsilon \\
b_{0, \text{Country}} &amp;\sim \mathcal{N}(0, \tau_0) \\
b_{1, \text{Country}} &amp;\sim \mathcal{N}(0, \tau_1) \\
b_{2, \text{Country}} &amp;\sim \mathcal{N}(0, \tau_2)
\end{aligned}
\]</span></p>
<p>The syntax for this random effects term is <code>(1 + gdpPercap_z + year | country)</code>, which lets the intercept (<code>1</code>), GDP per capita, and year vary by country. We’ll use the scaled versions of both regular GDP per capita and logged GDP per capita again, but we’ll see that we run into some serious computational issues now.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/model-gdp-country-year_51992d21507c0a99a972981bd5780396">
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_gdp_country_year</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span></span>
<span>  <span class="fu">bf</span><span class="op">(</span><span class="va">lifeExp</span> <span class="op">~</span> <span class="va">gdpPercap_z</span> <span class="op">+</span> <span class="va">year</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">gdpPercap_z</span> <span class="op">+</span> <span class="va">year</span> <span class="op">|</span> <span class="va">country</span><span class="op">)</span>,</span>
<span>     decomp <span class="op">=</span> <span class="st">"QR"</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">gapminder</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="va">bayes_seed</span>,</span>
<span>  threads <span class="op">=</span> <span class="fu">threading</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>  <span class="co"># Two CPUs per chain to speed things up</span></span>
<span><span class="op">)</span></span>
<span><span class="co">## Start sampling</span></span>
<span><span class="co">## Warning: 47 of 4000 (1.0%) transitions ended with a divergence.</span></span>
<span><span class="co">## See https://mc-stan.org/misc/warnings for details.</span></span>
<span><span class="co">## Warning: 2 of 4000 (0.0%) transitions hit the maximum treedepth limit of 10.</span></span>
<span><span class="co">## See https://mc-stan.org/misc/warnings for details.</span></span>
<span><span class="co">## Warning: 1 of 4 chains had an E-BFMI less than 0.2.</span></span>
<span><span class="co">## See https://mc-stan.org/misc/warnings for details.</span></span>
<span></span>
<span><span class="va">model_gdp_country_year_log</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span></span>
<span>  <span class="fu">bf</span><span class="op">(</span><span class="va">lifeExp</span> <span class="op">~</span> <span class="va">gdpPercap_log_z</span> <span class="op">+</span> <span class="va">year</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">gdpPercap_log_z</span> <span class="op">+</span> <span class="va">year</span> <span class="op">|</span> <span class="va">country</span><span class="op">)</span>,</span>
<span>     decomp <span class="op">=</span> <span class="st">"QR"</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">gapminder</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="va">bayes_seed</span>,</span>
<span>  threads <span class="op">=</span> <span class="fu">threading</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>  <span class="co"># Two CPUs per chain to speed things up</span></span>
<span><span class="op">)</span></span>
<span><span class="co">## Start sampling</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It takes nearly 2.5 times as long to fit the model with <code>gdpPercap_z</code> than it does <code>gdpPercap_log_z</code>, and there are some serious-ish issues with model convergence and effective sample size. Normally, the R-hat values for each parameter are supposed to be as close to 1 as possible, and values above 1.05 are a bad sign that the model didn’t converge. Again, we could try to fix this by using specific priors, using more iterations in the chains, or adjusting some of Stan’s parameters like <code>adapt_delta</code>, but for the sake of this example, we won’t.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Model with regular GDP per capita</span></span>
<span><span class="fu">rstan</span><span class="fu">::</span><span class="fu">get_elapsed_time</span><span class="op">(</span><span class="va">model_gdp_country_year</span><span class="op">$</span><span class="va">fit</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">as_tibble</span><span class="op">(</span>rownames <span class="op">=</span> <span class="st">"chain"</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">mutate</span><span class="op">(</span>total_seconds <span class="op">=</span> <span class="va">warmup</span> <span class="op">+</span> <span class="va">sample</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 4 × 4</span></span>
<span><span class="co">##   chain   warmup sample total_seconds</span></span>
<span><span class="co">##   &lt;chr&gt;    &lt;dbl&gt;  &lt;dbl&gt;         &lt;dbl&gt;</span></span>
<span><span class="co">## 1 chain:1   38.0   16.6          54.6</span></span>
<span><span class="co">## 2 chain:2   39.0   30.8          69.8</span></span>
<span><span class="co">## 3 chain:3   40.1   36.9          76.9</span></span>
<span><span class="co">## 4 chain:4   40.0   32.8          72.8</span></span>
<span></span>
<span><span class="co"># Model with logged GDP per capita </span></span>
<span><span class="fu">rstan</span><span class="fu">::</span><span class="fu">get_elapsed_time</span><span class="op">(</span><span class="va">model_gdp_country_year_log</span><span class="op">$</span><span class="va">fit</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">as_tibble</span><span class="op">(</span>rownames <span class="op">=</span> <span class="st">"chain"</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">mutate</span><span class="op">(</span>total_seconds <span class="op">=</span> <span class="va">warmup</span> <span class="op">+</span> <span class="va">sample</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 4 × 4</span></span>
<span><span class="co">##   chain   warmup sample total_seconds</span></span>
<span><span class="co">##   &lt;chr&gt;    &lt;dbl&gt;  &lt;dbl&gt;         &lt;dbl&gt;</span></span>
<span><span class="co">## 1 chain:1   23.8   17.2          40.9</span></span>
<span><span class="co">## 2 chain:2   23.7   17.1          40.8</span></span>
<span><span class="co">## 3 chain:3   23.5   16.8          40.4</span></span>
<span><span class="co">## 4 chain:4   24.4   16.8          41.2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/diagnostics-models-gdp-country-year_b4661f87ade9939349d215549f837681">
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Bad R-hats and low effective sample sizes</span></span>
<span><span class="fu">bayestestR</span><span class="fu">::</span><span class="fu">diagnostic_posterior</span><span class="op">(</span><span class="va">model_gdp_country_year</span><span class="op">)</span></span>
<span><span class="co">##       Parameter Rhat   ESS     MCSE</span></span>
<span><span class="co">## 1 b_gdpPercap_z 1.02  60.6 0.113683</span></span>
<span><span class="co">## 2   b_Intercept 1.00 346.3 0.053887</span></span>
<span><span class="co">## 3        b_year 1.01 730.0 0.000593</span></span>
<span></span>
<span><span class="co"># Okay R-hats and okay-ish effective sample sizes</span></span>
<span><span class="fu">bayestestR</span><span class="fu">::</span><span class="fu">diagnostic_posterior</span><span class="op">(</span><span class="va">model_gdp_country_year_log</span><span class="op">)</span></span>
<span><span class="co">##           Parameter Rhat  ESS     MCSE</span></span>
<span><span class="co">## 1 b_gdpPercap_log_z 1.00 1695 0.011915</span></span>
<span><span class="co">## 2       b_Intercept 1.01  310 0.052171</span></span>
<span><span class="co">## 3            b_year 1.00  632 0.000726</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="fixed-population-level-effects-5" class="level4"><h4 class="anchored" data-anchor-id="fixed-population-level-effects-5">Fixed (population-level) effects</h4>
<p>The global population-level coefficients are again similar to what we saw in the previous models: holding year trends constant, life expectancy increases by 0.39 years for every \$1,000 increase in wealth and 0.424 years for every 10% increase in wealth, on average.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Unscale both the GDP coefficient and the GDP random variance coefficient</span></span>
<span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_gdp_country_year</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">estimate</span>, <span class="va">std.error</span>, <span class="va">conf.low</span>, <span class="va">conf.high</span><span class="op">)</span>,</span>
<span>                <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">term</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"gdpPercap_z"</span>, <span class="st">"sd__gdpPercap_z"</span><span class="op">)</span>, </span>
<span>                        <span class="op">(</span><span class="va">.</span> <span class="op">/</span> <span class="va">gdp_sd</span><span class="op">)</span> <span class="op">*</span> <span class="fl">1000</span>, <span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 10 × 8</span></span>
<span><span class="co">##    effect   component group    term                  estimate std.error conf.low conf.high</span></span>
<span><span class="co">##    &lt;chr&gt;    &lt;chr&gt;     &lt;chr&gt;    &lt;chr&gt;                    &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">##  1 fixed    cond      &lt;NA&gt;     (Intercept)             52.2      1.00     50.3      54.2  </span></span>
<span><span class="co">##  2 fixed    cond      &lt;NA&gt;     gdpPercap_z              0.391    0.0906    0.264     0.620</span></span>
<span><span class="co">##  3 fixed    cond      &lt;NA&gt;     year                     0.316    0.0160    0.286     0.348</span></span>
<span><span class="co">##  4 ran_pars cond      country  sd__(Intercept)         11.0      0.736     9.75     12.6  </span></span>
<span><span class="co">##  5 ran_pars cond      country  sd__gdpPercap_z          0.497    0.212     0.278     0.954</span></span>
<span><span class="co">##  6 ran_pars cond      country  sd__year                 0.172    0.0127    0.150     0.199</span></span>
<span><span class="co">##  7 ran_pars cond      country  cor__(Intercept).gdp…   -0.366    0.241    -0.677     0.114</span></span>
<span><span class="co">##  8 ran_pars cond      country  cor__(Intercept).year   -0.548    0.0816   -0.703    -0.382</span></span>
<span><span class="co">##  9 ran_pars cond      country  cor__gdpPercap_z.year   -0.430    0.0984   -0.618    -0.234</span></span>
<span><span class="co">## 10 ran_pars cond      Residual sd__Observation          2.12     0.0617    2.00      2.23</span></span>
<span></span>
<span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_gdp_country_year_log</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">estimate</span>, <span class="va">std.error</span>, <span class="va">conf.low</span>, <span class="va">conf.high</span><span class="op">)</span>,</span>
<span>                <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">term</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"gdpPercap_log_z"</span>, <span class="st">"sd__gdpPercap_log_z"</span><span class="op">)</span>, </span>
<span>                        <span class="op">(</span><span class="va">.</span> <span class="op">/</span> <span class="va">gdp_log_sd</span><span class="op">)</span>, <span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 10 × 8</span></span>
<span><span class="co">##    effect   component group    term                  estimate std.error conf.low conf.high</span></span>
<span><span class="co">##    &lt;chr&gt;    &lt;chr&gt;     &lt;chr&gt;    &lt;chr&gt;                    &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">##  1 fixed    cond      &lt;NA&gt;     (Intercept)             52.0      0.919    50.2      53.7  </span></span>
<span><span class="co">##  2 fixed    cond      &lt;NA&gt;     gdpPercap_log_z          4.24     0.397     3.44      5.03 </span></span>
<span><span class="co">##  3 fixed    cond      &lt;NA&gt;     year                     0.259    0.0182    0.224     0.295</span></span>
<span><span class="co">##  4 ran_pars cond      country  sd__(Intercept)         10.4      0.700     9.19     11.9  </span></span>
<span><span class="co">##  5 ran_pars cond      country  sd__gdpPercap_log_z      3.26     0.379     2.55      4.05 </span></span>
<span><span class="co">##  6 ran_pars cond      country  sd__year                 0.202    0.0145    0.175     0.232</span></span>
<span><span class="co">##  7 ran_pars cond      country  cor__(Intercept).gdp…    0.383    0.112     0.150     0.584</span></span>
<span><span class="co">##  8 ran_pars cond      country  cor__(Intercept).year   -0.711    0.0485   -0.796    -0.605</span></span>
<span><span class="co">##  9 ran_pars cond      country  cor__gdpPercap_log_z…   -0.697    0.0660   -0.810    -0.555</span></span>
<span><span class="co">## 10 ran_pars cond      Residual sd__Observation          1.97     0.0391    1.90      2.05</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="country-level-variation-and-random-effects" class="level4"><h4 class="anchored" data-anchor-id="country-level-variation-and-random-effects">Country-level variation and random effects</h4>
<p>We’ll forgo detailed interpretations of all our new random effects values and instead just point out that we have estimates for each of the <span class="math inline">\(\tau\)</span>s: country-based variation in the intercept, the GDP slope, and the year slope. We also have three different correlations now: the correlation between the intercept and the GDP slope, the intercept and the year slope, and the GDP and year slopes. Neat.</p>
<p>If we look at the country-level coefficients, we can see that the intercepts, GDP slopes, and year slopes all vary by different amounts across countries, as intended:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">model_gdp_country_year</span><span class="op">)</span><span class="op">$</span><span class="va">country</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">as_tibble</span><span class="op">(</span>rownames <span class="op">=</span> <span class="st">"country"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">country</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">countries</span><span class="op">$</span><span class="va">country</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">country</span>, <span class="fu">starts_with</span><span class="op">(</span><span class="st">"Estimate"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Unscale the GDP offsets</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>Estimate.gdpPercap_z <span class="op">=</span> <span class="va">Estimate.gdpPercap_z</span> <span class="op">/</span> <span class="va">gdp_sd</span> <span class="op">*</span> <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 8 × 4</span></span>
<span><span class="co">##   country      Estimate.Intercept Estimate.gdpPercap_z Estimate.year</span></span>
<span><span class="co">##   &lt;chr&gt;                     &lt;dbl&gt;                &lt;dbl&gt;         &lt;dbl&gt;</span></span>
<span><span class="co">## 1 Bolivia                    40.7               0.375          0.485</span></span>
<span><span class="co">## 2 Canada                     68.5               0.0646         0.193</span></span>
<span><span class="co">## 3 Egypt                      42.9               0.272          0.525</span></span>
<span><span class="co">## 4 Italy                      66.6               0.0311         0.255</span></span>
<span><span class="co">## 5 Pakistan                   46.7               0.441          0.386</span></span>
<span><span class="co">## 6 Portugal                   61.3               0.0353         0.324</span></span>
<span><span class="co">## 7 Sierra Leone               38.0               1.23           0.224</span></span>
<span><span class="co">## 8 Yemen, Rep.                33.6               0.489          0.577</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="visualize-results-1" class="level4 page-columns page-full"><h4 class="anchored" data-anchor-id="visualize-results-1">Visualize results</h4>
<p>As usual, we can visualize the distribution of these country-specific GDP effects. If we look at regular GDP, we can immediately see some weirdness—a few of these distributions like Sierra Leone and Bolivia aren’t very smooth, likely because we didn’t specify good priors and because the model didn’t fully converge. These things look goofy and we shouldn’t put too much stock in them. Canada, Italy, and Portugal all seem to have null effects, along with Egypt now for whatever reason. But again, these are strange and the model isn’t that great, so we can stop looking at this. Scroll down.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ame_model_gdp_country_year</span> <span class="op">&lt;-</span> <span class="va">model_gdp_country_year</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">emtrends</span><span class="op">(</span><span class="op">~</span> <span class="va">year</span> <span class="op">+</span> <span class="va">country</span>,</span>
<span>           var <span class="op">=</span> <span class="st">"gdpPercap_z"</span>,</span>
<span>           at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fl">0</span>, country <span class="op">=</span> <span class="va">countries</span><span class="op">$</span><span class="va">country</span><span class="op">)</span>,</span>
<span>           epred <span class="op">=</span> <span class="cn">TRUE</span>, re_formula <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pred_ame_model_gdp_country_year</span> <span class="op">&lt;-</span> <span class="va">ame_model_gdp_country_year</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">gather_emmeans_draws</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>.value <span class="op">=</span> <span class="va">.value</span> <span class="op">/</span> <span class="va">gdp_sd</span> <span class="op">*</span> <span class="fl">1000</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">countries</span>, by <span class="op">=</span> <span class="st">"country"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">pred_ame_model_gdp_country_year</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">.value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">continent</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_okabe_ito</span><span class="op">(</span>order <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">6</span>, <span class="fl">1</span><span class="op">)</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Average marginal effect of GDP per capita"</span>, <span class="st">"\n"</span>,</span>
<span>                      <span class="st">"(intercepts and slopes of both GDP per capita and year vary by country)"</span><span class="op">)</span>, </span>
<span>       subtitle <span class="op">=</span> <span class="st">"lifeExp ~ gdpPercap_log_z + year + (1 + gdpPercap_z + year | country)"</span>,</span>
<span>       x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Average marginal effect on life expectancy"</span>, <span class="st">"\n"</span>, </span>
<span>                  <span class="st">"of a $1,000 increase in GDP per capita"</span><span class="op">)</span>, </span>
<span>       y <span class="op">=</span> <span class="st">"Density"</span>,</span>
<span>       caption <span class="op">=</span> <span class="st">"80% and 95% credible intervals shown with error bar"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_nested_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">continent</span>, <span class="va">country</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">2</span>, strip <span class="op">=</span> <span class="va">nested_settings</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_clean</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>plot.subtitle <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Consolas"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/plot-ame-gdp-country-year-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page-inset-right" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>The average marginal effects for logged GDP per capita look a lot smoother (and the model actually converged), so I trust these results more. After accounting for country- and year-specific differences, Canada, Italy, and Portugal all have positive GDP per capita slopes: a 10% increase in GDP per capita is associated with a 0.5ish year increase in life expectancy. We see a slightly smaller effect in Sierra Leone, and even smaller (and less “significant”) effects everywhere else.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ame_model_gdp_country_year_log</span> <span class="op">&lt;-</span> <span class="va">model_gdp_country_year_log</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">emtrends</span><span class="op">(</span><span class="op">~</span> <span class="va">year</span> <span class="op">+</span> <span class="va">country</span>,</span>
<span>           var <span class="op">=</span> <span class="st">"gdpPercap_log_z"</span>,</span>
<span>           at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fl">0</span>, country <span class="op">=</span> <span class="va">countries</span><span class="op">$</span><span class="va">country</span><span class="op">)</span>,</span>
<span>           epred <span class="op">=</span> <span class="cn">TRUE</span>, re_formula <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pred_ame_model_gdp_country_year_log</span> <span class="op">&lt;-</span> <span class="va">ame_model_gdp_country_year_log</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">gather_emmeans_draws</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>.value <span class="op">=</span> <span class="va">.value</span> <span class="op">/</span> <span class="va">gdp_log_sd</span> <span class="op">/</span> <span class="fl">10</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">countries</span>, by <span class="op">=</span> <span class="st">"country"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">pred_ame_model_gdp_country_year_log</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">.value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">continent</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_okabe_ito</span><span class="op">(</span>order <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">6</span>, <span class="fl">1</span><span class="op">)</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Average marginal effect of GDP per capita"</span>, <span class="st">"\n"</span>,</span>
<span>                      <span class="st">"(intercepts and slopes of both GDP per capita and year vary by country)"</span><span class="op">)</span>, </span>
<span>       subtitle <span class="op">=</span> <span class="st">"lifeExp ~ gdpPercap_log_z + year + (1 + gdpPercap_log_z + year | country)"</span>,</span>
<span>       x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Average marginal effect on life expectancy"</span>, <span class="st">"\n"</span>, </span>
<span>                  <span class="st">"of a 10% increase in GDP per capita"</span><span class="op">)</span>, </span>
<span>       y <span class="op">=</span> <span class="st">"Density"</span>,</span>
<span>       caption <span class="op">=</span> <span class="st">"80% and 95% credible intervals shown with error bar"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_nested_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">continent</span>, <span class="va">country</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">2</span>, strip <span class="op">=</span> <span class="va">nested_settings</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_clean</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>plot.subtitle <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Consolas"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/plot-ame-gdp-country-year-log-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page-inset-right" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section><section id="visualize-more-generic-average-marginal-effects" class="level4"><h4 class="anchored" data-anchor-id="visualize-more-generic-average-marginal-effects">Visualize more generic average marginal effects</h4>
<p>It’s really really neat that we can look at the specific effect of GDP on life expectancy in every country individually, but often we just want report a single number—what is the average effect of health on wealth? We don’t want to report 140 separate GDP effects! We just want one!</p>
<p>We can consolidate these country-specific effects into a single value a couple different ways:</p>
<ol type="1">
<li>Report a global grand mean, or the average predicted outcome ignoring country-specific deviations</li>
<li>Report the average predicted outcome for a hypothetical new country</li>
</ol>
<p>There are a ton of details about these different approaches for finding average marginal effects <a href="https://www.andrewheiss.com/blog/2021/11/10/ame-bayes-re-guide/">at this post here</a>—go there to learn all about the nuances of doing this.</p>
<p>Here we’ll do it both ways: calculate a global grand mean and simulate a fake new country (we’ll call it Atlantis).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Calculate the overall global effect</span></span>
<span><span class="co"># `re_formula = NA` means that no random effects will be incorporated</span></span>
<span><span class="va">ame_global_gdp_country_year</span> <span class="op">&lt;-</span> <span class="va">model_gdp_country_year_log</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">emtrends</span><span class="op">(</span><span class="op">~</span> <span class="fl">1</span>,</span>
<span>           var <span class="op">=</span> <span class="st">"gdpPercap_log_z"</span>,</span>
<span>           epred <span class="op">=</span> <span class="cn">TRUE</span>, re_formula <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span><span class="va">ame_global_gdp_country_year</span></span>
<span><span class="co">##  1       gdpPercap_log_z.trend lower.HPD upper.HPD</span></span>
<span><span class="co">##  overall                  5.25      4.28      6.23</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Point estimate displayed: median </span></span>
<span><span class="co">## HPD interval probability: 0.95</span></span>
<span></span>
<span><span class="co"># Get the posterior distribution of this global effect and make a plot</span></span>
<span><span class="va">pred_global_gdp_country_year</span> <span class="op">&lt;-</span> <span class="va">ame_global_gdp_country_year</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">gather_emmeans_draws</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>.value <span class="op">=</span> <span class="op">(</span><span class="va">.value</span> <span class="op">/</span> <span class="va">gdp_log_sd</span><span class="op">)</span> <span class="op">/</span> <span class="fl">10</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>fake_facet_title <span class="op">=</span> <span class="st">"Global grand mean"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_global_gdp_country_year</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">pred_global_gdp_country_year</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">.value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span>fill <span class="op">=</span> <span class="fu">palette_okabe_ito</span><span class="op">(</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Average marginal effect on life expectancy"</span>, <span class="st">"\n"</span>, </span>
<span>                  <span class="st">"of a 10% increase in GDP per capita"</span><span class="op">)</span>, </span>
<span>       y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">fake_facet_title</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_clean</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>strip.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fu">rel</span><span class="op">(</span><span class="fl">1.1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate the effect for Atlantis</span></span>
<span><span class="co"># `re_formula = NULL` means the full random effects structure will be</span></span>
<span><span class="co"># incorporated. `allow_new_levels` lets R deal with a new country, and</span></span>
<span><span class="co"># `sample_new_levels = "gaussian"` means that the characteristics for this new</span></span>
<span><span class="co"># country will be based on random draws from the model</span></span>
<span><span class="va">ame_hypo_gdp_country_year</span> <span class="op">&lt;-</span> <span class="va">model_gdp_country_year_log</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">emtrends</span><span class="op">(</span><span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">country</span>,</span>
<span>           var <span class="op">=</span> <span class="st">"gdpPercap_log_z"</span>,</span>
<span>           at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>country <span class="op">=</span> <span class="st">"Atlantis"</span><span class="op">)</span>,</span>
<span>           epred <span class="op">=</span> <span class="cn">TRUE</span>, re_formula <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>           allow_new_levels <span class="op">=</span> <span class="cn">TRUE</span>, sample_new_levels <span class="op">=</span> <span class="st">"gaussian"</span><span class="op">)</span></span>
<span><span class="va">ame_hypo_gdp_country_year</span></span>
<span><span class="co">##  country  gdpPercap_log_z.trend lower.HPD upper.HPD</span></span>
<span><span class="co">##  Atlantis                  5.19     -2.77      13.1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Point estimate displayed: median </span></span>
<span><span class="co">## HPD interval probability: 0.95</span></span>
<span></span>
<span><span class="co"># Get the posterior distribution of this Atlantis effect and make a plot</span></span>
<span><span class="va">pred_hypo_gdp_country_year</span> <span class="op">&lt;-</span> <span class="va">ame_hypo_gdp_country_year</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">gather_emmeans_draws</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>.value <span class="op">=</span> <span class="op">(</span><span class="va">.value</span> <span class="op">/</span> <span class="va">gdp_log_sd</span><span class="op">)</span> <span class="op">/</span> <span class="fl">10</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>fake_facet_title <span class="op">=</span> <span class="st">"AME for hypothetical Atlantis"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_hypo_gdp_country_year</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">pred_hypo_gdp_country_year</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">.value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span>fill <span class="op">=</span> <span class="fu">palette_okabe_ito</span><span class="op">(</span><span class="fl">7</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Average marginal effect on life expectancy"</span>, <span class="st">"\n"</span>, </span>
<span>                  <span class="st">"of a 10% increase in GDP per capita"</span><span class="op">)</span>, </span>
<span>       y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">fake_facet_title</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_clean</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>strip.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fu">rel</span><span class="op">(</span><span class="fl">1.1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Show the two AME distributions side-by-side</span></span>
<span><span class="op">(</span><span class="va">plot_global_gdp_country_year</span> <span class="op">|</span> <span class="va">plot_hypo_gdp_country_year</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">plot_annotation</span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Average marginal effect of GDP per capita"</span>, <span class="st">"\n"</span>,</span>
<span>                                 <span class="st">"(intercepts and slopes of both GDP per capita and year vary by country)"</span><span class="op">)</span>, </span>
<span>                  subtitle <span class="op">=</span> <span class="st">"lifeExp ~ gdpPercap_log_z + year + (1 + gdpPercap_log_z + year | country)"</span>,</span>
<span>                  caption <span class="op">=</span> <span class="st">"80% and 95% credible intervals shown with error bar"</span>,</span>
<span>                  theme <span class="op">=</span> <span class="fu">theme_clean</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme</span><span class="op">(</span>plot.subtitle <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Consolas"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-global-hypothetical-country-year-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
</section></section><section id="each-country-gets-its-own-intercept-and-gdp-and-year-slopes-and-year-specific-offsets-in-the-gdp-slope" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="each-country-gets-its-own-intercept-and-gdp-and-year-slopes-and-year-specific-offsets-in-the-gdp-slope">Each country gets its own intercept and GDP and year slopes <em>and</em> year-specific offsets in the GDP slope</h3>
<p>This <code>lifeExp ~ gdpPercap_z + year + (1 + gdpPercap_z + year | country)</code> approach is typically sufficient for models based on panel data, but like we did earlier, we can be extra fancy and include random effects for year-specific differences in the GDP per capita effect that are independent of country-specific differences. These typically represent time-specific global shocks, like recessions or pandemics.</p>
<p>To do this, we’ll add independent year-based offsets to the intercept term (<span class="math inline">\(b_{0, \text{Year}}\)</span>) and to the GDP effect:</p>
<p><span class="math display">\[
\begin{aligned}
\text{Life expectancy} &amp;= (\beta_0 + b_{0, \text{Country}} + b_{0, \text{Year}}) + (\beta_1 + b_{1, \text{Country}} + b_{1, \text{Year}}) \text{GDP} + \\
&amp;= (\beta_2 + b_{2, \text{Country}}) \text{Year} + \epsilon \\
b_{0, \text{Country}} &amp;\sim \mathcal{N}(0, \tau_{0, \text{Country}}) \\
b_{1, \text{Country}} &amp;\sim \mathcal{N}(0, \tau_{1, \text{Country}}) \\
b_{2, \text{Country}} &amp;\sim \mathcal{N}(0, \tau_{2, \text{Country}}) \\
b_{0, \text{Year}} &amp;\sim \mathcal{N}(0, \tau_{0, \text{Year}}) \\
b_{1, \text{Year}} &amp;\sim \mathcal{N}(0, \tau_{1, \text{Country}})
\end{aligned}
\]</span></p>
<p>There are so many moving parts here!</p>
<p>In code, we add two random effects terms: <code>(1 + gdpPercap_log_z | year) + (1 + gdpPercap_log_z + year | country)</code>. The intercept and the GDP effect get their own year-specific offsets, and the intercept, GDP effect, and year effect get their own country-specific offsets.</p>
<p>We won’t even try to use the regular GDP per capita measure—Stan will choke unless we do some fine tuning. We’ll just look at logged GDP per capita.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/model-gdp-country-year-year_d224d5eea7578a6e9b9871854b3fe438">
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_gdp_country_year_year</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span></span>
<span>  <span class="fu">bf</span><span class="op">(</span><span class="va">lifeExp</span> <span class="op">~</span> <span class="va">gdpPercap_log_z</span> <span class="op">+</span> <span class="va">year</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">gdpPercap_log_z</span> <span class="op">|</span> <span class="va">year</span><span class="op">)</span> <span class="op">+</span> </span>
<span>       <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">gdpPercap_log_z</span> <span class="op">+</span> <span class="va">year</span> <span class="op">|</span> <span class="va">country</span><span class="op">)</span>,</span>
<span>     decomp <span class="op">=</span> <span class="st">"QR"</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">gapminder</span>,</span>
<span>  cores <span class="op">=</span> <span class="fl">4</span>, chains <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="va">bayes_seed</span>,</span>
<span>  threads <span class="op">=</span> <span class="fu">threading</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>  <span class="co"># Two CPUs per chain to speed things up</span></span>
<span><span class="op">)</span></span>
<span><span class="co">## Start sampling</span></span>
<span><span class="co">## Warning: 994 of 4000 (25.0%) transitions hit the maximum treedepth limit of 10.</span></span>
<span><span class="co">## See https://mc-stan.org/misc/warnings for details.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">rstan</span><span class="fu">::</span><span class="fu">get_elapsed_time</span><span class="op">(</span><span class="va">model_gdp_country_year_year</span><span class="op">$</span><span class="va">fit</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">as_tibble</span><span class="op">(</span>rownames <span class="op">=</span> <span class="st">"chain"</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">mutate</span><span class="op">(</span>total_seconds <span class="op">=</span> <span class="va">warmup</span> <span class="op">+</span> <span class="va">sample</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 4 × 4</span></span>
<span><span class="co">##   chain   warmup sample total_seconds</span></span>
<span><span class="co">##   &lt;chr&gt;    &lt;dbl&gt;  &lt;dbl&gt;         &lt;dbl&gt;</span></span>
<span><span class="co">## 1 chain:1   37.7   22.0          59.7</span></span>
<span><span class="co">## 2 chain:2   37.3   23.7          61.0</span></span>
<span><span class="co">## 3 chain:3   95.5  144.          239. </span></span>
<span><span class="co">## 4 chain:4   38.7   22.1          60.8</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="fixed-population-level-effects-6" class="level4"><h4 class="anchored" data-anchor-id="fixed-population-level-effects-6">Fixed (population-level) effects</h4>
<p>The global population-level coefficients are again similar to what we saw in the previous models: holding year trends constant, life expectancy increases by 0.333 years for every 10% increase in wealth, on average.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Unscale both the GDP coefficient and the GDP random variance coefficient</span></span>
<span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_gdp_country_year_year</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">estimate</span>, <span class="va">std.error</span>, <span class="va">conf.low</span>, <span class="va">conf.high</span><span class="op">)</span>,</span>
<span>                <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">term</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"gdpPercap_log_z"</span>, <span class="st">"sd__gdpPercap_log_z"</span><span class="op">)</span>, </span>
<span>                        <span class="op">(</span><span class="va">.</span> <span class="op">/</span> <span class="va">gdp_log_sd</span><span class="op">)</span>, <span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 13 × 8</span></span>
<span><span class="co">##    effect   component group    term                  estimate std.error conf.low conf.high</span></span>
<span><span class="co">##    &lt;chr&gt;    &lt;chr&gt;     &lt;chr&gt;    &lt;chr&gt;                    &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">##  1 fixed    cond      &lt;NA&gt;     (Intercept)             52.5      1.11    50.3       54.7  </span></span>
<span><span class="co">##  2 fixed    cond      &lt;NA&gt;     gdpPercap_log_z          3.33     0.416    2.49       4.15 </span></span>
<span><span class="co">##  3 fixed    cond      &lt;NA&gt;     year                     0.258    0.0250   0.210      0.306</span></span>
<span><span class="co">##  4 ran_pars cond      country  sd__(Intercept)         10.6      0.729    9.29      12.1  </span></span>
<span><span class="co">##  5 ran_pars cond      country  sd__gdpPercap_log_z      2.81     0.354    2.16       3.54 </span></span>
<span><span class="co">##  6 ran_pars cond      country  sd__year                 0.192    0.0135   0.168      0.220</span></span>
<span><span class="co">##  7 ran_pars cond      year     sd__(Intercept)          0.947    0.254    0.597      1.59 </span></span>
<span><span class="co">##  8 ran_pars cond      year     sd__gdpPercap_log_z      0.263    0.0976   0.120      0.503</span></span>
<span><span class="co">##  9 ran_pars cond      country  cor__(Intercept).gdp…    0.283    0.130    0.0158     0.521</span></span>
<span><span class="co">## 10 ran_pars cond      country  cor__(Intercept).year   -0.647    0.0569  -0.748     -0.528</span></span>
<span><span class="co">## 11 ran_pars cond      country  cor__gdpPercap_log_z…   -0.681    0.0713  -0.804     -0.528</span></span>
<span><span class="co">## 12 ran_pars cond      year     cor__(Intercept).gdp…   -0.819    0.177   -0.993     -0.338</span></span>
<span><span class="co">## 13 ran_pars cond      Residual sd__Observation          1.80     0.0371   1.72       1.87</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="country-level-variation-and-random-effects-1" class="level4"><h4 class="anchored" data-anchor-id="country-level-variation-and-random-effects-1">Country-level variation and random effects</h4>
<p>We’ll again forgo detailed interpretations of all our new random effects values. Just note that there are five different <span class="math inline">\(\tau\)</span> values, as expected, and four different correlations.</p>
<p>If we look at the country-level coefficients, we can see that the intercepts, GDP slopes, and year slopes all vary by different amounts across countries:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">model_gdp_country_year</span><span class="op">)</span><span class="op">$</span><span class="va">country</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">as_tibble</span><span class="op">(</span>rownames <span class="op">=</span> <span class="st">"country"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">country</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">countries</span><span class="op">$</span><span class="va">country</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">country</span>, <span class="fu">starts_with</span><span class="op">(</span><span class="st">"Estimate"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Unscale the GDP offsets</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>Estimate.gdpPercap_z <span class="op">=</span> <span class="va">Estimate.gdpPercap_z</span> <span class="op">/</span> <span class="va">gdp_sd</span> <span class="op">*</span> <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 8 × 4</span></span>
<span><span class="co">##   country      Estimate.Intercept Estimate.gdpPercap_z Estimate.year</span></span>
<span><span class="co">##   &lt;chr&gt;                     &lt;dbl&gt;                &lt;dbl&gt;         &lt;dbl&gt;</span></span>
<span><span class="co">## 1 Bolivia                    40.7               0.375          0.485</span></span>
<span><span class="co">## 2 Canada                     68.5               0.0646         0.193</span></span>
<span><span class="co">## 3 Egypt                      42.9               0.272          0.525</span></span>
<span><span class="co">## 4 Italy                      66.6               0.0311         0.255</span></span>
<span><span class="co">## 5 Pakistan                   46.7               0.441          0.386</span></span>
<span><span class="co">## 6 Portugal                   61.3               0.0353         0.324</span></span>
<span><span class="co">## 7 Sierra Leone               38.0               1.23           0.224</span></span>
<span><span class="co">## 8 Yemen, Rep.                33.6               0.489          0.577</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Even better, though, is that the GDP slope changes each year too! That’s what we get for including the <code>(1 + gdpPercap_log_z | year)</code> term. The country-specific GDP slopes shift over time now:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Different slopes in each year!</span></span>
<span><span class="va">model_gdp_country_year_year</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">emtrends</span><span class="op">(</span><span class="op">~</span> <span class="va">year</span> <span class="op">+</span> <span class="va">country</span>,</span>
<span>           var <span class="op">=</span> <span class="st">"gdpPercap_log_z"</span>,</span>
<span>           at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">5</span><span class="op">)</span>, country <span class="op">=</span> <span class="va">countries</span><span class="op">$</span><span class="va">country</span><span class="op">)</span>,</span>
<span>           epred <span class="op">=</span> <span class="cn">TRUE</span>, re_formula <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span><span class="co">##  year country      gdpPercap_log_z.trend lower.HPD upper.HPD</span></span>
<span><span class="co">##     0 Egypt                         1.09     -5.11      6.61</span></span>
<span><span class="co">##     5 Egypt                         0.93     -5.44      6.27</span></span>
<span><span class="co">##     0 Sierra Leone                  4.60      0.99      7.77</span></span>
<span><span class="co">##     5 Sierra Leone                  4.46      0.92      7.70</span></span>
<span><span class="co">##     0 Pakistan                      3.84     -1.34      9.62</span></span>
<span><span class="co">##     5 Pakistan                      3.70     -1.65      9.36</span></span>
<span><span class="co">##     0 Yemen, Rep.                   2.35     -2.17      7.07</span></span>
<span><span class="co">##     5 Yemen, Rep.                   2.20     -2.28      7.00</span></span>
<span><span class="co">##     0 Bolivia                       1.95     -3.06      6.40</span></span>
<span><span class="co">##     5 Bolivia                       1.82     -3.02      6.45</span></span>
<span><span class="co">##     0 Canada                        5.77      0.28     11.70</span></span>
<span><span class="co">##     5 Canada                        5.63      0.30     11.69</span></span>
<span><span class="co">##     0 Italy                         4.82     -1.08     10.20</span></span>
<span><span class="co">##     5 Italy                         4.69     -1.20     10.12</span></span>
<span><span class="co">##     0 Portugal                      5.26     -0.04     10.60</span></span>
<span><span class="co">##     5 Portugal                      5.15     -0.42     10.23</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Point estimate displayed: median </span></span>
<span><span class="co">## HPD interval probability: 0.95</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="visualize-results-2" class="level4 page-columns page-full"><h4 class="anchored" data-anchor-id="visualize-results-2">Visualize results</h4>
<p>We can see this time-based change by making a slightly fancier version of our country-specific average marginal effect plot. We’ll show the posterior distribution for each year within each country using ridgeplots. We’ll also shade the credible intervals here using the neat <code>fill_ramp</code> aesthetic instead of showing a point and line, since it would get too visually busy otherwise.</p>
<p>This looks so cool! In some countries like Egypt and Canada, the GDP effect is fairly constant over time. In others, like Sierra Leone, you can see the GDP effect shrink slightly in the 1980s and 1990s, and then increase again after that.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb75"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ame_model_gdp_country_year_year</span> <span class="op">&lt;-</span> <span class="va">model_gdp_country_year_year</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">emtrends</span><span class="op">(</span><span class="op">~</span> <span class="va">year</span> <span class="op">+</span> <span class="va">country</span>,</span>
<span>           var <span class="op">=</span> <span class="st">"gdpPercap_log_z"</span>,</span>
<span>           at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">55</span>, by <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>, country <span class="op">=</span> <span class="va">countries</span><span class="op">$</span><span class="va">country</span><span class="op">)</span>,</span>
<span>           epred <span class="op">=</span> <span class="cn">TRUE</span>, re_formula <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pred_model_gdp_country_year_year</span> <span class="op">&lt;-</span> <span class="va">ame_model_gdp_country_year_year</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">gather_emmeans_draws</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>.value <span class="op">=</span> <span class="op">(</span><span class="va">.value</span> <span class="op">/</span> <span class="va">gdp_log_sd</span><span class="op">)</span> <span class="op">/</span> <span class="fl">10</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>year <span class="op">=</span> <span class="va">year</span> <span class="op">+</span> <span class="fl">1952</span>,</span>
<span>         year <span class="op">=</span> <span class="fu">fct_inorder</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">countries</span>, by <span class="op">=</span> <span class="st">"country"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">pred_model_gdp_country_year_year</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">.value</span>, fill <span class="op">=</span> <span class="va">year</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_slab</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="fu">fct_rev</span><span class="op">(</span><span class="va">year</span><span class="op">)</span>, fill <span class="op">=</span> <span class="va">year</span>,</span>
<span>                fill_ramp <span class="op">=</span> <span class="fu">after_stat</span><span class="op">(</span><span class="fu">cut_cdf_qi</span><span class="op">(</span><span class="va">cdf</span>, .width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.02</span>, <span class="fl">0.8</span>, <span class="fl">0.95</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            height <span class="op">=</span> <span class="fl">2</span>, color <span class="op">=</span> <span class="st">"white"</span>, slab_size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_d</span><span class="op">(</span>option <span class="op">=</span> <span class="st">"rocket"</span>, guide <span class="op">=</span> <span class="st">"none"</span>, end <span class="op">=</span> <span class="fl">0.9</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_ramp_discrete</span><span class="op">(</span>range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.2</span><span class="op">)</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Average marginal effect of GDP per capita"</span>, <span class="st">"\n"</span>,</span>
<span>                      <span class="st">"(intercepts and slopes of both GDP per capita and year "</span>,</span>
<span>                      <span class="st">"vary by country + intercepts vary by year)"</span><span class="op">)</span>, </span>
<span>       subtitle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"lifeExp ~ gdpPercap_log_z + year + "</span>, </span>
<span>                         <span class="st">"(1 + gdpPercap_log_z | year) + "</span>, </span>
<span>                         <span class="st">"(1 + gdpPercap_log_z + year | country)"</span><span class="op">)</span>,</span>
<span>       x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Average marginal effect on life expectancy"</span>, <span class="st">"\n"</span>, </span>
<span>                  <span class="st">"of a 10% increase in GDP per capita"</span><span class="op">)</span>, </span>
<span>       y <span class="op">=</span> <span class="st">"Year"</span>,</span>
<span>       caption <span class="op">=</span> <span class="st">"80% and 95% credible intervals shown with shading"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_nested_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">continent</span>, <span class="va">country</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">2</span>, strip <span class="op">=</span> <span class="va">nested_settings</span>,</span>
<span>                    scales <span class="op">=</span> <span class="st">"free_x"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_clean</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>panel.grid.major.y <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>        plot.subtitle <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Consolas"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/plot-ame-gdp-country-year-year-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page-inset-right" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section><section id="visualize-more-generic-average-marginal-effects-1" class="level4 page-columns page-full"><h4 class="anchored" data-anchor-id="visualize-more-generic-average-marginal-effects-1">Visualize more generic average marginal effects</h4>
<p>Finally we can calculate some aggregate average marginal effects to talk about the general effect of wealth on health. We’ll (1) find the global grand mean, (2) calculate the average effect in our fake Atlantis country in a fake 2020 year, and (2) calculate the average effect in Atlantis over time.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb76"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Calculate the overall global effect</span></span>
<span><span class="co"># `re_formula = NA` means that no random effects will be incorporated</span></span>
<span><span class="va">ame_global_gdp_country_year_year</span> <span class="op">&lt;-</span> <span class="va">model_gdp_country_year_year</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">emtrends</span><span class="op">(</span><span class="op">~</span> <span class="fl">1</span>,</span>
<span>           var <span class="op">=</span> <span class="st">"gdpPercap_log_z"</span>,</span>
<span>           epred <span class="op">=</span> <span class="cn">TRUE</span>, re_formula <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get the posterior distribution of this global effect and make a plot</span></span>
<span><span class="va">pred_global_gdp_country_year_year</span> <span class="op">&lt;-</span> <span class="va">ame_global_gdp_country_year_year</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">gather_emmeans_draws</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>.value <span class="op">=</span> <span class="op">(</span><span class="va">.value</span> <span class="op">/</span> <span class="va">gdp_log_sd</span><span class="op">)</span> <span class="op">/</span> <span class="fl">10</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>fake_facet_title <span class="op">=</span> <span class="st">"Global grand mean"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_global_gdp_country_year_year</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">pred_global_gdp_country_year_year</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">.value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_slab</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill_ramp <span class="op">=</span> <span class="fu">after_stat</span><span class="op">(</span><span class="fu">cut_cdf_qi</span><span class="op">(</span><span class="va">cdf</span>, .width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.02</span>, <span class="fl">0.8</span>, <span class="fl">0.95</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            fill <span class="op">=</span> <span class="fu">palette_okabe_ito</span><span class="op">(</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_d</span><span class="op">(</span>option <span class="op">=</span> <span class="st">"plasma"</span>, guide <span class="op">=</span> <span class="st">"none"</span>, begin <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_ramp_discrete</span><span class="op">(</span>range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.2</span><span class="op">)</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Average marginal effect on life expectancy"</span>, <span class="st">"\n"</span>, </span>
<span>                  <span class="st">"of a 10% increase in GDP per capita"</span><span class="op">)</span>, </span>
<span>       y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">fake_facet_title</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_clean</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>panel.grid.major.y <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>        strip.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fu">rel</span><span class="op">(</span><span class="fl">1.1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate the effect for Atlantis in 2020</span></span>
<span><span class="co"># `re_formula = NULL` means the full random effects structure will be</span></span>
<span><span class="co"># incorporated. `allow_new_levels` lets R deal with a new country, and</span></span>
<span><span class="co"># `sample_new_levels = "gaussian"` means that the characteristics for this new</span></span>
<span><span class="co"># country will be based on random draws from the model</span></span>
<span><span class="va">ame_hypo1_gdp_country_year_year</span> <span class="op">&lt;-</span> <span class="va">model_gdp_country_year_year</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">emtrends</span><span class="op">(</span><span class="op">~</span> <span class="va">country</span> <span class="op">+</span> <span class="va">year</span>,</span>
<span>           var <span class="op">=</span> <span class="st">"gdpPercap_log_z"</span>,</span>
<span>           at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>year <span class="op">=</span> <span class="op">(</span><span class="fl">2020</span> <span class="op">-</span> <span class="fl">1952</span><span class="op">)</span>, country <span class="op">=</span> <span class="st">"Atlantis"</span><span class="op">)</span>,</span>
<span>           epred <span class="op">=</span> <span class="cn">TRUE</span>, re_formula <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>           allow_new_levels <span class="op">=</span> <span class="cn">TRUE</span>, sample_new_levels <span class="op">=</span> <span class="st">"gaussian"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Atlantis median 2020 effect</span></span>
<span><span class="va">ame_hypo1_gdp_country_year_year</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">gather_emmeans_draws</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>.value <span class="op">=</span> <span class="op">(</span><span class="va">.value</span> <span class="op">/</span> <span class="va">gdp_log_sd</span><span class="op">)</span> <span class="op">/</span> <span class="fl">10</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">median_hdci</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 1 × 8</span></span>
<span><span class="co">##   country   year .value .lower .upper .width .point .interval</span></span>
<span><span class="co">##   &lt;fct&gt;    &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span><span class="co">## 1 Atlantis    68  0.330 -0.231  0.905   0.95 median hdci</span></span>
<span></span>
<span><span class="co"># Get the posterior distribution of this Atlantis effect and make a plot</span></span>
<span><span class="va">pred_hypo1_gdp_country_year_year</span> <span class="op">&lt;-</span> <span class="va">ame_hypo1_gdp_country_year_year</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">gather_emmeans_draws</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>.value <span class="op">=</span> <span class="op">(</span><span class="va">.value</span> <span class="op">/</span> <span class="va">gdp_log_sd</span><span class="op">)</span> <span class="op">/</span> <span class="fl">10</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>fake_facet_title <span class="op">=</span> <span class="st">"AME for hypothetical Atlantis in 2020"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_hypo1_gdp_country_year_year</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">pred_hypo1_gdp_country_year_year</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">.value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_slab</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill_ramp <span class="op">=</span> <span class="fu">after_stat</span><span class="op">(</span><span class="fu">cut_cdf_qi</span><span class="op">(</span><span class="va">cdf</span>, .width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.02</span>, <span class="fl">0.8</span>, <span class="fl">0.95</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            fill <span class="op">=</span> <span class="fu">palette_okabe_ito</span><span class="op">(</span><span class="fl">7</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_ramp_discrete</span><span class="op">(</span>range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.2</span><span class="op">)</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Average marginal effect on life expectancy"</span>, <span class="st">"\n"</span>, </span>
<span>                  <span class="st">"of a 10% increase in GDP per capita"</span><span class="op">)</span>, </span>
<span>       y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">fake_facet_title</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_clean</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>panel.grid.major.y <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>        strip.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fu">rel</span><span class="op">(</span><span class="fl">1.1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate the effect for Atlantis across all existing years</span></span>
<span><span class="va">ame_hypo_gdp_country_year_year</span> <span class="op">&lt;-</span> <span class="va">model_gdp_country_year_year</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">emtrends</span><span class="op">(</span><span class="op">~</span> <span class="va">country</span> <span class="op">+</span> <span class="va">year</span>,</span>
<span>           var <span class="op">=</span> <span class="st">"gdpPercap_log_z"</span>,</span>
<span>           at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">55</span>, by <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>, country <span class="op">=</span> <span class="st">"Atlantis"</span><span class="op">)</span>,</span>
<span>           epred <span class="op">=</span> <span class="cn">TRUE</span>, re_formula <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>           allow_new_levels <span class="op">=</span> <span class="cn">TRUE</span>, sample_new_levels <span class="op">=</span> <span class="st">"gaussian"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get the posterior distribution of this Atlantis effect and make a plot</span></span>
<span><span class="va">pred_hypo_gdp_country_year_year</span> <span class="op">&lt;-</span> <span class="va">ame_hypo_gdp_country_year_year</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">gather_emmeans_draws</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>.value <span class="op">=</span> <span class="op">(</span><span class="va">.value</span> <span class="op">/</span> <span class="va">gdp_log_sd</span><span class="op">)</span> <span class="op">/</span> <span class="fl">10</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>year <span class="op">=</span> <span class="va">year</span> <span class="op">+</span> <span class="fl">1952</span>,</span>
<span>         year <span class="op">=</span> <span class="fu">fct_inorder</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>fake_facet_title <span class="op">=</span> <span class="st">"AME for hypothetical Atlantis across time"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_hypo_gdp_country_year_year</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">pred_hypo_gdp_country_year_year</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">.value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_slab</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="fu">fct_rev</span><span class="op">(</span><span class="va">year</span><span class="op">)</span>, fill <span class="op">=</span> <span class="va">year</span>,</span>
<span>                fill_ramp <span class="op">=</span> <span class="fu">after_stat</span><span class="op">(</span><span class="fu">cut_cdf_qi</span><span class="op">(</span><span class="va">cdf</span>, .width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.02</span>, <span class="fl">0.8</span>, <span class="fl">0.95</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            height <span class="op">=</span> <span class="fl">2</span>, color <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_d</span><span class="op">(</span>option <span class="op">=</span> <span class="st">"rocket"</span>, guide <span class="op">=</span> <span class="st">"none"</span>, end <span class="op">=</span> <span class="fl">0.9</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_ramp_discrete</span><span class="op">(</span>range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.2</span><span class="op">)</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Average marginal effect on life expectancy"</span>, <span class="st">"\n"</span>, </span>
<span>                  <span class="st">"of a 10% increase in GDP per capita"</span><span class="op">)</span>, </span>
<span>       y <span class="op">=</span> <span class="st">"Year"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">fake_facet_title</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_clean</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>panel.grid.major.y <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>        strip.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fu">rel</span><span class="op">(</span><span class="fl">1.1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Show all the AME distributions in a mega plot</span></span>
<span><span class="op">(</span><span class="op">(</span><span class="va">plot_global_gdp_country_year_year</span> <span class="op">/</span> <span class="va">plot_hypo1_gdp_country_year_year</span><span class="op">)</span> <span class="op">|</span> </span>
<span>    <span class="va">plot_hypo_gdp_country_year_year</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">plot_annotation</span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Average marginal effect of GDP per capita"</span>, <span class="st">"\n"</span>,</span>
<span>                                 <span class="st">"(intercepts and slopes of both GDP per capita and year "</span>,</span>
<span>                                 <span class="st">"vary by country + intercepts and GDP slopes vary by year)"</span><span class="op">)</span>, </span>
<span>                  subtitle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"lifeExp ~ gdpPercap_log_z + year + "</span>, </span>
<span>                         <span class="st">"(1 + gdpPercap_log_z | year) + "</span>, </span>
<span>                         <span class="st">"(1 + gdpPercap_log_z + year | country)"</span><span class="op">)</span>,</span>
<span>                  caption <span class="op">=</span> <span class="st">"80% and 95% credible intervals shown with shading"</span>,</span>
<span>                  theme <span class="op">=</span> <span class="fu">theme_clean</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme</span><span class="op">(</span>plot.subtitle <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Consolas"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/plot-global-hypothetical-year-year-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page-inset-right" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section></section><section id="each-continent-and-nested-country-gets-its-own-intercept-and-gdp-and-year-slopes" class="level3"><h3 class="anchored" data-anchor-id="each-continent-and-nested-country-gets-its-own-intercept-and-gdp-and-year-slopes">Each continent and nested country gets its own intercept and GDP and year slopes</h3>
<p>Finally, for super bonus fun and games, we could incorporate an extra continent-level hierarchy into the model, since countries are nested in continents and regions might see specific trends in the GDP/life expectancy relationship. I’m not actually going to run this model here—it takes a while even on a fast computer, and you have to specify informative priors and let it run for more iterations, etc. If we did run this, we’d get 7 different <span class="math inline">\(\tau\)</span> parameters and 6 different correlation parameters and we could do all sorts of fun stuff with the posterior. But we won’t run this for now—you can though!</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_gdp_continent_country_year</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span></span>
<span>  <span class="fu">bf</span><span class="op">(</span><span class="va">lifeExp</span> <span class="op">~</span> <span class="va">gdpPercap_log_z</span> <span class="op">+</span> <span class="va">year</span> <span class="op">+</span> </span>
<span>       <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">gdpPercap_log_z</span> <span class="op">+</span> <span class="va">year</span> <span class="op">|</span> <span class="va">continent</span> <span class="op">/</span> <span class="va">country</span><span class="op">)</span>,</span>
<span>     decomp <span class="op">=</span> <span class="st">"QR"</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">gapminder</span>,</span>
<span>  cores <span class="op">=</span> <span class="fl">4</span>, chains <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="va">bayes_seed</span>,</span>
<span>  threads <span class="op">=</span> <span class="fu">threading</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>  <span class="co"># Two CPUs per chain to speed things up</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># You'd use this to calculate the continent/country specific effects</span></span>
<span><span class="va">model_gdp_continent_country_year</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">emtrends</span><span class="op">(</span><span class="op">~</span> <span class="va">year</span> <span class="op">+</span> <span class="va">continent</span><span class="op">:</span><span class="va">country</span>,</span>
<span>           var <span class="op">=</span> <span class="st">"gdpPercap_log_z"</span>,</span>
<span>           at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>, country <span class="op">=</span> <span class="va">countries</span><span class="op">$</span><span class="va">country</span><span class="op">)</span>,</span>
<span>           nesting <span class="op">=</span> <span class="st">"country %in% continent"</span>,</span>
<span>           epred <span class="op">=</span> <span class="cn">TRUE</span>, re_formula <span class="op">=</span> <span class="cn">NULL</span>, allow_new_levels <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="other-ways-of-dealing-with-time" class="level2"><h2 class="anchored" data-anchor-id="other-ways-of-dealing-with-time">Other ways of dealing with time</h2>
<p>Throughout this guide, we’ve treated the time effect as linear, and that’s probably okay for this toy Gapminder example. In reality, though you can model time in all sorts of fancier ways, and there are whole textbooks and courses about how to do that (like <a href="https://bookdown.org/content/4253/">Solomon Kurz’s excellent <strong>brms</strong> and <strong>tidyverse</strong> translation</a> of <a href="https://www.oxfordscholarship.com/view/10.1093/acprof:oso/9780195152968.001.0001/acprof-9780195152968">Singer and Willett’s <em>Applied Longitudinal Data Analysis</em></a> <a href="https://bookdown.org/content/4253/">here</a>). For example, <a href="https://twitter.com/solomonkurz/status/1465781498058092544">Solomon Kurz here</a> uses R’s built-in <code>ChickWeight</code> dataset to model the effect of different diets across time on chick weights:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="solomon-screenshot.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:75.0%"></p>
</figure>
</div>
</div>
</div>
<p>The model he uses looks like this—he uses time, time², the interaction of time and diet, the interaction of time² and diet, and adds chick-specific offsets to both time and time²! That lets the model pick up all sorts of linear and quadratic trends in time and their interactions with different diets, all across individual chicks in the dataset. That’s super neat.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">lme4</span><span class="fu">::</span><span class="fu">lmer</span><span class="op">(</span></span>
<span>  <span class="va">weight</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">Time</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="va">Time</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="va">Diet</span> <span class="op">+</span> <span class="va">Time</span><span class="op">:</span><span class="va">Diet</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="va">Time</span><span class="op">^</span><span class="fl">2</span><span class="op">:</span><span class="va">Diet</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">Time</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="va">Time</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">|</span> <span class="va">Chick</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">ChickWeight</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You could also add splines, higher-order polynomials (time⁴!), and other complexity to model time, but that goes way beyond the scope of this guide. Refer to <a href="https://bookdown.org/content/4253/">Solomon’s guide</a> for more about all that.</p>
</section><section id="tldr-holy-crap-this-was-so-long" class="level2"><h2 class="anchored" data-anchor-id="tldr-holy-crap-this-was-so-long">tl;dr holy crap this was so long</h2>
<p>This guide was long and detailed, but again, the audience for this post is future-me. You’re all just along for the ride :)</p>
<p>Multilevel models let us deal with both time and country-level differences in panel data, and the ways we structure the random effects terms determine what we’re actually estimating.</p>
<p>Here’s a super quick review of the different models we ran and what they do:</p>
<ul>
<li>
<p>Country-specific intercepts + global time trend:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">bf</span><span class="op">(</span><span class="va">outcome</span> <span class="op">~</span> <span class="va">x</span> <span class="op">+</span> <span class="va">year</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">country</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
<li>
<p>Country-specific intercepts <em>and</em> country-specific slopes for year + global time trend:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">bf</span><span class="op">(</span><span class="va">outcome</span> <span class="op">~</span> <span class="va">x</span> <span class="op">+</span> <span class="va">year</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">year</span> <span class="op">|</span> <span class="va">country</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
<li>
<p>Country-specific intercepts <em>and</em> country-specific slopes for year and <code>x</code> + global time trend (<em>this seems to be the most common and sensible approach</em>):</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">bf</span><span class="op">(</span><span class="va">outcome</span> <span class="op">~</span> <span class="va">x</span> <span class="op">+</span> <span class="va">year</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">x</span> <span class="op">+</span> <span class="va">year</span> <span class="op">|</span> <span class="va">country</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
<li>
<p>Country-specific intercepts <em>and</em> country-specific slopes for year and <code>x</code> <em>and</em> year-specific intercepts + global time trend:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">bf</span><span class="op">(</span><span class="va">outcome</span> <span class="op">~</span> <span class="va">x</span> <span class="op">+</span> <span class="va">year</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">year</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">x</span> <span class="op">+</span> <span class="va">year</span> <span class="op">|</span> <span class="va">country</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
<li>
<p>Country-inside-continent-specific intercepts <em>and</em> country-inside-continent specific slopes for year and <code>x</code> + global time trend</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">bf</span><span class="op">(</span><span class="va">outcome</span> <span class="op">~</span> <span class="va">x</span> <span class="op">+</span> <span class="va">year</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">x</span> <span class="op">+</span> <span class="va">year</span> <span class="op">|</span> <span class="va">continent</span> <span class="op">/</span> <span class="va">country</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
<li>
<p>Super wild party time: Country-inside-continent-specific intercepts <em>and</em> country-inside-continent specific slopes for year and <code>x</code> <em>and</em> year-specific intercepts and slopes for <code>x</code> + global time trend</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">bf</span><span class="op">(</span><span class="va">outcome</span> <span class="op">~</span> <span class="va">x</span> <span class="op">+</span> <span class="va">year</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">x</span> <span class="op">|</span> <span class="va">year</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">x</span> <span class="op">+</span> <span class="va">year</span> <span class="op">|</span> <span class="va">continent</span> <span class="op">/</span> <span class="va">country</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
</ul>


<!-- -->

</section><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{heiss2021,
  author = {Heiss, Andrew},
  title = {A Guide to Working with Country-Year Panel Data and
    {Bayesian} Multilevel Models},
  date = {2021-12-01},
  url = {https://www.andrewheiss.com/blog/2021/12/01/multilevel-models-panel-data-guide/},
  doi = {10.59350/t19jz-ds665},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-heiss2021" class="csl-entry quarto-appendix-citeas" role="listitem">
Heiss, Andrew. 2021. <span>“A Guide to Working with Country-Year Panel
Data and Bayesian Multilevel Models.”</span> December 1, 2021. <a href="https://doi.org/10.59350/t19jz-ds665">https://doi.org/10.59350/t19jz-ds665</a>.
</div></div></section></div></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/www\.andrewheiss\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><script src="https://giscus.app/client.js" data-repo="andrewheiss/ath-quarto" data-repo-id="R_kgDOIg6EJQ" data-category="Blog comments" data-category-id="DIC_kwDOIg6EJc4CSz92" data-mapping="pathname" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script><input type="hidden" id="giscus-base-theme" value="light"><input type="hidden" id="giscus-alt-theme" value="dark"><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb86" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "A guide to working with country-year panel data and Bayesian multilevel models"</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> 2021-12-01</span></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a><span class="an">description:</span><span class="co"> "How to use multilevel models with R and brms to work with country-year panel data."</span></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a><span class="an">image:</span><span class="co"> index_files/figure-html/plot-global-hypothetical-year-year-1.png</span></span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a><span class="co">  - r</span></span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a><span class="co">  - tidyverse</span></span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a><span class="co">  - regression</span></span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a><span class="co">  - statistics</span></span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a><span class="co">  - data visualization</span></span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a><span class="co">  - bayes</span></span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a><span class="co">  - brms</span></span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a><span class="co">  - stan</span></span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a><span class="an">doi:</span><span class="co"> 10.59350/t19jz-ds665</span></span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a><span class="an">citation:</span><span class="co"> true</span></span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb86-18"><a href="#cb86-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-19"><a href="#cb86-19" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setup, include=FALSE}</span></span>
<span id="cb86-20"><a href="#cb86-20" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::opts_chunk$set(fig.align = "center", fig.retina = 3,</span></span>
<span id="cb86-21"><a href="#cb86-21" aria-hidden="true" tabindex="-1"></a><span class="in">                      fig.width = 6, fig.height = (6 * 0.618),</span></span>
<span id="cb86-22"><a href="#cb86-22" aria-hidden="true" tabindex="-1"></a><span class="in">                      out.width = "90%", collapse = TRUE)</span></span>
<span id="cb86-23"><a href="#cb86-23" aria-hidden="true" tabindex="-1"></a><span class="in">options(digits = 3, width = 90)</span></span>
<span id="cb86-24"><a href="#cb86-24" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-25"><a href="#cb86-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-26"><a href="#cb86-26" aria-hidden="true" tabindex="-1"></a><span class="in">```{r knitr-hook, include=FALSE}</span></span>
<span id="cb86-27"><a href="#cb86-27" aria-hidden="true" tabindex="-1"></a><span class="in">library(knitr)</span></span>
<span id="cb86-28"><a href="#cb86-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-29"><a href="#cb86-29" aria-hidden="true" tabindex="-1"></a><span class="in"># https://stackoverflow.com/a/23147563/120898</span></span>
<span id="cb86-30"><a href="#cb86-30" aria-hidden="true" tabindex="-1"></a><span class="in">hook_output &lt;- knit_hooks$get("output")</span></span>
<span id="cb86-31"><a href="#cb86-31" aria-hidden="true" tabindex="-1"></a><span class="in">knit_hooks$set(output = function(x, options) {</span></span>
<span id="cb86-32"><a href="#cb86-32" aria-hidden="true" tabindex="-1"></a><span class="in">  lines &lt;- options$output.lines</span></span>
<span id="cb86-33"><a href="#cb86-33" aria-hidden="true" tabindex="-1"></a><span class="in">  if (is.null(lines)) {</span></span>
<span id="cb86-34"><a href="#cb86-34" aria-hidden="true" tabindex="-1"></a><span class="in">    return(hook_output(x, options))  # pass to default hook</span></span>
<span id="cb86-35"><a href="#cb86-35" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb86-36"><a href="#cb86-36" aria-hidden="true" tabindex="-1"></a><span class="in">  x &lt;- unlist(strsplit(x, "\n"))</span></span>
<span id="cb86-37"><a href="#cb86-37" aria-hidden="true" tabindex="-1"></a><span class="in">  more &lt;- "..."</span></span>
<span id="cb86-38"><a href="#cb86-38" aria-hidden="true" tabindex="-1"></a><span class="in">  if (length(lines) == 1) {        # first n lines</span></span>
<span id="cb86-39"><a href="#cb86-39" aria-hidden="true" tabindex="-1"></a><span class="in">    if (length(x) &gt; lines) {</span></span>
<span id="cb86-40"><a href="#cb86-40" aria-hidden="true" tabindex="-1"></a><span class="in">      # truncate the output, but add ....</span></span>
<span id="cb86-41"><a href="#cb86-41" aria-hidden="true" tabindex="-1"></a><span class="in">      x &lt;- c(head(x, lines), more)</span></span>
<span id="cb86-42"><a href="#cb86-42" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb86-43"><a href="#cb86-43" aria-hidden="true" tabindex="-1"></a><span class="in">  } else {</span></span>
<span id="cb86-44"><a href="#cb86-44" aria-hidden="true" tabindex="-1"></a><span class="in">    x &lt;- c(more, x[lines], more)</span></span>
<span id="cb86-45"><a href="#cb86-45" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb86-46"><a href="#cb86-46" aria-hidden="true" tabindex="-1"></a><span class="in">  # paste these lines together</span></span>
<span id="cb86-47"><a href="#cb86-47" aria-hidden="true" tabindex="-1"></a><span class="in">  x &lt;- paste(c(x, ""), collapse = "\n")</span></span>
<span id="cb86-48"><a href="#cb86-48" aria-hidden="true" tabindex="-1"></a><span class="in">  hook_output(x, options)</span></span>
<span id="cb86-49"><a href="#cb86-49" aria-hidden="true" tabindex="-1"></a><span class="in">})</span></span>
<span id="cb86-50"><a href="#cb86-50" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-51"><a href="#cb86-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-52"><a href="#cb86-52" aria-hidden="true" tabindex="-1"></a>In most of my research, I work with country-level panel data where each row is a country in a specific year (Afghanistan in 2010, Afghanistan in 2011, and so on), also known as time-series cross-sectional (TSCS) data. Building statistical models for TSCS panel data is tricky, and most introductory statistics classes don't typically cover how to do it. Countries are repeated longitudinally over time, which means that time itself influences changes in the outcome variable. Countries also have internal trends and characteristics that influence the outcome—some might have a legacy of post-colonial civil war, for example. And to make it all more complex, countries are nested in continents and regions, and there might be regional trends that influence the outcome. Oh, and time-based trends can be different across countries and continents too. Working with all these different moving parts gets really difficult.</span>
<span id="cb86-53"><a href="#cb86-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-54"><a href="#cb86-54" aria-hidden="true" tabindex="-1"></a>I have a few different past blog posts where I show some of the complexities of working with this kind of data, like <span class="co">[</span><span class="ot">calculating average marginal effects</span><span class="co">](https://www.andrewheiss.com/blog/2021/11/10/ame-bayes-re-guide/)</span>, <span class="co">[</span><span class="ot">generating inverse probability weights for panel data</span><span class="co">](https://www.andrewheiss.com/blog/2020/12/03/ipw-tscs-msm/)</span>, or <span class="co">[</span><span class="ot">running marginal structural models on panel data</span><span class="co">](https://www.andrewheiss.com/blog/2021/01/15/msm-gee-multilevel/)</span>, and even one where I play with <span class="co">[</span><span class="ot">economists' preferred approach to panel data: two-way fixed effects (TWFE)</span><span class="co">](https://www.andrewheiss.com/blog/2021/08/25/twfe-diagnostics/)</span>. But I keep forgetting the basics of how to correctly structure multilevel models for country-year data, and all the examples I find online and in textbooks are about contexts I don't work with (participants in an experimental sleep study!). When there are examples involving countries and years, they typically refer to individual people nested in countries nested in continents (like survey respondents) and not to whole countries, which trips me up when adapting their approaches.</span>
<span id="cb86-55"><a href="#cb86-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-56"><a href="#cb86-56" aria-hidden="true" tabindex="-1"></a>So, as a service to future-me, here's a basic guide to dealing with country-year panel data using Bayesian multilevel modeling!</span>
<span id="cb86-57"><a href="#cb86-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-58"><a href="#cb86-58" aria-hidden="true" tabindex="-1"></a>This guide is hardly comprehensive or rigorous. I don't use the intimidating math notation for nested random effects that everyone else uses. I don't set any priors for the Bayesian models and instead just stick with the defaults, which are often inefficient. I don't check any of the Bayesian model diagnostics (like <span class="in">`pp_check()`</span>. In real life I do do all that, but this is just an overview of the practical mechanics of multilevel models, so I'm keeping it as basic and simple as possible.</span>
<span id="cb86-59"><a href="#cb86-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-60"><a href="#cb86-60" aria-hidden="true" tabindex="-1"></a>There are a ton of other really helpful resources about multilevel models. I had all these open in tabs while building this guide:</span>
<span id="cb86-61"><a href="#cb86-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-62"><a href="#cb86-62" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Cheat sheet for the R syntax for nested models</span><span class="co">](https://bbolker.github.io/mixedmodels-misc/glmmFAQ.html#model-specification)</span> (I refer to this *all the time*). <span class="co">[</span><span class="ot">The answers at this Cross Validated question</span><span class="co">](https://stats.stackexchange.com/questions/13166/rs-lmer-cheat-sheet)</span> are also fantastic, especially for thinking about how to interpret the coefficients and think about which parts of which coefficients are fixed and random.</span>
<span id="cb86-63"><a href="#cb86-63" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Michael Clark's guide to mixed models with R</span><span class="co">](https://m-clark.github.io/mixed-models-with-R/)</span>, especially the <span class="co">[</span><span class="ot">mixed models</span><span class="co">](https://m-clark.github.io/mixed-models-with-R/random_intercepts.html)</span>, <span class="co">[</span><span class="ot">more random effects</span><span class="co">](https://m-clark.github.io/mixed-models-with-R/random_slopes.html)</span>, <span class="co">[</span><span class="ot">common extensions</span><span class="co">](https://m-clark.github.io/mixed-models-with-R/extensions.html)</span>, and <span class="co">[</span><span class="ot">Bayesian approaches</span><span class="co">](https://m-clark.github.io/mixed-models-with-R/bayesian.html)</span> sections.</span>
<span id="cb86-64"><a href="#cb86-64" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Kristoffer Magnusson's <span class="co">[</span><span class="ot">"Using R and lme/lmer to fit different two- and three-level longitudinal models"</span><span class="co">](https://rpsychologist.com/r-guide-longitudinal-lme-lmer)</span>.</span>
<span id="cb86-65"><a href="#cb86-65" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Solomon Kurz's <span class="co">[</span><span class="ot">**tidyverse**/**brms** translation of chapter 12 of Richard McElreath's *Statistical Rethinking*</span><span class="co">](https://bookdown.org/ajkurz/Statistical_Rethinking_recoded/multilevel-models.html)</span>.</span>
<span id="cb86-66"><a href="#cb86-66" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Solomon Kurz's <span class="co">[</span><span class="ot">**tidyverse**/**brms** translation of Singer and Willett's *Applied Longitudinal Data Analysis*</span><span class="co">](https://bookdown.org/content/4253/)</span>, especially <span class="co">[</span><span class="ot">chapter 3</span><span class="co">](https://bookdown.org/content/4253/introducing-the-multilevel-model-for-change.html)</span> and <span class="co">[</span><span class="ot">chapter 4</span><span class="co">](https://bookdown.org/content/4253/doing-data-analysis-with-the-multilevel-model-for-change.html)</span>.</span>
<span id="cb86-67"><a href="#cb86-67" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">This short *Nature* article</span><span class="co">](https://www.nature.com/articles/nmeth.3137)</span> with a really neat graphic showing different types of nested and crossed random effects structures. <span class="co">[</span><span class="ot">Yury Zablotski's post here</span><span class="co">](https://yury-zablotski.netlify.app/post/mixed-effects-models-2/)</span> explores all of those types.</span>
<span id="cb86-68"><a href="#cb86-68" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Sean Anderson's <span class="co">[</span><span class="ot">"Generalized Linear Mixed-Effects Modeling in R" workshop</span><span class="co">](https://github.com/seananderson/glmm-course)</span>, especially <span class="co">[</span><span class="ot">section 15</span><span class="co">](https://github.com/seananderson/glmm-course/blob/master/15-lmm-practice-gapminder.Rmd)</span> which uses **gapminder** data.</span>
<span id="cb86-69"><a href="#cb86-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-70"><a href="#cb86-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-71"><a href="#cb86-71" aria-hidden="true" tabindex="-1"></a><span class="fu">## Who this guide is for</span></span>
<span id="cb86-72"><a href="#cb86-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-73"><a href="#cb86-73" aria-hidden="true" tabindex="-1"></a>Here's what I assume you know:</span>
<span id="cb86-74"><a href="#cb86-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-75"><a href="#cb86-75" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>You're familiar with <span class="co">[</span><span class="ot">R</span><span class="co">](https://www.r-project.org/)</span> and the <span class="co">[</span><span class="ot">tidyverse</span><span class="co">](https://www.tidyverse.org/)</span> (particularly <span class="co">[</span><span class="ot">dplyr</span><span class="co">](https://dplyr.tidyverse.org/)</span> and <span class="co">[</span><span class="ot">ggplot2</span><span class="co">](https://ggplot2.tidyverse.org/)</span>).</span>
<span id="cb86-76"><a href="#cb86-76" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>You're familiar with <span class="co">[</span><span class="ot">brms</span><span class="co">](https://paul-buerkner.github.io/brms/)</span> for running Bayesian regression models. See <span class="co">[</span><span class="ot">the vignettes here</span><span class="co">](https://paul-buerkner.github.io/brms/articles/index.html)</span>, examples like <span class="co">[</span><span class="ot">this</span><span class="co">](https://www.rensvandeschoot.com/tutorials/brms-started/)</span>, or <span class="co">[</span><span class="ot">resources like these</span><span class="co">](https://evalf21.classes.andrewheiss.com/resource/bayes/#resources)</span> for an introduction.</span>
<span id="cb86-77"><a href="#cb86-77" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>You're somewhat familiar with multilevel models. <span class="co">[</span><span class="ot">Confusingly</span><span class="co">](https://twitter.com/chelseaparlett/status/1458461737431146500)</span>, these are also called mixed effect models, random effect models, and hierarchical models, among others! They're all the same thing! (&lt;small&gt;image below by <span class="co">[</span><span class="ot">Chelsea Parlett-Pelleriti</span><span class="co">](https://twitter.com/chelseaparlett/status/1458461737431146500)</span>&lt;/small&gt;)</span>
<span id="cb86-78"><a href="#cb86-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-79"><a href="#cb86-79" aria-hidden="true" tabindex="-1"></a><span class="in">```{r chelsea-meme, echo=FALSE, out.width="60%", indent="  "}</span></span>
<span id="cb86-80"><a href="#cb86-80" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::include_graphics("chelsea-meme.jpg")</span></span>
<span id="cb86-81"><a href="#cb86-81" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-82"><a href="#cb86-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-83"><a href="#cb86-83" aria-hidden="true" tabindex="-1"></a><span class="in">    See examples like [this](https://www.tjmahr.com/plotting-partial-pooling-in-mixed-effects-models/) or [this](https://www.tjmahr.com/another-mixed-effects-model-visualization/) or [this](https://www.rensvandeschoot.com/tutorials/lme4/) or [this](https://rstudio-pubs-static.s3.amazonaws.com/63556_e35cc7e2dfb54a5bb551f3fa4b3ec4ae.html). Basically Google "lme4 example" (lme4 is what you use for frequentist, non-Bayesian multilevel models with R) or "brms multilevel example" and you'll find a bunch. For a more formal treatment, see chapter 12 in [Richard McElreath's *Statistcal Rethinking*](https://xcelab.net/rm/statistical-rethinking/) book (or [this R translation of it](https://bookdown.org/content/3890/multilevel-models.html) by Solomon Kurz).</span></span>
<span id="cb86-84"><a href="#cb86-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-85"><a href="#cb86-85" aria-hidden="true" tabindex="-1"></a>Let's get started by loading all the libraries we'll need (and creating a couple helper functions):</span>
<span id="cb86-86"><a href="#cb86-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-87"><a href="#cb86-87" aria-hidden="true" tabindex="-1"></a><span class="in">```{r libraries-functions, warning=FALSE, message=FALSE}</span></span>
<span id="cb86-88"><a href="#cb86-88" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidyverse)    # ggplot, dplyr, %&gt;%, and friends</span></span>
<span id="cb86-89"><a href="#cb86-89" aria-hidden="true" tabindex="-1"></a><span class="in">library(gapminder)    # Country-year panel data from the Gapminder Project</span></span>
<span id="cb86-90"><a href="#cb86-90" aria-hidden="true" tabindex="-1"></a><span class="in">library(brms)         # Bayesian modeling through Stan</span></span>
<span id="cb86-91"><a href="#cb86-91" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidybayes)    # Manipulate Stan objects in a tidy way</span></span>
<span id="cb86-92"><a href="#cb86-92" aria-hidden="true" tabindex="-1"></a><span class="in">library(broom)        # Convert model objects to data frames</span></span>
<span id="cb86-93"><a href="#cb86-93" aria-hidden="true" tabindex="-1"></a><span class="in">library(broom.mixed)  # Convert brms model objects to data frames</span></span>
<span id="cb86-94"><a href="#cb86-94" aria-hidden="true" tabindex="-1"></a><span class="in">library(emmeans)      # Calculate marginal effects in even fancier ways</span></span>
<span id="cb86-95"><a href="#cb86-95" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggh4x)        # For nested facets in ggplot</span></span>
<span id="cb86-96"><a href="#cb86-96" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggrepel)      # For nice non-overlapping labels in ggplot</span></span>
<span id="cb86-97"><a href="#cb86-97" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggdist)       # For distribution-related ggplot geoms</span></span>
<span id="cb86-98"><a href="#cb86-98" aria-hidden="true" tabindex="-1"></a><span class="in">library(scales)       # For formatting numbers with comma(), dollar(), etc.</span></span>
<span id="cb86-99"><a href="#cb86-99" aria-hidden="true" tabindex="-1"></a><span class="in">library(patchwork)    # For combining plots</span></span>
<span id="cb86-100"><a href="#cb86-100" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggokabeito)   # Colorblind-friendly color palette</span></span>
<span id="cb86-101"><a href="#cb86-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-102"><a href="#cb86-102" aria-hidden="true" tabindex="-1"></a><span class="in"># Make all the random draws reproducible</span></span>
<span id="cb86-103"><a href="#cb86-103" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(1234)</span></span>
<span id="cb86-104"><a href="#cb86-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-105"><a href="#cb86-105" aria-hidden="true" tabindex="-1"></a><span class="in"># Bayes stuff</span></span>
<span id="cb86-106"><a href="#cb86-106" aria-hidden="true" tabindex="-1"></a><span class="in"># Use the cmdstanr backend for Stan because it's faster and more modern than</span></span>
<span id="cb86-107"><a href="#cb86-107" aria-hidden="true" tabindex="-1"></a><span class="in"># the default rstan. You need to install the cmdstanr package first</span></span>
<span id="cb86-108"><a href="#cb86-108" aria-hidden="true" tabindex="-1"></a><span class="in"># (https://mc-stan.org/cmdstanr/) and then run cmdstanr::install_cmdstan() to</span></span>
<span id="cb86-109"><a href="#cb86-109" aria-hidden="true" tabindex="-1"></a><span class="in"># install cmdstan on your computer.</span></span>
<span id="cb86-110"><a href="#cb86-110" aria-hidden="true" tabindex="-1"></a><span class="in">options(mc.cores = 4,  # Use 4 cores</span></span>
<span id="cb86-111"><a href="#cb86-111" aria-hidden="true" tabindex="-1"></a><span class="in">        brms.backend = "cmdstanr")</span></span>
<span id="cb86-112"><a href="#cb86-112" aria-hidden="true" tabindex="-1"></a><span class="in">bayes_seed &lt;- 1234</span></span>
<span id="cb86-113"><a href="#cb86-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-114"><a href="#cb86-114" aria-hidden="true" tabindex="-1"></a><span class="in"># Custom ggplot theme to make pretty plots</span></span>
<span id="cb86-115"><a href="#cb86-115" aria-hidden="true" tabindex="-1"></a><span class="in"># Get Barlow Semi Condensed at https://fonts.google.com/specimen/Barlow+Semi+Condensed</span></span>
<span id="cb86-116"><a href="#cb86-116" aria-hidden="true" tabindex="-1"></a><span class="in">theme_clean &lt;- function() {</span></span>
<span id="cb86-117"><a href="#cb86-117" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_minimal(base_family = "Barlow Semi Condensed") +</span></span>
<span id="cb86-118"><a href="#cb86-118" aria-hidden="true" tabindex="-1"></a><span class="in">    theme(panel.grid.minor = element_blank(),</span></span>
<span id="cb86-119"><a href="#cb86-119" aria-hidden="true" tabindex="-1"></a><span class="in">          plot.background = element_rect(fill = "white", color = NA),</span></span>
<span id="cb86-120"><a href="#cb86-120" aria-hidden="true" tabindex="-1"></a><span class="in">          plot.title = element_text(face = "bold"),</span></span>
<span id="cb86-121"><a href="#cb86-121" aria-hidden="true" tabindex="-1"></a><span class="in">          axis.title = element_text(face = "bold"),</span></span>
<span id="cb86-122"><a href="#cb86-122" aria-hidden="true" tabindex="-1"></a><span class="in">          strip.text = element_text(face = "bold", size = rel(0.8), hjust = 0),</span></span>
<span id="cb86-123"><a href="#cb86-123" aria-hidden="true" tabindex="-1"></a><span class="in">          strip.background = element_rect(fill = "grey80", color = NA),</span></span>
<span id="cb86-124"><a href="#cb86-124" aria-hidden="true" tabindex="-1"></a><span class="in">          legend.title = element_text(face = "bold"))</span></span>
<span id="cb86-125"><a href="#cb86-125" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb86-126"><a href="#cb86-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-127"><a href="#cb86-127" aria-hidden="true" tabindex="-1"></a><span class="in"># Make labels use Barlow by default</span></span>
<span id="cb86-128"><a href="#cb86-128" aria-hidden="true" tabindex="-1"></a><span class="in">update_geom_defaults("label_repel", </span></span>
<span id="cb86-129"><a href="#cb86-129" aria-hidden="true" tabindex="-1"></a><span class="in">                     list(family = "Barlow Semi Condensed",</span></span>
<span id="cb86-130"><a href="#cb86-130" aria-hidden="true" tabindex="-1"></a><span class="in">                          fontface = "bold"))</span></span>
<span id="cb86-131"><a href="#cb86-131" aria-hidden="true" tabindex="-1"></a><span class="in">update_geom_defaults("label", </span></span>
<span id="cb86-132"><a href="#cb86-132" aria-hidden="true" tabindex="-1"></a><span class="in">                     list(family = "Barlow Semi Condensed",</span></span>
<span id="cb86-133"><a href="#cb86-133" aria-hidden="true" tabindex="-1"></a><span class="in">                          fontface = "bold"))</span></span>
<span id="cb86-134"><a href="#cb86-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-135"><a href="#cb86-135" aria-hidden="true" tabindex="-1"></a><span class="in"># The ggh4x paackage includes a `facet_nested()` function for nesting facets</span></span>
<span id="cb86-136"><a href="#cb86-136" aria-hidden="true" tabindex="-1"></a><span class="in"># (like countries in continents). Throughout this post, I want the</span></span>
<span id="cb86-137"><a href="#cb86-137" aria-hidden="true" tabindex="-1"></a><span class="in"># continent-level facets to use bolder text and a lighter gray strip. I don't</span></span>
<span id="cb86-138"><a href="#cb86-138" aria-hidden="true" tabindex="-1"></a><span class="in"># want to keep repeating all these settings, though, so I create a list of the</span></span>
<span id="cb86-139"><a href="#cb86-139" aria-hidden="true" tabindex="-1"></a><span class="in"># settings here with `strip_nested()` and feed it to `facet_nested_wrap()` later</span></span>
<span id="cb86-140"><a href="#cb86-140" aria-hidden="true" tabindex="-1"></a><span class="in">nested_settings &lt;- strip_nested(</span></span>
<span id="cb86-141"><a href="#cb86-141" aria-hidden="true" tabindex="-1"></a><span class="in">  text_x = list(element_text(family = "Barlow Semi Condensed Black", </span></span>
<span id="cb86-142"><a href="#cb86-142" aria-hidden="true" tabindex="-1"></a><span class="in">                             face = "plain"), NULL),</span></span>
<span id="cb86-143"><a href="#cb86-143" aria-hidden="true" tabindex="-1"></a><span class="in">  background_x = list(element_rect(fill = "grey92"), NULL),</span></span>
<span id="cb86-144"><a href="#cb86-144" aria-hidden="true" tabindex="-1"></a><span class="in">  by_layer_x = TRUE)</span></span>
<span id="cb86-145"><a href="#cb86-145" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-146"><a href="#cb86-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-147"><a href="#cb86-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-148"><a href="#cb86-148" aria-hidden="true" tabindex="-1"></a><span class="fu">## Example data: health and wealth over time</span></span>
<span id="cb86-149"><a href="#cb86-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-150"><a href="#cb86-150" aria-hidden="true" tabindex="-1"></a>Throughout this example, we're going to use data from Hans Rosling's <span class="co">[</span><span class="ot">Gapminder project</span><span class="co">](https://www.gapminder.org/)</span> to explore the relationship between wealth (measured as GDP per capita, or average income per person) and health (measured as life expectancy). You may have seen Hans Rosling's <span class="co">[</span><span class="ot">delightful TED talk</span><span class="co">](https://www.ted.com/talks/hans_rosling_shows_the_best_stats_you_ve_ever_seen)</span> showing how global health and wealth have been increasing since 1800—he became internet famous because of this work. Sadly, Hans died in February 2017.</span>
<span id="cb86-151"><a href="#cb86-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-152"><a href="#cb86-152" aria-hidden="true" tabindex="-1"></a>Before we start, watch this short 4-minute version of his famous health/wealth presentation. It's the best overview of the complexities of the panel data we're going to be working with:</span>
<span id="cb86-153"><a href="#cb86-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-154"><a href="#cb86-154" aria-hidden="true" tabindex="-1"></a><span class="in">```{css echo=FALSE}</span></span>
<span id="cb86-155"><a href="#cb86-155" aria-hidden="true" tabindex="-1"></a><span class="in">.video-container { position: relative; padding-bottom: 56.25%; padding-top: 30px; height: 0; overflow: hidden; margin-bottom: 1em;}</span></span>
<span id="cb86-156"><a href="#cb86-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-157"><a href="#cb86-157" aria-hidden="true" tabindex="-1"></a><span class="in">.video-container iframe, .video-container object, .video-container embed { position: absolute; top: 0; left: 0; width: 100%; height: 100%}</span></span>
<span id="cb86-158"><a href="#cb86-158" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-159"><a href="#cb86-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-160"><a href="#cb86-160" aria-hidden="true" tabindex="-1"></a>&lt;div class="video-container"&gt;</span>
<span id="cb86-161"><a href="#cb86-161" aria-hidden="true" tabindex="-1"></a>&lt;iframe src="https://www.youtube.com/embed/Z8t4k0Q8e8Y" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen&gt;&lt;/iframe&gt;</span>
<span id="cb86-162"><a href="#cb86-162" aria-hidden="true" tabindex="-1"></a>&lt;/div&gt;</span>
<span id="cb86-163"><a href="#cb86-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-164"><a href="#cb86-164" aria-hidden="true" tabindex="-1"></a>The original health/wealth data is all available at the <span class="co">[</span><span class="ot">Gapminder Project</span><span class="co">](https://www.gapminder.org/)</span>, but Jenny Bryan has conveniently created <span class="co">[</span><span class="ot">an R package called **gapminder**</span><span class="co">](https://github.com/jennybc/gapminder)</span> with the data already cleaned and nicely structured, so we'll use that. The data from **gapminder** includes observations from 142 different countries across 5 continents, and it ranges from 1952–2007 (skipping every five years, so there are observations for 1952, 1957, 1962, and so on). To simplify things, we'll drop the Oceania continent (which includes only two countries: Australia and New Zealand), and we'll choose two representative-ish countries in each of the remaining continents for the different country-specific trends we'll be looking at throughout this guide.</span>
<span id="cb86-165"><a href="#cb86-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-166"><a href="#cb86-166" aria-hidden="true" tabindex="-1"></a><span class="in">```{r clean-data}</span></span>
<span id="cb86-167"><a href="#cb86-167" aria-hidden="true" tabindex="-1"></a><span class="in"># Little dataset of 8 countries (2 for each of the 4 continents in the data)</span></span>
<span id="cb86-168"><a href="#cb86-168" aria-hidden="true" tabindex="-1"></a><span class="in"># that are good examples of different trends and intercepts</span></span>
<span id="cb86-169"><a href="#cb86-169" aria-hidden="true" tabindex="-1"></a><span class="in">countries &lt;- tribble(</span></span>
<span id="cb86-170"><a href="#cb86-170" aria-hidden="true" tabindex="-1"></a><span class="in">  ~country,       ~continent,</span></span>
<span id="cb86-171"><a href="#cb86-171" aria-hidden="true" tabindex="-1"></a><span class="in">  "Egypt",        "Africa",</span></span>
<span id="cb86-172"><a href="#cb86-172" aria-hidden="true" tabindex="-1"></a><span class="in">  "Sierra Leone", "Africa",</span></span>
<span id="cb86-173"><a href="#cb86-173" aria-hidden="true" tabindex="-1"></a><span class="in">  "Pakistan",     "Asia",</span></span>
<span id="cb86-174"><a href="#cb86-174" aria-hidden="true" tabindex="-1"></a><span class="in">  "Yemen, Rep.",  "Asia",</span></span>
<span id="cb86-175"><a href="#cb86-175" aria-hidden="true" tabindex="-1"></a><span class="in">  "Bolivia",      "Americas",</span></span>
<span id="cb86-176"><a href="#cb86-176" aria-hidden="true" tabindex="-1"></a><span class="in">  "Canada",       "Americas",</span></span>
<span id="cb86-177"><a href="#cb86-177" aria-hidden="true" tabindex="-1"></a><span class="in">  "Italy",        "Europe",</span></span>
<span id="cb86-178"><a href="#cb86-178" aria-hidden="true" tabindex="-1"></a><span class="in">  "Portugal",     "Europe"</span></span>
<span id="cb86-179"><a href="#cb86-179" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb86-180"><a href="#cb86-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-181"><a href="#cb86-181" aria-hidden="true" tabindex="-1"></a><span class="in"># Clean up the gapminder data a little</span></span>
<span id="cb86-182"><a href="#cb86-182" aria-hidden="true" tabindex="-1"></a><span class="in">gapminder &lt;- gapminder::gapminder %&gt;%</span></span>
<span id="cb86-183"><a href="#cb86-183" aria-hidden="true" tabindex="-1"></a><span class="in">  # Remove Oceania since there are only two countries there and we want bigger</span></span>
<span id="cb86-184"><a href="#cb86-184" aria-hidden="true" tabindex="-1"></a><span class="in">  # continent clusters</span></span>
<span id="cb86-185"><a href="#cb86-185" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(continent != "Oceania") %&gt;%</span></span>
<span id="cb86-186"><a href="#cb86-186" aria-hidden="true" tabindex="-1"></a><span class="in">  # Scale down GDP per capita so it's more interpretable ("a $1,000 increase in</span></span>
<span id="cb86-187"><a href="#cb86-187" aria-hidden="true" tabindex="-1"></a><span class="in">  # GDP" vs. "a $1 increase in GDP")</span></span>
<span id="cb86-188"><a href="#cb86-188" aria-hidden="true" tabindex="-1"></a><span class="in">  # Also log it</span></span>
<span id="cb86-189"><a href="#cb86-189" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(gdpPercap_1000 = gdpPercap / 1000,</span></span>
<span id="cb86-190"><a href="#cb86-190" aria-hidden="true" tabindex="-1"></a><span class="in">         gdpPercap_log = log(gdpPercap)) %&gt;% </span></span>
<span id="cb86-191"><a href="#cb86-191" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(across(starts_with("gdp"), list("z" = ~scale(.)))) %&gt;% </span></span>
<span id="cb86-192"><a href="#cb86-192" aria-hidden="true" tabindex="-1"></a><span class="in">  # Make year centered on 1952 (so we're counting the years since 1952). This</span></span>
<span id="cb86-193"><a href="#cb86-193" aria-hidden="true" tabindex="-1"></a><span class="in">  # (1) helps with interpretability, since the intercept will show the average</span></span>
<span id="cb86-194"><a href="#cb86-194" aria-hidden="true" tabindex="-1"></a><span class="in">  # at 1952 instead of the average at 0 CE, and (2) helps with estimation speed</span></span>
<span id="cb86-195"><a href="#cb86-195" aria-hidden="true" tabindex="-1"></a><span class="in">  # since brms/Stan likes to work with small numbers</span></span>
<span id="cb86-196"><a href="#cb86-196" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(year_orig = year,</span></span>
<span id="cb86-197"><a href="#cb86-197" aria-hidden="true" tabindex="-1"></a><span class="in">         year = year - 1952) %&gt;% </span></span>
<span id="cb86-198"><a href="#cb86-198" aria-hidden="true" tabindex="-1"></a><span class="in">  # Indicator for the 8 countries we're focusing on</span></span>
<span id="cb86-199"><a href="#cb86-199" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(highlight = country %in% countries$country)</span></span>
<span id="cb86-200"><a href="#cb86-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-201"><a href="#cb86-201" aria-hidden="true" tabindex="-1"></a><span class="in"># Extract rows for the example countries</span></span>
<span id="cb86-202"><a href="#cb86-202" aria-hidden="true" tabindex="-1"></a><span class="in">original_points &lt;- gapminder %&gt;% </span></span>
<span id="cb86-203"><a href="#cb86-203" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(country %in% countries$country) %&gt;% </span></span>
<span id="cb86-204"><a href="#cb86-204" aria-hidden="true" tabindex="-1"></a><span class="in">  # Use real years</span></span>
<span id="cb86-205"><a href="#cb86-205" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(year = year_orig)</span></span>
<span id="cb86-206"><a href="#cb86-206" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-207"><a href="#cb86-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-208"><a href="#cb86-208" aria-hidden="true" tabindex="-1"></a>Here's what this cleaned up data looks like. Notice how the scaled and centered columns (the ones with the <span class="in">`_z`</span> suffix) show up a little differently here (as one-column matrices)—we'll see why that is later.</span>
<span id="cb86-209"><a href="#cb86-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-210"><a href="#cb86-210" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-clean-data}</span></span>
<span id="cb86-211"><a href="#cb86-211" aria-hidden="true" tabindex="-1"></a><span class="in">glimpse(gapminder)</span></span>
<span id="cb86-212"><a href="#cb86-212" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-213"><a href="#cb86-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-214"><a href="#cb86-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-215"><a href="#cb86-215" aria-hidden="true" tabindex="-1"></a><span class="fu">## The effect of continent, country, and time on life expectancy</span></span>
<span id="cb86-216"><a href="#cb86-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-217"><a href="#cb86-217" aria-hidden="true" tabindex="-1"></a>Before we look at the relationship between wealth and health over time, it's important to understand how multilevel modeling works, so we'll simplify things and only look at the the relationship between life expectancy and time and how that relationship differs across continent and country.</span>
<span id="cb86-218"><a href="#cb86-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-219"><a href="#cb86-219" aria-hidden="true" tabindex="-1"></a>As we saw in the video, pretty much every country's life expectancy has increased over time. Countries all have different starting points or intercepts in 1952, and continent-specific differences influence those intercepts (e.g., Western Europe has much higher life expectancy than sub-Saharan Africa), and countries each have their own trends over time. Compare Egypt, which starts off fairly low and then rockets up fairly quickly from the 1970s to the 1990s, with Canada, which starts fairly high and ends really high. Some countries see negative trends over time, like Rwanda and Sierra Leone.</span>
<span id="cb86-220"><a href="#cb86-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-221"><a href="#cb86-221" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-year-trends, fig.width=7, fig.height=5, warning=FALSE}</span></span>
<span id="cb86-222"><a href="#cb86-222" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-inset-right</span></span>
<span id="cb86-223"><a href="#cb86-223" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(gapminder, aes(x = year_orig, y = lifeExp, </span></span>
<span id="cb86-224"><a href="#cb86-224" aria-hidden="true" tabindex="-1"></a><span class="in">                      group = country, color = continent)) +</span></span>
<span id="cb86-225"><a href="#cb86-225" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(aes(size = highlight)) +</span></span>
<span id="cb86-226"><a href="#cb86-226" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_smooth(method = "lm", aes(color = NULL, group = NULL), </span></span>
<span id="cb86-227"><a href="#cb86-227" aria-hidden="true" tabindex="-1"></a><span class="in">              color = "grey60", size = 1, linetype = "21",</span></span>
<span id="cb86-228"><a href="#cb86-228" aria-hidden="true" tabindex="-1"></a><span class="in">              se = FALSE, show.legend = FALSE) +</span></span>
<span id="cb86-229"><a href="#cb86-229" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_label_repel(data = filter(gapminder, year == 0, highlight == TRUE), </span></span>
<span id="cb86-230"><a href="#cb86-230" aria-hidden="true" tabindex="-1"></a><span class="in">                   aes(label = country), direction = "y", size = 3, seed = 1234, </span></span>
<span id="cb86-231"><a href="#cb86-231" aria-hidden="true" tabindex="-1"></a><span class="in">                   show.legend = FALSE) +</span></span>
<span id="cb86-232"><a href="#cb86-232" aria-hidden="true" tabindex="-1"></a><span class="in">  annotate(geom = "label", label = "Global trend", x = 1952, y = 50,</span></span>
<span id="cb86-233"><a href="#cb86-233" aria-hidden="true" tabindex="-1"></a><span class="in">           size = 3, color = "grey60") +</span></span>
<span id="cb86-234"><a href="#cb86-234" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_size_manual(values = c(0.075, 1), guide = "none") +</span></span>
<span id="cb86-235"><a href="#cb86-235" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_color_okabe_ito(order = c(2, 3, 6, 1)) +</span></span>
<span id="cb86-236"><a href="#cb86-236" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = NULL, y = "Life expectancy", color = "Continent") +</span></span>
<span id="cb86-237"><a href="#cb86-237" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_clean() +</span></span>
<span id="cb86-238"><a href="#cb86-238" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = "bottom")</span></span>
<span id="cb86-239"><a href="#cb86-239" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-240"><a href="#cb86-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-241"><a href="#cb86-241" aria-hidden="true" tabindex="-1"></a><span class="fu">### Regular regression</span></span>
<span id="cb86-242"><a href="#cb86-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-243"><a href="#cb86-243" aria-hidden="true" tabindex="-1"></a>To start, we'll make a simple boring model that completely ignores continent- and country-level differences and only looks at how much life expectancy increases over time. This is the dotted gray line in the plot above.</span>
<span id="cb86-244"><a href="#cb86-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-245"><a href="#cb86-245" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-boring, cache=TRUE, warning=FALSE, results="hide"}</span></span>
<span id="cb86-246"><a href="#cb86-246" aria-hidden="true" tabindex="-1"></a><span class="in">model_boring &lt;- brm(</span></span>
<span id="cb86-247"><a href="#cb86-247" aria-hidden="true" tabindex="-1"></a><span class="in">  bf(lifeExp ~ year),</span></span>
<span id="cb86-248"><a href="#cb86-248" aria-hidden="true" tabindex="-1"></a><span class="in">  data = gapminder,</span></span>
<span id="cb86-249"><a href="#cb86-249" aria-hidden="true" tabindex="-1"></a><span class="in">  chains = 4, seed = bayes_seed</span></span>
<span id="cb86-250"><a href="#cb86-250" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb86-251"><a href="#cb86-251" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-252"><a href="#cb86-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-253"><a href="#cb86-253" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-model-boring}</span></span>
<span id="cb86-254"><a href="#cb86-254" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_boring)</span></span>
<span id="cb86-255"><a href="#cb86-255" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-256"><a href="#cb86-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-257"><a href="#cb86-257" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-model-boring, include=FALSE}</span></span>
<span id="cb86-258"><a href="#cb86-258" aria-hidden="true" tabindex="-1"></a><span class="in">m_boring &lt;- tidy(model_boring) %&gt;% </span></span>
<span id="cb86-259"><a href="#cb86-259" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(term = janitor::make_clean_names(term),</span></span>
<span id="cb86-260"><a href="#cb86-260" aria-hidden="true" tabindex="-1"></a><span class="in">         est = round(estimate, 2)) %&gt;% </span></span>
<span id="cb86-261"><a href="#cb86-261" aria-hidden="true" tabindex="-1"></a><span class="in">  split(.$term)</span></span>
<span id="cb86-262"><a href="#cb86-262" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-263"><a href="#cb86-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-264"><a href="#cb86-264" aria-hidden="true" tabindex="-1"></a>When <span class="in">`year`</span> is zero, or in 1952, the average life expectancy is <span class="in">`r m_boring$intercept$est`</span> years, and it increases by <span class="in">`r m_boring$year$est`</span> years each year after that. </span>
<span id="cb86-265"><a href="#cb86-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-266"><a href="#cb86-266" aria-hidden="true" tabindex="-1"></a>That's cool, I guess, but we're ignoring the structure of the data. We're not accounting for any of the country-specific or region-specific trends that might also influence life expectancy. This is apparent when we plot predictions from this model—each country has the same predicted trend and the same starting point. None of these lines fit any of the example countries at all.</span>
<span id="cb86-267"><a href="#cb86-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-268"><a href="#cb86-268" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-preds-boring, fig.width=8, fig.height=5, warning=FALSE}</span></span>
<span id="cb86-269"><a href="#cb86-269" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-inset-right</span></span>
<span id="cb86-270"><a href="#cb86-270" aria-hidden="true" tabindex="-1"></a><span class="in">pred_model_boring &lt;- model_boring %&gt;%</span></span>
<span id="cb86-271"><a href="#cb86-271" aria-hidden="true" tabindex="-1"></a><span class="in">  epred_draws(newdata = expand_grid(country = countries$country,</span></span>
<span id="cb86-272"><a href="#cb86-272" aria-hidden="true" tabindex="-1"></a><span class="in">                                    year = unique(gapminder$year))) %&gt;% </span></span>
<span id="cb86-273"><a href="#cb86-273" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(year = year + 1952) %&gt;% </span></span>
<span id="cb86-274"><a href="#cb86-274" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(countries, by = "country")</span></span>
<span id="cb86-275"><a href="#cb86-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-276"><a href="#cb86-276" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(pred_model_boring, aes(x = year, y = .epred)) +</span></span>
<span id="cb86-277"><a href="#cb86-277" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(data = original_points, aes(y = lifeExp), </span></span>
<span id="cb86-278"><a href="#cb86-278" aria-hidden="true" tabindex="-1"></a><span class="in">             color = "grey50", size = 3, alpha = 0.5) +</span></span>
<span id="cb86-279"><a href="#cb86-279" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_lineribbon(alpha = 0.5, size = 0.5) +</span></span>
<span id="cb86-280"><a href="#cb86-280" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_brewer(palette = "Reds") +</span></span>
<span id="cb86-281"><a href="#cb86-281" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(title = "Global year trend with no country-based variation",</span></span>
<span id="cb86-282"><a href="#cb86-282" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "lifeExp ~ year",</span></span>
<span id="cb86-283"><a href="#cb86-283" aria-hidden="true" tabindex="-1"></a><span class="in">       x = NULL, y = "Predicted life expectancy") +</span></span>
<span id="cb86-284"><a href="#cb86-284" aria-hidden="true" tabindex="-1"></a><span class="in">  guides(fill = "none") +</span></span>
<span id="cb86-285"><a href="#cb86-285" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_nested_wrap(vars(continent, country), nrow = 2, strip = nested_settings) +</span></span>
<span id="cb86-286"><a href="#cb86-286" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_clean() +</span></span>
<span id="cb86-287"><a href="#cb86-287" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = "bottom",</span></span>
<span id="cb86-288"><a href="#cb86-288" aria-hidden="true" tabindex="-1"></a><span class="in">        plot.subtitle = element_text(family = "Consolas"),</span></span>
<span id="cb86-289"><a href="#cb86-289" aria-hidden="true" tabindex="-1"></a><span class="in">        axis.text.x = element_text(angle = 45, hjust = 0.5, vjust = 0.5))</span></span>
<span id="cb86-290"><a href="#cb86-290" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-291"><a href="#cb86-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-292"><a href="#cb86-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-293"><a href="#cb86-293" aria-hidden="true" tabindex="-1"></a><span class="fu">### Introduction to random effects: Intercepts for each continent</span></span>
<span id="cb86-294"><a href="#cb86-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-295"><a href="#cb86-295" aria-hidden="true" tabindex="-1"></a>For now, we're interested in the effect of time on life expectancy: how much does life expectancy increase on average as time passes (or as <span class="in">`year`</span> increases)? We already estimated this basic model:</span>
<span id="cb86-296"><a href="#cb86-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-297"><a href="#cb86-297" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb86-298"><a href="#cb86-298" aria-hidden="true" tabindex="-1"></a>\text{Life expectancy} = \beta_0 + \beta_1 \text{Year} + \epsilon</span>
<span id="cb86-299"><a href="#cb86-299" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb86-300"><a href="#cb86-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-301"><a href="#cb86-301" aria-hidden="true" tabindex="-1"></a>The year effect here is the $\beta_1$ coefficient, but this global estimate doesn't account for continent- or country-specific differences, and that kind of variation is important—we don't necessarily want to combine the trends in life expectancy across Western Europe and Latin America since they're so different. </span>
<span id="cb86-302"><a href="#cb86-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-303"><a href="#cb86-303" aria-hidden="true" tabindex="-1"></a>That $\epsilon$ error term is doing a lot of work. It represents all the variation in life expectancy that's not explained by (1) the baseline global life expectancy when <span class="in">`year`</span> is 0 (or 1952), and by (2) increases in <span class="in">`year`</span>. All sorts of unmeasured things are hidden in that $\epsilon$, like continent-level differences that might explain some additional variation in life expectancy. We can pull that continent-specific variation out of the error term to show that it exists:</span>
<span id="cb86-304"><a href="#cb86-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-305"><a href="#cb86-305" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb86-306"><a href="#cb86-306" aria-hidden="true" tabindex="-1"></a>\text{Life expectancy} = \beta_0 + \beta_1 \text{Year} + (b_{\text{Continent}} + \epsilon)</span>
<span id="cb86-307"><a href="#cb86-307" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb86-308"><a href="#cb86-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-309"><a href="#cb86-309" aria-hidden="true" tabindex="-1"></a>We use the Latin letter $b$ instead of the Greek $\beta$ to signal that it's a different kind of parameter. The $\beta$ parameters are "fixed effects" (this gets ***so confusing*** since in the world of econometrics and political science, "fixed effects" typically refer to indicator variables, like when you control for state or country. That's *not* the case here! Fixed effects here refer to population-level parameters that apply to all the observations in the data. Random effects refer to variations or deviations within subpopulations in the data (country, year, region, etc.)). Random effects, or $b$, show the offset from specific fixed parameters. </span>
<span id="cb86-310"><a href="#cb86-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-311"><a href="#cb86-311" aria-hidden="true" tabindex="-1"></a>Right now, this continent-level offset is hidden in the unestimated error term $\epsilon$, but we can move it around and pair it with one of the fixed terms in the model: either the intercept or year. For now we'll lump it in with the intercept and say that this continent random effect shifts the intercept up and down based on continent-level differences (we'll lump it in with the year effect a little later). We can rewrite our model like this now:</span>
<span id="cb86-312"><a href="#cb86-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-313"><a href="#cb86-313" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb86-314"><a href="#cb86-314" aria-hidden="true" tabindex="-1"></a>\text{Life expectancy} = (\beta_0 + b_{0, \text{Continent}}) + \beta_1 \text{Year} + \epsilon</span>
<span id="cb86-315"><a href="#cb86-315" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb86-316"><a href="#cb86-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-317"><a href="#cb86-317" aria-hidden="true" tabindex="-1"></a>All we've really done is take $b_{\text{Continent}}$, move it over next to the intercept term $\beta_0$, and add a 0 subscript to show that it represents the offset or deviation from $\beta_0$ for each continent.</span>
<span id="cb86-318"><a href="#cb86-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-319"><a href="#cb86-319" aria-hidden="true" tabindex="-1"></a>If you've ever worked with regular old OLS regression with <span class="in">`lm()`</span>, you might be thinking that this is basically just the same as including an indicator variable for continent. For instance, if you run a model like this…</span>
<span id="cb86-320"><a href="#cb86-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-321"><a href="#cb86-321" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-super-boring}</span></span>
<span id="cb86-322"><a href="#cb86-322" aria-hidden="true" tabindex="-1"></a><span class="in">model_super_boring &lt;- lm(lifeExp ~ year + continent, data = gapminder)</span></span>
<span id="cb86-323"><a href="#cb86-323" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_super_boring)</span></span>
<span id="cb86-324"><a href="#cb86-324" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-325"><a href="#cb86-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-326"><a href="#cb86-326" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-model-super-boring, include=FALSE}</span></span>
<span id="cb86-327"><a href="#cb86-327" aria-hidden="true" tabindex="-1"></a><span class="in">m_super_boring &lt;- tidy(model_super_boring) %&gt;% </span></span>
<span id="cb86-328"><a href="#cb86-328" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(term = janitor::make_clean_names(term),</span></span>
<span id="cb86-329"><a href="#cb86-329" aria-hidden="true" tabindex="-1"></a><span class="in">         est = round(estimate, 2)) %&gt;% </span></span>
<span id="cb86-330"><a href="#cb86-330" aria-hidden="true" tabindex="-1"></a><span class="in">  split(.$term)</span></span>
<span id="cb86-331"><a href="#cb86-331" aria-hidden="true" tabindex="-1"></a><span class="in">m_super_boring$intercept$est</span></span>
<span id="cb86-332"><a href="#cb86-332" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-333"><a href="#cb86-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-334"><a href="#cb86-334" aria-hidden="true" tabindex="-1"></a>…you get coefficients for each of the continents (except Africa, which is the base case). You can then add these continent-specific coefficients to the intercept to get continent-specific intercepts. For example, the average life expectancy in Africa in 1952 (i.e. when <span class="in">`year`</span> is 0, or the intercept) is <span class="in">`r m_super_boring$intercept$est`</span> years. Europe's average life expectancy in 1952 is <span class="in">`r m_super_boring$intercept$est`</span> + <span class="in">`r m_super_boring$continent_europe$est`</span>, or <span class="in">`r round(m_super_boring$intercept$estimate + m_super_boring$continent_europe$estimate, 2)`</span> years, and so on.</span>
<span id="cb86-335"><a href="#cb86-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-336"><a href="#cb86-336" aria-hidden="true" tabindex="-1"></a>So why use these random effects instead of using indicator variables like this?</span>
<span id="cb86-337"><a href="#cb86-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-338"><a href="#cb86-338" aria-hidden="true" tabindex="-1"></a>One reason is that thinking about these group-specific offsets as random effects allows us to model them more richly. We can define the whole range of group offsets using a distribution. For example, we could say that the intercept offsets are normally distributed with a mean of 0 and a standard deviation of $\tau$ (note that we're using Greek again—this $\tau$ variance is a population-level parameter and doesn't vary by group). Some continents will have a positive offset; some will have a negative offset; in general the average of the offsets should be 0; and the variation in those offsets can be measured with $\tau$.</span>
<span id="cb86-339"><a href="#cb86-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-340"><a href="#cb86-340" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb86-341"><a href="#cb86-341" aria-hidden="true" tabindex="-1"></a>b_{0, \text{Continent}} \sim \mathcal{N}(0, \tau)</span>
<span id="cb86-342"><a href="#cb86-342" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb86-343"><a href="#cb86-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-344"><a href="#cb86-344" aria-hidden="true" tabindex="-1"></a>Notice how we're now working with a regression model with two parts: one part at a continent level where we estimate continent-specific offsets in the intercept, and one part at the observation level (which in this case is countries). That's why this approach is often called "multilevel modeling"—we have multiple levels in our model:</span>
<span id="cb86-345"><a href="#cb86-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-346"><a href="#cb86-346" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb86-347"><a href="#cb86-347" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb86-348"><a href="#cb86-348" aria-hidden="true" tabindex="-1"></a>\text{Life expectancy} &amp;= (\beta_0 + b_{0, \text{Continent}}) + \beta_1 \text{Year} + \epsilon <span class="sc">\\</span></span>
<span id="cb86-349"><a href="#cb86-349" aria-hidden="true" tabindex="-1"></a>b_{0, \text{Continent}} &amp;\sim \mathcal{N}(0, \tau)</span>
<span id="cb86-350"><a href="#cb86-350" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb86-351"><a href="#cb86-351" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb86-352"><a href="#cb86-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-353"><a href="#cb86-353" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Fixed (population-level) effects</span></span>
<span id="cb86-354"><a href="#cb86-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-355"><a href="#cb86-355" aria-hidden="true" tabindex="-1"></a>Here's what this looks like in practice. We'll take our boring basic model and add a <span class="in">`(1 | continent)`</span> term, which means that we're letting the intercept (or <span class="in">`1`</span>) vary by continent. This is the code version of lumping the random continent effect with the intercept, or creating $(\beta_0 + b_{0, \text{Continent}})$.</span>
<span id="cb86-356"><a href="#cb86-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-357"><a href="#cb86-357" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-continent-only, warning=FALSE, cache=TRUE, results="hide"}</span></span>
<span id="cb86-358"><a href="#cb86-358" aria-hidden="true" tabindex="-1"></a><span class="in"># Each continent gets its own intercept</span></span>
<span id="cb86-359"><a href="#cb86-359" aria-hidden="true" tabindex="-1"></a><span class="in">model_continent_only &lt;- brm(</span></span>
<span id="cb86-360"><a href="#cb86-360" aria-hidden="true" tabindex="-1"></a><span class="in">  bf(lifeExp ~ year + (1 | continent)),</span></span>
<span id="cb86-361"><a href="#cb86-361" aria-hidden="true" tabindex="-1"></a><span class="in">  data = gapminder,</span></span>
<span id="cb86-362"><a href="#cb86-362" aria-hidden="true" tabindex="-1"></a><span class="in">  control = list(adapt_delta = 0.95),</span></span>
<span id="cb86-363"><a href="#cb86-363" aria-hidden="true" tabindex="-1"></a><span class="in">  chains = 4, seed = bayes_seed</span></span>
<span id="cb86-364"><a href="#cb86-364" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb86-365"><a href="#cb86-365" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-366"><a href="#cb86-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-367"><a href="#cb86-367" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-model-continent-only, include=FALSE}</span></span>
<span id="cb86-368"><a href="#cb86-368" aria-hidden="true" tabindex="-1"></a><span class="in">m_continent_only &lt;- tidy(model_continent_only) %&gt;% </span></span>
<span id="cb86-369"><a href="#cb86-369" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(term = janitor::make_clean_names(term),</span></span>
<span id="cb86-370"><a href="#cb86-370" aria-hidden="true" tabindex="-1"></a><span class="in">         est = round(estimate, 2)) %&gt;% </span></span>
<span id="cb86-371"><a href="#cb86-371" aria-hidden="true" tabindex="-1"></a><span class="in">  split(~ term)</span></span>
<span id="cb86-372"><a href="#cb86-372" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-373"><a href="#cb86-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-374"><a href="#cb86-374" aria-hidden="true" tabindex="-1"></a>If we look at the results we find basically the same coefficients we found in the original boring model: average global life expectancy in 1952 is <span class="in">`r m_continent_only$intercept$est`</span> years, and it increases by <span class="in">`r m_continent_only$year$est`</span> each year after that, on average. We also have errors and credible intervals, like any regular **brms**-based regression model.</span>
<span id="cb86-375"><a href="#cb86-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-376"><a href="#cb86-376" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-model-continent-only}</span></span>
<span id="cb86-377"><a href="#cb86-377" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_continent_only)</span></span>
<span id="cb86-378"><a href="#cb86-378" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-379"><a href="#cb86-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-380"><a href="#cb86-380" aria-hidden="true" tabindex="-1"></a>These $\beta_0$ and $\beta_1$ coefficients for the intercept and year are considered "fixed effects" (again, this is totally unrelated to the idea of indicator variables from econometrics, political science, and other social sciences!). These are population-level parameters that transcend continent-specific differences. The default results from <span class="in">`summary()`</span> make this distinction a little more clear and calls them "Population-Level Effects":</span>
<span id="cb86-381"><a href="#cb86-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-382"><a href="#cb86-382" aria-hidden="true" tabindex="-1"></a><span class="in">```{r summary-model-continent-only, output.lines=13:16, warning=FALSE}</span></span>
<span id="cb86-383"><a href="#cb86-383" aria-hidden="true" tabindex="-1"></a><span class="in">summary(model_continent_only)</span></span>
<span id="cb86-384"><a href="#cb86-384" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-385"><a href="#cb86-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-386"><a href="#cb86-386" aria-hidden="true" tabindex="-1"></a>We can clean up the results from <span class="in">`tidy()`</span> and show only these fixed effects with the <span class="in">`effects = "fixed"`</span> argument:</span>
<span id="cb86-387"><a href="#cb86-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-388"><a href="#cb86-388" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-model-continent-only-fixed}</span></span>
<span id="cb86-389"><a href="#cb86-389" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_continent_only, effects = "fixed")</span></span>
<span id="cb86-390"><a href="#cb86-390" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-391"><a href="#cb86-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-392"><a href="#cb86-392" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Continent-level variance</span></span>
<span id="cb86-393"><a href="#cb86-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-394"><a href="#cb86-394" aria-hidden="true" tabindex="-1"></a>The whole reason we're using a multilevel model here instead of just using indicator variables is that we can use information about the variation in continents to improve our coefficient estimates and model accuracy. Notice that there were extra new parameters in the output from <span class="in">`tidy()`</span>, which we can also see if we use the <span class="in">`effects = "ran_pars"`</span> argument (these also show up in the output from <span class="in">`summary()`</span> as "Group-Level Effects"):</span>
<span id="cb86-395"><a href="#cb86-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-396"><a href="#cb86-396" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-model-continent-only-random}</span></span>
<span id="cb86-397"><a href="#cb86-397" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_continent_only, effects = "ran_pars")</span></span>
<span id="cb86-398"><a href="#cb86-398" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-399"><a href="#cb86-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-400"><a href="#cb86-400" aria-hidden="true" tabindex="-1"></a>We have two extra random parameters here: </span>
<span id="cb86-401"><a href="#cb86-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-402"><a href="#cb86-402" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>The estimated variance/standard deviation of the continent effect, or $\tau$ from our $b_{0, \text{Continent}} \sim \mathcal{N}(0, \tau)$ model level from before, represented with the `sd__(Intercept)<span class="in">` term in the `</span>continent<span class="in">` group: **`</span>r m_continent_only$sd_intercept$est`**</span>
<span id="cb86-403"><a href="#cb86-403" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>The total residual variation (i.e. unexplained variation in life expectancy), represented with the <span class="in">`sd__Observation`</span> term in the <span class="in">`Residual`</span> group: **`r m_continent_only$sd_observation$est`**</span>
<span id="cb86-404"><a href="#cb86-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-405"><a href="#cb86-405" aria-hidden="true" tabindex="-1"></a>To borrow heavily from <span class="co">[</span><span class="ot">Michael Clark's excellent explanation of these variance components</span><span class="co">](https://m-clark.github.io/mixed-models-with-R/random_intercepts.html#variance-components)</span>, this $\tau$ parameter tells how much life expectancy bounces around as we move from continent to continent. We can predict life expectancy based on the year trend, but each continent has its own unique life expectancy offset, and this $\tau$ is the average deviation across all the continents. Practically speaking, there's a substantial amount of cross-continent variation here: <span class="in">`r m_continent_only$sd_intercept$est`</span> years!</span>
<span id="cb86-406"><a href="#cb86-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-407"><a href="#cb86-407" aria-hidden="true" tabindex="-1"></a>We can also think about this continent-level variance as a percentage of the total residual variance in the model. Continent-level variation contributes <span class="in">`r percent(m_continent_only$sd_intercept$estimate / (m_continent_only$sd_intercept$est + m_continent_only$sd_observation$est))`</span> (<span class="in">`r m_continent_only$sd_intercept$est`</span> / (<span class="in">`r m_continent_only$sd_intercept$est`</span> + <span class="in">`r m_continent_only$sd_observation$est`</span>)) of the total variance in life expectancy.</span>
<span id="cb86-408"><a href="#cb86-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-409"><a href="#cb86-409" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Continent-level random effects</span></span>
<span id="cb86-410"><a href="#cb86-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-411"><a href="#cb86-411" aria-hidden="true" tabindex="-1"></a>We can see these actual offsets with the <span class="in">`ranef()`</span> function. By default this returns an unwieldy list with multi-dimensional arrays nested in it, so we'll convert it to a nice data frame here so we can work with it later.</span>
<span id="cb86-412"><a href="#cb86-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-413"><a href="#cb86-413" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-continent-offsets}</span></span>
<span id="cb86-414"><a href="#cb86-414" aria-hidden="true" tabindex="-1"></a><span class="in">continent_offsets &lt;- ranef(model_continent_only)$continent %&gt;% </span></span>
<span id="cb86-415"><a href="#cb86-415" aria-hidden="true" tabindex="-1"></a><span class="in">  as_tibble(rownames = "continent")</span></span>
<span id="cb86-416"><a href="#cb86-416" aria-hidden="true" tabindex="-1"></a><span class="in">continent_offsets</span></span>
<span id="cb86-417"><a href="#cb86-417" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-418"><a href="#cb86-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-419"><a href="#cb86-419" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-continent-offsets, include=FALSE}</span></span>
<span id="cb86-420"><a href="#cb86-420" aria-hidden="true" tabindex="-1"></a><span class="in">cont_off &lt;- continent_offsets %&gt;% </span></span>
<span id="cb86-421"><a href="#cb86-421" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(offset = round(Estimate.Intercept, 2),</span></span>
<span id="cb86-422"><a href="#cb86-422" aria-hidden="true" tabindex="-1"></a><span class="in">         int = round(Estimate.Intercept + </span></span>
<span id="cb86-423"><a href="#cb86-423" aria-hidden="true" tabindex="-1"></a><span class="in">                       m_continent_only$intercept$estimate, 2)) %&gt;% </span></span>
<span id="cb86-424"><a href="#cb86-424" aria-hidden="true" tabindex="-1"></a><span class="in">  split(~ continent)</span></span>
<span id="cb86-425"><a href="#cb86-425" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-426"><a href="#cb86-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-427"><a href="#cb86-427" aria-hidden="true" tabindex="-1"></a>Each of these estimates represent the continent-specific offsets in the intercept, or $b_{0, \text{Continent}}$. To help with the intuition, we can add these offsets to the global population-level intercept to see the actual intercept for each continent. Let's plug these values into our model equation, with year set to 0 (or 1952):</span>
<span id="cb86-428"><a href="#cb86-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-429"><a href="#cb86-429" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb86-430"><a href="#cb86-430" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb86-431"><a href="#cb86-431" aria-hidden="true" tabindex="-1"></a>\text{Life expectancy}_\text{general} &amp;= (\beta_0 + b_{0, \text{Continent}}) + \beta_1 \text{Year} + \epsilon <span class="sc">\\</span></span>
<span id="cb86-432"><a href="#cb86-432" aria-hidden="true" tabindex="-1"></a>\text{Life expectancy}_\text{Africa} &amp;= (<span class="in">`r m_continent_only$intercept$est`</span> + <span class="in">`r cont_off$Africa$offset`</span>) + (<span class="in">`r m_continent_only$year$est`</span> \times 0) = <span class="in">`r cont_off$Africa$int`</span> <span class="sc">\\</span></span>
<span id="cb86-433"><a href="#cb86-433" aria-hidden="true" tabindex="-1"></a>\text{Life expectancy}_\text{Americas} &amp;= (<span class="in">`r m_continent_only$intercept$est`</span> + <span class="in">`r cont_off$Americas$offset`</span>) + (<span class="in">`r m_continent_only$year$est`</span> \times 0) = <span class="in">`r cont_off$Americas$int`</span> <span class="sc">\\</span></span>
<span id="cb86-434"><a href="#cb86-434" aria-hidden="true" tabindex="-1"></a>\text{Life expectancy}_\text{Asia} &amp;= (<span class="in">`r m_continent_only$intercept$est`</span> + <span class="in">`r cont_off$Asia$offset`</span>) + (<span class="in">`r m_continent_only$year$est`</span> \times 0) = <span class="in">`r cont_off$Asia$int`</span> <span class="sc">\\</span></span>
<span id="cb86-435"><a href="#cb86-435" aria-hidden="true" tabindex="-1"></a>\text{Life expectancy}_\text{Europe} &amp;= (<span class="in">`r m_continent_only$intercept$est`</span> + <span class="in">`r cont_off$Europe$offset`</span>) + (<span class="in">`r m_continent_only$year$est`</span> \times 0) = <span class="in">`r cont_off$Europe$int`</span></span>
<span id="cb86-436"><a href="#cb86-436" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb86-437"><a href="#cb86-437" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb86-438"><a href="#cb86-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-439"><a href="#cb86-439" aria-hidden="true" tabindex="-1"></a>We don't need to do this all by hand though. The <span class="in">`coef()`</span> function will return these group-specific intercepts with the offsets already incorporated. Notice how the results are the same—each continent has its own intercept, while the $\beta_1$ coefficient for <span class="in">`year`</span> is the same across continents:</span>
<span id="cb86-440"><a href="#cb86-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-441"><a href="#cb86-441" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-continent-coefs}</span></span>
<span id="cb86-442"><a href="#cb86-442" aria-hidden="true" tabindex="-1"></a><span class="in">coef(model_continent_only)$continent %&gt;% </span></span>
<span id="cb86-443"><a href="#cb86-443" aria-hidden="true" tabindex="-1"></a><span class="in">  as_tibble(rownames = "continent") %&gt;% </span></span>
<span id="cb86-444"><a href="#cb86-444" aria-hidden="true" tabindex="-1"></a><span class="in">  select(continent, starts_with("Estimate"))</span></span>
<span id="cb86-445"><a href="#cb86-445" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-446"><a href="#cb86-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-447"><a href="#cb86-447" aria-hidden="true" tabindex="-1"></a>Alternatively, we can also use the powerful **emmeans** package to calculate predicted values at different combinations of our model's variables. In this case our model uses a Gaussian distribution so it works like regular OLS regression (which means we can just add coefficients together), but other models like logistic regression or beta regression require a lot more work to combine the coefficients correctly. The <span class="in">`emmeans()`</span> function will calculate predicted values of life expectancy, while the <span class="in">`emtrends()`</span> function will calculate coefficients, incorporating group-level effects as needed (that's what the <span class="in">`re_formula = NULL`</span> argument is doing here; see <span class="co">[</span><span class="ot">this post for more details about that</span><span class="co">](https://www.andrewheiss.com/blog/2021/11/10/ame-bayes-re-guide/)</span>). These values should be the same that we found both manually with math and with <span class="in">`coef()`</span>:</span>
<span id="cb86-448"><a href="#cb86-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-449"><a href="#cb86-449" aria-hidden="true" tabindex="-1"></a><span class="in">```{r continent-emmeans}</span></span>
<span id="cb86-450"><a href="#cb86-450" aria-hidden="true" tabindex="-1"></a><span class="in">model_continent_only %&gt;% </span></span>
<span id="cb86-451"><a href="#cb86-451" aria-hidden="true" tabindex="-1"></a><span class="in">  emmeans(~ continent + year,</span></span>
<span id="cb86-452"><a href="#cb86-452" aria-hidden="true" tabindex="-1"></a><span class="in">          at = list(year = 0),  # Look at predicted values for 1952</span></span>
<span id="cb86-453"><a href="#cb86-453" aria-hidden="true" tabindex="-1"></a><span class="in">          epred = TRUE,  # Use expected predictions from the posterior</span></span>
<span id="cb86-454"><a href="#cb86-454" aria-hidden="true" tabindex="-1"></a><span class="in">          re_formula = NULL)  # Incorporate random effects</span></span>
<span id="cb86-455"><a href="#cb86-455" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-456"><a href="#cb86-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-457"><a href="#cb86-457" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Visualize continent-specific trends</span></span>
<span id="cb86-458"><a href="#cb86-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-459"><a href="#cb86-459" aria-hidden="true" tabindex="-1"></a>Finally, let's visualize this continent-specific year trend. Each of these lines has the same slope, but the intercepts now shift up and down based on continent. The lines are substantially higher in Europe and substantially lower in Africa:</span>
<span id="cb86-460"><a href="#cb86-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-461"><a href="#cb86-461" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-preds-continent, out.width="100%", fig.width=8, fig.height=5, warning=FALSE}</span></span>
<span id="cb86-462"><a href="#cb86-462" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-inset-right</span></span>
<span id="cb86-463"><a href="#cb86-463" aria-hidden="true" tabindex="-1"></a><span class="in">newdata_country_continent &lt;- expand_grid(country = countries$country,</span></span>
<span id="cb86-464"><a href="#cb86-464" aria-hidden="true" tabindex="-1"></a><span class="in">                                         year = unique(gapminder$year)) %&gt;% </span></span>
<span id="cb86-465"><a href="#cb86-465" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(countries, by = "country")</span></span>
<span id="cb86-466"><a href="#cb86-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-467"><a href="#cb86-467" aria-hidden="true" tabindex="-1"></a><span class="in">pred_model_continent_only &lt;- model_continent_only %&gt;%</span></span>
<span id="cb86-468"><a href="#cb86-468" aria-hidden="true" tabindex="-1"></a><span class="in">  epred_draws(newdata_country_continent, re_formula = NULL) %&gt;% </span></span>
<span id="cb86-469"><a href="#cb86-469" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(year = year + 1952)</span></span>
<span id="cb86-470"><a href="#cb86-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-471"><a href="#cb86-471" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(pred_model_continent_only, aes(x = year, y = .epred)) +</span></span>
<span id="cb86-472"><a href="#cb86-472" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(data = original_points, aes(y = lifeExp),</span></span>
<span id="cb86-473"><a href="#cb86-473" aria-hidden="true" tabindex="-1"></a><span class="in">             color = "grey50", size = 3, alpha = 0.5) +</span></span>
<span id="cb86-474"><a href="#cb86-474" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_lineribbon(alpha = 0.5) +</span></span>
<span id="cb86-475"><a href="#cb86-475" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_brewer(palette = "Reds") +</span></span>
<span id="cb86-476"><a href="#cb86-476" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(title = "Intercepts for year trend vary by continent",</span></span>
<span id="cb86-477"><a href="#cb86-477" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "lifeExp ~ year + (1 | continent)",</span></span>
<span id="cb86-478"><a href="#cb86-478" aria-hidden="true" tabindex="-1"></a><span class="in">       x = NULL, y = "Predicted life expectancy") +</span></span>
<span id="cb86-479"><a href="#cb86-479" aria-hidden="true" tabindex="-1"></a><span class="in">  guides(fill = "none") +</span></span>
<span id="cb86-480"><a href="#cb86-480" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_nested_wrap(vars(continent, country), nrow = 2, strip = nested_settings) +</span></span>
<span id="cb86-481"><a href="#cb86-481" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_clean() +</span></span>
<span id="cb86-482"><a href="#cb86-482" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = "bottom",</span></span>
<span id="cb86-483"><a href="#cb86-483" aria-hidden="true" tabindex="-1"></a><span class="in">        plot.subtitle = element_text(family = "Consolas"),</span></span>
<span id="cb86-484"><a href="#cb86-484" aria-hidden="true" tabindex="-1"></a><span class="in">        axis.text.x = element_text(angle = 45, hjust = 0.5, vjust = 0.5))</span></span>
<span id="cb86-485"><a href="#cb86-485" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-486"><a href="#cb86-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-487"><a href="#cb86-487" aria-hidden="true" tabindex="-1"></a><span class="fu">### Intercepts for each country</span></span>
<span id="cb86-488"><a href="#cb86-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-489"><a href="#cb86-489" aria-hidden="true" tabindex="-1"></a>Continent-level effects are neat, but the predicted trends in the plot above still don't really fit the data that well (except maybe in Europe). Instead of including random effects for continents, we can include country effects so that each country gets its own offset and intercept. Let's make this model:</span>
<span id="cb86-490"><a href="#cb86-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-491"><a href="#cb86-491" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb86-492"><a href="#cb86-492" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb86-493"><a href="#cb86-493" aria-hidden="true" tabindex="-1"></a>\text{Life expectancy} &amp;= (\beta_0 + b_{0, \text{Country}}) + \beta_1 \text{Year} + \epsilon <span class="sc">\\</span></span>
<span id="cb86-494"><a href="#cb86-494" aria-hidden="true" tabindex="-1"></a>b_{0, \text{Country}} &amp;\sim \mathcal{N}(0, \tau)</span>
<span id="cb86-495"><a href="#cb86-495" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb86-496"><a href="#cb86-496" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb86-497"><a href="#cb86-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-498"><a href="#cb86-498" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-country-only, cache=TRUE, warning=FALSE, results="hide"}</span></span>
<span id="cb86-499"><a href="#cb86-499" aria-hidden="true" tabindex="-1"></a><span class="in"># Each country gets its own intercept</span></span>
<span id="cb86-500"><a href="#cb86-500" aria-hidden="true" tabindex="-1"></a><span class="in">model_country_only &lt;- brm(</span></span>
<span id="cb86-501"><a href="#cb86-501" aria-hidden="true" tabindex="-1"></a><span class="in">  bf(lifeExp ~ year + (1 | country)),</span></span>
<span id="cb86-502"><a href="#cb86-502" aria-hidden="true" tabindex="-1"></a><span class="in">  data = gapminder,</span></span>
<span id="cb86-503"><a href="#cb86-503" aria-hidden="true" tabindex="-1"></a><span class="in">  chains = 4, seed = bayes_seed,</span></span>
<span id="cb86-504"><a href="#cb86-504" aria-hidden="true" tabindex="-1"></a><span class="in">  iter = 4000  # Double the number of iterations to help with convergence</span></span>
<span id="cb86-505"><a href="#cb86-505" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb86-506"><a href="#cb86-506" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-507"><a href="#cb86-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-508"><a href="#cb86-508" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-model-country-only}</span></span>
<span id="cb86-509"><a href="#cb86-509" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_country_only)</span></span>
<span id="cb86-510"><a href="#cb86-510" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-511"><a href="#cb86-511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-512"><a href="#cb86-512" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-model-country-only, include=FALSE}</span></span>
<span id="cb86-513"><a href="#cb86-513" aria-hidden="true" tabindex="-1"></a><span class="in">m_country_only &lt;- tidy(model_country_only) %&gt;% </span></span>
<span id="cb86-514"><a href="#cb86-514" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(term = janitor::make_clean_names(term),</span></span>
<span id="cb86-515"><a href="#cb86-515" aria-hidden="true" tabindex="-1"></a><span class="in">         est = round(estimate, 2)) %&gt;% </span></span>
<span id="cb86-516"><a href="#cb86-516" aria-hidden="true" tabindex="-1"></a><span class="in">  split(.$term)</span></span>
<span id="cb86-517"><a href="#cb86-517" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-518"><a href="#cb86-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-519"><a href="#cb86-519" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Fixed (population-level) effects</span></span>
<span id="cb86-520"><a href="#cb86-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-521"><a href="#cb86-521" aria-hidden="true" tabindex="-1"></a>The global population-level coefficients (or "fixed effects", but ***again*** these are not the same as indicator variables!) are roughly the same that we saw in both the original boring model and the model with continent effects: in 1952 (when <span class="in">`year`</span> is 0) the average life expectancy is <span class="in">`r m_country_only$intercept$est`</span> years, and it increases by <span class="in">`r m_country_only$year$est`</span> years annually after that.</span>
<span id="cb86-522"><a href="#cb86-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-523"><a href="#cb86-523" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Country-level variation</span></span>
<span id="cb86-524"><a href="#cb86-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-525"><a href="#cb86-525" aria-hidden="true" tabindex="-1"></a>Because we're using random effects, we have information about the $\tau$ parameter for the variance in country offsets, which shows us how much life expectancy bounces around from country to country. As with continents, we have a ton of cross-country variation: <span class="in">`r m_country_only$sd_intercept$est`</span> years! Country-specific offsets are centered around 0 ± a huge standard deviation of <span class="in">`r m_country_only$sd_intercept$est`</span>. Accounting for country differences is going to be crucial for this model.</span>
<span id="cb86-526"><a href="#cb86-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-527"><a href="#cb86-527" aria-hidden="true" tabindex="-1"></a>If we look at country-level variance as a percentage of the total residual variance, we can see that country differences are really important. Country-level variation contributes <span class="in">`r percent(m_country_only$sd_intercept$estimate / (m_country_only$sd_intercept$estimate + m_country_only$sd_observation$estimate))`</span> (<span class="in">`r m_country_only$sd_intercept$est`</span> / (<span class="in">`r m_country_only$sd_intercept$est`</span> + <span class="in">`r m_country_only$sd_observation$est`</span>)) of the total variance in life expectancy.</span>
<span id="cb86-528"><a href="#cb86-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-529"><a href="#cb86-529" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Country-level random effects</span></span>
<span id="cb86-530"><a href="#cb86-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-531"><a href="#cb86-531" aria-hidden="true" tabindex="-1"></a>We can look at country-level offsets for our eight example countries with <span class="in">`ranef()`</span>. Canada, Italy, and Portugal have offsets that are substantially above the global average, while Yemen and Sierra Leone are substantially below it.</span>
<span id="cb86-532"><a href="#cb86-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-533"><a href="#cb86-533" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-country-offsets}</span></span>
<span id="cb86-534"><a href="#cb86-534" aria-hidden="true" tabindex="-1"></a><span class="in">country_offsets &lt;- ranef(model_country_only)$country %&gt;%</span></span>
<span id="cb86-535"><a href="#cb86-535" aria-hidden="true" tabindex="-1"></a><span class="in">  as_tibble(rownames = "country") %&gt;% </span></span>
<span id="cb86-536"><a href="#cb86-536" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(country %in% countries$country) %&gt;% </span></span>
<span id="cb86-537"><a href="#cb86-537" aria-hidden="true" tabindex="-1"></a><span class="in">  select(country, starts_with("Estimate"))</span></span>
<span id="cb86-538"><a href="#cb86-538" aria-hidden="true" tabindex="-1"></a><span class="in">country_offsets</span></span>
<span id="cb86-539"><a href="#cb86-539" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-540"><a href="#cb86-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-541"><a href="#cb86-541" aria-hidden="true" tabindex="-1"></a>We can see the actual country-specific intercepts too. Each of these intercepts represents the life expectancy in these countries in 1952. Note that the coefficient for <span class="in">`year`</span> is the same in each—that's because it's a global population-level effect and isn't country-specific.</span>
<span id="cb86-542"><a href="#cb86-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-543"><a href="#cb86-543" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-country-coefs}</span></span>
<span id="cb86-544"><a href="#cb86-544" aria-hidden="true" tabindex="-1"></a><span class="in">coef(model_country_only)$country %&gt;%</span></span>
<span id="cb86-545"><a href="#cb86-545" aria-hidden="true" tabindex="-1"></a><span class="in">  as_tibble(rownames = "country") %&gt;% </span></span>
<span id="cb86-546"><a href="#cb86-546" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(country %in% countries$country) %&gt;% </span></span>
<span id="cb86-547"><a href="#cb86-547" aria-hidden="true" tabindex="-1"></a><span class="in">  select(country, starts_with("Estimate"))</span></span>
<span id="cb86-548"><a href="#cb86-548" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-549"><a href="#cb86-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-550"><a href="#cb86-550" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Visualize country-specific trends</span></span>
<span id="cb86-551"><a href="#cb86-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-552"><a href="#cb86-552" aria-hidden="true" tabindex="-1"></a>With these country-specific intercepts, we can now see that the model fits a lot better across countries. Each predicted year trend still has the same slope, but the line is shifted up and down based on the country-specific offsets. Great!</span>
<span id="cb86-553"><a href="#cb86-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-554"><a href="#cb86-554" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-preds-country, out.width="100%", fig.width=8, fig.height=5, warning=FALSE}</span></span>
<span id="cb86-555"><a href="#cb86-555" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-inset-right</span></span>
<span id="cb86-556"><a href="#cb86-556" aria-hidden="true" tabindex="-1"></a><span class="in">pred_model_country_only &lt;- model_country_only %&gt;%</span></span>
<span id="cb86-557"><a href="#cb86-557" aria-hidden="true" tabindex="-1"></a><span class="in">  epred_draws(newdata = expand_grid(country = countries$country,</span></span>
<span id="cb86-558"><a href="#cb86-558" aria-hidden="true" tabindex="-1"></a><span class="in">                                    year = unique(gapminder$year)),</span></span>
<span id="cb86-559"><a href="#cb86-559" aria-hidden="true" tabindex="-1"></a><span class="in">              re_formula = NULL) %&gt;% </span></span>
<span id="cb86-560"><a href="#cb86-560" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(year = year + 1952) %&gt;% </span></span>
<span id="cb86-561"><a href="#cb86-561" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(countries, by = "country")</span></span>
<span id="cb86-562"><a href="#cb86-562" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-563"><a href="#cb86-563" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(pred_model_country_only, aes(x = year, y = .epred)) +</span></span>
<span id="cb86-564"><a href="#cb86-564" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(data = original_points, aes(y = lifeExp), </span></span>
<span id="cb86-565"><a href="#cb86-565" aria-hidden="true" tabindex="-1"></a><span class="in">             color = "grey50", size = 3, alpha = 0.5) +</span></span>
<span id="cb86-566"><a href="#cb86-566" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_lineribbon(alpha = 0.5) +</span></span>
<span id="cb86-567"><a href="#cb86-567" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_brewer(palette = "Reds") +</span></span>
<span id="cb86-568"><a href="#cb86-568" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(title = "Intercepts for year trend vary by country",</span></span>
<span id="cb86-569"><a href="#cb86-569" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "lifeExp ~ year + (1 | country)",</span></span>
<span id="cb86-570"><a href="#cb86-570" aria-hidden="true" tabindex="-1"></a><span class="in">       x = NULL, y = "Predicted life expectancy") +</span></span>
<span id="cb86-571"><a href="#cb86-571" aria-hidden="true" tabindex="-1"></a><span class="in">  guides(fill = "none") +</span></span>
<span id="cb86-572"><a href="#cb86-572" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_nested_wrap(vars(continent, country), nrow = 2, strip = nested_settings) +</span></span>
<span id="cb86-573"><a href="#cb86-573" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_clean() +</span></span>
<span id="cb86-574"><a href="#cb86-574" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = "bottom",</span></span>
<span id="cb86-575"><a href="#cb86-575" aria-hidden="true" tabindex="-1"></a><span class="in">        plot.subtitle = element_text(family = "Consolas"),</span></span>
<span id="cb86-576"><a href="#cb86-576" aria-hidden="true" tabindex="-1"></a><span class="in">        axis.text.x = element_text(angle = 45, hjust = 0.5, vjust = 0.5))</span></span>
<span id="cb86-577"><a href="#cb86-577" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-578"><a href="#cb86-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-579"><a href="#cb86-579" aria-hidden="true" tabindex="-1"></a><span class="fu">### `r emoji::emoji("star")` Intercepts and slopes for each country `r emoji::emoji("star")`</span></span>
<span id="cb86-580"><a href="#cb86-580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-581"><a href="#cb86-581" aria-hidden="true" tabindex="-1"></a>These country-level effects are cool and fit the data fairly well, but there are still some substantial errors. The predicted lines fit Italy and Portugal pretty well, but the year trend in Yemen, Egypt, and Bolivia is steeper than predicted, while the year trend in Sierra Leone is shallower. It would be neat if we could incorporate country-specific offsets into both the intercept *and* the year trend. Fortunately, multilevel modeling lets us do this!</span>
<span id="cb86-582"><a href="#cb86-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-583"><a href="#cb86-583" aria-hidden="true" tabindex="-1"></a>We'd previously excised random country effects $b_{\text{Country}}$ from the error term $\epsilon$ and lumped them in with the fixed intercept term, creating country-specific offsets $b_{0, \text{Country}}$. We can do a similar thing and add country-specific offsets to the fixed year term too. We'll call this $b_{1, \text{Country}}$ (with a 1 subscript to show that it goes with $\beta_1$). This random term also gets its own distribution of errors with its own variation. We'll add subscripts to these $\tau$ terms so we can keep track of the intercept variance and the year trend variance.</span>
<span id="cb86-584"><a href="#cb86-584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-585"><a href="#cb86-585" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb86-586"><a href="#cb86-586" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb86-587"><a href="#cb86-587" aria-hidden="true" tabindex="-1"></a>\text{Life expectancy} &amp;= (\beta_0 + b_{0, \text{Country}}) + (\beta_1 + b_{1, \text{Country}}) \text{Year} + \epsilon <span class="sc">\\</span></span>
<span id="cb86-588"><a href="#cb86-588" aria-hidden="true" tabindex="-1"></a>b_{0, \text{Country}} &amp;\sim \mathcal{N}(0, \tau_0) <span class="sc">\\</span></span>
<span id="cb86-589"><a href="#cb86-589" aria-hidden="true" tabindex="-1"></a>b_{1, \text{Country}} &amp;\sim \mathcal{N}(0, \tau_1)</span>
<span id="cb86-590"><a href="#cb86-590" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb86-591"><a href="#cb86-591" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb86-592"><a href="#cb86-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-593"><a href="#cb86-593" aria-hidden="true" tabindex="-1"></a>The R syntax for this kind of random effects term is <span class="in">`(1 + year | country)`</span>, which means that we're letting both the intercept (<span class="in">`1`</span>) and <span class="in">`year`</span> vary by country.</span>
<span id="cb86-594"><a href="#cb86-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-595"><a href="#cb86-595" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-country-year, cache=TRUE, warning=FALSE, results="hide"}</span></span>
<span id="cb86-596"><a href="#cb86-596" aria-hidden="true" tabindex="-1"></a><span class="in"># Each country gets its own slope and intercept for the year trend</span></span>
<span id="cb86-597"><a href="#cb86-597" aria-hidden="true" tabindex="-1"></a><span class="in">model_country_year &lt;- brm(</span></span>
<span id="cb86-598"><a href="#cb86-598" aria-hidden="true" tabindex="-1"></a><span class="in">  bf(lifeExp ~ year + (1 + year | country)),</span></span>
<span id="cb86-599"><a href="#cb86-599" aria-hidden="true" tabindex="-1"></a><span class="in">  data = gapminder,</span></span>
<span id="cb86-600"><a href="#cb86-600" aria-hidden="true" tabindex="-1"></a><span class="in">  chains = 4, seed = bayes_seed,</span></span>
<span id="cb86-601"><a href="#cb86-601" aria-hidden="true" tabindex="-1"></a><span class="in">  iter = 4000  # Double the number of iterations to help with convergence</span></span>
<span id="cb86-602"><a href="#cb86-602" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb86-603"><a href="#cb86-603" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-604"><a href="#cb86-604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-605"><a href="#cb86-605" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-model-country-year}</span></span>
<span id="cb86-606"><a href="#cb86-606" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_country_year)</span></span>
<span id="cb86-607"><a href="#cb86-607" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-608"><a href="#cb86-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-609"><a href="#cb86-609" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-model-country-year, include=FALSE}</span></span>
<span id="cb86-610"><a href="#cb86-610" aria-hidden="true" tabindex="-1"></a><span class="in">m_country_year &lt;- tidy(model_country_year) %&gt;% </span></span>
<span id="cb86-611"><a href="#cb86-611" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(term = janitor::make_clean_names(term),</span></span>
<span id="cb86-612"><a href="#cb86-612" aria-hidden="true" tabindex="-1"></a><span class="in">         est = round(estimate, 2)) %&gt;% </span></span>
<span id="cb86-613"><a href="#cb86-613" aria-hidden="true" tabindex="-1"></a><span class="in">  split(~ term)</span></span>
<span id="cb86-614"><a href="#cb86-614" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-615"><a href="#cb86-615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-616"><a href="#cb86-616" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Fixed (population-level) effects</span></span>
<span id="cb86-617"><a href="#cb86-617" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-618"><a href="#cb86-618" aria-hidden="true" tabindex="-1"></a>The global population-level coefficients are once again basically the same that we've seen before: in 1952 the average life expectancy is <span class="in">`r m_country_year$intercept$est`</span> years, and it increases by <span class="in">`r m_country_year$year$est`</span> years annually after that.</span>
<span id="cb86-619"><a href="#cb86-619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-620"><a href="#cb86-620" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Country-level variation</span></span>
<span id="cb86-621"><a href="#cb86-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-622"><a href="#cb86-622" aria-hidden="true" tabindex="-1"></a>We have a couple new rows in the random parameters part of our results, though. The variance for the intercept (<span class="in">`sd__(Intercept)`</span>) corresponds to $\tau_0$ and still shows us how much life expectancy bounces around across countries. We have a new term for country-specific variation in the year effect (<span class="in">`sd__year`</span>), which corresponds to $\tau_1$. This is considerably smaller than the intercept variance, but that's because the year trend is a slope that measures the increase or decrease in life expectancy as <span class="in">`year`</span> increases. Recall that our global year trend is <span class="in">`r m_country_year$year$est`</span>. Country-specific differences imply that our trend is something like <span class="in">`r m_country_year$year$est`</span> ± <span class="in">`r m_country_year$sd_year$est`</span> standard deviations across countries. </span>
<span id="cb86-623"><a href="#cb86-623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-624"><a href="#cb86-624" aria-hidden="true" tabindex="-1"></a>Since we're assuming a normal distribution of random offsets, the distribution of all country-specific year trends looks something like this. The year trend in most countries is positive, sometimes going as high as 0.8 years of life expectancy per year:</span>
<span id="cb86-625"><a href="#cb86-625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-626"><a href="#cb86-626" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-year-slopes-country}</span></span>
<span id="cb86-627"><a href="#cb86-627" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(data = tibble(x = seq(-0.3, 1, by = 0.1)), aes(x = x)) +</span></span>
<span id="cb86-628"><a href="#cb86-628" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_function(geom = "area",</span></span>
<span id="cb86-629"><a href="#cb86-629" aria-hidden="true" tabindex="-1"></a><span class="in">                fun = dnorm, args = list(mean = 0.327, sd = 0.161),</span></span>
<span id="cb86-630"><a href="#cb86-630" aria-hidden="true" tabindex="-1"></a><span class="in">                fill = palette_okabe_ito(order = 6)) +</span></span>
<span id="cb86-631"><a href="#cb86-631" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0) +</span></span>
<span id="cb86-632"><a href="#cb86-632" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(title = "Year trend across countries",</span></span>
<span id="cb86-633"><a href="#cb86-633" aria-hidden="true" tabindex="-1"></a><span class="in">       x = "Annual increase in life expectancy") +</span></span>
<span id="cb86-634"><a href="#cb86-634" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_clean()</span></span>
<span id="cb86-635"><a href="#cb86-635" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-636"><a href="#cb86-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-637"><a href="#cb86-637" aria-hidden="true" tabindex="-1"></a>The second new parameter we have is <span class="in">`cor__(Intercept).year`</span>, which shows us the correlation of the country-specific intercepts and slopes. This is a correlation, so it ranges from −1 to 1, with 0 indicating no correlation. In this case, we see a correlation of <span class="in">`r m_country_year$cor_intercept_year$est`</span>, which is fairly strong. It indicates that countries with lower intercepts are associated with larger year trends. This makes sense—every country in the dataset sees increased life expectancy over time, and countries with a lower starting point have more room to grow and grow more quickly. Canada, for instance, starts off with high life expectancy and grows a little between 1952 and 2007, while Egypt starts off with low life expectancy and grows rapidly through 2007.</span>
<span id="cb86-638"><a href="#cb86-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-639"><a href="#cb86-639" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Country-level random effects</span></span>
<span id="cb86-640"><a href="#cb86-640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-641"><a href="#cb86-641" aria-hidden="true" tabindex="-1"></a>We can look at the country-level offsets for both the intercept and the year slope now. As before, Canada, Italy, and Portugal have intercept offsets that are substantially above the global average, while Bolivia, Yemen, and Sierra Leone are substantially below it. We can also now look at country-specific slope offsets: Egypt and Yemen have much steeper slopes than the global average, while Canada's is shallower than the global effect.</span>
<span id="cb86-642"><a href="#cb86-642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-643"><a href="#cb86-643" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-country-year-offsets}</span></span>
<span id="cb86-644"><a href="#cb86-644" aria-hidden="true" tabindex="-1"></a><span class="in">country_year_offsets &lt;- ranef(model_country_year)$country %&gt;%</span></span>
<span id="cb86-645"><a href="#cb86-645" aria-hidden="true" tabindex="-1"></a><span class="in">  as_tibble(rownames = "country") %&gt;% </span></span>
<span id="cb86-646"><a href="#cb86-646" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(country %in% countries$country) %&gt;% </span></span>
<span id="cb86-647"><a href="#cb86-647" aria-hidden="true" tabindex="-1"></a><span class="in">  select(country, starts_with("Estimate"))</span></span>
<span id="cb86-648"><a href="#cb86-648" aria-hidden="true" tabindex="-1"></a><span class="in">country_year_offsets</span></span>
<span id="cb86-649"><a href="#cb86-649" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-650"><a href="#cb86-650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-651"><a href="#cb86-651" aria-hidden="true" tabindex="-1"></a>We can also look at the already-combined fixed effect + random offset for country-specific intercepts and slopes. Notice how both the intercept and the slope is different in each country. That's magical!</span>
<span id="cb86-652"><a href="#cb86-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-653"><a href="#cb86-653" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-country-year-coefs}</span></span>
<span id="cb86-654"><a href="#cb86-654" aria-hidden="true" tabindex="-1"></a><span class="in">coef(model_country_year)$country %&gt;%</span></span>
<span id="cb86-655"><a href="#cb86-655" aria-hidden="true" tabindex="-1"></a><span class="in">  as_tibble(rownames = "country") %&gt;% </span></span>
<span id="cb86-656"><a href="#cb86-656" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(country %in% countries$country) %&gt;% </span></span>
<span id="cb86-657"><a href="#cb86-657" aria-hidden="true" tabindex="-1"></a><span class="in">  select(country, starts_with("Estimate"))</span></span>
<span id="cb86-658"><a href="#cb86-658" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-659"><a href="#cb86-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-660"><a href="#cb86-660" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Visualize country-specific intercepts and slopes</span></span>
<span id="cb86-661"><a href="#cb86-661" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-662"><a href="#cb86-662" aria-hidden="true" tabindex="-1"></a>With country-specific intercepts *and* slopes, predicted life expectancy fits really well in each country over time. Each country has a different starting point *and* grows at different rates.</span>
<span id="cb86-663"><a href="#cb86-663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-664"><a href="#cb86-664" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-preds-country-year, out.width="100%", fig.width=8, fig.height=5, warning=FALSE}</span></span>
<span id="cb86-665"><a href="#cb86-665" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-inset-right</span></span>
<span id="cb86-666"><a href="#cb86-666" aria-hidden="true" tabindex="-1"></a><span class="in">pred_model_country_year &lt;- model_country_year %&gt;%</span></span>
<span id="cb86-667"><a href="#cb86-667" aria-hidden="true" tabindex="-1"></a><span class="in">  epred_draws(newdata = expand_grid(country = countries$country,</span></span>
<span id="cb86-668"><a href="#cb86-668" aria-hidden="true" tabindex="-1"></a><span class="in">                                    year = unique(gapminder$year)),</span></span>
<span id="cb86-669"><a href="#cb86-669" aria-hidden="true" tabindex="-1"></a><span class="in">              re_formula = NULL) %&gt;% </span></span>
<span id="cb86-670"><a href="#cb86-670" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(year = year + 1952) %&gt;% </span></span>
<span id="cb86-671"><a href="#cb86-671" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(countries, by = "country")</span></span>
<span id="cb86-672"><a href="#cb86-672" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-673"><a href="#cb86-673" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(pred_model_country_year, aes(x = year, y = .epred)) +</span></span>
<span id="cb86-674"><a href="#cb86-674" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(data = original_points, aes(y = lifeExp), </span></span>
<span id="cb86-675"><a href="#cb86-675" aria-hidden="true" tabindex="-1"></a><span class="in">             color = "grey50", size = 3, alpha = 0.5) +</span></span>
<span id="cb86-676"><a href="#cb86-676" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_lineribbon(alpha = 0.5) +</span></span>
<span id="cb86-677"><a href="#cb86-677" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_brewer(palette = "Reds") +</span></span>
<span id="cb86-678"><a href="#cb86-678" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(title = "Intercepts and slopes for year trend vary by country",</span></span>
<span id="cb86-679"><a href="#cb86-679" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "lifeExp ~ year + (1 + year | country)",</span></span>
<span id="cb86-680"><a href="#cb86-680" aria-hidden="true" tabindex="-1"></a><span class="in">       x = NULL, y = "Predicted life expectancy") +</span></span>
<span id="cb86-681"><a href="#cb86-681" aria-hidden="true" tabindex="-1"></a><span class="in">  guides(fill = "none") +</span></span>
<span id="cb86-682"><a href="#cb86-682" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_nested_wrap(vars(continent, country), nrow = 2, strip = nested_settings) +</span></span>
<span id="cb86-683"><a href="#cb86-683" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_clean() +</span></span>
<span id="cb86-684"><a href="#cb86-684" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = "bottom",</span></span>
<span id="cb86-685"><a href="#cb86-685" aria-hidden="true" tabindex="-1"></a><span class="in">        plot.subtitle = element_text(family = "Consolas"),</span></span>
<span id="cb86-686"><a href="#cb86-686" aria-hidden="true" tabindex="-1"></a><span class="in">        axis.text.x = element_text(angle = 45, hjust = 0.5, vjust = 0.5))</span></span>
<span id="cb86-687"><a href="#cb86-687" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-688"><a href="#cb86-688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-689"><a href="#cb86-689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-690"><a href="#cb86-690" aria-hidden="true" tabindex="-1"></a><span class="fu">### Intercepts and slopes for each country + account for year-specific differences</span></span>
<span id="cb86-691"><a href="#cb86-691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-692"><a href="#cb86-692" aria-hidden="true" tabindex="-1"></a>Ordinarily, the <span class="in">`year + (1 + year | country)`</span> approach is sufficient for working with panel data, since the population-level year effects gets their own country-specific intercepts and slopes. However, we can do a couple extra bonus things to make our model even richer. </span>
<span id="cb86-693"><a href="#cb86-693" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-694"><a href="#cb86-694" aria-hidden="true" tabindex="-1"></a>First, we'll add extra year-specific random effects. Theoretically we'd want to do this if something happens to observations at a year-level that is completely unrelated to country-specific trends. One way to think about this is as year-based shocks to life expectancy. At around <span class="co">[</span><span class="ot">1:50 in the video at the beginning of this post</span><span class="co">](https://www.youtube.com/watch?v=Z8t4k0Q8e8Y&amp;t=110s)</span>, Hans Rosling slows down his animation to show the impact of World War I and the Spanish Flu epidemic on global life expectancy—tons of the country circles in his animation dropped dramatically. We might see something similar in the future with 2020–21 life expectancy levels too, given the COVID-19 pandemic. That sudden drop in life expectancy across all countries is an excellent example of a year-specific change that is arguably unrelated to trends in specific continents (kind of; despite its name, not all countries fought in WWI, and Spanish Flu didn't have the same effects in all countries, but whatever; just go with it).</span>
<span id="cb86-695"><a href="#cb86-695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-696"><a href="#cb86-696" aria-hidden="true" tabindex="-1"></a>To do this, we'll add independent year-based offsets to the intercept term, or $b_{0, \text{Year}}$:</span>
<span id="cb86-697"><a href="#cb86-697" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-698"><a href="#cb86-698" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb86-699"><a href="#cb86-699" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb86-700"><a href="#cb86-700" aria-hidden="true" tabindex="-1"></a>\text{Life expectancy} &amp;= (\beta_0 + b_{0, \text{Country}} + b_{0, \text{Year}}) + (\beta_1 + b_{1, \text{Country}}) \text{Year} + \epsilon <span class="sc">\\</span></span>
<span id="cb86-701"><a href="#cb86-701" aria-hidden="true" tabindex="-1"></a>b_{0, \text{Country}} &amp;\sim \mathcal{N}(0, \tau_{0, \text{Country}}) <span class="sc">\\</span></span>
<span id="cb86-702"><a href="#cb86-702" aria-hidden="true" tabindex="-1"></a>b_{1, \text{Country}} &amp;\sim \mathcal{N}(0, \tau_{1, \text{Country}}) <span class="sc">\\</span></span>
<span id="cb86-703"><a href="#cb86-703" aria-hidden="true" tabindex="-1"></a>b_{0, \text{Year}} &amp;\sim \mathcal{N}(0, \tau_{0, \text{Year}})</span>
<span id="cb86-704"><a href="#cb86-704" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb86-705"><a href="#cb86-705" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb86-706"><a href="#cb86-706" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-707"><a href="#cb86-707" aria-hidden="true" tabindex="-1"></a>The code version of this random effects structure is <span class="in">`(1 | year) + (1 + year | country)`</span>, which means that we're letting the intercept (<span class="in">`1`</span>) vary by year *and* letting both the intercept (<span class="in">`1`</span>) and <span class="in">`year`</span> vary by country. Let's see how this model looks!</span>
<span id="cb86-708"><a href="#cb86-708" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-709"><a href="#cb86-709" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-country-year-year, cache=TRUE, warning=FALSE, results="hide"}</span></span>
<span id="cb86-710"><a href="#cb86-710" aria-hidden="true" tabindex="-1"></a><span class="in"># Each country gets its own slope and intercept for the year trend</span></span>
<span id="cb86-711"><a href="#cb86-711" aria-hidden="true" tabindex="-1"></a><span class="in">model_country_year_year &lt;- brm(</span></span>
<span id="cb86-712"><a href="#cb86-712" aria-hidden="true" tabindex="-1"></a><span class="in">  bf(lifeExp ~ year + (1 | year) + (1 + year | country)),</span></span>
<span id="cb86-713"><a href="#cb86-713" aria-hidden="true" tabindex="-1"></a><span class="in">  data = gapminder,</span></span>
<span id="cb86-714"><a href="#cb86-714" aria-hidden="true" tabindex="-1"></a><span class="in">  chains = 4, seed = bayes_seed,</span></span>
<span id="cb86-715"><a href="#cb86-715" aria-hidden="true" tabindex="-1"></a><span class="in">  iter = 4000  # Double the number of iterations to help with convergence</span></span>
<span id="cb86-716"><a href="#cb86-716" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb86-717"><a href="#cb86-717" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-718"><a href="#cb86-718" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-719"><a href="#cb86-719" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-model-country-year-year}</span></span>
<span id="cb86-720"><a href="#cb86-720" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_country_year_year)</span></span>
<span id="cb86-721"><a href="#cb86-721" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-722"><a href="#cb86-722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-723"><a href="#cb86-723" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-model-country-year-year, include=FALSE}</span></span>
<span id="cb86-724"><a href="#cb86-724" aria-hidden="true" tabindex="-1"></a><span class="in">m_country_year_year &lt;- tidy(model_country_year_year) %&gt;% </span></span>
<span id="cb86-725"><a href="#cb86-725" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(term = janitor::make_clean_names(term),</span></span>
<span id="cb86-726"><a href="#cb86-726" aria-hidden="true" tabindex="-1"></a><span class="in">         est = round(estimate, 2)) %&gt;% </span></span>
<span id="cb86-727"><a href="#cb86-727" aria-hidden="true" tabindex="-1"></a><span class="in">  split(~ term)</span></span>
<span id="cb86-728"><a href="#cb86-728" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-729"><a href="#cb86-729" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-730"><a href="#cb86-730" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Fixed (population-level) effects</span></span>
<span id="cb86-731"><a href="#cb86-731" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-732"><a href="#cb86-732" aria-hidden="true" tabindex="-1"></a>As always, the global population-level coefficients are the same that we've seen before: in 1952 the average life expectancy is <span class="in">`r m_country_year_year$intercept$est`</span> years, and it increases by <span class="in">`r m_country_year_year$year$est`</span> years annually after that.</span>
<span id="cb86-733"><a href="#cb86-733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-734"><a href="#cb86-734" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Country-level variation</span></span>
<span id="cb86-735"><a href="#cb86-735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-736"><a href="#cb86-736" aria-hidden="true" tabindex="-1"></a>The random effects section of our model results is getting longer and longer! We still have the variation in our country-based intercepts and year slopes, and we have the correlation between these country-based offsets. We also have a new term: <span class="in">`sd__(Intercept)`</span> for the <span class="in">`year`</span> group, which corresponds to $\tau_{0, \text{Year}}$ in the year-specific level of the model. This shows us how much life expectancy bounces around from year to year.</span>
<span id="cb86-737"><a href="#cb86-737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-738"><a href="#cb86-738" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Year-level random effects</span></span>
<span id="cb86-739"><a href="#cb86-739" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-740"><a href="#cb86-740" aria-hidden="true" tabindex="-1"></a>We can look at these new year-level offsets for the intercept using <span class="in">`ranef()`</span> (but this time extracting data from the <span class="in">`$year`</span> slot of the results). For whatever reason, average life expectancy in 1952 is nearly 1.5 years lower than the population-level average, but more than 1 year higher in the 1980s. If the Gapminder data went back further in time to the 1910s, we'd probably see a huge negative offset due to World War I and the Spanish Flu. </span>
<span id="cb86-741"><a href="#cb86-741" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-742"><a href="#cb86-742" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-country-year-year-offsets}</span></span>
<span id="cb86-743"><a href="#cb86-743" aria-hidden="true" tabindex="-1"></a><span class="in">year_offsets &lt;- ranef(model_country_year_year)$year %&gt;%</span></span>
<span id="cb86-744"><a href="#cb86-744" aria-hidden="true" tabindex="-1"></a><span class="in">  as_tibble(rownames = "year") %&gt;% </span></span>
<span id="cb86-745"><a href="#cb86-745" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(year = as.numeric(year) + 1952) %&gt;% </span></span>
<span id="cb86-746"><a href="#cb86-746" aria-hidden="true" tabindex="-1"></a><span class="in">  select(year, starts_with("Estimate"))</span></span>
<span id="cb86-747"><a href="#cb86-747" aria-hidden="true" tabindex="-1"></a><span class="in">year_offsets</span></span>
<span id="cb86-748"><a href="#cb86-748" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-749"><a href="#cb86-749" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-750"><a href="#cb86-750" aria-hidden="true" tabindex="-1"></a>Where this gets really interesting is when we incorporate these different year offsets into the overall model estimate of the year trend. We can use <span class="in">`emtrends()`</span> to calculate the predicted year slope for each of our example countries in both 1952 and 1957 (<span class="in">`year = 0`</span> and <span class="in">`year = 5`</span>):</span>
<span id="cb86-751"><a href="#cb86-751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-752"><a href="#cb86-752" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-country-year-year-trends}</span></span>
<span id="cb86-753"><a href="#cb86-753" aria-hidden="true" tabindex="-1"></a><span class="in">model_country_year_year %&gt;% </span></span>
<span id="cb86-754"><a href="#cb86-754" aria-hidden="true" tabindex="-1"></a><span class="in">  emtrends(~ year + country,</span></span>
<span id="cb86-755"><a href="#cb86-755" aria-hidden="true" tabindex="-1"></a><span class="in">           var = "year",</span></span>
<span id="cb86-756"><a href="#cb86-756" aria-hidden="true" tabindex="-1"></a><span class="in">           at = list(year = c(0, 5), country = countries$country),</span></span>
<span id="cb86-757"><a href="#cb86-757" aria-hidden="true" tabindex="-1"></a><span class="in">           epred = TRUE, re_formula = NULL, allow_new_levels = TRUE)</span></span>
<span id="cb86-758"><a href="#cb86-758" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-759"><a href="#cb86-759" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-760"><a href="#cb86-760" aria-hidden="true" tabindex="-1"></a>Notice how the slope of year now changes based on country *and* on year—it's different (and sizably smaller) in 1957. </span>
<span id="cb86-761"><a href="#cb86-761" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-762"><a href="#cb86-762" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Visualize country-specific intercepts and slopes and year-specific intercepts</span></span>
<span id="cb86-763"><a href="#cb86-763" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-764"><a href="#cb86-764" aria-hidden="true" tabindex="-1"></a>These year shocks are apparent when we plot predicted life expectancy. Each country gets its own slope and intercept like before, but now the intercept is also shifted up and down in specific years. Note how all these lines start getting a little shallower in the 1990s—something happened worldwide to shift average life expectancy outside of continent-level effects.</span>
<span id="cb86-765"><a href="#cb86-765" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-766"><a href="#cb86-766" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-preds-country-year-year, out.width="100%", fig.width=8, fig.height=5, warning=FALSE}</span></span>
<span id="cb86-767"><a href="#cb86-767" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-inset-right</span></span>
<span id="cb86-768"><a href="#cb86-768" aria-hidden="true" tabindex="-1"></a><span class="in">pred_model_country_year_year &lt;- model_country_year_year %&gt;%</span></span>
<span id="cb86-769"><a href="#cb86-769" aria-hidden="true" tabindex="-1"></a><span class="in">  epred_draws(newdata = expand_grid(country = countries$country,</span></span>
<span id="cb86-770"><a href="#cb86-770" aria-hidden="true" tabindex="-1"></a><span class="in">                                    year = unique(gapminder$year)),</span></span>
<span id="cb86-771"><a href="#cb86-771" aria-hidden="true" tabindex="-1"></a><span class="in">              re_formula = NULL) %&gt;% </span></span>
<span id="cb86-772"><a href="#cb86-772" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(year = year + 1952) %&gt;% </span></span>
<span id="cb86-773"><a href="#cb86-773" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(countries, by = "country")</span></span>
<span id="cb86-774"><a href="#cb86-774" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-775"><a href="#cb86-775" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(pred_model_country_year_year, aes(x = year, y = .epred)) +</span></span>
<span id="cb86-776"><a href="#cb86-776" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(data = original_points, aes(y = lifeExp), </span></span>
<span id="cb86-777"><a href="#cb86-777" aria-hidden="true" tabindex="-1"></a><span class="in">             color = "grey50", size = 3, alpha = 0.5) +</span></span>
<span id="cb86-778"><a href="#cb86-778" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_lineribbon(alpha = 0.5) +</span></span>
<span id="cb86-779"><a href="#cb86-779" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_brewer(palette = "Reds") +</span></span>
<span id="cb86-780"><a href="#cb86-780" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(title = "Intercepts and slopes for year trend vary by country and intercepts vary by year",</span></span>
<span id="cb86-781"><a href="#cb86-781" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "lifeExp ~ year + (1 | year) + (1 + year | country)",</span></span>
<span id="cb86-782"><a href="#cb86-782" aria-hidden="true" tabindex="-1"></a><span class="in">       x = NULL, y = "Predicted life expectancy") +</span></span>
<span id="cb86-783"><a href="#cb86-783" aria-hidden="true" tabindex="-1"></a><span class="in">  guides(fill = "none") +</span></span>
<span id="cb86-784"><a href="#cb86-784" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_nested_wrap(vars(continent, country), nrow = 2, strip = nested_settings) +</span></span>
<span id="cb86-785"><a href="#cb86-785" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_clean() +</span></span>
<span id="cb86-786"><a href="#cb86-786" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = "bottom",</span></span>
<span id="cb86-787"><a href="#cb86-787" aria-hidden="true" tabindex="-1"></a><span class="in">        plot.subtitle = element_text(family = "Consolas"),</span></span>
<span id="cb86-788"><a href="#cb86-788" aria-hidden="true" tabindex="-1"></a><span class="in">        axis.text.x = element_text(angle = 45, hjust = 0.5, vjust = 0.5))</span></span>
<span id="cb86-789"><a href="#cb86-789" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-790"><a href="#cb86-790" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-791"><a href="#cb86-791" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-792"><a href="#cb86-792" aria-hidden="true" tabindex="-1"></a><span class="fu">### Intercepts and slopes for each country and continent</span></span>
<span id="cb86-793"><a href="#cb86-793" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-794"><a href="#cb86-794" aria-hidden="true" tabindex="-1"></a>For our second bonus extension, we can incorporate random continent effects, since countries are nested in continents. This is probably overkill for this example, but it would be helpful in other situations with nested data structures.</span>
<span id="cb86-795"><a href="#cb86-795" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-796"><a href="#cb86-796" aria-hidden="true" tabindex="-1"></a>In this case, we're adding continent-specific effects *and* country-specific effects that incorporate information about parent continents. We end up with four different $b$ terms:</span>
<span id="cb86-797"><a href="#cb86-797" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-798"><a href="#cb86-798" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$b_{0, \text{Continent}}$: Continent-based shifts in the intercept</span>
<span id="cb86-799"><a href="#cb86-799" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$b_{0, \text{Continent, Country}}$: Country-within-continent-based shifts in the intercept</span>
<span id="cb86-800"><a href="#cb86-800" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$b_{1, \text{Continent}}$: Continent-based shifts in the year slope</span>
<span id="cb86-801"><a href="#cb86-801" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$b_{1, \text{Continent, Country}}$: Country-within-continent-based shifts in the year slope</span>
<span id="cb86-802"><a href="#cb86-802" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-803"><a href="#cb86-803" aria-hidden="true" tabindex="-1"></a>Each of these group terms also has its own variance term ($\tau$) like the other models—I'm not including them below, but pretend they exist.</span>
<span id="cb86-804"><a href="#cb86-804" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-805"><a href="#cb86-805" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb86-806"><a href="#cb86-806" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb86-807"><a href="#cb86-807" aria-hidden="true" tabindex="-1"></a>\text{Life expectancy} =&amp;\ (\beta_0 + b_{0, \text{Continent}} + b_{0, \text{Continent, Country}}) + <span class="sc">\\</span></span>
<span id="cb86-808"><a href="#cb86-808" aria-hidden="true" tabindex="-1"></a>&amp;\ (\beta_1 + b_{1, \text{Continent}} + b_{1, \text{Continent, Country}}) \text{Year} + \epsilon</span>
<span id="cb86-809"><a href="#cb86-809" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb86-810"><a href="#cb86-810" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb86-811"><a href="#cb86-811" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-812"><a href="#cb86-812" aria-hidden="true" tabindex="-1"></a>The code version of this nested random effects structure is <span class="in">`(1 + year | continent / country)`</span>.</span>
<span id="cb86-813"><a href="#cb86-813" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-814"><a href="#cb86-814" aria-hidden="true" tabindex="-1"></a>**However**, we won't actually fit this model here, since it takes 10+ minutes to run (likely because I'm using all the default priors). If we were fitting the model, the code would look like this:</span>
<span id="cb86-815"><a href="#cb86-815" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-816"><a href="#cb86-816" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-country-continent-year, eval=FALSE, warning=FALSE, results="hide"}</span></span>
<span id="cb86-817"><a href="#cb86-817" aria-hidden="true" tabindex="-1"></a><span class="in"># This takes a while! It also has a bunch of divergent transitions, and pretty</span></span>
<span id="cb86-818"><a href="#cb86-818" aria-hidden="true" tabindex="-1"></a><span class="in"># much all the chains hit the maximum treedepth limit, but this is just a toy</span></span>
<span id="cb86-819"><a href="#cb86-819" aria-hidden="true" tabindex="-1"></a><span class="in"># example, so whatever</span></span>
<span id="cb86-820"><a href="#cb86-820" aria-hidden="true" tabindex="-1"></a><span class="in">model_country_continent_year &lt;- brm(</span></span>
<span id="cb86-821"><a href="#cb86-821" aria-hidden="true" tabindex="-1"></a><span class="in">  bf(lifeExp ~ year + (1 + year | continent / country)),</span></span>
<span id="cb86-822"><a href="#cb86-822" aria-hidden="true" tabindex="-1"></a><span class="in">  data = gapminder,</span></span>
<span id="cb86-823"><a href="#cb86-823" aria-hidden="true" tabindex="-1"></a><span class="in">  chains = 4, seed = bayes_seed,</span></span>
<span id="cb86-824"><a href="#cb86-824" aria-hidden="true" tabindex="-1"></a><span class="in">  iter = 4000  # Double the number of iterations to help with convergence</span></span>
<span id="cb86-825"><a href="#cb86-825" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb86-826"><a href="#cb86-826" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-827"><a href="#cb86-827" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-828"><a href="#cb86-828" aria-hidden="true" tabindex="-1"></a><span class="in">```{r emmeans-model-country-continent-year, eval=FALSE}</span></span>
<span id="cb86-829"><a href="#cb86-829" aria-hidden="true" tabindex="-1"></a><span class="in"># You'd use this to calculate the continent/country effects</span></span>
<span id="cb86-830"><a href="#cb86-830" aria-hidden="true" tabindex="-1"></a><span class="in">model_country_continent_year %&gt;%</span></span>
<span id="cb86-831"><a href="#cb86-831" aria-hidden="true" tabindex="-1"></a><span class="in">  emmeans(~ year + continent:country,</span></span>
<span id="cb86-832"><a href="#cb86-832" aria-hidden="true" tabindex="-1"></a><span class="in">          at = list(year = c(0), country = countries$country),</span></span>
<span id="cb86-833"><a href="#cb86-833" aria-hidden="true" tabindex="-1"></a><span class="in">          nesting = "country %in% continent",</span></span>
<span id="cb86-834"><a href="#cb86-834" aria-hidden="true" tabindex="-1"></a><span class="in">          epred = TRUE, re_formula = NULL, allow_new_levels = TRUE)</span></span>
<span id="cb86-835"><a href="#cb86-835" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-836"><a href="#cb86-836" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-837"><a href="#cb86-837" aria-hidden="true" tabindex="-1"></a>The model results include a bunch of new group-level terms. We get estimates for all the group-specific variances (the $\tau$s), listed as <span class="in">`sd__(Intercept)`</span> and <span class="in">`sd__year`</span> for both continent and country-in-continent. We also get the correlation between continent-level offsets and year *and* country-in-continent-level offsets and year. </span>
<span id="cb86-838"><a href="#cb86-838" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-839"><a href="#cb86-839" aria-hidden="true" tabindex="-1"></a>Again, this kind of complexity is probably overkill for this situation, since country-specific offsets seem to work just fine on their own without needing broader continent-level trends. But it's a neat approach to thinking about hierarchy in the model.</span>
<span id="cb86-840"><a href="#cb86-840" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-841"><a href="#cb86-841" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-842"><a href="#cb86-842" aria-hidden="true" tabindex="-1"></a><span class="fu">## Quick digression on logging, scaling, and centering</span></span>
<span id="cb86-843"><a href="#cb86-843" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-844"><a href="#cb86-844" aria-hidden="true" tabindex="-1"></a>Part of the reason the countries-nested-in-continents model takes so long to fit and runs into so many warnings and divergences is because the columns we used have values that are too large and that are distributed non-normally.</span>
<span id="cb86-845"><a href="#cb86-845" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-846"><a href="#cb86-846" aria-hidden="true" tabindex="-1"></a>Bayesian sampling in Stan (through **brms**) works best and fastest when the ranges of covariates are small and centered around zero. We've been using year centered at 1952 (so that year 0 is 1952), and the max year in the data is 2007 (or 55), and even with that, we're probably pushing the envelope of what Stan likes to work with.</span>
<span id="cb86-847"><a href="#cb86-847" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-848"><a href="#cb86-848" aria-hidden="true" tabindex="-1"></a>For our main question, we want to know the relationship between GDP per capita and life expectancy. GDP per capita has a huge range with huge values. Some countries have a GDP per capita of <span class="sc">\\</span>$1,000; some have <span class="sc">\\</span>$40,000 or <span class="sc">\\</span>$50,000. To make these models run quickly (and actually fit and converge), we need to shrink those values down.</span>
<span id="cb86-849"><a href="#cb86-849" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-850"><a href="#cb86-850" aria-hidden="true" tabindex="-1"></a>We can do this in a few different ways, each with their own benefits and quirks of interpretation, which we'll explore really quick.</span>
<span id="cb86-851"><a href="#cb86-851" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-852"><a href="#cb86-852" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Divide by 1,000** (or any amount, really)</span>
<span id="cb86-853"><a href="#cb86-853" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Scale and center**</span>
<span id="cb86-854"><a href="#cb86-854" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Log**</span>
<span id="cb86-855"><a href="#cb86-855" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Log + scale and center**</span>
<span id="cb86-856"><a href="#cb86-856" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-857"><a href="#cb86-857" aria-hidden="true" tabindex="-1"></a>Here's what the distributions of these different scaling approaches look like. Notice how all the red GDP per capita distributions are identical. The per-1000 version is shrunken down so that most values are between 0 and 30 instead of 3 and 30,000, while the centered and scaled version ranges from ≈−0.5 and 8, with 0 in the middle of the distribution. The two logged versions are also identical—the original logged GDP per capita ranges from ≈5.5–11.5 (or <span class="in">`exp(5.5)`</span> (<span class="in">`r dollar(exp(5), accuracy = 1)`</span>) to <span class="in">`exp(11.5)`</span> (<span class="in">`r dollar(exp(11.5), accuracy = 1)`</span>)), while the centered and scaled version ranges from −2 to 3, centered at 0.</span>
<span id="cb86-858"><a href="#cb86-858" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-859"><a href="#cb86-859" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-different-scalings, fig.width=8, fig.height=5, out.width="100%"}</span></span>
<span id="cb86-860"><a href="#cb86-860" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-inset-right</span></span>
<span id="cb86-861"><a href="#cb86-861" aria-hidden="true" tabindex="-1"></a><span class="in">different_gdps &lt;- gapminder %&gt;% </span></span>
<span id="cb86-862"><a href="#cb86-862" aria-hidden="true" tabindex="-1"></a><span class="in">  select(gdpPercap, gdpPercap_1000, gdpPercap_z, gdpPercap_log, gdpPercap_log_z) %&gt;% </span></span>
<span id="cb86-863"><a href="#cb86-863" aria-hidden="true" tabindex="-1"></a><span class="in">  pivot_longer(everything()) %&gt;% </span></span>
<span id="cb86-864"><a href="#cb86-864" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(name_nice = recode(</span></span>
<span id="cb86-865"><a href="#cb86-865" aria-hidden="true" tabindex="-1"></a><span class="in">    name, "gdpPercap" = "GDP per capita",</span></span>
<span id="cb86-866"><a href="#cb86-866" aria-hidden="true" tabindex="-1"></a><span class="in">    "gdpPercap_1000" = "GDP per capita ($1,000)",</span></span>
<span id="cb86-867"><a href="#cb86-867" aria-hidden="true" tabindex="-1"></a><span class="in">    "gdpPercap_z" = "GDP per capita (centered &amp; scaled by one standard deviation)",</span></span>
<span id="cb86-868"><a href="#cb86-868" aria-hidden="true" tabindex="-1"></a><span class="in">    "gdpPercap_log" = "GDP per capita (logged)",</span></span>
<span id="cb86-869"><a href="#cb86-869" aria-hidden="true" tabindex="-1"></a><span class="in">    "gdpPercap_log_z" = "GDP per capita (logged; centered &amp; scaled by one standard deviation)")) %&gt;% </span></span>
<span id="cb86-870"><a href="#cb86-870" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(name_nice = fct_inorder(name_nice)) %&gt;% </span></span>
<span id="cb86-871"><a href="#cb86-871" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(type = ifelse(str_detect(name, "log"), "Logged", "Original scale")) %&gt;% </span></span>
<span id="cb86-872"><a href="#cb86-872" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(vline = ifelse(name == "gdpPercap_log", NA, 0))</span></span>
<span id="cb86-873"><a href="#cb86-873" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-874"><a href="#cb86-874" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(different_gdps, aes(x = value, fill = type)) +</span></span>
<span id="cb86-875"><a href="#cb86-875" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_density(color = NA) +</span></span>
<span id="cb86-876"><a href="#cb86-876" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(data = different_gdps %&gt;% drop_na(vline) %&gt;% </span></span>
<span id="cb86-877"><a href="#cb86-877" aria-hidden="true" tabindex="-1"></a><span class="in">               group_by(name_nice) %&gt;% slice(1),</span></span>
<span id="cb86-878"><a href="#cb86-878" aria-hidden="true" tabindex="-1"></a><span class="in">             aes(xintercept = vline)) +</span></span>
<span id="cb86-879"><a href="#cb86-879" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_viridis_d(option = "rocket", begin = 0.3, end = 0.6) +</span></span>
<span id="cb86-880"><a href="#cb86-880" aria-hidden="true" tabindex="-1"></a><span class="in">  guides(fill = "none") +</span></span>
<span id="cb86-881"><a href="#cb86-881" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = NULL, y = NULL) +</span></span>
<span id="cb86-882"><a href="#cb86-882" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(vars(name_nice), nrow = 3, scales = "free", dir = "v") +</span></span>
<span id="cb86-883"><a href="#cb86-883" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_clean()</span></span>
<span id="cb86-884"><a href="#cb86-884" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-885"><a href="#cb86-885" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-886"><a href="#cb86-886" aria-hidden="true" tabindex="-1"></a><span class="fu">### Scaling and centering</span></span>
<span id="cb86-887"><a href="#cb86-887" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-888"><a href="#cb86-888" aria-hidden="true" tabindex="-1"></a><span class="fu">#### 1: Divide by 1,000</span></span>
<span id="cb86-889"><a href="#cb86-889" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-890"><a href="#cb86-890" aria-hidden="true" tabindex="-1"></a>One quick and easy way to shrink the GDP values down is to divide them all by some arbitrary number like 1,000 so that we work with GDP per capita in thousands of dollars. A country with a GDP per capita of <span class="sc">\\</span>$2,000 would thus have a value of 2, and so on. Often this kind of downscaling is enough to make Stan happy, and it makes for easily interpretable results. We can interpret coefficients by saying "A <span class="sc">\\</span>$1,000 increase in GDP per capita is associated with a $\beta$ increase in life expectancy," and if we really wanted, we could divide the coefficient by 1,000 to shrink it back down to the original scale and talk about <span class="sc">\\</span>$1 increases in GDP per capita.</span>
<span id="cb86-891"><a href="#cb86-891" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-892"><a href="#cb86-892" aria-hidden="true" tabindex="-1"></a><span class="fu">#### 2: Scale and center</span></span>
<span id="cb86-893"><a href="#cb86-893" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-894"><a href="#cb86-894" aria-hidden="true" tabindex="-1"></a>A better alternative that requires a little bit more post-estimation finagling is to rescale the column by subtracting the mean so that it is centered at 0, and then dividing by the standard deviation. R's built-in <span class="in">`scale()`</span> function does this for us. There's no built-in <span class="in">`unscale()`</span> function to back-transform the values to their original numbers, but we can use a little algebra to see how to unscale the values: multiply by the standard deviation and add the mean. As long as we have a mean and standard deviation, we can flip between scaled and original values:</span>
<span id="cb86-895"><a href="#cb86-895" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-896"><a href="#cb86-896" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb86-897"><a href="#cb86-897" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb86-898"><a href="#cb86-898" aria-hidden="true" tabindex="-1"></a>\text{Scaled value}\ &amp;=\ \frac{\text{Original value} - \text{Mean}}{\text{Standard deviation}} <span class="sc">\\\\</span></span>
<span id="cb86-899"><a href="#cb86-899" aria-hidden="true" tabindex="-1"></a>\text{Original value}\ &amp;=\ (\text{Scaled value } \times \text{ Standard deviation})\ + \text{Mean}</span>
<span id="cb86-900"><a href="#cb86-900" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb86-901"><a href="#cb86-901" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb86-902"><a href="#cb86-902" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-903"><a href="#cb86-903" aria-hidden="true" tabindex="-1"></a>The <span class="in">`scale()`</span> function in R doesn't return a regular set of values. For convenience, it stores the mean and standard deviation of the values as a special kind of metadata called "attributes" in slots named <span class="in">`scaled:center`</span> (for the mean) and <span class="in">`scaled:scale`</span> (for the standard deviation):</span>
<span id="cb86-904"><a href="#cb86-904" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-905"><a href="#cb86-905" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eg-scale-numbers}</span></span>
<span id="cb86-906"><a href="#cb86-906" aria-hidden="true" tabindex="-1"></a><span class="in">some_numbers &lt;- 1:5</span></span>
<span id="cb86-907"><a href="#cb86-907" aria-hidden="true" tabindex="-1"></a><span class="in">scaled_numbers &lt;- scale(some_numbers)</span></span>
<span id="cb86-908"><a href="#cb86-908" aria-hidden="true" tabindex="-1"></a><span class="in">scaled_numbers</span></span>
<span id="cb86-909"><a href="#cb86-909" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-910"><a href="#cb86-910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-911"><a href="#cb86-911" aria-hidden="true" tabindex="-1"></a>We can access and extract those attributes with the <span class="in">`attributes`</span> function, which converts them to a more easily accessible list. Note that when we reference <span class="in">`scaled:center`</span> or <span class="in">`scaled:scale`</span> we have to use backticks around the names—that's because the <span class="in">`:`</span> character isn't normally allowed as an object name:</span>
<span id="cb86-912"><a href="#cb86-912" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-913"><a href="#cb86-913" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eg-extract-attributes}</span></span>
<span id="cb86-914"><a href="#cb86-914" aria-hidden="true" tabindex="-1"></a><span class="in">scaled_numbers_mean_sd &lt;- attributes(scaled_numbers)</span></span>
<span id="cb86-915"><a href="#cb86-915" aria-hidden="true" tabindex="-1"></a><span class="in">scaled_numbers_mean_sd</span></span>
<span id="cb86-916"><a href="#cb86-916" aria-hidden="true" tabindex="-1"></a><span class="in">scaled_numbers_mean_sd$`scaled:center`</span></span>
<span id="cb86-917"><a href="#cb86-917" aria-hidden="true" tabindex="-1"></a><span class="in">scaled_numbers_mean_sd$`scaled:scale`</span></span>
<span id="cb86-918"><a href="#cb86-918" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-919"><a href="#cb86-919" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-920"><a href="#cb86-920" aria-hidden="true" tabindex="-1"></a>To unscale <span class="in">`some_numbers`</span>, we can multiply by the standard deviation and add the mean:</span>
<span id="cb86-921"><a href="#cb86-921" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-922"><a href="#cb86-922" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eg-unscale}</span></span>
<span id="cb86-923"><a href="#cb86-923" aria-hidden="true" tabindex="-1"></a><span class="in">(scaled_numbers * scaled_numbers_mean_sd$`scaled:scale`) +</span></span>
<span id="cb86-924"><a href="#cb86-924" aria-hidden="true" tabindex="-1"></a><span class="in">  scaled_numbers_mean_sd$`scaled:center`</span></span>
<span id="cb86-925"><a href="#cb86-925" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-926"><a href="#cb86-926" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-927"><a href="#cb86-927" aria-hidden="true" tabindex="-1"></a>The same thing works with the actual data. When we initially loaded and cleaned the data, we used <span class="in">`scale()`</span> to scale down all the different GDP columns to versions with a <span class="in">`_z`</span> suffix, and we can see that they're all a little different from the other columns:</span>
<span id="cb86-928"><a href="#cb86-928" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-929"><a href="#cb86-929" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eg-show-gdp-gapminder}</span></span>
<span id="cb86-930"><a href="#cb86-930" aria-hidden="true" tabindex="-1"></a><span class="in">glimpse(gapminder)</span></span>
<span id="cb86-931"><a href="#cb86-931" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-932"><a href="#cb86-932" aria-hidden="true" tabindex="-1"></a><span class="in">gapminder %&gt;% </span></span>
<span id="cb86-933"><a href="#cb86-933" aria-hidden="true" tabindex="-1"></a><span class="in">  select(country, continent, year_orig, gdpPercap, gdpPercap_z) %&gt;% </span></span>
<span id="cb86-934"><a href="#cb86-934" aria-hidden="true" tabindex="-1"></a><span class="in">  head()</span></span>
<span id="cb86-935"><a href="#cb86-935" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-936"><a href="#cb86-936" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-937"><a href="#cb86-937" aria-hidden="true" tabindex="-1"></a>That's because (1) <span class="in">`scale()`</span> returns values as a 1-column matrix for whatever reason, and (2) the special mean and standard deviation metadata attributes are stored in that matrix. We can access those attributes like normal:</span>
<span id="cb86-938"><a href="#cb86-938" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-939"><a href="#cb86-939" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eg-extract-gdp-attributes}</span></span>
<span id="cb86-940"><a href="#cb86-940" aria-hidden="true" tabindex="-1"></a><span class="in">gdp_mean_sd &lt;- attributes(gapminder$gdpPercap_z)</span></span>
<span id="cb86-941"><a href="#cb86-941" aria-hidden="true" tabindex="-1"></a><span class="in">gdp_mean_sd</span></span>
<span id="cb86-942"><a href="#cb86-942" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-943"><a href="#cb86-943" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-944"><a href="#cb86-944" aria-hidden="true" tabindex="-1"></a>Just for fun, we can verify that these values are the same as the average and standard deviation of GDP per capita:</span>
<span id="cb86-945"><a href="#cb86-945" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-946"><a href="#cb86-946" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eg-show-gapminder-mean-sd}</span></span>
<span id="cb86-947"><a href="#cb86-947" aria-hidden="true" tabindex="-1"></a><span class="in">gapminder %&gt;% </span></span>
<span id="cb86-948"><a href="#cb86-948" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(avg = mean(gdpPercap),</span></span>
<span id="cb86-949"><a href="#cb86-949" aria-hidden="true" tabindex="-1"></a><span class="in">            sd = sd(gdpPercap))</span></span>
<span id="cb86-950"><a href="#cb86-950" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-951"><a href="#cb86-951" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-952"><a href="#cb86-952" aria-hidden="true" tabindex="-1"></a>They're the same!</span>
<span id="cb86-953"><a href="#cb86-953" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-954"><a href="#cb86-954" aria-hidden="true" tabindex="-1"></a>To make sure that we really can scale and unscale this stuff, let's look at the first few rows of the data and multiply the scaled <span class="in">`gdpPercap_z`</span> column by the attributes we extracted:</span>
<span id="cb86-955"><a href="#cb86-955" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-956"><a href="#cb86-956" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eg-unscale-gdp}</span></span>
<span id="cb86-957"><a href="#cb86-957" aria-hidden="true" tabindex="-1"></a><span class="in">gapminder %&gt;% </span></span>
<span id="cb86-958"><a href="#cb86-958" aria-hidden="true" tabindex="-1"></a><span class="in">  slice(1:5) %&gt;% </span></span>
<span id="cb86-959"><a href="#cb86-959" aria-hidden="true" tabindex="-1"></a><span class="in">  select(gdpPercap, gdpPercap_z) %&gt;% </span></span>
<span id="cb86-960"><a href="#cb86-960" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(unscaled = gdpPercap_z * gdp_mean_sd$`scaled:scale` + gdp_mean_sd$`scaled:center`)</span></span>
<span id="cb86-961"><a href="#cb86-961" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-962"><a href="#cb86-962" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-963"><a href="#cb86-963" aria-hidden="true" tabindex="-1"></a>They're the same!</span>
<span id="cb86-964"><a href="#cb86-964" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-965"><a href="#cb86-965" aria-hidden="true" tabindex="-1"></a>Unscaling regression coefficients is a little different. We don't need to add the mean, since we're working with marginal effects (i.e. the effect of adding one additional dollar of GDP per capita), and instead of multiplying by the standard deviation, we divide by it. Once again, just to make sure we can unscale correctly, we can run a couple models: one with GDP per capita in the thousands, and one with the scaled and centered GDP per capita. In theory, if we divide the coefficient from the second model by the standard deviation and multiply it by 1,000 (to scaled it up so it shows GDP per capita in the thousands), we'll get the same value:</span>
<span id="cb86-966"><a href="#cb86-966" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-967"><a href="#cb86-967" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eg-gdp-coef-unscale}</span></span>
<span id="cb86-968"><a href="#cb86-968" aria-hidden="true" tabindex="-1"></a><span class="in">model_super_simple &lt;- lm(lifeExp ~ gdpPercap_1000, data = gapminder)</span></span>
<span id="cb86-969"><a href="#cb86-969" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_super_simple)  # 0.755</span></span>
<span id="cb86-970"><a href="#cb86-970" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-971"><a href="#cb86-971" aria-hidden="true" tabindex="-1"></a><span class="in">model_super_simple_z &lt;- lm(lifeExp ~ gdpPercap_z, data = gapminder)</span></span>
<span id="cb86-972"><a href="#cb86-972" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_super_simple_z)  # 7.41</span></span>
<span id="cb86-973"><a href="#cb86-973" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-974"><a href="#cb86-974" aria-hidden="true" tabindex="-1"></a><span class="in"># Can we get the 7.41 coefficient from the centered/scaled model to turn into</span></span>
<span id="cb86-975"><a href="#cb86-975" aria-hidden="true" tabindex="-1"></a><span class="in"># 0.755 from the original model?</span></span>
<span id="cb86-976"><a href="#cb86-976" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_super_simple_z) %&gt;% </span></span>
<span id="cb86-977"><a href="#cb86-977" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(term == "gdpPercap_z") %&gt;% </span></span>
<span id="cb86-978"><a href="#cb86-978" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(estimate_unscaled_1000 = estimate / gdp_mean_sd$`scaled:scale` * 1000)</span></span>
<span id="cb86-979"><a href="#cb86-979" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-980"><a href="#cb86-980" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-981"><a href="#cb86-981" aria-hidden="true" tabindex="-1"></a>They're the same!</span>
<span id="cb86-982"><a href="#cb86-982" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-983"><a href="#cb86-983" aria-hidden="true" tabindex="-1"></a><span class="fu">### Logging</span></span>
<span id="cb86-984"><a href="#cb86-984" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-985"><a href="#cb86-985" aria-hidden="true" tabindex="-1"></a><span class="fu">#### 3: Log</span></span>
<span id="cb86-986"><a href="#cb86-986" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-987"><a href="#cb86-987" aria-hidden="true" tabindex="-1"></a>Stan also seems to like to work with more normally distributed variables. With GDP per capita, lots of countries have a low value, and a few have really high values, resulting in a skewed distribution that can sometimes cause issues when sampling. To address this, we can take the log of GDP per capita and think about changes in orders of magnitude (i.e. moving from <span class="sc">\\</span>$300 to <span class="sc">\\</span>$3,000 to <span class="sc">\\</span>$30,000, and so on) rather than linear changes. Back-transforming logged values is easy—exponentiate the value (i.e. $e^\text{logged value}$) if you're using a natural log, which is what R does by default when you use <span class="in">`log()`</span>:</span>
<span id="cb86-988"><a href="#cb86-988" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-989"><a href="#cb86-989" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eg-log-unlog}</span></span>
<span id="cb86-990"><a href="#cb86-990" aria-hidden="true" tabindex="-1"></a><span class="in">log(5000)</span></span>
<span id="cb86-991"><a href="#cb86-991" aria-hidden="true" tabindex="-1"></a><span class="in">exp(log(5000))</span></span>
<span id="cb86-992"><a href="#cb86-992" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-993"><a href="#cb86-993" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-994"><a href="#cb86-994" aria-hidden="true" tabindex="-1"></a>We can verify this works with our data:</span>
<span id="cb86-995"><a href="#cb86-995" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-996"><a href="#cb86-996" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eg-unlog-gdp}</span></span>
<span id="cb86-997"><a href="#cb86-997" aria-hidden="true" tabindex="-1"></a><span class="in">gapminder %&gt;% </span></span>
<span id="cb86-998"><a href="#cb86-998" aria-hidden="true" tabindex="-1"></a><span class="in">  slice(1:5) %&gt;% </span></span>
<span id="cb86-999"><a href="#cb86-999" aria-hidden="true" tabindex="-1"></a><span class="in">  select(gdpPercap, gdpPercap_log) %&gt;% </span></span>
<span id="cb86-1000"><a href="#cb86-1000" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(unlogged = exp(gdpPercap_log))</span></span>
<span id="cb86-1001"><a href="#cb86-1001" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1002"><a href="#cb86-1002" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1003"><a href="#cb86-1003" aria-hidden="true" tabindex="-1"></a>Working with logged variables in regression, though, is a little trickier since there's no consistent way to back-transform the logged effects to their original scale—with logs, we're working with orders of magnitude, so the coefficient represents a different kind of change in the outcome. But it's okay! We can interpret things using percent changes rather than actual values. <span class="co">[</span><span class="ot">This response at Cross Validated</span><span class="co">](https://stats.stackexchange.com/a/18639/3025)</span> is my favorite resource for remembering how to interpret regression results with logs in them (<span class="co">[</span><span class="ot">this resource</span><span class="co">](https://data.library.virginia.edu/interpreting-log-transformations-in-a-linear-model/)</span> is helpful too).</span>
<span id="cb86-1004"><a href="#cb86-1004" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1005"><a href="#cb86-1005" aria-hidden="true" tabindex="-1"></a>When we have a regression model with a logged predictor, we talk about percent increases in the predictor variables. In a model like this, for instance…</span>
<span id="cb86-1006"><a href="#cb86-1006" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1007"><a href="#cb86-1007" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb86-1008"><a href="#cb86-1008" aria-hidden="true" tabindex="-1"></a>\text{Outcome} = \beta_0 + \beta_1 \log(\text{Predictor}) + \epsilon</span>
<span id="cb86-1009"><a href="#cb86-1009" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb86-1010"><a href="#cb86-1010" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1011"><a href="#cb86-1011" aria-hidden="true" tabindex="-1"></a>…we'd say "A 1% increase in the predictor is associated with a ($\beta_1$ / 100) unit increase in the outcome." If we want to think about larger increases in the predictor, like 10%, we can divide the $\beta_1$ coefficient by 10 instead.</span>
<span id="cb86-1012"><a href="#cb86-1012" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1013"><a href="#cb86-1013" aria-hidden="true" tabindex="-1"></a>Here's what this looks like with logged GDP per capita:</span>
<span id="cb86-1014"><a href="#cb86-1014" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1015"><a href="#cb86-1015" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eg-gdp-interpret}</span></span>
<span id="cb86-1016"><a href="#cb86-1016" aria-hidden="true" tabindex="-1"></a><span class="in">model_super_simple_log &lt;- lm(lifeExp ~ gdpPercap_log, data = gapminder)</span></span>
<span id="cb86-1017"><a href="#cb86-1017" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_super_simple_log)  # 8.38</span></span>
<span id="cb86-1018"><a href="#cb86-1018" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1019"><a href="#cb86-1019" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1020"><a href="#cb86-1020" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-eg-gdp-interpret, include=FALSE}</span></span>
<span id="cb86-1021"><a href="#cb86-1021" aria-hidden="true" tabindex="-1"></a><span class="in">m_super_simple_log &lt;- tidy(model_super_simple_log) %&gt;% </span></span>
<span id="cb86-1022"><a href="#cb86-1022" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(term = janitor::make_clean_names(term),</span></span>
<span id="cb86-1023"><a href="#cb86-1023" aria-hidden="true" tabindex="-1"></a><span class="in">         est = round(estimate, 2)) %&gt;% </span></span>
<span id="cb86-1024"><a href="#cb86-1024" aria-hidden="true" tabindex="-1"></a><span class="in">  split(~ term)</span></span>
<span id="cb86-1025"><a href="#cb86-1025" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1026"><a href="#cb86-1026" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1027"><a href="#cb86-1027" aria-hidden="true" tabindex="-1"></a>In this model, a one-unit increase in logged GDP per capita is associated with a <span class="in">`r m_super_simple_log$gdp_percap_log$est`</span> year increase in life expectancy. But thinking about increases in logged values is weird—we can think about percent changes instead.</span>
<span id="cb86-1028"><a href="#cb86-1028" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1029"><a href="#cb86-1029" aria-hidden="true" tabindex="-1"></a>The <span class="in">`r m_super_simple_log$gdp_percap_log$est`</span> coefficient by itself shows the effect of a 100% increase in GDP per capita, which is huge, so we can scale it down to see the effect of a 1% increase (if we divide by 100) or a 10% increase (if we divide by 10). A 10% increase in income for country with a GDP per capita of <span class="sc">\\</span>$1,000 would boost its income to <span class="in">`r dollar(1000 * 1.1)`</span> (<span class="in">`1000 * 1.1`</span>), which is a <span class="sc">\\</span>$100 change. For a country with a GDP per capita of <span class="sc">\\</span>$10,000, a 10% increase would result in <span class="in">`r dollar(10000 * 1.1)`</span> (<span class="in">`10000 * 1.1`</span>), or a <span class="sc">\\</span>$1,000 boost. According to our model, both of those changes (<span class="sc">\\</span>$100 for a poor country, <span class="sc">\\</span>$1,000 for a wealthier country) should result in the same change in life expectancy.</span>
<span id="cb86-1030"><a href="#cb86-1030" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1031"><a href="#cb86-1031" aria-hidden="true" tabindex="-1"></a>We'll consider 10% increases since those are more sizable (e.g., a 1% increase in a country with a GDP per capita of <span class="sc">\\</span>$1,000 would lead to <span class="in">`r dollar(1000 * 1.01)`</span>—that <span class="sc">\\</span>$10 increase is hardly going to move the needle in life expectancy).</span>
<span id="cb86-1032"><a href="#cb86-1032" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1033"><a href="#cb86-1033" aria-hidden="true" tabindex="-1"></a>Thus, according to this not-very-great-at-all model, a 10% increase in GDP per capita is associated with a <span class="in">`r m_super_simple_log$gdp_percap_log$estimate / 10`</span> (<span class="in">`8.38 / 10`</span>) year increase in life expectancy, on average.</span>
<span id="cb86-1034"><a href="#cb86-1034" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1035"><a href="#cb86-1035" aria-hidden="true" tabindex="-1"></a><span class="fu">#### 4: Log + scale and center</span></span>
<span id="cb86-1036"><a href="#cb86-1036" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1037"><a href="#cb86-1037" aria-hidden="true" tabindex="-1"></a>And finally, since Stan likes working with centered variables, we can also scale and center logged values. If we want to interpret them we have to back-transform them by rescaling them up with the standard deviation. When we created the scaled version of logged GDP per capita at the beginning of this post, R stored the mean and standard deviation as metadata attributes. We can extract those and scale things back up as needed:</span>
<span id="cb86-1038"><a href="#cb86-1038" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1039"><a href="#cb86-1039" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eg-log-gdp-scaled}</span></span>
<span id="cb86-1040"><a href="#cb86-1040" aria-hidden="true" tabindex="-1"></a><span class="in">attributes(gapminder$gdpPercap_log_z)</span></span>
<span id="cb86-1041"><a href="#cb86-1041" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1042"><a href="#cb86-1042" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1043"><a href="#cb86-1043" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1044"><a href="#cb86-1044" aria-hidden="true" tabindex="-1"></a><span class="fu">## The effect of wealth on health, accounting for country and time</span></span>
<span id="cb86-1045"><a href="#cb86-1045" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1046"><a href="#cb86-1046" aria-hidden="true" tabindex="-1"></a>Okay, phew. So far we've looked at how to model time trends across countries and continents with multilevel models, and we've seen how to scale and unscale variables to work better with Stan and **brms**. We're really actually interested in Hans Rosling's and the Gapminder Project's original question—what's the relationship between wealth and health, or GDP per capita and life expectancy? This fancy multilevel structure so far lets us model the time relationships, but we can use that year trend to account for time in more complex models.</span>
<span id="cb86-1047"><a href="#cb86-1047" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1048"><a href="#cb86-1048" aria-hidden="true" tabindex="-1"></a>For instance, we know from the Gapminder video that life expectancy increases as wealth increases, but that relationship differs by country. Visualizing the across-time trajectories of each country in the data helps with the intuition here. Countries like Canada, Italy, and Portugal have fairly steady trajectories over time, while places like Bolivia, Egypt, and Yemen see really steep increases in life expectancy. Sierra Leone tragically backtracks in both income and life expectancy in the 1990s.</span>
<span id="cb86-1049"><a href="#cb86-1049" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1050"><a href="#cb86-1050" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-gdp-lifeexp-time, out.width="100%", fig.width=8, fig.height=6, message=FALSE}</span></span>
<span id="cb86-1051"><a href="#cb86-1051" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-inset-right</span></span>
<span id="cb86-1052"><a href="#cb86-1052" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(gapminder, aes(x = gdpPercap, y = lifeExp, color = continent)) + </span></span>
<span id="cb86-1053"><a href="#cb86-1053" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(size = 0.5, alpha = 0.25) +</span></span>
<span id="cb86-1054"><a href="#cb86-1054" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_smooth(method = "lm", aes(color = NULL), color = "grey60", size = 0.5, </span></span>
<span id="cb86-1055"><a href="#cb86-1055" aria-hidden="true" tabindex="-1"></a><span class="in">              se = FALSE, show.legend = FALSE) +</span></span>
<span id="cb86-1056"><a href="#cb86-1056" aria-hidden="true" tabindex="-1"></a><span class="in">  annotate(geom = "label", label = "Global trend", x = 64000, y = 84, </span></span>
<span id="cb86-1057"><a href="#cb86-1057" aria-hidden="true" tabindex="-1"></a><span class="in">           size = 3, color = "grey60") +</span></span>
<span id="cb86-1058"><a href="#cb86-1058" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_path(aes(group = country, size = highlight),</span></span>
<span id="cb86-1059"><a href="#cb86-1059" aria-hidden="true" tabindex="-1"></a><span class="in">            arrow = arrow(type = "open", angle = 30, length = unit(0.75, "lines")),</span></span>
<span id="cb86-1060"><a href="#cb86-1060" aria-hidden="true" tabindex="-1"></a><span class="in">            show.legend = FALSE) +</span></span>
<span id="cb86-1061"><a href="#cb86-1061" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_label_repel(data = filter(gapminder, year == 15, highlight == TRUE), </span></span>
<span id="cb86-1062"><a href="#cb86-1062" aria-hidden="true" tabindex="-1"></a><span class="in">                   aes(label = country), size = 3, seed = 1234, </span></span>
<span id="cb86-1063"><a href="#cb86-1063" aria-hidden="true" tabindex="-1"></a><span class="in">                   show.legend = FALSE,</span></span>
<span id="cb86-1064"><a href="#cb86-1064" aria-hidden="true" tabindex="-1"></a><span class="in">                   family = "Barlow Semi Condensed", fontface = "bold") +</span></span>
<span id="cb86-1065"><a href="#cb86-1065" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_size_manual(values = c(0.075, 1), guide = "none") +</span></span>
<span id="cb86-1066"><a href="#cb86-1066" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_color_okabe_ito(order = c(2, 3, 6, 1),</span></span>
<span id="cb86-1067"><a href="#cb86-1067" aria-hidden="true" tabindex="-1"></a><span class="in">                        guide = guide_legend(override.aes = list(size = 3, alpha = 1))) +</span></span>
<span id="cb86-1068"><a href="#cb86-1068" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_log10(labels = dollar_format(accuracy = 1), breaks = 125 * (2^(1:10))) +</span></span>
<span id="cb86-1069"><a href="#cb86-1069" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "GDP per capita (log)", y = "Life expectancy", color = "Continent") +</span></span>
<span id="cb86-1070"><a href="#cb86-1070" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_clean() +</span></span>
<span id="cb86-1071"><a href="#cb86-1071" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = "bottom")</span></span>
<span id="cb86-1072"><a href="#cb86-1072" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1073"><a href="#cb86-1073" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1074"><a href="#cb86-1074" aria-hidden="true" tabindex="-1"></a>We're interested in the effect of GDP per capita on life expectancy, but getting a single value for this is a little tricky. The grey line here shows the global trend—on average, health and wealth clearly move together. But that's not a universal effect. Look at Italy, for instance—its slope is relatively constant over time. Egypt's wealth slope gets steeper and shallower over time, while Sierra Leone reverses at some points. For the rest of this post, we'll explore how to calculate and visualize these different country-specific and global effects.</span>
<span id="cb86-1075"><a href="#cb86-1075" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1076"><a href="#cb86-1076" aria-hidden="true" tabindex="-1"></a>In the first part of this guide, we cared about average life expectancy over time, so we plotted predicted life expectancy. Now, though, we care about the GDP effect, or the GDP coefficient in a model like <span class="in">`lifeExp ~ gdpPercap`</span>, so we'll work with and visualize that throughout the rest of this guide. We'll look at the posterior distribution of this coefficient to see how much this wealth effect varies. We'll use the <span class="in">`emtrends()`</span> function from **emmeans** throughout, since it's designed to calculate instantaneous average marginal effects (<span class="co">[</span><span class="ot">see this for more on average marginal effects</span><span class="co">](https://www.andrewheiss.com/blog/2021/11/10/ame-bayes-re-guide/#average-marginal-effects)</span>).</span>
<span id="cb86-1077"><a href="#cb86-1077" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1078"><a href="#cb86-1078" aria-hidden="true" tabindex="-1"></a>We'll use the centered version of GDP per capita to speed up model fitting, which means we'll need to unscale coefficients to interpret them. We'll also interpret coefficients using <span class="sc">\\</span>$1,000 increases in GDP per capita (since a <span class="sc">\\</span>$1 increase in wealth won't lead to much of a difference in life expectancy). As these models get more complex, we'll switch from regular GDP per capita to logged GDP per capita for the sake of computation.</span>
<span id="cb86-1079"><a href="#cb86-1079" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1080"><a href="#cb86-1080" aria-hidden="true" tabindex="-1"></a>Let's extract the mean and standard deviation from both centered GDP per capita and centered logged GDP per capita so we can use them below:</span>
<span id="cb86-1081"><a href="#cb86-1081" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1082"><a href="#cb86-1082" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-gdp-mean-sd}</span></span>
<span id="cb86-1083"><a href="#cb86-1083" aria-hidden="true" tabindex="-1"></a><span class="in">gdp_mean_sd &lt;- attributes(gapminder$gdpPercap_z)</span></span>
<span id="cb86-1084"><a href="#cb86-1084" aria-hidden="true" tabindex="-1"></a><span class="in">gdp_mean &lt;- gdp_mean_sd$`scaled:center`</span></span>
<span id="cb86-1085"><a href="#cb86-1085" aria-hidden="true" tabindex="-1"></a><span class="in">gdp_sd &lt;- gdp_mean_sd$`scaled:scale`</span></span>
<span id="cb86-1086"><a href="#cb86-1086" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1087"><a href="#cb86-1087" aria-hidden="true" tabindex="-1"></a><span class="in">gdp_log_mean_sd &lt;- attributes(gapminder$gdpPercap_log_z)</span></span>
<span id="cb86-1088"><a href="#cb86-1088" aria-hidden="true" tabindex="-1"></a><span class="in">gdp_log_mean &lt;- gdp_log_mean_sd$`scaled:center`</span></span>
<span id="cb86-1089"><a href="#cb86-1089" aria-hidden="true" tabindex="-1"></a><span class="in">gdp_log_sd &lt;- gdp_log_mean_sd$`scaled:scale`</span></span>
<span id="cb86-1090"><a href="#cb86-1090" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1091"><a href="#cb86-1091" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1092"><a href="#cb86-1092" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1093"><a href="#cb86-1093" aria-hidden="true" tabindex="-1"></a><span class="fu">### Regular regression</span></span>
<span id="cb86-1094"><a href="#cb86-1094" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1095"><a href="#cb86-1095" aria-hidden="true" tabindex="-1"></a>Like we did when we looked at just year trends, we'll start with a regular old non-multilevel regression model to help get our bearings. We'll actually run two different models: one with scaled and centered GDP per capita and one with scaled and centered logged GDP per capita, mostly to get used to scaling the coefficients up. These simple models fit just fine in under a second, but as we add more complexity, the non-logged GDP per capita gets really unstable and unwieldy, so we'll shift to the logged version.</span>
<span id="cb86-1096"><a href="#cb86-1096" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1097"><a href="#cb86-1097" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-gdp-boring, cache=TRUE, warning=FALSE, results="hide"}</span></span>
<span id="cb86-1098"><a href="#cb86-1098" aria-hidden="true" tabindex="-1"></a><span class="in">model_gdp_boring &lt;- brm(</span></span>
<span id="cb86-1099"><a href="#cb86-1099" aria-hidden="true" tabindex="-1"></a><span class="in">  bf(lifeExp ~ gdpPercap_z + year),</span></span>
<span id="cb86-1100"><a href="#cb86-1100" aria-hidden="true" tabindex="-1"></a><span class="in">  data = gapminder,</span></span>
<span id="cb86-1101"><a href="#cb86-1101" aria-hidden="true" tabindex="-1"></a><span class="in">  chains = 4, seed = bayes_seed</span></span>
<span id="cb86-1102"><a href="#cb86-1102" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb86-1103"><a href="#cb86-1103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1104"><a href="#cb86-1104" aria-hidden="true" tabindex="-1"></a><span class="in">model_gdp_boring_log &lt;- brm(</span></span>
<span id="cb86-1105"><a href="#cb86-1105" aria-hidden="true" tabindex="-1"></a><span class="in">  bf(lifeExp ~ gdpPercap_log_z + year),</span></span>
<span id="cb86-1106"><a href="#cb86-1106" aria-hidden="true" tabindex="-1"></a><span class="in">  data = gapminder,</span></span>
<span id="cb86-1107"><a href="#cb86-1107" aria-hidden="true" tabindex="-1"></a><span class="in">  chains = 4, seed = bayes_seed</span></span>
<span id="cb86-1108"><a href="#cb86-1108" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb86-1109"><a href="#cb86-1109" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1110"><a href="#cb86-1110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1111"><a href="#cb86-1111" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-model-gdp-boring, warning=FALSE}</span></span>
<span id="cb86-1112"><a href="#cb86-1112" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_gdp_boring)</span></span>
<span id="cb86-1113"><a href="#cb86-1113" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_gdp_boring_log)</span></span>
<span id="cb86-1114"><a href="#cb86-1114" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1115"><a href="#cb86-1115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1116"><a href="#cb86-1116" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-model-gdp-boring, include=FALSE}</span></span>
<span id="cb86-1117"><a href="#cb86-1117" aria-hidden="true" tabindex="-1"></a><span class="in">m_gdp_boring &lt;- tidy(model_gdp_boring) %&gt;% </span></span>
<span id="cb86-1118"><a href="#cb86-1118" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(across(c(estimate, std.error, conf.low, conf.high),</span></span>
<span id="cb86-1119"><a href="#cb86-1119" aria-hidden="true" tabindex="-1"></a><span class="in">                ~ifelse(term == "gdpPercap_z", (. / gdp_sd) * 1000, .))) %&gt;% </span></span>
<span id="cb86-1120"><a href="#cb86-1120" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(term = janitor::make_clean_names(term),</span></span>
<span id="cb86-1121"><a href="#cb86-1121" aria-hidden="true" tabindex="-1"></a><span class="in">         est = round(estimate, 2)) %&gt;% </span></span>
<span id="cb86-1122"><a href="#cb86-1122" aria-hidden="true" tabindex="-1"></a><span class="in">  split(~ term)</span></span>
<span id="cb86-1123"><a href="#cb86-1123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1124"><a href="#cb86-1124" aria-hidden="true" tabindex="-1"></a><span class="in">m_gdp_boring_log &lt;- tidy(model_gdp_boring_log) %&gt;% </span></span>
<span id="cb86-1125"><a href="#cb86-1125" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(across(c(estimate, std.error, conf.low, conf.high),</span></span>
<span id="cb86-1126"><a href="#cb86-1126" aria-hidden="true" tabindex="-1"></a><span class="in">                ~ifelse(term == "gdpPercap_log_z", (. / gdp_log_sd), .))) %&gt;% </span></span>
<span id="cb86-1127"><a href="#cb86-1127" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(term = janitor::make_clean_names(term),</span></span>
<span id="cb86-1128"><a href="#cb86-1128" aria-hidden="true" tabindex="-1"></a><span class="in">         est = round(estimate, 2)) %&gt;% </span></span>
<span id="cb86-1129"><a href="#cb86-1129" aria-hidden="true" tabindex="-1"></a><span class="in">  split(~ term)</span></span>
<span id="cb86-1130"><a href="#cb86-1130" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1131"><a href="#cb86-1131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1132"><a href="#cb86-1132" aria-hidden="true" tabindex="-1"></a>We can look at the results, but the coefficients for the scaled variables are a little tricky to interpret here. Technically they represent the increase in life expectancy that follows a 1 standard deviation increase in GDP per capita (not logged and logged), but I don't think in standard deviations and I prefer to shift these coefficients back to their original scales. To do that we just need to divide by the standard deviation of the original columns. We'll also multiply the GDP per capita coefficient by 1,000 so we can talk about changes in life expectancy that follow a <span class="sc">\\</span>$1,000 increase in wealth, and we'll divide the logged GDP per capita coefficient by 10 so we can talk about changes in life expectancy that follow a 10% increase in wealth. This neat combination of <span class="in">`across()`</span> and <span class="in">`ifelse()`</span> inside <span class="in">`mutate()`</span> lets us rescale multiple columns for just a single row, which is cool.</span>
<span id="cb86-1133"><a href="#cb86-1133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1134"><a href="#cb86-1134" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-model-gdp-boring-unscaled, warning=FALSE}</span></span>
<span id="cb86-1135"><a href="#cb86-1135" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_gdp_boring) %&gt;% </span></span>
<span id="cb86-1136"><a href="#cb86-1136" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(across(c(estimate, std.error, conf.low, conf.high),</span></span>
<span id="cb86-1137"><a href="#cb86-1137" aria-hidden="true" tabindex="-1"></a><span class="in">                ~ifelse(term == "gdpPercap_z", (. / gdp_sd) * 1000, .)))</span></span>
<span id="cb86-1138"><a href="#cb86-1138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1139"><a href="#cb86-1139" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_gdp_boring_log) %&gt;% </span></span>
<span id="cb86-1140"><a href="#cb86-1140" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(across(c(estimate, std.error, conf.low, conf.high),</span></span>
<span id="cb86-1141"><a href="#cb86-1141" aria-hidden="true" tabindex="-1"></a><span class="in">                ~ifelse(term == "gdpPercap_log_z", (. / gdp_log_sd), .)))</span></span>
<span id="cb86-1142"><a href="#cb86-1142" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1143"><a href="#cb86-1143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1144"><a href="#cb86-1144" aria-hidden="true" tabindex="-1"></a>Based on this model, when <span class="in">`year`</span> is 0 (or in 1952) *and* when a country's GDP per capita is <span class="sc">\\</span>$0, the average life expectancy is <span class="in">`r m_gdp_boring$intercept$est`</span> years on average. It increases by <span class="in">`r m_gdp_boring$year$est`</span> years annually after that, holding income constant, and it increases by <span class="in">`r m_gdp_boring$gdp_percap_z$est`</span> years for every <span class="sc">\\</span>$1,000 increase in wealth, holding time constant.</span>
<span id="cb86-1145"><a href="#cb86-1145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1146"><a href="#cb86-1146" aria-hidden="true" tabindex="-1"></a>If we look at logged GDP per capita, we see a similar story: a 10% increase in GDP per capita is associated with a <span class="in">`r m_gdp_boring_log$gdp_percap_log_z$est / 10`</span> (<span class="in">`r m_gdp_boring_log$gdp_percap_log_z$est`</span> / 10) year increase in life expectancy, holding time constant.</span>
<span id="cb86-1147"><a href="#cb86-1147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1148"><a href="#cb86-1148" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-ame-gdp-boring, out.width="100%", fig.width=8, fig.height=4.5, warning=FALSE}</span></span>
<span id="cb86-1149"><a href="#cb86-1149" aria-hidden="true" tabindex="-1"></a><span class="in">ame_model_gdp_boring &lt;- model_gdp_boring %&gt;% </span></span>
<span id="cb86-1150"><a href="#cb86-1150" aria-hidden="true" tabindex="-1"></a><span class="in">  emtrends(~ 1,</span></span>
<span id="cb86-1151"><a href="#cb86-1151" aria-hidden="true" tabindex="-1"></a><span class="in">           var = "gdpPercap_z",</span></span>
<span id="cb86-1152"><a href="#cb86-1152" aria-hidden="true" tabindex="-1"></a><span class="in">           at = list(year = 0),</span></span>
<span id="cb86-1153"><a href="#cb86-1153" aria-hidden="true" tabindex="-1"></a><span class="in">           epred = TRUE, re_formula = NULL)</span></span>
<span id="cb86-1154"><a href="#cb86-1154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1155"><a href="#cb86-1155" aria-hidden="true" tabindex="-1"></a><span class="in">pred_ame_model_gdp_boring &lt;- ame_model_gdp_boring %&gt;% </span></span>
<span id="cb86-1156"><a href="#cb86-1156" aria-hidden="true" tabindex="-1"></a><span class="in">  gather_emmeans_draws() %&gt;% </span></span>
<span id="cb86-1157"><a href="#cb86-1157" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(.value = .value / gdp_sd * 1000) %&gt;% </span></span>
<span id="cb86-1158"><a href="#cb86-1158" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(fake_facet_title = "GDP per capita")</span></span>
<span id="cb86-1159"><a href="#cb86-1159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1160"><a href="#cb86-1160" aria-hidden="true" tabindex="-1"></a><span class="in">plot_ame_gdp &lt;- ggplot(pred_ame_model_gdp_boring, aes(x = .value)) +</span></span>
<span id="cb86-1161"><a href="#cb86-1161" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye(fill = palette_okabe_ito(5),</span></span>
<span id="cb86-1162"><a href="#cb86-1162" aria-hidden="true" tabindex="-1"></a><span class="in">               .width = c(0.8, 0.95)) +</span></span>
<span id="cb86-1163"><a href="#cb86-1163" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = paste0("Average marginal effect on life expectancy", "\n", </span></span>
<span id="cb86-1164"><a href="#cb86-1164" aria-hidden="true" tabindex="-1"></a><span class="in">                  "of a $1,000 increase in GDP per capita"), </span></span>
<span id="cb86-1165"><a href="#cb86-1165" aria-hidden="true" tabindex="-1"></a><span class="in">       y = "Density") +</span></span>
<span id="cb86-1166"><a href="#cb86-1166" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(vars(fake_facet_title)) +</span></span>
<span id="cb86-1167"><a href="#cb86-1167" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_clean() +</span></span>
<span id="cb86-1168"><a href="#cb86-1168" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(strip.text = element_text(size = rel(1.1)))</span></span>
<span id="cb86-1169"><a href="#cb86-1169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1170"><a href="#cb86-1170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1171"><a href="#cb86-1171" aria-hidden="true" tabindex="-1"></a><span class="in">ame_model_gdp_boring_log &lt;- model_gdp_boring_log %&gt;% </span></span>
<span id="cb86-1172"><a href="#cb86-1172" aria-hidden="true" tabindex="-1"></a><span class="in">  emtrends(~ 1,</span></span>
<span id="cb86-1173"><a href="#cb86-1173" aria-hidden="true" tabindex="-1"></a><span class="in">           var = "gdpPercap_log_z",</span></span>
<span id="cb86-1174"><a href="#cb86-1174" aria-hidden="true" tabindex="-1"></a><span class="in">           at = list(year = 0),</span></span>
<span id="cb86-1175"><a href="#cb86-1175" aria-hidden="true" tabindex="-1"></a><span class="in">           epred = TRUE, re_formula = NULL)</span></span>
<span id="cb86-1176"><a href="#cb86-1176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1177"><a href="#cb86-1177" aria-hidden="true" tabindex="-1"></a><span class="in">pred_ame_model_gdp_boring_log &lt;- ame_model_gdp_boring_log %&gt;% </span></span>
<span id="cb86-1178"><a href="#cb86-1178" aria-hidden="true" tabindex="-1"></a><span class="in">  gather_emmeans_draws() %&gt;% </span></span>
<span id="cb86-1179"><a href="#cb86-1179" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(.value = .value / gdp_log_sd / 10) %&gt;% </span></span>
<span id="cb86-1180"><a href="#cb86-1180" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(fake_facet_title = "Logged GDP per capita")</span></span>
<span id="cb86-1181"><a href="#cb86-1181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1182"><a href="#cb86-1182" aria-hidden="true" tabindex="-1"></a><span class="in">plot_ame_gdp_log &lt;- ggplot(pred_ame_model_gdp_boring_log, aes(x = .value)) +</span></span>
<span id="cb86-1183"><a href="#cb86-1183" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye(fill = palette_okabe_ito(5),</span></span>
<span id="cb86-1184"><a href="#cb86-1184" aria-hidden="true" tabindex="-1"></a><span class="in">               .width = c(0.8, 0.95)) +</span></span>
<span id="cb86-1185"><a href="#cb86-1185" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = paste0("Average marginal effect on life expectancy", "\n", </span></span>
<span id="cb86-1186"><a href="#cb86-1186" aria-hidden="true" tabindex="-1"></a><span class="in">                  "of a 10% increase in GDP per capita"), </span></span>
<span id="cb86-1187"><a href="#cb86-1187" aria-hidden="true" tabindex="-1"></a><span class="in">       y = "Density") +</span></span>
<span id="cb86-1188"><a href="#cb86-1188" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(vars(fake_facet_title)) +</span></span>
<span id="cb86-1189"><a href="#cb86-1189" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_clean() +</span></span>
<span id="cb86-1190"><a href="#cb86-1190" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(strip.text = element_text(size = rel(1.1)))</span></span>
<span id="cb86-1191"><a href="#cb86-1191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1192"><a href="#cb86-1192" aria-hidden="true" tabindex="-1"></a><span class="in">(plot_ame_gdp + plot_ame_gdp_log) +</span></span>
<span id="cb86-1193"><a href="#cb86-1193" aria-hidden="true" tabindex="-1"></a><span class="in">  plot_annotation(title = paste0("Average marginal effect of GDP per capita", "\n",</span></span>
<span id="cb86-1194"><a href="#cb86-1194" aria-hidden="true" tabindex="-1"></a><span class="in">                                 "(includes year trend with no country-based variation)"), </span></span>
<span id="cb86-1195"><a href="#cb86-1195" aria-hidden="true" tabindex="-1"></a><span class="in">                  subtitle = "lifeExp ~ gdpPercap_log_z + year",</span></span>
<span id="cb86-1196"><a href="#cb86-1196" aria-hidden="true" tabindex="-1"></a><span class="in">                  caption = "80% and 95% credible intervals shown with error bar",</span></span>
<span id="cb86-1197"><a href="#cb86-1197" aria-hidden="true" tabindex="-1"></a><span class="in">                  theme = theme_clean() + theme(plot.subtitle = element_text(family = "Consolas")))</span></span>
<span id="cb86-1198"><a href="#cb86-1198" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1199"><a href="#cb86-1199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1200"><a href="#cb86-1200" aria-hidden="true" tabindex="-1"></a><span class="fu">### Each country gets its own intercept and GDP slope</span></span>
<span id="cb86-1201"><a href="#cb86-1201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1202"><a href="#cb86-1202" aria-hidden="true" tabindex="-1"></a>As we saw in the plot with the different across-time trajectories, each country has a slightly different relationship between wealth and life expectancy. Using multilevel modeling, we can incorporate country-specific offsets into both the intercept ($b_{0, \text{Country}}$) and the fixed GDP per capita effect ($b_{1, \text{Country}}$). As always, each of these country-specific offsets has its own variation that we call $\tau$.</span>
<span id="cb86-1203"><a href="#cb86-1203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1204"><a href="#cb86-1204" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb86-1205"><a href="#cb86-1205" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb86-1206"><a href="#cb86-1206" aria-hidden="true" tabindex="-1"></a>\text{Life expectancy} &amp;= (\beta_0 + b_{0, \text{Country}}) + (\beta_1 + b_{1, \text{Country}}) \text{GDP} + \beta_2 \text{Year} + \epsilon <span class="sc">\\</span></span>
<span id="cb86-1207"><a href="#cb86-1207" aria-hidden="true" tabindex="-1"></a>b_{0, \text{Country}} &amp;\sim \mathcal{N}(0, \tau_0) <span class="sc">\\</span></span>
<span id="cb86-1208"><a href="#cb86-1208" aria-hidden="true" tabindex="-1"></a>b_{1, \text{Country}} &amp;\sim \mathcal{N}(0, \tau_1)</span>
<span id="cb86-1209"><a href="#cb86-1209" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb86-1210"><a href="#cb86-1210" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb86-1211"><a href="#cb86-1211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1212"><a href="#cb86-1212" aria-hidden="true" tabindex="-1"></a>The syntax for this random effects term is <span class="in">`(1 + gdpPercap_z | country)`</span>—we're letting both the intercept (<span class="in">`1`</span>) and GDP per capita vary by country. We'll use the scaled versions of both regular GDP per capita and logged GDP per capita.</span>
<span id="cb86-1213"><a href="#cb86-1213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1214"><a href="#cb86-1214" aria-hidden="true" tabindex="-1"></a>Note the addition of the <span class="in">`decomp = "QR"`</span> argument here—that tells **brms** to use QR decomposition for decorrelating highly correlated covariates (like year and GDP across country), and it can speed up computation (<span class="co">[</span><span class="ot">see here for more about that</span><span class="co">](https://mc-stan.org/users/documentation/case-studies/qr_regression.html)</span>).</span>
<span id="cb86-1215"><a href="#cb86-1215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1216"><a href="#cb86-1216" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-gdp-country, cache=TRUE, warning=FALSE, results="hide"}</span></span>
<span id="cb86-1217"><a href="#cb86-1217" aria-hidden="true" tabindex="-1"></a><span class="in">model_gdp_country_only &lt;- brm(</span></span>
<span id="cb86-1218"><a href="#cb86-1218" aria-hidden="true" tabindex="-1"></a><span class="in">  bf(lifeExp ~ gdpPercap_z + year + (1 + gdpPercap_z | country),</span></span>
<span id="cb86-1219"><a href="#cb86-1219" aria-hidden="true" tabindex="-1"></a><span class="in">     decomp = "QR"),</span></span>
<span id="cb86-1220"><a href="#cb86-1220" aria-hidden="true" tabindex="-1"></a><span class="in">  data = gapminder,</span></span>
<span id="cb86-1221"><a href="#cb86-1221" aria-hidden="true" tabindex="-1"></a><span class="in">  chains = 4, seed = bayes_seed,</span></span>
<span id="cb86-1222"><a href="#cb86-1222" aria-hidden="true" tabindex="-1"></a><span class="in">  threads = threading(2)  # Two CPUs per chain to speed things up</span></span>
<span id="cb86-1223"><a href="#cb86-1223" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb86-1224"><a href="#cb86-1224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1225"><a href="#cb86-1225" aria-hidden="true" tabindex="-1"></a><span class="in">model_gdp_country_only_log &lt;- brm(</span></span>
<span id="cb86-1226"><a href="#cb86-1226" aria-hidden="true" tabindex="-1"></a><span class="in">  bf(lifeExp ~ gdpPercap_log_z + year + (1 + gdpPercap_log_z | country),</span></span>
<span id="cb86-1227"><a href="#cb86-1227" aria-hidden="true" tabindex="-1"></a><span class="in">     decomp = "QR"),</span></span>
<span id="cb86-1228"><a href="#cb86-1228" aria-hidden="true" tabindex="-1"></a><span class="in">  data = gapminder,</span></span>
<span id="cb86-1229"><a href="#cb86-1229" aria-hidden="true" tabindex="-1"></a><span class="in">  chains = 4, seed = bayes_seed,</span></span>
<span id="cb86-1230"><a href="#cb86-1230" aria-hidden="true" tabindex="-1"></a><span class="in">  threads = threading(2)  # Two CPUs per chain to speed things up</span></span>
<span id="cb86-1231"><a href="#cb86-1231" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb86-1232"><a href="#cb86-1232" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1233"><a href="#cb86-1233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1234"><a href="#cb86-1234" aria-hidden="true" tabindex="-1"></a>Adding this country-level complexity starts slowing down the regular GDP version substantially—it takes twice as long to fit the model with <span class="in">`gdpPercap_z`</span> than it does <span class="in">`gdpPercap_log_z`</span>, and there are issues with divergent chains and model fit. This is a great example of <span class="co">[</span><span class="ot">Andrew Gelman's folk theorem of statistical computing</span><span class="co">](https://statmodeling.stat.columbia.edu/2008/05/13/the_folk_theore/)</span>: **"when you have computational problems, often there's a problem with your model."** We could fix this by using more specific priors, using more iterations in the chains, or adjusting some of Stan's parameters like <span class="in">`adapt_delta`</span>, but for the sake of this example, we won't.</span>
<span id="cb86-1235"><a href="#cb86-1235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1236"><a href="#cb86-1236" aria-hidden="true" tabindex="-1"></a><span class="in">```{r duration-models-gdp-country}</span></span>
<span id="cb86-1237"><a href="#cb86-1237" aria-hidden="true" tabindex="-1"></a><span class="in"># Model with regular GDP per capita</span></span>
<span id="cb86-1238"><a href="#cb86-1238" aria-hidden="true" tabindex="-1"></a><span class="in">rstan::get_elapsed_time(model_gdp_country_only$fit) %&gt;% </span></span>
<span id="cb86-1239"><a href="#cb86-1239" aria-hidden="true" tabindex="-1"></a><span class="in">  as_tibble(rownames = "chain") %&gt;% mutate(total_seconds = warmup + sample)</span></span>
<span id="cb86-1240"><a href="#cb86-1240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1241"><a href="#cb86-1241" aria-hidden="true" tabindex="-1"></a><span class="in"># Model with logged GDP per capita </span></span>
<span id="cb86-1242"><a href="#cb86-1242" aria-hidden="true" tabindex="-1"></a><span class="in">rstan::get_elapsed_time(model_gdp_country_only_log$fit) %&gt;% </span></span>
<span id="cb86-1243"><a href="#cb86-1243" aria-hidden="true" tabindex="-1"></a><span class="in">  as_tibble(rownames = "chain") %&gt;% mutate(total_seconds = warmup + sample)</span></span>
<span id="cb86-1244"><a href="#cb86-1244" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1245"><a href="#cb86-1245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1246"><a href="#cb86-1246" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-model-gdp-country, include=FALSE}</span></span>
<span id="cb86-1247"><a href="#cb86-1247" aria-hidden="true" tabindex="-1"></a><span class="in">m_gdp_country_only &lt;- tidy(model_gdp_country_only) %&gt;% </span></span>
<span id="cb86-1248"><a href="#cb86-1248" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(across(c(estimate, std.error, conf.low, conf.high),</span></span>
<span id="cb86-1249"><a href="#cb86-1249" aria-hidden="true" tabindex="-1"></a><span class="in">                ~ifelse(term %in% c("gdpPercap_z", "sd__gdpPercap_z"), </span></span>
<span id="cb86-1250"><a href="#cb86-1250" aria-hidden="true" tabindex="-1"></a><span class="in">                        (. / gdp_sd) * 1000, .))) %&gt;% </span></span>
<span id="cb86-1251"><a href="#cb86-1251" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(term = janitor::make_clean_names(term),</span></span>
<span id="cb86-1252"><a href="#cb86-1252" aria-hidden="true" tabindex="-1"></a><span class="in">         est = round(estimate, 2)) %&gt;% </span></span>
<span id="cb86-1253"><a href="#cb86-1253" aria-hidden="true" tabindex="-1"></a><span class="in">  split(~ term)</span></span>
<span id="cb86-1254"><a href="#cb86-1254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1255"><a href="#cb86-1255" aria-hidden="true" tabindex="-1"></a><span class="in">m_gdp_country_only_log &lt;- tidy(model_gdp_country_only_log) %&gt;% </span></span>
<span id="cb86-1256"><a href="#cb86-1256" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(across(c(estimate, std.error, conf.low, conf.high),</span></span>
<span id="cb86-1257"><a href="#cb86-1257" aria-hidden="true" tabindex="-1"></a><span class="in">                ~ifelse(term %in% c("gdpPercap_log_z", "sd__gdpPercap_log_z"), </span></span>
<span id="cb86-1258"><a href="#cb86-1258" aria-hidden="true" tabindex="-1"></a><span class="in">                        (. / gdp_log_sd), .))) %&gt;% </span></span>
<span id="cb86-1259"><a href="#cb86-1259" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(term = janitor::make_clean_names(term),</span></span>
<span id="cb86-1260"><a href="#cb86-1260" aria-hidden="true" tabindex="-1"></a><span class="in">         est = round(estimate, 2)) %&gt;% </span></span>
<span id="cb86-1261"><a href="#cb86-1261" aria-hidden="true" tabindex="-1"></a><span class="in">  split(~ term)</span></span>
<span id="cb86-1262"><a href="#cb86-1262" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1263"><a href="#cb86-1263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1264"><a href="#cb86-1264" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Fixed (population-level) effects</span></span>
<span id="cb86-1265"><a href="#cb86-1265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1266"><a href="#cb86-1266" aria-hidden="true" tabindex="-1"></a>The global population-level coefficients are similar to what we saw in the basic model without random country effects: holding year trends constant, life expectancy increases by <span class="in">`r m_gdp_country_only$gdp_percap_z$est`</span> years for every <span class="sc">\\</span>$1,000 increase in wealth and <span class="in">`r m_gdp_country_only_log$gdp_percap_log_z$est / 10`</span> years for every 10% increase in wealth, on average.</span>
<span id="cb86-1267"><a href="#cb86-1267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1268"><a href="#cb86-1268" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-model-gdp-country-unscaled, warning=FALSE}</span></span>
<span id="cb86-1269"><a href="#cb86-1269" aria-hidden="true" tabindex="-1"></a><span class="in"># Unscale both the GDP coefficient and the GDP random variance coefficient</span></span>
<span id="cb86-1270"><a href="#cb86-1270" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_gdp_country_only) %&gt;% </span></span>
<span id="cb86-1271"><a href="#cb86-1271" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(across(c(estimate, std.error, conf.low, conf.high),</span></span>
<span id="cb86-1272"><a href="#cb86-1272" aria-hidden="true" tabindex="-1"></a><span class="in">                ~ifelse(term %in% c("gdpPercap_z", "sd__gdpPercap_z"), </span></span>
<span id="cb86-1273"><a href="#cb86-1273" aria-hidden="true" tabindex="-1"></a><span class="in">                        (. / gdp_sd) * 1000, .)))</span></span>
<span id="cb86-1274"><a href="#cb86-1274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1275"><a href="#cb86-1275" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_gdp_country_only_log) %&gt;% </span></span>
<span id="cb86-1276"><a href="#cb86-1276" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(across(c(estimate, std.error, conf.low, conf.high),</span></span>
<span id="cb86-1277"><a href="#cb86-1277" aria-hidden="true" tabindex="-1"></a><span class="in">                ~ifelse(term %in% c("gdpPercap_log_z", "sd__gdpPercap_log_z"), </span></span>
<span id="cb86-1278"><a href="#cb86-1278" aria-hidden="true" tabindex="-1"></a><span class="in">                        (. / gdp_log_sd), .)))</span></span>
<span id="cb86-1279"><a href="#cb86-1279" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1280"><a href="#cb86-1280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1281"><a href="#cb86-1281" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Country-level variation</span></span>
<span id="cb86-1282"><a href="#cb86-1282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1283"><a href="#cb86-1283" aria-hidden="true" tabindex="-1"></a>We also have a few random effects terms that we can interpret. The variance for the intercept (<span class="in">`sd__(Intercept)`</span>) corresponds to $\tau_0$ and shows us how much life expectancy bounces around across countries. We can also see what proportion this country-level variation contributes to the the total residual variation of the model. For the GDP per capita model, the country structure contributes <span class="in">`r percent(m_gdp_country_only$sd_intercept$estimate / (m_gdp_country_only$sd_intercept$estimate + m_gdp_country_only$sd_observation$estimate))`</span> (<span class="in">`r m_gdp_country_only$sd_intercept$est`</span> / (<span class="in">`r m_gdp_country_only$sd_intercept$est`</span> + <span class="in">`r m_gdp_country_only$sd_observation$est`</span>)) of the total variance in life expectancy, while it contributes <span class="in">`r percent(m_gdp_country_only_log$sd_intercept$estimate / (m_gdp_country_only_log$sd_intercept$estimate + m_gdp_country_only_log$sd_observation$estimate))`</span> (<span class="in">`r m_gdp_country_only_log$sd_intercept$est`</span> / (<span class="in">`r m_gdp_country_only_log$sd_intercept$est`</span> + <span class="in">`r m_gdp_country_only_log$sd_observation$est`</span>)) in the logged GDP per capita model.</span>
<span id="cb86-1284"><a href="#cb86-1284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1285"><a href="#cb86-1285" aria-hidden="true" tabindex="-1"></a>The <span class="in">`sd__gdpPercap_z`</span> term is $\tau_1$ and shows the country-specific variation in the GDP effect. This is smaller than the intercept variance, but that's because the GDP effect is a slope that measures the *marginal change* in life expectancy as wealth increases by one unit (or \$1,000 here), not life expectancy itself. (We unscaled the values for <span class="in">`sd__gdpPercap_z`</span> and <span class="in">`sd__gdpPercap_log_z`</span> here too, like we did their actual fixed coefficients.)</span>
<span id="cb86-1286"><a href="#cb86-1286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1287"><a href="#cb86-1287" aria-hidden="true" tabindex="-1"></a>Finally, we have a term that shows the correlation of the country-specific intercepts and slopes. In the regular GDP per capita model, we see a correlation of <span class="in">`r m_gdp_country_only$cor_intercept_gdp_percap_z$est`</span>, which means that countries with lower intercepts are associated with lower GDP effects—countries that start out poor in 1952 grow slower. This correlation reverses in the logged GDP per capita model, where we have a correlation of <span class="in">`r m_gdp_country_only_log$cor_intercept_gdp_percap_log_z$est`</span>, which implies that countries with lower intercepts are associated with bigger GDP effects—countries that start out poor in 1952 grow faster. Why the reversal? Haha I don't know. It could be because the two measures of GDP capture different things: the logged version shows changes in orders of magnitude, while the regular version shows changes in dollar amounts. Somehow that difference makes the correlation flip. Weird.</span>
<span id="cb86-1288"><a href="#cb86-1288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1289"><a href="#cb86-1289" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Country-level random effects</span></span>
<span id="cb86-1290"><a href="#cb86-1290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1291"><a href="#cb86-1291" aria-hidden="true" tabindex="-1"></a>For fun, we can look at the country-level offsets for the intercept and the GDP slope. </span>
<span id="cb86-1292"><a href="#cb86-1292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1293"><a href="#cb86-1293" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-gdp-country-offsets}</span></span>
<span id="cb86-1294"><a href="#cb86-1294" aria-hidden="true" tabindex="-1"></a><span class="in">ranef(model_gdp_country_only)$country %&gt;%</span></span>
<span id="cb86-1295"><a href="#cb86-1295" aria-hidden="true" tabindex="-1"></a><span class="in">  as_tibble(rownames = "country") %&gt;% </span></span>
<span id="cb86-1296"><a href="#cb86-1296" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(country %in% countries$country) %&gt;% </span></span>
<span id="cb86-1297"><a href="#cb86-1297" aria-hidden="true" tabindex="-1"></a><span class="in">  select(country, starts_with("Estimate")) %&gt;% </span></span>
<span id="cb86-1298"><a href="#cb86-1298" aria-hidden="true" tabindex="-1"></a><span class="in">  # Unscale the GDP offsets</span></span>
<span id="cb86-1299"><a href="#cb86-1299" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(Estimate.gdpPercap_z = Estimate.gdpPercap_z / gdp_sd * 1000)</span></span>
<span id="cb86-1300"><a href="#cb86-1300" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1301"><a href="#cb86-1301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1302"><a href="#cb86-1302" aria-hidden="true" tabindex="-1"></a>We can also look at the already-combined fixed effect + random offset for country-specific intercepts and slopes. The intercept and the slope are different in each country, while the <span class="in">`year`</span> coefficient is the same, as expected:</span>
<span id="cb86-1303"><a href="#cb86-1303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1304"><a href="#cb86-1304" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-country-coefs-gdp}</span></span>
<span id="cb86-1305"><a href="#cb86-1305" aria-hidden="true" tabindex="-1"></a><span class="in">coef(model_gdp_country_only)$country %&gt;%</span></span>
<span id="cb86-1306"><a href="#cb86-1306" aria-hidden="true" tabindex="-1"></a><span class="in">  as_tibble(rownames = "country") %&gt;% </span></span>
<span id="cb86-1307"><a href="#cb86-1307" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(country %in% countries$country) %&gt;% </span></span>
<span id="cb86-1308"><a href="#cb86-1308" aria-hidden="true" tabindex="-1"></a><span class="in">  select(country, starts_with("Estimate")) %&gt;% </span></span>
<span id="cb86-1309"><a href="#cb86-1309" aria-hidden="true" tabindex="-1"></a><span class="in">  # Unscale the GDP offsets</span></span>
<span id="cb86-1310"><a href="#cb86-1310" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(Estimate.gdpPercap_z = Estimate.gdpPercap_z / gdp_sd * 1000)</span></span>
<span id="cb86-1311"><a href="#cb86-1311" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1312"><a href="#cb86-1312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1313"><a href="#cb86-1313" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Visualize results</span></span>
<span id="cb86-1314"><a href="#cb86-1314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1315"><a href="#cb86-1315" aria-hidden="true" tabindex="-1"></a>We can see the full posterior distributions for these country-specific GDP effects to get a sense of their variation. Looking at regular GDP shows some interesting trends—and reveals some potential issues with the model. In all countries except Canada, Italy, and Portugal, a <span class="sc">\\</span>$1,000 increase in GDP per capita—holding all other factors constant—is associated with a 2–5 year increase in life expectancy. This difference is "statistically significant" if we want to use that kind of frequentist language—the credible intervals for all these effects are fairly far from 0. Canada, Italy, and Portugal, however, see no practical GDP effect. Their slopes are essentially zero, and they're precisely estimated around zero (hence those really tall peaks). This could be an artifact of the model—those three countries had already-high levels of income and Stan struggles with extremes like that.</span>
<span id="cb86-1316"><a href="#cb86-1316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1317"><a href="#cb86-1317" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-ame-gdp-country, out.width="100%", fig.width=8, fig.height=5}</span></span>
<span id="cb86-1318"><a href="#cb86-1318" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-inset-right</span></span>
<span id="cb86-1319"><a href="#cb86-1319" aria-hidden="true" tabindex="-1"></a><span class="in">ame_model_gdp_country_only &lt;- model_gdp_country_only %&gt;% </span></span>
<span id="cb86-1320"><a href="#cb86-1320" aria-hidden="true" tabindex="-1"></a><span class="in">  emtrends(~ country,</span></span>
<span id="cb86-1321"><a href="#cb86-1321" aria-hidden="true" tabindex="-1"></a><span class="in">           var = "gdpPercap_z",</span></span>
<span id="cb86-1322"><a href="#cb86-1322" aria-hidden="true" tabindex="-1"></a><span class="in">           at = list(year = 0, country = countries$country),</span></span>
<span id="cb86-1323"><a href="#cb86-1323" aria-hidden="true" tabindex="-1"></a><span class="in">           epred = TRUE, re_formula = NULL)</span></span>
<span id="cb86-1324"><a href="#cb86-1324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1325"><a href="#cb86-1325" aria-hidden="true" tabindex="-1"></a><span class="in">pred_ame_model_gdp_country_only &lt;- ame_model_gdp_country_only %&gt;% </span></span>
<span id="cb86-1326"><a href="#cb86-1326" aria-hidden="true" tabindex="-1"></a><span class="in">  gather_emmeans_draws() %&gt;% </span></span>
<span id="cb86-1327"><a href="#cb86-1327" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(.value = .value / gdp_sd * 1000) %&gt;% </span></span>
<span id="cb86-1328"><a href="#cb86-1328" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(countries, by = "country")</span></span>
<span id="cb86-1329"><a href="#cb86-1329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1330"><a href="#cb86-1330" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(pred_ame_model_gdp_country_only, aes(x = .value)) +</span></span>
<span id="cb86-1331"><a href="#cb86-1331" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye(aes(fill = continent)) +</span></span>
<span id="cb86-1332"><a href="#cb86-1332" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0) +</span></span>
<span id="cb86-1333"><a href="#cb86-1333" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_okabe_ito(order = c(2, 3, 6, 1), guide = "none") +</span></span>
<span id="cb86-1334"><a href="#cb86-1334" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(title = paste0("Average marginal effect of GDP per capita", "\n",</span></span>
<span id="cb86-1335"><a href="#cb86-1335" aria-hidden="true" tabindex="-1"></a><span class="in">                      "(intercepts and slope of GDP per capita by country)"), </span></span>
<span id="cb86-1336"><a href="#cb86-1336" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "lifeExp ~ gdpPercap_z + year + (1 + gdpPercap_z | country)",</span></span>
<span id="cb86-1337"><a href="#cb86-1337" aria-hidden="true" tabindex="-1"></a><span class="in">       x = paste0("Average marginal effect on life expectancy", "\n", </span></span>
<span id="cb86-1338"><a href="#cb86-1338" aria-hidden="true" tabindex="-1"></a><span class="in">                  "of a $1,000 increase in GDP per capita"), </span></span>
<span id="cb86-1339"><a href="#cb86-1339" aria-hidden="true" tabindex="-1"></a><span class="in">       y = "Density",</span></span>
<span id="cb86-1340"><a href="#cb86-1340" aria-hidden="true" tabindex="-1"></a><span class="in">       caption = "80% and 95% credible intervals shown with error bar") +</span></span>
<span id="cb86-1341"><a href="#cb86-1341" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_nested_wrap(vars(continent, country), nrow = 2, strip = nested_settings) +</span></span>
<span id="cb86-1342"><a href="#cb86-1342" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_clean() +</span></span>
<span id="cb86-1343"><a href="#cb86-1343" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(plot.subtitle = element_text(family = "Consolas"))</span></span>
<span id="cb86-1344"><a href="#cb86-1344" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1345"><a href="#cb86-1345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1346"><a href="#cb86-1346" aria-hidden="true" tabindex="-1"></a>We get some more normal looking distributions when looking at the effect of logged GDP per capita instead. Canada, Italy, and Portugal are all still apparent null effects, since their credible intervals include zero, while all other countries have positive effects. A 10% increase in GDP per capita is associated with a 0.5ish to 1.2ish year increase in life expectancy, on average.</span>
<span id="cb86-1347"><a href="#cb86-1347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1348"><a href="#cb86-1348" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-ame-gdp-country-log, out.width="100%", fig.width=8, fig.height=5}</span></span>
<span id="cb86-1349"><a href="#cb86-1349" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-inset-right</span></span>
<span id="cb86-1350"><a href="#cb86-1350" aria-hidden="true" tabindex="-1"></a><span class="in">ame_model_gdp_country_only_log &lt;- model_gdp_country_only_log %&gt;% </span></span>
<span id="cb86-1351"><a href="#cb86-1351" aria-hidden="true" tabindex="-1"></a><span class="in">  emtrends(~ country,</span></span>
<span id="cb86-1352"><a href="#cb86-1352" aria-hidden="true" tabindex="-1"></a><span class="in">           var = "gdpPercap_log_z",</span></span>
<span id="cb86-1353"><a href="#cb86-1353" aria-hidden="true" tabindex="-1"></a><span class="in">           at = list(year = 0, country = countries$country),</span></span>
<span id="cb86-1354"><a href="#cb86-1354" aria-hidden="true" tabindex="-1"></a><span class="in">           epred = TRUE, re_formula = NULL)</span></span>
<span id="cb86-1355"><a href="#cb86-1355" aria-hidden="true" tabindex="-1"></a><span class="in">ame_model_gdp_country_only_log</span></span>
<span id="cb86-1356"><a href="#cb86-1356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1357"><a href="#cb86-1357" aria-hidden="true" tabindex="-1"></a><span class="in">pred_ame_model_gdp_country_only_log &lt;- ame_model_gdp_country_only_log %&gt;% </span></span>
<span id="cb86-1358"><a href="#cb86-1358" aria-hidden="true" tabindex="-1"></a><span class="in">  gather_emmeans_draws() %&gt;% </span></span>
<span id="cb86-1359"><a href="#cb86-1359" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(.value = .value / gdp_log_sd / 10) %&gt;% </span></span>
<span id="cb86-1360"><a href="#cb86-1360" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(countries, by = "country")</span></span>
<span id="cb86-1361"><a href="#cb86-1361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1362"><a href="#cb86-1362" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(pred_ame_model_gdp_country_only_log, aes(x = .value)) +</span></span>
<span id="cb86-1363"><a href="#cb86-1363" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye(aes(fill = continent)) +</span></span>
<span id="cb86-1364"><a href="#cb86-1364" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0) +</span></span>
<span id="cb86-1365"><a href="#cb86-1365" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_okabe_ito(order = c(2, 3, 6, 1), guide = "none") +</span></span>
<span id="cb86-1366"><a href="#cb86-1366" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(title = paste0("Average marginal effect of GDP per capita", "\n",</span></span>
<span id="cb86-1367"><a href="#cb86-1367" aria-hidden="true" tabindex="-1"></a><span class="in">                      "(intercepts and slope of GDP per capita by country)"), </span></span>
<span id="cb86-1368"><a href="#cb86-1368" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "lifeExp ~ gdpPercap_z + year + (1 + gdpPercap_z | country)",</span></span>
<span id="cb86-1369"><a href="#cb86-1369" aria-hidden="true" tabindex="-1"></a><span class="in">       x = paste0("Average marginal effect on life expectancy", "\n", </span></span>
<span id="cb86-1370"><a href="#cb86-1370" aria-hidden="true" tabindex="-1"></a><span class="in">                  "of a 10% increase in GDP per capita"), </span></span>
<span id="cb86-1371"><a href="#cb86-1371" aria-hidden="true" tabindex="-1"></a><span class="in">       y = "Density",</span></span>
<span id="cb86-1372"><a href="#cb86-1372" aria-hidden="true" tabindex="-1"></a><span class="in">       caption = "80% and 95% credible intervals shown with error bar") +</span></span>
<span id="cb86-1373"><a href="#cb86-1373" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_nested_wrap(vars(continent, country), nrow = 2, strip = nested_settings) +</span></span>
<span id="cb86-1374"><a href="#cb86-1374" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_clean() +</span></span>
<span id="cb86-1375"><a href="#cb86-1375" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(plot.subtitle = element_text(family = "Consolas"))</span></span>
<span id="cb86-1376"><a href="#cb86-1376" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1377"><a href="#cb86-1377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1378"><a href="#cb86-1378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1379"><a href="#cb86-1379" aria-hidden="true" tabindex="-1"></a><span class="fu">### `r emoji::emoji("star")` Each country gets its own intercept and GDP and year slopes `r emoji::emoji("star")`</span></span>
<span id="cb86-1380"><a href="#cb86-1380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1381"><a href="#cb86-1381" aria-hidden="true" tabindex="-1"></a>While it's cool that GDP now varies by country, we saw earlier that year-based trends in life expectancy also vary across country. We should probably incorporate country-specific differences for both GDP *and* year. Once again, multilevel modeling makes this easy—we'll allow <span class="in">`year`</span> to vary by country too by adding country-specific offsets to the year slope with a $b_{2, \text{Country}}$ term:</span>
<span id="cb86-1382"><a href="#cb86-1382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1383"><a href="#cb86-1383" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb86-1384"><a href="#cb86-1384" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb86-1385"><a href="#cb86-1385" aria-hidden="true" tabindex="-1"></a>\text{Life expectancy} &amp;= (\beta_0 + b_{0, \text{Country}}) + (\beta_1 + b_{1, \text{Country}}) \text{GDP} + (\beta_2 + b_{2, \text{Country}}) \text{Year} + \epsilon <span class="sc">\\</span></span>
<span id="cb86-1386"><a href="#cb86-1386" aria-hidden="true" tabindex="-1"></a>b_{0, \text{Country}} &amp;\sim \mathcal{N}(0, \tau_0) <span class="sc">\\</span></span>
<span id="cb86-1387"><a href="#cb86-1387" aria-hidden="true" tabindex="-1"></a>b_{1, \text{Country}} &amp;\sim \mathcal{N}(0, \tau_1) <span class="sc">\\</span></span>
<span id="cb86-1388"><a href="#cb86-1388" aria-hidden="true" tabindex="-1"></a>b_{2, \text{Country}} &amp;\sim \mathcal{N}(0, \tau_2)</span>
<span id="cb86-1389"><a href="#cb86-1389" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb86-1390"><a href="#cb86-1390" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb86-1391"><a href="#cb86-1391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1392"><a href="#cb86-1392" aria-hidden="true" tabindex="-1"></a>The syntax for this random effects term is <span class="in">`(1 + gdpPercap_z + year | country)`</span>, which lets the intercept (<span class="in">`1`</span>),  GDP per capita, and year vary by country. We'll use the scaled versions of both regular GDP per capita and logged GDP per capita again, but we'll see that we run into some serious computational issues now.</span>
<span id="cb86-1393"><a href="#cb86-1393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1394"><a href="#cb86-1394" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-gdp-country-year, cache=TRUE, warning=FALSE, results="hide"}</span></span>
<span id="cb86-1395"><a href="#cb86-1395" aria-hidden="true" tabindex="-1"></a><span class="in">model_gdp_country_year &lt;- brm(</span></span>
<span id="cb86-1396"><a href="#cb86-1396" aria-hidden="true" tabindex="-1"></a><span class="in">  bf(lifeExp ~ gdpPercap_z + year + (1 + gdpPercap_z + year | country),</span></span>
<span id="cb86-1397"><a href="#cb86-1397" aria-hidden="true" tabindex="-1"></a><span class="in">     decomp = "QR"),</span></span>
<span id="cb86-1398"><a href="#cb86-1398" aria-hidden="true" tabindex="-1"></a><span class="in">  data = gapminder,</span></span>
<span id="cb86-1399"><a href="#cb86-1399" aria-hidden="true" tabindex="-1"></a><span class="in">  chains = 4, seed = bayes_seed,</span></span>
<span id="cb86-1400"><a href="#cb86-1400" aria-hidden="true" tabindex="-1"></a><span class="in">  threads = threading(2)  # Two CPUs per chain to speed things up</span></span>
<span id="cb86-1401"><a href="#cb86-1401" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb86-1402"><a href="#cb86-1402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1403"><a href="#cb86-1403" aria-hidden="true" tabindex="-1"></a><span class="in">model_gdp_country_year_log &lt;- brm(</span></span>
<span id="cb86-1404"><a href="#cb86-1404" aria-hidden="true" tabindex="-1"></a><span class="in">  bf(lifeExp ~ gdpPercap_log_z + year + (1 + gdpPercap_log_z + year | country),</span></span>
<span id="cb86-1405"><a href="#cb86-1405" aria-hidden="true" tabindex="-1"></a><span class="in">     decomp = "QR"),</span></span>
<span id="cb86-1406"><a href="#cb86-1406" aria-hidden="true" tabindex="-1"></a><span class="in">  data = gapminder,</span></span>
<span id="cb86-1407"><a href="#cb86-1407" aria-hidden="true" tabindex="-1"></a><span class="in">  chains = 4, seed = bayes_seed,</span></span>
<span id="cb86-1408"><a href="#cb86-1408" aria-hidden="true" tabindex="-1"></a><span class="in">  threads = threading(2)  # Two CPUs per chain to speed things up</span></span>
<span id="cb86-1409"><a href="#cb86-1409" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb86-1410"><a href="#cb86-1410" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1411"><a href="#cb86-1411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1412"><a href="#cb86-1412" aria-hidden="true" tabindex="-1"></a>It takes nearly 2.5 times as long to fit the model with <span class="in">`gdpPercap_z`</span> than it does <span class="in">`gdpPercap_log_z`</span>, and there are some serious-ish issues with model convergence and effective sample size. Normally, the R-hat values for each parameter are supposed to be as close to 1 as possible, and values above 1.05 are a bad sign that the model didn't converge. Again, we could try to fix this by using specific priors, using more iterations in the chains, or adjusting some of Stan's parameters like <span class="in">`adapt_delta`</span>, but for the sake of this example, we won't.</span>
<span id="cb86-1413"><a href="#cb86-1413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1414"><a href="#cb86-1414" aria-hidden="true" tabindex="-1"></a><span class="in">```{r duration-models-gdp-country-year}</span></span>
<span id="cb86-1415"><a href="#cb86-1415" aria-hidden="true" tabindex="-1"></a><span class="in"># Model with regular GDP per capita</span></span>
<span id="cb86-1416"><a href="#cb86-1416" aria-hidden="true" tabindex="-1"></a><span class="in">rstan::get_elapsed_time(model_gdp_country_year$fit) %&gt;% </span></span>
<span id="cb86-1417"><a href="#cb86-1417" aria-hidden="true" tabindex="-1"></a><span class="in">  as_tibble(rownames = "chain") %&gt;% mutate(total_seconds = warmup + sample)</span></span>
<span id="cb86-1418"><a href="#cb86-1418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1419"><a href="#cb86-1419" aria-hidden="true" tabindex="-1"></a><span class="in"># Model with logged GDP per capita </span></span>
<span id="cb86-1420"><a href="#cb86-1420" aria-hidden="true" tabindex="-1"></a><span class="in">rstan::get_elapsed_time(model_gdp_country_year_log$fit) %&gt;% </span></span>
<span id="cb86-1421"><a href="#cb86-1421" aria-hidden="true" tabindex="-1"></a><span class="in">  as_tibble(rownames = "chain") %&gt;% mutate(total_seconds = warmup + sample)</span></span>
<span id="cb86-1422"><a href="#cb86-1422" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1423"><a href="#cb86-1423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1424"><a href="#cb86-1424" aria-hidden="true" tabindex="-1"></a><span class="in">```{r diagnostics-models-gdp-country-year, cache=TRUE}</span></span>
<span id="cb86-1425"><a href="#cb86-1425" aria-hidden="true" tabindex="-1"></a><span class="in"># Bad R-hats and low effective sample sizes</span></span>
<span id="cb86-1426"><a href="#cb86-1426" aria-hidden="true" tabindex="-1"></a><span class="in">bayestestR::diagnostic_posterior(model_gdp_country_year)</span></span>
<span id="cb86-1427"><a href="#cb86-1427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1428"><a href="#cb86-1428" aria-hidden="true" tabindex="-1"></a><span class="in"># Okay R-hats and okay-ish effective sample sizes</span></span>
<span id="cb86-1429"><a href="#cb86-1429" aria-hidden="true" tabindex="-1"></a><span class="in">bayestestR::diagnostic_posterior(model_gdp_country_year_log)</span></span>
<span id="cb86-1430"><a href="#cb86-1430" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1431"><a href="#cb86-1431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1432"><a href="#cb86-1432" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-model-gdp-country-year, include=FALSE}</span></span>
<span id="cb86-1433"><a href="#cb86-1433" aria-hidden="true" tabindex="-1"></a><span class="in">m_gdp_country_year &lt;- tidy(model_gdp_country_year) %&gt;% </span></span>
<span id="cb86-1434"><a href="#cb86-1434" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(across(c(estimate, std.error, conf.low, conf.high),</span></span>
<span id="cb86-1435"><a href="#cb86-1435" aria-hidden="true" tabindex="-1"></a><span class="in">                ~ifelse(term %in% c("gdpPercap_z", "sd__gdpPercap_z"), </span></span>
<span id="cb86-1436"><a href="#cb86-1436" aria-hidden="true" tabindex="-1"></a><span class="in">                        (. / gdp_sd) * 1000, .))) %&gt;% </span></span>
<span id="cb86-1437"><a href="#cb86-1437" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(term = janitor::make_clean_names(term),</span></span>
<span id="cb86-1438"><a href="#cb86-1438" aria-hidden="true" tabindex="-1"></a><span class="in">         est = round(estimate, 2)) %&gt;% </span></span>
<span id="cb86-1439"><a href="#cb86-1439" aria-hidden="true" tabindex="-1"></a><span class="in">  split(~ term)</span></span>
<span id="cb86-1440"><a href="#cb86-1440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1441"><a href="#cb86-1441" aria-hidden="true" tabindex="-1"></a><span class="in">m_gdp_country_year_log &lt;- tidy(model_gdp_country_year_log) %&gt;% </span></span>
<span id="cb86-1442"><a href="#cb86-1442" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(across(c(estimate, std.error, conf.low, conf.high),</span></span>
<span id="cb86-1443"><a href="#cb86-1443" aria-hidden="true" tabindex="-1"></a><span class="in">                ~ifelse(term %in% c("gdpPercap_log_z", "sd__gdpPercap_log_z"), </span></span>
<span id="cb86-1444"><a href="#cb86-1444" aria-hidden="true" tabindex="-1"></a><span class="in">                        (. / gdp_log_sd), .))) %&gt;% </span></span>
<span id="cb86-1445"><a href="#cb86-1445" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(term = janitor::make_clean_names(term),</span></span>
<span id="cb86-1446"><a href="#cb86-1446" aria-hidden="true" tabindex="-1"></a><span class="in">         est = round(estimate, 2)) %&gt;% </span></span>
<span id="cb86-1447"><a href="#cb86-1447" aria-hidden="true" tabindex="-1"></a><span class="in">  split(~ term)</span></span>
<span id="cb86-1448"><a href="#cb86-1448" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1449"><a href="#cb86-1449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1450"><a href="#cb86-1450" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Fixed (population-level) effects</span></span>
<span id="cb86-1451"><a href="#cb86-1451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1452"><a href="#cb86-1452" aria-hidden="true" tabindex="-1"></a>The global population-level coefficients are again similar to what we saw in the previous models: holding year trends constant, life expectancy increases by <span class="in">`r m_gdp_country_year$gdp_percap_z$est`</span> years for every <span class="sc">\\</span>$1,000 increase in wealth and <span class="in">`r m_gdp_country_year_log$gdp_percap_log_z$est / 10`</span> years for every 10% increase in wealth, on average.</span>
<span id="cb86-1453"><a href="#cb86-1453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1454"><a href="#cb86-1454" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-model-gdp-country-year-unscaled, warning=FALSE}</span></span>
<span id="cb86-1455"><a href="#cb86-1455" aria-hidden="true" tabindex="-1"></a><span class="in"># Unscale both the GDP coefficient and the GDP random variance coefficient</span></span>
<span id="cb86-1456"><a href="#cb86-1456" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_gdp_country_year) %&gt;% </span></span>
<span id="cb86-1457"><a href="#cb86-1457" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(across(c(estimate, std.error, conf.low, conf.high),</span></span>
<span id="cb86-1458"><a href="#cb86-1458" aria-hidden="true" tabindex="-1"></a><span class="in">                ~ifelse(term %in% c("gdpPercap_z", "sd__gdpPercap_z"), </span></span>
<span id="cb86-1459"><a href="#cb86-1459" aria-hidden="true" tabindex="-1"></a><span class="in">                        (. / gdp_sd) * 1000, .)))</span></span>
<span id="cb86-1460"><a href="#cb86-1460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1461"><a href="#cb86-1461" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_gdp_country_year_log) %&gt;% </span></span>
<span id="cb86-1462"><a href="#cb86-1462" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(across(c(estimate, std.error, conf.low, conf.high),</span></span>
<span id="cb86-1463"><a href="#cb86-1463" aria-hidden="true" tabindex="-1"></a><span class="in">                ~ifelse(term %in% c("gdpPercap_log_z", "sd__gdpPercap_log_z"), </span></span>
<span id="cb86-1464"><a href="#cb86-1464" aria-hidden="true" tabindex="-1"></a><span class="in">                        (. / gdp_log_sd), .)))</span></span>
<span id="cb86-1465"><a href="#cb86-1465" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1466"><a href="#cb86-1466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1467"><a href="#cb86-1467" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Country-level variation and random effects</span></span>
<span id="cb86-1468"><a href="#cb86-1468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1469"><a href="#cb86-1469" aria-hidden="true" tabindex="-1"></a>We'll forgo detailed interpretations of all our new random effects values and instead just point out that we have estimates for each of the $\tau$s: country-based variation in the intercept, the GDP slope, and the year slope. We also have three different correlations now: the correlation between the intercept and the GDP slope, the intercept and the year slope, and the GDP and year slopes. Neat.</span>
<span id="cb86-1470"><a href="#cb86-1470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1471"><a href="#cb86-1471" aria-hidden="true" tabindex="-1"></a>If we look at the country-level coefficients, we can see that the intercepts, GDP slopes, and year slopes all vary by different amounts across countries, as intended:</span>
<span id="cb86-1472"><a href="#cb86-1472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1473"><a href="#cb86-1473" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-gdp-country-year-offsets}</span></span>
<span id="cb86-1474"><a href="#cb86-1474" aria-hidden="true" tabindex="-1"></a><span class="in">coef(model_gdp_country_year)$country %&gt;%</span></span>
<span id="cb86-1475"><a href="#cb86-1475" aria-hidden="true" tabindex="-1"></a><span class="in">  as_tibble(rownames = "country") %&gt;% </span></span>
<span id="cb86-1476"><a href="#cb86-1476" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(country %in% countries$country) %&gt;% </span></span>
<span id="cb86-1477"><a href="#cb86-1477" aria-hidden="true" tabindex="-1"></a><span class="in">  select(country, starts_with("Estimate")) %&gt;% </span></span>
<span id="cb86-1478"><a href="#cb86-1478" aria-hidden="true" tabindex="-1"></a><span class="in">  # Unscale the GDP offsets</span></span>
<span id="cb86-1479"><a href="#cb86-1479" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(Estimate.gdpPercap_z = Estimate.gdpPercap_z / gdp_sd * 1000)</span></span>
<span id="cb86-1480"><a href="#cb86-1480" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1481"><a href="#cb86-1481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1482"><a href="#cb86-1482" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Visualize results</span></span>
<span id="cb86-1483"><a href="#cb86-1483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1484"><a href="#cb86-1484" aria-hidden="true" tabindex="-1"></a>As usual, we can visualize the distribution of these country-specific GDP effects. If we look at regular GDP, we can immediately see some weirdness—a few of these distributions like Sierra Leone and Bolivia aren't very smooth, likely because we didn't specify good priors and because the model didn't fully converge. These things look goofy and we shouldn't put too much stock in them. Canada, Italy, and Portugal all seem to have null effects, along with Egypt now for whatever reason. But again, these are strange and the model isn't that great, so we can stop looking at this. Scroll down.</span>
<span id="cb86-1485"><a href="#cb86-1485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1486"><a href="#cb86-1486" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-ame-gdp-country-year, out.width="100%", fig.width=8, fig.height=5}</span></span>
<span id="cb86-1487"><a href="#cb86-1487" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-inset-right</span></span>
<span id="cb86-1488"><a href="#cb86-1488" aria-hidden="true" tabindex="-1"></a><span class="in">ame_model_gdp_country_year &lt;- model_gdp_country_year %&gt;% </span></span>
<span id="cb86-1489"><a href="#cb86-1489" aria-hidden="true" tabindex="-1"></a><span class="in">  emtrends(~ year + country,</span></span>
<span id="cb86-1490"><a href="#cb86-1490" aria-hidden="true" tabindex="-1"></a><span class="in">           var = "gdpPercap_z",</span></span>
<span id="cb86-1491"><a href="#cb86-1491" aria-hidden="true" tabindex="-1"></a><span class="in">           at = list(year = 0, country = countries$country),</span></span>
<span id="cb86-1492"><a href="#cb86-1492" aria-hidden="true" tabindex="-1"></a><span class="in">           epred = TRUE, re_formula = NULL)</span></span>
<span id="cb86-1493"><a href="#cb86-1493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1494"><a href="#cb86-1494" aria-hidden="true" tabindex="-1"></a><span class="in">pred_ame_model_gdp_country_year &lt;- ame_model_gdp_country_year %&gt;% </span></span>
<span id="cb86-1495"><a href="#cb86-1495" aria-hidden="true" tabindex="-1"></a><span class="in">  gather_emmeans_draws() %&gt;% </span></span>
<span id="cb86-1496"><a href="#cb86-1496" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(.value = .value / gdp_sd * 1000) %&gt;% </span></span>
<span id="cb86-1497"><a href="#cb86-1497" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(countries, by = "country")</span></span>
<span id="cb86-1498"><a href="#cb86-1498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1499"><a href="#cb86-1499" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(pred_ame_model_gdp_country_year, aes(x = .value)) +</span></span>
<span id="cb86-1500"><a href="#cb86-1500" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye(aes(fill = continent)) +</span></span>
<span id="cb86-1501"><a href="#cb86-1501" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0) +</span></span>
<span id="cb86-1502"><a href="#cb86-1502" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_okabe_ito(order = c(2, 3, 6, 1), guide = "none") +</span></span>
<span id="cb86-1503"><a href="#cb86-1503" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(title = paste0("Average marginal effect of GDP per capita", "\n",</span></span>
<span id="cb86-1504"><a href="#cb86-1504" aria-hidden="true" tabindex="-1"></a><span class="in">                      "(intercepts and slopes of both GDP per capita and year vary by country)"), </span></span>
<span id="cb86-1505"><a href="#cb86-1505" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "lifeExp ~ gdpPercap_log_z + year + (1 + gdpPercap_z + year | country)",</span></span>
<span id="cb86-1506"><a href="#cb86-1506" aria-hidden="true" tabindex="-1"></a><span class="in">       x = paste0("Average marginal effect on life expectancy", "\n", </span></span>
<span id="cb86-1507"><a href="#cb86-1507" aria-hidden="true" tabindex="-1"></a><span class="in">                  "of a $1,000 increase in GDP per capita"), </span></span>
<span id="cb86-1508"><a href="#cb86-1508" aria-hidden="true" tabindex="-1"></a><span class="in">       y = "Density",</span></span>
<span id="cb86-1509"><a href="#cb86-1509" aria-hidden="true" tabindex="-1"></a><span class="in">       caption = "80% and 95% credible intervals shown with error bar") +</span></span>
<span id="cb86-1510"><a href="#cb86-1510" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_nested_wrap(vars(continent, country), nrow = 2, strip = nested_settings) +</span></span>
<span id="cb86-1511"><a href="#cb86-1511" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_clean() +</span></span>
<span id="cb86-1512"><a href="#cb86-1512" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(plot.subtitle = element_text(family = "Consolas"))</span></span>
<span id="cb86-1513"><a href="#cb86-1513" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1514"><a href="#cb86-1514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1515"><a href="#cb86-1515" aria-hidden="true" tabindex="-1"></a>The average marginal effects for logged GDP per capita look a lot smoother (and the model actually converged), so I trust these results more. After accounting for country- and year-specific differences, Canada, Italy, and Portugal all have positive GDP per capita slopes: a 10% increase in GDP per capita is associated with a 0.5ish year increase in life expectancy. We see a slightly smaller effect in Sierra Leone, and even smaller (and less "significant") effects everywhere else.</span>
<span id="cb86-1516"><a href="#cb86-1516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1517"><a href="#cb86-1517" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-ame-gdp-country-year-log, out.width="100%", fig.width=8, fig.height=5}</span></span>
<span id="cb86-1518"><a href="#cb86-1518" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-inset-right</span></span>
<span id="cb86-1519"><a href="#cb86-1519" aria-hidden="true" tabindex="-1"></a><span class="in">ame_model_gdp_country_year_log &lt;- model_gdp_country_year_log %&gt;% </span></span>
<span id="cb86-1520"><a href="#cb86-1520" aria-hidden="true" tabindex="-1"></a><span class="in">  emtrends(~ year + country,</span></span>
<span id="cb86-1521"><a href="#cb86-1521" aria-hidden="true" tabindex="-1"></a><span class="in">           var = "gdpPercap_log_z",</span></span>
<span id="cb86-1522"><a href="#cb86-1522" aria-hidden="true" tabindex="-1"></a><span class="in">           at = list(year = 0, country = countries$country),</span></span>
<span id="cb86-1523"><a href="#cb86-1523" aria-hidden="true" tabindex="-1"></a><span class="in">           epred = TRUE, re_formula = NULL)</span></span>
<span id="cb86-1524"><a href="#cb86-1524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1525"><a href="#cb86-1525" aria-hidden="true" tabindex="-1"></a><span class="in">pred_ame_model_gdp_country_year_log &lt;- ame_model_gdp_country_year_log %&gt;% </span></span>
<span id="cb86-1526"><a href="#cb86-1526" aria-hidden="true" tabindex="-1"></a><span class="in">  gather_emmeans_draws() %&gt;% </span></span>
<span id="cb86-1527"><a href="#cb86-1527" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(.value = .value / gdp_log_sd / 10) %&gt;% </span></span>
<span id="cb86-1528"><a href="#cb86-1528" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(countries, by = "country")</span></span>
<span id="cb86-1529"><a href="#cb86-1529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1530"><a href="#cb86-1530" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(pred_ame_model_gdp_country_year_log, aes(x = .value)) +</span></span>
<span id="cb86-1531"><a href="#cb86-1531" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye(aes(fill = continent)) +</span></span>
<span id="cb86-1532"><a href="#cb86-1532" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0) +</span></span>
<span id="cb86-1533"><a href="#cb86-1533" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_okabe_ito(order = c(2, 3, 6, 1), guide = "none") +</span></span>
<span id="cb86-1534"><a href="#cb86-1534" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(title = paste0("Average marginal effect of GDP per capita", "\n",</span></span>
<span id="cb86-1535"><a href="#cb86-1535" aria-hidden="true" tabindex="-1"></a><span class="in">                      "(intercepts and slopes of both GDP per capita and year vary by country)"), </span></span>
<span id="cb86-1536"><a href="#cb86-1536" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "lifeExp ~ gdpPercap_log_z + year + (1 + gdpPercap_log_z + year | country)",</span></span>
<span id="cb86-1537"><a href="#cb86-1537" aria-hidden="true" tabindex="-1"></a><span class="in">       x = paste0("Average marginal effect on life expectancy", "\n", </span></span>
<span id="cb86-1538"><a href="#cb86-1538" aria-hidden="true" tabindex="-1"></a><span class="in">                  "of a 10% increase in GDP per capita"), </span></span>
<span id="cb86-1539"><a href="#cb86-1539" aria-hidden="true" tabindex="-1"></a><span class="in">       y = "Density",</span></span>
<span id="cb86-1540"><a href="#cb86-1540" aria-hidden="true" tabindex="-1"></a><span class="in">       caption = "80% and 95% credible intervals shown with error bar") +</span></span>
<span id="cb86-1541"><a href="#cb86-1541" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_nested_wrap(vars(continent, country), nrow = 2, strip = nested_settings) +</span></span>
<span id="cb86-1542"><a href="#cb86-1542" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_clean() +</span></span>
<span id="cb86-1543"><a href="#cb86-1543" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(plot.subtitle = element_text(family = "Consolas"))</span></span>
<span id="cb86-1544"><a href="#cb86-1544" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1545"><a href="#cb86-1545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1546"><a href="#cb86-1546" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Visualize more generic average marginal effects</span></span>
<span id="cb86-1547"><a href="#cb86-1547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1548"><a href="#cb86-1548" aria-hidden="true" tabindex="-1"></a>It's really really neat that we can look at the specific effect of GDP on life expectancy in every country individually, but often we just want report a single number—what is the average effect of health on wealth? We don't want to report <span class="in">`r length(unique(gapminder$country))`</span> separate GDP effects! We just want one!</span>
<span id="cb86-1549"><a href="#cb86-1549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1550"><a href="#cb86-1550" aria-hidden="true" tabindex="-1"></a>We can consolidate these country-specific effects into a single value a couple different ways:</span>
<span id="cb86-1551"><a href="#cb86-1551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1552"><a href="#cb86-1552" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Report a global grand mean, or the average predicted outcome ignoring country-specific deviations</span>
<span id="cb86-1553"><a href="#cb86-1553" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Report the average predicted outcome for a hypothetical new country</span>
<span id="cb86-1554"><a href="#cb86-1554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1555"><a href="#cb86-1555" aria-hidden="true" tabindex="-1"></a>There are a ton of details about these different approaches for finding average marginal effects <span class="co">[</span><span class="ot">at this post here</span><span class="co">](https://www.andrewheiss.com/blog/2021/11/10/ame-bayes-re-guide/)</span>—go there to learn all about the nuances of doing this.</span>
<span id="cb86-1556"><a href="#cb86-1556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1557"><a href="#cb86-1557" aria-hidden="true" tabindex="-1"></a>Here we'll do it both ways: calculate a global grand mean and simulate a fake new country (we'll call it Atlantis).</span>
<span id="cb86-1558"><a href="#cb86-1558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1559"><a href="#cb86-1559" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-global-hypothetical-country-year, out.width="90%", fig.width=8, fig.height=5}</span></span>
<span id="cb86-1560"><a href="#cb86-1560" aria-hidden="true" tabindex="-1"></a><span class="in"># Calculate the overall global effect</span></span>
<span id="cb86-1561"><a href="#cb86-1561" aria-hidden="true" tabindex="-1"></a><span class="in"># `re_formula = NA` means that no random effects will be incorporated</span></span>
<span id="cb86-1562"><a href="#cb86-1562" aria-hidden="true" tabindex="-1"></a><span class="in">ame_global_gdp_country_year &lt;- model_gdp_country_year_log %&gt;% </span></span>
<span id="cb86-1563"><a href="#cb86-1563" aria-hidden="true" tabindex="-1"></a><span class="in">  emtrends(~ 1,</span></span>
<span id="cb86-1564"><a href="#cb86-1564" aria-hidden="true" tabindex="-1"></a><span class="in">           var = "gdpPercap_log_z",</span></span>
<span id="cb86-1565"><a href="#cb86-1565" aria-hidden="true" tabindex="-1"></a><span class="in">           epred = TRUE, re_formula = NA)</span></span>
<span id="cb86-1566"><a href="#cb86-1566" aria-hidden="true" tabindex="-1"></a><span class="in">ame_global_gdp_country_year</span></span>
<span id="cb86-1567"><a href="#cb86-1567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1568"><a href="#cb86-1568" aria-hidden="true" tabindex="-1"></a><span class="in"># Get the posterior distribution of this global effect and make a plot</span></span>
<span id="cb86-1569"><a href="#cb86-1569" aria-hidden="true" tabindex="-1"></a><span class="in">pred_global_gdp_country_year &lt;- ame_global_gdp_country_year %&gt;% </span></span>
<span id="cb86-1570"><a href="#cb86-1570" aria-hidden="true" tabindex="-1"></a><span class="in">  gather_emmeans_draws() %&gt;% </span></span>
<span id="cb86-1571"><a href="#cb86-1571" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(.value = (.value / gdp_log_sd) / 10) %&gt;% </span></span>
<span id="cb86-1572"><a href="#cb86-1572" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(fake_facet_title = "Global grand mean")</span></span>
<span id="cb86-1573"><a href="#cb86-1573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1574"><a href="#cb86-1574" aria-hidden="true" tabindex="-1"></a><span class="in">plot_global_gdp_country_year &lt;- ggplot(pred_global_gdp_country_year, aes(x = .value)) +</span></span>
<span id="cb86-1575"><a href="#cb86-1575" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye(fill = palette_okabe_ito(5)) +</span></span>
<span id="cb86-1576"><a href="#cb86-1576" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0) +</span></span>
<span id="cb86-1577"><a href="#cb86-1577" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = paste0("Average marginal effect on life expectancy", "\n", </span></span>
<span id="cb86-1578"><a href="#cb86-1578" aria-hidden="true" tabindex="-1"></a><span class="in">                  "of a 10% increase in GDP per capita"), </span></span>
<span id="cb86-1579"><a href="#cb86-1579" aria-hidden="true" tabindex="-1"></a><span class="in">       y = "Density") +</span></span>
<span id="cb86-1580"><a href="#cb86-1580" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(vars(fake_facet_title)) +</span></span>
<span id="cb86-1581"><a href="#cb86-1581" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_clean() +</span></span>
<span id="cb86-1582"><a href="#cb86-1582" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(strip.text = element_text(size = rel(1.1)))</span></span>
<span id="cb86-1583"><a href="#cb86-1583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1584"><a href="#cb86-1584" aria-hidden="true" tabindex="-1"></a><span class="in"># Calculate the effect for Atlantis</span></span>
<span id="cb86-1585"><a href="#cb86-1585" aria-hidden="true" tabindex="-1"></a><span class="in"># `re_formula = NULL` means the full random effects structure will be</span></span>
<span id="cb86-1586"><a href="#cb86-1586" aria-hidden="true" tabindex="-1"></a><span class="in"># incorporated. `allow_new_levels` lets R deal with a new country, and</span></span>
<span id="cb86-1587"><a href="#cb86-1587" aria-hidden="true" tabindex="-1"></a><span class="in"># `sample_new_levels = "gaussian"` means that the characteristics for this new</span></span>
<span id="cb86-1588"><a href="#cb86-1588" aria-hidden="true" tabindex="-1"></a><span class="in"># country will be based on random draws from the model</span></span>
<span id="cb86-1589"><a href="#cb86-1589" aria-hidden="true" tabindex="-1"></a><span class="in">ame_hypo_gdp_country_year &lt;- model_gdp_country_year_log %&gt;% </span></span>
<span id="cb86-1590"><a href="#cb86-1590" aria-hidden="true" tabindex="-1"></a><span class="in">  emtrends(~ 1 + country,</span></span>
<span id="cb86-1591"><a href="#cb86-1591" aria-hidden="true" tabindex="-1"></a><span class="in">           var = "gdpPercap_log_z",</span></span>
<span id="cb86-1592"><a href="#cb86-1592" aria-hidden="true" tabindex="-1"></a><span class="in">           at = list(country = "Atlantis"),</span></span>
<span id="cb86-1593"><a href="#cb86-1593" aria-hidden="true" tabindex="-1"></a><span class="in">           epred = TRUE, re_formula = NULL, </span></span>
<span id="cb86-1594"><a href="#cb86-1594" aria-hidden="true" tabindex="-1"></a><span class="in">           allow_new_levels = TRUE, sample_new_levels = "gaussian")</span></span>
<span id="cb86-1595"><a href="#cb86-1595" aria-hidden="true" tabindex="-1"></a><span class="in">ame_hypo_gdp_country_year</span></span>
<span id="cb86-1596"><a href="#cb86-1596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1597"><a href="#cb86-1597" aria-hidden="true" tabindex="-1"></a><span class="in"># Get the posterior distribution of this Atlantis effect and make a plot</span></span>
<span id="cb86-1598"><a href="#cb86-1598" aria-hidden="true" tabindex="-1"></a><span class="in">pred_hypo_gdp_country_year &lt;- ame_hypo_gdp_country_year %&gt;% </span></span>
<span id="cb86-1599"><a href="#cb86-1599" aria-hidden="true" tabindex="-1"></a><span class="in">  gather_emmeans_draws() %&gt;% </span></span>
<span id="cb86-1600"><a href="#cb86-1600" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(.value = (.value / gdp_log_sd) / 10) %&gt;% </span></span>
<span id="cb86-1601"><a href="#cb86-1601" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(fake_facet_title = "AME for hypothetical Atlantis")</span></span>
<span id="cb86-1602"><a href="#cb86-1602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1603"><a href="#cb86-1603" aria-hidden="true" tabindex="-1"></a><span class="in">plot_hypo_gdp_country_year &lt;- ggplot(pred_hypo_gdp_country_year, aes(x = .value)) +</span></span>
<span id="cb86-1604"><a href="#cb86-1604" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye(fill = palette_okabe_ito(7)) +</span></span>
<span id="cb86-1605"><a href="#cb86-1605" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0) +</span></span>
<span id="cb86-1606"><a href="#cb86-1606" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = paste0("Average marginal effect on life expectancy", "\n", </span></span>
<span id="cb86-1607"><a href="#cb86-1607" aria-hidden="true" tabindex="-1"></a><span class="in">                  "of a 10% increase in GDP per capita"), </span></span>
<span id="cb86-1608"><a href="#cb86-1608" aria-hidden="true" tabindex="-1"></a><span class="in">       y = "Density") +</span></span>
<span id="cb86-1609"><a href="#cb86-1609" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(vars(fake_facet_title)) +</span></span>
<span id="cb86-1610"><a href="#cb86-1610" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_clean() +</span></span>
<span id="cb86-1611"><a href="#cb86-1611" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(strip.text = element_text(size = rel(1.1)))</span></span>
<span id="cb86-1612"><a href="#cb86-1612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1613"><a href="#cb86-1613" aria-hidden="true" tabindex="-1"></a><span class="in"># Show the two AME distributions side-by-side</span></span>
<span id="cb86-1614"><a href="#cb86-1614" aria-hidden="true" tabindex="-1"></a><span class="in">(plot_global_gdp_country_year | plot_hypo_gdp_country_year) +</span></span>
<span id="cb86-1615"><a href="#cb86-1615" aria-hidden="true" tabindex="-1"></a><span class="in">  plot_annotation(title = paste0("Average marginal effect of GDP per capita", "\n",</span></span>
<span id="cb86-1616"><a href="#cb86-1616" aria-hidden="true" tabindex="-1"></a><span class="in">                                 "(intercepts and slopes of both GDP per capita and year vary by country)"), </span></span>
<span id="cb86-1617"><a href="#cb86-1617" aria-hidden="true" tabindex="-1"></a><span class="in">                  subtitle = "lifeExp ~ gdpPercap_log_z + year + (1 + gdpPercap_log_z + year | country)",</span></span>
<span id="cb86-1618"><a href="#cb86-1618" aria-hidden="true" tabindex="-1"></a><span class="in">                  caption = "80% and 95% credible intervals shown with error bar",</span></span>
<span id="cb86-1619"><a href="#cb86-1619" aria-hidden="true" tabindex="-1"></a><span class="in">                  theme = theme_clean() + theme(plot.subtitle = element_text(family = "Consolas")))</span></span>
<span id="cb86-1620"><a href="#cb86-1620" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1621"><a href="#cb86-1621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1622"><a href="#cb86-1622" aria-hidden="true" tabindex="-1"></a><span class="fu">### Each country gets its own intercept and GDP and year slopes *and* year-specific offsets in the GDP slope</span></span>
<span id="cb86-1623"><a href="#cb86-1623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1624"><a href="#cb86-1624" aria-hidden="true" tabindex="-1"></a>This <span class="in">`lifeExp ~ gdpPercap_z + year + (1 + gdpPercap_z + year | country)`</span> approach is typically sufficient for models based on panel data, but like we did earlier, we can be extra fancy and include random effects for year-specific differences in the GDP per capita effect that are independent of country-specific differences. These typically represent time-specific global shocks, like recessions or pandemics.</span>
<span id="cb86-1625"><a href="#cb86-1625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1626"><a href="#cb86-1626" aria-hidden="true" tabindex="-1"></a>To do this, we'll add independent year-based offsets to the intercept term ($b_{0, \text{Year}}$) and to the GDP effect:</span>
<span id="cb86-1627"><a href="#cb86-1627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1628"><a href="#cb86-1628" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb86-1629"><a href="#cb86-1629" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb86-1630"><a href="#cb86-1630" aria-hidden="true" tabindex="-1"></a>\text{Life expectancy} &amp;= (\beta_0 + b_{0, \text{Country}} + b_{0, \text{Year}}) + (\beta_1 + b_{1, \text{Country}} + b_{1, \text{Year}}) \text{GDP} + <span class="sc">\\</span></span>
<span id="cb86-1631"><a href="#cb86-1631" aria-hidden="true" tabindex="-1"></a>&amp;= (\beta_2 + b_{2, \text{Country}}) \text{Year} + \epsilon <span class="sc">\\</span></span>
<span id="cb86-1632"><a href="#cb86-1632" aria-hidden="true" tabindex="-1"></a>b_{0, \text{Country}} &amp;\sim \mathcal{N}(0, \tau_{0, \text{Country}}) <span class="sc">\\</span></span>
<span id="cb86-1633"><a href="#cb86-1633" aria-hidden="true" tabindex="-1"></a>b_{1, \text{Country}} &amp;\sim \mathcal{N}(0, \tau_{1, \text{Country}}) <span class="sc">\\</span></span>
<span id="cb86-1634"><a href="#cb86-1634" aria-hidden="true" tabindex="-1"></a>b_{2, \text{Country}} &amp;\sim \mathcal{N}(0, \tau_{2, \text{Country}}) <span class="sc">\\</span></span>
<span id="cb86-1635"><a href="#cb86-1635" aria-hidden="true" tabindex="-1"></a>b_{0, \text{Year}} &amp;\sim \mathcal{N}(0, \tau_{0, \text{Year}}) <span class="sc">\\</span></span>
<span id="cb86-1636"><a href="#cb86-1636" aria-hidden="true" tabindex="-1"></a>b_{1, \text{Year}} &amp;\sim \mathcal{N}(0, \tau_{1, \text{Country}})</span>
<span id="cb86-1637"><a href="#cb86-1637" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb86-1638"><a href="#cb86-1638" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb86-1639"><a href="#cb86-1639" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1640"><a href="#cb86-1640" aria-hidden="true" tabindex="-1"></a>There are so many moving parts here!</span>
<span id="cb86-1641"><a href="#cb86-1641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1642"><a href="#cb86-1642" aria-hidden="true" tabindex="-1"></a>In code, we add two random effects terms: <span class="in">`(1 + gdpPercap_log_z | year) + (1 + gdpPercap_log_z + year | country)`</span>. The intercept and the GDP effect get their own year-specific offsets, and the intercept, GDP effect, and year effect get their own country-specific offsets.</span>
<span id="cb86-1643"><a href="#cb86-1643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1644"><a href="#cb86-1644" aria-hidden="true" tabindex="-1"></a>We won't even try to use the regular GDP per capita measure—Stan will choke unless we do some fine tuning. We'll just look at logged GDP per capita.</span>
<span id="cb86-1645"><a href="#cb86-1645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1646"><a href="#cb86-1646" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-gdp-country-year-year, cache=TRUE, warning=FALSE, results="hide"}</span></span>
<span id="cb86-1647"><a href="#cb86-1647" aria-hidden="true" tabindex="-1"></a><span class="in">model_gdp_country_year_year &lt;- brm(</span></span>
<span id="cb86-1648"><a href="#cb86-1648" aria-hidden="true" tabindex="-1"></a><span class="in">  bf(lifeExp ~ gdpPercap_log_z + year + (1 + gdpPercap_log_z | year) + </span></span>
<span id="cb86-1649"><a href="#cb86-1649" aria-hidden="true" tabindex="-1"></a><span class="in">       (1 + gdpPercap_log_z + year | country),</span></span>
<span id="cb86-1650"><a href="#cb86-1650" aria-hidden="true" tabindex="-1"></a><span class="in">     decomp = "QR"),</span></span>
<span id="cb86-1651"><a href="#cb86-1651" aria-hidden="true" tabindex="-1"></a><span class="in">  data = gapminder,</span></span>
<span id="cb86-1652"><a href="#cb86-1652" aria-hidden="true" tabindex="-1"></a><span class="in">  cores = 4, chains = 4, seed = bayes_seed,</span></span>
<span id="cb86-1653"><a href="#cb86-1653" aria-hidden="true" tabindex="-1"></a><span class="in">  threads = threading(2)  # Two CPUs per chain to speed things up</span></span>
<span id="cb86-1654"><a href="#cb86-1654" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb86-1655"><a href="#cb86-1655" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1656"><a href="#cb86-1656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1657"><a href="#cb86-1657" aria-hidden="true" tabindex="-1"></a><span class="in">```{r duration-models-gdp-country-year-year}</span></span>
<span id="cb86-1658"><a href="#cb86-1658" aria-hidden="true" tabindex="-1"></a><span class="in">rstan::get_elapsed_time(model_gdp_country_year_year$fit) %&gt;% </span></span>
<span id="cb86-1659"><a href="#cb86-1659" aria-hidden="true" tabindex="-1"></a><span class="in">  as_tibble(rownames = "chain") %&gt;% mutate(total_seconds = warmup + sample)</span></span>
<span id="cb86-1660"><a href="#cb86-1660" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1661"><a href="#cb86-1661" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1662"><a href="#cb86-1662" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-model-gdp-country-year-year, include=FALSE}</span></span>
<span id="cb86-1663"><a href="#cb86-1663" aria-hidden="true" tabindex="-1"></a><span class="in">m_gdp_country_year_year &lt;- tidy(model_gdp_country_year_year) %&gt;% </span></span>
<span id="cb86-1664"><a href="#cb86-1664" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(across(c(estimate, std.error, conf.low, conf.high),</span></span>
<span id="cb86-1665"><a href="#cb86-1665" aria-hidden="true" tabindex="-1"></a><span class="in">                ~ifelse(term %in% c("gdpPercap_log_z", "sd__gdpPercap_log_z"), </span></span>
<span id="cb86-1666"><a href="#cb86-1666" aria-hidden="true" tabindex="-1"></a><span class="in">                        (. / gdp_log_sd), .))) %&gt;% </span></span>
<span id="cb86-1667"><a href="#cb86-1667" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(term = janitor::make_clean_names(term),</span></span>
<span id="cb86-1668"><a href="#cb86-1668" aria-hidden="true" tabindex="-1"></a><span class="in">         est = round(estimate, 2)) %&gt;% </span></span>
<span id="cb86-1669"><a href="#cb86-1669" aria-hidden="true" tabindex="-1"></a><span class="in">  split(~ term)</span></span>
<span id="cb86-1670"><a href="#cb86-1670" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1671"><a href="#cb86-1671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1672"><a href="#cb86-1672" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Fixed (population-level) effects</span></span>
<span id="cb86-1673"><a href="#cb86-1673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1674"><a href="#cb86-1674" aria-hidden="true" tabindex="-1"></a>The global population-level coefficients are again similar to what we saw in the previous models: holding year trends constant, life expectancy increases by <span class="in">`r m_gdp_country_year_year$gdp_percap_log_z$est / 10`</span> years for every 10% increase in wealth, on average.</span>
<span id="cb86-1675"><a href="#cb86-1675" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1676"><a href="#cb86-1676" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-model-gdp-country-year-year-unscaled, warning=FALSE}</span></span>
<span id="cb86-1677"><a href="#cb86-1677" aria-hidden="true" tabindex="-1"></a><span class="in"># Unscale both the GDP coefficient and the GDP random variance coefficient</span></span>
<span id="cb86-1678"><a href="#cb86-1678" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_gdp_country_year_year) %&gt;% </span></span>
<span id="cb86-1679"><a href="#cb86-1679" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(across(c(estimate, std.error, conf.low, conf.high),</span></span>
<span id="cb86-1680"><a href="#cb86-1680" aria-hidden="true" tabindex="-1"></a><span class="in">                ~ifelse(term %in% c("gdpPercap_log_z", "sd__gdpPercap_log_z"), </span></span>
<span id="cb86-1681"><a href="#cb86-1681" aria-hidden="true" tabindex="-1"></a><span class="in">                        (. / gdp_log_sd), .)))</span></span>
<span id="cb86-1682"><a href="#cb86-1682" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1683"><a href="#cb86-1683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1684"><a href="#cb86-1684" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Country-level variation and random effects</span></span>
<span id="cb86-1685"><a href="#cb86-1685" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1686"><a href="#cb86-1686" aria-hidden="true" tabindex="-1"></a>We'll again forgo detailed interpretations of all our new random effects values. Just note that there are five different $\tau$ values, as expected, and four different correlations.</span>
<span id="cb86-1687"><a href="#cb86-1687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1688"><a href="#cb86-1688" aria-hidden="true" tabindex="-1"></a>If we look at the country-level coefficients, we can see that the intercepts, GDP slopes, and year slopes all vary by different amounts across countries:</span>
<span id="cb86-1689"><a href="#cb86-1689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1690"><a href="#cb86-1690" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-gdp-country-year-year-offsets}</span></span>
<span id="cb86-1691"><a href="#cb86-1691" aria-hidden="true" tabindex="-1"></a><span class="in">coef(model_gdp_country_year)$country %&gt;%</span></span>
<span id="cb86-1692"><a href="#cb86-1692" aria-hidden="true" tabindex="-1"></a><span class="in">  as_tibble(rownames = "country") %&gt;% </span></span>
<span id="cb86-1693"><a href="#cb86-1693" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(country %in% countries$country) %&gt;% </span></span>
<span id="cb86-1694"><a href="#cb86-1694" aria-hidden="true" tabindex="-1"></a><span class="in">  select(country, starts_with("Estimate")) %&gt;% </span></span>
<span id="cb86-1695"><a href="#cb86-1695" aria-hidden="true" tabindex="-1"></a><span class="in">  # Unscale the GDP offsets</span></span>
<span id="cb86-1696"><a href="#cb86-1696" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(Estimate.gdpPercap_z = Estimate.gdpPercap_z / gdp_sd * 1000)</span></span>
<span id="cb86-1697"><a href="#cb86-1697" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1698"><a href="#cb86-1698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1699"><a href="#cb86-1699" aria-hidden="true" tabindex="-1"></a>Even better, though, is that the GDP slope changes each year too! That's what we get for including the <span class="in">`(1 + gdpPercap_log_z | year)`</span> term. The country-specific GDP slopes shift over time now:</span>
<span id="cb86-1700"><a href="#cb86-1700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1701"><a href="#cb86-1701" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-gdp-country-year-year-effects}</span></span>
<span id="cb86-1702"><a href="#cb86-1702" aria-hidden="true" tabindex="-1"></a><span class="in"># Different slopes in each year!</span></span>
<span id="cb86-1703"><a href="#cb86-1703" aria-hidden="true" tabindex="-1"></a><span class="in">model_gdp_country_year_year %&gt;% </span></span>
<span id="cb86-1704"><a href="#cb86-1704" aria-hidden="true" tabindex="-1"></a><span class="in">  emtrends(~ year + country,</span></span>
<span id="cb86-1705"><a href="#cb86-1705" aria-hidden="true" tabindex="-1"></a><span class="in">           var = "gdpPercap_log_z",</span></span>
<span id="cb86-1706"><a href="#cb86-1706" aria-hidden="true" tabindex="-1"></a><span class="in">           at = list(year = c(0, 5), country = countries$country),</span></span>
<span id="cb86-1707"><a href="#cb86-1707" aria-hidden="true" tabindex="-1"></a><span class="in">           epred = TRUE, re_formula = NULL)</span></span>
<span id="cb86-1708"><a href="#cb86-1708" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1709"><a href="#cb86-1709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1710"><a href="#cb86-1710" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Visualize results</span></span>
<span id="cb86-1711"><a href="#cb86-1711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1712"><a href="#cb86-1712" aria-hidden="true" tabindex="-1"></a>We can see this time-based change by making a slightly fancier version of our country-specific average marginal effect plot. We'll show the posterior distribution for each year within each country using ridgeplots. We'll also shade the credible intervals here using the neat <span class="in">`fill_ramp`</span> aesthetic instead of showing a point and line, since it would get too visually busy otherwise.</span>
<span id="cb86-1713"><a href="#cb86-1713" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1714"><a href="#cb86-1714" aria-hidden="true" tabindex="-1"></a>This looks so cool! In some countries like Egypt and Canada, the GDP effect is fairly constant over time. In others, like Sierra Leone, you can see the GDP effect shrink slightly in the 1980s and 1990s, and then increase again after that. </span>
<span id="cb86-1715"><a href="#cb86-1715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1716"><a href="#cb86-1716" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-ame-gdp-country-year-year, out.width="100%", fig.width=10, fig.height=7}</span></span>
<span id="cb86-1717"><a href="#cb86-1717" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-inset-right</span></span>
<span id="cb86-1718"><a href="#cb86-1718" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb86-1719"><a href="#cb86-1719" aria-hidden="true" tabindex="-1"></a><span class="in">ame_model_gdp_country_year_year &lt;- model_gdp_country_year_year %&gt;% </span></span>
<span id="cb86-1720"><a href="#cb86-1720" aria-hidden="true" tabindex="-1"></a><span class="in">  emtrends(~ year + country,</span></span>
<span id="cb86-1721"><a href="#cb86-1721" aria-hidden="true" tabindex="-1"></a><span class="in">           var = "gdpPercap_log_z",</span></span>
<span id="cb86-1722"><a href="#cb86-1722" aria-hidden="true" tabindex="-1"></a><span class="in">           at = list(year = seq(0, 55, by = 5), country = countries$country),</span></span>
<span id="cb86-1723"><a href="#cb86-1723" aria-hidden="true" tabindex="-1"></a><span class="in">           epred = TRUE, re_formula = NULL)</span></span>
<span id="cb86-1724"><a href="#cb86-1724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1725"><a href="#cb86-1725" aria-hidden="true" tabindex="-1"></a><span class="in">pred_model_gdp_country_year_year &lt;- ame_model_gdp_country_year_year %&gt;% </span></span>
<span id="cb86-1726"><a href="#cb86-1726" aria-hidden="true" tabindex="-1"></a><span class="in">  gather_emmeans_draws() %&gt;% </span></span>
<span id="cb86-1727"><a href="#cb86-1727" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(.value = (.value / gdp_log_sd) / 10) %&gt;% </span></span>
<span id="cb86-1728"><a href="#cb86-1728" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(year = year + 1952,</span></span>
<span id="cb86-1729"><a href="#cb86-1729" aria-hidden="true" tabindex="-1"></a><span class="in">         year = fct_inorder(factor(year))) %&gt;%</span></span>
<span id="cb86-1730"><a href="#cb86-1730" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(countries, by = "country")</span></span>
<span id="cb86-1731"><a href="#cb86-1731" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1732"><a href="#cb86-1732" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(pred_model_gdp_country_year_year, aes(x = .value, fill = year)) +</span></span>
<span id="cb86-1733"><a href="#cb86-1733" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_slab(aes(y = fct_rev(year), fill = year,</span></span>
<span id="cb86-1734"><a href="#cb86-1734" aria-hidden="true" tabindex="-1"></a><span class="in">                fill_ramp = after_stat(cut_cdf_qi(cdf, .width = c(0.02, 0.8, 0.95, 1)))),</span></span>
<span id="cb86-1735"><a href="#cb86-1735" aria-hidden="true" tabindex="-1"></a><span class="in">            height = 2, color = "white", slab_size = 0.5) +</span></span>
<span id="cb86-1736"><a href="#cb86-1736" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_viridis_d(option = "rocket", guide = "none", end = 0.9) +</span></span>
<span id="cb86-1737"><a href="#cb86-1737" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_ramp_discrete(range = c(1, 0.2), guide = "none") +</span></span>
<span id="cb86-1738"><a href="#cb86-1738" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0) +</span></span>
<span id="cb86-1739"><a href="#cb86-1739" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(title = paste0("Average marginal effect of GDP per capita", "\n",</span></span>
<span id="cb86-1740"><a href="#cb86-1740" aria-hidden="true" tabindex="-1"></a><span class="in">                      "(intercepts and slopes of both GDP per capita and year ",</span></span>
<span id="cb86-1741"><a href="#cb86-1741" aria-hidden="true" tabindex="-1"></a><span class="in">                      "vary by country + intercepts vary by year)"), </span></span>
<span id="cb86-1742"><a href="#cb86-1742" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = paste0("lifeExp ~ gdpPercap_log_z + year + ", </span></span>
<span id="cb86-1743"><a href="#cb86-1743" aria-hidden="true" tabindex="-1"></a><span class="in">                         "(1 + gdpPercap_log_z | year) + ", </span></span>
<span id="cb86-1744"><a href="#cb86-1744" aria-hidden="true" tabindex="-1"></a><span class="in">                         "(1 + gdpPercap_log_z + year | country)"),</span></span>
<span id="cb86-1745"><a href="#cb86-1745" aria-hidden="true" tabindex="-1"></a><span class="in">       x = paste0("Average marginal effect on life expectancy", "\n", </span></span>
<span id="cb86-1746"><a href="#cb86-1746" aria-hidden="true" tabindex="-1"></a><span class="in">                  "of a 10% increase in GDP per capita"), </span></span>
<span id="cb86-1747"><a href="#cb86-1747" aria-hidden="true" tabindex="-1"></a><span class="in">       y = "Year",</span></span>
<span id="cb86-1748"><a href="#cb86-1748" aria-hidden="true" tabindex="-1"></a><span class="in">       caption = "80% and 95% credible intervals shown with shading") +</span></span>
<span id="cb86-1749"><a href="#cb86-1749" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_nested_wrap(vars(continent, country), nrow = 2, strip = nested_settings,</span></span>
<span id="cb86-1750"><a href="#cb86-1750" aria-hidden="true" tabindex="-1"></a><span class="in">                    scales = "free_x") +</span></span>
<span id="cb86-1751"><a href="#cb86-1751" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_clean() +</span></span>
<span id="cb86-1752"><a href="#cb86-1752" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(panel.grid.major.y = element_blank(),</span></span>
<span id="cb86-1753"><a href="#cb86-1753" aria-hidden="true" tabindex="-1"></a><span class="in">        plot.subtitle = element_text(family = "Consolas"))</span></span>
<span id="cb86-1754"><a href="#cb86-1754" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1755"><a href="#cb86-1755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1756"><a href="#cb86-1756" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Visualize more generic average marginal effects</span></span>
<span id="cb86-1757"><a href="#cb86-1757" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1758"><a href="#cb86-1758" aria-hidden="true" tabindex="-1"></a>Finally we can calculate some aggregate average marginal effects to talk about the general effect of wealth on health. We'll (1) find the global grand mean, (2) calculate the average effect in our fake Atlantis country in a fake 2020 year, and (2) calculate the average effect in Atlantis over time.</span>
<span id="cb86-1759"><a href="#cb86-1759" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1760"><a href="#cb86-1760" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-global-hypothetical-year-year, out.width="100%", fig.width=9, fig.height=6}</span></span>
<span id="cb86-1761"><a href="#cb86-1761" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-inset-right</span></span>
<span id="cb86-1762"><a href="#cb86-1762" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb86-1763"><a href="#cb86-1763" aria-hidden="true" tabindex="-1"></a><span class="in"># Calculate the overall global effect</span></span>
<span id="cb86-1764"><a href="#cb86-1764" aria-hidden="true" tabindex="-1"></a><span class="in"># `re_formula = NA` means that no random effects will be incorporated</span></span>
<span id="cb86-1765"><a href="#cb86-1765" aria-hidden="true" tabindex="-1"></a><span class="in">ame_global_gdp_country_year_year &lt;- model_gdp_country_year_year %&gt;% </span></span>
<span id="cb86-1766"><a href="#cb86-1766" aria-hidden="true" tabindex="-1"></a><span class="in">  emtrends(~ 1,</span></span>
<span id="cb86-1767"><a href="#cb86-1767" aria-hidden="true" tabindex="-1"></a><span class="in">           var = "gdpPercap_log_z",</span></span>
<span id="cb86-1768"><a href="#cb86-1768" aria-hidden="true" tabindex="-1"></a><span class="in">           epred = TRUE, re_formula = NA)</span></span>
<span id="cb86-1769"><a href="#cb86-1769" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1770"><a href="#cb86-1770" aria-hidden="true" tabindex="-1"></a><span class="in"># Get the posterior distribution of this global effect and make a plot</span></span>
<span id="cb86-1771"><a href="#cb86-1771" aria-hidden="true" tabindex="-1"></a><span class="in">pred_global_gdp_country_year_year &lt;- ame_global_gdp_country_year_year %&gt;% </span></span>
<span id="cb86-1772"><a href="#cb86-1772" aria-hidden="true" tabindex="-1"></a><span class="in">  gather_emmeans_draws() %&gt;% </span></span>
<span id="cb86-1773"><a href="#cb86-1773" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(.value = (.value / gdp_log_sd) / 10) %&gt;% </span></span>
<span id="cb86-1774"><a href="#cb86-1774" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(fake_facet_title = "Global grand mean")</span></span>
<span id="cb86-1775"><a href="#cb86-1775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1776"><a href="#cb86-1776" aria-hidden="true" tabindex="-1"></a><span class="in">plot_global_gdp_country_year_year &lt;- ggplot(pred_global_gdp_country_year_year, aes(x = .value)) +</span></span>
<span id="cb86-1777"><a href="#cb86-1777" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_slab(aes(fill_ramp = after_stat(cut_cdf_qi(cdf, .width = c(0.02, 0.8, 0.95, 1)))),</span></span>
<span id="cb86-1778"><a href="#cb86-1778" aria-hidden="true" tabindex="-1"></a><span class="in">            fill = palette_okabe_ito(5)) +</span></span>
<span id="cb86-1779"><a href="#cb86-1779" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_viridis_d(option = "plasma", guide = "none", begin = 0.5) +</span></span>
<span id="cb86-1780"><a href="#cb86-1780" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_ramp_discrete(range = c(1, 0.2), guide = "none") +</span></span>
<span id="cb86-1781"><a href="#cb86-1781" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0) +</span></span>
<span id="cb86-1782"><a href="#cb86-1782" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = paste0("Average marginal effect on life expectancy", "\n", </span></span>
<span id="cb86-1783"><a href="#cb86-1783" aria-hidden="true" tabindex="-1"></a><span class="in">                  "of a 10% increase in GDP per capita"), </span></span>
<span id="cb86-1784"><a href="#cb86-1784" aria-hidden="true" tabindex="-1"></a><span class="in">       y = "Density") +</span></span>
<span id="cb86-1785"><a href="#cb86-1785" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(vars(fake_facet_title)) +</span></span>
<span id="cb86-1786"><a href="#cb86-1786" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_clean() +</span></span>
<span id="cb86-1787"><a href="#cb86-1787" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(panel.grid.major.y = element_blank(),</span></span>
<span id="cb86-1788"><a href="#cb86-1788" aria-hidden="true" tabindex="-1"></a><span class="in">        strip.text = element_text(size = rel(1.1)))</span></span>
<span id="cb86-1789"><a href="#cb86-1789" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1790"><a href="#cb86-1790" aria-hidden="true" tabindex="-1"></a><span class="in"># Calculate the effect for Atlantis in 2020</span></span>
<span id="cb86-1791"><a href="#cb86-1791" aria-hidden="true" tabindex="-1"></a><span class="in"># `re_formula = NULL` means the full random effects structure will be</span></span>
<span id="cb86-1792"><a href="#cb86-1792" aria-hidden="true" tabindex="-1"></a><span class="in"># incorporated. `allow_new_levels` lets R deal with a new country, and</span></span>
<span id="cb86-1793"><a href="#cb86-1793" aria-hidden="true" tabindex="-1"></a><span class="in"># `sample_new_levels = "gaussian"` means that the characteristics for this new</span></span>
<span id="cb86-1794"><a href="#cb86-1794" aria-hidden="true" tabindex="-1"></a><span class="in"># country will be based on random draws from the model</span></span>
<span id="cb86-1795"><a href="#cb86-1795" aria-hidden="true" tabindex="-1"></a><span class="in">ame_hypo1_gdp_country_year_year &lt;- model_gdp_country_year_year %&gt;% </span></span>
<span id="cb86-1796"><a href="#cb86-1796" aria-hidden="true" tabindex="-1"></a><span class="in">  emtrends(~ country + year,</span></span>
<span id="cb86-1797"><a href="#cb86-1797" aria-hidden="true" tabindex="-1"></a><span class="in">           var = "gdpPercap_log_z",</span></span>
<span id="cb86-1798"><a href="#cb86-1798" aria-hidden="true" tabindex="-1"></a><span class="in">           at = list(year = (2020 - 1952), country = "Atlantis"),</span></span>
<span id="cb86-1799"><a href="#cb86-1799" aria-hidden="true" tabindex="-1"></a><span class="in">           epred = TRUE, re_formula = NULL, </span></span>
<span id="cb86-1800"><a href="#cb86-1800" aria-hidden="true" tabindex="-1"></a><span class="in">           allow_new_levels = TRUE, sample_new_levels = "gaussian")</span></span>
<span id="cb86-1801"><a href="#cb86-1801" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1802"><a href="#cb86-1802" aria-hidden="true" tabindex="-1"></a><span class="in"># Atlantis median 2020 effect</span></span>
<span id="cb86-1803"><a href="#cb86-1803" aria-hidden="true" tabindex="-1"></a><span class="in">ame_hypo1_gdp_country_year_year %&gt;% </span></span>
<span id="cb86-1804"><a href="#cb86-1804" aria-hidden="true" tabindex="-1"></a><span class="in">  gather_emmeans_draws() %&gt;% </span></span>
<span id="cb86-1805"><a href="#cb86-1805" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(.value = (.value / gdp_log_sd) / 10) %&gt;% </span></span>
<span id="cb86-1806"><a href="#cb86-1806" aria-hidden="true" tabindex="-1"></a><span class="in">  median_hdci()</span></span>
<span id="cb86-1807"><a href="#cb86-1807" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1808"><a href="#cb86-1808" aria-hidden="true" tabindex="-1"></a><span class="in"># Get the posterior distribution of this Atlantis effect and make a plot</span></span>
<span id="cb86-1809"><a href="#cb86-1809" aria-hidden="true" tabindex="-1"></a><span class="in">pred_hypo1_gdp_country_year_year &lt;- ame_hypo1_gdp_country_year_year %&gt;% </span></span>
<span id="cb86-1810"><a href="#cb86-1810" aria-hidden="true" tabindex="-1"></a><span class="in">  gather_emmeans_draws() %&gt;% </span></span>
<span id="cb86-1811"><a href="#cb86-1811" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(.value = (.value / gdp_log_sd) / 10) %&gt;% </span></span>
<span id="cb86-1812"><a href="#cb86-1812" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(fake_facet_title = "AME for hypothetical Atlantis in 2020")</span></span>
<span id="cb86-1813"><a href="#cb86-1813" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1814"><a href="#cb86-1814" aria-hidden="true" tabindex="-1"></a><span class="in">plot_hypo1_gdp_country_year_year &lt;- ggplot(pred_hypo1_gdp_country_year_year, aes(x = .value)) +</span></span>
<span id="cb86-1815"><a href="#cb86-1815" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_slab(aes(fill_ramp = after_stat(cut_cdf_qi(cdf, .width = c(0.02, 0.8, 0.95, 1)))),</span></span>
<span id="cb86-1816"><a href="#cb86-1816" aria-hidden="true" tabindex="-1"></a><span class="in">            fill = palette_okabe_ito(7)) +</span></span>
<span id="cb86-1817"><a href="#cb86-1817" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_ramp_discrete(range = c(1, 0.2), guide = "none") +</span></span>
<span id="cb86-1818"><a href="#cb86-1818" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0) +</span></span>
<span id="cb86-1819"><a href="#cb86-1819" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = paste0("Average marginal effect on life expectancy", "\n", </span></span>
<span id="cb86-1820"><a href="#cb86-1820" aria-hidden="true" tabindex="-1"></a><span class="in">                  "of a 10% increase in GDP per capita"), </span></span>
<span id="cb86-1821"><a href="#cb86-1821" aria-hidden="true" tabindex="-1"></a><span class="in">       y = "Density") +</span></span>
<span id="cb86-1822"><a href="#cb86-1822" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(vars(fake_facet_title)) +</span></span>
<span id="cb86-1823"><a href="#cb86-1823" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_clean() +</span></span>
<span id="cb86-1824"><a href="#cb86-1824" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(panel.grid.major.y = element_blank(),</span></span>
<span id="cb86-1825"><a href="#cb86-1825" aria-hidden="true" tabindex="-1"></a><span class="in">        strip.text = element_text(size = rel(1.1)))</span></span>
<span id="cb86-1826"><a href="#cb86-1826" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1827"><a href="#cb86-1827" aria-hidden="true" tabindex="-1"></a><span class="in"># Calculate the effect for Atlantis across all existing years</span></span>
<span id="cb86-1828"><a href="#cb86-1828" aria-hidden="true" tabindex="-1"></a><span class="in">ame_hypo_gdp_country_year_year &lt;- model_gdp_country_year_year %&gt;% </span></span>
<span id="cb86-1829"><a href="#cb86-1829" aria-hidden="true" tabindex="-1"></a><span class="in">  emtrends(~ country + year,</span></span>
<span id="cb86-1830"><a href="#cb86-1830" aria-hidden="true" tabindex="-1"></a><span class="in">           var = "gdpPercap_log_z",</span></span>
<span id="cb86-1831"><a href="#cb86-1831" aria-hidden="true" tabindex="-1"></a><span class="in">           at = list(year = seq(0, 55, by = 5), country = "Atlantis"),</span></span>
<span id="cb86-1832"><a href="#cb86-1832" aria-hidden="true" tabindex="-1"></a><span class="in">           epred = TRUE, re_formula = NULL, </span></span>
<span id="cb86-1833"><a href="#cb86-1833" aria-hidden="true" tabindex="-1"></a><span class="in">           allow_new_levels = TRUE, sample_new_levels = "gaussian")</span></span>
<span id="cb86-1834"><a href="#cb86-1834" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1835"><a href="#cb86-1835" aria-hidden="true" tabindex="-1"></a><span class="in"># Get the posterior distribution of this Atlantis effect and make a plot</span></span>
<span id="cb86-1836"><a href="#cb86-1836" aria-hidden="true" tabindex="-1"></a><span class="in">pred_hypo_gdp_country_year_year &lt;- ame_hypo_gdp_country_year_year %&gt;% </span></span>
<span id="cb86-1837"><a href="#cb86-1837" aria-hidden="true" tabindex="-1"></a><span class="in">  gather_emmeans_draws() %&gt;% </span></span>
<span id="cb86-1838"><a href="#cb86-1838" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(.value = (.value / gdp_log_sd) / 10) %&gt;% </span></span>
<span id="cb86-1839"><a href="#cb86-1839" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(year = year + 1952,</span></span>
<span id="cb86-1840"><a href="#cb86-1840" aria-hidden="true" tabindex="-1"></a><span class="in">         year = fct_inorder(factor(year))) %&gt;%</span></span>
<span id="cb86-1841"><a href="#cb86-1841" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(fake_facet_title = "AME for hypothetical Atlantis across time")</span></span>
<span id="cb86-1842"><a href="#cb86-1842" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1843"><a href="#cb86-1843" aria-hidden="true" tabindex="-1"></a><span class="in">plot_hypo_gdp_country_year_year &lt;- ggplot(pred_hypo_gdp_country_year_year, aes(x = .value)) +</span></span>
<span id="cb86-1844"><a href="#cb86-1844" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_slab(aes(y = fct_rev(year), fill = year,</span></span>
<span id="cb86-1845"><a href="#cb86-1845" aria-hidden="true" tabindex="-1"></a><span class="in">                fill_ramp = after_stat(cut_cdf_qi(cdf, .width = c(0.02, 0.8, 0.95, 1)))),</span></span>
<span id="cb86-1846"><a href="#cb86-1846" aria-hidden="true" tabindex="-1"></a><span class="in">            height = 2, color = "white") +</span></span>
<span id="cb86-1847"><a href="#cb86-1847" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_viridis_d(option = "rocket", guide = "none", end = 0.9) +</span></span>
<span id="cb86-1848"><a href="#cb86-1848" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_ramp_discrete(range = c(1, 0.2), guide = "none") +</span></span>
<span id="cb86-1849"><a href="#cb86-1849" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0) +</span></span>
<span id="cb86-1850"><a href="#cb86-1850" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = paste0("Average marginal effect on life expectancy", "\n", </span></span>
<span id="cb86-1851"><a href="#cb86-1851" aria-hidden="true" tabindex="-1"></a><span class="in">                  "of a 10% increase in GDP per capita"), </span></span>
<span id="cb86-1852"><a href="#cb86-1852" aria-hidden="true" tabindex="-1"></a><span class="in">       y = "Year") +</span></span>
<span id="cb86-1853"><a href="#cb86-1853" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(vars(fake_facet_title)) +</span></span>
<span id="cb86-1854"><a href="#cb86-1854" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_clean() +</span></span>
<span id="cb86-1855"><a href="#cb86-1855" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(panel.grid.major.y = element_blank(),</span></span>
<span id="cb86-1856"><a href="#cb86-1856" aria-hidden="true" tabindex="-1"></a><span class="in">        strip.text = element_text(size = rel(1.1)))</span></span>
<span id="cb86-1857"><a href="#cb86-1857" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1858"><a href="#cb86-1858" aria-hidden="true" tabindex="-1"></a><span class="in"># Show all the AME distributions in a mega plot</span></span>
<span id="cb86-1859"><a href="#cb86-1859" aria-hidden="true" tabindex="-1"></a><span class="in">((plot_global_gdp_country_year_year / plot_hypo1_gdp_country_year_year) | </span></span>
<span id="cb86-1860"><a href="#cb86-1860" aria-hidden="true" tabindex="-1"></a><span class="in">    plot_hypo_gdp_country_year_year) +</span></span>
<span id="cb86-1861"><a href="#cb86-1861" aria-hidden="true" tabindex="-1"></a><span class="in">  plot_annotation(title = paste0("Average marginal effect of GDP per capita", "\n",</span></span>
<span id="cb86-1862"><a href="#cb86-1862" aria-hidden="true" tabindex="-1"></a><span class="in">                                 "(intercepts and slopes of both GDP per capita and year ",</span></span>
<span id="cb86-1863"><a href="#cb86-1863" aria-hidden="true" tabindex="-1"></a><span class="in">                                 "vary by country + intercepts and GDP slopes vary by year)"), </span></span>
<span id="cb86-1864"><a href="#cb86-1864" aria-hidden="true" tabindex="-1"></a><span class="in">                  subtitle = paste0("lifeExp ~ gdpPercap_log_z + year + ", </span></span>
<span id="cb86-1865"><a href="#cb86-1865" aria-hidden="true" tabindex="-1"></a><span class="in">                         "(1 + gdpPercap_log_z | year) + ", </span></span>
<span id="cb86-1866"><a href="#cb86-1866" aria-hidden="true" tabindex="-1"></a><span class="in">                         "(1 + gdpPercap_log_z + year | country)"),</span></span>
<span id="cb86-1867"><a href="#cb86-1867" aria-hidden="true" tabindex="-1"></a><span class="in">                  caption = "80% and 95% credible intervals shown with shading",</span></span>
<span id="cb86-1868"><a href="#cb86-1868" aria-hidden="true" tabindex="-1"></a><span class="in">                  theme = theme_clean() + theme(plot.subtitle = element_text(family = "Consolas")))</span></span>
<span id="cb86-1869"><a href="#cb86-1869" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1870"><a href="#cb86-1870" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1871"><a href="#cb86-1871" aria-hidden="true" tabindex="-1"></a><span class="fu">### Each continent and nested country gets its own intercept and GDP and year slopes</span></span>
<span id="cb86-1872"><a href="#cb86-1872" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1873"><a href="#cb86-1873" aria-hidden="true" tabindex="-1"></a>Finally, for super bonus fun and games, we could incorporate an extra continent-level hierarchy into the model, since countries are nested in continents and regions might see specific trends in the GDP/life expectancy relationship. I'm not actually going to run this model here—it takes a while even on a fast computer, and you have to specify informative priors and let it run for more iterations, etc. If we did run this, we'd get 7 different $\tau$ parameters and 6 different correlation parameters and we could do all sorts of fun stuff with the posterior. But we won't run this for now—you can though!</span>
<span id="cb86-1874"><a href="#cb86-1874" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1875"><a href="#cb86-1875" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-gdp-continent-country-year, eval=FALSE}</span></span>
<span id="cb86-1876"><a href="#cb86-1876" aria-hidden="true" tabindex="-1"></a><span class="in">model_gdp_continent_country_year &lt;- brm(</span></span>
<span id="cb86-1877"><a href="#cb86-1877" aria-hidden="true" tabindex="-1"></a><span class="in">  bf(lifeExp ~ gdpPercap_log_z + year + </span></span>
<span id="cb86-1878"><a href="#cb86-1878" aria-hidden="true" tabindex="-1"></a><span class="in">       (1 + gdpPercap_log_z + year | continent / country),</span></span>
<span id="cb86-1879"><a href="#cb86-1879" aria-hidden="true" tabindex="-1"></a><span class="in">     decomp = "QR"),</span></span>
<span id="cb86-1880"><a href="#cb86-1880" aria-hidden="true" tabindex="-1"></a><span class="in">  data = gapminder,</span></span>
<span id="cb86-1881"><a href="#cb86-1881" aria-hidden="true" tabindex="-1"></a><span class="in">  cores = 4, chains = 4, seed = bayes_seed,</span></span>
<span id="cb86-1882"><a href="#cb86-1882" aria-hidden="true" tabindex="-1"></a><span class="in">  threads = threading(2)  # Two CPUs per chain to speed things up</span></span>
<span id="cb86-1883"><a href="#cb86-1883" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb86-1884"><a href="#cb86-1884" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1885"><a href="#cb86-1885" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1886"><a href="#cb86-1886" aria-hidden="true" tabindex="-1"></a><span class="in">```{r emtrends-model-gdp-continent-country-year, eval=FALSE}</span></span>
<span id="cb86-1887"><a href="#cb86-1887" aria-hidden="true" tabindex="-1"></a><span class="in"># You'd use this to calculate the continent/country specific effects</span></span>
<span id="cb86-1888"><a href="#cb86-1888" aria-hidden="true" tabindex="-1"></a><span class="in">model_gdp_continent_country_year %&gt;%</span></span>
<span id="cb86-1889"><a href="#cb86-1889" aria-hidden="true" tabindex="-1"></a><span class="in">  emtrends(~ year + continent:country,</span></span>
<span id="cb86-1890"><a href="#cb86-1890" aria-hidden="true" tabindex="-1"></a><span class="in">           var = "gdpPercap_log_z",</span></span>
<span id="cb86-1891"><a href="#cb86-1891" aria-hidden="true" tabindex="-1"></a><span class="in">           at = list(year = c(0), country = countries$country),</span></span>
<span id="cb86-1892"><a href="#cb86-1892" aria-hidden="true" tabindex="-1"></a><span class="in">           nesting = "country %in% continent",</span></span>
<span id="cb86-1893"><a href="#cb86-1893" aria-hidden="true" tabindex="-1"></a><span class="in">           epred = TRUE, re_formula = NULL, allow_new_levels = TRUE)</span></span>
<span id="cb86-1894"><a href="#cb86-1894" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1895"><a href="#cb86-1895" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1896"><a href="#cb86-1896" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1897"><a href="#cb86-1897" aria-hidden="true" tabindex="-1"></a><span class="fu">## Other ways of dealing with time</span></span>
<span id="cb86-1898"><a href="#cb86-1898" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1899"><a href="#cb86-1899" aria-hidden="true" tabindex="-1"></a>Throughout this guide, we've treated the time effect as linear, and that's probably okay for this toy Gapminder example. In reality, though you can model time in all sorts of fancier ways, and there are whole textbooks and courses about how to do that (like <span class="co">[</span><span class="ot">Solomon Kurz's excellent **brms** and **tidyverse** translation</span><span class="co">](https://bookdown.org/content/4253/)</span> of <span class="co">[</span><span class="ot">Singer and Willett's *Applied Longitudinal Data Analysis*</span><span class="co">](https://www.oxfordscholarship.com/view/10.1093/acprof:oso/9780195152968.001.0001/acprof-9780195152968)</span> <span class="co">[</span><span class="ot">here</span><span class="co">](https://bookdown.org/content/4253/)</span>). For example, <span class="co">[</span><span class="ot">Solomon Kurz here</span><span class="co">](https://twitter.com/solomonkurz/status/1465781498058092544)</span> uses R's built-in <span class="in">`ChickWeight`</span> dataset to model the effect of different diets across time on chick weights:</span>
<span id="cb86-1900"><a href="#cb86-1900" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1901"><a href="#cb86-1901" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solomon-tweet, echo=FALSE, out.width="75%"}</span></span>
<span id="cb86-1902"><a href="#cb86-1902" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::include_graphics("solomon-screenshot.png")</span></span>
<span id="cb86-1903"><a href="#cb86-1903" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1904"><a href="#cb86-1904" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1905"><a href="#cb86-1905" aria-hidden="true" tabindex="-1"></a>The model he uses looks like this—he uses time, time², the interaction of time and diet, the interaction of time² and diet, and adds chick-specific offsets to both time and time²! That lets the model pick up all sorts of linear and quadratic trends in time and their interactions with different diets, all across individual chicks in the dataset. That's super neat.</span>
<span id="cb86-1906"><a href="#cb86-1906" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1907"><a href="#cb86-1907" aria-hidden="true" tabindex="-1"></a><span class="in">```{r chickweight-example, eval=FALSE}</span></span>
<span id="cb86-1908"><a href="#cb86-1908" aria-hidden="true" tabindex="-1"></a><span class="in">fit &lt;- lme4::lmer(</span></span>
<span id="cb86-1909"><a href="#cb86-1909" aria-hidden="true" tabindex="-1"></a><span class="in">  weight ~ 1 + Time + I(Time^2) + Diet + Time:Diet + I(Time^2:Diet) + </span></span>
<span id="cb86-1910"><a href="#cb86-1910" aria-hidden="true" tabindex="-1"></a><span class="in">    (1 + Time + I(Time^2) | Chick),</span></span>
<span id="cb86-1911"><a href="#cb86-1911" aria-hidden="true" tabindex="-1"></a><span class="in">  data = ChickWeight</span></span>
<span id="cb86-1912"><a href="#cb86-1912" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb86-1913"><a href="#cb86-1913" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1914"><a href="#cb86-1914" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1915"><a href="#cb86-1915" aria-hidden="true" tabindex="-1"></a>You could also add splines, higher-order polynomials (time⁴!), and other complexity to model time, but that goes way beyond the scope of this guide. Refer to <span class="co">[</span><span class="ot">Solomon's guide</span><span class="co">](https://bookdown.org/content/4253/)</span> for more about all that.</span>
<span id="cb86-1916"><a href="#cb86-1916" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1917"><a href="#cb86-1917" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1918"><a href="#cb86-1918" aria-hidden="true" tabindex="-1"></a><span class="fu">## tl;dr holy crap this was so long</span></span>
<span id="cb86-1919"><a href="#cb86-1919" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1920"><a href="#cb86-1920" aria-hidden="true" tabindex="-1"></a>This guide was long and detailed, but again, the audience for this post is future-me. You're all just along for the ride :)</span>
<span id="cb86-1921"><a href="#cb86-1921" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1922"><a href="#cb86-1922" aria-hidden="true" tabindex="-1"></a>Multilevel models let us deal with both time and country-level differences in panel data, and the ways we structure the random effects terms determine what we're actually estimating.</span>
<span id="cb86-1923"><a href="#cb86-1923" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1924"><a href="#cb86-1924" aria-hidden="true" tabindex="-1"></a>Here's a super quick review of the different models we ran and what they do:</span>
<span id="cb86-1925"><a href="#cb86-1925" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1926"><a href="#cb86-1926" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Country-specific intercepts + global time trend:</span>
<span id="cb86-1927"><a href="#cb86-1927" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1928"><a href="#cb86-1928" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval=FALSE, indent="  "}</span></span>
<span id="cb86-1929"><a href="#cb86-1929" aria-hidden="true" tabindex="-1"></a><span class="in">bf(outcome ~ x + year + (1 | country))</span></span>
<span id="cb86-1930"><a href="#cb86-1930" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1931"><a href="#cb86-1931" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1932"><a href="#cb86-1932" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Country-specific intercepts *and* country-specific slopes for year + global time trend:</span>
<span id="cb86-1933"><a href="#cb86-1933" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1934"><a href="#cb86-1934" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval=FALSE, indent="  "}</span></span>
<span id="cb86-1935"><a href="#cb86-1935" aria-hidden="true" tabindex="-1"></a><span class="in">bf(outcome ~ x + year + (1 + year | country))</span></span>
<span id="cb86-1936"><a href="#cb86-1936" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1937"><a href="#cb86-1937" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1938"><a href="#cb86-1938" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Country-specific intercepts *and* country-specific slopes for year and `x` + global time trend (*this seems to be the most common and sensible approach*):</span>
<span id="cb86-1939"><a href="#cb86-1939" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1940"><a href="#cb86-1940" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval=FALSE, indent="  "}</span></span>
<span id="cb86-1941"><a href="#cb86-1941" aria-hidden="true" tabindex="-1"></a><span class="in">bf(outcome ~ x + year + (1 + x + year | country))</span></span>
<span id="cb86-1942"><a href="#cb86-1942" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1943"><a href="#cb86-1943" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1944"><a href="#cb86-1944" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Country-specific intercepts *and* country-specific slopes for year and `x` *and* year-specific intercepts + global time trend:</span>
<span id="cb86-1945"><a href="#cb86-1945" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1946"><a href="#cb86-1946" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval=FALSE, indent="  "}</span></span>
<span id="cb86-1947"><a href="#cb86-1947" aria-hidden="true" tabindex="-1"></a><span class="in">bf(outcome ~ x + year + (1 | year) + (1 + x + year | country))</span></span>
<span id="cb86-1948"><a href="#cb86-1948" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1949"><a href="#cb86-1949" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1950"><a href="#cb86-1950" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Country-inside-continent-specific intercepts *and* country-inside-continent specific slopes for year and <span class="in">`x`</span> + global time trend</span>
<span id="cb86-1951"><a href="#cb86-1951" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1952"><a href="#cb86-1952" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval=FALSE, indent="  "}</span></span>
<span id="cb86-1953"><a href="#cb86-1953" aria-hidden="true" tabindex="-1"></a><span class="in">bf(outcome ~ x + year + (1 + x + year | continent / country))</span></span>
<span id="cb86-1954"><a href="#cb86-1954" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1955"><a href="#cb86-1955" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1956"><a href="#cb86-1956" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Super wild party time: Country-inside-continent-specific intercepts *and* country-inside-continent specific slopes for year and `x` *and* year-specific intercepts and slopes for <span class="in">`x`</span> + global time trend</span>
<span id="cb86-1957"><a href="#cb86-1957" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1958"><a href="#cb86-1958" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval=FALSE, indent="  "}</span></span>
<span id="cb86-1959"><a href="#cb86-1959" aria-hidden="true" tabindex="-1"></a><span class="in">bf(outcome ~ x + year + (1 + x | year) + (1 + x + year | continent / country))</span></span>
<span id="cb86-1960"><a href="#cb86-1960" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p><span class="faux-block">Forked from <a href="https://www.andrewheiss.com/">Andrew Heiss</a></span> # <span class="faux-block"><a href="https://github.com/andrewheiss/ath-quarto">View the source at <i class="fa-brands fa-github" aria-label="github"></i> GitHub</a></span></p>
</div>
  </div>
</footer>


</body></html>