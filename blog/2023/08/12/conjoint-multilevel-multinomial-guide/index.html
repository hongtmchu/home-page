<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Andrew Heiss">
<meta name="description" content="Learn how to use R, {brms}, {marginaleffects}, and {tidybayes} to analyze discrete choice conjoint data with fully specified hierarchical multilevel multinomial models">
<title>The ultimate practical guide to multilevel multinomial conjoint analysis with R | Andrew Heiss – Andrew Heiss</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="../../../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../../../">
<link href="../../../../..//files/favicon-512.png" rel="icon" type="image/png">
<script src="../../../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../../../site_libs/quarto-html/quarto-syntax-highlighting-17c909d5fd25ae21b861c0c7a49b2096.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../../../site_libs/bootstrap/bootstrap-5cd0811f461c8271ae6bab49df9501be.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<link href="../../../../../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../../../../../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<script src="../../../../../site_libs/quarto-contrib/iconify-2.0.0/iconify-icon.min.js"></script><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script type="text/javascript">

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-527449-5', 'auto');

ga('send', {
  hitType: 'pageview',
  'anonymizeIp': true,
});
</script><style>

      .quarto-title-block .quarto-title-banner {
        background: #170C3A;
      }
</style>
<script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
<meta property="og:title" content="The ultimate practical guide to multilevel multinomial conjoint analysis with R | Andrew Heiss">
<meta property="og:description" content="Learn how to use R, {brms}, {marginaleffects}, and {tidybayes} to analyze discrete choice conjoint data with fully specified hierarchical multilevel multinomial models">
<meta property="og:image" content="https://www.andrewheiss.com/blog/2023/08/12/conjoint-multilevel-multinomial-guide/index_files/figure-html/plot-amces-minivans-carpool-1.png">
<meta property="og:site_name" content="Andrew Heiss">
<meta property="og:locale" content="en_US">
<meta property="og:image:height" content="1440">
<meta property="og:image:width" content="1728">
<meta name="twitter:title" content="The ultimate practical guide to multilevel multinomial conjoint analysis with R | Andrew Heiss">
<meta name="twitter:description" content="Learn how to use R, {brms}, {marginaleffects}, and {tidybayes} to analyze discrete choice conjoint data with fully specified hierarchical multilevel multinomial models">
<meta name="twitter:image" content="https://www.andrewheiss.com/blog/2023/08/12/conjoint-multilevel-multinomial-guide/index_files/figure-html/plot-amces-minivans-carpool-1.png">
<meta name="twitter:creator" content="@andrewheiss">
<meta name="twitter:site" content="@andrewheiss">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image-height" content="1440">
<meta name="twitter:image-width" content="1728">
</head>
<body class="floating nav-fixed slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../../../index.html">
    <span class="navbar-title">Andrew Heiss</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link" href="../../../../../index.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../cv/index.html"> 
<span class="menu-text">CV</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../blog/index.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../research/index.html"> 
<span class="menu-text">Research</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../teaching/index.html"> 
<span class="menu-text">Teaching</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../talks/index.html"> 
<span class="menu-text">Talks</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../now/index.html"> 
<span class="menu-text">Now</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../uses/index.html"> 
<span class="menu-text">Uses</span></a>
  </li>  
</ul>
<ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item">
    <a class="nav-link" href="../../../../../atom.xml"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:rss" style="font-size: 1.1em;" aria-label="Icon rss from bi Iconify.design set." title="RSS"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="mailto:aheiss@gsu.edu"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:envelope" style="font-size: 1.1em;" aria-label="Icon envelope from bi Iconify.design set." title="E-mail"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://bsky.app/profile/andrew.heiss.phd" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="fa6-brands:bluesky" style="font-size: 1.1em;" aria-label="Icon bluesky from fa6-brands Iconify.design set." title="Bluesky"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://fediscience.org/users/andrew/" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:mastodon" style="font-size: 1.1em;" aria-label="Icon mastodon from bi Iconify.design set." title="Mastodon"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/andrewheiss" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:github" style="font-size: 1.1em;" aria-label="Icon github from bi Iconify.design set." title="GitHub"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.youtube.com/andrewheiss" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:youtube" style="font-size: 1.1em;" aria-label="Icon youtube from bi Iconify.design set." title="YouTube"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.heissatopia.com/"> 
<span class="menu-text"><iconify-icon inline="" icon="fa6-brands:blogger" style="font-size: 1.15em;" aria-label="Icon blogger from fa6-brands Iconify.design set." title="Blogger"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.linkedin.com/in/andrewheiss" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:linkedin" style="font-size: 1.1em;" aria-label="Icon linkedin from bi Iconify.design set." title="LinkedIn"></iconify-icon></span></a>
  </li>  
</ul>
</div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><header id="title-block-header" class="quarto-title-block default blog-post page-columns page-full"><div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">The ultimate practical guide to multilevel multinomial conjoint analysis with R</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
                  <div>
        <div class="description">
          Learn how to use R, {brms}, {marginaleffects}, and {tidybayes} to analyze discrete choice conjoint data with fully specified hierarchical multilevel multinomial models
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">r</div>
                <div class="quarto-category">tidyverse</div>
                <div class="quarto-category">ggplot</div>
                <div class="quarto-category">statistics</div>
                <div class="quarto-category">brms</div>
                <div class="quarto-category">stan</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p><a href="https://www.andrewheiss.com/">Andrew Heiss</a> <a href="https://orcid.org/0000-0002-3948-3914" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">Saturday, August 12, 2023</p>
      </div>
    </div>
    
      <div>
      <div class="quarto-title-meta-heading">Modified</div>
      <div class="quarto-title-meta-contents">
        <p class="date-modified">Tuesday, September 24, 2024</p>
      </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Doi</div>
      <div class="quarto-title-meta-contents">
        <p class="doi">
          <a href="https://doi.org/10.59350/2mz75-rrc46">10.59350/2mz75-rrc46</a>
        </p>
      </div>
    </div>
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Contents</h2>
   
  <ul>
<li>
<a href="#part-1-candy-single-question-basic-multinomial-logit" id="toc-part-1-candy-single-question-basic-multinomial-logit" class="nav-link active" data-scroll-target="#part-1-candy-single-question-basic-multinomial-logit">Part 1: Candy; single question; basic multinomial logit</a>
  <ul>
<li><a href="#the-setup" id="toc-the-setup" class="nav-link" data-scroll-target="#the-setup">The setup</a></li>
  <li><a href="#the-data" id="toc-the-data" class="nav-link" data-scroll-target="#the-data">The data</a></li>
  <li>
<a href="#the-model" id="toc-the-model" class="nav-link" data-scroll-target="#the-model">The model</a>
  <ul class="collapse">
<li><a href="#original-sas-model-as-a-baseline" id="toc-original-sas-model-as-a-baseline" class="nav-link" data-scroll-target="#original-sas-model-as-a-baseline">Original SAS model as a baseline</a></li>
  <li><a href="#survival-model" id="toc-survival-model" class="nav-link" data-scroll-target="#survival-model">Survival model</a></li>
  <li><a href="#poisson-model" id="toc-poisson-model" class="nav-link" data-scroll-target="#poisson-model">Poisson model</a></li>
  <li><a href="#mlogit-model" id="toc-mlogit-model" class="nav-link" data-scroll-target="#mlogit-model"><code>mlogit</code> model</a></li>
  <li><a href="#mclogit-model" id="toc-mclogit-model" class="nav-link" data-scroll-target="#mclogit-model"><code>mclogit</code> model</a></li>
  <li><a href="#bayesian-model" id="toc-bayesian-model" class="nav-link" data-scroll-target="#bayesian-model">Bayesian model</a></li>
  </ul>
</li>
  <li>
<a href="#predictions" id="toc-predictions" class="nav-link" data-scroll-target="#predictions">Predictions</a>
  <ul class="collapse">
<li><a href="#frequentist-predictions" id="toc-frequentist-predictions" class="nav-link" data-scroll-target="#frequentist-predictions">Frequentist predictions</a></li>
  <li><a href="#bayesian-predictions" id="toc-bayesian-predictions" class="nav-link" data-scroll-target="#bayesian-predictions">Bayesian predictions</a></li>
  <li><a href="#plots" id="toc-plots" class="nav-link" data-scroll-target="#plots">Plots</a></li>
  </ul>
</li>
  <li>
<a href="#amces" id="toc-amces" class="nav-link" data-scroll-target="#amces">AMCEs</a>
  <ul class="collapse">
<li><a href="#bayesian-comparisonscontrasts" id="toc-bayesian-comparisonscontrasts" class="nav-link" data-scroll-target="#bayesian-comparisonscontrasts">Bayesian comparisons/contrasts</a></li>
  <li><a href="#frequentist-comparisonscontrasts" id="toc-frequentist-comparisonscontrasts" class="nav-link" data-scroll-target="#frequentist-comparisonscontrasts">Frequentist comparisons/contrasts</a></li>
  <li><a href="#plots-1" id="toc-plots-1" class="nav-link" data-scroll-target="#plots-1">Plots</a></li>
  </ul>
</li>
  </ul>
</li>
  <li>
<a href="#part-2-minivans-repeated-questions-basic-multinomial-logit" id="toc-part-2-minivans-repeated-questions-basic-multinomial-logit" class="nav-link" data-scroll-target="#part-2-minivans-repeated-questions-basic-multinomial-logit">Part 2: Minivans; repeated questions; basic multinomial logit</a>
  <ul>
<li><a href="#the-setup-1" id="toc-the-setup-1" class="nav-link" data-scroll-target="#the-setup-1">The setup</a></li>
  <li><a href="#the-data-1" id="toc-the-data-1" class="nav-link" data-scroll-target="#the-data-1">The data</a></li>
  <li>
<a href="#the-model-1" id="toc-the-model-1" class="nav-link" data-scroll-target="#the-model-1">The model</a>
  <ul class="collapse">
<li><a href="#original-model-as-a-baseline" id="toc-original-model-as-a-baseline" class="nav-link" data-scroll-target="#original-model-as-a-baseline">Original model as a baseline</a></li>
  <li><a href="#mlogit-model-1" id="toc-mlogit-model-1" class="nav-link" data-scroll-target="#mlogit-model-1"><code>mlogit</code> model</a></li>
  <li><a href="#mclogit-model-1" id="toc-mclogit-model-1" class="nav-link" data-scroll-target="#mclogit-model-1"><code>mclogit</code> model</a></li>
  <li><a href="#bayesian-model-with-brms" id="toc-bayesian-model-with-brms" class="nav-link" data-scroll-target="#bayesian-model-with-brms">Bayesian model with {brms}</a></li>
  </ul>
</li>
  <li>
<a href="#predictions-1" id="toc-predictions-1" class="nav-link" data-scroll-target="#predictions-1">Predictions</a>
  <ul class="collapse">
<li><a href="#frequentist-predictions-1" id="toc-frequentist-predictions-1" class="nav-link" data-scroll-target="#frequentist-predictions-1">Frequentist predictions</a></li>
  <li><a href="#bayesian-predictions-1" id="toc-bayesian-predictions-1" class="nav-link" data-scroll-target="#bayesian-predictions-1">Bayesian predictions</a></li>
  </ul>
</li>
  <li>
<a href="#amces-1" id="toc-amces-1" class="nav-link" data-scroll-target="#amces-1">AMCEs</a>
  <ul class="collapse">
<li><a href="#frequentist-comparisonscontrasts-1" id="toc-frequentist-comparisonscontrasts-1" class="nav-link" data-scroll-target="#frequentist-comparisonscontrasts-1">Frequentist comparisons/contrasts</a></li>
  <li><a href="#bayesian-comparisonscontrasts-1" id="toc-bayesian-comparisonscontrasts-1" class="nav-link" data-scroll-target="#bayesian-comparisonscontrasts-1">Bayesian comparisons/contrasts</a></li>
  <li><a href="#plots-2" id="toc-plots-2" class="nav-link" data-scroll-target="#plots-2">Plots</a></li>
  </ul>
</li>
  </ul>
</li>
  <li>
<a href="#part-3-minivans-repeated-questions-full-hierarchical-multinomial-logit" id="toc-part-3-minivans-repeated-questions-full-hierarchical-multinomial-logit" class="nav-link" data-scroll-target="#part-3-minivans-repeated-questions-full-hierarchical-multinomial-logit">Part 3: Minivans; repeated questions; full hierarchical multinomial logit</a>
  <ul>
<li><a href="#the-setup-2" id="toc-the-setup-2" class="nav-link" data-scroll-target="#the-setup-2">The setup</a></li>
  <li>
<a href="#important-sidenote-on-notation" id="toc-important-sidenote-on-notation" class="nav-link" data-scroll-target="#important-sidenote-on-notation">Important sidenote on notation</a>
  <ul class="collapse">
<li><a href="#random-intercepts" id="toc-random-intercepts" class="nav-link" data-scroll-target="#random-intercepts">Random intercepts</a></li>
  <li><a href="#random-slopes" id="toc-random-slopes" class="nav-link" data-scroll-target="#random-slopes">Random slopes</a></li>
  <li><a href="#summary-table" id="toc-summary-table" class="nav-link" data-scroll-target="#summary-table">Summary table</a></li>
  </ul>
</li>
  <li>
<a href="#translating-from-marketing-style-stan-notation-to-brms-syntax" id="toc-translating-from-marketing-style-stan-notation-to-brms-syntax" class="nav-link" data-scroll-target="#translating-from-marketing-style-stan-notation-to-brms-syntax">Translating from marketing-style Stan notation to {brms} syntax</a>
  <ul class="collapse">
<li><a href="#different-variations-of-group-level-interactions" id="toc-different-variations-of-group-level-interactions" class="nav-link" data-scroll-target="#different-variations-of-group-level-interactions">Different variations of group-level interactions</a></li>
  </ul>
</li>
  <li><a href="#mlogit-model-2" id="toc-mlogit-model-2" class="nav-link" data-scroll-target="#mlogit-model-2"><code>mlogit</code> model</a></li>
  <li><a href="#finally-the-full-brms-model" id="toc-finally-the-full-brms-model" class="nav-link" data-scroll-target="#finally-the-full-brms-model">Finally, the full {brms} model</a></li>
  <li><a href="#predictions-2" id="toc-predictions-2" class="nav-link" data-scroll-target="#predictions-2">Predictions</a></li>
  <li><a href="#amces-2" id="toc-amces-2" class="nav-link" data-scroll-target="#amces-2">AMCEs</a></li>
  </ul>
</li>
  <li><a href="#tldr-moral-of-the-story" id="toc-tldr-moral-of-the-story" class="nav-link" data-scroll-target="#tldr-moral-of-the-story">tl;dr: Moral of the story</a></li>
  </ul></nav>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content"><p>I recently <a href="https://www.andrewheiss.com/blog/2023/07/25/conjoint-bayesian-frequentist-guide/">posted a guide</a> (mostly for future-me) about how to analyze conjoint survey data with R. I explore two different estimands that social scientists are interested in—causal average marginal component effects (AMCEs) and descriptive marginal means—and show how to find them with R, with both frequentist and Bayesian approaches.</p>
<p>However, that post is a little wrong. It’s not <em>wrong</em> wrong, but it is a bit oversimplified.</p>
<p>When political scientists, psychologists, economists, and other social scientists analyze conjoint data, they overwhelmingly do it with <a href="https://en.wikipedia.org/wiki/Ordinary_least_squares">ordinary least squares (OLS) regression</a>, or just standard linear regression (<code>lm(y ~ x)</code> in R; <code>reg y x</code> in Stata). Even if the outcome is binary, they’ll use OLS and call it a linear probability model. The main R package for working with conjoint data in a frequentist way (<a href="https://thomasleeper.com/cregg/">{cregg}</a>) uses OLS and linear probability models. Social scientists (and economists in particular) adore OLS.</p>
<figure class="figure"><video controls="" loop="" width="90%" style="display: block; margin: auto;"><source src="img/parks-rec-ols.mp4" type="video/mp4"></video><figcaption>Video by <a href="https://twitter.com/theotheredmund/status/1349453230762196992">Edmund Helmer</a></figcaption></figure><p>In my earlier guide, <a href="https://www.andrewheiss.com/blog/2023/07/25/conjoint-bayesian-frequentist-guide/#the-overall-model">I showed how to analyze the data with logistic regression</a>, but even that is still overly simplified. In reality, conjoint choice-based experiments are more complex than what regular old OLS regression—or even logistic regression—can handle (though I’m sure some econometrician somewhere has a proof showing that OLS works just fine for multinomial conjoint data :shrug:).</p>
<p>A recent paper published in <em>Political Science Research and Methods</em> <span class="citation" data-cites="JensenMarbleScheve:2021">(<a href="#ref-JensenMarbleScheve:2021" role="doc-biblioref">Jensen et al. 2021</a>)</span> does an excellent job explaining the problem with using plain old OLS to estimate AMCEs and marginal means with conjoint data (<a href="https://williammarble.co/docs/CityLimits-April2020.pdf">access the preprint here</a>). Their main argument boils down to this: OLS throws away too much useful information about (1) the relationships and covariance between the different combinations of feature levels offered to respondents, and (2) individual-specific differences in how respondents react to different feature levels.</p>
<p>Jensen et al.&nbsp;explain three different approaches to analyzing data that has a natural hierarchical structure like conjoint data (where lots of choices related to different “products” are nested within individuals). This also is the same argument from <a href="https://www.bayesrulesbook.com/chapter-15">chapter 15 of <em>Bayes Rules!</em></a>.</p>
<ol type="1">
<li>
<p><strong>Pooled data</strong> (<a href="https://www.bayesrulesbook.com/chapter-15#ch15-complete">“no room for individuality”</a>): The easiest way to deal with individual-specific effects is to not to. Lump each choice by each respondent into one big dataset, run OLS on it, and be done. Believe it or not, linear regression right away.</p>
<p>However, this erases all individual-level heterogeneity and details about how different feature levels interact with individual characteristics.</p>
</li>
<li>
<p><strong>No pooling</strong> (<a href="https://www.bayesrulesbook.com/chapter-15#no-pooling">“every person for themselves”</a>): An alternative way to deal with individual-specific effects is to run a separate model for each individual. If 800 people participated in the experiment, run 800 different models. That way you can perfectly model the relationship between each individual’s characteristics (political party, age, income, education, etc.) with their choices and preferences.</p>
<p>This sounds neat, but has substantial issues. It’ll only show an identified causal effect if each respondent saw every combination of conjoint features at least once. In the candidate experiment <a href="https://www.andrewheiss.com/blog/2023/07/25/conjoint-bayesian-frequentist-guide/">from my previous post</a>, there were 8 features with different counts of attributes: 2 × 6 × 6 × 6 × 2 × 6 × 6 × 6 = 186,624 possibilities. Every respondent would need to see each of the nearly 200,000 options. lol.</p>
</li>
<li>
<p><strong>Partial pooling</strong> (<a href="https://www.bayesrulesbook.com/chapter-15#partial-pooling-with-hierarchical-models">“a welcome middle ground”</a>): Jensen et al.’s solution is to use hierarchical models that allow individual-level characteristics to inform choice-level decisions. As <em>Bayes Rules!</em> says:</p>
<blockquote class="blockquote">
<p>[T]hough each group is <em>unique</em>, having been sampled from the same population, all groups are connected and thus might contain valuable information about one another.</p>
</blockquote>
<p>In this kind of model, we want individual-level characteristics like age, income, education, etc. to inform the decision to choose specific outcomes and interact with different feature levels in different ways. Not every respondent needs to have seen all 200,000 options—information about respondents with similar characteristics facing similar sets of choices gets shared because of the hierarchical-ness of the model.</p>
</li>
</ol>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Best overview of multilevel models
</div>
</div>
<div class="callout-body-container callout-body">
<p>For the best overviews I’ve found of how multilevel models work, check out these two resources:</p>
<ul>
<li>Chapters 15–17 in <a href="https://www.bayesrulesbook.com/"><em>Bayes Rules!</em></a> (<a href="https://www.bayesrulesbook.com/chapter-17">especially chapter 17</a>)</li>
<li>Michael Clark’s <a href="https://m-clark.github.io/mixed-models-with-R/"><em>Mixed Models with R</em> guide</a>
</li>
</ul>
<p><a href="https://www.andrewheiss.com/blog/2021/12/01/multilevel-models-panel-data-guide/">I also have a guide here</a>, but it’s nowhere near as good as those ↑</p>
</div>
</div>
<p>By using a multilevel hierarchical model, <span class="citation" data-cites="JensenMarbleScheve:2021">Jensen et al. (<a href="#ref-JensenMarbleScheve:2021" role="doc-biblioref">2021</a>)</span> show that we can still find AMCEs and causal effects, just like in my previous guide, but we can take advantage of the far richer heterogeneity that we get from these complex statements. We can make cool statements like this (in an experiment that varied policies related to unions):</p>
<blockquote class="blockquote">
<p>On average, Democrats are <span class="math inline">\(x\)</span> percentage points more likely than demographically similar Republicans to support a plan that includes expanding union power, relative to the status quo.</p>
</blockquote>
<p>Using hierarchical models for conjoint experiments in political science is new and exciting and revolutionary and neat. That’s the whole point of Jensen et al.’s paper—it’s a call to stop using OLS for everything.</p>
<p>I’ve been working on a conjoint experiment with my coauthors <a href="https://marriott.byu.edu/directory/details?id=50683">Marc Dotson</a> and <a href="https://www.suparnachaudhry.com/">Suparna Chaudhry</a>. Suparna and I are political scientists and this multilevel stuff in general is still relatively new and wildly underused in the discipline. Marc, though, is a marketing scholar. The marketing world has been using hierarchical models for conjoint experiments for a long time and it’s standard practice in that discipline. There’s a whole textbook about the hierarchical model approach in marketing <span class="citation" data-cites="ChapmanFeit:2019">(<a href="#ref-ChapmanFeit:2019" role="doc-biblioref">Chapman and Feit 2019</a>)</span>, and these fancy conjoint multilevel models are used widely throughout the marketing industry.</p>
<p>lol at political science, just now discovering this.</p>
<hr>
<p>So, I need to expand <a href="https://www.andrewheiss.com/blog/2023/07/25/conjoint-bayesian-frequentist-guide/">my previous conjoint guide</a>. That’s what this post is for.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Who this post is for
</div>
</div>
<div class="callout-body-container callout-body">
<p>Here’s what I assume you know:</p>
<ul>
<li>You’re familiar with <a href="https://www.r-project.org/">R</a> and the <a href="https://www.tidyverse.org/">tidyverse</a> (particularly <a href="https://dplyr.tidyverse.org/">{dplyr}</a> and <a href="https://ggplot2.tidyverse.org/">{ggplot2}</a>).</li>
<li>You’re familiar with linear regression and packages like <a href="https://broom.tidymodels.org/">{broom}</a> for converting regression results into tidy data frames and <a href="https://vincentarelbundock.github.io/marginaleffects/">{marginaleffects}</a> for calculating <a href="https://www.andrewheiss.com/blog/2022/05/20/marginalia/">marginal effects</a>.</li>
<li>You’re familiar with <a href="https://paul-buerkner.github.io/brms/">{brms}</a> for running Bayesian regression models and <a href="https://mjskay.github.io/tidybayes/">{tidybayes}</a> and <a href="https://mjskay.github.io/ggdist/">{ggdist}</a> for manipulating and plotting posterior draws. You <em>don’t</em> need to know how to write stuff in raw Stan.</li>
</ul>
</div>
</div>
<p>I’ll do three things in this guide:</p>
<ol type="1">
<li>
<strong>Chocolate</strong>: Analyze a simple choice-based conjoint experiment where respondents only saw one set of options. This is so I can (1) explore the {mlogit} package, and (2) figure out how to work with multinomial models and predictions both frequentistly and Bayesianly.</li>
<li>
<strong>Minivans</strong>: Analyze a more complex choice-based conjoint experiment where respondents saw three randomly selected options fifteen times. I do this with both {mlogit} and {brms} to figure out how to work with true multinomial outcomes both frequentistly and Bayesianly.</li>
<li>
<strong>Minivans again</strong>: Analyze the same complex choice-based experiment but incorporate respondent-level characteristics into the estimates using a hierarchical or multilevel model. I only do this with {brms} because in reality I have no interest in working with {mlogit} (I only use it here as a sort of baseline for my {brms} explorations).</li>
</ol>
<p>Throughout this example, I’ll use data from two different simulated conjoint choice experiments. You can download these files and follow along:</p>
<ul>
<li>
<a href="data/choco_candy.csv"><i class="fa-solid fa-table" aria-label="table"></i> <code>choco_candy.csv</code></a>: This is simulated data for a hypothetical experiment about consumer preferences for candy features. It comes from p.&nbsp;292 in <span class="citation" data-cites="Kuhfeld:2010">Kuhfeld (<a href="#ref-Kuhfeld:2010" role="doc-biblioref">2010</a>)</span>, a <a href="http://support.sas.com/techsup/technote/mr2010f.pdf">SAS technical note</a> about how to run multinomial models in SAS. Instead of copying/pasting from the PDF, <a href="https://github.com/sangwoo-statistics/dataset">I found a version of it here</a>, cleaned up by Sangwoo Kim (who also has <a href="https://www.youtube.com/watch?v=ra8Y2FjRqOE">a YouTube tutorial</a> using the same candy data)</li>
<li>
<a href="data/rintro-chapter13conjoint.csv"><i class="fa-solid fa-table" aria-label="table"></i> <code>rintro-chapter13conjoint.csv</code></a>: This is simultated data for a hypothetical experiment about consumer preferences for minivan features. It comes from chapter 13 in <span class="citation" data-cites="ChapmanFeit:2019">Chapman and Feit (<a href="#ref-ChapmanFeit:2019" role="doc-biblioref">2019</a>)</span> and is available from the <a href="http://r-marketing.r-forge.r-project.org/">book’s resources page</a> (or <a href="http://r-marketing.r-forge.r-project.org/data/">directly from their data folder</a>)</li>
</ul>
<div id="mclogit-note" class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
{mlogit}, {mclogit}, and {marginaleffects}
</div>
</div>
<div class="callout-body-container callout-body">
<p>In September 2024, {marginaleffects} <a href="https://github.com/vincentarelbundock/marginaleffects/commit/9778eef3ad98369c6e8d11ba7e894111ae6b4e94">removed support</a> for {mlogit} because the internal model object structure made it extremely difficult to calculate consistent results.</p>
<p>We can calculate predictions with {mlogit}’s version of <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code>, but it doesn’t include standard errors, so we can’t find confidence intervals or other measures of uncertainty without doing fancier things like bootstrapping or using Bayesian methods. The Bayesian approach is the whole point of this tutorial, really, so take the difficulty of {mlogit}-related postestimation work as a call to convert to the wonderful world of {brms} and Bayes. :)</p>
<p>If you’re really into frequentism and want to use {marginaleffects}, you can use <a href="https://cran.r-project.org/package=mclogit">the {mclogit} package</a>, which comes with <code>mclogit()</code> for fitting conditional logit models just like {mlogit}, but with {marginaleffects} support.</p>
<p>The results that you get from <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> and <code>marginaleffects::predictions()</code> are different from <code>mlogit()</code> and seem to be closer to what happens with {brms}, but working with them is left as an exercise to the reader.</p>
<p>I’ve included examples of how to fit <code>mclogit()</code> models for both the <a href="#mclogit-model">chocolate example</a> and the <a href="#mclogit-model-1">minivan example</a> below.</p>
</div>
</div>
<p>Additionally, in <a href="#part-3-minivans-repeated-questions-full-hierarchical-multinomial-logit">Part 3</a>, I fit a huge Stan model with {brms} that takes ≈30 minutes to run on my fast laptop. If you want to follow along and not melt your CPU for half an hour, you can download an .rds file of that fitted model that I stuck in <a href="https://osf.io/3y7es/">an OSF project</a>. The code for <code>brm()</code> later in this guide will load the .rds file automatically instead of rerunning the model as long as you put it in a folder named “models” in your working directory. This code uses the <a href="https://docs.ropensci.org/osfr/">{osfr} package</a> to download <a href="https://osf.io/zp6eh">the .rds file from OSF</a> automatically and places it where it needs to go:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/osfr/">osfr</a></span><span class="op">)</span>  <span class="co"># Interact with OSF via R</span></span>
<span></span>
<span><span class="co"># Make a "models" folder if it doesn't exist already</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html">file.exists</a></span><span class="op">(</span><span class="st">"models"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span> <span class="fu"><a href="https://rdrr.io/r/base/files2.html">dir.create</a></span><span class="op">(</span><span class="st">"models"</span><span class="op">)</span> <span class="op">}</span></span>
<span></span>
<span><span class="co"># Download model_minivans_mega_mlm_brms.rds from OSF</span></span>
<span><span class="fu">osf_retrieve_file</span><span class="op">(</span><span class="st">"https://osf.io/zp6eh"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">osf_download</span><span class="op">(</span>path <span class="op">=</span> <span class="st">"models"</span>, conflicts <span class="op">=</span> <span class="st">"overwrite"</span>, progress <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s load some libraries, create some helper functions, load the data, and get started!</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>        <span class="co"># ggplot, dplyr, and friends</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://broom.tidymodels.org/">broom</a></span><span class="op">)</span>            <span class="co"># Convert model objects to tidy data frames</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://easystats.github.io/parameters/">parameters</a></span><span class="op">)</span>       <span class="co"># Show model results as nice tables</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://r-survey.r-forge.r-project.org/survey/">survey</a></span><span class="op">)</span>           <span class="co"># Panel-ish frequentist regression models</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://cran.r-project.org/package=mlogit">mlogit</a></span><span class="op">)</span>           <span class="co"># Frequentist multinomial regression models</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://cran.r-project.org/package=dfidx">dfidx</a></span><span class="op">)</span>            <span class="co"># Structure data for {mlogit} models</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://scales.r-lib.org">scales</a></span><span class="op">)</span>           <span class="co"># Nicer labeling functions</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://marginaleffects.com/">marginaleffects</a></span><span class="op">)</span>  <span class="co"># Calculate marginal effects</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggforce.data-imaginist.com">ggforce</a></span><span class="op">)</span>          <span class="co"># For facet_col()</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/paul-buerkner/brms">brms</a></span><span class="op">)</span>             <span class="co"># The best formula-based interface to Stan</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mjskay.github.io/tidybayes/">tidybayes</a></span><span class="op">)</span>        <span class="co"># Manipulate Stan results in tidy ways</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mjskay.github.io/ggdist/">ggdist</a></span><span class="op">)</span>           <span class="co"># Fancy distribution plots</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com">patchwork</a></span><span class="op">)</span>        <span class="co"># Combine ggplot plots</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/Nowosad/rcartocolor">rcartocolor</a></span><span class="op">)</span>      <span class="co"># Color palettes from CARTOColors (https://carto.com/carto-colors/)</span></span>
<span></span>
<span><span class="co"># Custom ggplot theme to make pretty plots</span></span>
<span><span class="co"># Get the font at https://github.com/intel/clear-sans</span></span>
<span><span class="va">theme_nice</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span>base_family <span class="op">=</span> <span class="st">"Clear Sans"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">theme</span><span class="op">(</span>panel.grid.minor <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>          plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Clear Sans"</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>          axis.title.x <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>          axis.title.y <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>          strip.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Clear Sans"</span>, face <span class="op">=</span> <span class="st">"bold"</span>,</span>
<span>                                    size <span class="op">=</span> <span class="fu">rel</span><span class="op">(</span><span class="fl">0.75</span><span class="op">)</span>, hjust <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>          strip.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"grey90"</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">theme_set</span><span class="op">(</span><span class="fu">theme_nice</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">clrs</span> <span class="op">&lt;-</span> <span class="fu">carto_pal</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Prism"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Functions for formatting things as percentage points</span></span>
<span><span class="va">label_pp</span> <span class="op">&lt;-</span> <span class="fu">label_number</span><span class="op">(</span>accuracy <span class="op">=</span> <span class="fl">1</span>, scale <span class="op">=</span> <span class="fl">100</span>, </span>
<span>                         suffix <span class="op">=</span> <span class="st">" pp."</span>, style_negative <span class="op">=</span> <span class="st">"minus"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">chocolate</span> <span class="op">&lt;-</span> <span class="fu">read_csv</span><span class="op">(</span><span class="st">"data/choco_candy.csv"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    dark <span class="op">=</span> <span class="fu">case_match</span><span class="op">(</span><span class="va">dark</span>, <span class="fl">0</span> <span class="op">~</span> <span class="st">"Milk"</span>, <span class="fl">1</span> <span class="op">~</span> <span class="st">"Dark"</span><span class="op">)</span>,</span>
<span>    dark <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">dark</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Milk"</span>, <span class="st">"Dark"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    soft <span class="op">=</span> <span class="fu">case_match</span><span class="op">(</span><span class="va">soft</span>, <span class="fl">0</span> <span class="op">~</span> <span class="st">"Chewy"</span>, <span class="fl">1</span> <span class="op">~</span> <span class="st">"Soft"</span><span class="op">)</span>,</span>
<span>    soft <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">soft</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Chewy"</span>, <span class="st">"Soft"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    nuts <span class="op">=</span> <span class="fu">case_match</span><span class="op">(</span><span class="va">nuts</span>, <span class="fl">0</span> <span class="op">~</span> <span class="st">"No nuts"</span>, <span class="fl">1</span> <span class="op">~</span> <span class="st">"Nuts"</span><span class="op">)</span>,</span>
<span>    nuts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">nuts</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"No nuts"</span>, <span class="st">"Nuts"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">minivans</span> <span class="op">&lt;-</span> <span class="fu">read_csv</span><span class="op">(</span><span class="st">"data/rintro-chapter13conjoint.csv"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    <span class="fu">across</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">seat</span>, <span class="va">cargo</span>, <span class="va">price</span><span class="op">)</span>, <span class="va">factor</span><span class="op">)</span>,</span>
<span>    carpool <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">carpool</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"no"</span>, <span class="st">"yes"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    eng <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">eng</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"gas"</span>, <span class="st">"hyb"</span>, <span class="st">"elec"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>&nbsp;</p>
<section id="part-1-candy-single-question-basic-multinomial-logit" class="level1 page-columns page-full"><h1>Part 1: Candy; single question; basic multinomial logit</h1>
<section id="the-setup" class="level2"><h2 class="anchored" data-anchor-id="the-setup">The setup</h2>
<p>In this experiment, respondents are asked to choose which of these kinds of candies they’d want to buy. Respondents only see this question one time and all possible options are presented simultaneously.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Example survey question
</div>
</div>
<div class="callout-body-container callout-body">
<table class="caption-top table">
<colgroup>
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 11%">
</colgroup>
<thead><tr class="header">
<th></th>
<th style="text-align: center;">A</th>
<th style="text-align: center;">B</th>
<th style="text-align: center;">C</th>
<th style="text-align: center;">D</th>
<th style="text-align: center;">E</th>
<th style="text-align: center;">F</th>
<th style="text-align: center;">G</th>
<th style="text-align: center;">H</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Chocolate</td>
<td style="text-align: center;">Milk</td>
<td style="text-align: center;">Milk</td>
<td style="text-align: center;">Milk</td>
<td style="text-align: center;">Milk</td>
<td style="text-align: center;">Dark</td>
<td style="text-align: center;">Dark</td>
<td style="text-align: center;">Dark</td>
<td style="text-align: center;">Dark</td>
</tr>
<tr class="even">
<td>Center</td>
<td style="text-align: center;">Chewy</td>
<td style="text-align: center;">Chewy</td>
<td style="text-align: center;">Soft</td>
<td style="text-align: center;">Soft</td>
<td style="text-align: center;">Chewy</td>
<td style="text-align: center;">Chewy</td>
<td style="text-align: center;">Soft</td>
<td style="text-align: center;">Soft</td>
</tr>
<tr class="odd">
<td>Nuts</td>
<td style="text-align: center;">No nuts</td>
<td style="text-align: center;">Nuts</td>
<td style="text-align: center;">No nuts</td>
<td style="text-align: center;">Nuts</td>
<td style="text-align: center;">No nuts</td>
<td style="text-align: center;">Nuts</td>
<td style="text-align: center;">No nuts</td>
<td style="text-align: center;">Nuts</td>
</tr>
<tr class="even">
<td>Choice</td>
<td style="text-align: center;"><input type="radio" name="ex1"></td>
<td style="text-align: center;"><input type="radio" name="ex1"></td>
<td style="text-align: center;"><input type="radio" name="ex1"></td>
<td style="text-align: center;"><input type="radio" name="ex1"></td>
<td style="text-align: center;"><input type="radio" name="ex1"></td>
<td style="text-align: center;"><input type="radio" name="ex1"></td>
<td style="text-align: center;"><input type="radio" name="ex1"></td>
<td style="text-align: center;"><input type="radio" name="ex1"></td>
</tr>
</tbody>
</table>
</div>
</div>
</section><section id="the-data" class="level2"><h2 class="anchored" data-anchor-id="the-data">The data</h2>
<p>The data for this kind of experiment looks like this, with one row for each possible alternative (so eight rows per person, or <code>subj</code>), with the alternative that was selected marked as 1 in <code>choice</code>. Here, Subject 1 chose option E (dark, chewy, no nuts). There were 10 respondents, with 8 rows each, so there are 10 × 8 = 80 rows.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">chocolate</span></span>
<span><span class="co">## # A tibble: 80 × 6</span></span>
<span><span class="co">##     subj choice alt   dark  soft  nuts   </span></span>
<span><span class="co">##    &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt;  </span></span>
<span><span class="co">##  1     1      0 A     Milk  Chewy No nuts</span></span>
<span><span class="co">##  2     1      0 B     Milk  Chewy Nuts   </span></span>
<span><span class="co">##  3     1      0 C     Milk  Soft  No nuts</span></span>
<span><span class="co">##  4     1      0 D     Milk  Soft  Nuts   </span></span>
<span><span class="co">##  5     1      1 E     Dark  Chewy No nuts</span></span>
<span><span class="co">##  6     1      0 F     Dark  Chewy Nuts   </span></span>
<span><span class="co">##  7     1      0 G     Dark  Soft  No nuts</span></span>
<span><span class="co">##  8     1      0 H     Dark  Soft  Nuts   </span></span>
<span><span class="co">##  9     2      0 A     Milk  Chewy No nuts</span></span>
<span><span class="co">## 10     2      0 B     Milk  Chewy Nuts   </span></span>
<span><span class="co">## # ℹ 70 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="the-model" class="level2"><h2 class="anchored" data-anchor-id="the-model">The model</h2>
<p>Respondents were shown eight different options and asked to select one. While this seems like a binary yes/no choice that could work with just regular plain old logistic regression, we want to account for the features and levels in all the unchosen categories too. To do this, we can use <a href="https://en.wikipedia.org/wiki/Multinomial_logistic_regression">multinomial logistic regression</a>, where the outcome variable is an unordered categorical variable with more than two categories. In this case we have eight different possible outcomes: alternatives A through H.</p>
<section id="original-sas-model-as-a-baseline" class="level3"><h3 class="anchored" data-anchor-id="original-sas-model-as-a-baseline">Original SAS model as a baseline</h3>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
lol SAS
</div>
</div>
<div class="callout-body-container callout-body">
<p>I know nothing about SAS. I have never opened SAS in my life. It is a mystery to me.</p>
<p>I copied these results directly from p.&nbsp;297 in SAS’s massive <a href="http://support.sas.com/techsup/technote/mr2010f.pdf">“Discrete Choice” technical note</a> <span class="citation" data-cites="Kuhfeld:2010">(<a href="#ref-Kuhfeld:2010" role="doc-biblioref">Kuhfeld 2010</a>)</span>.</p>
<p>I only have this SAS output here as a baseline reference for what the actual correct coefficients are supposed to be.</p>
</div>
</div>
<p>SAS apparently fits these models with proportional hazard survival-style models, which feels weird, but there’s probably a mathematical or statistical reason for it. You use PROC PHREG to do it:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>proc phreg data=chocs outest=betas;</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>   strata subj set;</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>   model c*c(2) = dark soft nuts / ties=breslow;</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>   run;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>It gives these results:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>                   Choice of Chocolate Candies</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>                       The PHREG Procedure</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>              Multinomial Logit Parameter Estimates</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>                      Parameter     Standard</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>                 DF    Estimate        Error  Chi-Square   Pr &gt; ChiSq</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>Dark Chocolate   1      1.38629      0.79057      3.0749       0.0795</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>Soft Center      1     -2.19722      1.05409      4.3450       0.0371</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>With Nuts        1      0.84730      0.69007      1.5076       0.2195</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section><section id="survival-model" class="level3"><h3 class="anchored" data-anchor-id="survival-model">Survival model</h3>
<p>Ew, enough SAS. Let’s do this with R instead.</p>
<p>We can recreate the same proportional hazards model with <code>coxph()</code> from the {survival} package. Again, this feels weird and not like an intended purpose of survival models and not like multinomial logit at all—in my mind it is neither (1) multinomial nor (2) logit, but whatever. People far smarter than me invented these things, so I’ll just trust them.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_chocolate_survival</span> <span class="op">&lt;-</span> <span class="fu">coxph</span><span class="op">(</span></span>
<span>  <span class="fu">Surv</span><span class="op">(</span><span class="va">subj</span>, <span class="va">choice</span><span class="op">)</span> <span class="op">~</span> <span class="va">dark</span> <span class="op">+</span> <span class="va">soft</span> <span class="op">+</span> <span class="va">nuts</span>, </span>
<span>  data <span class="op">=</span> <span class="va">chocolate</span>, </span>
<span>  ties <span class="op">=</span> <span class="st">"breslow"</span>  <span class="co"># This is what SAS uses</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">model_parameters</span><span class="op">(</span><span class="va">model_chocolate_survival</span>, digits <span class="op">=</span> <span class="fl">4</span>, p_digits <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="co">## Parameter   | Coefficient |     SE |             95% CI |       z |      p</span></span>
<span><span class="co">## --------------------------------------------------------------------------</span></span>
<span><span class="co">## dark [Dark] |      1.3863 | 0.7906 | [-0.1632,  2.9358] |  1.7535 | 0.0795</span></span>
<span><span class="co">## soft [Soft] |     -2.1972 | 1.0541 | [-4.2632, -0.1312] | -2.0845 | 0.0371</span></span>
<span><span class="co">## nuts [Nuts] |      0.8473 | 0.6901 | [-0.5052,  2.1998] |  1.2279 | 0.2195</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The coefficients, standard errors, and p-values are identical to the SAS output! The only difference is the statistic: in SAS they use a chi-square statistic, while <code>survival:coxph()</code> uses a z statistic. There’s probably a way to make <code>coxph()</code> use a chi-square statistic, but I don’t care about that. I never use survival models and I’m only doing this to replicate the SAS output and it just doesn’t matter.</p>
</section><section id="poisson-model" class="level3"><h3 class="anchored" data-anchor-id="poisson-model">Poisson model</h3>
<p>An alternative way to fit a multinomial logit model without resorting to survival models is to actually (mis?)use another model family. We can use a Poisson model, even though <code>choice</code> isn’t technically count data, because of obscure stats reasons. <a href="https://online.stat.psu.edu/stat504/lesson/2/2.3/2.3.6">See here</a> for an illustration of the relationship between multinomial and Poisson distributions; or <a href="https://doi.org/10.1093/biomet/asr026">see this 2011 <em>Biometrika</em> paper</a> about using Poisson models to reduce bias in multinomial logit models. Richard McElreath has a subsection about this in <em>Statistical Rethinking</em> as well: “Multinomial in disguise as Poisson” (11.3.3). Or <a href="https://bsky.app/profile/rmcelreath.bsky.social/post/3k4e5s6zbxc2j">as he said over on the currently-walled-garden Bluesky</a>, “All count distributions are just one or more Poisson distributions in a trench coat.”</p>
<p>To account for the repeated subjects in the data, we’ll use <code>svyglm()</code> from the {survey} package so that the standard errors are more accurate.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_chocolate_poisson</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span></span>
<span>  <span class="va">choice</span> <span class="op">~</span> <span class="va">dark</span> <span class="op">+</span> <span class="va">soft</span> <span class="op">+</span> <span class="va">nuts</span>, </span>
<span>  data <span class="op">=</span> <span class="va">chocolate</span>, </span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">poisson</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">model_parameters</span><span class="op">(</span><span class="va">model_chocolate_poisson</span>, digits <span class="op">=</span> <span class="fl">4</span>, p_digits <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="co">## Parameter   | Log-Mean |     SE |             95% CI |       z |      p</span></span>
<span><span class="co">## -----------------------------------------------------------------------</span></span>
<span><span class="co">## (Intercept) |  -2.9188 | 0.8628 | [-4.9727, -1.4905] | -3.3829 | 0.0007</span></span>
<span><span class="co">## dark [Dark] |   1.3863 | 0.7906 | [ 0.0023,  3.2772] |  1.7535 | 0.0795</span></span>
<span><span class="co">## soft [Soft] |  -2.1972 | 1.0541 | [-5.1119, -0.5256] | -2.0845 | 0.0371</span></span>
<span><span class="co">## nuts [Nuts] |   0.8473 | 0.6901 | [-0.4328,  2.3820] |  1.2279 | 0.2195</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Lovely—the results are the same.</p>
</section><section id="mlogit-model" class="level3"><h3 class="anchored" data-anchor-id="mlogit-model">
<code>mlogit</code> model</h3>
<p>Finally, we can use the {mlogit} package to fit the model. Before using <code>mlogit()</code>, we need to transform our data a bit to specify which column represents the choice (<code>choice)</code> and how the data is indexed: subjects (<code>subj</code>) with repeated alternatives (<code>alt</code>).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">chocolate_idx</span> <span class="op">&lt;-</span> <span class="fu">dfidx</span><span class="op">(</span></span>
<span>  <span class="va">chocolate</span>,</span>
<span>  idx <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"subj"</span>, <span class="st">"alt"</span><span class="op">)</span>,</span>
<span>  choice <span class="op">=</span> <span class="st">"choice"</span>,</span>
<span>  shape <span class="op">=</span> <span class="st">"long"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can then use this indexed data frame with <code>mlogit()</code>, which uses the familiar R formula interface, but with some extra features separated by <code>|</code>s</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>outcome ~ features | individual-level variables | alternative-level variables</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If we had columns related to individual-level characteristics or alternative-level characteristics, we could include those in the model—and we’ll do precisely that later in this post. (Incorporating individual-level covariates is the whole point of this post!)</p>
<p>Let’s fit the model:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_chocolate_mlogit</span> <span class="op">&lt;-</span> <span class="fu">mlogit</span><span class="op">(</span></span>
<span>  <span class="va">choice</span> <span class="op">~</span> <span class="va">dark</span> <span class="op">+</span> <span class="va">soft</span> <span class="op">+</span> <span class="va">nuts</span> <span class="op">|</span> <span class="fl">0</span> <span class="op">|</span> <span class="fl">0</span>, </span>
<span>  data <span class="op">=</span> <span class="va">chocolate_idx</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">model_parameters</span><span class="op">(</span><span class="va">model_chocolate_mlogit</span>, digits <span class="op">=</span> <span class="fl">4</span>, p_digits <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="co">## Parameter   | Log-Odds |     SE |             95% CI |       z |      p</span></span>
<span><span class="co">## -----------------------------------------------------------------------</span></span>
<span><span class="co">## dark [Dark] |   1.3863 | 0.7906 | [-0.1632,  2.9358] |  1.7535 | 0.0795</span></span>
<span><span class="co">## soft [Soft] |  -2.1972 | 1.0541 | [-4.2632, -0.1312] | -2.0845 | 0.0371</span></span>
<span><span class="co">## nuts [Nuts] |   0.8473 | 0.6901 | [-0.5052,  2.1998] |  1.2279 | 0.2195</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Delightful. All the results are the same as the survival model and the Poisson model.</p>
</section><section id="mclogit-model" class="level3"><h3 class="anchored" data-anchor-id="mclogit-model">
<code>mclogit</code> model</h3>
<p><a href="#mclogit-note">As noted earlier</a>, {marginaleffects} doesn’t support <code>mlogit()</code> because of its weird internal structure. It <em>does</em> support <code>mclogit::mclogit()</code> though.</p>
<p>The syntax requires two parts on the left-hand side of the formula: (1) the choice selected (0 or 1), and (2) a unique id for set of choices, or the question. In this case, since each subject only saw one question, the <code>subj</code> column doubles as the question ID, so we can just use that.</p>
<p>The results are the same:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://mclogit.elff.eu">mclogit</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_chocolate_mclogit</span> <span class="op">&lt;-</span> <span class="fu">mclogit</span><span class="op">(</span></span>
<span>  <span class="va">choice</span> <span class="op">|</span> <span class="va">subj</span> <span class="op">~</span> <span class="va">dark</span> <span class="op">+</span> <span class="va">soft</span> <span class="op">+</span> <span class="va">nuts</span>,</span>
<span>  data <span class="op">=</span> <span class="va">chocolate</span></span>
<span><span class="op">)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Iteration 1 - deviance = 29.16 - criterion = 0.1735</span></span>
<span><span class="co">## Iteration 2 - deviance = 28.74 - criterion = 0.01449</span></span>
<span><span class="co">## Iteration 3 - deviance = 28.73 - criterion = 0.0003555</span></span>
<span><span class="co">## Iteration 4 - deviance = 28.73 - criterion = 5.523e-07</span></span>
<span><span class="co">## Iteration 5 - deviance = 28.73 - criterion = 1.554e-12</span></span>
<span><span class="co">## converged</span></span>
<span><span class="fu">model_parameters</span><span class="op">(</span><span class="va">model_chocolate_mclogit</span>, digits <span class="op">=</span> <span class="fl">4</span>, p_digits <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="co">## Parameter   | Log-Odds |     SE |             95% CI |       z |      p</span></span>
<span><span class="co">## -----------------------------------------------------------------------</span></span>
<span><span class="co">## dark [Dark] |   1.3863 | 0.7906 | [-0.1632,  2.9358] |  1.7535 | 0.0795</span></span>
<span><span class="co">## soft [Soft] |  -2.1972 | 1.0541 | [-4.2632, -0.1312] | -2.0845 | 0.0371</span></span>
<span><span class="co">## nuts [Nuts] |   0.8473 | 0.6901 | [-0.5052,  2.1998] |  1.2279 | 0.2195</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Uncertainty intervals (equal-tailed) and p-values (two-tailed) computed using a Wald z-distribution approximation.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="bayesian-model" class="level3"><h3 class="anchored" data-anchor-id="bayesian-model">Bayesian model</h3>
<p>We can also fit this model in a Bayesian way using {brms}. Stan has a categorical distribution family for multinomial models, and we’ll use it in the next example. For now, for the sake of simplicity, we’ll use a Poisson family, since, as we saw above, that’s a legal way of parameterizing multinomial distributions.</p>
<p>The data has a natural hierarchical structure to it, with 8 choices (for alternatives A through H) nested inside each of the 10 subjects.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/chocolate-multilevel-structure-1.svg" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption>Multilevel experimental structure, with candy choices <span class="math inline">\(y_{\text{A}\dots\text{H}}\)</span> nested in subjects</figcaption></figure>
</div>
</div>
</div>
<p>We want to model candy choice (<code>choice</code>) based on candy characteristics (<code>dark</code>, <code>soft</code>, and <code>nuts</code>). We’ll use the subscript <span class="math inline">\(i\)</span> to refer to individual candy choices and <span class="math inline">\(j\)</span> to refer to subjects.</p>
<p>Since we can legally pretend that this multinomial selection process is actually Poisson, we’ll model it as a Poisson process that has a rate of <span class="math inline">\(\lambda_{i_j}\)</span>. We’ll model that <span class="math inline">\(\lambda_{i_j}\)</span> with a log-linked regression model with covariates for each of the levels of each candy feature. To account for the multilevel structure, we’ll include subject-specific offsets (<span class="math inline">\(b_{0_j}\)</span>) from the global average, thus creating random intercepts. We’ll specify fairly wide priors just because.</p>
<p>Here’s the formal model for all this:</p>
<p><span class="math display">\[
\begin{aligned}
&amp;\ \textbf{Probability of selection of alternative}_i \textbf{ in subject}_j \\
\text{Choice}_{i_j} \sim&amp;\ \operatorname{Poisson}(\lambda_{i_j}) \\[10pt]
&amp;\ \textbf{Model for probability of each option} \\
\log(\lambda_{i_j}) =&amp;\ (\beta_0 + b_{0_j}) + \beta_1 \text{Dark}_{i_j} + \beta_2 \text{Soft}_{i_j} + \beta_3 \text{Nuts}_{i_j} \\[5pt]
b_{0_j} \sim&amp;\ \mathcal{N}(0, \sigma_0) \qquad\qquad\quad \text{Subject-specific offsets from global choice probability} \\[10pt]
&amp;\ \textbf{Priors} \\
\beta_0 \sim&amp;\ \mathcal{N}(0, 3) \qquad\qquad\quad\ \ \text{Prior for global average choice probability} \\
\beta_1, \beta_2, \beta_3 \sim&amp;\ \mathcal{N}(0, 3) \qquad\qquad\quad\ \ \text{Prior for candy feature levels} \\
\sigma_0 \sim&amp;\ \operatorname{Exponential}(1) \qquad \text{Prior for between-subject variability}
\end{aligned}
\]</span></p>
<p>And here’s the {brms} model:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_chocolate_brms</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span></span>
<span>  <span class="fu">bf</span><span class="op">(</span><span class="va">choice</span> <span class="op">~</span> <span class="va">dark</span> <span class="op">+</span> <span class="va">soft</span> <span class="op">+</span> <span class="va">nuts</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">subj</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">chocolate</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">poisson</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="fu">prior</span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,</span>
<span>    <span class="fu">prior</span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,</span>
<span>    <span class="fu">prior</span><span class="op">(</span><span class="fu">exponential</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sd</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, iter <span class="op">=</span> <span class="fl">2000</span>, seed <span class="op">=</span> <span class="fl">1234</span>,</span>
<span>  backend <span class="op">=</span> <span class="st">"cmdstanr"</span>, threads <span class="op">=</span> <span class="fu">threading</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>, refresh <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  file <span class="op">=</span> <span class="st">"models/model_chocolate_brms"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The results are roughly the same as what we found with all the other models—they’re slightly off because of random MCMC sampling.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">model_parameters</span><span class="op">(</span><span class="va">model_chocolate_brms</span><span class="op">)</span></span>
<span><span class="co">## Running MCMC with 4 sequential chains, with 2 thread(s) per chain...</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Chain 1 finished in 0.1 seconds.</span></span>
<span><span class="co">## Chain 2 finished in 0.1 seconds.</span></span>
<span><span class="co">## Chain 3 finished in 0.1 seconds.</span></span>
<span><span class="co">## Chain 4 finished in 0.1 seconds.</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## All 4 chains finished successfully.</span></span>
<span><span class="co">## Mean chain execution time: 0.1 seconds.</span></span>
<span><span class="co">## Total execution time: 1.0 seconds.</span></span>
<span><span class="co">## # Fixed Effects</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Parameter   | Median |         95% CI |     pd |  Rhat |     ESS</span></span>
<span><span class="co">## ----------------------------------------------------------------</span></span>
<span><span class="co">## (Intercept) |  -3.04 | [-5.07, -1.60] |   100% | 1.000 | 3598.00</span></span>
<span><span class="co">## darkDark    |   1.35 | [-0.05,  3.16] | 96.92% | 1.000 | 4238.00</span></span>
<span><span class="co">## softSoft    |  -2.03 | [-4.35, -0.47] | 99.60% | 1.000 | 2867.00</span></span>
<span><span class="co">## nutsNuts    |   0.83 | [-0.40,  2.27] | 90.28% | 1.000 | 4648.00</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="predictions" class="level2"><h2 class="anchored" data-anchor-id="predictions">Predictions</h2>
<p>In the SAS technical note example, they use the model to generated predicted probabilities of the choice of each of the options. In the world of marketing, this can also be seen as the predicted market share for each option. To do this, they plug each of the eight different different combinations of dark, soft, and nuts into the model and calculate the predicted output on the response (i.e.&nbsp;probability) scale. They get these results, where dark, chewy, and nuts is the most likely and popular option (commanding a 50% market share).</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>      Choice of Chocolate Candies</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>Obs    Dark    Soft     Nuts       p</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  1    Dark    Chewy    Nuts       0.50400</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  2    Dark    Chewy    No Nuts    0.21600</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  3    Milk    Chewy    Nuts       0.12600</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  4    Dark    Soft     Nuts       0.05600</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  5    Milk    Chewy    No Nuts    0.05400</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  6    Dark    Soft     No Nuts    0.02400</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  7    Milk    Soft     Nuts       0.01400</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>  8    Milk    Soft     No Nuts    0.00600</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We can do the same thing with R.</p>
<section id="frequentist-predictions" class="level3"><h3 class="anchored" data-anchor-id="frequentist-predictions">Frequentist predictions</h3>
<p><del>{mlogit} model objects have predicted values stored in one of their slots (<code>model_chocolate_mlogit$probabilities</code>), but they’re in a weird non-tidy matrix form and I like working with tidy data. I’m also a huge fan of <a href="https://vincentarelbundock.github.io/marginaleffects/">the {marginaleffects} package</a>, which provides a consistent way to calculate predictions, comparisons, and slopes/marginal effects (with <code>predictions()</code>, <code>comparisons()</code>, and <code>slopes()</code>) for dozens of kinds of models, including <code>mlogit()</code> models. So instead of wrangling the built-in <code>mlogit()</code> probabilities, we’ll generate predictions by feeding the model the unique combinations of <code>dark</code>, <code>soft</code>, and <code>nuts</code> to <code>marginaleffects::predictions()</code>, which will provide us with probability- or proportion-scale predictions:</del></p>
<p>We can calculate probability-scale predictions by feeding the alternatives A–H (or the unique combinations of <code>dark</code>, <code>soft</code>, and <code>nuts</code>) to the model using <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code>. We have to first create a little dataset of the alternatives (here I filter the data to include only Subject 1), and then feed that to <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code>, which returns a named vector. To get that into a more usable data frame, we can convert the named vector into a data frame with <code>tidyr::enframe()</code> and then join it to the data frame of alternatives:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Unique combinations of dark, soft, and nuts across the 8 alternatives</span></span>
<span><span class="va">alts</span> <span class="op">&lt;-</span> <span class="va">chocolate</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">subj</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">subj</span>, <span class="op">-</span><span class="va">choice</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Named vector of predicted values</span></span>
<span><span class="va">preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">model_chocolate_mlogit</span>, newdata <span class="op">=</span> <span class="va">alts</span><span class="op">)</span></span>
<span></span>
<span><span class="va">preds_chocolate_mlogit</span> <span class="op">&lt;-</span> <span class="va">alts</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="fu">enframe</span><span class="op">(</span><span class="va">preds</span>, name <span class="op">=</span> <span class="st">"alt"</span>, value <span class="op">=</span> <span class="st">"estimate"</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">join_by</span><span class="op">(</span><span class="va">alt</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">preds_chocolate_mlogit</span></span>
<span><span class="co">## # A tibble: 8 × 5</span></span>
<span><span class="co">##   alt   dark  soft  nuts    estimate</span></span>
<span><span class="co">##   &lt;chr&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt;      &lt;dbl&gt;</span></span>
<span><span class="co">## 1 F     Dark  Chewy Nuts     0.504  </span></span>
<span><span class="co">## 2 E     Dark  Chewy No nuts  0.216  </span></span>
<span><span class="co">## 3 B     Milk  Chewy Nuts     0.126  </span></span>
<span><span class="co">## 4 H     Dark  Soft  Nuts     0.0560 </span></span>
<span><span class="co">## 5 A     Milk  Chewy No nuts  0.0540 </span></span>
<span><span class="co">## 6 G     Dark  Soft  No nuts  0.0240 </span></span>
<span><span class="co">## 7 D     Milk  Soft  Nuts     0.0140 </span></span>
<span><span class="co">## 8 C     Milk  Soft  No nuts  0.00600</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Perfect! They’re identical to the SAS output.</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
jklol they’re not perfect
</div>
</div>
<div class="callout-body-container callout-body">
<p>As far as I can tell, <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> doesn’t provide standard errors for <code>mlogit()</code>-based models, and none of the more standard helper packages like <code>marginaleffects::predictions()</code> or <code>broom::agument()</code> really do either. I guess that’s good incentive to do this with Bayesian methods instead :)</p>
</div>
</div>
<p>We can play around with these predictions to describe the overall market for candy. Chewy candies dominate the market…</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">preds_chocolate_mlogit</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">dark</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>share <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 2 × 2</span></span>
<span><span class="co">##   dark  share</span></span>
<span><span class="co">##   &lt;fct&gt; &lt;dbl&gt;</span></span>
<span><span class="co">## 1 Milk  0.200</span></span>
<span><span class="co">## 2 Dark  0.800</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>…and dark chewy candies are by far the most popular:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">preds_chocolate_mlogit</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">dark</span>, <span class="va">soft</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>share <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 4 × 3</span></span>
<span><span class="co">## # Groups:   dark [2]</span></span>
<span><span class="co">##   dark  soft   share</span></span>
<span><span class="co">##   &lt;fct&gt; &lt;fct&gt;  &lt;dbl&gt;</span></span>
<span><span class="co">## 1 Milk  Chewy 0.180 </span></span>
<span><span class="co">## 2 Milk  Soft  0.0200</span></span>
<span><span class="co">## 3 Dark  Chewy 0.720 </span></span>
<span><span class="co">## 4 Dark  Soft  0.0800</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="bayesian-predictions" class="level3"><h3 class="anchored" data-anchor-id="bayesian-predictions">Bayesian predictions</h3>
<p>{marginaleffects} supports {brms} models too, so we can use its <code>predictions()</code> function to generate predictions for our Bayesian model.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
lol subject offsets
</div>
</div>
<div class="callout-body-container callout-body">
<p>When plugging values into <code>predictions()</code> (or <code>avg_slopes()</code> or any function that calculates predictions from a model), we have to decide how to handle the random subject offsets (<span class="math inline">\(b_{0_j}\)</span>). <a href="https://www.andrewheiss.com/blog/2022/11/29/conditional-marginal-marginaleffects/#summary">I have a whole other blog post guide about this</a> and how absolutely maddening the nomenclature for all this is.</p>
<p>By default, <code>predictions()</code> and friends will calculate predictions for subjects on average by using the <code>re_formula = NULL</code> argument. This estimate includes details from the random offsets, either by integrating them out or by using the mean and standard deviation of the random offsets to generate a simulated average subject. When working with slopes, this is also called a <em>marginal effect</em>.</p>
<p>We could also use <code>re_formula = NA</code> to calculate predictions for a typical subject, or a subject where the random offset is set to 0. When working with slopes, this is also called a <em>conditional effect</em>.</p>
<ul>
<li>Conditional predictions/effect = average subject = <code>re_formula = NA</code>
</li>
<li>Marginal predictions/effect = subjects on average = <code>re_formula = NULL</code> (default), using existing subject levels or a new simulated subject</li>
</ul>
<p>Again, <a href="https://www.andrewheiss.com/blog/2022/11/29/conditional-marginal-marginaleffects">see this guide for way more about these distinctions</a>. In this example here, we’ll just use the default marginal predictions/effects (<code>re_formula = NULL</code>), or the effect for subjects on average.</p>
</div>
</div>
<p>The predicted proportions aren’t identical to the SAS output, but they’re close enough, given that it’s a completely different modeling approach.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">preds_chocolate_brms</span> <span class="op">&lt;-</span> <span class="fu">predictions</span><span class="op">(</span></span>
<span>  <span class="va">model_chocolate_brms</span>, </span>
<span>  newdata <span class="op">=</span> <span class="fu">datagrid</span><span class="op">(</span>dark <span class="op">=</span> <span class="va">unique</span>, soft <span class="op">=</span> <span class="va">unique</span>, nuts <span class="op">=</span> <span class="va">unique</span><span class="op">)</span></span>
<span><span class="op">)</span> </span>
<span></span>
<span><span class="va">preds_chocolate_brms</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">dark</span>, <span class="va">soft</span>, <span class="va">nuts</span>, <span class="va">estimate</span>, <span class="va">conf.low</span>, <span class="va">conf.high</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 8 × 6</span></span>
<span><span class="co">##   dark  soft  nuts    estimate conf.low conf.high</span></span>
<span><span class="co">##   &lt;fct&gt; &lt;fct&gt; &lt;fct&gt;      &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 Dark  Chewy Nuts     0.432   0.144       1.09  </span></span>
<span><span class="co">## 2 Dark  Chewy No nuts  0.186   0.0424      0.571 </span></span>
<span><span class="co">## 3 Milk  Chewy Nuts     0.110   0.0168      0.419 </span></span>
<span><span class="co">## 4 Dark  Soft  Nuts     0.0553  0.00519     0.279 </span></span>
<span><span class="co">## 5 Milk  Chewy No nuts  0.0465  0.00552     0.219 </span></span>
<span><span class="co">## 6 Dark  Soft  No nuts  0.0230  0.00182     0.141 </span></span>
<span><span class="co">## 7 Milk  Soft  Nuts     0.0136  0.00104     0.0881</span></span>
<span><span class="co">## 8 Milk  Soft  No nuts  0.00556 0.000326    0.0414</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="plots" class="level3"><h3 class="anchored" data-anchor-id="plots">Plots</h3>
<p>Since <code>predictions()</code> returns a tidy data frame, we can plot these predicted probabilities (or market shares or however we want to think about them) with {ggplot2}:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="va">preds_chocolate_mlogit</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>label <span class="op">=</span> <span class="fu">str_to_sentence</span><span class="op">(</span><span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"{dark} chocolate, {soft} interior, {nuts}"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>label <span class="op">=</span> <span class="fu">fct_inorder</span><span class="op">(</span><span class="va">label</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">estimate</span>, y <span class="op">=</span> <span class="va">label</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">7</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_percent</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Predicted probability of selection"</span>, y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"Frequentist {mlogit} predictions"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>panel.grid.minor <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>, panel.grid.major.y <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="va">preds_chocolate_brms</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">posterior_draws</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>  <span class="co"># Extract the posterior draws of the predictions</span></span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>label <span class="op">=</span> <span class="fu">str_to_sentence</span><span class="op">(</span><span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"{dark} chocolate, {soft} interior, {nuts}"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>label <span class="op">=</span> <span class="fu">fct_inorder</span><span class="op">(</span><span class="va">label</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">draw</span>, y <span class="op">=</span> <span class="va">label</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span>normalize <span class="op">=</span> <span class="st">"xy"</span>, fill <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">7</span><span class="op">]</span><span class="op">)</span>  <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_percent</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Predicted probability of selection"</span>, y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"Bayesian {brms} predictions"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>panel.grid.minor <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>, panel.grid.major.y <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Make the x-axis match the mlogit plot</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.05</span>, <span class="fl">0.78</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p1</span> <span class="op">/</span> <span class="va">p2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-preds-chocolate-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
</section></section><section id="amces" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="amces">AMCEs</h2>
<p>The marketing world doesn’t typically look at coefficients or marginal effects, but the political science world definitely does. In political science, the estimand we often care about the most is the average marginal component effect (AMCE), or the causal effect of moving one feature level to a different value, holding all other features constant. <a href="https://www.andrewheiss.com/blog/2023/07/25/conjoint-bayesian-frequentist-guide/">I have a whole in-depth blog post about AMCEs and how to calculate them</a>—go look at that for more details. Long story short—AMCEs are basically the coefficients in a regression model.</p>
<p>Interpreting the coefficients is difficult with models that aren’t basic linear regression. Here, all these coefficients are on the log scale, so they’re not directly interpretable. The original SAS technical note also doesn’t really interpret any of these , they don’t really interpret these things anyway, since they’re more focused on predictions. All they say is this:</p>
<blockquote class="blockquote">
<p>The parameter estimate with the smallest <em>p</em>-value is for soft center. Since the parameter estimate is negative, chewy is the more preferred level. Dark is preferred over milk, and nuts over no nuts, however only the <em>p</em>-value for Soft is less than 0.05.</p>
</blockquote>
<p>We could exponentiate the coefficients to make them multiplicative (akin to odds ratios in logistic regression). For center = soft, <span class="math inline">\(e^{-2.19722}\)</span> = 0.1111, which means that candies with a soft center are 89% less likely to be chosen than candies with a chewy center, relative to the average candy. But that’s weird to think about.</p>
<p>So instead we can turn to {marginaleffects} once again to calculate percentage-point scale estimands that we can interpret far more easily.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
lol marginal effects
</div>
</div>
<div class="callout-body-container callout-body">
<p>Nobody is ever consistent about the word “marginal effect.” Some people use it to refer to averages; some people use it to refer to slopes. These are complete opposites. In calculus, averages = integrals and slopes = derivatives and they’re the inverse of each other.</p>
<p>I like to think of marginal effects as what happens to the outcome when you move an explanatory variable a tiny bit. With continuous variables, that’s a slope; with categorical variables, that’s an offset in average outcomes. These correspond directly to how you normally interpret regression coefficients. Or returning to <a href="https://www.andrewheiss.com/blog/2022/05/20/marginalia/#regression-sliders-switches-and-mixing-boards">my favorite analogy about regression</a>, with numeric variables we care what happens to the outcome when we slide the value up a tiny bit; with categorical variables we care about what happens to the outcome when we switch on a category.</p>
<p>Additionally, there are like a billion different ways to calculate marginal effects: average marginal effects (AMEs), group-average marginal effects (G-AMEs), marginal effects at user-specified values, marginal effects at the mean (MEM), and counterfactual marginal effects. See <a href="https://vincentarelbundock.github.io/marginaleffects/articles/slopes.html">the documentation for {marginaleffects}</a> + <a href="https://www.andrewheiss.com/blog/2022/05/20/marginalia/">this mega blog post</a> for more about these subtle differences.</p>
</div>
</div>
<section id="bayesian-comparisonscontrasts" class="level3"><h3 class="anchored" data-anchor-id="bayesian-comparisonscontrasts">Bayesian comparisons/contrasts</h3>
<p>We can use <code>avg_comparisons()</code> to calculate the difference (or average marginal effect) for each of the categorical coefficients on the percentage-point scale, showing the effect of moving from milk → dark, chewy → soft, and nuts → no nuts.</p>
<p>(Technically we can also use <code>avg_slopes()</code>, even though none of these coefficients are actually slopes. {marginaleffects} is smart enough to show contrasts for categorical variables and partial derivatives/slopes for continuous variables.)</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">avg_comparisons</span><span class="op">(</span><span class="va">model_chocolate_brms</span><span class="op">)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##  Term                   Contrast Estimate    2.5 %  97.5 %</span></span>
<span><span class="co">##  dark mean(Dark) - mean(Milk)       0.139 -0.00551  0.3211</span></span>
<span><span class="co">##  nuts mean(Nuts) - mean(No nuts)    0.092 -0.05221  0.2599</span></span>
<span><span class="co">##  soft mean(Soft) - mean(Chewy)     -0.182 -0.35800 -0.0523</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Type:  response </span></span>
<span><span class="co">## Columns: term, contrast, estimate, conf.low, conf.high, predicted_lo, predicted_hi, predicted, tmp_idx</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>When holding all other features constant, moving from chewy → soft is associated with a posterior median 18 percentage point decrease in the probability of selection (or drop in market share if you want to think of it that way), on average.</p>
</section><section id="frequentist-comparisonscontrasts" class="level3"><h3 class="anchored" data-anchor-id="frequentist-comparisonscontrasts">Frequentist comparisons/contrasts</h3>
<p>We went out of order in this section and showed how to use <code>avg_comparisons()</code> with the Bayesian model first instead of the frequentist model. That’s because it was easy.</p>
<p><code>mlogit()</code> models don’t work with {marignaleffects} (or other model wrangling packages like {broom}), so there’s no good way to do it. We’re limited to calculating the contrasts of predictions by hand and manipulating and collapsing the data frame of predictions that we made previously.</p>
<p>It’s helpful to illustrate what exactly we’re looking at when collapsing these results. Remember that earlier we calculated predictions for all the unique combinations of <code>dark</code>, <code>soft</code>, and <code>nuts</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Unique combinations of dark, soft, and nuts across the 8 alternatives</span></span>
<span><span class="va">alts</span> <span class="op">&lt;-</span> <span class="va">chocolate</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">subj</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">subj</span>, <span class="op">-</span><span class="va">choice</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Named vector of predicted values</span></span>
<span><span class="va">preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">model_chocolate_mlogit</span>, newdata <span class="op">=</span> <span class="va">alts</span>, se.fit <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">preds_chocolate_mlogit</span> <span class="op">&lt;-</span> <span class="va">alts</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="fu">enframe</span><span class="op">(</span><span class="va">preds</span>, name <span class="op">=</span> <span class="st">"alt"</span>, value <span class="op">=</span> <span class="st">"estimate"</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">join_by</span><span class="op">(</span><span class="va">alt</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">preds_chocolate_mlogit</span></span>
<span><span class="co">## # A tibble: 8 × 5</span></span>
<span><span class="co">##   alt   dark  soft  nuts    estimate</span></span>
<span><span class="co">##   &lt;chr&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt;      &lt;dbl&gt;</span></span>
<span><span class="co">## 1 F     Dark  Chewy Nuts     0.504  </span></span>
<span><span class="co">## 2 E     Dark  Chewy No nuts  0.216  </span></span>
<span><span class="co">## 3 B     Milk  Chewy Nuts     0.126  </span></span>
<span><span class="co">## 4 H     Dark  Soft  Nuts     0.0560 </span></span>
<span><span class="co">## 5 A     Milk  Chewy No nuts  0.0540 </span></span>
<span><span class="co">## 6 G     Dark  Soft  No nuts  0.0240 </span></span>
<span><span class="co">## 7 D     Milk  Soft  Nuts     0.0140 </span></span>
<span><span class="co">## 8 C     Milk  Soft  No nuts  0.00600</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Four of the groups have <code>dark</code> = Milk and four have <code>dark</code> = Dark, with other varying characteristics across those groups (chewy/soft, nuts/no nuts). If we want the average proportion of all milk and dark chocolate options, we can group and summarize:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">preds_dark</span> <span class="op">&lt;-</span> <span class="va">preds_chocolate_mlogit</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">dark</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>avg_pred <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">preds_dark</span></span>
<span><span class="co">## # A tibble: 2 × 2</span></span>
<span><span class="co">##   dark  avg_pred</span></span>
<span><span class="co">##   &lt;fct&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">## 1 Milk    0.0500</span></span>
<span><span class="co">## 2 Dark    0.200</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The average market share for milk chocolate candies, holding all other features constant, is 5% (<span class="math inline">\(\frac{0.0540 + 0.126 + 0.006 + 0.014}{2} = 0.05\)</span>); the average market share for dark chocolate candies is 20% (<span class="math inline">\(\frac{0.216 + 0.504 + 0.024 + 0.056}{2} = 0.2\)</span>). These values are the averages of the predictions from the four groups where <code>dark</code> is either Milk or Dark.</p>
<p>If we find the difference between the two predictions, we’ll see the average causal effect of moving from dark → milk—holding all other features constant, switching the chocolate type from dark to milk causes a 15 percentage point decrease in the probability of selecting the candy, on average.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Using diff() (reversing it so that it does Milk - Dark)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rev.html">rev</a></span><span class="op">(</span><span class="va">preds_dark</span><span class="op">$</span><span class="va">avg_pred</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## [1] -0.15</span></span>
<span></span>
<span><span class="co"># Tidyverse way</span></span>
<span><span class="va">preds_dark</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">dark</span>, values_from <span class="op">=</span> <span class="va">avg_pred</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    term <span class="op">=</span> <span class="st">"Milk - Dark"</span>,</span>
<span>    estimate <span class="op">=</span> <span class="va">Milk</span> <span class="op">-</span> <span class="va">Dark</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">term</span>, <span class="va">estimate</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 1 × 2</span></span>
<span><span class="co">##   term        estimate</span></span>
<span><span class="co">##   &lt;chr&gt;          &lt;dbl&gt;</span></span>
<span><span class="co">## 1 Milk - Dark   -0.150</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can use this same approach to make a big data frame of all the contrasts:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">amces_chocolate_mlogit</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span></span>
<span>  dark <span class="op">=</span> <span class="va">preds_chocolate_mlogit</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">dark</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">summarize</span><span class="op">(</span>avg_pred <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">dark</span>, values_from <span class="op">=</span> <span class="va">avg_pred</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">mutate</span><span class="op">(</span></span>
<span>      term <span class="op">=</span> <span class="st">"Dark - Milk"</span>,</span>
<span>      estimate <span class="op">=</span> <span class="va">Dark</span> <span class="op">-</span> <span class="va">Milk</span></span>
<span>    <span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">select</span><span class="op">(</span><span class="va">term</span>, <span class="va">estimate</span><span class="op">)</span>,</span>
<span>  soft <span class="op">=</span> <span class="va">preds_chocolate_mlogit</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">soft</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">summarize</span><span class="op">(</span>avg_pred <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">soft</span>, values_from <span class="op">=</span> <span class="va">avg_pred</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">mutate</span><span class="op">(</span></span>
<span>      term <span class="op">=</span> <span class="st">"Soft - Chewy"</span>,</span>
<span>      estimate <span class="op">=</span> <span class="va">Soft</span> <span class="op">-</span> <span class="va">Chewy</span></span>
<span>    <span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">select</span><span class="op">(</span><span class="va">term</span>, <span class="va">estimate</span><span class="op">)</span>,</span>
<span>  nuts <span class="op">=</span> <span class="va">preds_chocolate_mlogit</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">nuts</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">summarize</span><span class="op">(</span>avg_pred <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">nuts</span>, values_from <span class="op">=</span> <span class="va">avg_pred</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">mutate</span><span class="op">(</span></span>
<span>      term <span class="op">=</span> <span class="st">"Nuts - No nuts"</span>,</span>
<span>      estimate <span class="op">=</span> <span class="va">Nuts</span> <span class="op">-</span> <span class="va">`No nuts`</span></span>
<span>    <span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">select</span><span class="op">(</span><span class="va">term</span>, <span class="va">estimate</span><span class="op">)</span>,</span>
<span>  .id <span class="op">=</span> <span class="st">"variable"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">amces_chocolate_mlogit</span></span>
<span><span class="co">## # A tibble: 3 × 3</span></span>
<span><span class="co">##   variable term           estimate</span></span>
<span><span class="co">##   &lt;chr&gt;    &lt;chr&gt;             &lt;dbl&gt;</span></span>
<span><span class="co">## 1 dark     Dark - Milk       0.150</span></span>
<span><span class="co">## 2 soft     Soft - Chewy     -0.200</span></span>
<span><span class="co">## 3 nuts     Nuts - No nuts    0.1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For instance, what’s the causal effect of moving from milk → dark chocolate?</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Unique combinations of dark, soft, and nuts across the 8 alternatives</span></span>
<span><span class="va">alts</span> <span class="op">&lt;-</span> <span class="va">chocolate</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">subj</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">subj</span>, <span class="op">-</span><span class="va">choice</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Named vector of predicted values</span></span>
<span><span class="va">preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">model_chocolate_mlogit</span>, newdata <span class="op">=</span> <span class="va">alts</span>, se.fit <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">preds_chocolate_mlogit</span> <span class="op">&lt;-</span> <span class="va">alts</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="fu">enframe</span><span class="op">(</span><span class="va">preds</span>, name <span class="op">=</span> <span class="st">"alt"</span>, value <span class="op">=</span> <span class="st">"estimate"</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">join_by</span><span class="op">(</span><span class="va">alt</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">preds_chocolate_mlogit</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">dark</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>estimate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 2 × 2</span></span>
<span><span class="co">##   dark  estimate</span></span>
<span><span class="co">##   &lt;fct&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">## 1 Milk    0.0500</span></span>
<span><span class="co">## 2 Dark    0.200</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="plots-1" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="plots-1">Plots</h3>
<p>Plotting these AMCEs requires a bit of data wrangling, but we get really neat plots, so it’s worth it. I’ve hidden all the code here for the sake of space.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Extract variable labels</summary><div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">chocolate_var_levels</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span></span>
<span>  variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"dark"</span>, <span class="st">"soft"</span>, <span class="st">"nuts"</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>levels <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">variable</span>, <span class="op">~</span><span class="op">{</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">chocolate</span><span class="op">[[</span><span class="va">.x</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">is.numeric</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="st">""</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">is.factor</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">unnest</span><span class="op">(</span><span class="va">levels</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>term <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">variable</span>, <span class="va">levels</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Make a little lookup table for nicer feature labels</span></span>
<span><span class="va">chocolate_var_lookup</span> <span class="op">&lt;-</span> <span class="fu">tribble</span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">variable</span>, <span class="op">~</span><span class="va">variable_nice</span>,</span>
<span>  <span class="st">"dark"</span>,    <span class="st">"Type of chocolate"</span>,</span>
<span>  <span class="st">"soft"</span>,    <span class="st">"Type of center"</span>,</span>
<span>  <span class="st">"nuts"</span>,    <span class="st">"Nuts"</span></span>
<span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>variable_nice <span class="op">=</span> <span class="fu">fct_inorder</span><span class="op">(</span><span class="va">variable_nice</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Combine full dataset of factor levels with model comparisons and make {mlogit} plot</summary><div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">amces_chocolate_mlogit_split</span> <span class="op">&lt;-</span> <span class="va">amces_chocolate_mlogit</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">separate_wider_delim</span><span class="op">(</span></span>
<span>    <span class="va">term</span>,</span>
<span>    delim <span class="op">=</span> <span class="st">" - "</span>, </span>
<span>    names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"variable_level"</span>, <span class="st">"reference_level"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">rename</span><span class="op">(</span>term <span class="op">=</span> <span class="va">variable</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_data</span> <span class="op">&lt;-</span> <span class="va">chocolate_var_levels</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span></span>
<span>    <span class="va">amces_chocolate_mlogit_split</span>,</span>
<span>    by <span class="op">=</span> <span class="fu">join_by</span><span class="op">(</span><span class="va">variable</span> <span class="op">==</span> <span class="va">term</span>, <span class="va">levels</span> <span class="op">==</span> <span class="va">variable_level</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Make these zero</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    <span class="fu">across</span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span>,</span>
<span>      <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span>, <span class="fl">0</span>, <span class="va">.x</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">chocolate_var_lookup</span>, by <span class="op">=</span> <span class="fu">join_by</span><span class="op">(</span><span class="va">variable</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">levels</span>, <span class="va">variable_nice</span><span class="op">)</span>, <span class="op">~</span><span class="fu">fct_inorder</span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span></span>
<span>  <span class="va">plot_data</span>,</span>
<span>  <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">estimate</span>, y <span class="op">=</span> <span class="va">levels</span>, color <span class="op">=</span> <span class="va">variable_nice</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="va">label_pp</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">8</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Percentage point change in\nprobability of candy selection"</span>,</span>
<span>    y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"Frequentist AMCEs from {mlogit}"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_col</span><span class="op">(</span>facets <span class="op">=</span> <span class="st">"variable_nice"</span>, scales <span class="op">=</span> <span class="st">"free_y"</span>, space <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Combine full dataset of factor levels with posterior draws and make {brms} plot</summary><div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># This is much easier than the mlogit mess because we can use avg_comparisons() directly</span></span>
<span><span class="va">posterior_mfx</span> <span class="op">&lt;-</span> <span class="va">model_chocolate_brms</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">avg_comparisons</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">posteriordraws</span><span class="op">(</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">posterior_mfx_nested</span> <span class="op">&lt;-</span> <span class="va">posterior_mfx</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">separate_wider_delim</span><span class="op">(</span></span>
<span>    <span class="va">contrast</span>,</span>
<span>    delim <span class="op">=</span> <span class="st">" - "</span>, </span>
<span>    names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"variable_level"</span>, <span class="st">"reference_level"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># At some point marginaleffects() started adding "mean(Blah)" instead of</span></span>
<span>  <span class="co"># "Blah" in the contrast column for avg_comparisons(), so this removes the</span></span>
<span>  <span class="co"># function name and parentheses</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>variable_level <span class="op">=</span> <span class="fu">str_replace_all</span><span class="op">(</span><span class="va">variable_level</span>, <span class="st">".*\\(([^)]+)\\).*"</span>, <span class="st">"\\1"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">term</span>, <span class="va">variable_level</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">nest</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Combine full dataset of factor levels with model results</span></span>
<span><span class="va">plot_data_bayes</span> <span class="op">&lt;-</span> <span class="va">chocolate_var_levels</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span></span>
<span>    <span class="va">posterior_mfx_nested</span>,</span>
<span>    by <span class="op">=</span> <span class="fu">join_by</span><span class="op">(</span><span class="va">variable</span> <span class="op">==</span> <span class="va">term</span>, <span class="va">levels</span> <span class="op">==</span> <span class="va">variable_level</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>data <span class="op">=</span> <span class="fu">map_if</span><span class="op">(</span><span class="va">data</span>, <span class="va">is.null</span>, <span class="op">~</span> <span class="fu">tibble</span><span class="op">(</span>draw <span class="op">=</span> <span class="fl">0</span>, estimate <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">unnest</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">chocolate_var_lookup</span>, by <span class="op">=</span> <span class="fu">join_by</span><span class="op">(</span><span class="va">variable</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">levels</span>, <span class="va">variable_nice</span><span class="op">)</span>, <span class="op">~</span><span class="fu">fct_inorder</span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">plot_data_bayes</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">draw</span>, y <span class="op">=</span> <span class="va">levels</span>, fill <span class="op">=</span> <span class="va">variable_nice</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span>normalize <span class="op">=</span> <span class="st">"groups"</span><span class="op">)</span> <span class="op">+</span>  <span class="co"># Make the heights of the distributions equal within each facet</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_col</span><span class="op">(</span>facets <span class="op">=</span> <span class="st">"variable_nice"</span>, scales <span class="op">=</span> <span class="st">"free_y"</span>, space <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="va">label_pp</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">8</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Percentage point change in\nprobability of candy selection"</span>,</span>
<span>    y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"Posterior Bayesian AMCEs from {brms}"</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">p1</span> <span class="op">|</span> <span class="va">p2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/plot-amces-chocolate-both-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-body-outset" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>&nbsp;</p>
</section></section></section><section id="part-2-minivans-repeated-questions-basic-multinomial-logit" class="level1 page-columns page-full"><h1>Part 2: Minivans; repeated questions; basic multinomial logit</h1>
<section id="the-setup-1" class="level2"><h2 class="anchored" data-anchor-id="the-setup-1">The setup</h2>
<p>In this experiment, respondents are asked to choose which of these minivans they’d want to buy, based on four different features/attributes with different levels:</p>
<table class="caption-top table">
<thead><tr class="header">
<th style="text-align: left;">Features/Attributes</th>
<th style="text-align: left;">Levels</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Passengers</td>
<td style="text-align: left;">6, 7, 8</td>
</tr>
<tr class="even">
<td style="text-align: left;">Cargo area</td>
<td style="text-align: left;">2 feet, 3 feet</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Engine</td>
<td style="text-align: left;">Gas, electric, hybrid</td>
</tr>
<tr class="even">
<td style="text-align: left;">Price</td>
<td style="text-align: left;">$30,000; $35,000; $40,000</td>
</tr>
</tbody>
</table>
<p>Respondents see this a question similar to this fifteen different times, with three options with randomly shuffled levels for each of the features.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Example survey question
</div>
</div>
<div class="callout-body-container callout-body">
<table class="caption-top table">
<colgroup>
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
</colgroup>
<thead><tr class="header">
<th></th>
<th style="text-align: center;">Option 1</th>
<th style="text-align: center;">Option 2</th>
<th style="text-align: center;">Option 3</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Passengers</td>
<td style="text-align: center;">7</td>
<td style="text-align: center;">8</td>
<td style="text-align: center;">6</td>
</tr>
<tr class="even">
<td>Cargo area</td>
<td style="text-align: center;">3 feet</td>
<td style="text-align: center;">3 feet</td>
<td style="text-align: center;">2 feet</td>
</tr>
<tr class="odd">
<td>Engine</td>
<td style="text-align: center;">Electric</td>
<td style="text-align: center;">Gas</td>
<td style="text-align: center;">Hybrid</td>
</tr>
<tr class="even">
<td>Price</td>
<td style="text-align: center;">$40,000</td>
<td style="text-align: center;">$40,000</td>
<td style="text-align: center;">$30,000</td>
</tr>
<tr class="odd">
<td>Choice</td>
<td style="text-align: center;"><input type="radio" name="ex2"></td>
<td style="text-align: center;"><input type="radio" name="ex2"></td>
<td style="text-align: center;"><input type="radio" name="ex2"></td>
</tr>
</tbody>
</table>
</div>
</div>
</section><section id="the-data-1" class="level2"><h2 class="anchored" data-anchor-id="the-data-1">The data</h2>
<p>The data for this kind of experiment has one row for each possible alternative (<code>alt</code>) within each set of 15 questions (<code>ques</code>), thus creating 3 × 15 = 45 rows per respondent (<code>resp.id</code>). There were 200 respondents, with 45 rows each, so there are 200 × 45 = 9,000 rows. Here, Respondent 1 chose a $30,000 gas van with 6 seats and 3 feet of cargo space in the first set of three options, a $35,000 gas van with 7 seats and 3 feet of cargo space in the second set of three options, and so on.</p>
<p>There’s also a column here for <code>carpool</code> indicating if the respondent carpools with others when commuting. It’s an individual respondent-level characteristic and is constant throughout all the questions and alternatives, and we’ll use it later.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">minivans</span></span>
<span><span class="co">## # A tibble: 9,000 × 9</span></span>
<span><span class="co">##    resp.id  ques   alt carpool seat  cargo eng   price choice</span></span>
<span><span class="co">##      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;fct&gt;   &lt;fct&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt;  &lt;dbl&gt;</span></span>
<span><span class="co">##  1       1     1     1 yes     6     2ft   gas   35         0</span></span>
<span><span class="co">##  2       1     1     2 yes     8     3ft   hyb   30         0</span></span>
<span><span class="co">##  3       1     1     3 yes     6     3ft   gas   30         1</span></span>
<span><span class="co">##  4       1     2     1 yes     6     2ft   gas   30         0</span></span>
<span><span class="co">##  5       1     2     2 yes     7     3ft   gas   35         1</span></span>
<span><span class="co">##  6       1     2     3 yes     6     2ft   elec  35         0</span></span>
<span><span class="co">##  7       1     3     1 yes     8     3ft   gas   35         1</span></span>
<span><span class="co">##  8       1     3     2 yes     7     3ft   elec  30         0</span></span>
<span><span class="co">##  9       1     3     3 yes     8     2ft   elec  40         0</span></span>
<span><span class="co">## 10       1     4     1 yes     7     3ft   elec  40         1</span></span>
<span><span class="co">## # ℹ 8,990 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="the-model-1" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="the-model-1">The model</h2>
<p>Respondents were shown three different options and asked to select one. We thus have three possible outcomes: a respondent could have selected option 1, option 2, or option 3. Because everything was randomized, there shouldn’t be any patterns in which options people choose—we don’t want to see that the first column is more common, since that would indicate that respondents are just repeatedly selecting the first column to get through the survey. Since there are three possible outcomes (option 1, 2, and 3), we’ll use multinomial logistic regression.</p>
<section id="original-model-as-a-baseline" class="level3"><h3 class="anchored" data-anchor-id="original-model-as-a-baseline">Original model as a baseline</h3>
<p>In the example in their textbook, <span class="citation" data-cites="ChapmanFeit:2019">Chapman and Feit (<a href="#ref-ChapmanFeit:2019" role="doc-biblioref">2019</a>)</span> use {mlogit} to estimate this model and they find these results. This will be our baseline throughout this example.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="img/chapman-feit-mlogit.png" class="img-fluid figure-img"></p>
<figcaption>Original results from <span class="citation" data-cites="ChapmanFeit:2019">Chapman and Feit (<a href="#ref-ChapmanFeit:2019" role="doc-biblioref">2019</a>)</span> p.&nbsp;371</figcaption></figure>
</div>
</section><section id="mlogit-model-1" class="level3"><h3 class="anchored" data-anchor-id="mlogit-model-1">
<code>mlogit</code> model</h3>
<p>This data is a little more complex now, since there are alternatives nested inside questions inside respondents. To account for this panel structure when using {mlogit}, we need to define two index columns: one for the unique set of alternatives offered to the respondent and one for the respondent ID. We still do this with <code>dfidx()</code>, but need to create a new column with an ID number for each unique combination of respondent ID and question number:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">minivans_idx</span> <span class="op">&lt;-</span> <span class="va">minivans</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># mlogit() needs a column with unique question id numbers</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">resp.id</span>, <span class="va">ques</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>choice.id <span class="op">=</span> <span class="fu">cur_group_id</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Make indexed data frame for mlogit</span></span>
<span>  <span class="fu">dfidx</span><span class="op">(</span></span>
<span>    idx <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"choice.id"</span>, <span class="st">"resp.id"</span><span class="op">)</span>, <span class="st">"alt"</span><span class="op">)</span>,</span>
<span>    choice <span class="op">=</span> <span class="st">"choice"</span>,</span>
<span>    shape <span class="op">=</span> <span class="st">"long"</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can fit the model. Note the <code>0 ~ seat</code> syntax here. That suppresses the intercept for the model, which behaves weirdly with multinomial models. Since there are three categories for the outcome (options 1, 2, and 3), there are two intercepts, representing cutpoints-from-ordered-logit-esque shifts in the probability of selecting option 1 vs.&nbsp;option 2 and option 2 vs.&nbsp;option 3. We don’t want to deal with those, so we’ll suppress them.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_minivans_mlogit</span> <span class="op">&lt;-</span> <span class="fu">mlogit</span><span class="op">(</span></span>
<span>  <span class="va">choice</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">seat</span> <span class="op">+</span> <span class="va">cargo</span> <span class="op">+</span> <span class="va">eng</span> <span class="op">+</span> <span class="va">price</span> <span class="op">|</span> <span class="fl">0</span> <span class="op">|</span> <span class="fl">0</span>, </span>
<span>  data <span class="op">=</span> <span class="va">minivans_idx</span></span>
<span><span class="op">)</span></span>
<span><span class="fu">model_parameters</span><span class="op">(</span><span class="va">model_minivans_mlogit</span>, digits <span class="op">=</span> <span class="fl">4</span>, p_digits <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="co">## Parameter   | Log-Odds |     SE |             95% CI |        z |           p</span></span>
<span><span class="co">## -----------------------------------------------------------------------------</span></span>
<span><span class="co">## seat [7]    |  -0.5353 | 0.0624 | [-0.6575, -0.4131] |  -8.5837 | 9.1863e-18 </span></span>
<span><span class="co">## seat [8]    |  -0.3058 | 0.0611 | [-0.4256, -0.1860] |  -5.0032 | 5.6376e-07 </span></span>
<span><span class="co">## cargo [3ft] |   0.4774 | 0.0509 | [ 0.3777,  0.5772] |   9.3824 | 6.4514e-21 </span></span>
<span><span class="co">## eng [hyb]   |  -0.8113 | 0.0601 | [-0.9291, -0.6934] | -13.4921 | 1.7408e-41 </span></span>
<span><span class="co">## eng [elec]  |  -1.5308 | 0.0675 | [-1.6630, -1.3985] | -22.6926 | 5.3004e-114</span></span>
<span><span class="co">## price [35]  |  -0.9137 | 0.0606 | [-1.0324, -0.7949] | -15.0765 | 2.3123e-51 </span></span>
<span><span class="co">## price [40]  |  -1.7259 | 0.0696 | [-1.8623, -1.5894] | -24.7856 | 1.2829e-135</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>These are the same results from p.&nbsp;371 in <span class="citation" data-cites="ChapmanFeit:2019">Chapman and Feit (<a href="#ref-ChapmanFeit:2019" role="doc-biblioref">2019</a>)</span>, so it worked. Again, the marketing world doesn’t typically do much with these coefficients beyond looking at their direction and magnitude. For instance, in <span class="citation" data-cites="ChapmanFeit:2019">Chapman and Feit (<a href="#ref-ChapmanFeit:2019" role="doc-biblioref">2019</a>)</span> they say that the estimate for <code>seat [7]</code> here is negative, which means that a 7-seat option is less preferred than 6-seat option, and that the estimate for <code>price [40]</code> is more negative than the already-negative estimate for <code>price [35]</code>, which means that (1) respondents don’t like the $35,000 option compared to the baseline $30,000 and that (2) respondents <em>really</em> don’t like the $40,000 option. We could theoretically exponentiate these things—like, seeing 7 seats makes it <span class="math inline">\(e^{-0.5353}\)</span> = 0.5855 = 41% less likely to select the option compared to 6 seats—but again, that’s weird.</p>
</section><section id="mclogit-model-1" class="level3"><h3 class="anchored" data-anchor-id="mclogit-model-1">
<code>mclogit</code> model</h3>
<p><a href="#mclogit-note">As noted earlier</a>, {marginaleffects} doesn’t support <code>mlogit()</code> because of its weird internal structure. It <em>does</em> support <code>mclogit::mclogit()</code> though.</p>
<p>The syntax requires two parts on the left-hand side of the formula: (1) the choice selected (0 or 1), and (2) a unique id for set of choices, or the question. Like with <code>mlogit()</code>, we can create a <code>choice.id</code> column identifying the unique question numbers, and then use that in the formula.</p>
<p>The results are the same:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://mclogit.elff.eu">mclogit</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">minivans_mclogit</span> <span class="op">&lt;-</span> <span class="va">minivans</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># mclogit() needs a column with unique question id numbers</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">resp.id</span>, <span class="va">ques</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>choice.id <span class="op">=</span> <span class="fu">cur_group_id</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_minivans_mclogit</span> <span class="op">&lt;-</span> <span class="fu">mclogit</span><span class="op">(</span></span>
<span>  <span class="va">choice</span> <span class="op">|</span> <span class="va">choice.id</span> <span class="op">~</span> <span class="va">seat</span> <span class="op">+</span> <span class="va">cargo</span> <span class="op">+</span> <span class="va">eng</span> <span class="op">+</span> <span class="va">price</span>,</span>
<span>  data <span class="op">=</span> <span class="va">minivans_mclogit</span></span>
<span><span class="op">)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Iteration 1 - deviance = 5176 - criterion = 0.4078</span></span>
<span><span class="co">## Iteration 2 - deviance = 5163 - criterion = 0.00242</span></span>
<span><span class="co">## Iteration 3 - deviance = 5163 - criterion = 7.874e-06</span></span>
<span><span class="co">## Iteration 4 - deviance = 5163 - criterion = 1.033e-10</span></span>
<span><span class="co">## converged</span></span>
<span></span>
<span><span class="fu">model_parameters</span><span class="op">(</span><span class="va">model_minivans_mclogit</span>, digits <span class="op">=</span> <span class="fl">4</span>, p_digits <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="co">## Parameter   | Log-Odds |     SE |             95% CI |        z |           p</span></span>
<span><span class="co">## -----------------------------------------------------------------------------</span></span>
<span><span class="co">## seat [7]    |  -0.5353 | 0.0624 | [-0.6575, -0.4131] |  -8.5837 | 9.1863e-18 </span></span>
<span><span class="co">## seat [8]    |  -0.3058 | 0.0611 | [-0.4256, -0.1860] |  -5.0032 | 5.6376e-07 </span></span>
<span><span class="co">## cargo [3ft] |   0.4774 | 0.0509 | [ 0.3777,  0.5772] |   9.3824 | 6.4514e-21 </span></span>
<span><span class="co">## eng [hyb]   |  -0.8113 | 0.0601 | [-0.9291, -0.6934] | -13.4921 | 1.7408e-41 </span></span>
<span><span class="co">## eng [elec]  |  -1.5308 | 0.0675 | [-1.6630, -1.3985] | -22.6926 | 5.3003e-114</span></span>
<span><span class="co">## price [35]  |  -0.9137 | 0.0606 | [-1.0324, -0.7949] | -15.0765 | 2.3123e-51 </span></span>
<span><span class="co">## price [40]  |  -1.7259 | 0.0696 | [-1.8623, -1.5894] | -24.7856 | 1.2828e-135</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Uncertainty intervals (equal-tailed) and p-values (two-tailed) computed using a Wald z-distribution approximation.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="bayesian-model-with-brms" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="bayesian-model-with-brms">Bayesian model with {brms}</h3>
<p>We can also fit this multinomial model in a Bayesian way using {brms}. Stan has a categorical family for dealing with mulitnomial/categorical outcomes. But first, we’ll look at the nested structure of this data and incorporate that into the model, since we won’t be using the weird {mlogit}-style indexed data frame. As with the chocolate experiment, the data has a natural hierarchy in it, with three questions nested inside 15 separate question sets, nested inside each of the 200 respondents.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/minivan-multilevel-structure-1.svg" class="img-fluid figure-img column-page" style="width:100.0%"></p>
<figcaption>Multilevel experimental structure, with minivan choices <span class="math inline">\(\{y_1, y_2, y_3\}\)</span> nested in sets of questions in respondents</figcaption></figure>
</div>
</div>
</div>
<p>Currently, our main outcome variable <code>choice</code> is binary. If we run the model with <code>choice</code> as the outcome with a categorical family, the model will fit, but it will go slow and {brms} will complain about it and recommend switching to regular logistic regression. The categorical family in Stan requires 2+ outcomes and a reference category. Here we have three possible options (1, 2, and 3), and we can imagine a reference category of 0 for rows that weren’t selected.</p>
<p>We can create a new outcome column (<code>choice_alt</code>) that indicates which option each respondent selected: 0 if they didn’t choose the option and 1–3 if they chose the first, second, or third option. Because of how the data is recorded, this only requires multiplying <code>alt</code> and <code>choice</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">minivans_choice_alt</span> <span class="op">&lt;-</span> <span class="va">minivans</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>choice_alt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">alt</span> <span class="op">*</span> <span class="va">choice</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">minivans_choice_alt</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">resp.id</span>, <span class="va">ques</span>, <span class="va">alt</span>, <span class="va">seat</span>, <span class="va">cargo</span>, <span class="va">eng</span>, <span class="va">price</span>, <span class="va">choice</span>, <span class="va">choice_alt</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 9,000 × 9</span></span>
<span><span class="co">##    resp.id  ques   alt seat  cargo eng   price choice choice_alt</span></span>
<span><span class="co">##      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt;  &lt;dbl&gt; &lt;fct&gt;     </span></span>
<span><span class="co">##  1       1     1     1 6     2ft   gas   35         0 0         </span></span>
<span><span class="co">##  2       1     1     2 8     3ft   hyb   30         0 0         </span></span>
<span><span class="co">##  3       1     1     3 6     3ft   gas   30         1 3         </span></span>
<span><span class="co">##  4       1     2     1 6     2ft   gas   30         0 0         </span></span>
<span><span class="co">##  5       1     2     2 7     3ft   gas   35         1 2         </span></span>
<span><span class="co">##  6       1     2     3 6     2ft   elec  35         0 0         </span></span>
<span><span class="co">##  7       1     3     1 8     3ft   gas   35         1 1         </span></span>
<span><span class="co">##  8       1     3     2 7     3ft   elec  30         0 0         </span></span>
<span><span class="co">##  9       1     3     3 8     2ft   elec  40         0 0         </span></span>
<span><span class="co">## 10       1     4     1 7     3ft   elec  40         1 1         </span></span>
<span><span class="co">## # ℹ 8,990 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now use the new four-category <code>choice_alt</code> column as our outcome with the <code>categorical()</code> family.</p>
<p>If we <em>realllly</em> wanted, we could add random effects for question sets nested inside respondents, like <code>(1 | resp.id / ques)</code>. We’d want to do that if there were set-specific things that could influences choices. Like maybe we want to account for the possibility that everyone’s just choosing the first option, so it behaves differently? Or maybe the 5th set of questions is set to an extra difficult level on a quiz or something? Or maybe we have so many sets that we think the later ones will be less accurate because of respondent fatigue? idk. In this case, question set-specific effects don’t matter at all. Each question set is equally randomized and no different from the others, so we won’t bother modeling that layer of the hierarchy.</p>
<p>We want to model the choice of option 1, 2, or 3 (<code>choice_alt</code>) based on minivan characteristics (<code>seat</code>, <code>cargo</code>, <code>eng</code>, price). With the categorical model, we actually get a set of parameters to estimate the probability of selecting each of the options, which Stan calls <span class="math inline">\(\mu\)</span>, so we have a set of three probabilities: <span class="math inline">\(\{\mu_1, \mu_2, \mu_3\}\)</span>. We’ll use the subscript <span class="math inline">\(i\)</span> to refer to individual minivan choices and <span class="math inline">\(j\)</span> to refer to respondents. Here’s the fun formal model:</p>
<p><span class="math display">\[
\begin{aligned}
&amp;\ \textbf{Multinomial probability of selection of choice}_i \textbf{ in respondent}_j \\
\text{Choice}_{i_j} \sim&amp;\ \operatorname{Categorical}(\{\mu_{1,i_j}, \mu_{2,i_j}, \mu_{3,i_j}\}) \\[10pt]
&amp;\ \textbf{Model for probability of each option} \\
\{\mu_{1,i_j}, \mu_{2,i_j}, \mu_{3,i_j}\} =&amp;\ (\beta_0 + b_{0_j}) + \beta_1 \text{Seat[7]}_{i_j} + \beta_2 \text{Seat[8]}_{i_j} + \beta_3 \text{Cargo[3ft]}_{i_j} + \\
&amp;\ \beta_4 \text{Engine[hyb]}_{i_j} + \beta_5 \text{Engine[elec]}_{i_j} + \beta_6 \text{Price[35k]}_{i_j} + \beta_7 \text{Price[40k]}_{i_j} \\[5pt]
b_{0_j} \sim&amp;\ \mathcal{N}(0, \sigma_0) \qquad\quad\quad \text{Respondent-specific offsets from global probability} \\[10pt]
&amp;\ \textbf{Priors} \\
\beta_{0 \dots 7} \sim&amp;\ \mathcal{N} (0, 3) \qquad\qquad\ \ \text{Prior for choice-level coefficients} \\
\sigma_0 \sim&amp;\ \operatorname{Exponential}(1) \quad \text{Prior for between-respondent variability}
\end{aligned}
\]</span></p>
<p>And here’s the {brms} model. Notice the much-more-verbose prior section—because the categorical family in Stan estimates separate parameters for each of the categories (<span class="math inline">\(\{\mu_1, \mu_2, \mu_3\}\)</span>), we have a mean and standard deviation for the probability of selecting each of those options. We need to specify each of these separately too instead of just doing something like <code>prior(normal(0, 3), class = b)</code>. Also notice the <code>refcat</code> argument in <code>categorical()</code>—this makes it so that all the estimates are relative to not choosing an option (or when <code>choice_alt</code> is 0). And <em>also</em> notice the slightly different syntax for the random respondent intercepts: <code>(1 | ID | resp.id)</code>. That new middle <code>ID</code> is special {brms} formula syntax that we can use when working with categorical or ordinal families, and it makes it so that the group-level effects for the different outcomes (here options 0, 1, 2, and 3) are correlated (see p.&nbsp;4 of <a href="https://cran.r-project.org/web/packages/brms/vignettes/brms_multilevel.pdf">this {brms} vignette</a> for more about this special syntax).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_minivans_categorical_brms</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span></span>
<span>  <span class="fu">bf</span><span class="op">(</span><span class="va">choice_alt</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">seat</span> <span class="op">+</span> <span class="va">cargo</span> <span class="op">+</span> <span class="va">eng</span> <span class="op">+</span> <span class="va">price</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">ID</span> <span class="op">|</span> <span class="va">resp.id</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">minivans_choice_alt</span>,</span>
<span>  family <span class="op">=</span> <span class="fu">categorical</span><span class="op">(</span>refcat <span class="op">=</span> <span class="st">"0"</span><span class="op">)</span>,</span>
<span>  prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="fu">prior</span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, dpar <span class="op">=</span> <span class="va">mu1</span><span class="op">)</span>,</span>
<span>    <span class="fu">prior</span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, dpar <span class="op">=</span> <span class="va">mu2</span><span class="op">)</span>,</span>
<span>    <span class="fu">prior</span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, dpar <span class="op">=</span> <span class="va">mu3</span><span class="op">)</span>,</span>
<span>    <span class="fu">prior</span><span class="op">(</span><span class="fu">exponential</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sd</span>, dpar <span class="op">=</span> <span class="va">mu1</span><span class="op">)</span>,</span>
<span>    <span class="fu">prior</span><span class="op">(</span><span class="fu">exponential</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sd</span>, dpar <span class="op">=</span> <span class="va">mu2</span><span class="op">)</span>,</span>
<span>    <span class="fu">prior</span><span class="op">(</span><span class="fu">exponential</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sd</span>, dpar <span class="op">=</span> <span class="va">mu3</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, iter <span class="op">=</span> <span class="fl">2000</span>, seed <span class="op">=</span> <span class="fl">1234</span>,</span>
<span>  backend <span class="op">=</span> <span class="st">"cmdstanr"</span>, threads <span class="op">=</span> <span class="fu">threading</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>, refresh <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  file <span class="op">=</span> <span class="st">"models/model_minivans_categorical_brms"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This model gives us a ton of parameters! We get three estimates per feature level (i.e.&nbsp;<code>mu1_cargo3ft</code>, <code>mu2_cargo3ft</code>, and <code>mu3_cargo3ft</code> for the <code>cargo3ft</code> effect), since we’re actually estimating the effect of each covariate on the probability of selecting each of the three options.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">model_parameters</span><span class="op">(</span><span class="va">model_minivans_categorical_brms</span><span class="op">)</span></span>
<span><span class="co">## Parameter    | Median |         95% CI |     pd |  Rhat |     ESS</span></span>
<span><span class="co">## -----------------------------------------------------------------</span></span>
<span><span class="co">## mu1_seat6    |  -0.34 | [-0.52, -0.16] | 99.95% | 1.001 | 2673.00</span></span>
<span><span class="co">## mu1_seat7    |  -0.86 | [-1.04, -0.67] |   100% | 1.000 | 3167.00</span></span>
<span><span class="co">## mu1_seat8    |  -0.59 | [-0.77, -0.41] |   100% | 1.000 | 3373.00</span></span>
<span><span class="co">## mu1_cargo3ft |   0.46 | [ 0.32,  0.60] |   100% | 1.000 | 6314.00</span></span>
<span><span class="co">## mu1_enghyb   |  -0.76 | [-0.92, -0.60] |   100% | 1.001 | 4628.00</span></span>
<span><span class="co">## mu1_engelec  |  -1.51 | [-1.69, -1.33] |   100% | 0.999 | 4913.00</span></span>
<span><span class="co">## mu1_price35  |  -0.82 | [-0.99, -0.67] |   100% | 0.999 | 4574.00</span></span>
<span><span class="co">## mu1_price40  |  -1.74 | [-1.94, -1.56] |   100% | 1.000 | 4637.00</span></span>
<span><span class="co">## mu2_seat6    |  -0.39 | [-0.57, -0.20] |   100% | 1.000 | 2387.00</span></span>
<span><span class="co">## mu2_seat7    |  -0.95 | [-1.15, -0.77] |   100% | 1.001 | 2470.00</span></span>
<span><span class="co">## mu2_seat8    |  -0.67 | [-0.85, -0.49] |   100% | 1.001 | 2489.00</span></span>
<span><span class="co">## mu2_cargo3ft |   0.49 | [ 0.35,  0.63] |   100% | 1.000 | 4836.00</span></span>
<span><span class="co">## mu2_enghyb   |  -0.79 | [-0.95, -0.63] |   100% | 1.000 | 4421.00</span></span>
<span><span class="co">## mu2_engelec  |  -1.40 | [-1.57, -1.22] |   100% | 1.000 | 4261.00</span></span>
<span><span class="co">## mu2_price35  |  -0.79 | [-0.95, -0.63] |   100% | 1.001 | 3699.00</span></span>
<span><span class="co">## mu2_price40  |  -1.47 | [-1.65, -1.29] |   100% | 0.999 | 3978.00</span></span>
<span><span class="co">## mu3_seat6    |  -0.28 | [-0.46, -0.11] | 99.85% | 1.000 | 2077.00</span></span>
<span><span class="co">## mu3_seat7    |  -0.78 | [-0.96, -0.60] |   100% | 1.000 | 3025.00</span></span>
<span><span class="co">## mu3_seat8    |  -0.63 | [-0.81, -0.46] |   100% | 1.000 | 2483.00</span></span>
<span><span class="co">## mu3_cargo3ft |   0.36 | [ 0.23,  0.50] |   100% | 0.999 | 5327.00</span></span>
<span><span class="co">## mu3_enghyb   |  -0.73 | [-0.88, -0.58] |   100% | 1.000 | 4039.00</span></span>
<span><span class="co">## mu3_engelec  |  -1.41 | [-1.59, -1.23] |   100% | 1.001 | 3818.00</span></span>
<span><span class="co">## mu3_price35  |  -0.85 | [-1.01, -0.69] |   100% | 1.000 | 4315.00</span></span>
<span><span class="co">## mu3_price40  |  -1.56 | [-1.75, -1.39] |   100% | 0.999 | 4774.00</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Importantly, the estimates here are all roughly equivalent to what we get from {mlogit}: the {mlogit} estimate for <code>cargo3ft</code> was 0.4775, while the three median posterior {brms} estimates are 0.46 (95% credible interval: 0.32–0.60), 0.49 (0.35–0.63), and 0.36 (0.23–0.50)</p>
<p>Since all the features are randomly shuffled between the three options each time, and each option is selected 1/3rd of the time, it’s probably maybe legal to pool these posterior estimates together (maaaaybeee???) so that we don’t have to work with three separate estimates for each parameter? To do this we’ll take the average of each of the three <span class="math inline">\(\mu\)</span> estimates within each draw, which is also called “marginalizing” across the three options.</p>
<p>Here’s how we’d do that with {tidybayes}. The medians are all roughly the same now!</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">minivans_cat_marginalized</span> <span class="op">&lt;-</span> <span class="va">model_minivans_categorical_brms</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">gather_draws</span><span class="op">(</span><span class="va">`^b_.*$`</span>, regex <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Each variable name has "mu1", "mu2", etc. built in, like "b_mu1_seat6". This</span></span>
<span>  <span class="co"># splits the .variable column into two parts based on a regular expression,</span></span>
<span>  <span class="co"># creating one column for the mu part ("b_mu1_") and one for the rest of the</span></span>
<span>  <span class="co"># variable name ("seat6")</span></span>
<span>  <span class="fu">separate_wider_regex</span><span class="op">(</span></span>
<span>    <span class="va">.variable</span>,</span>
<span>    patterns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>mu <span class="op">=</span> <span class="st">"b_mu\\d_"</span>, .variable <span class="op">=</span> <span class="st">".*"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Find the average of the three mu estimates for each variable within each</span></span>
<span>  <span class="co"># draw, or marginalize across the three options, since they're randomized</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">.variable</span>, <span class="va">.draw</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>.value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">.value</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">minivans_cat_marginalized</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">.variable</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">median_qi</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 8 × 7</span></span>
<span><span class="co">##   .variable .value .lower .upper .width .point .interval</span></span>
<span><span class="co">##   &lt;chr&gt;      &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span><span class="co">## 1 cargo3ft   0.439  0.340  0.532   0.95 median qi       </span></span>
<span><span class="co">## 2 engelec   -1.44  -1.56  -1.32    0.95 median qi       </span></span>
<span><span class="co">## 3 enghyb    -0.762 -0.871 -0.651   0.95 median qi       </span></span>
<span><span class="co">## 4 price35   -0.823 -0.935 -0.713   0.95 median qi       </span></span>
<span><span class="co">## 5 price40   -1.59  -1.72  -1.47    0.95 median qi       </span></span>
<span><span class="co">## 6 seat6     -0.337 -0.464 -0.208   0.95 median qi       </span></span>
<span><span class="co">## 7 seat7     -0.862 -0.994 -0.734   0.95 median qi       </span></span>
<span><span class="co">## 8 seat8     -0.629 -0.753 -0.503   0.95 median qi</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And for fun, here’s what the posterior for new combined/collapsed/marginalized <code>cargo3ft</code> looks like. Great.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">minivans_cat_marginalized</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">.variable</span> <span class="op">==</span> <span class="st">"cargo3ft"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">.value</span>, y <span class="op">=</span> <span class="va">.variable</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Posterior distribution of β (logit-scale)"</span>, y <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-cargo3ft-combined-posterior-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</section></section><section id="predictions-1" class="level2"><h2 class="anchored" data-anchor-id="predictions-1">Predictions</h2>
<p><a href="#predictions">As we saw in the first example with chocolates</a>, the marketing world typically uses predictions from these kinds of models to estimate the predicted market share for products with different constellations of features. That was a pretty straightforward task with the chocolate model since respondents were shown all 8 options simultaneously. It’s a lot trickier with the minivan example where respondents were shown 15 sets of 3 options. Dealing with multinomial predictions is a bear of a task because these models are a lot more complex.</p>
<section id="frequentist-predictions-1" class="level3"><h3 class="anchored" data-anchor-id="frequentist-predictions-1">Frequentist predictions</h3>
<p>With the chocolate model, we could use <code>predict(model_chocolate_mlogit)</code> and automatically get predictions for all 8 options. That’s not the case here:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">model_minivans_mlogit</span><span class="op">)</span></span>
<span><span class="co">##      1      2      3 </span></span>
<span><span class="co">## 0.3333 0.3333 0.3333</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We get three predictions, and they’re all 33ish%. That’s because respondents were presented with three randomly shuffled options and chose one of them. All these predictions tell us is that across all 15 iterations of the questions, 1/3 of respondents selected the first option, 1/3 the second, and 1/3 the third. That’s a good sign in this case—there’s no evidence that people were just repeatedly choosing the first option. But in the end, these predictions aren’t super useful.</p>
<p>We instead want to be able to get predicted market shares (or predicted probabilities) for any given mix of products. For instance, here are six arbitrary hypothetical products with different combinations of seats, cargo space, engines, and prices:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">example_product_mix</span> <span class="op">&lt;-</span> <span class="fu">tribble</span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">seat</span>, <span class="op">~</span><span class="va">cargo</span>, <span class="op">~</span><span class="va">eng</span>, <span class="op">~</span><span class="va">price</span>,</span>
<span>  <span class="st">"7"</span>, <span class="st">"2ft"</span>, <span class="st">"hyb"</span>, <span class="st">"30"</span>,</span>
<span>  <span class="st">"6"</span>, <span class="st">"2ft"</span>, <span class="st">"gas"</span>, <span class="st">"30"</span>,</span>
<span>  <span class="st">"8"</span>, <span class="st">"2ft"</span>, <span class="st">"gas"</span>, <span class="st">"30"</span>,</span>
<span>  <span class="st">"7"</span>, <span class="st">"3ft"</span>, <span class="st">"gas"</span>, <span class="st">"40"</span>,</span>
<span>  <span class="st">"6"</span>, <span class="st">"2ft"</span>, <span class="st">"elec"</span>, <span class="st">"40"</span>,</span>
<span>  <span class="st">"7"</span>, <span class="st">"2ft"</span>, <span class="st">"hyb"</span>, <span class="st">"35"</span></span>
<span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu">everything</span><span class="op">(</span><span class="op">)</span>, <span class="va">factor</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>eng <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">eng</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">minivans</span><span class="op">$</span><span class="va">eng</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">example_product_mix</span></span>
<span><span class="co">## # A tibble: 6 × 4</span></span>
<span><span class="co">##   seat  cargo eng   price</span></span>
<span><span class="co">##   &lt;fct&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt;</span></span>
<span><span class="co">## 1 7     2ft   hyb   30   </span></span>
<span><span class="co">## 2 6     2ft   gas   30   </span></span>
<span><span class="co">## 3 8     2ft   gas   30   </span></span>
<span><span class="co">## 4 7     3ft   gas   40   </span></span>
<span><span class="co">## 5 6     2ft   elec  40   </span></span>
<span><span class="co">## 6 7     2ft   hyb   35</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If we were working with any other type of model, we could plug this data into the <code>newdata</code> argument of <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> and get predicted values. That doesn’t work here though. We get predicted values, but these don’t correspond to each row of the <code>newdata</code> dataset—instead, each row sums to 100%, showing the probability of choosing column 1, 2 or 3 in the original survey, which isn’t really all that helpful here.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">preds_wrong</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">model_minivans_mlogit</span>, newdata <span class="op">=</span> <span class="va">example_product_mix</span><span class="op">)</span></span>
<span><span class="va">preds_wrong</span></span>
<span><span class="co">##        1      2      3</span></span>
<span><span class="co">## 1 0.1303 0.5008 0.3689</span></span>
<span><span class="co">## 2 0.5405 0.1239 0.3356</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Further complicating things, it only returns two rows because it assumes that these six hypothetical product offerings were two different choice sets, or that rows 1–3 were shown together to the respondent, followed by rows 4–6. But that’s not the case, and we’re not interested in that.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Rearrange the predictions to be based on choice sets</span></span>
<span><span class="va">preds_wrong_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">preds_wrong</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>choice_set <span class="op">=</span> <span class="fu">row_number</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">pivot_longer</span><span class="op">(</span>cols <span class="op">=</span> <span class="op">-</span><span class="va">choice_set</span>, names_to <span class="op">=</span> <span class="st">"alternative"</span>, values_to <span class="op">=</span> <span class="st">"probability"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>alternative <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">alternative</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># The probabilities within each fake choice set add to 100%</span></span>
<span><span class="va">example_product_mix</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>choice_set <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, each <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>, alternative <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">preds_wrong_df</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"choice_set"</span>, <span class="st">"alternative"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 6 × 7</span></span>
<span><span class="co">##   seat  cargo eng   price choice_set alternative probability</span></span>
<span><span class="co">##   &lt;fct&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt;      &lt;int&gt;       &lt;int&gt;       &lt;dbl&gt;</span></span>
<span><span class="co">## 1 7     2ft   hyb   30             1           1       0.130</span></span>
<span><span class="co">## 2 6     2ft   gas   30             1           2       0.501</span></span>
<span><span class="co">## 3 8     2ft   gas   30             1           3       0.369</span></span>
<span><span class="co">## 4 7     3ft   gas   40             2           1       0.540</span></span>
<span><span class="co">## 5 6     2ft   elec  40             2           2       0.124</span></span>
<span><span class="co">## 6 7     2ft   hyb   35             2           3       0.336</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Instead, following <span class="citation" data-cites="ChapmanFeit:2019">Chapman and Feit (<a href="#ref-ChapmanFeit:2019" role="doc-biblioref">2019</a>)</span> (and <a href="https://discourse.mc-stan.org/t/getting-predictions-for-multinomial-model-using-brms/22335">this Stan forum post</a>), we can manually multiply the covariates in <code>example_product_mix</code> with the model coefficients to calculate “utility” (or predicted vales on the logit scale), which we can then exponentiate and divide to calculate market shares.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Create a matrix of 0s and 1s for the values in `example_product_mix`, omitting</span></span>
<span><span class="co"># the first column (seat6)</span></span>
<span><span class="va">example_product_dummy_encoded</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html">model.matrix</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">model_minivans_mlogit</span><span class="op">$</span><span class="va">formula</span>, <span class="fl">0</span> <span class="op">~</span> <span class="va">.</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">example_product_mix</span></span>
<span><span class="op">)</span><span class="op">[</span>, <span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">example_product_dummy_encoded</span></span>
<span><span class="co">##   seat7 seat8 cargo3ft enghyb engelec price35 price40</span></span>
<span><span class="co">## 1     1     0        0      1       0       0       0</span></span>
<span><span class="co">## 2     0     0        0      0       0       0       0</span></span>
<span><span class="co">## 3     0     1        0      0       0       0       0</span></span>
<span><span class="co">## 4     1     0        1      0       0       0       1</span></span>
<span><span class="co">## 5     0     0        0      0       1       0       1</span></span>
<span><span class="co">## 6     1     0        0      1       0       1       0</span></span>
<span></span>
<span><span class="co"># Matrix multiply the matrix of 0s and 1s with the model coefficients to get</span></span>
<span><span class="co"># logit-scale predictions, or utility</span></span>
<span><span class="va">utility</span> <span class="op">&lt;-</span> <span class="va">example_product_dummy_encoded</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">model_minivans_mlogit</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Divide each exponentiated utility by the sum of the exponentiated utilities to</span></span>
<span><span class="co"># get the market share</span></span>
<span><span class="va">share</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">utility</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">utility</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Stick all of these in one final dataset</span></span>
<span><span class="fu">bind_cols</span><span class="op">(</span>share <span class="op">=</span> <span class="va">share</span>, logits <span class="op">=</span> <span class="va">utility</span>, <span class="va">example_product_mix</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 6 × 6</span></span>
<span><span class="co">##   share[,1] logits[,1] seat  cargo eng   price</span></span>
<span><span class="co">##       &lt;dbl&gt;      &lt;dbl&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt;</span></span>
<span><span class="co">## 1    0.113      -1.35  7     2ft   hyb   30   </span></span>
<span><span class="co">## 2    0.433       0     6     2ft   gas   30   </span></span>
<span><span class="co">## 3    0.319      -0.306 8     2ft   gas   30   </span></span>
<span><span class="co">## 4    0.0728     -1.78  7     3ft   gas   40   </span></span>
<span><span class="co">## 5    0.0167     -3.26  6     2ft   elec  40   </span></span>
<span><span class="co">## 6    0.0452     -2.26  7     2ft   hyb   35</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-10-contents" aria-controls="callout-10" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Function version of this kind of prediction
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-10" class="callout-10-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>On p.&nbsp;375 of <span class="citation" data-cites="ChapmanFeit:2019">Chapman and Feit (<a href="#ref-ChapmanFeit:2019" role="doc-biblioref">2019</a>)</span> (and at <a href="https://discourse.mc-stan.org/t/getting-predictions-for-multinomial-model-using-brms/22335/">this Stan forum post</a>), there’s a function called <code>predict.mnl()</code> that does this utility and share calculation automatically. Because this post is more didactic and because I’m more interested in the Bayesian approach, I didn’t use it earlier, but it works just the same.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">predict.mnl</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Function for predicting shares from a multinomial logit model </span></span>
<span>  <span class="co"># model: mlogit object returned by mlogit()</span></span>
<span>  <span class="co"># data: a data frame containing the set of designs for which you want to </span></span>
<span>  <span class="co">#       predict shares. Same format at the data used to estimate model. </span></span>
<span>  <span class="va">data.model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html">model.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">model</span><span class="op">$</span><span class="va">formula</span>, <span class="fl">0</span> <span class="op">~</span> <span class="va">.</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span><span class="op">[</span> , <span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">utility</span> <span class="op">&lt;-</span> <span class="va">data.model</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">model</span><span class="op">$</span><span class="va">coef</span></span>
<span>  <span class="va">share</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">utility</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">utility</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">share</span>, <span class="va">data</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">predict.mnl</span><span class="op">(</span><span class="va">model_minivans_mlogit</span>, <span class="va">example_product_mix</span><span class="op">)</span></span>
<span><span class="co">##     share seat cargo  eng price</span></span>
<span><span class="co">## 1 0.11273    7   2ft  hyb    30</span></span>
<span><span class="co">## 2 0.43337    6   2ft  gas    30</span></span>
<span><span class="co">## 3 0.31918    8   2ft  gas    30</span></span>
<span><span class="co">## 4 0.07281    7   3ft  gas    40</span></span>
<span><span class="co">## 5 0.01669    6   2ft elec    40</span></span>
<span><span class="co">## 6 0.04521    7   2ft  hyb    35</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>This new predicted <code>share</code> column sums to one, and it shows us the predicted market share assuming these are the only six products available. The $30,000 six-seater 2ft gas van and the $30,000 eight-seater 2ft gas van would comprise more than 75% (0.43337 + 0.31918) of a market consisting of these six products.</p>
</section><section id="bayesian-predictions-1" class="level3"><h3 class="anchored" data-anchor-id="bayesian-predictions-1">Bayesian predictions</h3>
<p>If we use the categorical multinomial {brms} model we run into the same issue of getting weird predictions. Using <code>marginaleffects::avg_predictions()</code>, we see that that 2/3rds of predictions are 0, which makes sense—if a respondent is offered 10 iterations of 3 possible choices, that would be 30 total choices, but they can only choose one option per iteration, so 20 choices (or 20/30 or 2/3) wouldn’t be selected. The other three groups are each 11%, since that’s the remaining 33% divided evenly across three options. Neat, I guess, but still not super helpful.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">avg_predictions</span><span class="op">(</span><span class="va">model_minivans_categorical_brms</span><span class="op">)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##  Group Estimate 2.5 % 97.5 %</span></span>
<span><span class="co">##      0    0.667 0.657  0.676</span></span>
<span><span class="co">##      1    0.109 0.103  0.115</span></span>
<span><span class="co">##      2    0.112 0.105  0.118</span></span>
<span><span class="co">##      3    0.113 0.106  0.119</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Columns: group, estimate, conf.low, conf.high </span></span>
<span><span class="co">## Type:  response</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Instead of going through the manual process of matrix-multiplying a dataset of some mix of products with a single set of coefficients, we can use <code>predictions(..., type = "link")</code> to get predicted values on the log-odds scale, or that utility value that we found before.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<code>marginaleffects::predictions()</code> vs.&nbsp;{tidybayes} functions
</div>
</div>
<div class="callout-body-container callout-body">
<p>We can actually use either <code>marginaleffects::predictions()</code> or {tidybayes}’s <code>*_draw()</code> functions for these posterior predictions. They do the same thing, with slightly different syntax:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Logit-scale predictions with marginaleffects::predictions()</span></span>
<span><span class="va">model_minivans_categorical_brms</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">predictions</span><span class="op">(</span>newdata <span class="op">=</span> <span class="va">example_product_mix</span>, re_formula <span class="op">=</span> <span class="cn">NA</span>, type <span class="op">=</span> <span class="st">"link"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">posterior_draws</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Logit-scale predictions with tidybayes::add_linpred_draws()</span></span>
<span><span class="va">model_minivans_categorical_brms</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">add_linpred_draws</span><span class="op">(</span>newdata <span class="op">=</span> <span class="va">example_product_mix</span>, re_formula <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="#bayesian-predictions">Earlier in the chocolate example</a>, I used <code>marginaleffects::predictions()</code> with the Bayesian {brms} model. Here I’m going to switch to the {tidybayes} prediction functions instead, in part because these multinomial models with the <code>categorical()</code> family are a lot more complex (though {marginaleffects} can handle them nicely), but mostly because in the actual paper I’m working on with real conjoint data, our MCMC results were generated with raw Stan code through <code>rstan</code>, and {marginaleffects} doesn’t support raw Stan models.</p>
<p><a href="https://www.andrewheiss.com/blog/2022/09/26/guide-visualizing-types-posteriors/">Check out this guide</a> for the differences between {tidybayes}’s three general prediction functions: <code>predicted_draws()</code>, <code>epred_draws()</code>, and <code>linpred_draws()</code>.</p>
</div>
</div>
<p>Additionally, we now actually have 4,000 draws in 3 categories (option 1, option 2, and option 3), so we actually have 12,000 sets of coefficients (!). To take advantage of the full posterior distribution of these coefficients, we can calculate shares within each set of draws within each of the three categories, resulting in a distribution of shares rather than single values.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">draws_df</span> <span class="op">&lt;-</span> <span class="va">example_product_mix</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">add_linpred_draws</span><span class="op">(</span><span class="va">model_minivans_categorical_brms</span>, value <span class="op">=</span> <span class="st">"utility"</span>, re_formula <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span></span>
<span><span class="va">shares_df</span> <span class="op">&lt;-</span> <span class="va">draws_df</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Look at each set of predicted utilities within each draw within each of the</span></span>
<span>  <span class="co"># three outcomes</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">.draw</span>, <span class="va">.category</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>share <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">utility</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">utility</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    mix_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">seat</span>, <span class="va">cargo</span>, <span class="va">eng</span>, <span class="va">price</span>, sep <span class="op">=</span> <span class="st">" "</span><span class="op">)</span>,</span>
<span>    mix_type <span class="op">=</span> <span class="fu">fct_reorder</span><span class="op">(</span><span class="va">mix_type</span>, <span class="va">share</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can summarize this huge dataset of posterior shares to get medians and credible intervals, but we need to do one extra step first. Right now, we have three predictions for each mix type, one for each of the categories (i.e.&nbsp;option 1, option 2, and option 3.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">shares_df</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">mix_type</span>, <span class="va">.category</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">median_qi</span><span class="op">(</span><span class="va">share</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 18 × 8</span></span>
<span><span class="co">##    mix_type      .category  share .lower .upper .width .point .interval</span></span>
<span><span class="co">##    &lt;fct&gt;         &lt;fct&gt;      &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span><span class="co">##  1 6 2ft elec 40 1         0.0161 0.0123 0.0208   0.95 median qi       </span></span>
<span><span class="co">##  2 6 2ft elec 40 2         0.0238 0.0183 0.0302   0.95 median qi       </span></span>
<span><span class="co">##  3 6 2ft elec 40 3         0.0216 0.0168 0.0275   0.95 median qi       </span></span>
<span><span class="co">##  4 7 2ft hyb 35  1         0.0513 0.0400 0.0647   0.95 median qi       </span></span>
<span><span class="co">##  5 7 2ft hyb 35  2         0.0485 0.0379 0.0605   0.95 median qi       </span></span>
<span><span class="co">##  6 7 2ft hyb 35  3         0.0532 0.0424 0.0660   0.95 median qi       </span></span>
<span><span class="co">##  7 7 3ft gas 40  1         0.0693 0.0543 0.0876   0.95 median qi       </span></span>
<span><span class="co">##  8 7 3ft gas 40  2         0.0891 0.0705 0.111    0.95 median qi       </span></span>
<span><span class="co">##  9 7 3ft gas 40  3         0.0775 0.0615 0.0967   0.95 median qi       </span></span>
<span><span class="co">## 10 7 2ft hyb 30  1         0.117  0.0976 0.139    0.95 median qi       </span></span>
<span><span class="co">## 11 7 2ft hyb 30  2         0.107  0.0891 0.128    0.95 median qi       </span></span>
<span><span class="co">## 12 7 2ft hyb 30  3         0.124  0.104  0.146    0.95 median qi       </span></span>
<span><span class="co">## 13 8 2ft gas 30  1         0.326  0.292  0.363    0.95 median qi       </span></span>
<span><span class="co">## 14 8 2ft gas 30  2         0.314  0.282  0.348    0.95 median qi       </span></span>
<span><span class="co">## 15 8 2ft gas 30  3         0.299  0.267  0.331    0.95 median qi       </span></span>
<span><span class="co">## 16 6 2ft gas 30  1         0.418  0.380  0.457    0.95 median qi       </span></span>
<span><span class="co">## 17 6 2ft gas 30  2         0.416  0.379  0.454    0.95 median qi       </span></span>
<span><span class="co">## 18 6 2ft gas 30  3         0.423  0.387  0.462    0.95 median qi</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Since those options were all randomized, we can lump them all together as a single choice. To do this we’ll take the average share across the three categories (this is also called “marginalizing”) within each posterior draw.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">shares_marginalized</span> <span class="op">&lt;-</span> <span class="va">shares_df</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Marginalize across categories within each draw</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">mix_type</span>, <span class="va">.draw</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>share <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">share</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">shares_marginalized</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">mix_type</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">median_qi</span><span class="op">(</span><span class="va">share</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 6 × 7</span></span>
<span><span class="co">##   mix_type       share .lower .upper .width .point .interval</span></span>
<span><span class="co">##   &lt;fct&gt;          &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span><span class="co">## 1 6 2ft elec 40 0.0206 0.0173 0.0242   0.95 median qi       </span></span>
<span><span class="co">## 2 7 2ft hyb 35  0.0512 0.0435 0.0600   0.95 median qi       </span></span>
<span><span class="co">## 3 7 3ft gas 40  0.0788 0.0673 0.0915   0.95 median qi       </span></span>
<span><span class="co">## 4 7 2ft hyb 30  0.116  0.103  0.131    0.95 median qi       </span></span>
<span><span class="co">## 5 8 2ft gas 30  0.313  0.291  0.337    0.95 median qi       </span></span>
<span><span class="co">## 6 6 2ft gas 30  0.419  0.394  0.446    0.95 median qi</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And we can plot them:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">shares_marginalized</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">share</span>, y <span class="op">=</span> <span class="va">mix_type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">10</span><span class="op">]</span>, normalize <span class="op">=</span> <span class="st">"xy"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_percent</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Predicted market share"</span>, y <span class="op">=</span> <span class="st">"Hypothetical product mix"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-shares-brms-categorical-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>This is great because (1) it includes the uncertainty in the estimated shares, and (2) it lets us do neat Bayesian inference and say things like “there’s a 93% chance that in this market of 6 options, a $30,000 6-passenger gas minivan with 2 feet of storage would reach at least 40% market share”:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">shares_marginalized</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">mix_type</span> <span class="op">==</span> <span class="st">"6 2ft gas 30"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>prop_greater_40 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">share</span> <span class="op">&gt;=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">/</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 1 × 1</span></span>
<span><span class="co">##   prop_greater_40</span></span>
<span><span class="co">##             &lt;dbl&gt;</span></span>
<span><span class="co">## 1           0.931</span></span>
<span></span>
<span><span class="va">shares_marginalized</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">mix_type</span> <span class="op">==</span> <span class="st">"6 2ft gas 30"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">share</span>, y <span class="op">=</span> <span class="va">mix_type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill_ramp <span class="op">=</span> <span class="fu">after_stat</span><span class="op">(</span><span class="va">x</span> <span class="op">&gt;=</span> <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span>, fill <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">10</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_percent</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_ramp_discrete</span><span class="op">(</span>from <span class="op">=</span> <span class="fu">colorspace</span><span class="fu">::</span><span class="fu">lighten</span><span class="op">(</span><span class="va">clrs</span><span class="op">[</span><span class="fl">10</span><span class="op">]</span>, <span class="fl">0.4</span><span class="op">)</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Predicted market share"</span>, y <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-shares-pd-example-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</section></section><section id="amces-1" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="amces-1">AMCEs</h2>
<p>As explained in the <a href="#amces">AMCEs section for the chocolate data</a>, in the social sciences we’re less concerned about predicted market shares and more concerned about causal effects. Holding all other features constant, what is the effect of a $5,000 increase in price or moving from 2 feet → 3 feet of storage space on the probability (or favorability) of selecting a minivan?</p>
<p>In the chocolate example, we were able to use <code>marginaleffects::avg_comparisons()</code> with the Bayesian model and get categorical contrasts automatically. This was because we cheated and used a Poisson model, since those can secretly behave like multinomial models. For the frequentist {mlogit}-based model, we had to use base R’s <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> instead and then collapse the predictions into the different contrasts we were interested in using <code>group_by() %&gt;% summarize()</code>. We need to do the same thing here.</p>
<section id="frequentist-comparisonscontrasts-1" class="level3"><h3 class="anchored" data-anchor-id="frequentist-comparisonscontrasts-1">Frequentist comparisons/contrasts</h3>
<p>To help with the intuition behind this, since it’s more complex this time, we’ll create a data frame to show all the combinations of all the feature levels (3 seats × 2 cargos × 3 engines × 3 prices). There are 54 possible combinations:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">van_all_combos</span> <span class="op">&lt;-</span> <span class="va">minivans</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu">expand</span><span class="op">(</span><span class="va">seat</span>, <span class="va">cargo</span>, <span class="va">eng</span>, <span class="va">price</span><span class="op">)</span></span>
<span><span class="va">van_all_combos</span></span>
<span><span class="co">## # A tibble: 54 × 4</span></span>
<span><span class="co">##    seat  cargo eng   price</span></span>
<span><span class="co">##    &lt;fct&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt;</span></span>
<span><span class="co">##  1 6     2ft   gas   30   </span></span>
<span><span class="co">##  2 6     2ft   gas   35   </span></span>
<span><span class="co">##  3 6     2ft   gas   40   </span></span>
<span><span class="co">##  4 6     2ft   hyb   30   </span></span>
<span><span class="co">##  5 6     2ft   hyb   35   </span></span>
<span><span class="co">##  6 6     2ft   hyb   40   </span></span>
<span><span class="co">##  7 6     2ft   elec  30   </span></span>
<span><span class="co">##  8 6     2ft   elec  35   </span></span>
<span><span class="co">##  9 6     2ft   elec  40   </span></span>
<span><span class="co">## 10 6     3ft   gas   30   </span></span>
<span><span class="co">## # ℹ 44 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We want to calculate the probabilities for each of these combinations, regardless of whether the hypothetical minivan appeared as the first, second, or third option in the survey experiment.</p>
<p>Fortunately, {mlogit} already did most of the work for us! One of the slots in the <code>model_minivans_mlogit</code> object is named <code>$probabilities</code>, which contains the a matrix of predicted probabilities for each of the 3,000 choice sets (200 respondents × 15 sets of questions)</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Number of choice sets</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">model_minivans_mlogit</span><span class="op">$</span><span class="va">probabilities</span><span class="op">)</span></span>
<span><span class="co">## [1] 3000</span></span>
<span></span>
<span><span class="co"># Probability of selecting each alternative within each choice set</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">model_minivans_mlogit</span><span class="op">$</span><span class="va">probabilities</span><span class="op">)</span></span>
<span><span class="co">##         1      2       3</span></span>
<span><span class="co">## 1 0.15787 0.2076 0.63451</span></span>
<span><span class="co">## 2 0.68246 0.2583 0.05922</span></span>
<span><span class="co">## 3 0.67183 0.2881 0.04003</span></span>
<span><span class="co">## 4 0.05254 0.3054 0.64204</span></span>
<span><span class="co">## 5 0.64785 0.1153 0.23682</span></span>
<span><span class="co">## 6 0.10199 0.6218 0.27624</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Working with data like this, though, is messy and untidy. Fortunately again, if we use <code><a href="https://rdrr.io/r/stats/model.frame.html">model.frame()</a></code>, {mlogit} will return a long data frame with probabilities for each of the alternatives within each of the choice sets, or 9,000 rows (200 respondents × 15 sets of questions × 3 options within each question). This is the original data we used for the model, only now with columns for the fitted values on the logit scale (the <code>linpred</code> column) and the probability scale (the <code>probabilities</code> column).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/model.frame.html">model.frame</a></span><span class="op">(</span><span class="va">model_minivans_mlogit</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 9,000 × 8</span></span>
<span><span class="co">## # Index:    3000 (choice.id) x 3 (alt)</span></span>
<span><span class="co">## # Balanced: yes</span></span>
<span><span class="co">## # Nesting:  choice.id (resp.id)</span></span>
<span><span class="co">##    choice seat  cargo eng   price idx   probabilities linpred</span></span>
<span><span class="co">##    &lt;lgl&gt;  &lt;fct&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt; &lt;idx&gt;         &lt;dbl&gt;   &lt;dbl&gt;</span></span>
<span><span class="co">##  1 FALSE  6     2ft   gas   35    1:1          0.158   -0.914</span></span>
<span><span class="co">##  2 FALSE  8     3ft   hyb   30    1:2          0.208   -0.640</span></span>
<span><span class="co">##  3 TRUE   6     3ft   gas   30    1:3          0.635    0.477</span></span>
<span><span class="co">##  4 FALSE  6     2ft   gas   30    2:1          0.682    0    </span></span>
<span><span class="co">##  5 TRUE   7     3ft   gas   35    2:2          0.258   -0.971</span></span>
<span><span class="co">##  6 FALSE  6     2ft   elec  35    2:3          0.0592  -2.44 </span></span>
<span><span class="co">##  7 TRUE   8     3ft   gas   35    3:1          0.672   -0.742</span></span>
<span><span class="co">##  8 FALSE  7     3ft   elec  30    3:2          0.288   -1.59 </span></span>
<span><span class="co">##  9 FALSE  8     2ft   elec  40    3:3          0.0400  -3.56 </span></span>
<span><span class="co">## 10 TRUE   7     3ft   elec  40    4:1          0.0525  -3.31 </span></span>
<span><span class="co">## # ℹ 8,990 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>That’s neat, but it’s still a lot of data. Remember <code>van_all_combos</code> from earlier, with the 54 unique combinations of seat, cargo, engine, and price? We want to know the probabilities for each of those combinations.</p>
<p>We can find those with some grouping and summarizing, finding the average probability within each of the combinations:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">all_preds_mlogit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.frame.html">model.frame</a></span><span class="op">(</span><span class="va">model_minivans_mlogit</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">seat</span>, <span class="va">cargo</span>, <span class="va">eng</span>, <span class="va">price</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>estimate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">probabilities</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">all_preds_mlogit</span></span>
<span><span class="co">## # A tibble: 54 × 5</span></span>
<span><span class="co">## # Groups:   seat, cargo, eng [18]</span></span>
<span><span class="co">##    seat  cargo eng   price estimate</span></span>
<span><span class="co">##    &lt;fct&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">##  1 6     2ft   gas   30      0.695 </span></span>
<span><span class="co">##  2 6     2ft   gas   35      0.491 </span></span>
<span><span class="co">##  3 6     2ft   gas   40      0.311 </span></span>
<span><span class="co">##  4 6     2ft   hyb   30      0.499 </span></span>
<span><span class="co">##  5 6     2ft   hyb   35      0.300 </span></span>
<span><span class="co">##  6 6     2ft   hyb   40      0.161 </span></span>
<span><span class="co">##  7 6     2ft   elec  30      0.348 </span></span>
<span><span class="co">##  8 6     2ft   elec  35      0.173 </span></span>
<span><span class="co">##  9 6     2ft   elec  40      0.0872</span></span>
<span><span class="co">## 10 6     3ft   gas   30      0.768 </span></span>
<span><span class="co">## # ℹ 44 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Perfect. The option with 6 seats, 2 feet of cargo space, a gas engine, at $30,000 had a 70% chance of being selected <em>regardless of whether it was presented as option 1, 2, or 3</em>.</p>
<p>To find the AMCE of specific features, we can collapse and average even further. For instance, suppose we’re interested in the AMCE of cargo space. We can first find the average predicted probability of selection with some grouping and summarizing, then calculate the difference between the two rows:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">manual_cargo_example</span> <span class="op">&lt;-</span> <span class="va">all_preds_mlogit</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">cargo</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>avg_pred <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">manual_cargo_example</span></span>
<span><span class="co">## # A tibble: 2 × 2</span></span>
<span><span class="co">##   cargo avg_pred</span></span>
<span><span class="co">##   &lt;fct&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">## 1 2ft      0.292</span></span>
<span><span class="co">## 2 3ft      0.375</span></span>
<span></span>
<span><span class="co"># diff() way</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="va">manual_cargo_example</span><span class="op">$</span><span class="va">avg_pred</span><span class="op">)</span></span>
<span><span class="co">## [1] 0.08326</span></span>
<span></span>
<span><span class="co"># Tidyverse way</span></span>
<span><span class="va">manual_cargo_example</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">cargo</span>, values_from <span class="op">=</span> <span class="va">avg_pred</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    term <span class="op">=</span> <span class="st">"3ft - 2ft"</span>,</span>
<span>    estimate <span class="op">=</span> <span class="va">`3ft`</span> <span class="op">-</span> <span class="va">`2ft`</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">term</span>, <span class="va">estimate</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 1 × 2</span></span>
<span><span class="co">##   term      estimate</span></span>
<span><span class="co">##   &lt;chr&gt;        &lt;dbl&gt;</span></span>
<span><span class="co">## 1 3ft - 2ft   0.0833</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Holding all other features constant, the average probability (or average favorability, or average market share, or whatever we want to call it) of selecting a minivan with 2 feet of storage space is 0.292 (this is the average of the 27 predictions from <code>all_preds_mlogit</code> where <code>cargo</code> = <code>2ft</code>); the average probability for a minivan with 3 feet of storage space is 0.375 (again, this is the average of the 27 predictions from <code>all_preds_mlogit</code> where <code>cargo</code> = <code>3ft</code>). There’s an 8.3 percentage point difference between these groups. <strong>This is the causal effect or AMCE</strong>: switching from 2 feet to 3 feet increases minivan favorability by 8 percentage points on average.</p>
<p>We can make a big data frame with all the AMCEs we’re interested in. I’ve hidden the code here because it’s really repetitive.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Make separate datasets of predictions and combine them in one data frame</summary><div class="sourceCode" id="cb58"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">amce_minivan_seat_67_mlogit</span> <span class="op">&lt;-</span> <span class="va">all_preds_mlogit</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">seat</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>avg_pred <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">seat</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"6"</span>, <span class="st">"7"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">seat</span>, values_from <span class="op">=</span> <span class="va">avg_pred</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    term <span class="op">=</span> <span class="st">"7 - 6"</span>,</span>
<span>    estimate <span class="op">=</span> <span class="va">`7`</span> <span class="op">-</span> <span class="va">`6`</span>,</span>
<span>    variable <span class="op">=</span> <span class="st">"seat"</span></span>
<span>  <span class="op">)</span>  <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">variable</span>, <span class="va">term</span>, <span class="va">estimate</span><span class="op">)</span></span>
<span></span>
<span><span class="va">amce_minivan_seat_68_mlogit</span> <span class="op">&lt;-</span> <span class="va">all_preds_mlogit</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">seat</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>avg_pred <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">seat</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"6"</span>, <span class="st">"8"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">seat</span>, values_from <span class="op">=</span> <span class="va">avg_pred</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    term <span class="op">=</span> <span class="st">"8 - 6"</span>,</span>
<span>    estimate <span class="op">=</span> <span class="va">`8`</span> <span class="op">-</span> <span class="va">`6`</span>,</span>
<span>    variable <span class="op">=</span> <span class="st">"seat"</span></span>
<span>  <span class="op">)</span>  <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">variable</span>, <span class="va">term</span>, <span class="va">estimate</span><span class="op">)</span></span>
<span></span>
<span><span class="va">amce_minivan_cargo_mlogit</span> <span class="op">&lt;-</span> <span class="va">all_preds_mlogit</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">cargo</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>avg_pred <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">cargo</span>, values_from <span class="op">=</span> <span class="va">avg_pred</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    term <span class="op">=</span> <span class="st">"3ft - 2ft"</span>,</span>
<span>    estimate <span class="op">=</span> <span class="va">`3ft`</span> <span class="op">-</span> <span class="va">`2ft`</span>,</span>
<span>    variable <span class="op">=</span> <span class="st">"cargo"</span></span>
<span>  <span class="op">)</span>  <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">variable</span>, <span class="va">term</span>, <span class="va">estimate</span><span class="op">)</span></span>
<span></span>
<span><span class="va">amce_minivan_eng_gas_elec_mlogit</span> <span class="op">&lt;-</span> <span class="va">all_preds_mlogit</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">eng</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>avg_pred <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">eng</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"gas"</span>, <span class="st">"elec"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">eng</span>, values_from <span class="op">=</span> <span class="va">avg_pred</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    term <span class="op">=</span> <span class="st">"elec - gas"</span>,</span>
<span>    estimate <span class="op">=</span> <span class="va">elec</span> <span class="op">-</span> <span class="va">gas</span>,</span>
<span>    variable <span class="op">=</span> <span class="st">"eng"</span></span>
<span>  <span class="op">)</span>  <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">variable</span>, <span class="va">term</span>, <span class="va">estimate</span><span class="op">)</span></span>
<span></span>
<span><span class="va">amce_minivan_eng_gas_hyb_mlogit</span> <span class="op">&lt;-</span> <span class="va">all_preds_mlogit</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">eng</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>avg_pred <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">eng</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"gas"</span>, <span class="st">"hyb"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">eng</span>, values_from <span class="op">=</span> <span class="va">avg_pred</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    term <span class="op">=</span> <span class="st">"hyb - gas"</span>,</span>
<span>    estimate <span class="op">=</span> <span class="va">hyb</span> <span class="op">-</span> <span class="va">gas</span>,</span>
<span>    variable <span class="op">=</span> <span class="st">"eng"</span></span>
<span>  <span class="op">)</span>  <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">variable</span>, <span class="va">term</span>, <span class="va">estimate</span><span class="op">)</span></span>
<span></span>
<span><span class="va">amce_minivan_price_3035_mlogit</span> <span class="op">&lt;-</span> <span class="va">all_preds_mlogit</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">price</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>avg_pred <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">price</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"30"</span>, <span class="st">"35"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">price</span>, values_from <span class="op">=</span> <span class="va">avg_pred</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    term <span class="op">=</span> <span class="st">"35 - 30"</span>,</span>
<span>    estimate <span class="op">=</span> <span class="va">`35`</span> <span class="op">-</span> <span class="va">`30`</span>,</span>
<span>    variable <span class="op">=</span> <span class="st">"price"</span></span>
<span>  <span class="op">)</span>  <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">variable</span>, <span class="va">term</span>, <span class="va">estimate</span><span class="op">)</span></span>
<span></span>
<span><span class="va">amce_minivan_price_3040_mlogit</span> <span class="op">&lt;-</span> <span class="va">all_preds_mlogit</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">price</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>avg_pred <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">price</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"30"</span>, <span class="st">"40"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">price</span>, values_from <span class="op">=</span> <span class="va">avg_pred</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    term <span class="op">=</span> <span class="st">"40 - 30"</span>,</span>
<span>    estimate <span class="op">=</span> <span class="va">`40`</span> <span class="op">-</span> <span class="va">`30`</span>,</span>
<span>    variable <span class="op">=</span> <span class="st">"price"</span></span>
<span>  <span class="op">)</span>  <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">variable</span>, <span class="va">term</span>, <span class="va">estimate</span><span class="op">)</span></span>
<span></span>
<span><span class="va">amces_minivan_mlogit</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span></span>
<span>  <span class="va">amce_minivan_seat_67_mlogit</span>,</span>
<span>  <span class="va">amce_minivan_seat_68_mlogit</span>,</span>
<span>  <span class="va">amce_minivan_cargo_mlogit</span>,</span>
<span>  <span class="va">amce_minivan_eng_gas_elec_mlogit</span>,</span>
<span>  <span class="va">amce_minivan_eng_gas_hyb_mlogit</span>,</span>
<span>  <span class="va">amce_minivan_price_3035_mlogit</span>,</span>
<span>  <span class="va">amce_minivan_price_3040_mlogit</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">amces_minivan_mlogit</span></span>
<span><span class="co">## # A tibble: 7 × 3</span></span>
<span><span class="co">##   variable term       estimate</span></span>
<span><span class="co">##   &lt;chr&gt;    &lt;chr&gt;         &lt;dbl&gt;</span></span>
<span><span class="co">## 1 seat     7 - 6       -0.0997</span></span>
<span><span class="co">## 2 seat     8 - 6       -0.0574</span></span>
<span><span class="co">## 3 cargo    3ft - 2ft    0.0833</span></span>
<span><span class="co">## 4 eng      elec - gas  -0.278 </span></span>
<span><span class="co">## 5 eng      hyb - gas   -0.161 </span></span>
<span><span class="co">## 6 price    35 - 30     -0.178 </span></span>
<span><span class="co">## 7 price    40 - 30     -0.309</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="bayesian-comparisonscontrasts-1" class="level3"><h3 class="anchored" data-anchor-id="bayesian-comparisonscontrasts-1">Bayesian comparisons/contrasts</h3>
<p>Unlike the chocolate example, where the outcome variable was binary, we have to do similar grouping and summarizing and marginalizing shenanigans with the Bayesian minivan model here. We could theoretically work with things like <code>marginaleffects::comparisons()</code> or <code>marginaleffects::slopes()</code> to extract the AMCEs from the model, but as I’ll show below, there are some weird mathy things we have to deal with because of the multinomial outcome, and I think it’s beyond what {marginaleffects} is designed to easily do.</p>
<p>So instead we can use <code>epred_draws()</code> from {tidybayes} and calculate posterior predictions ourselves (<a href="https://www.andrewheiss.com/blog/2022/09/26/guide-visualizing-types-posteriors/">see this guide</a> for an overview of all of {tidybayes}’s different prediction functions).</p>
<p>To illustrate why predicting things with this multinomial model is so weird, we’ll first predict the probability that someone chooses a $30,000 6-seater electric van with 2 feet of storage space. For this combination of minivan characteristics, there’s a 66% chance that someone does not select it, shown as category 0. That means there’s a 33% chance that someone <em>does</em> select it. Because options 1, 2 and 3 were randomized, that 33% is split evenly across categories 1, 2, and 3 in the predictions here.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">one_prediction</span> <span class="op">&lt;-</span> <span class="va">model_minivans_categorical_brms</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">epred_draws</span><span class="op">(</span>newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>    seat <span class="op">=</span> <span class="st">"6"</span>, cargo <span class="op">=</span> <span class="st">"2ft"</span>, eng <span class="op">=</span> <span class="st">"elec"</span>, price <span class="op">=</span> <span class="st">"30"</span>, resp.id <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">one_prediction</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">.category</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">median_qi</span><span class="op">(</span><span class="va">.epred</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 4 × 7</span></span>
<span><span class="co">##   .category .epred .lower .upper .width .point .interval</span></span>
<span><span class="co">##   &lt;fct&gt;      &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span><span class="co">## 1 0          0.661 0.629   0.694   0.95 median qi       </span></span>
<span><span class="co">## 2 1          0.104 0.0843  0.128   0.95 median qi       </span></span>
<span><span class="co">## 3 2          0.112 0.0894  0.138   0.95 median qi       </span></span>
<span><span class="co">## 4 3          0.121 0.0990  0.147   0.95 median qi</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We could add the predictions for categories 1, 2, and 3 together, but that would take a bit of extra data manipulation work. Instead, we can rely on the the fact that the prediction for category 0 is actually the inverse of the sum of categories 1+2+3, so we can instead just use <code>1 - .epred</code> and only look at category 0. Even though the <code>category</code> column here says <code>0</code>, it’s really the combined probability of choosing options 1, 2, or 3:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">one_prediction</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>.epred <span class="op">=</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">.epred</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">.category</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">median_qi</span><span class="op">(</span><span class="va">.epred</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 1 × 13</span></span>
<span><span class="co">##   seat  cargo eng   price resp.id  .row .category .epred .lower .upper .width .point .interval</span></span>
<span><span class="co">##   &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;   &lt;dbl&gt; &lt;int&gt; &lt;fct&gt;      &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span><span class="co">## 1 6     2ft   elec  30          1     1 0          0.339  0.306  0.371   0.95 median qi</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>With {mlogit}, we found AMCEs by essentially calculating marginal means for specific contrasts of predicted probabilities. We created a data frame of all 54 combinations of feature levels and then grouped and summarized that data frame as needed (e.g., the average of the 27 predictions for 2 feet of cargo space and the average of the 27 predictions for 3 feed of cargo space).</p>
<p>We can do the same thing with the {brms} model, but selecting only the 0 category and reversing the predicted value:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">newdata_all_combos</span> <span class="op">&lt;-</span> <span class="va">minivans</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu">expand</span><span class="op">(</span><span class="va">seat</span>, <span class="va">cargo</span>, <span class="va">eng</span>, <span class="va">price</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>resp.id <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">all_preds_brms</span> <span class="op">&lt;-</span> <span class="va">model_minivans_categorical_brms</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">epred_draws</span><span class="op">(</span>newdata <span class="op">=</span> <span class="va">newdata_all_combos</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">.category</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>.epred <span class="op">=</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">.epred</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To make sure it worked, here are the posterior medians for all the different levels. It’s roughly the same as what we found with in <code>all_preds_mlogit</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">all_preds_brms</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">seat</span>, <span class="va">cargo</span>, <span class="va">eng</span>, <span class="va">price</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">median_qi</span><span class="op">(</span><span class="va">.epred</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 54 × 10</span></span>
<span><span class="co">##    seat  cargo eng   price .epred .lower .upper .width .point .interval</span></span>
<span><span class="co">##    &lt;fct&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span><span class="co">##  1 6     2ft   gas   30    0.682  0.651   0.713   0.95 median qi       </span></span>
<span><span class="co">##  2 6     2ft   gas   35    0.485  0.451   0.520   0.95 median qi       </span></span>
<span><span class="co">##  3 6     2ft   gas   40    0.305  0.275   0.338   0.95 median qi       </span></span>
<span><span class="co">##  4 6     2ft   hyb   30    0.502  0.466   0.537   0.95 median qi       </span></span>
<span><span class="co">##  5 6     2ft   hyb   35    0.306  0.276   0.338   0.95 median qi       </span></span>
<span><span class="co">##  6 6     2ft   hyb   40    0.171  0.150   0.194   0.95 median qi       </span></span>
<span><span class="co">##  7 6     2ft   elec  30    0.339  0.306   0.371   0.95 median qi       </span></span>
<span><span class="co">##  8 6     2ft   elec  35    0.183  0.161   0.207   0.95 median qi       </span></span>
<span><span class="co">##  9 6     2ft   elec  40    0.0952 0.0819  0.110   0.95 median qi       </span></span>
<span><span class="co">## 10 6     3ft   gas   30    0.769  0.743   0.795   0.95 median qi       </span></span>
<span><span class="co">## # ℹ 44 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To pull out specific group-level averages, we can group and summarize. For example, here are the posterior median predictions for the two levels of cargo space:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">all_preds_brms</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">cargo</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">median_qi</span><span class="op">(</span><span class="va">.epred</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 2 × 7</span></span>
<span><span class="co">##   cargo .epred .lower .upper .width .point .interval</span></span>
<span><span class="co">##   &lt;fct&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span><span class="co">## 1 2ft    0.256 0.0606  0.676   0.95 median qi       </span></span>
<span><span class="co">## 2 3ft    0.348 0.0905  0.763   0.95 median qi</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The medians here are correct and basically what we found with {mlogit}, but the credible intervals are <em>wildly</em> off (5% to 75% favorability?!). If we plot this we can see why:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">all_preds_brms</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">.epred</span>, y <span class="op">=</span> <span class="va">cargo</span>, fill <span class="op">=</span> <span class="va">cargo</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_percent</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">11</span>, <span class="fl">7</span><span class="op">)</span><span class="op">]</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Marginal means"</span>, y <span class="op">=</span> <span class="st">"Cargo space"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-preds-combo-wrong-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>hahahaha check out those mountain ranges. All those peaks come from combining the 27 different 2ft- and 3ft- posterior distributions for all the different combinations of other feature levels.</p>
<p>To get the actual marginal mean for cargo space, we need to marginalize out (or average out) all those other covariates. To do this, we need to group by the <code>cargo</code> column <em>and</em> the <code>.draw</code> column so that we find the average within each set of MCMC draws. To help with the intuition, look how many rows are in each of these groups of <code>cargo</code> and <code>.draw</code>—there are 27 different estimates for each of the 4,000 draws for 2 feet and 27 different estimates for each of the 4,000 draws for 3 feet. We want to collapse (or marginalize) those 27 rows into just one average.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">all_preds_brms</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">cargo</span>, <span class="va">.draw</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>nrows <span class="op">=</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 8,000 × 3</span></span>
<span><span class="co">## # Groups:   cargo [2]</span></span>
<span><span class="co">##    cargo .draw nrows</span></span>
<span><span class="co">##    &lt;fct&gt; &lt;int&gt; &lt;int&gt;</span></span>
<span><span class="co">##  1 2ft       1    27</span></span>
<span><span class="co">##  2 2ft       2    27</span></span>
<span><span class="co">##  3 2ft       3    27</span></span>
<span><span class="co">##  4 2ft       4    27</span></span>
<span><span class="co">##  5 2ft       5    27</span></span>
<span><span class="co">##  6 2ft       6    27</span></span>
<span><span class="co">##  7 2ft       7    27</span></span>
<span><span class="co">##  8 2ft       8    27</span></span>
<span><span class="co">##  9 2ft       9    27</span></span>
<span><span class="co">## 10 2ft      10    27</span></span>
<span><span class="co">## # ℹ 7,990 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To do that, we can find the average predicted value in those groups, then work with that as our main estimand. Check out these marginalized-out posteriors now—the medians are the same as before, but the credible intervals make a lot more sense:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">preds_cargo_marginalized</span> <span class="op">&lt;-</span> <span class="va">all_preds_brms</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Marginalize out the other covariates</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">cargo</span>, <span class="va">.draw</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span>avg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">.epred</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">preds_cargo_marginalized</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">cargo</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">median_qi</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 2 × 7</span></span>
<span><span class="co">##   cargo   avg .lower .upper .width .point .interval</span></span>
<span><span class="co">##   &lt;fct&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span><span class="co">## 1 2ft   0.292  0.275  0.309   0.95 median qi       </span></span>
<span><span class="co">## 2 3ft   0.374  0.356  0.393   0.95 median qi</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can confirm that marginalizing out the other covariates worked by plotting it:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">preds_cargo_marginalized</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">avg</span>, y <span class="op">=</span> <span class="va">cargo</span>, fill <span class="op">=</span> <span class="va">cargo</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_percent</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">11</span>, <span class="fl">7</span><span class="op">)</span><span class="op">]</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Marginal means"</span>, y <span class="op">=</span> <span class="st">"Cargo space"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-preds-cargo-marginalized-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>heck. yes.</p>
<p>Finally, we’re actually most interested in the AMCE, or the difference between these two cargo sizes. The <code>compare_levels()</code> function from {tidybayes} can calculate this automatically:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">preds_cargo_marginalized</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">compare_levels</span><span class="op">(</span>variable <span class="op">=</span> <span class="va">avg</span>, by <span class="op">=</span> <span class="va">cargo</span>, comparison <span class="op">=</span> <span class="st">"control"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">median_qi</span><span class="op">(</span><span class="va">avg</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 1 × 7</span></span>
<span><span class="co">##   cargo        avg .lower .upper .width .point .interval</span></span>
<span><span class="co">##   &lt;chr&gt;      &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span><span class="co">## 1 3ft - 2ft 0.0830 0.0643  0.100   0.95 median qi</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>That’s it! The <strong>causal effect</strong> of moving from 2 feet → 3 feet of storage space, holding all other features constant, is 8 percentage points (with a 95% credible interval of 6.5 to 10 percentage points).</p>
<p>We can combine all these AMCEs into a huge data frame. The marginalization process + <code>compare_levels()</code> has to happen with one feature at a time, so we need to create several separate data frames:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># I could probably do this with purrr::map() to reduce all this repetition, but</span></span>
<span><span class="co"># whatever, it works</span></span>
<span><span class="va">amces_minivan_brms</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span></span>
<span>  seat <span class="op">=</span> <span class="va">all_preds_brms</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">seat</span>, <span class="va">.draw</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">summarize</span><span class="op">(</span>avg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">.epred</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">compare_levels</span><span class="op">(</span>variable <span class="op">=</span> <span class="va">avg</span>, by <span class="op">=</span> <span class="va">seat</span>, comparison <span class="op">=</span> <span class="st">"control"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">rename</span><span class="op">(</span>contrast <span class="op">=</span> <span class="va">seat</span><span class="op">)</span>,</span>
<span>  cargo <span class="op">=</span> <span class="va">all_preds_brms</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">cargo</span>, <span class="va">.draw</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">summarize</span><span class="op">(</span>avg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">.epred</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">compare_levels</span><span class="op">(</span>variable <span class="op">=</span> <span class="va">avg</span>, by <span class="op">=</span> <span class="va">cargo</span>, comparison <span class="op">=</span> <span class="st">"control"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">rename</span><span class="op">(</span>contrast <span class="op">=</span> <span class="va">cargo</span><span class="op">)</span>,</span>
<span>  eng <span class="op">=</span> <span class="va">all_preds_brms</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">eng</span>, <span class="va">.draw</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">summarize</span><span class="op">(</span>avg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">.epred</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">compare_levels</span><span class="op">(</span>variable <span class="op">=</span> <span class="va">avg</span>, by <span class="op">=</span> <span class="va">eng</span>, comparison <span class="op">=</span> <span class="st">"control"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">rename</span><span class="op">(</span>contrast <span class="op">=</span> <span class="va">eng</span><span class="op">)</span>,</span>
<span>  price <span class="op">=</span> <span class="va">all_preds_brms</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">price</span>, <span class="va">.draw</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">summarize</span><span class="op">(</span>avg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">.epred</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">compare_levels</span><span class="op">(</span>variable <span class="op">=</span> <span class="va">avg</span>, by <span class="op">=</span> <span class="va">price</span>, comparison <span class="op">=</span> <span class="st">"control"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">rename</span><span class="op">(</span>contrast <span class="op">=</span> <span class="va">price</span><span class="op">)</span>,</span>
<span>  .id <span class="op">=</span> <span class="st">"term"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">amces_minivan_brms</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">term</span>, <span class="va">contrast</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">median_qi</span><span class="op">(</span><span class="va">avg</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 7 × 8</span></span>
<span><span class="co">##   term  contrast       avg  .lower  .upper .width .point .interval</span></span>
<span><span class="co">##   &lt;chr&gt; &lt;chr&gt;        &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span><span class="co">## 1 cargo 3ft - 2ft   0.0830  0.0643  0.100    0.95 median qi       </span></span>
<span><span class="co">## 2 eng   elec - gas -0.279  -0.300  -0.256    0.95 median qi       </span></span>
<span><span class="co">## 3 eng   hyb - gas  -0.161  -0.184  -0.138    0.95 median qi       </span></span>
<span><span class="co">## 4 price 35 - 30    -0.178  -0.201  -0.155    0.95 median qi       </span></span>
<span><span class="co">## 5 price 40 - 30    -0.309  -0.330  -0.287    0.95 median qi       </span></span>
<span><span class="co">## 6 seat  7 - 6      -0.0995 -0.121  -0.0785   0.95 median qi       </span></span>
<span><span class="co">## 7 seat  8 - 6      -0.0570 -0.0788 -0.0355   0.95 median qi</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="plots-2" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="plots-2">Plots</h3>
<p>Again, plotting these AMCEs so that there’s a reference category at 0 requires some extra data work, so I’ve hidden all that code for the sake of space.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Extract variable labels</summary><div class="sourceCode" id="cb71"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">minivan_var_levels</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span></span>
<span>  variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"seat"</span>, <span class="st">"cargo"</span>, <span class="st">"eng"</span>, <span class="st">"price"</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>levels <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">variable</span>, <span class="op">~</span><span class="op">{</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">minivans</span><span class="op">[[</span><span class="va">.x</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">is.numeric</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="st">""</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">is.factor</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">unnest</span><span class="op">(</span><span class="va">levels</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>term <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">variable</span>, <span class="va">levels</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Make a little lookup table for nicer feature labels</span></span>
<span><span class="va">minivan_var_lookup</span> <span class="op">&lt;-</span> <span class="fu">tribble</span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">variable</span>, <span class="op">~</span><span class="va">variable_nice</span>,</span>
<span>  <span class="st">"seat"</span>,    <span class="st">"Passengers"</span>,</span>
<span>  <span class="st">"cargo"</span>,   <span class="st">"Cargo space"</span>,</span>
<span>  <span class="st">"eng"</span>,     <span class="st">"Engine type"</span>,</span>
<span>  <span class="st">"price"</span>,   <span class="st">"Price (thousands of $)"</span></span>
<span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>variable_nice <span class="op">=</span> <span class="fu">fct_inorder</span><span class="op">(</span><span class="va">variable_nice</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Combine full dataset of factor levels with model comparisons and make {mlogit} plot</summary><div class="sourceCode" id="cb72"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">amces_minivan_mlogit_split</span> <span class="op">&lt;-</span> <span class="va">amces_minivan_mlogit</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">separate_wider_delim</span><span class="op">(</span></span>
<span>    <span class="va">term</span>,</span>
<span>    delim <span class="op">=</span> <span class="st">" - "</span>, </span>
<span>    names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"variable_level"</span>, <span class="st">"reference_level"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">rename</span><span class="op">(</span>term <span class="op">=</span> <span class="va">variable</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_data</span> <span class="op">&lt;-</span> <span class="va">minivan_var_levels</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span></span>
<span>    <span class="va">amces_minivan_mlogit_split</span>,</span>
<span>    by <span class="op">=</span> <span class="fu">join_by</span><span class="op">(</span><span class="va">variable</span> <span class="op">==</span> <span class="va">term</span>, <span class="va">levels</span> <span class="op">==</span> <span class="va">variable_level</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Make these zero</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    <span class="fu">across</span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span>,</span>
<span>      <span class="co"># This is from when this worked with marginaleffects</span></span>
<span>      <span class="co"># c(estimate, conf.low, conf.high),</span></span>
<span>      <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span>, <span class="fl">0</span>, <span class="va">.x</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">minivan_var_lookup</span>, by <span class="op">=</span> <span class="fu">join_by</span><span class="op">(</span><span class="va">variable</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">levels</span>, <span class="va">variable_nice</span><span class="op">)</span>, <span class="op">~</span><span class="fu">fct_inorder</span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span></span>
<span>  <span class="va">plot_data</span>,</span>
<span>  <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">estimate</span>, y <span class="op">=</span> <span class="va">levels</span>, color <span class="op">=</span> <span class="va">variable_nice</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="va">label_pp</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">7</span>, <span class="fl">8</span>, <span class="fl">9</span><span class="op">)</span><span class="op">]</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Percentage point change in\nprobability of minivan selection"</span>,</span>
<span>    y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"Frequentist AMCEs from {mlogit}"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_col</span><span class="op">(</span>facets <span class="op">=</span> <span class="st">"variable_nice"</span>, scales <span class="op">=</span> <span class="st">"free_y"</span>, space <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Combine full dataset of factor levels with marginalized posterior draws and make {brms} plot</summary><div class="sourceCode" id="cb73"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">posterior_mfx_minivan_nested</span> <span class="op">&lt;-</span> <span class="va">amces_minivan_brms</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">separate_wider_delim</span><span class="op">(</span></span>
<span>    <span class="va">contrast</span>,</span>
<span>    delim <span class="op">=</span> <span class="st">" - "</span>, </span>
<span>    names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"variable_level"</span>, <span class="st">"reference_level"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">term</span>, <span class="va">variable_level</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">nest</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_data_minivan_bayes</span> <span class="op">&lt;-</span> <span class="va">minivan_var_levels</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span></span>
<span>    <span class="va">posterior_mfx_minivan_nested</span>,</span>
<span>    by <span class="op">=</span> <span class="fu">join_by</span><span class="op">(</span><span class="va">variable</span> <span class="op">==</span> <span class="va">term</span>, <span class="va">levels</span> <span class="op">==</span> <span class="va">variable_level</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>data <span class="op">=</span> <span class="fu">map_if</span><span class="op">(</span><span class="va">data</span>, <span class="va">is.null</span>, <span class="op">~</span> <span class="fu">tibble</span><span class="op">(</span>avg <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">unnest</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">minivan_var_lookup</span>, by <span class="op">=</span> <span class="fu">join_by</span><span class="op">(</span><span class="va">variable</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">levels</span>, <span class="va">variable_nice</span><span class="op">)</span>, <span class="op">~</span><span class="fu">fct_inorder</span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">plot_data_minivan_bayes</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">avg</span>, y <span class="op">=</span> <span class="va">levels</span>, fill <span class="op">=</span> <span class="va">variable_nice</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span>normalize <span class="op">=</span> <span class="st">"groups"</span><span class="op">)</span> <span class="op">+</span>  <span class="co"># Make the heights of the distributions equal within each facet</span></span>
<span>  <span class="fu">facet_col</span><span class="op">(</span>facets <span class="op">=</span> <span class="st">"variable_nice"</span>, scales <span class="op">=</span> <span class="st">"free_y"</span>, space <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="va">label_pp</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">7</span>, <span class="fl">8</span>, <span class="fl">9</span><span class="op">)</span><span class="op">]</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Percentage point change in\nprobability of minivan selection"</span>,</span>
<span>    y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"Posterior Bayesian AMCEs from {brms}"</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/plot-amces-minivans-both-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-body-outset" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>&nbsp;</p>
</section></section></section><section id="part-3-minivans-repeated-questions-full-hierarchical-multinomial-logit" class="level1 page-columns page-full"><h1>Part 3: Minivans; repeated questions; full hierarchical multinomial logit</h1>
<section id="the-setup-2" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="the-setup-2">The setup</h2>
<p>We’ve cheated a little and have already used multilevel structures in the Bayesian models for the chocolate experiment and the minivan experiment. This was because these datasets had a natural panel grouping structure inside them. {mlogit} can work with panel-indexed data frames (that’s the point of that strange <code>dfidx()</code> function). By creating respondent-specific intercepts like we did with the {brms} models, we helped account for some of the variation caused by respondent differences.</p>
<p>But we can do better than that and get far richer and more complex models and estimates and predictions. In addition to using respondent-specific intercepts, we can (1) include respondent-level characteristics as covariates, and (2) include respondent-specific slopes for the minivan characteristic.</p>
<p>In the minivan data, we have data on feature levels (<code>seat</code>, <code>cargo</code>, <code>eng</code>, <code>price</code>) <em>and</em> on individual characteristics (<code>carpool</code>). The <code>carpool</code> variable indicates if the respondent uses their vehicle for carpooling. This is measured at the respondent level and not the choice level (i.e.&nbsp;someone won’t stop being a carpooler during one set of choices and then resume being a carpooler for another set). We can visualize where these different columns are measured by returning to the hierarchical model diagram:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/minivan-multilevel-structure-annotated-1.svg" class="img-fluid figure-img column-page" style="width:100.0%"></p>
<figcaption>Multilevel experimental structure, with minivan choices <span class="math inline">\(\{y_1, y_2, y_3\}\)</span> nested in sets of questions in respondents, w ith variables measured at different levels</figcaption></figure>
</div>
</div>
</div>
<p>We can use hierarchical models (or multilevel models, or mixed effects models, or whatever you want to call them) to account for choice-level and respondent-level covariates <em>and</em> incorporate respondent-level heterogeneity and covariance into the model estimates.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="img/chelsea-meme.jpg" class="img-fluid figure-img" style="width:50.0%"></p>
<figcaption>Image by <a href="https://twitter.com/chelseaparlett/status/1458461737431146500">Chelsea Parlett-Pelleriti</a></figcaption></figure>
</div>
</section><section id="important-sidenote-on-notation" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="important-sidenote-on-notation">Important sidenote on notation</h2>
<p>But before looking at how to incorporate that <code>carpool</code> column into the model, we need to take a quick little detour into the world of notation. There’s no consistent way of writing out multilevel models,<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> and accordingly, I thought it was impossible to run fully specified marketing-style hierarchical Bayesian models with {brms}—all because of notation!</p>
<div class="no-row-height column-margin column-container"><div id="fn1"><p><sup>1</sup>&nbsp;These are not the only approaches—section 12.5 in <span class="citation" data-cites="GelmanHill:2007">Gelman and Hill (<a href="#ref-GelmanHill:2007" role="doc-biblioref">2007</a>)</span> is called “Five ways to write the same model,” and they don’t include the offset notation as one of their five!</p></div></div><p>There are a couple general ways I’ve seen group-level random effects written out in formal model notation: one with complete random β terms and one with random offsets from a global β term.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
{brms} / {lme4} syntax
</div>
</div>
<div class="callout-body-container callout-body">
<p>For the best overview of how to use {brms} and {lme4} with different random group-level intercept and slope specifications, <a href="https://bbolker.github.io/mixedmodels-misc/glmmFAQ.html#model-specification">check out this summary table by Ben Bolker</a>.</p>
</div>
</div>
<section id="random-intercepts" class="level3"><h3 class="anchored" data-anchor-id="random-intercepts">Random intercepts</h3>
<p>If you want group-specific intercept terms, you can use a formula like this:</p>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">bf</span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">group</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In formal mathy terms, we can write this group-specific intercept as a complete coefficient: <span class="math inline">\(\beta_{0_j}\)</span>. Each group <span class="math inline">\(j\)</span> gets its own intercept coefficient. Nice and straightforward.</p>
<p><span class="math display">\[
\begin{aligned}
Y_{i_j} &amp;\sim \mathcal{N}(\mu_{i_j}, \sigma_y) &amp; \text{Outcome for individual}_i \text{ within group}_j \\
\mu_{i_j} &amp;= \beta_{0_j} + \beta_1 X_{i_j} &amp; \text{Linear model of within-group variation } \\
\beta_{0_j} &amp;\sim \mathcal{N}(\beta_0, \sigma_0) &amp; \text{Random group-specific intercepts}
\end{aligned}
\]</span></p>
<p>However, I actually like to think of these random effects in a slightly different way, where each group intercept is actually a combination of a global average (<span class="math inline">\(\beta_0\)</span>) and a group-specific offset from that average (<span class="math inline">\(b_{0_j}\)</span>), like this:</p>
<p><span class="math display">\[
\beta_{0_j} = \beta_0 + b_{0_j}
\]</span></p>
<p>That offset is assumed to be normally distributed with a mean of 0 (<span class="math inline">\(\mathcal{N}(0, \sigma_0)\)</span>):</p>
<p><span class="math display">\[
\begin{aligned}
Y_{i_j} &amp;\sim \mathcal{N}(\mu_{i_j}, \sigma_y) &amp; \text{Outcome for individual}_i \text{ within group}_j \\
\mu_{i_j} &amp;= (b_{0_j} + \beta_0) + \beta_1 X_{i_j} &amp; \text{Linear model of within-group variation } \\
b_{0_j} &amp;\sim \mathcal{N}(0, \sigma_0) &amp; \text{Random group-specific offsets from global intercept}
\end{aligned}
\]</span></p>
<p>I prefer this offset notation because it aligns with the output of {brms}, which reports population-level coefficients (i.e.&nbsp;the global average <span class="math inline">\(\beta_0\)</span>) along with group-specific offsets from that average (i.e.&nbsp;<span class="math inline">\(b_{0_j}\)</span>), which you can access with <code>ranef(model_name)</code>.</p>
</section><section id="random-slopes" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="random-slopes">Random slopes</h3>
<p>If you want group-specific intercepts <em>and</em> slopes, you can use a formula like this:</p>
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">bf</span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">x</span> <span class="op">|</span> <span class="va">group</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The same dual syntax applies when using random slopes too. We can either use whole group-specific <span class="math inline">\(\beta_{n_j}\)</span> terms, or use offsets (<span class="math inline">\(b_{n_j}\)</span>) from a global average slope (<span class="math inline">\(\beta_n\)</span>). When working with random slopes, the math notation gets a little fancier because the random intercept and slope terms are actually correlated and move together across groups. The <span class="math inline">\(\beta\)</span> terms come from a multivariate (or joint) normal distribution with shared covariance.</p>
<p>With the complete β approach, we’re estimating the joint distribution of <span class="math inline">\(\begin{pmatrix} \beta_{0_j} \\ \beta_{1_j} \end{pmatrix}\)</span>:</p>
<div class="column-page-inset">
<p><span class="math display">\[
\begin{aligned}
Y_{i_j} &amp;\sim \mathcal{N}(\mu_{i_j}, \sigma_y) &amp; \text{Outcome for individual}_i \text{ within group}_j \\
\mu_{i_j} &amp;= \beta_{0_j} + \beta_{1_j} X_{i_j} &amp; \text{Linear model of within-group variation } \\
\left(
  \begin{array}{c}
  \beta_{0_j} \\
  \beta_{1_j}
  \end{array}
\right)
&amp;\sim \operatorname{MV}\, \mathcal{N}
\left(
  \left(
    \begin{array}{c}
    \beta_0 \\
    \beta_1 \\
    \end{array}
  \right)
  , \,
\left(
  \begin{array}{cc}
     \sigma^2_{\beta_0} &amp; \rho_{\beta_0, \beta_1}\, \sigma_{\beta_0} \sigma_{\beta_1} \\
     \dots &amp; \sigma^2_{\beta_1}
  \end{array}
\right)
\right) &amp; \text{Random group-specific slopes and intercepts}
\end{aligned}
\]</span></p>
</div>
<p>With the offset approach, we’re estimating the joint distribution of the offsets from the global intercept and slope, or <span class="math inline">\(\begin{pmatrix} b_{0_j} \\ b_{1_j} \end{pmatrix}\)</span>:</p>
<div class="column-page-inset">
<p><span class="math display">\[
\begin{aligned}
Y_{i_j} &amp;\sim \mathcal{N}(\mu_{i_j}, \sigma_y) &amp; \text{Outcome for individual}_i \text{ within group}_j \\
\mu_{i_j} &amp;= (b_{0_j} + \beta_0) + (b_{1_j} + \beta_1) X_{i_j} &amp; \text{Linear model of within-group variation } \\
\left(
  \begin{array}{c}
  b_{0_j} \\
  b_{1_j}
  \end{array}
\right)
&amp;\sim \operatorname{MV}\, \mathcal{N}
\left(
  \left(
    \begin{array}{c}
    0 \\
    0 \\
    \end{array}
  \right)
  , \,
\left(
  \begin{array}{cc}
     \sigma^2_{\beta_0} &amp; \rho_{\beta_0, \beta_1}\, \sigma_{\beta_0} \sigma_{\beta_1} \\
     \dots &amp; \sigma^2_{\beta_1}
  \end{array}
\right)
\right) &amp; \text{Random group-specific offsets from global intercept and slope}
\end{aligned}
\]</span></p>
</div>
</section><section id="summary-table" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="summary-table">Summary table</h3>
<p>And here’s a helpful little table summarizing these two types of notation (mostly for future me).</p>
<div class="column-page-inset">
<table class="caption-top table">
<colgroup>
<col style="width: 22%">
<col style="width: 22%">
<col style="width: 27%">
<col style="width: 27%">
</colgroup>
<thead><tr class="header">
<th></th>
<th>Formula syntax</th>
<th style="text-align: center;">Full <span class="math inline">\(\beta\)</span> notation</th>
<th style="text-align: center;">Offset notation</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Random intercept</td>
<td><code>y ~ x + (1 | group)</code></td>
<td style="text-align: center;"><span class="math display">\[                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                  \begin{aligned}                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                     Y_{i_j} &amp;\sim \mathcal{N}(\mu_{i_j}, \sigma_y) \\                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                       \mu_{i_j} &amp;= \beta_{0_j} + \beta_1 X_{i_j} \\                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                      \beta_{0_j} &amp;\sim \mathcal{N}(\beta_0, \sigma_0)                                                                                                                                                                                                                                              
                                                                                                                                       \end{aligned}                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                        \]</span></td>
<td style="text-align: center;"><span class="math display">\[                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          \begin{aligned}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       Y_{i_j} &amp;\sim \mathcal{N}(\mu_{i_j}, \sigma_y) \\                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     \mu_{i_j} &amp;= (b_{0_j} + \beta_0) + \beta_1 X_{i_j} \\                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            b_{0_j} &amp;\sim \mathcal{N}(0, \sigma_0)                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         \end{aligned}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                \]</span></td>
</tr>
<tr class="even">
<td>Random intercept + slope</td>
<td><code>y ~ x + (1 + x | group)</code></td>
<td style="text-align: center;"><span class="math display">\[                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                  \begin{aligned}                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                     Y_{i_j} &amp;\sim \mathcal{N}(\mu_{i_j}, \sigma_y) \\                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                     \mu_{i_j} &amp;= \beta_{0_j} + \beta_{1_j} X_{i_j} \\                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                           \left(                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                       \begin{array}{c}                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                        \beta_{0_j} \\                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                         \beta_{1_j}                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                         \end{array}                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                          \right)                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                           &amp;\sim \operatorname{MV}\, \mathcal{N}                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                           \left(                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                            \left(                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                        \begin{array}{c}                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                           \beta_0 \\                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                           \beta_1 \\                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                          \end{array}                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                           \right)                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                         , \, \Sigma                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                         \right) \\                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                        \Sigma &amp;\sim                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                           \left(                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                      \begin{array}{cc}                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                       \sigma^2_{\beta_0} &amp; \rho_{\beta_0, \beta_1}\, \sigma_{\beta_0} \sigma_{\beta_1} \\                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                   \dots &amp; \sigma^2_{\beta_1}                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                         \end{array}                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                          \right)                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                      \end{aligned}                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                        \]</span></td>
<td style="text-align: center;"><span class="math display">\[                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          \begin{aligned}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       Y_{i_j} &amp;\sim \mathcal{N}(\mu_{i_j}, \sigma_y) \\                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               \mu_{i_j} &amp;= (b_{0_j} + \beta_0) + (b_{1_j} + \beta_1) X_{i_j} \\                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            \left(                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \begin{array}{c}                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           b_{0_j} \\                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             b_{1_j}                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           \end{array}                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            \right)                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             &amp;\sim \operatorname{MV}\, \mathcal{N}                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            \left(                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             \left(                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         \begin{array}{c}                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               0 \\                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               0 \\                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            \end{array}                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             \right)                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           , \, \Sigma                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          \right) \\                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         \Sigma &amp;\sim                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            \left(                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \begin{array}{cc}                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \sigma^2_{\beta_0} &amp; \rho_{\beta_0, \beta_1}\, \sigma_{\beta_0} \sigma_{\beta_1} \\                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     \dots &amp; \sigma^2_{\beta_1}                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           \end{array}                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            \right)                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \end{aligned}                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                \]</span></td>
</tr>
</tbody>
</table>
</div>
</section></section><section id="translating-from-marketing-style-stan-notation-to-brms-syntax" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="translating-from-marketing-style-stan-notation-to-brms-syntax">Translating from marketing-style Stan notation to {brms} syntax</h2>
<p>In <span class="citation" data-cites="ChapmanFeit:2019">Chapman and Feit (<a href="#ref-ChapmanFeit:2019" role="doc-biblioref">2019</a>)</span> and in all the marketing papers I’ve seen that use hierarchical Bayesian models—and even one I coauthored! <span class="citation" data-cites="ChaudhryDotsonHeiss:2021">(<a href="#ref-ChaudhryDotsonHeiss:2021" role="doc-biblioref">Chaudhry, Dotson, and Heiss 2021</a>)</span> (<a href="https://stats.andrewheiss.com/who-cares-about-crackdowns/output/appendix.html#model-details">see the appendix</a>)—they define their models using notation like this:</p>
<p><span class="math display">\[
\begin{aligned}
\text{Choice} &amp;\sim \operatorname{Multinomial\ logit}(\beta X) &amp; \text{where } X = \text{feature levels} \\
\beta &amp;\sim \operatorname{Multivariate} \mathcal{N}(\gamma Z, \Sigma) &amp; \text{where } Z = \text{individual characteristics}
\end{aligned}
\]</span></p>
<p>For the longest time this threw me off because it’s slightly different from the two different notations we just reviewed (full βs vs.&nbsp;offsets from global β), and I figured that specifying a model like this with {brms} was impossible. The main reason for my confusion is that there are two different datasets involved in this model, and {brms} can only really work with one dataset.</p>
<p>In raw Stan (like <a href="https://github.com/ksvanhorn/ART-Forum-2017-Stan-Tutorial">in this tutorial on conjoint hierarchical Bayes models</a>, or in <a href="https://github.com/Bartosz-G/Conjoint-Analysis-in-R/">this example of a different conjoint hierarchical model</a>), you’d typically work with two different datasets or matrices: one <span class="math inline">\(X\)</span> with feature levels and one <span class="math inline">\(Z\)</span> with respondent-level characteristics. (<a href="https://mc-stan.org/docs/stan-users-guide/multivariate-hierarchical-priors.html">This is actually the recommended way to write hierarchical models in raw Stan!</a>).</p>
<p>Here’s what separate <span class="math inline">\(X\)</span> and <span class="math inline">\(Z\)</span> matrices would look like with the minivan data—<code>X</code> contains the full data without respondent-level covariates like <code>carpool</code> and it has 9,000 rows; <code>Z</code> contains only respondent-level characteristics like <code>carpool</code> and it only has 200 rows (one per respondent).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">X</span> <span class="op">&lt;-</span> <span class="va">minivans</span> <span class="op">%&gt;%</span> <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">carpool</span><span class="op">)</span></span>
<span><span class="va">X</span></span>
<span><span class="co">## # A tibble: 9,000 × 8</span></span>
<span><span class="co">##    resp.id  ques   alt seat  cargo eng   price choice</span></span>
<span><span class="co">##      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt;  &lt;dbl&gt;</span></span>
<span><span class="co">##  1       1     1     1 6     2ft   gas   35         0</span></span>
<span><span class="co">##  2       1     1     2 8     3ft   hyb   30         0</span></span>
<span><span class="co">##  3       1     1     3 6     3ft   gas   30         1</span></span>
<span><span class="co">##  4       1     2     1 6     2ft   gas   30         0</span></span>
<span><span class="co">##  5       1     2     2 7     3ft   gas   35         1</span></span>
<span><span class="co">##  6       1     2     3 6     2ft   elec  35         0</span></span>
<span><span class="co">##  7       1     3     1 8     3ft   gas   35         1</span></span>
<span><span class="co">##  8       1     3     2 7     3ft   elec  30         0</span></span>
<span><span class="co">##  9       1     3     3 8     2ft   elec  40         0</span></span>
<span><span class="co">## 10       1     4     1 7     3ft   elec  40         1</span></span>
<span><span class="co">## # ℹ 8,990 more rows</span></span>
<span></span>
<span><span class="va">Z</span> <span class="op">&lt;-</span> <span class="va">minivans</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Only keep the first row of each respondent</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">resp.id</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">slice</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Only keep the respondent-level columns</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">resp.id</span>, <span class="va">carpool</span><span class="op">)</span></span>
<span><span class="va">Z</span></span>
<span><span class="co">## # A tibble: 200 × 2</span></span>
<span><span class="co">##    resp.id carpool</span></span>
<span><span class="co">##      &lt;dbl&gt; &lt;fct&gt;  </span></span>
<span><span class="co">##  1       1 yes    </span></span>
<span><span class="co">##  2       2 no     </span></span>
<span><span class="co">##  3       3 no     </span></span>
<span><span class="co">##  4       4 no     </span></span>
<span><span class="co">##  5       5 yes    </span></span>
<span><span class="co">##  6       6 no     </span></span>
<span><span class="co">##  7       7 no     </span></span>
<span><span class="co">##  8       8 yes    </span></span>
<span><span class="co">##  9       9 no     </span></span>
<span><span class="co">## 10      10 no     </span></span>
<span><span class="co">## # ℹ 190 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>X</code> and <code>Z</code> are then passed to Stan as separate matrices and used at different places in the model fitting process. Here’s what that looks like in pseudo-Stan code. The matrix of individual characteristics <code>Z</code> is matrix-multiplied with a bunch of estimated <span class="math inline">\(\gamma\)</span> coefficients (<code>Gamma</code> here) to generate individual-specific <span class="math inline">\(\beta\)</span> coefficients (<code>Beta</code> here). The matrix of choices <code>X</code> is then matrix-multiplied with the individual-specific <span class="math inline">\(\beta\)</span> coefficients to generate predicted outcomes (<code>Y</code> here).</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (r <span class="cf">in</span> <span class="dv">1</span>:n_respondents) {</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// All the individual-specific slopes and intercepts</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>  Beta[,r] ~ multi_normal(Gamma * Z[,r], ...);</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// All the question-level outcomes, using individual-specific slopes and intercepts</span></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (s <span class="cf">in</span> <span class="dv">1</span>:n_questions) {</span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>     Y[r,s] ~ categorical_logit( X [r,s] * Beta[,r]);</span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>That’s a neat way of working with multilevel models, but it’s different from how I’ve always worked with them (and it requires working with raw Stan). As seen throughout this post, I’m a fan of {brms}’s formula-style syntax for specifying multilevel models, but {brms} can only work with one dataset at a time—you can’t pass it both <code>X</code> and <code>Z</code> like you’d do with raw Stan. So I (naively) figured that this went beyond {brms}’s abilities and was only possible with raw Stan.</p>
<p>However, if we use {brms}’s <a href="https://cran.r-project.org/web/packages/brms/vignettes/brms_multilevel.pdf">special formula syntax</a>, we can actually specify an identical model with only one dataset (again, <a href="https://bbolker.github.io/mixedmodels-misc/glmmFAQ.html#model-specification">see this for a fantastic overview of the syntax</a>).</p>
<p>First, let’s look at the marketing-style syntax again:</p>
<p><span class="math display">\[
\begin{aligned}
\text{Choice} &amp;\sim \operatorname{Multinomial\ logit}(\beta X) &amp; \text{where } X = \text{feature levels} \\
\beta &amp;\sim \operatorname{Multivariate} \mathcal{N}(\gamma Z, \Sigma) &amp; \text{where } Z = \text{individual characteristics}
\end{aligned}
\]</span></p>
<p>This is actually just a kind of <em>really</em> compact notation. That second line with the <span class="math inline">\(\beta \sim \operatorname{Multivariate}\, \mathcal{N}(\cdot)\)</span> distribution is a shorthand version of the full-β syntax from earlier. To illustrate this, let’s expand this out to a more complete formal definition of the model. Instead of using <span class="math inline">\(X\)</span> to stand in for all the feature levels and <span class="math inline">\(Z\)</span> for all the individual characteristics, we’ll expand those to include all the covariates we’re using. And instead of calling the distribution “Multinomial logit” we’ll call it “Categorical” so it aligns with Stan. It’ll make for a <em>really massive formula</em>, but it shows what’s really going on.</p>
<div class="column-page-inset">
<p><span class="math display">\[
\begin{aligned}
&amp;\ \textbf{Multinomial probability of selection of choice}_i \textbf{ in respondent}_j \\
\text{Choice}_{i_j} \sim&amp;\ \operatorname{Categorical}(\{\mu_{1,i_j}, \mu_{2,i_j}, \mu_{3,i_j}\}) \\[10pt]
&amp;\ \textbf{Model for probability of each option} \\
\{\mu_{1,i_j}, \mu_{2,i_j}, \mu_{3,i_j}\} =&amp;\ \beta_{0_j} + \beta_{1_j} \text{Seat[7]}_{i_j} + \beta_{2_j} \text{Seat[8]}_{i_j} + \beta_{3_j} \text{Cargo[3ft]}_{i_j} + \\
&amp;\ \beta_{4_j} \text{Engine[hyb]}_{i_j} + \beta_{5_j} \text{Engine[elec]}_{i_j} + \\
&amp;\ \beta_{6_j} \text{Price[35k]}_{i_j} + \beta_{7_j} \text{Price[40k]}_{i_j} \\[20pt]  
&amp;\ \textbf{Respondent-specific slopes} \\
\left(
  \begin{array}{c}
    \begin{aligned}
      &amp;\beta_{0_j} \\
      &amp;\beta_{1_j} \\
      &amp;\beta_{2_j} \\
      &amp;\beta_{3_j} \\
      &amp;\beta_{4_j} \\
      &amp;\beta_{5_j} \\
      &amp;\beta_{6_j} \\
      &amp;\beta_{7_j}
    \end{aligned}
  \end{array}
\right) \sim&amp;\ \operatorname{Multivariate}\ \mathcal{N} \left[
\left(
  \begin{array}{c}
    \begin{aligned}
      &amp;\gamma^{\beta_{0}}_{0} + \gamma^{\beta_{0}}_{1}\text{Carpool} \\
      &amp;\gamma^{\beta_{1}}_{0} + \gamma^{\beta_{1}}_{1}\text{Carpool} \\
      &amp;\gamma^{\beta_{2}}_{0} + \gamma^{\beta_{2}}_{1}\text{Carpool} \\
      &amp;\gamma^{\beta_{3}}_{0} + \gamma^{\beta_{3}}_{1}\text{Carpool} \\
      &amp;\gamma^{\beta_{4}}_{0} + \gamma^{\beta_{4}}_{1}\text{Carpool} \\
      &amp;\gamma^{\beta_{5}}_{0} + \gamma^{\beta_{5}}_{1}\text{Carpool} \\
      &amp;\gamma^{\beta_{6}}_{0} + \gamma^{\beta_{6}}_{1}\text{Carpool} \\
      &amp;\gamma^{\beta_{7}}_{0} + \gamma^{\beta_{7}}_{1}\text{Carpool}
    \end{aligned}
  \end{array}
\right)
,
\left(
  \begin{array}{cccccccc}
     \sigma^2_{\beta_{0j}} &amp; \rho_{\beta_{0j}\beta_{1j}} &amp; \rho_{\beta_{0j}\beta_{2j}} &amp; \rho_{\beta_{0j}\beta_{3j}} &amp; \rho_{\beta_{0j}\beta_{4j}} &amp; \rho_{\beta_{0j}\beta_{5j}} &amp; \rho_{\beta_{0j}\beta_{6j}} &amp; \rho_{\beta_{0j}\beta_{7j}} \\
     \dots &amp; \sigma^2_{\beta_{1j}} &amp; \rho_{\beta_{1j}\beta_{2j}} &amp; \rho_{\beta_{1j}\beta_{3j}} &amp; \rho_{\beta_{1j}\beta_{4j}} &amp; \rho_{\beta_{1j}\beta_{5j}} &amp; \rho_{\beta_{1j}\beta_{6j}} &amp; \rho_{\beta_{1j}\beta_{7j}} \\
     \dots &amp; \dots &amp; \sigma^2_{\beta_{2j}} &amp; \rho_{\beta_{2j}\beta_{3j}} &amp; \rho_{\beta_{2j}\beta_{4j}} &amp; \rho_{\beta_{2j}\beta_{5j}} &amp; \rho_{\beta_{2j}\beta_{6j}} &amp; \rho_{\beta_{2j}\beta_{7j}} \\
     \dots &amp; \dots &amp; \dots &amp; \sigma^2_{\beta_{3j}} &amp; \rho_{\beta_{3j}\beta_{4j}} &amp; \rho_{\beta_{3j}\beta_{5j}} &amp; \rho_{\beta_{3j}\beta_{6j}} &amp; \rho_{\beta_{3j}\beta_{7j}} \\
     \dots &amp; \dots &amp; \dots &amp; \dots &amp; \sigma^2_{\beta_{4j}} &amp; \rho_{\beta_{4j}\beta_{5j}} &amp; \rho_{\beta_{4j}\beta_{6j}} &amp; \rho_{\beta_{4j}\beta_{7j}} \\
     \dots &amp; \dots &amp; \dots &amp; \dots &amp; \dots &amp; \sigma^2_{\beta_{5j}} &amp; \rho_{\beta_{5j}\beta_{6j}} &amp; \rho_{\beta_{5j}\beta_{7j}} \\
     \dots &amp; \dots &amp; \dots &amp; \dots &amp; \dots &amp; \dots &amp; \sigma^2_{\beta_{6j}} &amp; \rho_{\beta_{6j}\beta_{7j}} \\
     \dots &amp; \dots &amp; \dots &amp; \dots &amp; \dots &amp; \dots &amp; \dots &amp; \sigma^2_{\beta_{7j}}
  \end{array}
\right)
\right]
\end{aligned}
\]</span></p>
</div>
<p>&nbsp;</p>
<p>Importantly, pay attention to where the choice-level and respondent-level variables show up in this expanded version. All the choice-level variables have respondent-specific <span class="math inline">\(\beta\)</span> coefficients, while the respondent-level variable (<code>carpool</code>) is down in that massive multivariate normal matrix with its own <span class="math inline">\(\gamma\)</span> coefficients, helping determine the respondent-specific <span class="math inline">\(\beta\)</span> coefficients. That’s great and exactly what we want, and we can do that with raw Stan, but raw Stan is no fun.</p>
<p>We can create this exact same model structure with {brms} like this:</p>
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">bf</span><span class="op">(</span><span class="va">choice_alt</span> <span class="op">~</span></span>
<span>  <span class="co"># Choice-level predictors that are nested within respondents...</span></span>
<span>  <span class="op">(</span><span class="va">seat</span> <span class="op">+</span> <span class="va">cargo</span> <span class="op">+</span> <span class="va">eng</span> <span class="op">+</span> <span class="va">price</span><span class="op">)</span> <span class="op">*</span></span>
<span>  <span class="co"># ...interacted with all respondent-level predictors...</span></span>
<span>  <span class="op">(</span><span class="va">carpool</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># ... with random respondent-specific slopes for the</span></span>
<span>  <span class="co"># nested choice-level predictors</span></span>
<span>  <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">seat</span> <span class="op">+</span> <span class="va">cargo</span> <span class="op">+</span> <span class="va">eng</span> <span class="op">+</span> <span class="va">price</span> <span class="op">|</span> <span class="va">resp.id</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We can confirm that this worked by using <a href="https://datalorax.github.io/equatiomatic/">the miraculous {equatiomatic} package</a>, which automatically converts model objects into LaTeX code. {equatiomatic} doesn’t work with {brms} models, but it does work with frequentist {lme4} models, so we can fit a throwaway frequentist model with this syntax (it won’t actually converge and it’ll give a warning, but that’s fine—we don’t actually care about this model) and then feed it to <code>equatiomatic::extract_eq()</code> to see what it looks like in formal notation.</p>
<p>(This is actually how I figured out the correct combination of interactions and random slopes—I kept trying different combinations that I thought were right until the math matched the huge full model above, with the <span class="math inline">\(\beta\)</span> and <span class="math inline">\(\gamma\)</span> terms in the right places.)</p>
<div class="cell column-page" data-layout-align="center">
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lme4/lme4/">lme4</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/datalorax/equatiomatic">equatiomatic</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_throwaway</span> <span class="op">&lt;-</span> <span class="fu">lmer</span><span class="op">(</span></span>
<span>  <span class="va">choice</span> <span class="op">~</span> <span class="op">(</span><span class="va">seat</span> <span class="op">+</span> <span class="va">cargo</span> <span class="op">+</span> <span class="va">eng</span> <span class="op">+</span> <span class="va">price</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">carpool</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">seat</span> <span class="op">+</span> <span class="va">cargo</span> <span class="op">+</span> <span class="va">eng</span> <span class="op">+</span> <span class="va">price</span> <span class="op">|</span> <span class="va">resp.id</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">minivans</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu">extract_eq</span><span class="op">(</span><span class="va">model_throwaway</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><span class="math display">\[
\begin{aligned}
  \operatorname{choice}_{i}  &amp;\sim N \left(\mu, \sigma^2 \right) \\
    \mu &amp;=\alpha_{j[i]} + \beta_{1j[i]}(\operatorname{seat}_{\operatorname{7}}) + \beta_{2j[i]}(\operatorname{seat}_{\operatorname{8}}) + \beta_{3j[i]}(\operatorname{cargo}_{\operatorname{3ft}}) + \beta_{4j[i]}(\operatorname{eng}_{\operatorname{hyb}}) + \beta_{5j[i]}(\operatorname{eng}_{\operatorname{elec}}) + \beta_{6j[i]}(\operatorname{price}_{\operatorname{35}}) + \beta_{7j[i]}(\operatorname{price}_{\operatorname{40}}) \\    
\left(
  \begin{array}{c}
    \begin{aligned}
      &amp;\alpha_{j} \\
      &amp;\beta_{1j} \\
      &amp;\beta_{2j} \\
      &amp;\beta_{3j} \\
      &amp;\beta_{4j} \\
      &amp;\beta_{5j} \\
      &amp;\beta_{6j} \\
      &amp;\beta_{7j}
    \end{aligned}
  \end{array}
\right)
  &amp;\sim N \left(
\left(
  \begin{array}{c}
    \begin{aligned}
      &amp;\gamma_{0}^{\alpha} + \gamma_{1}^{\alpha}(\operatorname{carpool}_{\operatorname{yes}}) \\
      &amp;\gamma^{\beta_{1}}_{0} + \gamma^{\beta_{1}}_{1}(\operatorname{carpool}_{\operatorname{yes}}) \\
      &amp;\gamma^{\beta_{2}}_{0} + \gamma^{\beta_{2}}_{1}(\operatorname{carpool}_{\operatorname{yes}}) \\
      &amp;\gamma^{\beta_{3}}_{0} + \gamma^{\beta_{3}}_{1}(\operatorname{carpool}_{\operatorname{yes}}) \\
      &amp;\gamma^{\beta_{4}}_{0} + \gamma^{\beta_{4}}_{1}(\operatorname{carpool}_{\operatorname{yes}}) \\
      &amp;\gamma^{\beta_{5}}_{0} + \gamma^{\beta_{5}}_{1}(\operatorname{carpool}_{\operatorname{yes}}) \\
      &amp;\gamma^{\beta_{6}}_{0} + \gamma^{\beta_{6}}_{1}(\operatorname{carpool}_{\operatorname{yes}}) \\
      &amp;\gamma^{\beta_{7}}_{0} + \gamma^{\beta_{7}}_{1}(\operatorname{carpool}_{\operatorname{yes}})
    \end{aligned}
  \end{array}
\right)
,
\left(
  \begin{array}{cccccccc}
     \sigma^2_{\alpha_{j}} &amp; \rho_{\alpha_{j}\beta_{1j}} &amp; \rho_{\alpha_{j}\beta_{2j}} &amp; \rho_{\alpha_{j}\beta_{3j}} &amp; \rho_{\alpha_{j}\beta_{4j}} &amp; \rho_{\alpha_{j}\beta_{5j}} &amp; \rho_{\alpha_{j}\beta_{6j}} &amp; \rho_{\alpha_{j}\beta_{7j}} \\
     \rho_{\beta_{1j}\alpha_{j}} &amp; \sigma^2_{\beta_{1j}} &amp; \rho_{\beta_{1j}\beta_{2j}} &amp; \rho_{\beta_{1j}\beta_{3j}} &amp; \rho_{\beta_{1j}\beta_{4j}} &amp; \rho_{\beta_{1j}\beta_{5j}} &amp; \rho_{\beta_{1j}\beta_{6j}} &amp; \rho_{\beta_{1j}\beta_{7j}} \\
     \rho_{\beta_{2j}\alpha_{j}} &amp; \rho_{\beta_{2j}\beta_{1j}} &amp; \sigma^2_{\beta_{2j}} &amp; \rho_{\beta_{2j}\beta_{3j}} &amp; \rho_{\beta_{2j}\beta_{4j}} &amp; \rho_{\beta_{2j}\beta_{5j}} &amp; \rho_{\beta_{2j}\beta_{6j}} &amp; \rho_{\beta_{2j}\beta_{7j}} \\
     \rho_{\beta_{3j}\alpha_{j}} &amp; \rho_{\beta_{3j}\beta_{1j}} &amp; \rho_{\beta_{3j}\beta_{2j}} &amp; \sigma^2_{\beta_{3j}} &amp; \rho_{\beta_{3j}\beta_{4j}} &amp; \rho_{\beta_{3j}\beta_{5j}} &amp; \rho_{\beta_{3j}\beta_{6j}} &amp; \rho_{\beta_{3j}\beta_{7j}} \\
     \rho_{\beta_{4j}\alpha_{j}} &amp; \rho_{\beta_{4j}\beta_{1j}} &amp; \rho_{\beta_{4j}\beta_{2j}} &amp; \rho_{\beta_{4j}\beta_{3j}} &amp; \sigma^2_{\beta_{4j}} &amp; \rho_{\beta_{4j}\beta_{5j}} &amp; \rho_{\beta_{4j}\beta_{6j}} &amp; \rho_{\beta_{4j}\beta_{7j}} \\
     \rho_{\beta_{5j}\alpha_{j}} &amp; \rho_{\beta_{5j}\beta_{1j}} &amp; \rho_{\beta_{5j}\beta_{2j}} &amp; \rho_{\beta_{5j}\beta_{3j}} &amp; \rho_{\beta_{5j}\beta_{4j}} &amp; \sigma^2_{\beta_{5j}} &amp; \rho_{\beta_{5j}\beta_{6j}} &amp; \rho_{\beta_{5j}\beta_{7j}} \\
     \rho_{\beta_{6j}\alpha_{j}} &amp; \rho_{\beta_{6j}\beta_{1j}} &amp; \rho_{\beta_{6j}\beta_{2j}} &amp; \rho_{\beta_{6j}\beta_{3j}} &amp; \rho_{\beta_{6j}\beta_{4j}} &amp; \rho_{\beta_{6j}\beta_{5j}} &amp; \sigma^2_{\beta_{6j}} &amp; \rho_{\beta_{6j}\beta_{7j}} \\
     \rho_{\beta_{7j}\alpha_{j}} &amp; \rho_{\beta_{7j}\beta_{1j}} &amp; \rho_{\beta_{7j}\beta_{2j}} &amp; \rho_{\beta_{7j}\beta_{3j}} &amp; \rho_{\beta_{7j}\beta_{4j}} &amp; \rho_{\beta_{7j}\beta_{5j}} &amp; \rho_{\beta_{7j}\beta_{6j}} &amp; \sigma^2_{\beta_{7j}}
  \end{array}
\right)
\right)
    \text{, for resp.id j = 1,} \dots \text{,J}
\end{aligned}
\]</span></p>
</div>
<section id="different-variations-of-group-level-interactions" class="level3"><h3 class="anchored" data-anchor-id="different-variations-of-group-level-interactions">Different variations of group-level interactions</h3>
<p>This syntax is a special R shortcut for interacting <code>carpool</code> with each of the feature variables:</p>
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Short way</span></span>
<span><span class="op">(</span><span class="va">seat</span> <span class="op">+</span> <span class="va">cargo</span> <span class="op">+</span> <span class="va">eng</span> <span class="op">+</span> <span class="va">price</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">carpool</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># This expands to this</span></span>
<span><span class="va">seat</span><span class="op">*</span><span class="va">carpool</span> <span class="op">+</span> <span class="va">cargo</span><span class="op">*</span><span class="va">carpool</span> <span class="op">+</span> <span class="va">eng</span><span class="op">*</span><span class="va">carpool</span> <span class="op">+</span> <span class="va">price</span><span class="op">*</span><span class="va">carpool</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If we had other respondent-level columns like age (<code>age</code>) and education (<code>ed</code>), the shortcut syntax is really helpful:</p>
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Short way</span></span>
<span><span class="op">(</span><span class="va">seat</span> <span class="op">+</span> <span class="va">cargo</span> <span class="op">+</span> <span class="va">eng</span> <span class="op">+</span> <span class="va">price</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">carpool</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> <span class="va">ed</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># This expands to this</span></span>
<span><span class="va">seat</span><span class="op">*</span><span class="va">carpool</span> <span class="op">+</span> <span class="va">cargo</span><span class="op">*</span><span class="va">carpool</span> <span class="op">+</span> <span class="va">eng</span><span class="op">*</span><span class="va">carpool</span> <span class="op">+</span> <span class="va">price</span><span class="op">*</span><span class="va">carpool</span> <span class="op">+</span></span>
<span><span class="va">seat</span><span class="op">*</span><span class="va">age</span> <span class="op">+</span> <span class="va">cargo</span><span class="op">*</span><span class="va">age</span> <span class="op">+</span> <span class="va">eng</span><span class="op">*</span><span class="va">age</span> <span class="op">+</span> <span class="va">price</span><span class="op">*</span><span class="va">age</span> <span class="op">+</span></span>
<span><span class="va">seat</span><span class="op">*</span><span class="va">ed</span> <span class="op">+</span> <span class="va">cargo</span><span class="op">*</span><span class="va">ed</span> <span class="op">+</span> <span class="va">eng</span><span class="op">*</span><span class="va">ed</span> <span class="op">+</span> <span class="va">price</span><span class="op">*</span><span class="va">ed</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We don’t necessarily need to fully interact everything. For instance, if we have theoretical reasons to think that carpool status is associated with seat count preferences, but not other features, we can only interact <code>seat</code> and <code>carpool</code>:</p>
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">bf</span><span class="op">(</span><span class="va">choice</span> <span class="op">~</span> </span>
<span>    <span class="op">(</span><span class="va">seat</span> <span class="op">*</span> <span class="va">carpool</span><span class="op">)</span> <span class="op">+</span> <span class="va">cargo</span> <span class="op">+</span> <span class="va">eng</span> <span class="op">+</span> <span class="va">price</span> <span class="op">+</span> </span>
<span>  <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">seat</span> <span class="op">+</span> <span class="va">cargo</span> <span class="op">+</span> <span class="va">eng</span> <span class="op">+</span> <span class="va">price</span> <span class="op">|</span> <span class="va">resp.id</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Model running times
</div>
</div>
<div class="callout-body-container callout-body">
<p>The more individual-level interactions you add, the longer it will take for the model to run. As we’ll see below, interacting <code>carpool</code> with the four feature levels takes ≈30 minutes to fit. As you add more individual-level interactions, the running time blows up.</p>
<p>In the replication code for <span class="citation" data-cites="JensenMarbleScheve:2021">Jensen et al. (<a href="#ref-JensenMarbleScheve:2021" role="doc-biblioref">2021</a>)</span>, where they model a ton of individual variables, they say it takes several days to run. Our models in <span class="citation" data-cites="ChaudhryDotsonHeiss:2021">Chaudhry, Dotson, and Heiss (<a href="#ref-ChaudhryDotsonHeiss:2021" role="doc-biblioref">2021</a>)</span> take hours and hours to run.</p>
</div>
</div>
</section></section><section id="mlogit-model-2" class="level2"><h2 class="anchored" data-anchor-id="mlogit-model-2">
<code>mlogit</code> model</h2>
<p>{mlogit} can estimate hierarchical models with something like this:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Define the random parameters</span></span>
<span><span class="va">model_mlogit_rpar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"n"</span>, length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">model_minivans_mlogit</span><span class="op">$</span><span class="va">coef</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">model_mlogit_rpar</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">model_minivans_mlogit</span><span class="op">$</span><span class="va">coef</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># This means these random terms are all normally distributed</span></span>
<span><span class="va">model_mlogit_rpar</span></span>
<span><span class="co">#&gt; seat7    seat8 cargo3ft   enghyb  engelec  price35  price40 </span></span>
<span><span class="co">#&gt;   "n"      "n"      "n"      "n"      "n"      "n"      "n" </span></span>
<span></span>
<span><span class="co"># Run the model with carpool as an individual-level covariate</span></span>
<span><span class="va">model_mlogit_hierarchical</span> <span class="op">&lt;-</span> <span class="fu">mlogit</span><span class="op">(</span></span>
<span>  <span class="va">choice</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">seat</span> <span class="op">+</span> <span class="va">eng</span> <span class="op">+</span> <span class="va">cargo</span> <span class="op">+</span> <span class="va">price</span> <span class="op">|</span> <span class="va">carpool</span>,</span>
<span>  data <span class="op">=</span> <span class="va">minivans_idx</span>,</span>
<span>  panel <span class="op">=</span> <span class="cn">TRUE</span>, rpar <span class="op">=</span> <span class="va">model_mlogit_rpar</span>, correlation <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Show the results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">model_mlogit_hierarchical</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>However, I’m not a frequentist and I’m already not a huge fan of extracting the predictions and AMCEs from these {mlogit} models. Running and interpreting and working with the results of that object is left as an exercise for the reader :). (See p.&nbsp;381 in <span class="citation" data-cites="ChapmanFeit:2019">Chapman and Feit (<a href="#ref-ChapmanFeit:2019" role="doc-biblioref">2019</a>)</span> for a worked example of how to do it.)</p>
</section><section id="finally-the-full-brms-model" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="finally-the-full-brms-model">Finally, the full {brms} model</h2>
<p>This is a really complex model with a ton of moving parts, but it’s also incredibly powerful. It lets us account for individual-specific differences across each of the minivan features. For instance, whether an individual carpools probably influences their preferences for the number of seats, and maybe cargo space, but probably doesn’t influence their preferences for engine type. If we had other individual-level characteristics, we could also let those influence feature preferences. Like, the number of kids an individual has probably influences seat count preferences; the individual’s income probably influences their price preferences; and so on.</p>
<p>Let’s define the model more formally again, this time with priors for the parameters we’ll be estimating:</p>
<div class="column-page-inset">
<p><span class="math display">\[
\begin{aligned}
&amp;\ \textbf{Multinomial probability of selection of choice}_i \textbf{ in respondent}_j \\
\text{Choice}_{i_j} \sim&amp;\ \operatorname{Categorical}(\{\mu_{1,i_j}, \mu_{2,i_j}, \mu_{3,i_j}\}) \\[10pt]
&amp;\ \textbf{Model for probability of each option} \\
\{\mu_{1,i_j}, \mu_{2,i_j}, \mu_{3,i_j}\} =&amp;\ \beta_{0_j} + \beta_{1_j} \text{Seat[7]}_{i_j} + \beta_{2_j} \text{Seat[8]}_{i_j} + \beta_{3_j} \text{Cargo[3ft]}_{i_j} + \\
&amp;\ \beta_{4_j} \text{Engine[hyb]}_{i_j} + \beta_{5_j} \text{Engine[elec]}_{i_j} + \\
&amp;\ \beta_{6_j} \text{Price[35k]}_{i_j} + \beta_{7_j} \text{Price[40k]}_{i_j} \\[20pt]  
&amp;\ \textbf{Respondent-specific slopes} \\
\left(
  \begin{array}{c}
    \begin{aligned}
      &amp;\beta_{0_j} \\
      &amp;\beta_{1_j} \\
      &amp;\beta_{2_j} \\
      &amp;\beta_{3_j} \\
      &amp;\beta_{4_j} \\
      &amp;\beta_{5_j} \\
      &amp;\beta_{6_j} \\
      &amp;\beta_{7_j}
    \end{aligned}
  \end{array}
\right) \sim&amp;\ \operatorname{Multivariate}\ \mathcal{N} \left[
\left(
  \begin{array}{c}
    \begin{aligned}
      &amp;\gamma^{\beta_{0}}_{0} + \gamma^{\beta_{0}}_{1}\text{Carpool} \\
      &amp;\gamma^{\beta_{1}}_{0} + \gamma^{\beta_{1}}_{1}\text{Carpool} \\
      &amp;\gamma^{\beta_{2}}_{0} + \gamma^{\beta_{2}}_{1}\text{Carpool} \\
      &amp;\gamma^{\beta_{3}}_{0} + \gamma^{\beta_{3}}_{1}\text{Carpool} \\
      &amp;\gamma^{\beta_{4}}_{0} + \gamma^{\beta_{4}}_{1}\text{Carpool} \\
      &amp;\gamma^{\beta_{5}}_{0} + \gamma^{\beta_{5}}_{1}\text{Carpool} \\
      &amp;\gamma^{\beta_{6}}_{0} + \gamma^{\beta_{6}}_{1}\text{Carpool} \\
      &amp;\gamma^{\beta_{7}}_{0} + \gamma^{\beta_{7}}_{1}\text{Carpool}
    \end{aligned}
  \end{array}
\right)
,
\left(
  \begin{array}{cccccccc}
     \sigma^2_{\beta_{0j}} &amp; \rho_{\beta_{0j}\beta_{1j}} &amp; \rho_{\beta_{0j}\beta_{2j}} &amp; \rho_{\beta_{0j}\beta_{3j}} &amp; \rho_{\beta_{0j}\beta_{4j}} &amp; \rho_{\beta_{0j}\beta_{5j}} &amp; \rho_{\beta_{0j}\beta_{6j}} &amp; \rho_{\beta_{0j}\beta_{7j}} \\
     \dots &amp; \sigma^2_{\beta_{1j}} &amp; \rho_{\beta_{1j}\beta_{2j}} &amp; \rho_{\beta_{1j}\beta_{3j}} &amp; \rho_{\beta_{1j}\beta_{4j}} &amp; \rho_{\beta_{1j}\beta_{5j}} &amp; \rho_{\beta_{1j}\beta_{6j}} &amp; \rho_{\beta_{1j}\beta_{7j}} \\
     \dots &amp; \dots &amp; \sigma^2_{\beta_{2j}} &amp; \rho_{\beta_{2j}\beta_{3j}} &amp; \rho_{\beta_{2j}\beta_{4j}} &amp; \rho_{\beta_{2j}\beta_{5j}} &amp; \rho_{\beta_{2j}\beta_{6j}} &amp; \rho_{\beta_{2j}\beta_{7j}} \\
     \dots &amp; \dots &amp; \dots &amp; \sigma^2_{\beta_{3j}} &amp; \rho_{\beta_{3j}\beta_{4j}} &amp; \rho_{\beta_{3j}\beta_{5j}} &amp; \rho_{\beta_{3j}\beta_{6j}} &amp; \rho_{\beta_{3j}\beta_{7j}} \\
     \dots &amp; \dots &amp; \dots &amp; \dots &amp; \sigma^2_{\beta_{4j}} &amp; \rho_{\beta_{4j}\beta_{5j}} &amp; \rho_{\beta_{4j}\beta_{6j}} &amp; \rho_{\beta_{4j}\beta_{7j}} \\
     \dots &amp; \dots &amp; \dots &amp; \dots &amp; \dots &amp; \sigma^2_{\beta_{5j}} &amp; \rho_{\beta_{5j}\beta_{6j}} &amp; \rho_{\beta_{5j}\beta_{7j}} \\
     \dots &amp; \dots &amp; \dots &amp; \dots &amp; \dots &amp; \dots &amp; \sigma^2_{\beta_{6j}} &amp; \rho_{\beta_{6j}\beta_{7j}} \\
     \dots &amp; \dots &amp; \dots &amp; \dots &amp; \dots &amp; \dots &amp; \dots &amp; \sigma^2_{\beta_{7j}}
  \end{array}
\right)
\right] \\[10pt]
&amp;\ \textbf{Priors} \\
\beta_{0 \dots 7} \sim&amp;\ \mathcal{N} (0, 3) \qquad\qquad\ [\text{Prior for choice-level coefficients}] \\
\gamma^{\beta_{0 \dots 7}}_0 \sim&amp;\ \mathcal{N} (0, 3) \qquad\qquad\ [\text{Prior for individual-level coefficients}] \\
\sigma_{\beta_{0 \dots 7}} \sim&amp;\ \operatorname{Exponential}(1) \qquad [\text{Prior for between-respondent intercept and slope variability}] \\
\rho \sim&amp;\ \operatorname{LKJ}(1) \qquad\qquad [\text{Prior for correlation between random slopes and intercepts}]
\end{aligned}
\]</span></p>
</div>
<p>&nbsp;</p>
<p>Here it is in code form. There are a couple new things here in the Stan settings. First, we’re going to create 4 MCMC chains with 4,000 draws rather than 2,000—there are so many parameters to be estimated that we need to let the simulation run longer. Second, we’ve modified the <code>adapt_delta</code> setting to 0.99. Conceptually, this adjusts the size of the steps the MCMC algorithm takes as it traverses the posterior space for each parameter—higher numbers make the steps smaller and more granular. This slows down the MCMC simulation, but it also helps avoid divergent transitions (or failed out-of-bounds draws).</p>
<p>On my 2021 M1 MacBook Pro, running through cmdstanr with 2 CPU cores per chain, it took about 30 minutes to fit. If you’re following along with this post, start running this and go get some lunch or go for a walk or something.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Pre-run model
</div>
</div>
<div class="callout-body-container callout-body">
<p>Alternatively, you can download <a href="https://osf.io/zp6eh">an .rds file of this completed</a>. This <code>brm()</code> code load the .rds file automatically instead of rerunning the model as long as you put it in a folder named “models” in your working directory. This code uses the <a href="https://docs.ropensci.org/osfr/">{osfr} package</a> to download <a href="https://osf.io/zp6eh">the .rds file from OSF</a> automatically and places it where it needs to go:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/osfr/">osfr</a></span><span class="op">)</span>  <span class="co"># Interact with OSF via R</span></span>
<span></span>
<span><span class="co"># Make a "models" folder if it doesn't exist already</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html">file.exists</a></span><span class="op">(</span><span class="st">"models"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span> <span class="fu"><a href="https://rdrr.io/r/base/files2.html">dir.create</a></span><span class="op">(</span><span class="st">"models"</span><span class="op">)</span> <span class="op">}</span></span>
<span></span>
<span><span class="co"># Download model_minivans_mega_mlm_brms.rds from OSF</span></span>
<span><span class="fu">osf_retrieve_file</span><span class="op">(</span><span class="st">"https://osf.io/zp6eh"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">osf_download</span><span class="op">(</span>path <span class="op">=</span> <span class="st">"models"</span>, conflicts <span class="op">=</span> <span class="st">"overwrite"</span>, progress <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_minivans_mega_mlm_brms</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span></span>
<span>  <span class="fu">bf</span><span class="op">(</span><span class="va">choice_alt</span> <span class="op">~</span></span>
<span>    <span class="co"># Choice-level predictors that are nested within respondents...</span></span>
<span>    <span class="op">(</span><span class="va">seat</span> <span class="op">+</span> <span class="va">cargo</span> <span class="op">+</span> <span class="va">eng</span> <span class="op">+</span> <span class="va">price</span><span class="op">)</span> <span class="op">*</span></span>
<span>    <span class="co"># ...interacted with all respondent-level predictors...</span></span>
<span>    <span class="op">(</span><span class="va">carpool</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># ... with random respondent-specific slopes for the</span></span>
<span>    <span class="co"># nested choice-level predictors</span></span>
<span>    <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">seat</span> <span class="op">+</span> <span class="va">cargo</span> <span class="op">+</span> <span class="va">eng</span> <span class="op">+</span> <span class="va">price</span> <span class="op">|</span> <span class="va">ID</span> <span class="op">|</span> <span class="va">resp.id</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">minivans_choice_alt</span>,</span>
<span>  family <span class="op">=</span> <span class="fu">categorical</span><span class="op">(</span>refcat <span class="op">=</span> <span class="st">"0"</span><span class="op">)</span>,</span>
<span>  prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="fu">prior</span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, dpar <span class="op">=</span> <span class="va">mu1</span><span class="op">)</span>,</span>
<span>    <span class="fu">prior</span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, dpar <span class="op">=</span> <span class="va">mu2</span><span class="op">)</span>,</span>
<span>    <span class="fu">prior</span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, dpar <span class="op">=</span> <span class="va">mu3</span><span class="op">)</span>,</span>
<span>    <span class="fu">prior</span><span class="op">(</span><span class="fu">exponential</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sd</span>, dpar <span class="op">=</span> <span class="va">mu1</span><span class="op">)</span>,</span>
<span>    <span class="fu">prior</span><span class="op">(</span><span class="fu">exponential</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sd</span>, dpar <span class="op">=</span> <span class="va">mu2</span><span class="op">)</span>,</span>
<span>    <span class="fu">prior</span><span class="op">(</span><span class="fu">exponential</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sd</span>, dpar <span class="op">=</span> <span class="va">mu3</span><span class="op">)</span>,</span>
<span>    <span class="fu">prior</span><span class="op">(</span><span class="fu">lkj</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">cor</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, warmup <span class="op">=</span> <span class="fl">1000</span>, iter <span class="op">=</span> <span class="fl">5000</span>, seed <span class="op">=</span> <span class="fl">1234</span>,</span>
<span>  backend <span class="op">=</span> <span class="st">"cmdstanr"</span>, threads <span class="op">=</span> <span class="fu">threading</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>, <span class="co"># refresh = 0,</span></span>
<span>  control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>adapt_delta <span class="op">=</span> <span class="fl">0.9</span><span class="op">)</span>,</span>
<span>  file <span class="op">=</span> <span class="st">"models/model_minivans_mega_mlm_brms"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This model is incredibly rich. We just estimated more than 5,000 parameters (!!!)—we have three sets of coefficients for each of the three options, and those are all interacted with <code>carpool</code>, plus we have individual-specific offsets to each of those coefficients, plus all the <span class="math inline">\(\rho\)</span> terms in that massive correlation matrix.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu">get_variables</span><span class="op">(</span><span class="va">model_minivans_mega_mlm_brms</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## [1] 5159</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Since we’re dealing with interaction terms, these raw log odds coefficients are even <em>less</em> helpful on their own. It’s nearly impossible to interpret these coefficients in any meaningful way—there’s no point in even trying to combine each of the individual parts of each effect (random parts, interaction parts, etc.). The only way we’ll be able to interpret these things is by making predictions.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb88"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">minivans_mega_marginalized</span> <span class="op">&lt;-</span> <span class="va">model_minivans_mega_mlm_brms</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">gather_draws</span><span class="op">(</span><span class="va">`^b_.*$`</span>, regex <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Each variable name has "mu1", "mu2", etc. built in, like "b_mu1_seat6". This</span></span>
<span>  <span class="co"># splits the .variable column into two parts based on a regular expression,</span></span>
<span>  <span class="co"># creating one column for the mu part ("b_mu1_") and one for the rest of the</span></span>
<span>  <span class="co"># variable name ("seat6")</span></span>
<span>  <span class="fu">separate_wider_regex</span><span class="op">(</span></span>
<span>    <span class="va">.variable</span>,</span>
<span>    patterns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>mu <span class="op">=</span> <span class="st">"b_mu\\d_"</span>, .variable <span class="op">=</span> <span class="st">".*"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Find the average of the three mu estimates for each variable within each</span></span>
<span>  <span class="co"># draw, or marginalize across the three options, since they're randomized</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">.variable</span>, <span class="va">.draw</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>.value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">.value</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">minivans_mega_marginalized</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">.variable</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">median_qi</span><span class="op">(</span><span class="va">.value</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 16 × 7</span></span>
<span><span class="co">##    .variable            .value  .lower  .upper .width .point .interval</span></span>
<span><span class="co">##    &lt;chr&gt;                 &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span><span class="co">##  1 cargo3ft             0.405   0.288   0.522    0.95 median qi       </span></span>
<span><span class="co">##  2 cargo3ft:carpoolyes  0.163  -0.0493  0.377    0.95 median qi       </span></span>
<span><span class="co">##  3 carpoolyes          -0.722  -1.01   -0.434    0.95 median qi       </span></span>
<span><span class="co">##  4 engelec             -1.59   -1.77   -1.42     0.95 median qi       </span></span>
<span><span class="co">##  5 engelec:carpoolyes   0.0859 -0.213   0.380    0.95 median qi       </span></span>
<span><span class="co">##  6 enghyb              -0.775  -0.911  -0.638    0.95 median qi       </span></span>
<span><span class="co">##  7 enghyb:carpoolyes   -0.0550 -0.307   0.197    0.95 median qi       </span></span>
<span><span class="co">##  8 Intercept           -0.125  -0.285   0.0303   0.95 median qi       </span></span>
<span><span class="co">##  9 price35             -0.813  -0.948  -0.675    0.95 median qi       </span></span>
<span><span class="co">## 10 price35:carpoolyes  -0.163  -0.408   0.0825   0.95 median qi       </span></span>
<span><span class="co">## 11 price40             -1.58   -1.74   -1.43     0.95 median qi       </span></span>
<span><span class="co">## 12 price40:carpoolyes  -0.246  -0.526   0.0307   0.95 median qi       </span></span>
<span><span class="co">## 13 seat7               -0.880  -1.03   -0.736    0.95 median qi       </span></span>
<span><span class="co">## 14 seat7:carpoolyes     1.14    0.875   1.40     0.95 median qi       </span></span>
<span><span class="co">## 15 seat8               -0.646  -0.796  -0.501    0.95 median qi       </span></span>
<span><span class="co">## 16 seat8:carpoolyes     1.13    0.857   1.40     0.95 median qi</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="predictions-2" class="level2"><h2 class="anchored" data-anchor-id="predictions-2">Predictions</h2>
<p>In the non-hierarchical model earlier, <a href="#bayesian-predictions-1">we made marketing-style predictions</a> by thinking of a product mix and figuring out the predicted utility and market share of each product in that mix. We can do the same thing here, but now we can incorporate individual-level characteristics too.</p>
<p>Here’s our example product mix again, but this time we’ll repeat it twice—once with <code>carpool</code> set to “yes” and once with it set to “no”. This will let us see the predicted market share for each mix of products for a market of only carpoolers and only non-carpoolers.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">example_product_mix</span> <span class="op">&lt;-</span> <span class="fu">tribble</span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">seat</span>, <span class="op">~</span><span class="va">cargo</span>, <span class="op">~</span><span class="va">eng</span>, <span class="op">~</span><span class="va">price</span>,</span>
<span>  <span class="st">"7"</span>, <span class="st">"2ft"</span>, <span class="st">"hyb"</span>, <span class="st">"30"</span>,</span>
<span>  <span class="st">"6"</span>, <span class="st">"2ft"</span>, <span class="st">"gas"</span>, <span class="st">"30"</span>,</span>
<span>  <span class="st">"8"</span>, <span class="st">"2ft"</span>, <span class="st">"gas"</span>, <span class="st">"30"</span>,</span>
<span>  <span class="st">"7"</span>, <span class="st">"3ft"</span>, <span class="st">"gas"</span>, <span class="st">"40"</span>,</span>
<span>  <span class="st">"6"</span>, <span class="st">"2ft"</span>, <span class="st">"elec"</span>, <span class="st">"40"</span>,</span>
<span>  <span class="st">"7"</span>, <span class="st">"2ft"</span>, <span class="st">"hyb"</span>, <span class="st">"35"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">product_mix_carpool</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="va">example_product_mix</span>, carpool <span class="op">=</span> <span class="st">"yes"</span><span class="op">)</span>,</span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="va">example_product_mix</span>, carpool <span class="op">=</span> <span class="st">"no"</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu">everything</span><span class="op">(</span><span class="op">)</span>, <span class="va">factor</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>eng <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">eng</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">minivans</span><span class="op">$</span><span class="va">eng</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now go through <a href="#bayesian-predictions-1">the same process from earlier</a> where we get logit-scale predictions for this smaller dataset and find the shares inside each draw + category (options 1, 2, and 3) + carpool status group.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">draws_df</span> <span class="op">&lt;-</span> <span class="va">product_mix_carpool</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">add_linpred_draws</span><span class="op">(</span><span class="va">model_minivans_mega_mlm_brms</span>, value <span class="op">=</span> <span class="st">"utility"</span>, re_formula <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span></span>
<span><span class="va">shares_df</span> <span class="op">&lt;-</span> <span class="va">draws_df</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Look at each set of predicted utilities within each draw within each of the</span></span>
<span>  <span class="co"># three outcomes across both levels of carpooling</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">.draw</span>, <span class="va">.category</span>, <span class="va">carpool</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>share <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">utility</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">utility</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    mix_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">seat</span>, <span class="va">cargo</span>, <span class="va">eng</span>, <span class="va">price</span>, sep <span class="op">=</span> <span class="st">" "</span><span class="op">)</span>,</span>
<span>    mix_type <span class="op">=</span> <span class="fu">fct_reorder</span><span class="op">(</span><span class="va">mix_type</span>, <span class="va">share</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This new dataset contains 576,000 (!!) rows: 6 products × 2 carpool types × 3 <span class="math inline">\(\mu\)</span>-specific sets of coefficients × 16,000 MCMC draws. We can summarize this to get posterior medians and credible intervals, making sure to find the average share across the three outcomes (choice 1, 2, and 3), or marginalizing across the outcome.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb91"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">shares_df</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Marginalize across the three outcomes within each draw</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">mix_type</span>, <span class="va">carpool</span>, <span class="va">.draw</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>share <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">share</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">median_qi</span><span class="op">(</span><span class="va">share</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 12 × 8</span></span>
<span><span class="co">##    mix_type      carpool   share  .lower .upper .width .point .interval</span></span>
<span><span class="co">##    &lt;fct&gt;         &lt;fct&gt;     &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span><span class="co">##  1 6 2ft elec 40 no      0.0218  0.0172  0.0272   0.95 median qi       </span></span>
<span><span class="co">##  2 6 2ft elec 40 yes     0.00948 0.00648 0.0137   0.95 median qi       </span></span>
<span><span class="co">##  3 7 2ft hyb 35  no      0.0433  0.0352  0.0530   0.95 median qi       </span></span>
<span><span class="co">##  4 7 2ft hyb 35  yes     0.0573  0.0421  0.0766   0.95 median qi       </span></span>
<span><span class="co">##  5 7 3ft gas 40  no      0.0653  0.0531  0.0799   0.95 median qi       </span></span>
<span><span class="co">##  6 7 3ft gas 40  yes     0.0976  0.0722  0.130    0.95 median qi       </span></span>
<span><span class="co">##  7 7 2ft hyb 30  no      0.0971  0.0825  0.114    0.95 median qi       </span></span>
<span><span class="co">##  8 7 2ft hyb 30  yes     0.148   0.118   0.183    0.95 median qi       </span></span>
<span><span class="co">##  9 8 2ft gas 30  no      0.265   0.239   0.293    0.95 median qi       </span></span>
<span><span class="co">## 10 8 2ft gas 30  yes     0.424   0.367   0.480    0.95 median qi       </span></span>
<span><span class="co">## 11 6 2ft gas 30  no      0.506   0.472   0.540    0.95 median qi       </span></span>
<span><span class="co">## 12 6 2ft gas 30  yes     0.261   0.224   0.303    0.95 median qi</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And we can plot them:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">shares_df</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>carpool <span class="op">=</span> <span class="fu">case_match</span><span class="op">(</span><span class="va">carpool</span>, <span class="st">"no"</span> <span class="op">~</span> <span class="st">"Non-carpoolers"</span>, <span class="st">"yes"</span> <span class="op">~</span> <span class="st">"Carpoolers"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Marginalize across the three outcomes within each draw</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">mix_type</span>, <span class="va">carpool</span>, <span class="va">.draw</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>share <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">share</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">share</span>, y <span class="op">=</span> <span class="va">mix_type</span>, slab_alpha <span class="op">=</span> <span class="va">carpool</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span>normalize <span class="op">=</span> <span class="st">"groups"</span>, fill <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">10</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_percent</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_slab_alpha_discrete</span><span class="op">(</span></span>
<span>    range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.4</span><span class="op">)</span>,</span>
<span>    guide <span class="op">=</span> <span class="st">"none"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">carpool</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Predicted market share"</span>, y <span class="op">=</span> <span class="st">"Hypothetical product mix"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-shares-carpool-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>This is so cool! In general, the market share for these six hypothetical products is roughly the same across carpoolers and non-carpoolers, with one obvious exception—among non-carpoolers, the $30,000 8-passenger gas minivan with 2 feet of space has 26% of the market, while among carpoolers it has 42%. Individuals who carpool apparently <em>really</em> care about the number of passengers their vehicle can carry.</p>
</section><section id="amces-2" class="level2"><h2 class="anchored" data-anchor-id="amces-2">AMCEs</h2>
<p>To find the average marginal component effects (AMCEs), or the causal effect of moving one of these features to another value, holding all other variables constant, we can go through <a href="#bayesian-comparisonscontrasts-1">the same process as before</a>. We’ll calculate the predicted probabilities of choosing option 0, 1, 2, and 3 across a full grid of all the combinations of feature levels <em>and</em> carpool status. We’ll then filter those predictions to only look at option 0 and reverse the predicted probabilities. Again, that feels weird, but it’s a neat little trick—if there’s a 33% chance that someone will select a specific combination of features, that would imply a 66% chance of not selecting it and an 11% chance of selecting it when it appears in option 1, option 2, and option 3. Rather than adding the probabilities within those three options together, we can do 100% − 66% to get the same 33% value, only it’s automatically combined.</p>
<p>Earlier we had 54 combinations—now we have 108 (54 × 2). We’ll set <code>resp.id</code> to one that’s not in the dataset (201) so that these effects all deal with a generic hypothetical respondent (we could also do some fancy “integrating out” work and find population-level averages; <a href="https://www.andrewheiss.com/blog/2022/11/29/conditional-marginal-marginaleffects/">see here for more about that</a>).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb93"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">newdata_all_combos_carpool</span> <span class="op">&lt;-</span> <span class="va">minivans</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu">expand</span><span class="op">(</span><span class="va">seat</span>, <span class="va">cargo</span>, <span class="va">eng</span>, <span class="va">price</span>, <span class="va">carpool</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>resp.id <span class="op">=</span> <span class="fl">201</span><span class="op">)</span></span>
<span><span class="va">newdata_all_combos_carpool</span></span>
<span><span class="co">## # A tibble: 108 × 6</span></span>
<span><span class="co">##    seat  cargo eng   price carpool resp.id</span></span>
<span><span class="co">##    &lt;fct&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt; &lt;fct&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">##  1 6     2ft   gas   30    no          201</span></span>
<span><span class="co">##  2 6     2ft   gas   30    yes         201</span></span>
<span><span class="co">##  3 6     2ft   gas   35    no          201</span></span>
<span><span class="co">##  4 6     2ft   gas   35    yes         201</span></span>
<span><span class="co">##  5 6     2ft   gas   40    no          201</span></span>
<span><span class="co">##  6 6     2ft   gas   40    yes         201</span></span>
<span><span class="co">##  7 6     2ft   hyb   30    no          201</span></span>
<span><span class="co">##  8 6     2ft   hyb   30    yes         201</span></span>
<span><span class="co">##  9 6     2ft   hyb   35    no          201</span></span>
<span><span class="co">## 10 6     2ft   hyb   35    yes         201</span></span>
<span><span class="co">## # ℹ 98 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next we can plug this grid into the model, filter to only keep option 0, and reverse the predictions:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb94"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">all_preds_brms_carpool</span> <span class="op">&lt;-</span> <span class="va">model_minivans_mega_mlm_brms</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">epred_draws</span><span class="op">(</span></span>
<span>    newdata <span class="op">=</span> <span class="va">newdata_all_combos_carpool</span>,</span>
<span>    re_formula <span class="op">=</span> <span class="cn">NULL</span>, allow_new_levels <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">.category</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>.epred <span class="op">=</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">.epred</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This thing has 1.7 million rows in it, so we need to group and summarize to do anything useful with it. We also need to marginalize across all the other covariates when grouping (i.e.&nbsp;if we want the estimates for passenger seat count across carpool status, we need to average out all the other covariates).</p>
<p>To test that this worked, here are the posterior marginal means for seat count:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb95"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">preds_seat_carpool_marginalized</span> <span class="op">&lt;-</span> <span class="va">all_preds_brms_carpool</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Marginalize out the other covariates in each draw</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">seat</span>, <span class="va">carpool</span>, <span class="va">.draw</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>avg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">.epred</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">preds_seat_carpool_marginalized</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">seat</span>, <span class="va">carpool</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">median_qi</span><span class="op">(</span><span class="va">avg</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 6 × 8</span></span>
<span><span class="co">##   seat  carpool   avg .lower .upper .width .point .interval</span></span>
<span><span class="co">##   &lt;fct&gt; &lt;fct&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span><span class="co">## 1 6     no      0.425  0.378  0.485   0.95 median qi       </span></span>
<span><span class="co">## 2 6     yes     0.287  0.246  0.339   0.95 median qi       </span></span>
<span><span class="co">## 3 7     no      0.263  0.205  0.335   0.95 median qi       </span></span>
<span><span class="co">## 4 7     yes     0.335  0.267  0.418   0.95 median qi       </span></span>
<span><span class="co">## 5 8     no      0.305  0.226  0.406   0.95 median qi       </span></span>
<span><span class="co">## 6 8     yes     0.379  0.288  0.487   0.95 median qi</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Those credible intervals all look reasonable (i.e.&nbsp;not ranging from 5% to 80% or whatever), but it’s hard to see any trends from just this table. Let’s plot it:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">preds_seat_carpool_marginalized</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">avg</span>, y <span class="op">=</span> <span class="va">seat</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>slab_alpha <span class="op">=</span> <span class="va">carpool</span><span class="op">)</span>, fill <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_percent</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_slab_alpha_discrete</span><span class="op">(</span></span>
<span>    range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.4</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Non-carpoolers"</span>, <span class="st">"Carpoolers"</span><span class="op">)</span>,</span>
<span>    guide <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span></span>
<span>      reverse <span class="op">=</span> <span class="cn">TRUE</span>, override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"grey10"</span><span class="op">)</span>, </span>
<span>      keywidth <span class="op">=</span> <span class="fl">0.8</span>, keyheight <span class="op">=</span> <span class="fl">0.8</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Marginal means"</span>,</span>
<span>    y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    slab_alpha <span class="op">=</span> <span class="cn">NULL</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">"top"</span>,</span>
<span>    legend.justification <span class="op">=</span> <span class="st">"left"</span>,</span>
<span>    legend.margin <span class="op">=</span> <span class="fu">margin</span><span class="op">(</span>l <span class="op">=</span> <span class="op">-</span><span class="fl">7</span>, t <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-marginal-means-seat-carpool-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>Neat! The average posterior predicted probability of choosing six seats is substantially higher for carpoolers than for non-carpoolers, while the probability for seven and eight seats is bigger for carpoolers.</p>
<p>We’re most interested in the AMCE though, and not the marginal means, so we’ll use <code>compare_levels()</code> to find the carpool-specific differences between the effect of moving from 6 → 7 and 6 → seats:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb97"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">amces_seat_carpool</span> <span class="op">&lt;-</span> <span class="va">preds_seat_carpool_marginalized</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">carpool</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">compare_levels</span><span class="op">(</span>variable <span class="op">=</span> <span class="va">avg</span>, by <span class="op">=</span> <span class="va">seat</span>, comparison <span class="op">=</span> <span class="st">"control"</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">amces_seat_carpool</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">median_qi</span><span class="op">(</span><span class="va">avg</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 4 × 8</span></span>
<span><span class="co">##   carpool seat      avg  .lower  .upper .width .point .interval</span></span>
<span><span class="co">##   &lt;fct&gt;   &lt;chr&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span><span class="co">## 1 no      7 - 6 -0.163  -0.232  -0.0887   0.95 median qi       </span></span>
<span><span class="co">## 2 no      8 - 6 -0.121  -0.217  -0.0108   0.95 median qi       </span></span>
<span><span class="co">## 3 yes     7 - 6  0.0475 -0.0254  0.127    0.95 median qi       </span></span>
<span><span class="co">## 4 yes     8 - 6  0.0909 -0.0108  0.204    0.95 median qi</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Among carpoolers, the causal effect of moving from 6 → 7 passengers, holding all other features constant, is a 5ish percentage point increase in the probability of selecting the vehicle. The effect is bigger (9ish percentage points) when moving from 6 → 8.</p>
<p>Among non-carpoolers, the causal effect is reversed. Moving from 6 → 7 passengers causes a 16 percentage point decrease in the probability of selection, while moving from 6 → 8 causes a 12 percentage point decrease, holding all other features constant.</p>
<p>These effects are “significant” and have a 90–97% probability of being greater than zero for carpoolers and 98–99% probability of being less than zero for the non-carpoolers.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb98"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Calculate probability of direction</span></span>
<span><span class="va">amces_seat_carpool</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">seat</span>, <span class="va">carpool</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>p_gt_0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">avg</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">/</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>p_lt_0 <span class="op">=</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">p_gt_0</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 4 × 4</span></span>
<span><span class="co">## # Groups:   seat [2]</span></span>
<span><span class="co">##   seat  carpool   p_gt_0 p_lt_0</span></span>
<span><span class="co">##   &lt;chr&gt; &lt;fct&gt;      &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span><span class="co">## 1 7 - 6 no      0.000625 0.999 </span></span>
<span><span class="co">## 2 7 - 6 yes     0.912    0.0883</span></span>
<span><span class="co">## 3 8 - 6 no      0.0186   0.981 </span></span>
<span><span class="co">## 4 8 - 6 yes     0.961    0.0387</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb99"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">amces_seat_carpool</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">avg</span>, y <span class="op">=</span> <span class="va">seat</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>slab_alpha <span class="op">=</span> <span class="va">carpool</span><span class="op">)</span>, fill <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="va">label_pp</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_slab_alpha_discrete</span><span class="op">(</span></span>
<span>    range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.4</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Non-carpoolers"</span>, <span class="st">"Carpoolers"</span><span class="op">)</span>,</span>
<span>    guide <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span></span>
<span>      reverse <span class="op">=</span> <span class="cn">TRUE</span>, override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"grey10"</span><span class="op">)</span>, </span>
<span>      keywidth <span class="op">=</span> <span class="fl">0.8</span>, keyheight <span class="op">=</span> <span class="fl">0.8</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Percentage point change in probability of minivan selection"</span>,</span>
<span>    y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    slab_alpha <span class="op">=</span> <span class="cn">NULL</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">"top"</span>,</span>
<span>    legend.justification <span class="op">=</span> <span class="st">"left"</span>,</span>
<span>    legend.margin <span class="op">=</span> <span class="fu">margin</span><span class="op">(</span>l <span class="op">=</span> <span class="op">-</span><span class="fl">7</span>, t <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-amces-seat-carpool-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>Here are all the AMCEs across carpool status:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb100"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">amces_minivan_carpool</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span></span>
<span>  seat <span class="op">=</span> <span class="va">all_preds_brms_carpool</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">seat</span>, <span class="va">carpool</span>, <span class="va">.draw</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">summarize</span><span class="op">(</span>avg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">.epred</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">compare_levels</span><span class="op">(</span>variable <span class="op">=</span> <span class="va">avg</span>, by <span class="op">=</span> <span class="va">seat</span>, comparison <span class="op">=</span> <span class="st">"control"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">rename</span><span class="op">(</span>contrast <span class="op">=</span> <span class="va">seat</span><span class="op">)</span>,</span>
<span>  cargo <span class="op">=</span> <span class="va">all_preds_brms_carpool</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">cargo</span>, <span class="va">carpool</span>, <span class="va">.draw</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">summarize</span><span class="op">(</span>avg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">.epred</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">compare_levels</span><span class="op">(</span>variable <span class="op">=</span> <span class="va">avg</span>, by <span class="op">=</span> <span class="va">cargo</span>, comparison <span class="op">=</span> <span class="st">"control"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">rename</span><span class="op">(</span>contrast <span class="op">=</span> <span class="va">cargo</span><span class="op">)</span>,</span>
<span>  eng <span class="op">=</span> <span class="va">all_preds_brms_carpool</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">eng</span>, <span class="va">carpool</span>, <span class="va">.draw</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">summarize</span><span class="op">(</span>avg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">.epred</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">compare_levels</span><span class="op">(</span>variable <span class="op">=</span> <span class="va">avg</span>, by <span class="op">=</span> <span class="va">eng</span>, comparison <span class="op">=</span> <span class="st">"control"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">rename</span><span class="op">(</span>contrast <span class="op">=</span> <span class="va">eng</span><span class="op">)</span>,</span>
<span>  price <span class="op">=</span> <span class="va">all_preds_brms_carpool</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">price</span>, <span class="va">carpool</span>, <span class="va">.draw</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">summarize</span><span class="op">(</span>avg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">.epred</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">compare_levels</span><span class="op">(</span>variable <span class="op">=</span> <span class="va">avg</span>, by <span class="op">=</span> <span class="va">price</span>, comparison <span class="op">=</span> <span class="st">"control"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">rename</span><span class="op">(</span>contrast <span class="op">=</span> <span class="va">price</span><span class="op">)</span>,</span>
<span>  .id <span class="op">=</span> <span class="st">"term"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">amces_minivan_carpool</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">term</span>, <span class="va">carpool</span>, <span class="va">contrast</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">median_qi</span><span class="op">(</span><span class="va">avg</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 14 × 9</span></span>
<span><span class="co">##    term  carpool contrast       avg  .lower  .upper .width .point .interval</span></span>
<span><span class="co">##    &lt;chr&gt; &lt;fct&gt;   &lt;chr&gt;        &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span><span class="co">##  1 cargo no      3ft - 2ft   0.0750  0.0351  0.117    0.95 median qi       </span></span>
<span><span class="co">##  2 cargo yes     3ft - 2ft   0.102   0.0557  0.151    0.95 median qi       </span></span>
<span><span class="co">##  3 eng   no      elec - gas -0.287  -0.397  -0.142    0.95 median qi       </span></span>
<span><span class="co">##  4 eng   no      hyb - gas  -0.160  -0.209  -0.107    0.95 median qi       </span></span>
<span><span class="co">##  5 eng   yes     elec - gas -0.271  -0.388  -0.120    0.95 median qi       </span></span>
<span><span class="co">##  6 eng   yes     hyb - gas  -0.166  -0.223  -0.104    0.95 median qi       </span></span>
<span><span class="co">##  7 price no      35 - 30    -0.167  -0.225  -0.109    0.95 median qi       </span></span>
<span><span class="co">##  8 price no      40 - 30    -0.295  -0.355  -0.231    0.95 median qi       </span></span>
<span><span class="co">##  9 price yes     35 - 30    -0.203  -0.270  -0.134    0.95 median qi       </span></span>
<span><span class="co">## 10 price yes     40 - 30    -0.342  -0.410  -0.272    0.95 median qi       </span></span>
<span><span class="co">## 11 seat  no      7 - 6      -0.163  -0.232  -0.0887   0.95 median qi       </span></span>
<span><span class="co">## 12 seat  no      8 - 6      -0.121  -0.217  -0.0108   0.95 median qi       </span></span>
<span><span class="co">## 13 seat  yes     7 - 6       0.0475 -0.0254  0.127    0.95 median qi       </span></span>
<span><span class="co">## 14 seat  yes     8 - 6       0.0909 -0.0108  0.204    0.95 median qi</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And finally, here’s a polisci-style plot of all these AMCEs, which is so so neat. An individual’s carpooling behavior interacts with seat count (increasing the seat count causes carpoolers to select the minivan more often), and it also interacts a bit with cargo space (increasing the cargo space makes both types of individuals more likely to select the minivan, but moreso for carpoolers) and also with price (increasing the price makes both types of individuals less likely to select the minivan, but moreso for carpoolers). Switching from gas → hybrid and gas → electric has a negative effect on both types of consumers, and there’s no carpooling-based difference.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Extract variable labels</summary><div class="sourceCode" id="cb101"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">minivan_var_levels</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span></span>
<span>  variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"seat"</span>, <span class="st">"cargo"</span>, <span class="st">"eng"</span>, <span class="st">"price"</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>levels <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">variable</span>, <span class="op">~</span><span class="op">{</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">minivans</span><span class="op">[[</span><span class="va">.x</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">is.numeric</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="st">""</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">is.factor</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">unnest</span><span class="op">(</span><span class="va">levels</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>term <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">variable</span>, <span class="va">levels</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Make a little lookup table for nicer feature labels</span></span>
<span><span class="va">minivan_var_lookup</span> <span class="op">&lt;-</span> <span class="fu">tribble</span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">variable</span>, <span class="op">~</span><span class="va">variable_nice</span>,</span>
<span>  <span class="st">"seat"</span>,    <span class="st">"Passengers"</span>,</span>
<span>  <span class="st">"cargo"</span>,   <span class="st">"Cargo space"</span>,</span>
<span>  <span class="st">"eng"</span>,     <span class="st">"Engine type"</span>,</span>
<span>  <span class="st">"price"</span>,   <span class="st">"Price (thousands of $)"</span></span>
<span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>variable_nice <span class="op">=</span> <span class="fu">fct_inorder</span><span class="op">(</span><span class="va">variable_nice</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Combine full dataset of factor levels with marginalized posterior draws and make plot</summary><div class="sourceCode" id="cb102"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">posterior_amces_minivan_carpool_nested</span> <span class="op">&lt;-</span> <span class="va">amces_minivan_carpool</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">separate_wider_delim</span><span class="op">(</span></span>
<span>    <span class="va">contrast</span>,</span>
<span>    delim <span class="op">=</span> <span class="st">" - "</span>, </span>
<span>    names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"variable_level"</span>, <span class="st">"reference_level"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">term</span>, <span class="va">variable_level</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">nest</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_data_minivan_carpool</span> <span class="op">&lt;-</span> <span class="va">minivan_var_levels</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span></span>
<span>    <span class="va">posterior_amces_minivan_carpool_nested</span>,</span>
<span>    by <span class="op">=</span> <span class="fu">join_by</span><span class="op">(</span><span class="va">variable</span> <span class="op">==</span> <span class="va">term</span>, <span class="va">levels</span> <span class="op">==</span> <span class="va">variable_level</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>data <span class="op">=</span> <span class="fu">map_if</span><span class="op">(</span><span class="va">data</span>, <span class="va">is.null</span>, <span class="op">~</span> <span class="fu">tibble</span><span class="op">(</span>avg <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">unnest</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">minivan_var_lookup</span>, by <span class="op">=</span> <span class="fu">join_by</span><span class="op">(</span><span class="va">variable</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">levels</span>, <span class="va">variable_nice</span><span class="op">)</span>, <span class="op">~</span><span class="fu">fct_inorder</span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Make the missing carpool values be "yes" for the reference category</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>carpool <span class="op">=</span> <span class="fu">replace_na</span><span class="op">(</span><span class="va">carpool</span>, <span class="st">"yes"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_data_minivan_carpool</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">avg</span>, y <span class="op">=</span> <span class="va">levels</span>, fill <span class="op">=</span> <span class="va">variable_nice</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>slab_alpha <span class="op">=</span> <span class="va">carpool</span><span class="op">)</span>, normalize <span class="op">=</span> <span class="st">"groups"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">facet_col</span><span class="op">(</span>facets <span class="op">=</span> <span class="st">"variable_nice"</span>, scales <span class="op">=</span> <span class="st">"free_y"</span>, space <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="va">label_pp</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_slab_alpha_discrete</span><span class="op">(</span></span>
<span>    range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.4</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Non-carpoolers"</span>, <span class="st">"Carpoolers"</span><span class="op">)</span>,</span>
<span>    guide <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span></span>
<span>      reverse <span class="op">=</span> <span class="cn">TRUE</span>, override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"grey10"</span><span class="op">)</span>, </span>
<span>      keywidth <span class="op">=</span> <span class="fl">0.8</span>, keyheight <span class="op">=</span> <span class="fl">0.8</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">7</span>, <span class="fl">8</span>, <span class="fl">9</span><span class="op">)</span><span class="op">]</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Percentage point change in probability of minivan selection"</span>,</span>
<span>    y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"AMCEs across respondent carpool status"</span>,</span>
<span>    slab_alpha <span class="op">=</span> <span class="cn">NULL</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">"top"</span>,</span>
<span>    legend.justification <span class="op">=</span> <span class="st">"left"</span>,</span>
<span>    legend.margin <span class="op">=</span> <span class="fu">margin</span><span class="op">(</span>l <span class="op">=</span> <span class="op">-</span><span class="fl">7</span>, t <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-amces-minivans-carpool-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<hr></section></section><section id="tldr-moral-of-the-story" class="level1"><h1>tl;dr: Moral of the story</h1>
<p>holy crap this might be the longest guide I’ve ever posted here. This is hard.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Main points
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p>OLS is nice and easy, but it fails to capture all the dynamics between sets of features and individual characteristics. Use multilevel multinomial models to account for all the heterogeneity in choices and individuals.</p></li>
<li><p>{brms} provides a powerful, easy-to-use frontend for running complex multilevel models in Stan. There’s no need to write raw Stan code if you don’t want to.</p></li>
<li><p>This is hard stuff. Multinomial logit models are complex and weird to work with. But the power and flexibility and richness is worth it.</p></li>
</ul>
</div>
</div>
<p>Here’s a general summary of the main code for all this, based on a hypothetical conjoint survey with three features, like this:</p>
<table class="caption-top table">
<thead><tr class="header">
<th style="text-align: left;">Features/Attributes</th>
<th style="text-align: left;">Levels</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Brand (<code>brand</code>)</td>
<td style="text-align: left;">A, B, C</td>
</tr>
<tr class="even">
<td style="text-align: left;">Color (<code>color</code>)</td>
<td style="text-align: left;">Blue, red, yellow</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Size (<code>size</code>)</td>
<td style="text-align: left;">Small, large</td>
</tr>
</tbody>
</table>
<p>And imagine that we have data on respondent age (<code>resp_age</code>) and education (<code>resp_ed</code>).</p>
<ul>
<li>
<p>Specify a full luxury multilevel model with individual-level characteristics informing choice-level coefficients like this (<a href="#translating-from-marketing-style-stan-notation-to-brms-syntax">see here</a>):</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb103"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span></span>
<span>  <span class="fu">bf</span><span class="op">(</span><span class="va">choice</span> <span class="op">~</span></span>
<span>      <span class="co"># Columns for feature interacted with respondent-level covariates</span></span>
<span>      <span class="op">(</span><span class="va">brand</span> <span class="op">+</span> <span class="va">color</span> <span class="op">+</span> <span class="va">size</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">resp_age</span> <span class="op">+</span> <span class="va">resp_ed</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="co"># Respondent-specific intercepts and slopes for all features</span></span>
<span>      <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">brand</span> <span class="op">+</span> <span class="va">color</span> <span class="op">+</span> <span class="va">sice</span> <span class="op">|</span> <span class="va">ID</span> <span class="op">|</span> <span class="va">resp_id</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  family <span class="op">=</span> <span class="fu">categorical</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">data</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
<li>
<p>Find marketing-style predicted shares for hypothetical mixes of products by feeding a smaller dataset of hypothetical mixes to <code>brms::posterior_linpred()</code> (or <code>tidybayes::linpred_draws()</code>) to find utility (or logit-scale predictions), then calculate the share for each draw, and then marginalize (or average) the shares across the multiple choices within each draw. (<a href="#predictions-2">See here</a>.)</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb104"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">product_mix</span> <span class="op">&lt;-</span> <span class="fu">tribble</span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">brand</span>, <span class="op">~</span><span class="va">color</span>,   <span class="op">~</span><span class="va">size</span>,   <span class="op">~</span><span class="va">resp_age</span>,</span>
<span>  <span class="st">"A"</span>,    <span class="st">"Blue"</span>,   <span class="st">"Small"</span>, <span class="fl">25</span>,</span>
<span>  <span class="st">"B"</span>,    <span class="st">"Red"</span>,    <span class="st">"Small"</span>, <span class="fl">25</span>,</span>
<span>  <span class="st">"C"</span>,    <span class="st">"Yellow"</span>, <span class="st">"Large"</span>, <span class="fl">25</span>,</span>
<span>  <span class="st">"A"</span>,    <span class="st">"Blue"</span>,   <span class="st">"Small"</span>, <span class="fl">45</span>,</span>
<span>  <span class="st">"B"</span>,    <span class="st">"Red"</span>,    <span class="st">"Small"</span>, <span class="fl">45</span>,</span>
<span>  <span class="st">"C"</span>,    <span class="st">"Yellow"</span>, <span class="st">"Large"</span>, <span class="fl">45</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">linpred_draws</span><span class="op">(</span>newdata <span class="op">=</span> <span class="va">product_mix</span>, value <span class="op">=</span> <span class="st">"utility"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">.draw</span>, <span class="va">.category</span>, <span class="va">resp_age</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>share <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">utility</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">utility</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Marginalize across the outcomes within each draw</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">brand</span>, <span class="va">color</span>, <span class="va">size</span>, <span class="va">resp_age</span>, <span class="va">.draw</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>share <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">share</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
<li>
<p>Find political science-style marginal means and AMCEs by feeding a <em>complete grid of all possible feature levels</em>, along with any respondent-level characteristics of interest to <code>brms::posterior_epred()</code> (or <code>tidybayes::epred_draws()</code>), then filter those probabilities to look only at option 0 (i.e.&nbsp;not choosing an option), and calculate <code>1 - prediction</code> to reverse it. Then group by the feature level and respondent-level characteristics you’re interested in, find the average of predictions, and marginalize (or average) out the other covariates in each draw. (<a href="#amces-2">See here</a>.)</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb105"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">all_feature_combos_with_age</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu">expand</span><span class="op">(</span><span class="va">brand</span>, <span class="va">color</span>, <span class="va">size</span>, <span class="va">resp_age</span><span class="op">)</span></span>
<span></span>
<span><span class="va">all_predictions</span> <span class="op">&lt;-</span> <span class="va">model</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">epred_draws</span><span class="op">(</span>newdata <span class="op">=</span> <span class="va">all_feature_combos_with_age</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Only look at category 0 and reverse predictions</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">.category</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>.epred <span class="op">=</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">.epred</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Marginal means for brand across respondent age</span></span>
<span><span class="va">all_predictions</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Marginalize out the other covariates in each draw</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">brand</span>, <span class="va">resp_age</span>, <span class="va">.draw</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>avg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">.epred</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># AMCEs for brand across respondent age</span></span>
<span><span class="va">all_predictions</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Marginalize out the other covariates in each draw</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">brand</span>, <span class="va">resp_age</span>, <span class="va">.draw</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>avg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">.epred</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">resp_age</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">compare_levels</span><span class="op">(</span>variable <span class="op">=</span> <span class="va">avg</span>, by <span class="op">=</span> <span class="va">brand</span>, comparison <span class="op">=</span> <span class="st">"control"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
</ul>
<hr>
<p>Fin.</p>


<!-- -->


</section><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-ChapmanFeit:2019" class="csl-entry" role="listitem">
Chapman, Chris, and Elea McDonnell Feit. 2019. <em>R For Marketing Research and Analytics</em>. 2nd ed. Use R! Cham, Switzerland: Springer Nature Switzerland. <a href="https://doi.org/10.1007/978-3-030-14316-9">https://doi.org/10.1007/978-3-030-14316-9</a>.
</div>
<div id="ref-ChaudhryDotsonHeiss:2021" class="csl-entry" role="listitem">
Chaudhry, Suparna, Marc Dotson, and Andrew Heiss. 2021. <span>“Who Cares about Crackdowns? Exploring the Role of Trust in Individual Philanthropy.”</span> <em>Global Policy</em> 12 (S5): 45–58. <a href="https://doi.org/10.1111/1758-5899.12984">https://doi.org/10.1111/1758-5899.12984</a>.
</div>
<div id="ref-GelmanHill:2007" class="csl-entry" role="listitem">
Gelman, Andrew, and Jennifer Hill. 2007. <em>Data Analysis Using Regression and Multilevel/Hierarchical Models</em>. Cambridge: Cambridge University Press. <a href="https://doi.org/10.1017/CBO9780511790942">https://doi.org/10.1017/CBO9780511790942</a>.
</div>
<div id="ref-JensenMarbleScheve:2021" class="csl-entry" role="listitem">
Jensen, Amalie, William Marble, Kenneth Scheve, and Matthew J. Slaughter. 2021. <span>“City Limits to Partisan Polarization in the American Public.”</span> <em>Political Science Research and Methods</em> 9 (2): 223–41. <a href="https://doi.org/10.1017/psrm.2020.56">https://doi.org/10.1017/psrm.2020.56</a>.
</div>
<div id="ref-Kuhfeld:2010" class="csl-entry" role="listitem">
Kuhfeld, Warren F. 2010. <span>“Discrete Choice.”</span> SAS Technical Paper MR2010F. SAS Institute. <a href="http://support.sas.com/resources/papers/tnote/tnote_marketresearch.html">http://support.sas.com/resources/papers/tnote/tnote_marketresearch.html</a>.
</div>
</div></section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{heiss2023,
  author = {Heiss, Andrew},
  title = {The Ultimate Practical Guide to Multilevel Multinomial
    Conjoint Analysis with {R}},
  date = {2023-08-12},
  url = {https://www.andrewheiss.com/blog/2023/08/12/conjoint-multilevel-multinomial-guide/},
  doi = {10.59350/2mz75-rrc46},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-heiss2023" class="csl-entry quarto-appendix-citeas" role="listitem">
Heiss, Andrew. 2023. <span>“The Ultimate Practical Guide to Multilevel
Multinomial Conjoint Analysis with R.”</span> August 12, 2023. <a href="https://doi.org/10.59350/2mz75-rrc46">https://doi.org/10.59350/2mz75-rrc46</a>.
</div></div></section></div></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/www\.andrewheiss\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><script src="https://giscus.app/client.js" data-repo="andrewheiss/ath-quarto" data-repo-id="R_kgDOIg6EJQ" data-category="Blog comments" data-category-id="DIC_kwDOIg6EJc4CSz92" data-mapping="pathname" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script><input type="hidden" id="giscus-base-theme" value="light"><input type="hidden" id="giscus-alt-theme" value="dark"><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb106" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "The ultimate practical guide to multilevel multinomial conjoint analysis with R"</span></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> 2023-08-12</span></span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a><span class="an">date-modified:</span><span class="co"> 2024-09-24</span></span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a><span class="an">description:</span><span class="co"> "Learn how to use R, {brms}, {marginaleffects}, and {tidybayes} to analyze discrete choice conjoint data with fully specified hierarchical multilevel multinomial models"</span></span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a><span class="an">image:</span><span class="co"> index_files/figure-html/plot-amces-minivans-carpool-1.png</span></span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a><span class="an">twitter-card:</span></span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a><span class="co">  image: "index_files/figure-html/plot-amces-minivans-carpool-1.png"</span></span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a><span class="an">open-graph:</span></span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a><span class="co">  image: "index_files/figure-html/plot-amces-minivans-carpool-1.png"</span></span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span></span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a><span class="co">  - r</span></span>
<span id="cb106-13"><a href="#cb106-13" aria-hidden="true" tabindex="-1"></a><span class="co">  - tidyverse</span></span>
<span id="cb106-14"><a href="#cb106-14" aria-hidden="true" tabindex="-1"></a><span class="co">  - ggplot</span></span>
<span id="cb106-15"><a href="#cb106-15" aria-hidden="true" tabindex="-1"></a><span class="co">  - statistics</span></span>
<span id="cb106-16"><a href="#cb106-16" aria-hidden="true" tabindex="-1"></a><span class="co">  - brms</span></span>
<span id="cb106-17"><a href="#cb106-17" aria-hidden="true" tabindex="-1"></a><span class="co">  - stan</span></span>
<span id="cb106-18"><a href="#cb106-18" aria-hidden="true" tabindex="-1"></a><span class="an">toc-depth:</span><span class="co"> 4</span></span>
<span id="cb106-19"><a href="#cb106-19" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb106-20"><a href="#cb106-20" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb106-21"><a href="#cb106-21" aria-hidden="true" tabindex="-1"></a><span class="co">    fig-cap-location: bottom</span></span>
<span id="cb106-22"><a href="#cb106-22" aria-hidden="true" tabindex="-1"></a><span class="an">bibliography:</span><span class="co"> references.json</span></span>
<span id="cb106-23"><a href="#cb106-23" aria-hidden="true" tabindex="-1"></a><span class="an">resources:</span></span>
<span id="cb106-24"><a href="#cb106-24" aria-hidden="true" tabindex="-1"></a><span class="co">  - "img/parks-rec-ols.mp4"</span></span>
<span id="cb106-25"><a href="#cb106-25" aria-hidden="true" tabindex="-1"></a><span class="an">doi:</span><span class="co"> 10.59350/2mz75-rrc46</span></span>
<span id="cb106-26"><a href="#cb106-26" aria-hidden="true" tabindex="-1"></a><span class="an">citation:</span><span class="co"> true</span></span>
<span id="cb106-27"><a href="#cb106-27" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb106-28"><a href="#cb106-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-29"><a href="#cb106-29" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setup, include=FALSE}</span></span>
<span id="cb106-30"><a href="#cb106-30" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::opts_chunk$set(</span></span>
<span id="cb106-31"><a href="#cb106-31" aria-hidden="true" tabindex="-1"></a><span class="in">  fig.width = 6,</span></span>
<span id="cb106-32"><a href="#cb106-32" aria-hidden="true" tabindex="-1"></a><span class="in">  fig.height = 6 * 0.618,</span></span>
<span id="cb106-33"><a href="#cb106-33" aria-hidden="true" tabindex="-1"></a><span class="in">  fig.retina = 3,</span></span>
<span id="cb106-34"><a href="#cb106-34" aria-hidden="true" tabindex="-1"></a><span class="in">  dev = "ragg_png",</span></span>
<span id="cb106-35"><a href="#cb106-35" aria-hidden="true" tabindex="-1"></a><span class="in">  fig.align = "center",</span></span>
<span id="cb106-36"><a href="#cb106-36" aria-hidden="true" tabindex="-1"></a><span class="in">  out.width = "90%",</span></span>
<span id="cb106-37"><a href="#cb106-37" aria-hidden="true" tabindex="-1"></a><span class="in">  collapse = TRUE,</span></span>
<span id="cb106-38"><a href="#cb106-38" aria-hidden="true" tabindex="-1"></a><span class="in">  cache.extra = 1234  # Change number to invalidate cache</span></span>
<span id="cb106-39"><a href="#cb106-39" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb106-40"><a href="#cb106-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-41"><a href="#cb106-41" aria-hidden="true" tabindex="-1"></a><span class="in">options(</span></span>
<span id="cb106-42"><a href="#cb106-42" aria-hidden="true" tabindex="-1"></a><span class="in">  digits = 4,</span></span>
<span id="cb106-43"><a href="#cb106-43" aria-hidden="true" tabindex="-1"></a><span class="in">  width = 300,</span></span>
<span id="cb106-44"><a href="#cb106-44" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr.summarise.inform = FALSE</span></span>
<span id="cb106-45"><a href="#cb106-45" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb106-46"><a href="#cb106-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-47"><a href="#cb106-47" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(1234)</span></span>
<span id="cb106-48"><a href="#cb106-48" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-49"><a href="#cb106-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-50"><a href="#cb106-50" aria-hidden="true" tabindex="-1"></a><span class="in">```{r tikz-stuff, include=FALSE}</span></span>
<span id="cb106-51"><a href="#cb106-51" aria-hidden="true" tabindex="-1"></a><span class="in"># Necessary for using dvisvgm on macOS</span></span>
<span id="cb106-52"><a href="#cb106-52" aria-hidden="true" tabindex="-1"></a><span class="in"># See https://www.andrewheiss.com/blog/2021/08/27/tikz-knitr-html-svg-fun/</span></span>
<span id="cb106-53"><a href="#cb106-53" aria-hidden="true" tabindex="-1"></a><span class="in">Sys.setenv(LIBGS = "/opt/homebrew/opt/ghostscript/lib/libgs.dylib")</span></span>
<span id="cb106-54"><a href="#cb106-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-55"><a href="#cb106-55" aria-hidden="true" tabindex="-1"></a><span class="in">font_opts &lt;- list(</span></span>
<span id="cb106-56"><a href="#cb106-56" aria-hidden="true" tabindex="-1"></a><span class="in">  extra.preamble = c(</span></span>
<span id="cb106-57"><a href="#cb106-57" aria-hidden="true" tabindex="-1"></a><span class="in">    "\\usepackage{libertine}",</span></span>
<span id="cb106-58"><a href="#cb106-58" aria-hidden="true" tabindex="-1"></a><span class="in">    "\\usepackage{libertinust1math}"</span></span>
<span id="cb106-59"><a href="#cb106-59" aria-hidden="true" tabindex="-1"></a><span class="in">  ),</span></span>
<span id="cb106-60"><a href="#cb106-60" aria-hidden="true" tabindex="-1"></a><span class="in">  dvisvgm.opts = "--font-format=woff"</span></span>
<span id="cb106-61"><a href="#cb106-61" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb106-62"><a href="#cb106-62" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-63"><a href="#cb106-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-64"><a href="#cb106-64" aria-hidden="true" tabindex="-1"></a>I recently <span class="co">[</span><span class="ot">posted a guide</span><span class="co">](https://www.andrewheiss.com/blog/2023/07/25/conjoint-bayesian-frequentist-guide/)</span> (mostly for future-me) about how to analyze conjoint survey data with R. I explore two different estimands that social scientists are interested in—causal average marginal component effects (AMCEs) and descriptive marginal means—and show how to find them with R, with both frequentist and Bayesian approaches.</span>
<span id="cb106-65"><a href="#cb106-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-66"><a href="#cb106-66" aria-hidden="true" tabindex="-1"></a>However, that post is a little wrong. It's not *wrong* wrong, but it is a bit oversimplified.</span>
<span id="cb106-67"><a href="#cb106-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-68"><a href="#cb106-68" aria-hidden="true" tabindex="-1"></a>When political scientists, psychologists, economists, and other social scientists analyze conjoint data, they overwhelmingly do it with <span class="co">[</span><span class="ot">ordinary least squares (OLS) regression</span><span class="co">](https://en.wikipedia.org/wiki/Ordinary_least_squares)</span>, or just standard linear regression (<span class="in">`lm(y ~ x)`</span> in R; <span class="in">`reg y x`</span> in Stata). Even if the outcome is binary, they'll use OLS and call it a linear probability model. The main R package for working with conjoint data in a frequentist way (<span class="co">[</span><span class="ot">{cregg}</span><span class="co">](https://thomasleeper.com/cregg/)</span>) uses OLS and linear probability models. Social scientists (and economists in particular) adore OLS.</span>
<span id="cb106-69"><a href="#cb106-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-70"><a href="#cb106-70" aria-hidden="true" tabindex="-1"></a><span class="in">```{=html}</span></span>
<span id="cb106-71"><a href="#cb106-71" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;figure&gt;</span></span>
<span id="cb106-72"><a href="#cb106-72" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;video controls loop width="90%" style="display: block; margin: auto;"&gt;</span></span>
<span id="cb106-73"><a href="#cb106-73" aria-hidden="true" tabindex="-1"></a><span class="in">  &lt;source src="img/parks-rec-ols.mp4" type="video/mp4"&gt;</span></span>
<span id="cb106-74"><a href="#cb106-74" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;/video&gt;</span></span>
<span id="cb106-75"><a href="#cb106-75" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;figcaption&gt;Video by &lt;a href="https://twitter.com/theotheredmund/status/1349453230762196992"&gt;Edmund Helmer&lt;/a&gt;&lt;/figcaption&gt;</span></span>
<span id="cb106-76"><a href="#cb106-76" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;/figure&gt;</span></span>
<span id="cb106-77"><a href="#cb106-77" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-78"><a href="#cb106-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-79"><a href="#cb106-79" aria-hidden="true" tabindex="-1"></a>In my earlier guide, <span class="co">[</span><span class="ot">I showed how to analyze the data with logistic regression</span><span class="co">](https://www.andrewheiss.com/blog/2023/07/25/conjoint-bayesian-frequentist-guide/#the-overall-model)</span>, but even that is still overly simplified. In reality, conjoint choice-based experiments are more complex than what regular old OLS regression—or even logistic regression—can handle (though I'm sure some econometrician somewhere has a proof showing that OLS works just fine for multinomial conjoint data :shrug:).</span>
<span id="cb106-80"><a href="#cb106-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-81"><a href="#cb106-81" aria-hidden="true" tabindex="-1"></a>A recent paper published in *Political Science Research and Methods* <span class="co">[</span><span class="ot">@JensenMarbleScheve:2021</span><span class="co">]</span> does an excellent job explaining the problem with using plain old OLS to estimate AMCEs and marginal means with conjoint data (<span class="co">[</span><span class="ot">access the preprint here</span><span class="co">](https://williammarble.co/docs/CityLimits-April2020.pdf)</span>). Their main argument boils down to this: OLS throws away too much useful information about (1) the relationships and covariance between the different combinations of feature levels offered to respondents, and (2) individual-specific differences in how respondents react to different feature levels.</span>
<span id="cb106-82"><a href="#cb106-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-83"><a href="#cb106-83" aria-hidden="true" tabindex="-1"></a>Jensen et al. explain three different approaches to analyzing data that has a natural hierarchical structure like conjoint data (where lots of choices related to different "products" are nested within individuals). This also is the same argument from <span class="co">[</span><span class="ot">chapter 15 of *Bayes Rules!*</span><span class="co">](https://www.bayesrulesbook.com/chapter-15)</span>.</span>
<span id="cb106-84"><a href="#cb106-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-85"><a href="#cb106-85" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Pooled data** (<span class="co">[</span><span class="ot">"no room for individuality"</span><span class="co">](https://www.bayesrulesbook.com/chapter-15#ch15-complete)</span>): The easiest way to deal with individual-specific effects is to not to. Lump each choice by each respondent into one big dataset, run OLS on it, and be done. Believe it or not, linear regression right away.</span>
<span id="cb106-86"><a href="#cb106-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-87"><a href="#cb106-87" aria-hidden="true" tabindex="-1"></a>   However, this erases all individual-level heterogeneity and details about how different feature levels interact with individual characteristics.</span>
<span id="cb106-88"><a href="#cb106-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-89"><a href="#cb106-89" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**No pooling** (<span class="co">[</span><span class="ot">"every person for themselves"</span><span class="co">](https://www.bayesrulesbook.com/chapter-15#no-pooling)</span>): An alternative way to deal with individual-specific effects is to run a separate model for each individual. If 800 people participated in the experiment, run 800 different models. That way you can perfectly model the relationship between each individual's characteristics (political party, age, income, education, etc.) with their choices and preferences. </span>
<span id="cb106-90"><a href="#cb106-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-91"><a href="#cb106-91" aria-hidden="true" tabindex="-1"></a>   This sounds neat, but has substantial issues. It'll only show an identified causal effect if each respondent saw every combination of conjoint features at least once. In the candidate experiment <span class="co">[</span><span class="ot">from my previous post</span><span class="co">](https://www.andrewheiss.com/blog/2023/07/25/conjoint-bayesian-frequentist-guide/)</span>, there were 8 features with different counts of attributes: 2 × 6 × 6 × 6 × 2 × 6 × 6 × 6 = 186,624 possibilities. Every respondent would need to see each of the nearly 200,000 options. lol.</span>
<span id="cb106-92"><a href="#cb106-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-93"><a href="#cb106-93" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Partial pooling** (<span class="co">[</span><span class="ot">"a welcome middle ground"</span><span class="co">](https://www.bayesrulesbook.com/chapter-15#partial-pooling-with-hierarchical-models)</span>): Jensen et al.'s solution is to use hierarchical models that allow individual-level characteristics to inform choice-level decisions. As *Bayes Rules!* says:</span>
<span id="cb106-94"><a href="#cb106-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-95"><a href="#cb106-95" aria-hidden="true" tabindex="-1"></a><span class="at">   &gt; </span><span class="co">[</span><span class="ot">T</span><span class="co">]</span><span class="at">hough each group is *unique*, having been sampled from the same population, all groups are connected and thus might contain valuable information about one another.</span></span>
<span id="cb106-96"><a href="#cb106-96" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb106-97"><a href="#cb106-97" aria-hidden="true" tabindex="-1"></a>   In this kind of model, we want individual-level characteristics like age, income, education, etc. to inform the decision to choose specific outcomes and interact with different feature levels in different ways. Not every respondent needs to have seen all 200,000 options—information about respondents with similar characteristics facing similar sets of choices gets shared because of the hierarchical-ness of the model.</span>
<span id="cb106-98"><a href="#cb106-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-99"><a href="#cb106-99" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb106-100"><a href="#cb106-100" aria-hidden="true" tabindex="-1"></a><span class="fu">## Best overview of multilevel models</span></span>
<span id="cb106-101"><a href="#cb106-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-102"><a href="#cb106-102" aria-hidden="true" tabindex="-1"></a>For the best overviews I've found of how multilevel models work, check out these two resources:</span>
<span id="cb106-103"><a href="#cb106-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-104"><a href="#cb106-104" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Chapters 15–17 in <span class="co">[</span><span class="ot">*Bayes Rules!*</span><span class="co">](https://www.bayesrulesbook.com/)</span> (<span class="co">[</span><span class="ot">especially chapter 17</span><span class="co">](https://www.bayesrulesbook.com/chapter-17)</span>)</span>
<span id="cb106-105"><a href="#cb106-105" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Michael Clark's <span class="co">[</span><span class="ot">*Mixed Models with R* guide</span><span class="co">](https://m-clark.github.io/mixed-models-with-R/)</span></span>
<span id="cb106-106"><a href="#cb106-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-107"><a href="#cb106-107" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">I also have a guide here</span><span class="co">](https://www.andrewheiss.com/blog/2021/12/01/multilevel-models-panel-data-guide/)</span>, but it's nowhere near as good as those ↑</span>
<span id="cb106-108"><a href="#cb106-108" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb106-109"><a href="#cb106-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-110"><a href="#cb106-110" aria-hidden="true" tabindex="-1"></a>By using a multilevel hierarchical model, @JensenMarbleScheve:2021 show that we can still find AMCEs and causal effects, just like in my previous guide, but we can take advantage of the far richer heterogeneity that we get from these complex statements. We can make cool statements like this (in an experiment that varied policies related to unions):</span>
<span id="cb106-111"><a href="#cb106-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-112"><a href="#cb106-112" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; On average, Democrats are $x$ percentage points more likely than demographically similar Republicans to support a plan that includes expanding union power, relative to the status quo.</span></span>
<span id="cb106-113"><a href="#cb106-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-114"><a href="#cb106-114" aria-hidden="true" tabindex="-1"></a>Using hierarchical models for conjoint experiments in political science is new and exciting and revolutionary and neat. That's the whole point of Jensen et al.'s paper—it's a call to stop using OLS for everything.</span>
<span id="cb106-115"><a href="#cb106-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-116"><a href="#cb106-116" aria-hidden="true" tabindex="-1"></a>I've been working on a conjoint experiment with my coauthors <span class="co">[</span><span class="ot">Marc Dotson</span><span class="co">](https://marriott.byu.edu/directory/details?id=50683)</span> and <span class="co">[</span><span class="ot">Suparna Chaudhry</span><span class="co">](https://www.suparnachaudhry.com/)</span>. Suparna and I are political scientists and this multilevel stuff in general is still relatively new and wildly underused in the discipline. Marc, though, is a marketing scholar. The marketing world has been using hierarchical models for conjoint experiments for a long time and it's standard practice in that discipline. There's a whole textbook about the hierarchical model approach in marketing <span class="co">[</span><span class="ot">@ChapmanFeit:2019</span><span class="co">]</span>, and these fancy conjoint multilevel models are used widely throughout the marketing industry.</span>
<span id="cb106-117"><a href="#cb106-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-118"><a href="#cb106-118" aria-hidden="true" tabindex="-1"></a>lol at political science, just now discovering this.</span>
<span id="cb106-119"><a href="#cb106-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-120"><a href="#cb106-120" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb106-121"><a href="#cb106-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-122"><a href="#cb106-122" aria-hidden="true" tabindex="-1"></a>So, I need to expand <span class="co">[</span><span class="ot">my previous conjoint guide</span><span class="co">](https://www.andrewheiss.com/blog/2023/07/25/conjoint-bayesian-frequentist-guide/)</span>. That's what this post is for.</span>
<span id="cb106-123"><a href="#cb106-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-124"><a href="#cb106-124" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb106-125"><a href="#cb106-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-126"><a href="#cb106-126" aria-hidden="true" tabindex="-1"></a><span class="fu">## Who this post is for</span></span>
<span id="cb106-127"><a href="#cb106-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-128"><a href="#cb106-128" aria-hidden="true" tabindex="-1"></a>Here's what I assume you know:</span>
<span id="cb106-129"><a href="#cb106-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-130"><a href="#cb106-130" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>You're familiar with <span class="co">[</span><span class="ot">R</span><span class="co">](https://www.r-project.org/)</span> and the <span class="co">[</span><span class="ot">tidyverse</span><span class="co">](https://www.tidyverse.org/)</span> (particularly <span class="co">[</span><span class="ot">{dplyr}</span><span class="co">](https://dplyr.tidyverse.org/)</span> and <span class="co">[</span><span class="ot">{ggplot2}</span><span class="co">](https://ggplot2.tidyverse.org/)</span>).</span>
<span id="cb106-131"><a href="#cb106-131" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>You're familiar with linear regression and packages like <span class="co">[</span><span class="ot">{broom}</span><span class="co">](https://broom.tidymodels.org/)</span> for converting regression results into tidy data frames and <span class="co">[</span><span class="ot">{marginaleffects}</span><span class="co">](https://vincentarelbundock.github.io/marginaleffects/)</span> for calculating <span class="co">[</span><span class="ot">marginal effects</span><span class="co">](https://www.andrewheiss.com/blog/2022/05/20/marginalia/)</span>.</span>
<span id="cb106-132"><a href="#cb106-132" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>You're familiar with <span class="co">[</span><span class="ot">{brms}</span><span class="co">](https://paul-buerkner.github.io/brms/)</span> for running Bayesian regression models and <span class="co">[</span><span class="ot">{tidybayes}</span><span class="co">](https://mjskay.github.io/tidybayes/)</span> and <span class="co">[</span><span class="ot">{ggdist}</span><span class="co">](https://mjskay.github.io/ggdist/)</span> for manipulating and plotting posterior draws. You *don't* need to know how to write stuff in raw Stan.</span>
<span id="cb106-133"><a href="#cb106-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-134"><a href="#cb106-134" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb106-135"><a href="#cb106-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-136"><a href="#cb106-136" aria-hidden="true" tabindex="-1"></a>I'll do three things in this guide:</span>
<span id="cb106-137"><a href="#cb106-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-138"><a href="#cb106-138" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Chocolate**: Analyze a simple choice-based conjoint experiment where respondents only saw one set of options. This is so I can (1) explore the {mlogit} package, and (2) figure out how to work with multinomial models and predictions both frequentistly and Bayesianly.</span>
<span id="cb106-139"><a href="#cb106-139" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Minivans**: Analyze a more complex choice-based conjoint experiment where respondents saw three randomly selected options fifteen times. I do this with both {mlogit} and {brms} to figure out how to work with true multinomial outcomes both frequentistly and Bayesianly.</span>
<span id="cb106-140"><a href="#cb106-140" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Minivans again**: Analyze the same complex choice-based experiment but incorporate respondent-level characteristics into the estimates using a hierarchical or multilevel model. I only do this with {brms} because in reality I have no interest in working with {mlogit} (I only use it here as a sort of baseline for my {brms} explorations).</span>
<span id="cb106-141"><a href="#cb106-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-142"><a href="#cb106-142" aria-hidden="true" tabindex="-1"></a>Throughout this example, I'll use data from two different simulated conjoint choice experiments. You can download these files and follow along:</span>
<span id="cb106-143"><a href="#cb106-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-144"><a href="#cb106-144" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">{{&lt; fa table &gt;}} `choco_candy.csv`</span><span class="co">](data/choco_candy.csv)</span>: This is simulated data for a hypothetical experiment about consumer preferences for candy features. It comes from p. 292 in @Kuhfeld:2010, a <span class="co">[</span><span class="ot">SAS technical note</span><span class="co">](http://support.sas.com/techsup/technote/mr2010f.pdf)</span> about how to run multinomial models in SAS. Instead of copying/pasting from the PDF, <span class="co">[</span><span class="ot">I found a version of it here</span><span class="co">](https://github.com/sangwoo-statistics/dataset)</span>, cleaned up by Sangwoo Kim (who also has <span class="co">[</span><span class="ot">a YouTube tutorial</span><span class="co">](https://www.youtube.com/watch?v=ra8Y2FjRqOE)</span> using the same candy data)</span>
<span id="cb106-145"><a href="#cb106-145" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">{{&lt; fa table &gt;}} `rintro-chapter13conjoint.csv`</span><span class="co">](data/rintro-chapter13conjoint.csv)</span>: This is simultated data for a hypothetical experiment about consumer preferences for minivan features. It comes from chapter 13 in @ChapmanFeit:2019 and is available from the <span class="co">[</span><span class="ot">book's resources page</span><span class="co">](http://r-marketing.r-forge.r-project.org/)</span> (or <span class="co">[</span><span class="ot">directly from their data folder</span><span class="co">](http://r-marketing.r-forge.r-project.org/data/)</span>)</span>
<span id="cb106-146"><a href="#cb106-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-147"><a href="#cb106-147" aria-hidden="true" tabindex="-1"></a>::: {.callout-note #mclogit-note}</span>
<span id="cb106-148"><a href="#cb106-148" aria-hidden="true" tabindex="-1"></a><span class="fu">### {mlogit}, {mclogit}, and {marginaleffects}</span></span>
<span id="cb106-149"><a href="#cb106-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-150"><a href="#cb106-150" aria-hidden="true" tabindex="-1"></a>In September 2024, {marginaleffects} <span class="co">[</span><span class="ot">removed support</span><span class="co">](https://github.com/vincentarelbundock/marginaleffects/commit/9778eef3ad98369c6e8d11ba7e894111ae6b4e94)</span> for {mlogit} because the internal model object structure made it extremely difficult to calculate consistent results.</span>
<span id="cb106-151"><a href="#cb106-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-152"><a href="#cb106-152" aria-hidden="true" tabindex="-1"></a>We can calculate predictions with {mlogit}'s version of <span class="in">`predict()`</span>, but it doesn't include standard errors, so we can't find confidence intervals or other measures of uncertainty without doing fancier things like bootstrapping or using Bayesian methods. The Bayesian approach is the whole point of this tutorial, really, so take the difficulty of {mlogit}-related postestimation work as a call to convert to the wonderful world of {brms} and Bayes. :)</span>
<span id="cb106-153"><a href="#cb106-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-154"><a href="#cb106-154" aria-hidden="true" tabindex="-1"></a>If you're really into frequentism and want to use {marginaleffects}, you can use <span class="co">[</span><span class="ot">the {mclogit} package</span><span class="co">](https://cran.r-project.org/package=mclogit)</span>, which comes with <span class="in">`mclogit()`</span> for fitting conditional logit models just like {mlogit}, but with {marginaleffects} support.</span>
<span id="cb106-155"><a href="#cb106-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-156"><a href="#cb106-156" aria-hidden="true" tabindex="-1"></a>The results that you get from <span class="in">`predict()`</span> and <span class="in">`marginaleffects::predictions()`</span> are different from <span class="in">`mlogit()`</span> and seem to be closer to what happens with {brms}, but working with them is left as an exercise to the reader.</span>
<span id="cb106-157"><a href="#cb106-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-158"><a href="#cb106-158" aria-hidden="true" tabindex="-1"></a>I've included examples of how to fit <span class="in">`mclogit()`</span> models for both the <span class="co">[</span><span class="ot">chocolate example</span><span class="co">](#mclogit-model)</span> and the <span class="co">[</span><span class="ot">minivan example</span><span class="co">](#mclogit-model-1)</span> below.</span>
<span id="cb106-159"><a href="#cb106-159" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb106-160"><a href="#cb106-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-161"><a href="#cb106-161" aria-hidden="true" tabindex="-1"></a>Additionally, in <span class="co">[</span><span class="ot">Part 3</span><span class="co">](#part-3-minivans-repeated-questions-full-hierarchical-multinomial-logit)</span>, I fit a huge Stan model with {brms} that takes ≈30 minutes to run on my fast laptop. If you want to follow along and not melt your CPU for half an hour, you can download an .rds file of that fitted model that I stuck in <span class="co">[</span><span class="ot">an OSF project</span><span class="co">](https://osf.io/3y7es/)</span>. The code for <span class="in">`brm()`</span> later in this guide will load the .rds file automatically instead of rerunning the model as long as you put it in a folder named "models" in your working directory. This code uses the <span class="co">[</span><span class="ot">{osfr} package</span><span class="co">](https://docs.ropensci.org/osfr/)</span> to download <span class="co">[</span><span class="ot">the .rds file from OSF</span><span class="co">](https://osf.io/zp6eh)</span> automatically and places it where it needs to go:</span>
<span id="cb106-162"><a href="#cb106-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-163"><a href="#cb106-163" aria-hidden="true" tabindex="-1"></a><span class="in">```{r get-rds-osf, eval=FALSE}</span></span>
<span id="cb106-164"><a href="#cb106-164" aria-hidden="true" tabindex="-1"></a><span class="in">library(osfr)  # Interact with OSF via R</span></span>
<span id="cb106-165"><a href="#cb106-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-166"><a href="#cb106-166" aria-hidden="true" tabindex="-1"></a><span class="in"># Make a "models" folder if it doesn't exist already</span></span>
<span id="cb106-167"><a href="#cb106-167" aria-hidden="true" tabindex="-1"></a><span class="in">if (!file.exists("models")) { dir.create("models") }</span></span>
<span id="cb106-168"><a href="#cb106-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-169"><a href="#cb106-169" aria-hidden="true" tabindex="-1"></a><span class="in"># Download model_minivans_mega_mlm_brms.rds from OSF</span></span>
<span id="cb106-170"><a href="#cb106-170" aria-hidden="true" tabindex="-1"></a><span class="in">osf_retrieve_file("https://osf.io/zp6eh") |&gt;</span></span>
<span id="cb106-171"><a href="#cb106-171" aria-hidden="true" tabindex="-1"></a><span class="in">  osf_download(path = "models", conflicts = "overwrite", progress = TRUE)</span></span>
<span id="cb106-172"><a href="#cb106-172" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-173"><a href="#cb106-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-174"><a href="#cb106-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-175"><a href="#cb106-175" aria-hidden="true" tabindex="-1"></a>Let's load some libraries, create some helper functions, load the data, and get started!</span>
<span id="cb106-176"><a href="#cb106-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-177"><a href="#cb106-177" aria-hidden="true" tabindex="-1"></a><span class="in">```{r libraries, warning=FALSE, message=FALSE}</span></span>
<span id="cb106-178"><a href="#cb106-178" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidyverse)        # ggplot, dplyr, and friends</span></span>
<span id="cb106-179"><a href="#cb106-179" aria-hidden="true" tabindex="-1"></a><span class="in">library(broom)            # Convert model objects to tidy data frames</span></span>
<span id="cb106-180"><a href="#cb106-180" aria-hidden="true" tabindex="-1"></a><span class="in">library(parameters)       # Show model results as nice tables</span></span>
<span id="cb106-181"><a href="#cb106-181" aria-hidden="true" tabindex="-1"></a><span class="in">library(survey)           # Panel-ish frequentist regression models</span></span>
<span id="cb106-182"><a href="#cb106-182" aria-hidden="true" tabindex="-1"></a><span class="in">library(mlogit)           # Frequentist multinomial regression models</span></span>
<span id="cb106-183"><a href="#cb106-183" aria-hidden="true" tabindex="-1"></a><span class="in">library(dfidx)            # Structure data for {mlogit} models</span></span>
<span id="cb106-184"><a href="#cb106-184" aria-hidden="true" tabindex="-1"></a><span class="in">library(scales)           # Nicer labeling functions</span></span>
<span id="cb106-185"><a href="#cb106-185" aria-hidden="true" tabindex="-1"></a><span class="in">library(marginaleffects)  # Calculate marginal effects</span></span>
<span id="cb106-186"><a href="#cb106-186" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggforce)          # For facet_col()</span></span>
<span id="cb106-187"><a href="#cb106-187" aria-hidden="true" tabindex="-1"></a><span class="in">library(brms)             # The best formula-based interface to Stan</span></span>
<span id="cb106-188"><a href="#cb106-188" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidybayes)        # Manipulate Stan results in tidy ways</span></span>
<span id="cb106-189"><a href="#cb106-189" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggdist)           # Fancy distribution plots</span></span>
<span id="cb106-190"><a href="#cb106-190" aria-hidden="true" tabindex="-1"></a><span class="in">library(patchwork)        # Combine ggplot plots</span></span>
<span id="cb106-191"><a href="#cb106-191" aria-hidden="true" tabindex="-1"></a><span class="in">library(rcartocolor)      # Color palettes from CARTOColors (https://carto.com/carto-colors/)</span></span>
<span id="cb106-192"><a href="#cb106-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-193"><a href="#cb106-193" aria-hidden="true" tabindex="-1"></a><span class="in"># Custom ggplot theme to make pretty plots</span></span>
<span id="cb106-194"><a href="#cb106-194" aria-hidden="true" tabindex="-1"></a><span class="in"># Get the font at https://github.com/intel/clear-sans</span></span>
<span id="cb106-195"><a href="#cb106-195" aria-hidden="true" tabindex="-1"></a><span class="in">theme_nice &lt;- function() {</span></span>
<span id="cb106-196"><a href="#cb106-196" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_minimal(base_family = "Clear Sans") +</span></span>
<span id="cb106-197"><a href="#cb106-197" aria-hidden="true" tabindex="-1"></a><span class="in">    theme(panel.grid.minor = element_blank(),</span></span>
<span id="cb106-198"><a href="#cb106-198" aria-hidden="true" tabindex="-1"></a><span class="in">          plot.title = element_text(family = "Clear Sans", face = "bold"),</span></span>
<span id="cb106-199"><a href="#cb106-199" aria-hidden="true" tabindex="-1"></a><span class="in">          axis.title.x = element_text(hjust = 0),</span></span>
<span id="cb106-200"><a href="#cb106-200" aria-hidden="true" tabindex="-1"></a><span class="in">          axis.title.y = element_text(hjust = 1),</span></span>
<span id="cb106-201"><a href="#cb106-201" aria-hidden="true" tabindex="-1"></a><span class="in">          strip.text = element_text(family = "Clear Sans", face = "bold",</span></span>
<span id="cb106-202"><a href="#cb106-202" aria-hidden="true" tabindex="-1"></a><span class="in">                                    size = rel(0.75), hjust = 0),</span></span>
<span id="cb106-203"><a href="#cb106-203" aria-hidden="true" tabindex="-1"></a><span class="in">          strip.background = element_rect(fill = "grey90", color = NA))</span></span>
<span id="cb106-204"><a href="#cb106-204" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb106-205"><a href="#cb106-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-206"><a href="#cb106-206" aria-hidden="true" tabindex="-1"></a><span class="in">theme_set(theme_nice())</span></span>
<span id="cb106-207"><a href="#cb106-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-208"><a href="#cb106-208" aria-hidden="true" tabindex="-1"></a><span class="in">clrs &lt;- carto_pal(name = "Prism")</span></span>
<span id="cb106-209"><a href="#cb106-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-210"><a href="#cb106-210" aria-hidden="true" tabindex="-1"></a><span class="in"># Functions for formatting things as percentage points</span></span>
<span id="cb106-211"><a href="#cb106-211" aria-hidden="true" tabindex="-1"></a><span class="in">label_pp &lt;- label_number(accuracy = 1, scale = 100, </span></span>
<span id="cb106-212"><a href="#cb106-212" aria-hidden="true" tabindex="-1"></a><span class="in">                         suffix = " pp.", style_negative = "minus")</span></span>
<span id="cb106-213"><a href="#cb106-213" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-214"><a href="#cb106-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-215"><a href="#cb106-215" aria-hidden="true" tabindex="-1"></a><span class="in">```{r load-clean-data, warning=FALSE, message=FALSE}</span></span>
<span id="cb106-216"><a href="#cb106-216" aria-hidden="true" tabindex="-1"></a><span class="in">chocolate &lt;- read_csv("data/choco_candy.csv") %&gt;% </span></span>
<span id="cb106-217"><a href="#cb106-217" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb106-218"><a href="#cb106-218" aria-hidden="true" tabindex="-1"></a><span class="in">    dark = case_match(dark, 0 ~ "Milk", 1 ~ "Dark"),</span></span>
<span id="cb106-219"><a href="#cb106-219" aria-hidden="true" tabindex="-1"></a><span class="in">    dark = factor(dark, levels = c("Milk", "Dark")),</span></span>
<span id="cb106-220"><a href="#cb106-220" aria-hidden="true" tabindex="-1"></a><span class="in">    soft = case_match(soft, 0 ~ "Chewy", 1 ~ "Soft"),</span></span>
<span id="cb106-221"><a href="#cb106-221" aria-hidden="true" tabindex="-1"></a><span class="in">    soft = factor(soft, levels = c("Chewy", "Soft")),</span></span>
<span id="cb106-222"><a href="#cb106-222" aria-hidden="true" tabindex="-1"></a><span class="in">    nuts = case_match(nuts, 0 ~ "No nuts", 1 ~ "Nuts"),</span></span>
<span id="cb106-223"><a href="#cb106-223" aria-hidden="true" tabindex="-1"></a><span class="in">    nuts = factor(nuts, levels = c("No nuts", "Nuts"))</span></span>
<span id="cb106-224"><a href="#cb106-224" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb106-225"><a href="#cb106-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-226"><a href="#cb106-226" aria-hidden="true" tabindex="-1"></a><span class="in">minivans &lt;- read_csv("data/rintro-chapter13conjoint.csv") %&gt;% </span></span>
<span id="cb106-227"><a href="#cb106-227" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb106-228"><a href="#cb106-228" aria-hidden="true" tabindex="-1"></a><span class="in">    across(c(seat, cargo, price), factor),</span></span>
<span id="cb106-229"><a href="#cb106-229" aria-hidden="true" tabindex="-1"></a><span class="in">    carpool = factor(carpool, levels = c("no", "yes")),</span></span>
<span id="cb106-230"><a href="#cb106-230" aria-hidden="true" tabindex="-1"></a><span class="in">    eng = factor(eng, levels = c("gas", "hyb", "elec"))</span></span>
<span id="cb106-231"><a href="#cb106-231" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb106-232"><a href="#cb106-232" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-233"><a href="#cb106-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-234"><a href="#cb106-234" aria-hidden="true" tabindex="-1"></a>\ </span>
<span id="cb106-235"><a href="#cb106-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-236"><a href="#cb106-236" aria-hidden="true" tabindex="-1"></a><span class="fu"># Part 1: Candy; single question; basic multinomial logit</span></span>
<span id="cb106-237"><a href="#cb106-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-238"><a href="#cb106-238" aria-hidden="true" tabindex="-1"></a><span class="fu">## The setup</span></span>
<span id="cb106-239"><a href="#cb106-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-240"><a href="#cb106-240" aria-hidden="true" tabindex="-1"></a>In this experiment, respondents are asked to choose which of these kinds of candies they'd want to buy. Respondents only see this question one time and all possible options are presented simultaneously.</span>
<span id="cb106-241"><a href="#cb106-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-242"><a href="#cb106-242" aria-hidden="true" tabindex="-1"></a>:::: {.callout-tip}</span>
<span id="cb106-243"><a href="#cb106-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-244"><a href="#cb106-244" aria-hidden="true" tabindex="-1"></a><span class="fu">### Example survey question</span></span>
<span id="cb106-245"><a href="#cb106-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-246"><a href="#cb106-246" aria-hidden="true" tabindex="-1"></a>|           |                A                |                B                |                C                |                D                |                E                |                F                |                G                |                H                |</span>
<span id="cb106-247"><a href="#cb106-247" aria-hidden="true" tabindex="-1"></a>|--------|:------:|:------:|:------:|:------:|:------:|:------:|:------:|:------:|</span>
<span id="cb106-248"><a href="#cb106-248" aria-hidden="true" tabindex="-1"></a>| Chocolate |              Milk               |              Milk               |              Milk               |              Milk               |              Dark               |              Dark               |              Dark               |              Dark               |</span>
<span id="cb106-249"><a href="#cb106-249" aria-hidden="true" tabindex="-1"></a>| Center    |              Chewy              |              Chewy              |              Soft               |              Soft               |              Chewy              |              Chewy              |              Soft               |              Soft               |</span>
<span id="cb106-250"><a href="#cb106-250" aria-hidden="true" tabindex="-1"></a>| Nuts      |             No nuts             |              Nuts               |             No nuts             |              Nuts               |             No nuts             |              Nuts               |             No nuts             |              Nuts               |</span>
<span id="cb106-251"><a href="#cb106-251" aria-hidden="true" tabindex="-1"></a>| Choice    | &lt;input type="radio" name="ex1"&gt; | &lt;input type="radio" name="ex1"&gt; | &lt;input type="radio" name="ex1"&gt; | &lt;input type="radio" name="ex1"&gt; | &lt;input type="radio" name="ex1"&gt; | &lt;input type="radio" name="ex1"&gt; | &lt;input type="radio" name="ex1"&gt; | &lt;input type="radio" name="ex1"&gt; |</span>
<span id="cb106-252"><a href="#cb106-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-253"><a href="#cb106-253" aria-hidden="true" tabindex="-1"></a>::::</span>
<span id="cb106-254"><a href="#cb106-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-255"><a href="#cb106-255" aria-hidden="true" tabindex="-1"></a><span class="fu">## The data</span></span>
<span id="cb106-256"><a href="#cb106-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-257"><a href="#cb106-257" aria-hidden="true" tabindex="-1"></a>The data for this kind of experiment looks like this, with one row for each possible alternative (so eight rows per person, or <span class="in">`subj`</span>), with the alternative that was selected marked as 1 in <span class="in">`choice`</span>. Here, Subject 1 chose option E (dark, chewy, no nuts). There were 10 respondents, with 8 rows each, so there are 10 × 8 = 80 rows.</span>
<span id="cb106-258"><a href="#cb106-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-259"><a href="#cb106-259" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-chocolate}</span></span>
<span id="cb106-260"><a href="#cb106-260" aria-hidden="true" tabindex="-1"></a><span class="in">chocolate</span></span>
<span id="cb106-261"><a href="#cb106-261" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-262"><a href="#cb106-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-263"><a href="#cb106-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-264"><a href="#cb106-264" aria-hidden="true" tabindex="-1"></a><span class="fu">## The model</span></span>
<span id="cb106-265"><a href="#cb106-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-266"><a href="#cb106-266" aria-hidden="true" tabindex="-1"></a>Respondents were shown eight different options and asked to select one. While this seems like a binary yes/no choice that could work with just regular plain old logistic regression, we want to account for the features and levels in all the unchosen categories too. To do this, we can use <span class="co">[</span><span class="ot">multinomial logistic regression</span><span class="co">](https://en.wikipedia.org/wiki/Multinomial_logistic_regression)</span>, where the outcome variable is an unordered categorical variable with more than two categories. In this case we have eight different possible outcomes: alternatives A through H.</span>
<span id="cb106-267"><a href="#cb106-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-268"><a href="#cb106-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-269"><a href="#cb106-269" aria-hidden="true" tabindex="-1"></a><span class="fu">### Original SAS model as a baseline</span></span>
<span id="cb106-270"><a href="#cb106-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-271"><a href="#cb106-271" aria-hidden="true" tabindex="-1"></a>::: {.callout-warning}</span>
<span id="cb106-272"><a href="#cb106-272" aria-hidden="true" tabindex="-1"></a><span class="fu">#### lol SAS</span></span>
<span id="cb106-273"><a href="#cb106-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-274"><a href="#cb106-274" aria-hidden="true" tabindex="-1"></a>I know nothing about SAS. I have never opened SAS in my life. It is a mystery to me.</span>
<span id="cb106-275"><a href="#cb106-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-276"><a href="#cb106-276" aria-hidden="true" tabindex="-1"></a>I copied these results directly from p. 297 in SAS's massive <span class="co">[</span><span class="ot">"Discrete Choice" technical note</span><span class="co">](http://support.sas.com/techsup/technote/mr2010f.pdf)</span> <span class="co">[</span><span class="ot">@Kuhfeld:2010</span><span class="co">]</span>.</span>
<span id="cb106-277"><a href="#cb106-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-278"><a href="#cb106-278" aria-hidden="true" tabindex="-1"></a>I only have this SAS output here as a baseline reference for what the actual correct coefficients are supposed to be.</span>
<span id="cb106-279"><a href="#cb106-279" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb106-280"><a href="#cb106-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-281"><a href="#cb106-281" aria-hidden="true" tabindex="-1"></a>SAS apparently fits these models with proportional hazard survival-style models, which feels weird, but there's probably a mathematical or statistical reason for it. You use PROC PHREG to do it:</span>
<span id="cb106-282"><a href="#cb106-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-283"><a href="#cb106-283" aria-hidden="true" tabindex="-1"></a><span class="in">```default</span></span>
<span id="cb106-284"><a href="#cb106-284" aria-hidden="true" tabindex="-1"></a><span class="in">proc phreg data=chocs outest=betas;</span></span>
<span id="cb106-285"><a href="#cb106-285" aria-hidden="true" tabindex="-1"></a><span class="in">   strata subj set;</span></span>
<span id="cb106-286"><a href="#cb106-286" aria-hidden="true" tabindex="-1"></a><span class="in">   model c*c(2) = dark soft nuts / ties=breslow;</span></span>
<span id="cb106-287"><a href="#cb106-287" aria-hidden="true" tabindex="-1"></a><span class="in">   run;</span></span>
<span id="cb106-288"><a href="#cb106-288" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-289"><a href="#cb106-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-290"><a href="#cb106-290" aria-hidden="true" tabindex="-1"></a>It gives these results:</span>
<span id="cb106-291"><a href="#cb106-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-292"><a href="#cb106-292" aria-hidden="true" tabindex="-1"></a><span class="in">```default</span></span>
<span id="cb106-293"><a href="#cb106-293" aria-hidden="true" tabindex="-1"></a><span class="in">                   Choice of Chocolate Candies</span></span>
<span id="cb106-294"><a href="#cb106-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-295"><a href="#cb106-295" aria-hidden="true" tabindex="-1"></a><span class="in">                       The PHREG Procedure</span></span>
<span id="cb106-296"><a href="#cb106-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-297"><a href="#cb106-297" aria-hidden="true" tabindex="-1"></a><span class="in">              Multinomial Logit Parameter Estimates</span></span>
<span id="cb106-298"><a href="#cb106-298" aria-hidden="true" tabindex="-1"></a><span class="in">              </span></span>
<span id="cb106-299"><a href="#cb106-299" aria-hidden="true" tabindex="-1"></a><span class="in">                      Parameter     Standard</span></span>
<span id="cb106-300"><a href="#cb106-300" aria-hidden="true" tabindex="-1"></a><span class="in">                 DF    Estimate        Error  Chi-Square   Pr &gt; ChiSq</span></span>
<span id="cb106-301"><a href="#cb106-301" aria-hidden="true" tabindex="-1"></a><span class="in">Dark Chocolate   1      1.38629      0.79057      3.0749       0.0795</span></span>
<span id="cb106-302"><a href="#cb106-302" aria-hidden="true" tabindex="-1"></a><span class="in">Soft Center      1     -2.19722      1.05409      4.3450       0.0371</span></span>
<span id="cb106-303"><a href="#cb106-303" aria-hidden="true" tabindex="-1"></a><span class="in">With Nuts        1      0.84730      0.69007      1.5076       0.2195</span></span>
<span id="cb106-304"><a href="#cb106-304" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-305"><a href="#cb106-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-306"><a href="#cb106-306" aria-hidden="true" tabindex="-1"></a><span class="fu">### Survival model</span></span>
<span id="cb106-307"><a href="#cb106-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-308"><a href="#cb106-308" aria-hidden="true" tabindex="-1"></a>Ew, enough SAS. Let's do this with R instead.</span>
<span id="cb106-309"><a href="#cb106-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-310"><a href="#cb106-310" aria-hidden="true" tabindex="-1"></a>We can recreate the same proportional hazards model with <span class="in">`coxph()`</span> from the {survival} package. Again, this feels weird and not like an intended purpose of survival models and not like multinomial logit at all—in my mind it is neither (1) multinomial nor (2) logit, but whatever. People far smarter than me invented these things, so I'll just trust them.</span>
<span id="cb106-311"><a href="#cb106-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-312"><a href="#cb106-312" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-chocolate-survival, message=FALSE}</span></span>
<span id="cb106-313"><a href="#cb106-313" aria-hidden="true" tabindex="-1"></a><span class="in">model_chocolate_survival &lt;- coxph(</span></span>
<span id="cb106-314"><a href="#cb106-314" aria-hidden="true" tabindex="-1"></a><span class="in">  Surv(subj, choice) ~ dark + soft + nuts, </span></span>
<span id="cb106-315"><a href="#cb106-315" aria-hidden="true" tabindex="-1"></a><span class="in">  data = chocolate, </span></span>
<span id="cb106-316"><a href="#cb106-316" aria-hidden="true" tabindex="-1"></a><span class="in">  ties = "breslow"  # This is what SAS uses</span></span>
<span id="cb106-317"><a href="#cb106-317" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb106-318"><a href="#cb106-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-319"><a href="#cb106-319" aria-hidden="true" tabindex="-1"></a><span class="in">model_parameters(model_chocolate_survival, digits = 4, p_digits = 4)</span></span>
<span id="cb106-320"><a href="#cb106-320" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-321"><a href="#cb106-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-322"><a href="#cb106-322" aria-hidden="true" tabindex="-1"></a>The coefficients, standard errors, and p-values are identical to the SAS output! The only difference is the statistic: in SAS they use a chi-square statistic, while <span class="in">`survival:coxph()`</span> uses a z statistic. There's probably a way to make <span class="in">`coxph()`</span> use a chi-square statistic, but I don't care about that. I never use survival models and I'm only doing this to replicate the SAS output and it just doesn't matter.</span>
<span id="cb106-323"><a href="#cb106-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-324"><a href="#cb106-324" aria-hidden="true" tabindex="-1"></a><span class="fu">### Poisson model</span></span>
<span id="cb106-325"><a href="#cb106-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-326"><a href="#cb106-326" aria-hidden="true" tabindex="-1"></a>An alternative way to fit a multinomial logit model without resorting to survival models is to actually (mis?)use another model family. We can use a Poisson model, even though <span class="in">`choice`</span> isn't technically count data, because of obscure stats reasons. <span class="co">[</span><span class="ot">See here</span><span class="co">](https://online.stat.psu.edu/stat504/lesson/2/2.3/2.3.6)</span> for an illustration of the relationship between multinomial and Poisson distributions; or <span class="co">[</span><span class="ot">see this 2011 *Biometrika* paper</span><span class="co">](https://doi.org/10.1093/biomet/asr026)</span> about using Poisson models to reduce bias in multinomial logit models. Richard McElreath has a subsection about this in *Statistical Rethinking* as well: "Multinomial in disguise as Poisson" (11.3.3). Or <span class="co">[</span><span class="ot">as he said over on the currently-walled-garden Bluesky</span><span class="co">](https://bsky.app/profile/rmcelreath.bsky.social/post/3k4e5s6zbxc2j)</span>, "All count distributions are just one or more Poisson distributions in a trench coat." </span>
<span id="cb106-327"><a href="#cb106-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-328"><a href="#cb106-328" aria-hidden="true" tabindex="-1"></a>To account for the repeated subjects in the data, we'll use <span class="in">`svyglm()`</span> from the {survey} package so that the standard errors are more accurate.</span>
<span id="cb106-329"><a href="#cb106-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-330"><a href="#cb106-330" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-chocolate-poisson, message=FALSE}</span></span>
<span id="cb106-331"><a href="#cb106-331" aria-hidden="true" tabindex="-1"></a><span class="in">model_chocolate_poisson &lt;- glm(</span></span>
<span id="cb106-332"><a href="#cb106-332" aria-hidden="true" tabindex="-1"></a><span class="in">  choice ~ dark + soft + nuts, </span></span>
<span id="cb106-333"><a href="#cb106-333" aria-hidden="true" tabindex="-1"></a><span class="in">  data = chocolate, </span></span>
<span id="cb106-334"><a href="#cb106-334" aria-hidden="true" tabindex="-1"></a><span class="in">  family = poisson()</span></span>
<span id="cb106-335"><a href="#cb106-335" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb106-336"><a href="#cb106-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-337"><a href="#cb106-337" aria-hidden="true" tabindex="-1"></a><span class="in">model_parameters(model_chocolate_poisson, digits = 4, p_digits = 4)</span></span>
<span id="cb106-338"><a href="#cb106-338" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-339"><a href="#cb106-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-340"><a href="#cb106-340" aria-hidden="true" tabindex="-1"></a>Lovely—the results are the same.</span>
<span id="cb106-341"><a href="#cb106-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-342"><a href="#cb106-342" aria-hidden="true" tabindex="-1"></a><span class="fu">### `mlogit` model</span></span>
<span id="cb106-343"><a href="#cb106-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-344"><a href="#cb106-344" aria-hidden="true" tabindex="-1"></a>Finally, we can use the {mlogit} package to fit the model. Before using <span class="in">`mlogit()`</span>, we need to transform our data a bit to specify which column represents the choice (<span class="in">`choice)`</span> and how the data is indexed: subjects (<span class="in">`subj`</span>) with repeated alternatives (<span class="in">`alt`</span>).</span>
<span id="cb106-345"><a href="#cb106-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-346"><a href="#cb106-346" aria-hidden="true" tabindex="-1"></a><span class="in">```{r make-dfidx-chocolate}</span></span>
<span id="cb106-347"><a href="#cb106-347" aria-hidden="true" tabindex="-1"></a><span class="in">chocolate_idx &lt;- dfidx(</span></span>
<span id="cb106-348"><a href="#cb106-348" aria-hidden="true" tabindex="-1"></a><span class="in">  chocolate,</span></span>
<span id="cb106-349"><a href="#cb106-349" aria-hidden="true" tabindex="-1"></a><span class="in">  idx = list("subj", "alt"),</span></span>
<span id="cb106-350"><a href="#cb106-350" aria-hidden="true" tabindex="-1"></a><span class="in">  choice = "choice",</span></span>
<span id="cb106-351"><a href="#cb106-351" aria-hidden="true" tabindex="-1"></a><span class="in">  shape = "long"</span></span>
<span id="cb106-352"><a href="#cb106-352" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb106-353"><a href="#cb106-353" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-354"><a href="#cb106-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-355"><a href="#cb106-355" aria-hidden="true" tabindex="-1"></a>We can then use this indexed data frame with <span class="in">`mlogit()`</span>, which uses the familiar R formula interface, but with some extra features separated by <span class="in">`|`</span>s</span>
<span id="cb106-356"><a href="#cb106-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-357"><a href="#cb106-357" aria-hidden="true" tabindex="-1"></a><span class="in">```default</span></span>
<span id="cb106-358"><a href="#cb106-358" aria-hidden="true" tabindex="-1"></a><span class="in">outcome ~ features | individual-level variables | alternative-level variables</span></span>
<span id="cb106-359"><a href="#cb106-359" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-360"><a href="#cb106-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-361"><a href="#cb106-361" aria-hidden="true" tabindex="-1"></a>If we had columns related to individual-level characteristics or alternative-level characteristics, we could include those in the model—and we'll do precisely that later in this post. (Incorporating individual-level covariates is the whole point of this post!)</span>
<span id="cb106-362"><a href="#cb106-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-363"><a href="#cb106-363" aria-hidden="true" tabindex="-1"></a>Let's fit the model:</span>
<span id="cb106-364"><a href="#cb106-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-365"><a href="#cb106-365" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-chocolate-mlogit, message=FALSE}</span></span>
<span id="cb106-366"><a href="#cb106-366" aria-hidden="true" tabindex="-1"></a><span class="in">model_chocolate_mlogit &lt;- mlogit(</span></span>
<span id="cb106-367"><a href="#cb106-367" aria-hidden="true" tabindex="-1"></a><span class="in">  choice ~ dark + soft + nuts | 0 | 0, </span></span>
<span id="cb106-368"><a href="#cb106-368" aria-hidden="true" tabindex="-1"></a><span class="in">  data = chocolate_idx</span></span>
<span id="cb106-369"><a href="#cb106-369" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb106-370"><a href="#cb106-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-371"><a href="#cb106-371" aria-hidden="true" tabindex="-1"></a><span class="in">model_parameters(model_chocolate_mlogit, digits = 4, p_digits = 4)</span></span>
<span id="cb106-372"><a href="#cb106-372" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-373"><a href="#cb106-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-374"><a href="#cb106-374" aria-hidden="true" tabindex="-1"></a>Delightful. All the results are the same as the survival model and the Poisson model.</span>
<span id="cb106-375"><a href="#cb106-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-376"><a href="#cb106-376" aria-hidden="true" tabindex="-1"></a><span class="fu">### `mclogit` model</span></span>
<span id="cb106-377"><a href="#cb106-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-378"><a href="#cb106-378" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">As noted earlier</span><span class="co">](#mclogit-note)</span>, {marginaleffects} doesn't support <span class="in">`mlogit()`</span> because of its weird internal structure. It *does* support <span class="in">`mclogit::mclogit()`</span> though.</span>
<span id="cb106-379"><a href="#cb106-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-380"><a href="#cb106-380" aria-hidden="true" tabindex="-1"></a>The syntax requires two parts on the left-hand side of the formula: (1) the choice selected (0 or 1), and (2) a unique id for set of choices, or the question. In this case, since each subject only saw one question, the <span class="in">`subj`</span> column doubles as the question ID, so we can just use that.</span>
<span id="cb106-381"><a href="#cb106-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-382"><a href="#cb106-382" aria-hidden="true" tabindex="-1"></a>The results are the same:</span>
<span id="cb106-383"><a href="#cb106-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-384"><a href="#cb106-384" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mclogit-example-chocolate}</span></span>
<span id="cb106-385"><a href="#cb106-385" aria-hidden="true" tabindex="-1"></a><span class="in">library(mclogit)</span></span>
<span id="cb106-386"><a href="#cb106-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-387"><a href="#cb106-387" aria-hidden="true" tabindex="-1"></a><span class="in">model_chocolate_mclogit &lt;- mclogit(</span></span>
<span id="cb106-388"><a href="#cb106-388" aria-hidden="true" tabindex="-1"></a><span class="in">  choice | subj ~ dark + soft + nuts,</span></span>
<span id="cb106-389"><a href="#cb106-389" aria-hidden="true" tabindex="-1"></a><span class="in">  data = chocolate</span></span>
<span id="cb106-390"><a href="#cb106-390" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb106-391"><a href="#cb106-391" aria-hidden="true" tabindex="-1"></a><span class="in">model_parameters(model_chocolate_mclogit, digits = 4, p_digits = 4)</span></span>
<span id="cb106-392"><a href="#cb106-392" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-393"><a href="#cb106-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-394"><a href="#cb106-394" aria-hidden="true" tabindex="-1"></a><span class="fu">### Bayesian model</span></span>
<span id="cb106-395"><a href="#cb106-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-396"><a href="#cb106-396" aria-hidden="true" tabindex="-1"></a>We can also fit this model in a Bayesian way using {brms}. Stan has a categorical distribution family for multinomial models, and we'll use it in the next example. For now, for the sake of simplicity, we'll use a Poisson family, since, as we saw above, that's a legal way of parameterizing multinomial distributions.</span>
<span id="cb106-397"><a href="#cb106-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-398"><a href="#cb106-398" aria-hidden="true" tabindex="-1"></a>The data has a natural hierarchical structure to it, with 8 choices (for alternatives A through H) nested inside each of the 10 subjects.</span>
<span id="cb106-399"><a href="#cb106-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-400"><a href="#cb106-400" aria-hidden="true" tabindex="-1"></a><span class="in">```{tikz chocolate-multilevel-structure, engine.opts=font_opts}</span></span>
<span id="cb106-401"><a href="#cb106-401" aria-hidden="true" tabindex="-1"></a><span class="in">#| echo: false</span></span>
<span id="cb106-402"><a href="#cb106-402" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: "Multilevel experimental structure, with candy choices $y_{\\text{A}\\dots\\text{H}}$ nested in subjects"</span></span>
<span id="cb106-403"><a href="#cb106-403" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-align: center</span></span>
<span id="cb106-404"><a href="#cb106-404" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-ext: svg</span></span>
<span id="cb106-405"><a href="#cb106-405" aria-hidden="true" tabindex="-1"></a><span class="in">#| out-width: 100%</span></span>
<span id="cb106-406"><a href="#cb106-406" aria-hidden="true" tabindex="-1"></a><span class="in">\usetikzlibrary{positioning}</span></span>
<span id="cb106-407"><a href="#cb106-407" aria-hidden="true" tabindex="-1"></a><span class="in">\usetikzlibrary{shapes.geometric}</span></span>
<span id="cb106-408"><a href="#cb106-408" aria-hidden="true" tabindex="-1"></a><span class="in">\begin{tikzpicture}[{every node/.append style}=draw]</span></span>
<span id="cb106-409"><a href="#cb106-409" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [rectangle] (respondent1) at (0, 2.5) {Subject 1};</span></span>
<span id="cb106-410"><a href="#cb106-410" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [ellipse] (y11) at (-1.5, 1) {$y_{\text{A}_1}$};</span></span>
<span id="cb106-411"><a href="#cb106-411" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [draw=none] (y21) at (0, 1) {$\dots$};</span></span>
<span id="cb106-412"><a href="#cb106-412" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [ellipse] (y31) at (1.5, 1) {$y_{\text{H}_1}$};</span></span>
<span id="cb106-413"><a href="#cb106-413" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (respondent1) to (y11);</span></span>
<span id="cb106-414"><a href="#cb106-414" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (respondent1) to (y21);</span></span>
<span id="cb106-415"><a href="#cb106-415" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (respondent1) to (y31);</span></span>
<span id="cb106-416"><a href="#cb106-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-417"><a href="#cb106-417" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [rectangle] (respondent2) at (4.5, 2.5) {Subject 2};</span></span>
<span id="cb106-418"><a href="#cb106-418" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [ellipse] (y12) at (3, 1) {$y_{\text{A}_2}$};</span></span>
<span id="cb106-419"><a href="#cb106-419" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [draw=none] (y22) at (4.5, 1) {$\dots$};</span></span>
<span id="cb106-420"><a href="#cb106-420" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [ellipse] (y32) at (6, 1) {$y_{\text{H}_2}$};</span></span>
<span id="cb106-421"><a href="#cb106-421" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (respondent2) to (y12);</span></span>
<span id="cb106-422"><a href="#cb106-422" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (respondent2) to (y22);</span></span>
<span id="cb106-423"><a href="#cb106-423" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (respondent2) to (y32);</span></span>
<span id="cb106-424"><a href="#cb106-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-425"><a href="#cb106-425" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [ellipse, draw=white] (dots_top) at (7.25, 2.5) {$\dots$};</span></span>
<span id="cb106-426"><a href="#cb106-426" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [ellipse, draw=white] (dots_bottom) at (7.25, 1) {$\dots$};</span></span>
<span id="cb106-427"><a href="#cb106-427" aria-hidden="true" tabindex="-1"></a><span class="in">    \draw [-latex] (dots_top) to (dots_bottom);</span></span>
<span id="cb106-428"><a href="#cb106-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-429"><a href="#cb106-429" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [rectangle] (respondentn) at (10, 2.5) {Subject 10};</span></span>
<span id="cb106-430"><a href="#cb106-430" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [ellipse] (y1n) at (8.5, 1) {$y_{\text{A}_{10}}$};</span></span>
<span id="cb106-431"><a href="#cb106-431" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [draw=none] (y2n) at (10, 1) {$\dots$};</span></span>
<span id="cb106-432"><a href="#cb106-432" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [ellipse] (y3n) at (11.5, 1) {$y_{\text{H}_{10}}$};</span></span>
<span id="cb106-433"><a href="#cb106-433" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (respondentn) to (y1n);</span></span>
<span id="cb106-434"><a href="#cb106-434" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (respondentn) to (y2n);</span></span>
<span id="cb106-435"><a href="#cb106-435" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (respondentn) to (y3n);</span></span>
<span id="cb106-436"><a href="#cb106-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-437"><a href="#cb106-437" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [rectangle] (population) at (5, 4) {Population of experiment subjects};</span></span>
<span id="cb106-438"><a href="#cb106-438" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (population) to (respondent1);</span></span>
<span id="cb106-439"><a href="#cb106-439" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (population) to (respondent2);</span></span>
<span id="cb106-440"><a href="#cb106-440" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (population) to (dots_top);</span></span>
<span id="cb106-441"><a href="#cb106-441" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (population) to (respondentn);</span></span>
<span id="cb106-442"><a href="#cb106-442" aria-hidden="true" tabindex="-1"></a><span class="in">\end{tikzpicture}</span></span>
<span id="cb106-443"><a href="#cb106-443" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-444"><a href="#cb106-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-445"><a href="#cb106-445" aria-hidden="true" tabindex="-1"></a>We want to model candy choice (<span class="in">`choice`</span>) based on candy characteristics (<span class="in">`dark`</span>, <span class="in">`soft`</span>, and <span class="in">`nuts`</span>). We'll use the subscript $i$ to refer to individual candy choices and $j$ to refer to subjects. </span>
<span id="cb106-446"><a href="#cb106-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-447"><a href="#cb106-447" aria-hidden="true" tabindex="-1"></a>Since we can legally pretend that this multinomial selection process is actually Poisson, we'll model it as a Poisson process that has a rate of $\lambda_{i_j}$. We'll model that $\lambda_{i_j}$ with a log-linked regression model with covariates for each of the levels of each candy feature. To account for the multilevel structure, we'll include subject-specific offsets ($b_{0_j}$) from the global average, thus creating random intercepts. We'll specify fairly wide priors just because.</span>
<span id="cb106-448"><a href="#cb106-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-449"><a href="#cb106-449" aria-hidden="true" tabindex="-1"></a>Here's the formal model for all this:</span>
<span id="cb106-450"><a href="#cb106-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-451"><a href="#cb106-451" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-452"><a href="#cb106-452" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb106-453"><a href="#cb106-453" aria-hidden="true" tabindex="-1"></a>&amp;\ \textbf{Probability of selection of alternative}_i \textbf{ in subject}_j <span class="sc">\\</span></span>
<span id="cb106-454"><a href="#cb106-454" aria-hidden="true" tabindex="-1"></a>\text{Choice}_{i_j} \sim&amp;\ \operatorname{Poisson}(\lambda_{i_j}) <span class="sc">\\</span><span class="co">[</span><span class="ot">10pt</span><span class="co">]</span></span>
<span id="cb106-455"><a href="#cb106-455" aria-hidden="true" tabindex="-1"></a>&amp;\ \textbf{Model for probability of each option} <span class="sc">\\</span></span>
<span id="cb106-456"><a href="#cb106-456" aria-hidden="true" tabindex="-1"></a>\log(\lambda_{i_j}) =&amp;\ (\beta_0 + b_{0_j}) + \beta_1 \text{Dark}_{i_j} + \beta_2 \text{Soft}_{i_j} + \beta_3 \text{Nuts}_{i_j} <span class="sc">\\</span><span class="co">[</span><span class="ot">5pt</span><span class="co">]</span></span>
<span id="cb106-457"><a href="#cb106-457" aria-hidden="true" tabindex="-1"></a>b_{0_j} \sim&amp;\ \mathcal{N}(0, \sigma_0) \qquad\qquad\quad \text{Subject-specific offsets from global choice probability} <span class="sc">\\</span><span class="co">[</span><span class="ot">10pt</span><span class="co">]</span></span>
<span id="cb106-458"><a href="#cb106-458" aria-hidden="true" tabindex="-1"></a>&amp;\ \textbf{Priors} <span class="sc">\\</span></span>
<span id="cb106-459"><a href="#cb106-459" aria-hidden="true" tabindex="-1"></a>\beta_0 \sim&amp;\ \mathcal{N}(0, 3) \qquad\qquad\quad\ \ \text{Prior for global average choice probability} <span class="sc">\\</span></span>
<span id="cb106-460"><a href="#cb106-460" aria-hidden="true" tabindex="-1"></a>\beta_1, \beta_2, \beta_3 \sim&amp;\ \mathcal{N}(0, 3) \qquad\qquad\quad\ \ \text{Prior for candy feature levels} <span class="sc">\\</span></span>
<span id="cb106-461"><a href="#cb106-461" aria-hidden="true" tabindex="-1"></a>\sigma_0 \sim&amp;\ \operatorname{Exponential}(1) \qquad \text{Prior for between-subject variability}</span>
<span id="cb106-462"><a href="#cb106-462" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb106-463"><a href="#cb106-463" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-464"><a href="#cb106-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-465"><a href="#cb106-465" aria-hidden="true" tabindex="-1"></a>And here's the {brms} model:</span>
<span id="cb106-466"><a href="#cb106-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-467"><a href="#cb106-467" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-chocolate-brms}</span></span>
<span id="cb106-468"><a href="#cb106-468" aria-hidden="true" tabindex="-1"></a><span class="in">model_chocolate_brms &lt;- brm(</span></span>
<span id="cb106-469"><a href="#cb106-469" aria-hidden="true" tabindex="-1"></a><span class="in">  bf(choice ~ dark + soft + nuts + (1 | subj)),</span></span>
<span id="cb106-470"><a href="#cb106-470" aria-hidden="true" tabindex="-1"></a><span class="in">  data = chocolate,</span></span>
<span id="cb106-471"><a href="#cb106-471" aria-hidden="true" tabindex="-1"></a><span class="in">  family = poisson(),</span></span>
<span id="cb106-472"><a href="#cb106-472" aria-hidden="true" tabindex="-1"></a><span class="in">  prior = c(</span></span>
<span id="cb106-473"><a href="#cb106-473" aria-hidden="true" tabindex="-1"></a><span class="in">    prior(normal(0, 3), class = Intercept),</span></span>
<span id="cb106-474"><a href="#cb106-474" aria-hidden="true" tabindex="-1"></a><span class="in">    prior(normal(0, 3), class = b),</span></span>
<span id="cb106-475"><a href="#cb106-475" aria-hidden="true" tabindex="-1"></a><span class="in">    prior(exponential(1), class = sd)</span></span>
<span id="cb106-476"><a href="#cb106-476" aria-hidden="true" tabindex="-1"></a><span class="in">  ),</span></span>
<span id="cb106-477"><a href="#cb106-477" aria-hidden="true" tabindex="-1"></a><span class="in">  chains = 4, cores = 4, iter = 2000, seed = 1234,</span></span>
<span id="cb106-478"><a href="#cb106-478" aria-hidden="true" tabindex="-1"></a><span class="in">  backend = "cmdstanr", threads = threading(2), refresh = 0,</span></span>
<span id="cb106-479"><a href="#cb106-479" aria-hidden="true" tabindex="-1"></a><span class="in">  file = "models/model_chocolate_brms"</span></span>
<span id="cb106-480"><a href="#cb106-480" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb106-481"><a href="#cb106-481" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-482"><a href="#cb106-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-483"><a href="#cb106-483" aria-hidden="true" tabindex="-1"></a>The results are roughly the same as what we found with all the other models—they're slightly off because of random MCMC sampling.</span>
<span id="cb106-484"><a href="#cb106-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-485"><a href="#cb106-485" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-model-chocolate-brms, warning=FALSE, message=FALSE}</span></span>
<span id="cb106-486"><a href="#cb106-486" aria-hidden="true" tabindex="-1"></a><span class="in">model_parameters(model_chocolate_brms)</span></span>
<span id="cb106-487"><a href="#cb106-487" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-488"><a href="#cb106-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-489"><a href="#cb106-489" aria-hidden="true" tabindex="-1"></a><span class="fu">## Predictions</span></span>
<span id="cb106-490"><a href="#cb106-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-491"><a href="#cb106-491" aria-hidden="true" tabindex="-1"></a>In the SAS technical note example, they use the model to generated predicted probabilities of the choice of each of the options. In the world of marketing, this can also be seen as the predicted market share for each option. To do this, they plug each of the eight different different combinations of dark, soft, and nuts into the model and calculate the predicted output on the response (i.e. probability) scale. They get these results, where dark, chewy, and nuts is the most likely and popular option (commanding a 50% market share). </span>
<span id="cb106-492"><a href="#cb106-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-493"><a href="#cb106-493" aria-hidden="true" tabindex="-1"></a><span class="in">```default</span></span>
<span id="cb106-494"><a href="#cb106-494" aria-hidden="true" tabindex="-1"></a><span class="in">      Choice of Chocolate Candies</span></span>
<span id="cb106-495"><a href="#cb106-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-496"><a href="#cb106-496" aria-hidden="true" tabindex="-1"></a><span class="in">Obs    Dark    Soft     Nuts       p</span></span>
<span id="cb106-497"><a href="#cb106-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-498"><a href="#cb106-498" aria-hidden="true" tabindex="-1"></a><span class="in">  1    Dark    Chewy    Nuts       0.50400</span></span>
<span id="cb106-499"><a href="#cb106-499" aria-hidden="true" tabindex="-1"></a><span class="in">  2    Dark    Chewy    No Nuts    0.21600</span></span>
<span id="cb106-500"><a href="#cb106-500" aria-hidden="true" tabindex="-1"></a><span class="in">  3    Milk    Chewy    Nuts       0.12600</span></span>
<span id="cb106-501"><a href="#cb106-501" aria-hidden="true" tabindex="-1"></a><span class="in">  4    Dark    Soft     Nuts       0.05600</span></span>
<span id="cb106-502"><a href="#cb106-502" aria-hidden="true" tabindex="-1"></a><span class="in">  5    Milk    Chewy    No Nuts    0.05400</span></span>
<span id="cb106-503"><a href="#cb106-503" aria-hidden="true" tabindex="-1"></a><span class="in">  6    Dark    Soft     No Nuts    0.02400</span></span>
<span id="cb106-504"><a href="#cb106-504" aria-hidden="true" tabindex="-1"></a><span class="in">  7    Milk    Soft     Nuts       0.01400</span></span>
<span id="cb106-505"><a href="#cb106-505" aria-hidden="true" tabindex="-1"></a><span class="in">  8    Milk    Soft     No Nuts    0.00600</span></span>
<span id="cb106-506"><a href="#cb106-506" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-507"><a href="#cb106-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-508"><a href="#cb106-508" aria-hidden="true" tabindex="-1"></a>We can do the same thing with R. </span>
<span id="cb106-509"><a href="#cb106-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-510"><a href="#cb106-510" aria-hidden="true" tabindex="-1"></a><span class="fu">### Frequentist predictions</span></span>
<span id="cb106-511"><a href="#cb106-511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-512"><a href="#cb106-512" aria-hidden="true" tabindex="-1"></a>~~{mlogit} model objects have predicted values stored in one of their slots (`model_chocolate_mlogit$probabilities`), but they're in a weird non-tidy matrix form and I like working with tidy data. I'm also a huge fan of [the {marginaleffects} package](https://vincentarelbundock.github.io/marginaleffects/), which provides a consistent way to calculate predictions, comparisons, and slopes/marginal effects (with `predictions()`, `comparisons()`, and `slopes()`) for dozens of kinds of models, including `mlogit()` models. So instead of wrangling the built-in `mlogit()` probabilities, we'll generate predictions by feeding the model the unique combinations of `dark`, `soft`, and `nuts` to `marginaleffects::predictions()`, which will provide us with probability- or proportion-scale predictions:~~</span>
<span id="cb106-513"><a href="#cb106-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-514"><a href="#cb106-514" aria-hidden="true" tabindex="-1"></a>We can calculate probability-scale predictions by feeding the alternatives A–H (or the unique combinations of <span class="in">`dark`</span>, <span class="in">`soft`</span>, and <span class="in">`nuts`</span>) to the model using <span class="in">`predict()`</span>. We have to first create a little dataset of the alternatives (here I filter the data to include only Subject 1), and then feed that to <span class="in">`predict()`</span>, which returns a named vector. To get that into a more usable data frame, we can convert the named vector into a data frame with <span class="in">`tidyr::enframe()`</span> and then join it to the data frame of alternatives:</span>
<span id="cb106-515"><a href="#cb106-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-516"><a href="#cb106-516" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pred-model-chocolate-mlogit}</span></span>
<span id="cb106-517"><a href="#cb106-517" aria-hidden="true" tabindex="-1"></a><span class="in"># Unique combinations of dark, soft, and nuts across the 8 alternatives</span></span>
<span id="cb106-518"><a href="#cb106-518" aria-hidden="true" tabindex="-1"></a><span class="in">alts &lt;- chocolate %&gt;% </span></span>
<span id="cb106-519"><a href="#cb106-519" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(subj == 1) %&gt;% </span></span>
<span id="cb106-520"><a href="#cb106-520" aria-hidden="true" tabindex="-1"></a><span class="in">  select(-subj, -choice)</span></span>
<span id="cb106-521"><a href="#cb106-521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-522"><a href="#cb106-522" aria-hidden="true" tabindex="-1"></a><span class="in"># Named vector of predicted values</span></span>
<span id="cb106-523"><a href="#cb106-523" aria-hidden="true" tabindex="-1"></a><span class="in">preds &lt;- predict(model_chocolate_mlogit, newdata = alts)</span></span>
<span id="cb106-524"><a href="#cb106-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-525"><a href="#cb106-525" aria-hidden="true" tabindex="-1"></a><span class="in">preds_chocolate_mlogit &lt;- alts %&gt;% </span></span>
<span id="cb106-526"><a href="#cb106-526" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(enframe(preds, name = "alt", value = "estimate"), by = join_by(alt)) %&gt;% </span></span>
<span id="cb106-527"><a href="#cb106-527" aria-hidden="true" tabindex="-1"></a><span class="in">  arrange(desc(estimate))</span></span>
<span id="cb106-528"><a href="#cb106-528" aria-hidden="true" tabindex="-1"></a><span class="in">preds_chocolate_mlogit</span></span>
<span id="cb106-529"><a href="#cb106-529" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-530"><a href="#cb106-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-531"><a href="#cb106-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-532"><a href="#cb106-532" aria-hidden="true" tabindex="-1"></a>Perfect! They're identical to the SAS output. </span>
<span id="cb106-533"><a href="#cb106-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-534"><a href="#cb106-534" aria-hidden="true" tabindex="-1"></a>::: {.callout-warning}</span>
<span id="cb106-535"><a href="#cb106-535" aria-hidden="true" tabindex="-1"></a><span class="fu">### jklol they're not perfect</span></span>
<span id="cb106-536"><a href="#cb106-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-537"><a href="#cb106-537" aria-hidden="true" tabindex="-1"></a>As far as I can tell, <span class="in">`predict()`</span> doesn't provide standard errors for <span class="in">`mlogit()`</span>-based models, and none of the more standard helper packages like <span class="in">`marginaleffects::predictions()`</span> or <span class="in">`broom::agument()`</span> really do either. I guess that's good incentive to do this with Bayesian methods instead :)</span>
<span id="cb106-538"><a href="#cb106-538" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb106-539"><a href="#cb106-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-540"><a href="#cb106-540" aria-hidden="true" tabindex="-1"></a>We can play around with these predictions to describe the overall market for candy. Chewy candies dominate the market…</span>
<span id="cb106-541"><a href="#cb106-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-542"><a href="#cb106-542" aria-hidden="true" tabindex="-1"></a><span class="in">```{r preds-chocolate-dark-only}</span></span>
<span id="cb106-543"><a href="#cb106-543" aria-hidden="true" tabindex="-1"></a><span class="in">preds_chocolate_mlogit %&gt;% </span></span>
<span id="cb106-544"><a href="#cb106-544" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(dark) %&gt;% </span></span>
<span id="cb106-545"><a href="#cb106-545" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(share = sum(estimate))</span></span>
<span id="cb106-546"><a href="#cb106-546" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-547"><a href="#cb106-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-548"><a href="#cb106-548" aria-hidden="true" tabindex="-1"></a>…and dark chewy candies are by far the most popular:</span>
<span id="cb106-549"><a href="#cb106-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-550"><a href="#cb106-550" aria-hidden="true" tabindex="-1"></a><span class="in">```{r preds-chocolate-dark-soft}</span></span>
<span id="cb106-551"><a href="#cb106-551" aria-hidden="true" tabindex="-1"></a><span class="in">preds_chocolate_mlogit %&gt;% </span></span>
<span id="cb106-552"><a href="#cb106-552" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(dark, soft) %&gt;% </span></span>
<span id="cb106-553"><a href="#cb106-553" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(share = sum(estimate))</span></span>
<span id="cb106-554"><a href="#cb106-554" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-555"><a href="#cb106-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-556"><a href="#cb106-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-557"><a href="#cb106-557" aria-hidden="true" tabindex="-1"></a><span class="fu">### Bayesian predictions</span></span>
<span id="cb106-558"><a href="#cb106-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-559"><a href="#cb106-559" aria-hidden="true" tabindex="-1"></a>{marginaleffects} supports {brms} models too, so we can use its <span class="in">`predictions()`</span> function to generate predictions for our Bayesian model.</span>
<span id="cb106-560"><a href="#cb106-560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-561"><a href="#cb106-561" aria-hidden="true" tabindex="-1"></a>::: {.callout-important}</span>
<span id="cb106-562"><a href="#cb106-562" aria-hidden="true" tabindex="-1"></a><span class="fu">#### lol subject offsets</span></span>
<span id="cb106-563"><a href="#cb106-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-564"><a href="#cb106-564" aria-hidden="true" tabindex="-1"></a>When plugging values into <span class="in">`predictions()`</span> (or <span class="in">`avg_slopes()`</span> or any function that calculates predictions from a model), we have to decide how to handle the random subject offsets ($b_{0_j}$). <span class="co">[</span><span class="ot">I have a whole other blog post guide about this</span><span class="co">](https://www.andrewheiss.com/blog/2022/11/29/conditional-marginal-marginaleffects/#summary)</span> and how absolutely maddening the nomenclature for all this is.</span>
<span id="cb106-565"><a href="#cb106-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-566"><a href="#cb106-566" aria-hidden="true" tabindex="-1"></a>By default, <span class="in">`predictions()`</span> and friends will calculate predictions for subjects on average by using the <span class="in">`re_formula = NULL`</span> argument. This estimate includes details from the random offsets, either by integrating them out or by using the mean and standard deviation of the random offsets to generate a simulated average subject. When working with slopes, this is also called a *marginal effect*.</span>
<span id="cb106-567"><a href="#cb106-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-568"><a href="#cb106-568" aria-hidden="true" tabindex="-1"></a>We could also use <span class="in">`re_formula = NA`</span> to calculate predictions for a typical subject, or a subject where the random offset is set to 0. When working with slopes, this is also called a *conditional effect*.</span>
<span id="cb106-569"><a href="#cb106-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-570"><a href="#cb106-570" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Conditional predictions/effect = average subject = <span class="in">`re_formula = NA`</span></span>
<span id="cb106-571"><a href="#cb106-571" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Marginal predictions/effect = subjects on average = <span class="in">`re_formula = NULL`</span> (default), using existing subject levels or a new simulated subject</span>
<span id="cb106-572"><a href="#cb106-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-573"><a href="#cb106-573" aria-hidden="true" tabindex="-1"></a>Again, <span class="co">[</span><span class="ot">see this guide for way more about these distinctions</span><span class="co">](https://www.andrewheiss.com/blog/2022/11/29/conditional-marginal-marginaleffects)</span>. In this example here, we'll just use the default marginal predictions/effects (<span class="in">`re_formula = NULL`</span>), or the effect for subjects on average.</span>
<span id="cb106-574"><a href="#cb106-574" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb106-575"><a href="#cb106-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-576"><a href="#cb106-576" aria-hidden="true" tabindex="-1"></a>The predicted proportions aren't identical to the SAS output, but they're close enough, given that it's a completely different modeling approach.</span>
<span id="cb106-577"><a href="#cb106-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-578"><a href="#cb106-578" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pred-model-chocolate-brms}</span></span>
<span id="cb106-579"><a href="#cb106-579" aria-hidden="true" tabindex="-1"></a><span class="in">preds_chocolate_brms &lt;- predictions(</span></span>
<span id="cb106-580"><a href="#cb106-580" aria-hidden="true" tabindex="-1"></a><span class="in">  model_chocolate_brms, </span></span>
<span id="cb106-581"><a href="#cb106-581" aria-hidden="true" tabindex="-1"></a><span class="in">  newdata = datagrid(dark = unique, soft = unique, nuts = unique)</span></span>
<span id="cb106-582"><a href="#cb106-582" aria-hidden="true" tabindex="-1"></a><span class="in">) </span></span>
<span id="cb106-583"><a href="#cb106-583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-584"><a href="#cb106-584" aria-hidden="true" tabindex="-1"></a><span class="in">preds_chocolate_brms %&gt;% </span></span>
<span id="cb106-585"><a href="#cb106-585" aria-hidden="true" tabindex="-1"></a><span class="in">  as_tibble() %&gt;%</span></span>
<span id="cb106-586"><a href="#cb106-586" aria-hidden="true" tabindex="-1"></a><span class="in">  arrange(desc(estimate)) %&gt;% </span></span>
<span id="cb106-587"><a href="#cb106-587" aria-hidden="true" tabindex="-1"></a><span class="in">  select(dark, soft, nuts, estimate, conf.low, conf.high)</span></span>
<span id="cb106-588"><a href="#cb106-588" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-589"><a href="#cb106-589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-590"><a href="#cb106-590" aria-hidden="true" tabindex="-1"></a><span class="fu">### Plots</span></span>
<span id="cb106-591"><a href="#cb106-591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-592"><a href="#cb106-592" aria-hidden="true" tabindex="-1"></a>Since <span class="in">`predictions()`</span> returns a tidy data frame, we can plot these predicted probabilities (or market shares or however we want to think about them) with {ggplot2}:</span>
<span id="cb106-593"><a href="#cb106-593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-594"><a href="#cb106-594" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-preds-chocolate, fig.width=6, fig.height=5.5}</span></span>
<span id="cb106-595"><a href="#cb106-595" aria-hidden="true" tabindex="-1"></a><span class="in">p1 &lt;- preds_chocolate_mlogit %&gt;% </span></span>
<span id="cb106-596"><a href="#cb106-596" aria-hidden="true" tabindex="-1"></a><span class="in">  arrange(estimate) %&gt;% </span></span>
<span id="cb106-597"><a href="#cb106-597" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(label = str_to_sentence(glue::glue("{dark} chocolate, {soft} interior, {nuts}"))) %&gt;% </span></span>
<span id="cb106-598"><a href="#cb106-598" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(label = fct_inorder(label)) %&gt;% </span></span>
<span id="cb106-599"><a href="#cb106-599" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = estimate, y = label)) +</span></span>
<span id="cb106-600"><a href="#cb106-600" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(color = clrs[7]) +</span></span>
<span id="cb106-601"><a href="#cb106-601" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_percent()) +</span></span>
<span id="cb106-602"><a href="#cb106-602" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(</span></span>
<span id="cb106-603"><a href="#cb106-603" aria-hidden="true" tabindex="-1"></a><span class="in">    x = "Predicted probability of selection", y = NULL,</span></span>
<span id="cb106-604"><a href="#cb106-604" aria-hidden="true" tabindex="-1"></a><span class="in">    title = "Frequentist {mlogit} predictions") +</span></span>
<span id="cb106-605"><a href="#cb106-605" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(panel.grid.minor = element_blank(), panel.grid.major.y = element_blank())</span></span>
<span id="cb106-606"><a href="#cb106-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-607"><a href="#cb106-607" aria-hidden="true" tabindex="-1"></a><span class="in">p2 &lt;- preds_chocolate_brms %&gt;% </span></span>
<span id="cb106-608"><a href="#cb106-608" aria-hidden="true" tabindex="-1"></a><span class="in">  posterior_draws() %&gt;%  # Extract the posterior draws of the predictions</span></span>
<span id="cb106-609"><a href="#cb106-609" aria-hidden="true" tabindex="-1"></a><span class="in">  arrange(estimate) %&gt;% </span></span>
<span id="cb106-610"><a href="#cb106-610" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(label = str_to_sentence(glue::glue("{dark} chocolate, {soft} interior, {nuts}"))) %&gt;% </span></span>
<span id="cb106-611"><a href="#cb106-611" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(label = fct_inorder(label)) %&gt;% </span></span>
<span id="cb106-612"><a href="#cb106-612" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = draw, y = label)) +</span></span>
<span id="cb106-613"><a href="#cb106-613" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye(normalize = "xy", fill = clrs[7])  +</span></span>
<span id="cb106-614"><a href="#cb106-614" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_percent()) +</span></span>
<span id="cb106-615"><a href="#cb106-615" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(</span></span>
<span id="cb106-616"><a href="#cb106-616" aria-hidden="true" tabindex="-1"></a><span class="in">    x = "Predicted probability of selection", y = NULL,</span></span>
<span id="cb106-617"><a href="#cb106-617" aria-hidden="true" tabindex="-1"></a><span class="in">    title = "Bayesian {brms} predictions") +</span></span>
<span id="cb106-618"><a href="#cb106-618" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(panel.grid.minor = element_blank(), panel.grid.major.y = element_blank()) +</span></span>
<span id="cb106-619"><a href="#cb106-619" aria-hidden="true" tabindex="-1"></a><span class="in">  # Make the x-axis match the mlogit plot</span></span>
<span id="cb106-620"><a href="#cb106-620" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(xlim = c(-0.05, 0.78))</span></span>
<span id="cb106-621"><a href="#cb106-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-622"><a href="#cb106-622" aria-hidden="true" tabindex="-1"></a><span class="in">p1 / p2</span></span>
<span id="cb106-623"><a href="#cb106-623" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-624"><a href="#cb106-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-625"><a href="#cb106-625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-626"><a href="#cb106-626" aria-hidden="true" tabindex="-1"></a><span class="fu">## AMCEs</span></span>
<span id="cb106-627"><a href="#cb106-627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-628"><a href="#cb106-628" aria-hidden="true" tabindex="-1"></a>The marketing world doesn't typically look at coefficients or marginal effects, but the political science world definitely does. In political science, the estimand we often care about the most is the average marginal component effect (AMCE), or the causal effect of moving one feature level to a different value, holding all other features constant. <span class="co">[</span><span class="ot">I have a whole in-depth blog post about AMCEs and how to calculate them</span><span class="co">](https://www.andrewheiss.com/blog/2023/07/25/conjoint-bayesian-frequentist-guide/)</span>—go look at that for more details. Long story short—AMCEs are basically the coefficients in a regression model.</span>
<span id="cb106-629"><a href="#cb106-629" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-630"><a href="#cb106-630" aria-hidden="true" tabindex="-1"></a>Interpreting the coefficients is difficult with models that aren't basic linear regression. Here, all these coefficients are on the log scale, so they're not directly interpretable. The original SAS technical note also doesn't really interpret any of these , they don't really interpret these things anyway, since they're more focused on predictions. All they say is this:</span>
<span id="cb106-631"><a href="#cb106-631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-632"><a href="#cb106-632" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; The parameter estimate with the smallest *p*-value is for soft center. Since the parameter estimate is negative, chewy is the more preferred level. Dark is preferred over milk, and nuts over no nuts, however only the *p*-value for Soft is less than 0.05.</span></span>
<span id="cb106-633"><a href="#cb106-633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-634"><a href="#cb106-634" aria-hidden="true" tabindex="-1"></a>We could exponentiate the coefficients to make them multiplicative (akin to odds ratios in logistic regression). For center = soft, $e^{-2.19722}$ = <span class="in">`r exp(-2.19722)`</span>, which means that candies with a soft center are <span class="in">`r label_percent()(1 - exp(-2.19722))`</span> less likely to be chosen than candies with a chewy center, relative to the average candy. But that's weird to think about.</span>
<span id="cb106-635"><a href="#cb106-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-636"><a href="#cb106-636" aria-hidden="true" tabindex="-1"></a>So instead we can turn to {marginaleffects} once again to calculate percentage-point scale estimands that we can interpret far more easily.</span>
<span id="cb106-637"><a href="#cb106-637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-638"><a href="#cb106-638" aria-hidden="true" tabindex="-1"></a>::: {.callout-important}</span>
<span id="cb106-639"><a href="#cb106-639" aria-hidden="true" tabindex="-1"></a><span class="fu">#### lol marginal effects</span></span>
<span id="cb106-640"><a href="#cb106-640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-641"><a href="#cb106-641" aria-hidden="true" tabindex="-1"></a>Nobody is ever consistent about the word "marginal effect." Some people use it to refer to averages; some people use it to refer to slopes. These are complete opposites. In calculus, averages = integrals and slopes = derivatives and they're the inverse of each other.</span>
<span id="cb106-642"><a href="#cb106-642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-643"><a href="#cb106-643" aria-hidden="true" tabindex="-1"></a>I like to think of marginal effects as what happens to the outcome when you move an explanatory variable a tiny bit. With continuous variables, that's a slope; with categorical variables, that's an offset in average outcomes. These correspond directly to how you normally interpret regression coefficients. Or returning to <span class="co">[</span><span class="ot">my favorite analogy about regression</span><span class="co">](https://www.andrewheiss.com/blog/2022/05/20/marginalia/#regression-sliders-switches-and-mixing-boards)</span>, with numeric variables we care what happens to the outcome when we slide the value up a tiny bit; with categorical variables we care about what happens to the outcome when we switch on a category.</span>
<span id="cb106-644"><a href="#cb106-644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-645"><a href="#cb106-645" aria-hidden="true" tabindex="-1"></a>Additionally, there are like a billion different ways to calculate marginal effects: average marginal effects (AMEs), group-average marginal effects (G-AMEs), marginal effects at user-specified values, marginal effects at the mean (MEM), and counterfactual marginal effects. See <span class="co">[</span><span class="ot">the documentation for {marginaleffects}</span><span class="co">](https://vincentarelbundock.github.io/marginaleffects/articles/slopes.html)</span> + <span class="co">[</span><span class="ot">this mega blog post</span><span class="co">](https://www.andrewheiss.com/blog/2022/05/20/marginalia/)</span> for more about these subtle differences.</span>
<span id="cb106-646"><a href="#cb106-646" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb106-647"><a href="#cb106-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-648"><a href="#cb106-648" aria-hidden="true" tabindex="-1"></a><span class="fu">### Bayesian comparisons/contrasts</span></span>
<span id="cb106-649"><a href="#cb106-649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-650"><a href="#cb106-650" aria-hidden="true" tabindex="-1"></a>We can use <span class="in">`avg_comparisons()`</span> to calculate the difference (or average marginal effect) for each of the categorical coefficients on the percentage-point scale, showing the effect of moving from milk → dark, chewy → soft, and nuts → no nuts.</span>
<span id="cb106-651"><a href="#cb106-651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-652"><a href="#cb106-652" aria-hidden="true" tabindex="-1"></a>(Technically we can also use <span class="in">`avg_slopes()`</span>, even though none of these coefficients are actually slopes. {marginaleffects} is smart enough to show contrasts for categorical variables and partial derivatives/slopes for continuous variables.)</span>
<span id="cb106-653"><a href="#cb106-653" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-654"><a href="#cb106-654" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-comparisons-chocolate-brms}</span></span>
<span id="cb106-655"><a href="#cb106-655" aria-hidden="true" tabindex="-1"></a><span class="in">avg_comparisons(model_chocolate_brms)</span></span>
<span id="cb106-656"><a href="#cb106-656" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-657"><a href="#cb106-657" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-658"><a href="#cb106-658" aria-hidden="true" tabindex="-1"></a>When holding all other features constant, moving from chewy → soft is associated with a posterior median 18 percentage point decrease in the probability of selection (or drop in market share if you want to think of it that way), on average.</span>
<span id="cb106-659"><a href="#cb106-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-660"><a href="#cb106-660" aria-hidden="true" tabindex="-1"></a><span class="fu">### Frequentist comparisons/contrasts</span></span>
<span id="cb106-661"><a href="#cb106-661" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-662"><a href="#cb106-662" aria-hidden="true" tabindex="-1"></a>We went out of order in this section and showed how to use <span class="in">`avg_comparisons()`</span> with the Bayesian model first instead of the frequentist model. That's because it was easy. </span>
<span id="cb106-663"><a href="#cb106-663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-664"><a href="#cb106-664" aria-hidden="true" tabindex="-1"></a><span class="in">`mlogit()`</span> models don't work with {marignaleffects} (or other model wrangling packages like {broom}), so there's no good way to do it. We're limited to calculating the contrasts of predictions by hand and manipulating and collapsing the data frame of predictions that we made previously.</span>
<span id="cb106-665"><a href="#cb106-665" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-666"><a href="#cb106-666" aria-hidden="true" tabindex="-1"></a>It's helpful to illustrate what exactly we're looking at when collapsing these results. Remember that earlier we calculated predictions for all the unique combinations of <span class="in">`dark`</span>, <span class="in">`soft`</span>, and <span class="in">`nuts`</span>:</span>
<span id="cb106-667"><a href="#cb106-667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-668"><a href="#cb106-668" aria-hidden="true" tabindex="-1"></a><span class="in">```{r preds-chocolate-mlogit-again}</span></span>
<span id="cb106-669"><a href="#cb106-669" aria-hidden="true" tabindex="-1"></a><span class="in"># Unique combinations of dark, soft, and nuts across the 8 alternatives</span></span>
<span id="cb106-670"><a href="#cb106-670" aria-hidden="true" tabindex="-1"></a><span class="in">alts &lt;- chocolate %&gt;% </span></span>
<span id="cb106-671"><a href="#cb106-671" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(subj == 1) %&gt;% </span></span>
<span id="cb106-672"><a href="#cb106-672" aria-hidden="true" tabindex="-1"></a><span class="in">  select(-subj, -choice)</span></span>
<span id="cb106-673"><a href="#cb106-673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-674"><a href="#cb106-674" aria-hidden="true" tabindex="-1"></a><span class="in"># Named vector of predicted values</span></span>
<span id="cb106-675"><a href="#cb106-675" aria-hidden="true" tabindex="-1"></a><span class="in">preds &lt;- predict(model_chocolate_mlogit, newdata = alts, se.fit = TRUE)</span></span>
<span id="cb106-676"><a href="#cb106-676" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-677"><a href="#cb106-677" aria-hidden="true" tabindex="-1"></a><span class="in">preds_chocolate_mlogit &lt;- alts %&gt;% </span></span>
<span id="cb106-678"><a href="#cb106-678" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(enframe(preds, name = "alt", value = "estimate"), by = join_by(alt)) %&gt;% </span></span>
<span id="cb106-679"><a href="#cb106-679" aria-hidden="true" tabindex="-1"></a><span class="in">  arrange(desc(estimate))</span></span>
<span id="cb106-680"><a href="#cb106-680" aria-hidden="true" tabindex="-1"></a><span class="in">preds_chocolate_mlogit</span></span>
<span id="cb106-681"><a href="#cb106-681" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-682"><a href="#cb106-682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-683"><a href="#cb106-683" aria-hidden="true" tabindex="-1"></a>Four of the groups have <span class="in">`dark`</span> = Milk and four have <span class="in">`dark`</span> = Dark, with other varying characteristics across those groups (chewy/soft, nuts/no nuts). If we want the average proportion of all milk and dark chocolate options, we can group and summarize:</span>
<span id="cb106-684"><a href="#cb106-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-685"><a href="#cb106-685" aria-hidden="true" tabindex="-1"></a><span class="in">```{r preds-chocolate-avg-dark-manual}</span></span>
<span id="cb106-686"><a href="#cb106-686" aria-hidden="true" tabindex="-1"></a><span class="in">preds_dark &lt;- preds_chocolate_mlogit %&gt;% </span></span>
<span id="cb106-687"><a href="#cb106-687" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(dark) %&gt;% </span></span>
<span id="cb106-688"><a href="#cb106-688" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(avg_pred = mean(estimate))</span></span>
<span id="cb106-689"><a href="#cb106-689" aria-hidden="true" tabindex="-1"></a><span class="in">preds_dark</span></span>
<span id="cb106-690"><a href="#cb106-690" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-691"><a href="#cb106-691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-692"><a href="#cb106-692" aria-hidden="true" tabindex="-1"></a>The average market share for milk chocolate candies, holding all other features constant, is 5% ($\frac{0.0540 + 0.126 + 0.006 + 0.014}{2} = 0.05$); the average market share for dark chocolate candies is 20% ($\frac{0.216 + 0.504 + 0.024 + 0.056}{2} = 0.2$). These values are the averages of the predictions from the four groups where <span class="in">`dark`</span> is either Milk or Dark. </span>
<span id="cb106-693"><a href="#cb106-693" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-694"><a href="#cb106-694" aria-hidden="true" tabindex="-1"></a>If we find the difference between the two predictions, we'll see the average causal effect of moving from dark → milk—holding all other features constant, switching the chocolate type from dark to milk causes a 15 percentage point decrease in the probability of selecting the candy, on average.</span>
<span id="cb106-695"><a href="#cb106-695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-696"><a href="#cb106-696" aria-hidden="true" tabindex="-1"></a><span class="in">```{r preds-chocolate-avg-by-dark}</span></span>
<span id="cb106-697"><a href="#cb106-697" aria-hidden="true" tabindex="-1"></a><span class="in"># Using diff() (reversing it so that it does Milk - Dark)</span></span>
<span id="cb106-698"><a href="#cb106-698" aria-hidden="true" tabindex="-1"></a><span class="in">diff(rev(preds_dark$avg_pred))</span></span>
<span id="cb106-699"><a href="#cb106-699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-700"><a href="#cb106-700" aria-hidden="true" tabindex="-1"></a><span class="in"># Tidyverse way</span></span>
<span id="cb106-701"><a href="#cb106-701" aria-hidden="true" tabindex="-1"></a><span class="in">preds_dark %&gt;% </span></span>
<span id="cb106-702"><a href="#cb106-702" aria-hidden="true" tabindex="-1"></a><span class="in">  pivot_wider(names_from = dark, values_from = avg_pred) %&gt;% </span></span>
<span id="cb106-703"><a href="#cb106-703" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb106-704"><a href="#cb106-704" aria-hidden="true" tabindex="-1"></a><span class="in">    term = "Milk - Dark",</span></span>
<span id="cb106-705"><a href="#cb106-705" aria-hidden="true" tabindex="-1"></a><span class="in">    estimate = Milk - Dark</span></span>
<span id="cb106-706"><a href="#cb106-706" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;% </span></span>
<span id="cb106-707"><a href="#cb106-707" aria-hidden="true" tabindex="-1"></a><span class="in">  select(term, estimate)</span></span>
<span id="cb106-708"><a href="#cb106-708" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-709"><a href="#cb106-709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-710"><a href="#cb106-710" aria-hidden="true" tabindex="-1"></a>We can use this same approach to make a big data frame of all the contrasts:</span>
<span id="cb106-711"><a href="#cb106-711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-712"><a href="#cb106-712" aria-hidden="true" tabindex="-1"></a><span class="in">```{r preds-chocolate-avg-all}</span></span>
<span id="cb106-713"><a href="#cb106-713" aria-hidden="true" tabindex="-1"></a><span class="in">amces_chocolate_mlogit &lt;- bind_rows(</span></span>
<span id="cb106-714"><a href="#cb106-714" aria-hidden="true" tabindex="-1"></a><span class="in">  dark = preds_chocolate_mlogit %&gt;% </span></span>
<span id="cb106-715"><a href="#cb106-715" aria-hidden="true" tabindex="-1"></a><span class="in">    group_by(dark) %&gt;% </span></span>
<span id="cb106-716"><a href="#cb106-716" aria-hidden="true" tabindex="-1"></a><span class="in">    summarize(avg_pred = mean(estimate)) %&gt;% </span></span>
<span id="cb106-717"><a href="#cb106-717" aria-hidden="true" tabindex="-1"></a><span class="in">    pivot_wider(names_from = dark, values_from = avg_pred) %&gt;% </span></span>
<span id="cb106-718"><a href="#cb106-718" aria-hidden="true" tabindex="-1"></a><span class="in">    mutate(</span></span>
<span id="cb106-719"><a href="#cb106-719" aria-hidden="true" tabindex="-1"></a><span class="in">      term = "Dark - Milk",</span></span>
<span id="cb106-720"><a href="#cb106-720" aria-hidden="true" tabindex="-1"></a><span class="in">      estimate = Dark - Milk</span></span>
<span id="cb106-721"><a href="#cb106-721" aria-hidden="true" tabindex="-1"></a><span class="in">    ) %&gt;% </span></span>
<span id="cb106-722"><a href="#cb106-722" aria-hidden="true" tabindex="-1"></a><span class="in">    select(term, estimate),</span></span>
<span id="cb106-723"><a href="#cb106-723" aria-hidden="true" tabindex="-1"></a><span class="in">  soft = preds_chocolate_mlogit %&gt;% </span></span>
<span id="cb106-724"><a href="#cb106-724" aria-hidden="true" tabindex="-1"></a><span class="in">    group_by(soft) %&gt;% </span></span>
<span id="cb106-725"><a href="#cb106-725" aria-hidden="true" tabindex="-1"></a><span class="in">    summarize(avg_pred = mean(estimate)) %&gt;% </span></span>
<span id="cb106-726"><a href="#cb106-726" aria-hidden="true" tabindex="-1"></a><span class="in">    pivot_wider(names_from = soft, values_from = avg_pred) %&gt;% </span></span>
<span id="cb106-727"><a href="#cb106-727" aria-hidden="true" tabindex="-1"></a><span class="in">    mutate(</span></span>
<span id="cb106-728"><a href="#cb106-728" aria-hidden="true" tabindex="-1"></a><span class="in">      term = "Soft - Chewy",</span></span>
<span id="cb106-729"><a href="#cb106-729" aria-hidden="true" tabindex="-1"></a><span class="in">      estimate = Soft - Chewy</span></span>
<span id="cb106-730"><a href="#cb106-730" aria-hidden="true" tabindex="-1"></a><span class="in">    ) %&gt;% </span></span>
<span id="cb106-731"><a href="#cb106-731" aria-hidden="true" tabindex="-1"></a><span class="in">    select(term, estimate),</span></span>
<span id="cb106-732"><a href="#cb106-732" aria-hidden="true" tabindex="-1"></a><span class="in">  nuts = preds_chocolate_mlogit %&gt;% </span></span>
<span id="cb106-733"><a href="#cb106-733" aria-hidden="true" tabindex="-1"></a><span class="in">    group_by(nuts) %&gt;% </span></span>
<span id="cb106-734"><a href="#cb106-734" aria-hidden="true" tabindex="-1"></a><span class="in">    summarize(avg_pred = mean(estimate)) %&gt;% </span></span>
<span id="cb106-735"><a href="#cb106-735" aria-hidden="true" tabindex="-1"></a><span class="in">    pivot_wider(names_from = nuts, values_from = avg_pred) %&gt;% </span></span>
<span id="cb106-736"><a href="#cb106-736" aria-hidden="true" tabindex="-1"></a><span class="in">    mutate(</span></span>
<span id="cb106-737"><a href="#cb106-737" aria-hidden="true" tabindex="-1"></a><span class="in">      term = "Nuts - No nuts",</span></span>
<span id="cb106-738"><a href="#cb106-738" aria-hidden="true" tabindex="-1"></a><span class="in">      estimate = Nuts - `No nuts`</span></span>
<span id="cb106-739"><a href="#cb106-739" aria-hidden="true" tabindex="-1"></a><span class="in">    ) %&gt;% </span></span>
<span id="cb106-740"><a href="#cb106-740" aria-hidden="true" tabindex="-1"></a><span class="in">    select(term, estimate),</span></span>
<span id="cb106-741"><a href="#cb106-741" aria-hidden="true" tabindex="-1"></a><span class="in">  .id = "variable"</span></span>
<span id="cb106-742"><a href="#cb106-742" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb106-743"><a href="#cb106-743" aria-hidden="true" tabindex="-1"></a><span class="in">amces_chocolate_mlogit</span></span>
<span id="cb106-744"><a href="#cb106-744" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-745"><a href="#cb106-745" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-746"><a href="#cb106-746" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-747"><a href="#cb106-747" aria-hidden="true" tabindex="-1"></a>For instance, what's the causal effect of moving from milk → dark chocolate?</span>
<span id="cb106-748"><a href="#cb106-748" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-749"><a href="#cb106-749" aria-hidden="true" tabindex="-1"></a><span class="in">```{r calc-amce-dark-mlogit}</span></span>
<span id="cb106-750"><a href="#cb106-750" aria-hidden="true" tabindex="-1"></a><span class="in"># Unique combinations of dark, soft, and nuts across the 8 alternatives</span></span>
<span id="cb106-751"><a href="#cb106-751" aria-hidden="true" tabindex="-1"></a><span class="in">alts &lt;- chocolate %&gt;% </span></span>
<span id="cb106-752"><a href="#cb106-752" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(subj == 1) %&gt;% </span></span>
<span id="cb106-753"><a href="#cb106-753" aria-hidden="true" tabindex="-1"></a><span class="in">  select(-subj, -choice)</span></span>
<span id="cb106-754"><a href="#cb106-754" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-755"><a href="#cb106-755" aria-hidden="true" tabindex="-1"></a><span class="in"># Named vector of predicted values</span></span>
<span id="cb106-756"><a href="#cb106-756" aria-hidden="true" tabindex="-1"></a><span class="in">preds &lt;- predict(model_chocolate_mlogit, newdata = alts, se.fit = TRUE)</span></span>
<span id="cb106-757"><a href="#cb106-757" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-758"><a href="#cb106-758" aria-hidden="true" tabindex="-1"></a><span class="in">preds_chocolate_mlogit &lt;- alts %&gt;% </span></span>
<span id="cb106-759"><a href="#cb106-759" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(enframe(preds, name = "alt", value = "estimate"), by = join_by(alt)) %&gt;% </span></span>
<span id="cb106-760"><a href="#cb106-760" aria-hidden="true" tabindex="-1"></a><span class="in">  arrange(desc(estimate))</span></span>
<span id="cb106-761"><a href="#cb106-761" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-762"><a href="#cb106-762" aria-hidden="true" tabindex="-1"></a><span class="in">preds_chocolate_mlogit %&gt;% </span></span>
<span id="cb106-763"><a href="#cb106-763" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(dark) %&gt;% </span></span>
<span id="cb106-764"><a href="#cb106-764" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(estimate = mean(estimate))</span></span>
<span id="cb106-765"><a href="#cb106-765" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-766"><a href="#cb106-766" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-767"><a href="#cb106-767" aria-hidden="true" tabindex="-1"></a><span class="fu">### Plots</span></span>
<span id="cb106-768"><a href="#cb106-768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-769"><a href="#cb106-769" aria-hidden="true" tabindex="-1"></a>Plotting these AMCEs requires a bit of data wrangling, but we get really neat plots, so it's worth it. I've hidden all the code here for the sake of space.</span>
<span id="cb106-770"><a href="#cb106-770" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-771"><a href="#cb106-771" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-chocolate-variable-levels}</span></span>
<span id="cb106-772"><a href="#cb106-772" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb106-773"><a href="#cb106-773" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-summary: "Extract variable labels"</span></span>
<span id="cb106-774"><a href="#cb106-774" aria-hidden="true" tabindex="-1"></a><span class="in">chocolate_var_levels &lt;- tibble(</span></span>
<span id="cb106-775"><a href="#cb106-775" aria-hidden="true" tabindex="-1"></a><span class="in">  variable = c("dark", "soft", "nuts")</span></span>
<span id="cb106-776"><a href="#cb106-776" aria-hidden="true" tabindex="-1"></a><span class="in">) %&gt;% </span></span>
<span id="cb106-777"><a href="#cb106-777" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(levels = map(variable, ~{</span></span>
<span id="cb106-778"><a href="#cb106-778" aria-hidden="true" tabindex="-1"></a><span class="in">    x &lt;- chocolate[[.x]]</span></span>
<span id="cb106-779"><a href="#cb106-779" aria-hidden="true" tabindex="-1"></a><span class="in">    if (is.numeric(x)) {</span></span>
<span id="cb106-780"><a href="#cb106-780" aria-hidden="true" tabindex="-1"></a><span class="in">      ""</span></span>
<span id="cb106-781"><a href="#cb106-781" aria-hidden="true" tabindex="-1"></a><span class="in">    } else if (is.factor(x)) {</span></span>
<span id="cb106-782"><a href="#cb106-782" aria-hidden="true" tabindex="-1"></a><span class="in">      levels(x)</span></span>
<span id="cb106-783"><a href="#cb106-783" aria-hidden="true" tabindex="-1"></a><span class="in">    } else {</span></span>
<span id="cb106-784"><a href="#cb106-784" aria-hidden="true" tabindex="-1"></a><span class="in">      sort(unique(x))</span></span>
<span id="cb106-785"><a href="#cb106-785" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb106-786"><a href="#cb106-786" aria-hidden="true" tabindex="-1"></a><span class="in">  })) %&gt;% </span></span>
<span id="cb106-787"><a href="#cb106-787" aria-hidden="true" tabindex="-1"></a><span class="in">  unnest(levels) %&gt;% </span></span>
<span id="cb106-788"><a href="#cb106-788" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(term = paste0(variable, levels))</span></span>
<span id="cb106-789"><a href="#cb106-789" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-790"><a href="#cb106-790" aria-hidden="true" tabindex="-1"></a><span class="in"># Make a little lookup table for nicer feature labels</span></span>
<span id="cb106-791"><a href="#cb106-791" aria-hidden="true" tabindex="-1"></a><span class="in">chocolate_var_lookup &lt;- tribble(</span></span>
<span id="cb106-792"><a href="#cb106-792" aria-hidden="true" tabindex="-1"></a><span class="in">  ~variable, ~variable_nice,</span></span>
<span id="cb106-793"><a href="#cb106-793" aria-hidden="true" tabindex="-1"></a><span class="in">  "dark",    "Type of chocolate",</span></span>
<span id="cb106-794"><a href="#cb106-794" aria-hidden="true" tabindex="-1"></a><span class="in">  "soft",    "Type of center",</span></span>
<span id="cb106-795"><a href="#cb106-795" aria-hidden="true" tabindex="-1"></a><span class="in">  "nuts",    "Nuts"</span></span>
<span id="cb106-796"><a href="#cb106-796" aria-hidden="true" tabindex="-1"></a><span class="in">) %&gt;% </span></span>
<span id="cb106-797"><a href="#cb106-797" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(variable_nice = fct_inorder(variable_nice))</span></span>
<span id="cb106-798"><a href="#cb106-798" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-799"><a href="#cb106-799" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-800"><a href="#cb106-800" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-amces-chocolate-mlogit}</span></span>
<span id="cb106-801"><a href="#cb106-801" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb106-802"><a href="#cb106-802" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-summary: "Combine full dataset of factor levels with model comparisons and make {mlogit} plot"</span></span>
<span id="cb106-803"><a href="#cb106-803" aria-hidden="true" tabindex="-1"></a><span class="in">amces_chocolate_mlogit_split &lt;- amces_chocolate_mlogit %&gt;% </span></span>
<span id="cb106-804"><a href="#cb106-804" aria-hidden="true" tabindex="-1"></a><span class="in">  separate_wider_delim(</span></span>
<span id="cb106-805"><a href="#cb106-805" aria-hidden="true" tabindex="-1"></a><span class="in">    term,</span></span>
<span id="cb106-806"><a href="#cb106-806" aria-hidden="true" tabindex="-1"></a><span class="in">    delim = " - ", </span></span>
<span id="cb106-807"><a href="#cb106-807" aria-hidden="true" tabindex="-1"></a><span class="in">    names = c("variable_level", "reference_level")</span></span>
<span id="cb106-808"><a href="#cb106-808" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;% </span></span>
<span id="cb106-809"><a href="#cb106-809" aria-hidden="true" tabindex="-1"></a><span class="in">  rename(term = variable)</span></span>
<span id="cb106-810"><a href="#cb106-810" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-811"><a href="#cb106-811" aria-hidden="true" tabindex="-1"></a><span class="in">plot_data &lt;- chocolate_var_levels %&gt;%</span></span>
<span id="cb106-812"><a href="#cb106-812" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(</span></span>
<span id="cb106-813"><a href="#cb106-813" aria-hidden="true" tabindex="-1"></a><span class="in">    amces_chocolate_mlogit_split,</span></span>
<span id="cb106-814"><a href="#cb106-814" aria-hidden="true" tabindex="-1"></a><span class="in">    by = join_by(variable == term, levels == variable_level)</span></span>
<span id="cb106-815"><a href="#cb106-815" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;% </span></span>
<span id="cb106-816"><a href="#cb106-816" aria-hidden="true" tabindex="-1"></a><span class="in">  # Make these zero</span></span>
<span id="cb106-817"><a href="#cb106-817" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb106-818"><a href="#cb106-818" aria-hidden="true" tabindex="-1"></a><span class="in">    across(</span></span>
<span id="cb106-819"><a href="#cb106-819" aria-hidden="true" tabindex="-1"></a><span class="in">      c(estimate),</span></span>
<span id="cb106-820"><a href="#cb106-820" aria-hidden="true" tabindex="-1"></a><span class="in">      ~ ifelse(is.na(.x), 0, .x)</span></span>
<span id="cb106-821"><a href="#cb106-821" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb106-822"><a href="#cb106-822" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;% </span></span>
<span id="cb106-823"><a href="#cb106-823" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(chocolate_var_lookup, by = join_by(variable)) %&gt;% </span></span>
<span id="cb106-824"><a href="#cb106-824" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(across(c(levels, variable_nice), ~fct_inorder(.)))</span></span>
<span id="cb106-825"><a href="#cb106-825" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-826"><a href="#cb106-826" aria-hidden="true" tabindex="-1"></a><span class="in">p1 &lt;- ggplot(</span></span>
<span id="cb106-827"><a href="#cb106-827" aria-hidden="true" tabindex="-1"></a><span class="in">  plot_data,</span></span>
<span id="cb106-828"><a href="#cb106-828" aria-hidden="true" tabindex="-1"></a><span class="in">  aes(x = estimate, y = levels, color = variable_nice)</span></span>
<span id="cb106-829"><a href="#cb106-829" aria-hidden="true" tabindex="-1"></a><span class="in">) +</span></span>
<span id="cb106-830"><a href="#cb106-830" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0) +</span></span>
<span id="cb106-831"><a href="#cb106-831" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point() +</span></span>
<span id="cb106-832"><a href="#cb106-832" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_pp) +</span></span>
<span id="cb106-833"><a href="#cb106-833" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_color_manual(values = clrs[c(1, 3, 8)]) +</span></span>
<span id="cb106-834"><a href="#cb106-834" aria-hidden="true" tabindex="-1"></a><span class="in">  guides(color = "none") +</span></span>
<span id="cb106-835"><a href="#cb106-835" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(</span></span>
<span id="cb106-836"><a href="#cb106-836" aria-hidden="true" tabindex="-1"></a><span class="in">    x = "Percentage point change in\nprobability of candy selection",</span></span>
<span id="cb106-837"><a href="#cb106-837" aria-hidden="true" tabindex="-1"></a><span class="in">    y = NULL,</span></span>
<span id="cb106-838"><a href="#cb106-838" aria-hidden="true" tabindex="-1"></a><span class="in">    title = "Frequentist AMCEs from {mlogit}"</span></span>
<span id="cb106-839"><a href="#cb106-839" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb106-840"><a href="#cb106-840" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_col(facets = "variable_nice", scales = "free_y", space = "free")</span></span>
<span id="cb106-841"><a href="#cb106-841" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-842"><a href="#cb106-842" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-843"><a href="#cb106-843" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-amces-chocolate-brms}</span></span>
<span id="cb106-844"><a href="#cb106-844" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb106-845"><a href="#cb106-845" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-summary: "Combine full dataset of factor levels with posterior draws and make {brms} plot"</span></span>
<span id="cb106-846"><a href="#cb106-846" aria-hidden="true" tabindex="-1"></a><span class="in"># This is much easier than the mlogit mess because we can use avg_comparisons() directly</span></span>
<span id="cb106-847"><a href="#cb106-847" aria-hidden="true" tabindex="-1"></a><span class="in">posterior_mfx &lt;- model_chocolate_brms %&gt;% </span></span>
<span id="cb106-848"><a href="#cb106-848" aria-hidden="true" tabindex="-1"></a><span class="in">  avg_comparisons() %&gt;% </span></span>
<span id="cb106-849"><a href="#cb106-849" aria-hidden="true" tabindex="-1"></a><span class="in">  posteriordraws() </span></span>
<span id="cb106-850"><a href="#cb106-850" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-851"><a href="#cb106-851" aria-hidden="true" tabindex="-1"></a><span class="in">posterior_mfx_nested &lt;- posterior_mfx %&gt;% </span></span>
<span id="cb106-852"><a href="#cb106-852" aria-hidden="true" tabindex="-1"></a><span class="in">  separate_wider_delim(</span></span>
<span id="cb106-853"><a href="#cb106-853" aria-hidden="true" tabindex="-1"></a><span class="in">    contrast,</span></span>
<span id="cb106-854"><a href="#cb106-854" aria-hidden="true" tabindex="-1"></a><span class="in">    delim = " - ", </span></span>
<span id="cb106-855"><a href="#cb106-855" aria-hidden="true" tabindex="-1"></a><span class="in">    names = c("variable_level", "reference_level")</span></span>
<span id="cb106-856"><a href="#cb106-856" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;% </span></span>
<span id="cb106-857"><a href="#cb106-857" aria-hidden="true" tabindex="-1"></a><span class="in">  # At some point marginaleffects() started adding "mean(Blah)" instead of</span></span>
<span id="cb106-858"><a href="#cb106-858" aria-hidden="true" tabindex="-1"></a><span class="in">  # "Blah" in the contrast column for avg_comparisons(), so this removes the</span></span>
<span id="cb106-859"><a href="#cb106-859" aria-hidden="true" tabindex="-1"></a><span class="in">  # function name and parentheses</span></span>
<span id="cb106-860"><a href="#cb106-860" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(variable_level = str_replace_all(variable_level, ".*\\(([^)]+)\\).*", "\\1")) %&gt;% </span></span>
<span id="cb106-861"><a href="#cb106-861" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(term, variable_level) %&gt;% </span></span>
<span id="cb106-862"><a href="#cb106-862" aria-hidden="true" tabindex="-1"></a><span class="in">  nest()</span></span>
<span id="cb106-863"><a href="#cb106-863" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-864"><a href="#cb106-864" aria-hidden="true" tabindex="-1"></a><span class="in"># Combine full dataset of factor levels with model results</span></span>
<span id="cb106-865"><a href="#cb106-865" aria-hidden="true" tabindex="-1"></a><span class="in">plot_data_bayes &lt;- chocolate_var_levels %&gt;%</span></span>
<span id="cb106-866"><a href="#cb106-866" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(</span></span>
<span id="cb106-867"><a href="#cb106-867" aria-hidden="true" tabindex="-1"></a><span class="in">    posterior_mfx_nested,</span></span>
<span id="cb106-868"><a href="#cb106-868" aria-hidden="true" tabindex="-1"></a><span class="in">    by = join_by(variable == term, levels == variable_level)</span></span>
<span id="cb106-869"><a href="#cb106-869" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;%</span></span>
<span id="cb106-870"><a href="#cb106-870" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(data = map_if(data, is.null, ~ tibble(draw = 0, estimate = 0))) %&gt;% </span></span>
<span id="cb106-871"><a href="#cb106-871" aria-hidden="true" tabindex="-1"></a><span class="in">  unnest(data) %&gt;% </span></span>
<span id="cb106-872"><a href="#cb106-872" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(chocolate_var_lookup, by = join_by(variable)) %&gt;% </span></span>
<span id="cb106-873"><a href="#cb106-873" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(across(c(levels, variable_nice), ~fct_inorder(.)))</span></span>
<span id="cb106-874"><a href="#cb106-874" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-875"><a href="#cb106-875" aria-hidden="true" tabindex="-1"></a><span class="in">p2 &lt;- ggplot(plot_data_bayes, aes(x = draw, y = levels, fill = variable_nice)) +</span></span>
<span id="cb106-876"><a href="#cb106-876" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0) +</span></span>
<span id="cb106-877"><a href="#cb106-877" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye(normalize = "groups") +  # Make the heights of the distributions equal within each facet</span></span>
<span id="cb106-878"><a href="#cb106-878" aria-hidden="true" tabindex="-1"></a><span class="in">  guides(fill = "none") +</span></span>
<span id="cb106-879"><a href="#cb106-879" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_col(facets = "variable_nice", scales = "free_y", space = "free") +</span></span>
<span id="cb106-880"><a href="#cb106-880" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_pp) +</span></span>
<span id="cb106-881"><a href="#cb106-881" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_manual(values = clrs[c(1, 3, 8)]) +</span></span>
<span id="cb106-882"><a href="#cb106-882" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(</span></span>
<span id="cb106-883"><a href="#cb106-883" aria-hidden="true" tabindex="-1"></a><span class="in">    x = "Percentage point change in\nprobability of candy selection",</span></span>
<span id="cb106-884"><a href="#cb106-884" aria-hidden="true" tabindex="-1"></a><span class="in">    y = NULL,</span></span>
<span id="cb106-885"><a href="#cb106-885" aria-hidden="true" tabindex="-1"></a><span class="in">    title = "Posterior Bayesian AMCEs from {brms}"</span></span>
<span id="cb106-886"><a href="#cb106-886" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb106-887"><a href="#cb106-887" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-888"><a href="#cb106-888" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-889"><a href="#cb106-889" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-amces-chocolate-both, fig.height=4, fig.width=8, out.width="100%"}</span></span>
<span id="cb106-890"><a href="#cb106-890" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: body-outset</span></span>
<span id="cb106-891"><a href="#cb106-891" aria-hidden="true" tabindex="-1"></a><span class="in">p1 | p2</span></span>
<span id="cb106-892"><a href="#cb106-892" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-893"><a href="#cb106-893" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-894"><a href="#cb106-894" aria-hidden="true" tabindex="-1"></a>\ </span>
<span id="cb106-895"><a href="#cb106-895" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-896"><a href="#cb106-896" aria-hidden="true" tabindex="-1"></a><span class="fu"># Part 2: Minivans; repeated questions; basic multinomial logit</span></span>
<span id="cb106-897"><a href="#cb106-897" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-898"><a href="#cb106-898" aria-hidden="true" tabindex="-1"></a><span class="fu">## The setup</span></span>
<span id="cb106-899"><a href="#cb106-899" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-900"><a href="#cb106-900" aria-hidden="true" tabindex="-1"></a>In this experiment, respondents are asked to choose which of these minivans they'd want to buy, based on four different features/attributes with different levels:</span>
<span id="cb106-901"><a href="#cb106-901" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-902"><a href="#cb106-902" aria-hidden="true" tabindex="-1"></a>| Features/Attributes | Levels                       |</span>
<span id="cb106-903"><a href="#cb106-903" aria-hidden="true" tabindex="-1"></a>|:--------------------|:-----------------------------|</span>
<span id="cb106-904"><a href="#cb106-904" aria-hidden="true" tabindex="-1"></a>| Passengers          | 6, 7, 8                      |</span>
<span id="cb106-905"><a href="#cb106-905" aria-hidden="true" tabindex="-1"></a>| Cargo area          | 2 feet, 3 feet               |</span>
<span id="cb106-906"><a href="#cb106-906" aria-hidden="true" tabindex="-1"></a>| Engine              | Gas, electric, hybrid        |</span>
<span id="cb106-907"><a href="#cb106-907" aria-hidden="true" tabindex="-1"></a>| Price               | \$30,000; \$35,000; \$40,000 |</span>
<span id="cb106-908"><a href="#cb106-908" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-909"><a href="#cb106-909" aria-hidden="true" tabindex="-1"></a>Respondents see this a question similar to this fifteen different times, with three options with randomly shuffled levels for each of the features.</span>
<span id="cb106-910"><a href="#cb106-910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-911"><a href="#cb106-911" aria-hidden="true" tabindex="-1"></a>:::: {.callout-tip}</span>
<span id="cb106-912"><a href="#cb106-912" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-913"><a href="#cb106-913" aria-hidden="true" tabindex="-1"></a><span class="fu">### Example survey question</span></span>
<span id="cb106-914"><a href="#cb106-914" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-915"><a href="#cb106-915" aria-hidden="true" tabindex="-1"></a>|            |            Option 1             |            Option 2             |            Option 3             |</span>
<span id="cb106-916"><a href="#cb106-916" aria-hidden="true" tabindex="-1"></a>|------------------|:----------------:|:----------------:|:----------------:|</span>
<span id="cb106-917"><a href="#cb106-917" aria-hidden="true" tabindex="-1"></a>| Passengers |                7                |                8                |                6                |</span>
<span id="cb106-918"><a href="#cb106-918" aria-hidden="true" tabindex="-1"></a>| Cargo area |             3 feet              |             3 feet              |             2 feet              |</span>
<span id="cb106-919"><a href="#cb106-919" aria-hidden="true" tabindex="-1"></a>| Engine     |            Electric             |               Gas               |             Hybrid              |</span>
<span id="cb106-920"><a href="#cb106-920" aria-hidden="true" tabindex="-1"></a>| Price      |            \$40,000             |            \$40,000             |            \$30,000             |</span>
<span id="cb106-921"><a href="#cb106-921" aria-hidden="true" tabindex="-1"></a>| Choice     | &lt;input type="radio" name="ex2"&gt; | &lt;input type="radio" name="ex2"&gt; | &lt;input type="radio" name="ex2"&gt; |</span>
<span id="cb106-922"><a href="#cb106-922" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-923"><a href="#cb106-923" aria-hidden="true" tabindex="-1"></a>::::</span>
<span id="cb106-924"><a href="#cb106-924" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-925"><a href="#cb106-925" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-926"><a href="#cb106-926" aria-hidden="true" tabindex="-1"></a><span class="fu">## The data</span></span>
<span id="cb106-927"><a href="#cb106-927" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-928"><a href="#cb106-928" aria-hidden="true" tabindex="-1"></a>The data for this kind of experiment has one row for each possible alternative (<span class="in">`alt`</span>) within each set of 15 questions (<span class="in">`ques`</span>), thus creating 3 × 15 = 45 rows per respondent (<span class="in">`resp.id`</span>). There were 200 respondents, with 45 rows each, so there are 200 × 45 = 9,000 rows. Here, Respondent 1 chose a \$30,000 gas van with 6 seats and 3 feet of cargo space in the first set of three options, a \$35,000 gas van with 7 seats and 3 feet of cargo space in the second set of three options, and so on. </span>
<span id="cb106-929"><a href="#cb106-929" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-930"><a href="#cb106-930" aria-hidden="true" tabindex="-1"></a>There's also a column here for <span class="in">`carpool`</span> indicating if the respondent carpools with others when commuting. It's an individual respondent-level characteristic and is constant throughout all the questions and alternatives, and we'll use it later.</span>
<span id="cb106-931"><a href="#cb106-931" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-932"><a href="#cb106-932" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-minivans}</span></span>
<span id="cb106-933"><a href="#cb106-933" aria-hidden="true" tabindex="-1"></a><span class="in">minivans</span></span>
<span id="cb106-934"><a href="#cb106-934" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-935"><a href="#cb106-935" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-936"><a href="#cb106-936" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-937"><a href="#cb106-937" aria-hidden="true" tabindex="-1"></a><span class="fu">## The model</span></span>
<span id="cb106-938"><a href="#cb106-938" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-939"><a href="#cb106-939" aria-hidden="true" tabindex="-1"></a>Respondents were shown three different options and asked to select one. We thus have three possible outcomes: a respondent could have selected option 1, option 2, or option 3. Because everything was randomized, there shouldn't be any patterns in which options people choose—we don't want to see that the first column is more common, since that would indicate that respondents are just repeatedly selecting the first column to get through the survey. Since there are three possible outcomes (option 1, 2, and 3), we'll use multinomial logistic regression.</span>
<span id="cb106-940"><a href="#cb106-940" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-941"><a href="#cb106-941" aria-hidden="true" tabindex="-1"></a><span class="fu">### Original model as a baseline</span></span>
<span id="cb106-942"><a href="#cb106-942" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-943"><a href="#cb106-943" aria-hidden="true" tabindex="-1"></a>In the example in their textbook, @ChapmanFeit:2019 use {mlogit} to estimate this model and they find these results. This will be our baseline throughout this example.</span>
<span id="cb106-944"><a href="#cb106-944" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-945"><a href="#cb106-945" aria-hidden="true" tabindex="-1"></a><span class="al">![Original results from @ChapmanFeit:2019 p. 371](img/chapman-feit-mlogit.png)</span></span>
<span id="cb106-946"><a href="#cb106-946" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-947"><a href="#cb106-947" aria-hidden="true" tabindex="-1"></a><span class="fu">### `mlogit` model</span></span>
<span id="cb106-948"><a href="#cb106-948" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-949"><a href="#cb106-949" aria-hidden="true" tabindex="-1"></a>This data is a little more complex now, since there are alternatives nested inside questions inside respondents. To account for this panel structure when using {mlogit}, we need to define two index columns: one for the unique set of alternatives offered to the respondent and one for the respondent ID. We still do this with <span class="in">`dfidx()`</span>, but need to create a new column with an ID number for each unique combination of respondent ID and question number:</span>
<span id="cb106-950"><a href="#cb106-950" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-951"><a href="#cb106-951" aria-hidden="true" tabindex="-1"></a><span class="in">```{r make-dfidx-minivans}</span></span>
<span id="cb106-952"><a href="#cb106-952" aria-hidden="true" tabindex="-1"></a><span class="in">minivans_idx &lt;- minivans %&gt;% </span></span>
<span id="cb106-953"><a href="#cb106-953" aria-hidden="true" tabindex="-1"></a><span class="in">  # mlogit() needs a column with unique question id numbers</span></span>
<span id="cb106-954"><a href="#cb106-954" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(resp.id, ques) %&gt;% </span></span>
<span id="cb106-955"><a href="#cb106-955" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(choice.id = cur_group_id()) %&gt;% </span></span>
<span id="cb106-956"><a href="#cb106-956" aria-hidden="true" tabindex="-1"></a><span class="in">  ungroup() %&gt;% </span></span>
<span id="cb106-957"><a href="#cb106-957" aria-hidden="true" tabindex="-1"></a><span class="in">  # Make indexed data frame for mlogit</span></span>
<span id="cb106-958"><a href="#cb106-958" aria-hidden="true" tabindex="-1"></a><span class="in">  dfidx(</span></span>
<span id="cb106-959"><a href="#cb106-959" aria-hidden="true" tabindex="-1"></a><span class="in">    idx = list(c("choice.id", "resp.id"), "alt"),</span></span>
<span id="cb106-960"><a href="#cb106-960" aria-hidden="true" tabindex="-1"></a><span class="in">    choice = "choice",</span></span>
<span id="cb106-961"><a href="#cb106-961" aria-hidden="true" tabindex="-1"></a><span class="in">    shape = "long"</span></span>
<span id="cb106-962"><a href="#cb106-962" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb106-963"><a href="#cb106-963" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-964"><a href="#cb106-964" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-965"><a href="#cb106-965" aria-hidden="true" tabindex="-1"></a>Now we can fit the model. Note the <span class="in">`0 ~ seat`</span> syntax here. That suppresses the intercept for the model, which behaves weirdly with multinomial models. Since there are three categories for the outcome (options 1, 2, and 3), there are two intercepts, representing cutpoints-from-ordered-logit-esque shifts in the probability of selecting option 1 vs. option 2 and option 2 vs. option 3. We don't want to deal with those, so we'll suppress them. </span>
<span id="cb106-966"><a href="#cb106-966" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-967"><a href="#cb106-967" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-minivans-mlogit, message=FALSE}</span></span>
<span id="cb106-968"><a href="#cb106-968" aria-hidden="true" tabindex="-1"></a><span class="in">model_minivans_mlogit &lt;- mlogit(</span></span>
<span id="cb106-969"><a href="#cb106-969" aria-hidden="true" tabindex="-1"></a><span class="in">  choice ~ 0 + seat + cargo + eng + price | 0 | 0, </span></span>
<span id="cb106-970"><a href="#cb106-970" aria-hidden="true" tabindex="-1"></a><span class="in">  data = minivans_idx</span></span>
<span id="cb106-971"><a href="#cb106-971" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb106-972"><a href="#cb106-972" aria-hidden="true" tabindex="-1"></a><span class="in">model_parameters(model_minivans_mlogit, digits = 4, p_digits = 4)</span></span>
<span id="cb106-973"><a href="#cb106-973" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-974"><a href="#cb106-974" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-975"><a href="#cb106-975" aria-hidden="true" tabindex="-1"></a>These are the same results from p. 371 in @ChapmanFeit:2019, so it worked. Again, the marketing world doesn't typically do much with these coefficients beyond looking at their direction and magnitude. For instance, in @ChapmanFeit:2019 they say that the estimate for <span class="in">`seat [7]`</span> here is negative, which means that a 7-seat option is less preferred than 6-seat option, and that the estimate for <span class="in">`price [40]`</span> is more negative than the already-negative estimate for <span class="in">`price [35]`</span>, which means that (1) respondents don't like the \$35,000 option compared to the baseline \$30,000 and that (2) respondents *really* don't like the \$40,000 option. We could theoretically exponentiate these things—like, seeing 7 seats makes it $e^{-0.5353}$ = 0.5855 = 41% less likely to select the option compared to 6 seats—but again, that's weird.</span>
<span id="cb106-976"><a href="#cb106-976" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-977"><a href="#cb106-977" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-978"><a href="#cb106-978" aria-hidden="true" tabindex="-1"></a><span class="fu">### `mclogit` model</span></span>
<span id="cb106-979"><a href="#cb106-979" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-980"><a href="#cb106-980" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">As noted earlier</span><span class="co">](#mclogit-note)</span>, {marginaleffects} doesn't support <span class="in">`mlogit()`</span> because of its weird internal structure. It *does* support <span class="in">`mclogit::mclogit()`</span> though.</span>
<span id="cb106-981"><a href="#cb106-981" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-982"><a href="#cb106-982" aria-hidden="true" tabindex="-1"></a>The syntax requires two parts on the left-hand side of the formula: (1) the choice selected (0 or 1), and (2) a unique id for set of choices, or the question. Like with <span class="in">`mlogit()`</span>, we can create a <span class="in">`choice.id`</span> column identifying the unique question numbers, and then use that in the formula.</span>
<span id="cb106-983"><a href="#cb106-983" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-984"><a href="#cb106-984" aria-hidden="true" tabindex="-1"></a>The results are the same: </span>
<span id="cb106-985"><a href="#cb106-985" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-986"><a href="#cb106-986" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mclogit-example-vans}</span></span>
<span id="cb106-987"><a href="#cb106-987" aria-hidden="true" tabindex="-1"></a><span class="in">library(mclogit)</span></span>
<span id="cb106-988"><a href="#cb106-988" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-989"><a href="#cb106-989" aria-hidden="true" tabindex="-1"></a><span class="in">minivans_mclogit &lt;- minivans %&gt;% </span></span>
<span id="cb106-990"><a href="#cb106-990" aria-hidden="true" tabindex="-1"></a><span class="in">  # mclogit() needs a column with unique question id numbers</span></span>
<span id="cb106-991"><a href="#cb106-991" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(resp.id, ques) %&gt;% </span></span>
<span id="cb106-992"><a href="#cb106-992" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(choice.id = cur_group_id()) %&gt;%</span></span>
<span id="cb106-993"><a href="#cb106-993" aria-hidden="true" tabindex="-1"></a><span class="in">  ungroup()</span></span>
<span id="cb106-994"><a href="#cb106-994" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-995"><a href="#cb106-995" aria-hidden="true" tabindex="-1"></a><span class="in">model_minivans_mclogit &lt;- mclogit(</span></span>
<span id="cb106-996"><a href="#cb106-996" aria-hidden="true" tabindex="-1"></a><span class="in">  choice | choice.id ~ seat + cargo + eng + price,</span></span>
<span id="cb106-997"><a href="#cb106-997" aria-hidden="true" tabindex="-1"></a><span class="in">  data = minivans_mclogit</span></span>
<span id="cb106-998"><a href="#cb106-998" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb106-999"><a href="#cb106-999" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1000"><a href="#cb106-1000" aria-hidden="true" tabindex="-1"></a><span class="in">model_parameters(model_minivans_mclogit, digits = 4, p_digits = 4)</span></span>
<span id="cb106-1001"><a href="#cb106-1001" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1002"><a href="#cb106-1002" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1003"><a href="#cb106-1003" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1004"><a href="#cb106-1004" aria-hidden="true" tabindex="-1"></a><span class="fu">### Bayesian model with {brms}</span></span>
<span id="cb106-1005"><a href="#cb106-1005" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1006"><a href="#cb106-1006" aria-hidden="true" tabindex="-1"></a>We can also fit this multinomial model in a Bayesian way using {brms}. Stan has a categorical family for dealing with mulitnomial/categorical outcomes. But first, we'll look at the nested structure of this data and incorporate that into the model, since we won't be using the weird {mlogit}-style indexed data frame. As with the chocolate experiment, the data has a natural hierarchy in it, with three questions nested inside 15 separate question sets, nested inside each of the 200 respondents.</span>
<span id="cb106-1007"><a href="#cb106-1007" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1008"><a href="#cb106-1008" aria-hidden="true" tabindex="-1"></a><span class="in">```{tikz minivan-multilevel-structure, engine.opts=font_opts}</span></span>
<span id="cb106-1009"><a href="#cb106-1009" aria-hidden="true" tabindex="-1"></a><span class="in">#| echo: false</span></span>
<span id="cb106-1010"><a href="#cb106-1010" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: "Multilevel experimental structure, with minivan choices $\\{y_1, y_2, y_3\\}$ nested in sets of questions in respondents"</span></span>
<span id="cb106-1011"><a href="#cb106-1011" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-align: center</span></span>
<span id="cb106-1012"><a href="#cb106-1012" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-ext: svg</span></span>
<span id="cb106-1013"><a href="#cb106-1013" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page</span></span>
<span id="cb106-1014"><a href="#cb106-1014" aria-hidden="true" tabindex="-1"></a><span class="in">#| out-width: 100%</span></span>
<span id="cb106-1015"><a href="#cb106-1015" aria-hidden="true" tabindex="-1"></a><span class="in">\usetikzlibrary{positioning}</span></span>
<span id="cb106-1016"><a href="#cb106-1016" aria-hidden="true" tabindex="-1"></a><span class="in">\usetikzlibrary{shapes.geometric}</span></span>
<span id="cb106-1017"><a href="#cb106-1017" aria-hidden="true" tabindex="-1"></a><span class="in">\begin{tikzpicture}[{every node/.append style}=draw]</span></span>
<span id="cb106-1018"><a href="#cb106-1018" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [rectangle] (respondent1) at (0, 2.5) {Respondent 1};</span></span>
<span id="cb106-1019"><a href="#cb106-1019" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1020"><a href="#cb106-1020" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [rectangle] (q11) at (-1.5, 1) {Set $1_1$};</span></span>
<span id="cb106-1021"><a href="#cb106-1021" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [draw=none] (q21) at (0, 1) {$\dots$};</span></span>
<span id="cb106-1022"><a href="#cb106-1022" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [rectangle] (q31) at (1.5, 1) {Set $15_1$};</span></span>
<span id="cb106-1023"><a href="#cb106-1023" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1024"><a href="#cb106-1024" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [circle] (y111) at (-3.75, -0.5) {$y_{1_{1_1}}$};</span></span>
<span id="cb106-1025"><a href="#cb106-1025" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [circle] (y211) at (-2.5, -0.5) {$y_{2_{1_1}}$};</span></span>
<span id="cb106-1026"><a href="#cb106-1026" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [circle] (y311) at (-1.25, -0.5) {$y_{3_{1_1}}$};</span></span>
<span id="cb106-1027"><a href="#cb106-1027" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1028"><a href="#cb106-1028" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [draw=none] (y121) at (0, -0.5) {$\dots$};</span></span>
<span id="cb106-1029"><a href="#cb106-1029" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1030"><a href="#cb106-1030" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [circle] (y131) at (1.25, -0.5) {$y_{1_{15_1}}$};</span></span>
<span id="cb106-1031"><a href="#cb106-1031" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [circle] (y231) at (2.5, -0.5) {$y_{2_{15_1}}$};</span></span>
<span id="cb106-1032"><a href="#cb106-1032" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [circle] (y331) at (3.75, -0.5) {$y_{3_{15_1}}$};</span></span>
<span id="cb106-1033"><a href="#cb106-1033" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1034"><a href="#cb106-1034" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (respondent1) to (q11);</span></span>
<span id="cb106-1035"><a href="#cb106-1035" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (respondent1) to (q21);</span></span>
<span id="cb106-1036"><a href="#cb106-1036" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (respondent1) to (q31);</span></span>
<span id="cb106-1037"><a href="#cb106-1037" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (q11) to (y111);</span></span>
<span id="cb106-1038"><a href="#cb106-1038" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (q11) to (y211);</span></span>
<span id="cb106-1039"><a href="#cb106-1039" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (q11) to (y311);</span></span>
<span id="cb106-1040"><a href="#cb106-1040" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (q21) to (y121);</span></span>
<span id="cb106-1041"><a href="#cb106-1041" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (q31) to (y131);</span></span>
<span id="cb106-1042"><a href="#cb106-1042" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (q31) to (y231);</span></span>
<span id="cb106-1043"><a href="#cb106-1043" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (q31) to (y331);</span></span>
<span id="cb106-1044"><a href="#cb106-1044" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1045"><a href="#cb106-1045" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [draw=none] (respondent2) at (5, 2.5) {$\dots$};</span></span>
<span id="cb106-1046"><a href="#cb106-1046" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [rectangle] (y12) at (4, 1) {Set 1};</span></span>
<span id="cb106-1047"><a href="#cb106-1047" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [draw=none] (y22) at (5, 1) {$\dots$};</span></span>
<span id="cb106-1048"><a href="#cb106-1048" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [rectangle] (y32) at (6, 1) {Set 15};</span></span>
<span id="cb106-1049"><a href="#cb106-1049" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (respondent2) to (y12);</span></span>
<span id="cb106-1050"><a href="#cb106-1050" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (respondent2) to (y22);</span></span>
<span id="cb106-1051"><a href="#cb106-1051" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (respondent2) to (y32);</span></span>
<span id="cb106-1052"><a href="#cb106-1052" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1053"><a href="#cb106-1053" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [rectangle] (respondentn) at (10, 2.5) {Respondent 200};</span></span>
<span id="cb106-1054"><a href="#cb106-1054" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [rectangle] (q1n) at (8.5, 1) {Set $1_{200}$};</span></span>
<span id="cb106-1055"><a href="#cb106-1055" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [draw=none] (q2n) at (10, 1) {$\dots$};</span></span>
<span id="cb106-1056"><a href="#cb106-1056" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [rectangle] (q3n) at (11.5, 1) {Set $15_{200}$};</span></span>
<span id="cb106-1057"><a href="#cb106-1057" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1058"><a href="#cb106-1058" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [circle] (y113) at (6.25, -0.5) {$y_{1_{1_{200}}}$};</span></span>
<span id="cb106-1059"><a href="#cb106-1059" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [circle] (y213) at (7.5, -0.5) {$y_{2_{1_{200}}}$};</span></span>
<span id="cb106-1060"><a href="#cb106-1060" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [circle] (y313) at (8.75, -0.5) {$y_{3_{1_{200}}}$};</span></span>
<span id="cb106-1061"><a href="#cb106-1061" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1062"><a href="#cb106-1062" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [draw=none] (y123) at (10, -0.5) {$\dots$};</span></span>
<span id="cb106-1063"><a href="#cb106-1063" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1064"><a href="#cb106-1064" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [circle] (y133) at (11.25, -0.5) {$y_{1_{15_{200}}}$};</span></span>
<span id="cb106-1065"><a href="#cb106-1065" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [circle] (y233) at (12.5, -0.5) {$y_{2_{15_{200}}}$};</span></span>
<span id="cb106-1066"><a href="#cb106-1066" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [circle] (y333) at (13.75, -0.5) {$y_{3_{15_{200}}}$};</span></span>
<span id="cb106-1067"><a href="#cb106-1067" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1068"><a href="#cb106-1068" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (respondentn) to (q1n);</span></span>
<span id="cb106-1069"><a href="#cb106-1069" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (respondentn) to (q2n);</span></span>
<span id="cb106-1070"><a href="#cb106-1070" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (respondentn) to (q3n);</span></span>
<span id="cb106-1071"><a href="#cb106-1071" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (q1n) to (y113);</span></span>
<span id="cb106-1072"><a href="#cb106-1072" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (q1n) to (y213);</span></span>
<span id="cb106-1073"><a href="#cb106-1073" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (q1n) to (y313);</span></span>
<span id="cb106-1074"><a href="#cb106-1074" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (q2n) to (y123);</span></span>
<span id="cb106-1075"><a href="#cb106-1075" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (q3n) to (y133);</span></span>
<span id="cb106-1076"><a href="#cb106-1076" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (q3n) to (y233);</span></span>
<span id="cb106-1077"><a href="#cb106-1077" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (q3n) to (y333);</span></span>
<span id="cb106-1078"><a href="#cb106-1078" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1079"><a href="#cb106-1079" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [rectangle] (population) at (5, 4) {Population of experiment respondents};</span></span>
<span id="cb106-1080"><a href="#cb106-1080" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (population) to (respondent1);</span></span>
<span id="cb106-1081"><a href="#cb106-1081" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (population) to (respondent2);</span></span>
<span id="cb106-1082"><a href="#cb106-1082" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (population) to (respondentn);</span></span>
<span id="cb106-1083"><a href="#cb106-1083" aria-hidden="true" tabindex="-1"></a><span class="in">\end{tikzpicture}</span></span>
<span id="cb106-1084"><a href="#cb106-1084" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1085"><a href="#cb106-1085" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1086"><a href="#cb106-1086" aria-hidden="true" tabindex="-1"></a>Currently, our main outcome variable <span class="in">`choice`</span> is binary. If we run the model with <span class="in">`choice`</span> as the outcome with a categorical family, the model will fit, but it will go slow and {brms} will complain about it and recommend switching to regular logistic regression. The categorical family in Stan requires 2+ outcomes and a reference category. Here we have three possible options (1, 2, and 3), and we can imagine a reference category of 0 for rows that weren't selected. </span>
<span id="cb106-1087"><a href="#cb106-1087" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1088"><a href="#cb106-1088" aria-hidden="true" tabindex="-1"></a>We can create a new outcome column (<span class="in">`choice_alt`</span>) that indicates which option each respondent selected: 0 if they didn't choose the option and 1–3 if they chose the first, second, or third option. Because of how the data is recorded, this only requires multiplying <span class="in">`alt`</span> and <span class="in">`choice`</span>:</span>
<span id="cb106-1089"><a href="#cb106-1089" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1090"><a href="#cb106-1090" aria-hidden="true" tabindex="-1"></a><span class="in">```{r create-choice-alt-column}</span></span>
<span id="cb106-1091"><a href="#cb106-1091" aria-hidden="true" tabindex="-1"></a><span class="in">minivans_choice_alt &lt;- minivans %&gt;% </span></span>
<span id="cb106-1092"><a href="#cb106-1092" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(choice_alt = factor(alt * choice))</span></span>
<span id="cb106-1093"><a href="#cb106-1093" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1094"><a href="#cb106-1094" aria-hidden="true" tabindex="-1"></a><span class="in">minivans_choice_alt %&gt;% </span></span>
<span id="cb106-1095"><a href="#cb106-1095" aria-hidden="true" tabindex="-1"></a><span class="in">  select(resp.id, ques, alt, seat, cargo, eng, price, choice, choice_alt)</span></span>
<span id="cb106-1096"><a href="#cb106-1096" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1097"><a href="#cb106-1097" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1098"><a href="#cb106-1098" aria-hidden="true" tabindex="-1"></a>We can now use the new four-category <span class="in">`choice_alt`</span> column as our outcome with the <span class="in">`categorical()`</span> family. </span>
<span id="cb106-1099"><a href="#cb106-1099" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1100"><a href="#cb106-1100" aria-hidden="true" tabindex="-1"></a>If we *realllly* wanted, we could add random effects for question sets nested inside respondents, like <span class="in">`(1 | resp.id / ques)`</span>. We'd want to do that if there were set-specific things that could influences choices. Like maybe we want to account for the possibility that everyone's just choosing the first option, so it behaves differently? Or maybe the 5th set of questions is set to an extra difficult level on a quiz or something? Or maybe we have so many sets that we think the later ones will be less accurate because of respondent fatigue? idk. In this case, question set-specific effects don't matter at all. Each question set is equally randomized and no different from the others, so we won't bother modeling that layer of the hierarchy.</span>
<span id="cb106-1101"><a href="#cb106-1101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1102"><a href="#cb106-1102" aria-hidden="true" tabindex="-1"></a>We want to model the choice of option 1, 2, or 3 (<span class="in">`choice_alt`</span>) based on minivan characteristics (<span class="in">`seat`</span>, <span class="in">`cargo`</span>, <span class="in">`eng`</span>, price). With the categorical model, we actually get a set of parameters to estimate the probability of selecting each of the options, which Stan calls $\mu$, so we have a set of three probabilities: $<span class="sc">\{</span>\mu_1, \mu_2, \mu_3<span class="sc">\}</span>$. We'll use the subscript $i$ to refer to individual minivan choices and $j$ to refer to respondents. Here's the fun formal model:</span>
<span id="cb106-1103"><a href="#cb106-1103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1104"><a href="#cb106-1104" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-1105"><a href="#cb106-1105" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb106-1106"><a href="#cb106-1106" aria-hidden="true" tabindex="-1"></a>&amp;\ \textbf{Multinomial probability of selection of choice}_i \textbf{ in respondent}_j <span class="sc">\\</span></span>
<span id="cb106-1107"><a href="#cb106-1107" aria-hidden="true" tabindex="-1"></a>\text{Choice}_{i_j} \sim&amp;\ \operatorname{Categorical}(\{\mu_{1,i_j}, \mu_{2,i_j}, \mu_{3,i_j}<span class="sc">\}</span>) <span class="sc">\\</span><span class="co">[</span><span class="ot">10pt</span><span class="co">]</span></span>
<span id="cb106-1108"><a href="#cb106-1108" aria-hidden="true" tabindex="-1"></a>&amp;\ \textbf{Model for probability of each option} <span class="sc">\\</span></span>
<span id="cb106-1109"><a href="#cb106-1109" aria-hidden="true" tabindex="-1"></a><span class="sc">\{</span>\mu_{1,i_j}, \mu_{2,i_j}, \mu_{3,i_j}<span class="sc">\}</span> =&amp;\ (\beta_0 + b_{0_j}) + \beta_1 \text{Seat<span class="co">[</span><span class="ot">7</span><span class="co">]</span>}_{i_j} + \beta_2 \text{Seat[8]}_{i_j} + \beta_3 \text{Cargo[3ft]}_{i_j} + <span class="sc">\\</span></span>
<span id="cb106-1110"><a href="#cb106-1110" aria-hidden="true" tabindex="-1"></a>&amp;\ \beta_4 \text{Engine<span class="co">[</span><span class="ot">hyb</span><span class="co">]</span>}_{i_j} + \beta_5 \text{Engine[elec]}_{i_j} + \beta_6 \text{Price[35k]}_{i_j} + \beta_7 \text{Price[40k]}_{i_j} <span class="sc">\\</span><span class="co">[</span><span class="ot">5pt</span><span class="co">]</span></span>
<span id="cb106-1111"><a href="#cb106-1111" aria-hidden="true" tabindex="-1"></a>b_{0_j} \sim&amp;\ \mathcal{N}(0, \sigma_0) \qquad\quad\quad \text{Respondent-specific offsets from global probability} <span class="sc">\\</span><span class="co">[</span><span class="ot">10pt</span><span class="co">]</span></span>
<span id="cb106-1112"><a href="#cb106-1112" aria-hidden="true" tabindex="-1"></a>&amp;\ \textbf{Priors} <span class="sc">\\</span></span>
<span id="cb106-1113"><a href="#cb106-1113" aria-hidden="true" tabindex="-1"></a>\beta_{0 \dots 7} \sim&amp;\ \mathcal{N} (0, 3) \qquad\qquad\ \ \text{Prior for choice-level coefficients} <span class="sc">\\</span></span>
<span id="cb106-1114"><a href="#cb106-1114" aria-hidden="true" tabindex="-1"></a>\sigma_0 \sim&amp;\ \operatorname{Exponential}(1) \quad \text{Prior for between-respondent variability}</span>
<span id="cb106-1115"><a href="#cb106-1115" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb106-1116"><a href="#cb106-1116" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-1117"><a href="#cb106-1117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1118"><a href="#cb106-1118" aria-hidden="true" tabindex="-1"></a>And here's the {brms} model. Notice the much-more-verbose prior section—because the categorical family in Stan estimates separate parameters for each of the categories ($<span class="sc">\{</span>\mu_1, \mu_2, \mu_3<span class="sc">\}</span>$), we have a mean and standard deviation for the probability of selecting each of those options. We need to specify each of these separately too instead of just doing something like <span class="in">`prior(normal(0, 3), class = b)`</span>. Also notice the <span class="in">`refcat`</span> argument in <span class="in">`categorical()`</span>—this makes it so that all the estimates are relative to not choosing an option (or when <span class="in">`choice_alt`</span> is 0). And *also* notice the slightly different syntax for the random respondent intercepts: <span class="in">`(1 | ID | resp.id)`</span>. That new middle <span class="in">`ID`</span> is special {brms} formula syntax that we can use when working with categorical or ordinal families, and it makes it so that the group-level effects for the different outcomes (here options 0, 1, 2, and 3) are correlated (see p. 4 of <span class="co">[</span><span class="ot">this {brms} vignette</span><span class="co">](https://cran.r-project.org/web/packages/brms/vignettes/brms_multilevel.pdf)</span> for more about this special syntax).</span>
<span id="cb106-1119"><a href="#cb106-1119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1120"><a href="#cb106-1120" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-minivans-categorical-brms}</span></span>
<span id="cb106-1121"><a href="#cb106-1121" aria-hidden="true" tabindex="-1"></a><span class="in">model_minivans_categorical_brms &lt;- brm(</span></span>
<span id="cb106-1122"><a href="#cb106-1122" aria-hidden="true" tabindex="-1"></a><span class="in">  bf(choice_alt ~ 0 + seat + cargo + eng + price + (1 | ID | resp.id)),</span></span>
<span id="cb106-1123"><a href="#cb106-1123" aria-hidden="true" tabindex="-1"></a><span class="in">  data = minivans_choice_alt,</span></span>
<span id="cb106-1124"><a href="#cb106-1124" aria-hidden="true" tabindex="-1"></a><span class="in">  family = categorical(refcat = "0"),</span></span>
<span id="cb106-1125"><a href="#cb106-1125" aria-hidden="true" tabindex="-1"></a><span class="in">  prior = c(</span></span>
<span id="cb106-1126"><a href="#cb106-1126" aria-hidden="true" tabindex="-1"></a><span class="in">    prior(normal(0, 3), class = b, dpar = mu1),</span></span>
<span id="cb106-1127"><a href="#cb106-1127" aria-hidden="true" tabindex="-1"></a><span class="in">    prior(normal(0, 3), class = b, dpar = mu2),</span></span>
<span id="cb106-1128"><a href="#cb106-1128" aria-hidden="true" tabindex="-1"></a><span class="in">    prior(normal(0, 3), class = b, dpar = mu3),</span></span>
<span id="cb106-1129"><a href="#cb106-1129" aria-hidden="true" tabindex="-1"></a><span class="in">    prior(exponential(1), class = sd, dpar = mu1),</span></span>
<span id="cb106-1130"><a href="#cb106-1130" aria-hidden="true" tabindex="-1"></a><span class="in">    prior(exponential(1), class = sd, dpar = mu2),</span></span>
<span id="cb106-1131"><a href="#cb106-1131" aria-hidden="true" tabindex="-1"></a><span class="in">    prior(exponential(1), class = sd, dpar = mu3)</span></span>
<span id="cb106-1132"><a href="#cb106-1132" aria-hidden="true" tabindex="-1"></a><span class="in">  ),</span></span>
<span id="cb106-1133"><a href="#cb106-1133" aria-hidden="true" tabindex="-1"></a><span class="in">  chains = 4, cores = 4, iter = 2000, seed = 1234,</span></span>
<span id="cb106-1134"><a href="#cb106-1134" aria-hidden="true" tabindex="-1"></a><span class="in">  backend = "cmdstanr", threads = threading(2), refresh = 0,</span></span>
<span id="cb106-1135"><a href="#cb106-1135" aria-hidden="true" tabindex="-1"></a><span class="in">  file = "models/model_minivans_categorical_brms"</span></span>
<span id="cb106-1136"><a href="#cb106-1136" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb106-1137"><a href="#cb106-1137" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1138"><a href="#cb106-1138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1139"><a href="#cb106-1139" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-cargo3ft-results, include=FALSE}</span></span>
<span id="cb106-1140"><a href="#cb106-1140" aria-hidden="true" tabindex="-1"></a><span class="in">cargo3ft_results &lt;- model_minivans_categorical_brms %&gt;%</span></span>
<span id="cb106-1141"><a href="#cb106-1141" aria-hidden="true" tabindex="-1"></a><span class="in">  # gather_draws(`b_.*`, regex = TRUE) %&gt;%</span></span>
<span id="cb106-1142"><a href="#cb106-1142" aria-hidden="true" tabindex="-1"></a><span class="in">  gather_draws(`b_mu\\d_cargo3ft`, regex = TRUE) %&gt;%</span></span>
<span id="cb106-1143"><a href="#cb106-1143" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(.variable) %&gt;%</span></span>
<span id="cb106-1144"><a href="#cb106-1144" aria-hidden="true" tabindex="-1"></a><span class="in">  median_qi() %&gt;%</span></span>
<span id="cb106-1145"><a href="#cb106-1145" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(across(</span></span>
<span id="cb106-1146"><a href="#cb106-1146" aria-hidden="true" tabindex="-1"></a><span class="in">    c(.value, .lower, .upper),</span></span>
<span id="cb106-1147"><a href="#cb106-1147" aria-hidden="true" tabindex="-1"></a><span class="in">    list(nice = ~ label_comma(accuracy = 0.01, style_negative = "minus")(.))</span></span>
<span id="cb106-1148"><a href="#cb106-1148" aria-hidden="true" tabindex="-1"></a><span class="in">  )) %&gt;% </span></span>
<span id="cb106-1149"><a href="#cb106-1149" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(ci = glue::glue("{.lower_nice}–{.upper_nice}")) %&gt;% </span></span>
<span id="cb106-1150"><a href="#cb106-1150" aria-hidden="true" tabindex="-1"></a><span class="in">  split(~.variable)</span></span>
<span id="cb106-1151"><a href="#cb106-1151" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1152"><a href="#cb106-1152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1153"><a href="#cb106-1153" aria-hidden="true" tabindex="-1"></a>This model gives us a ton of parameters! We get three estimates per feature level (i.e. <span class="in">`mu1_cargo3ft`</span>, <span class="in">`mu2_cargo3ft`</span>, and <span class="in">`mu3_cargo3ft`</span> for the <span class="in">`cargo3ft`</span> effect), since we're actually estimating the effect of each covariate on the probability of selecting each of the three options.</span>
<span id="cb106-1154"><a href="#cb106-1154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1155"><a href="#cb106-1155" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-model-minivans-brms, warning=FALSE, message=FALSE}</span></span>
<span id="cb106-1156"><a href="#cb106-1156" aria-hidden="true" tabindex="-1"></a><span class="in">model_parameters(model_minivans_categorical_brms)</span></span>
<span id="cb106-1157"><a href="#cb106-1157" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1158"><a href="#cb106-1158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1159"><a href="#cb106-1159" aria-hidden="true" tabindex="-1"></a>Importantly, the estimates here are all roughly equivalent to what we get from {mlogit}: the {mlogit} estimate for <span class="in">`cargo3ft`</span> was 0.4775, while the three median posterior {brms} estimates are <span class="in">`r cargo3ft_results$b_mu1_cargo3ft$.value_nice`</span> (95% credible interval: <span class="in">`r cargo3ft_results$b_mu1_cargo3ft$ci`</span>), <span class="in">`r cargo3ft_results$b_mu2_cargo3ft$.value_nice`</span> (<span class="in">`r cargo3ft_results$b_mu2_cargo3ft$ci`</span>), and <span class="in">`r cargo3ft_results$b_mu3_cargo3ft$.value_nice`</span> (<span class="in">`r cargo3ft_results$b_mu3_cargo3ft$ci`</span>)</span>
<span id="cb106-1160"><a href="#cb106-1160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1161"><a href="#cb106-1161" aria-hidden="true" tabindex="-1"></a>Since all the features are randomly shuffled between the three options each time, and each option is selected 1/3rd of the time, it's probably maybe legal to pool these posterior estimates together (maaaaybeee???) so that we don't have to work with three separate estimates for each parameter? To do this we'll take the average of each of the three $\mu$ estimates within each draw, which is also called "marginalizing" across the three options.</span>
<span id="cb106-1162"><a href="#cb106-1162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1163"><a href="#cb106-1163" aria-hidden="true" tabindex="-1"></a>Here's how we'd do that with {tidybayes}. The medians are all roughly the same now!</span>
<span id="cb106-1164"><a href="#cb106-1164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1165"><a href="#cb106-1165" aria-hidden="true" tabindex="-1"></a><span class="in">```{r marginalize-cat-posterior-estimates}</span></span>
<span id="cb106-1166"><a href="#cb106-1166" aria-hidden="true" tabindex="-1"></a><span class="in">minivans_cat_marginalized &lt;- model_minivans_categorical_brms %&gt;% </span></span>
<span id="cb106-1167"><a href="#cb106-1167" aria-hidden="true" tabindex="-1"></a><span class="in">  gather_draws(`^b_.*$`, regex = TRUE) %&gt;% </span></span>
<span id="cb106-1168"><a href="#cb106-1168" aria-hidden="true" tabindex="-1"></a><span class="in">  # Each variable name has "mu1", "mu2", etc. built in, like "b_mu1_seat6". This</span></span>
<span id="cb106-1169"><a href="#cb106-1169" aria-hidden="true" tabindex="-1"></a><span class="in">  # splits the .variable column into two parts based on a regular expression,</span></span>
<span id="cb106-1170"><a href="#cb106-1170" aria-hidden="true" tabindex="-1"></a><span class="in">  # creating one column for the mu part ("b_mu1_") and one for the rest of the</span></span>
<span id="cb106-1171"><a href="#cb106-1171" aria-hidden="true" tabindex="-1"></a><span class="in">  # variable name ("seat6")</span></span>
<span id="cb106-1172"><a href="#cb106-1172" aria-hidden="true" tabindex="-1"></a><span class="in">  separate_wider_regex(</span></span>
<span id="cb106-1173"><a href="#cb106-1173" aria-hidden="true" tabindex="-1"></a><span class="in">    .variable,</span></span>
<span id="cb106-1174"><a href="#cb106-1174" aria-hidden="true" tabindex="-1"></a><span class="in">    patterns = c(mu = "b_mu\\d_", .variable = ".*")</span></span>
<span id="cb106-1175"><a href="#cb106-1175" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;% </span></span>
<span id="cb106-1176"><a href="#cb106-1176" aria-hidden="true" tabindex="-1"></a><span class="in">  # Find the average of the three mu estimates for each variable within each</span></span>
<span id="cb106-1177"><a href="#cb106-1177" aria-hidden="true" tabindex="-1"></a><span class="in">  # draw, or marginalize across the three options, since they're randomized</span></span>
<span id="cb106-1178"><a href="#cb106-1178" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(.variable, .draw) %&gt;% </span></span>
<span id="cb106-1179"><a href="#cb106-1179" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(.value = mean(.value)) </span></span>
<span id="cb106-1180"><a href="#cb106-1180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1181"><a href="#cb106-1181" aria-hidden="true" tabindex="-1"></a><span class="in">minivans_cat_marginalized %&gt;% </span></span>
<span id="cb106-1182"><a href="#cb106-1182" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(.variable) %&gt;% </span></span>
<span id="cb106-1183"><a href="#cb106-1183" aria-hidden="true" tabindex="-1"></a><span class="in">  median_qi()</span></span>
<span id="cb106-1184"><a href="#cb106-1184" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1185"><a href="#cb106-1185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1186"><a href="#cb106-1186" aria-hidden="true" tabindex="-1"></a>And for fun, here's what the posterior for new combined/collapsed/marginalized <span class="in">`cargo3ft`</span> looks like. Great.</span>
<span id="cb106-1187"><a href="#cb106-1187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1188"><a href="#cb106-1188" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-cargo3ft-combined-posterior, out.width="80%"}</span></span>
<span id="cb106-1189"><a href="#cb106-1189" aria-hidden="true" tabindex="-1"></a><span class="in">minivans_cat_marginalized %&gt;% </span></span>
<span id="cb106-1190"><a href="#cb106-1190" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(.variable == "cargo3ft") %&gt;% </span></span>
<span id="cb106-1191"><a href="#cb106-1191" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = .value, y = .variable)) +</span></span>
<span id="cb106-1192"><a href="#cb106-1192" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye(fill = clrs[4]) +</span></span>
<span id="cb106-1193"><a href="#cb106-1193" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Posterior distribution of β (logit-scale)", y = NULL)</span></span>
<span id="cb106-1194"><a href="#cb106-1194" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1195"><a href="#cb106-1195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1196"><a href="#cb106-1196" aria-hidden="true" tabindex="-1"></a><span class="fu">## Predictions</span></span>
<span id="cb106-1197"><a href="#cb106-1197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1198"><a href="#cb106-1198" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">As we saw in the first example with chocolates</span><span class="co">](#predictions)</span>, the marketing world typically uses predictions from these kinds of models to estimate the predicted market share for products with different constellations of features. That was a pretty straightforward task with the chocolate model since respondents were shown all 8 options simultaneously. It's a lot trickier with the minivan example where respondents were shown 15 sets of 3 options. Dealing with multinomial predictions is a bear of a task because these models are a lot more complex. </span>
<span id="cb106-1199"><a href="#cb106-1199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1200"><a href="#cb106-1200" aria-hidden="true" tabindex="-1"></a><span class="fu">### Frequentist predictions</span></span>
<span id="cb106-1201"><a href="#cb106-1201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1202"><a href="#cb106-1202" aria-hidden="true" tabindex="-1"></a>With the chocolate model, we could use <span class="in">`predict(model_chocolate_mlogit)`</span> and automatically get predictions for all 8 options. That's not the case here:</span>
<span id="cb106-1203"><a href="#cb106-1203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1204"><a href="#cb106-1204" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-mlogit-predictions-wrong}</span></span>
<span id="cb106-1205"><a href="#cb106-1205" aria-hidden="true" tabindex="-1"></a><span class="in">predict(model_minivans_mlogit)</span></span>
<span id="cb106-1206"><a href="#cb106-1206" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1207"><a href="#cb106-1207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1208"><a href="#cb106-1208" aria-hidden="true" tabindex="-1"></a>We get three predictions, and they're all 33ish%. That's because respondents were presented with three randomly shuffled options and chose one of them. All these predictions tell us is that across all 15 iterations of the questions, 1/3 of respondents selected the first option, 1/3 the second, and 1/3 the third. That's a good sign in this case—there's no evidence that people were just repeatedly choosing the first option. But in the end, these predictions aren't super useful.</span>
<span id="cb106-1209"><a href="#cb106-1209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1210"><a href="#cb106-1210" aria-hidden="true" tabindex="-1"></a>We instead want to be able to get predicted market shares (or predicted probabilities) for any given mix of products. For instance, here are six arbitrary hypothetical products with different combinations of seats, cargo space, engines, and prices:</span>
<span id="cb106-1211"><a href="#cb106-1211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1212"><a href="#cb106-1212" aria-hidden="true" tabindex="-1"></a><span class="in">```{r create-example-product-mix}</span></span>
<span id="cb106-1213"><a href="#cb106-1213" aria-hidden="true" tabindex="-1"></a><span class="in">example_product_mix &lt;- tribble(</span></span>
<span id="cb106-1214"><a href="#cb106-1214" aria-hidden="true" tabindex="-1"></a><span class="in">  ~seat, ~cargo, ~eng, ~price,</span></span>
<span id="cb106-1215"><a href="#cb106-1215" aria-hidden="true" tabindex="-1"></a><span class="in">  "7", "2ft", "hyb", "30",</span></span>
<span id="cb106-1216"><a href="#cb106-1216" aria-hidden="true" tabindex="-1"></a><span class="in">  "6", "2ft", "gas", "30",</span></span>
<span id="cb106-1217"><a href="#cb106-1217" aria-hidden="true" tabindex="-1"></a><span class="in">  "8", "2ft", "gas", "30",</span></span>
<span id="cb106-1218"><a href="#cb106-1218" aria-hidden="true" tabindex="-1"></a><span class="in">  "7", "3ft", "gas", "40",</span></span>
<span id="cb106-1219"><a href="#cb106-1219" aria-hidden="true" tabindex="-1"></a><span class="in">  "6", "2ft", "elec", "40",</span></span>
<span id="cb106-1220"><a href="#cb106-1220" aria-hidden="true" tabindex="-1"></a><span class="in">  "7", "2ft", "hyb", "35"</span></span>
<span id="cb106-1221"><a href="#cb106-1221" aria-hidden="true" tabindex="-1"></a><span class="in">) %&gt;% </span></span>
<span id="cb106-1222"><a href="#cb106-1222" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(across(everything(), factor)) %&gt;% </span></span>
<span id="cb106-1223"><a href="#cb106-1223" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(eng = factor(eng, levels = levels(minivans$eng)))</span></span>
<span id="cb106-1224"><a href="#cb106-1224" aria-hidden="true" tabindex="-1"></a><span class="in">example_product_mix</span></span>
<span id="cb106-1225"><a href="#cb106-1225" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1226"><a href="#cb106-1226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1227"><a href="#cb106-1227" aria-hidden="true" tabindex="-1"></a>If we were working with any other type of model, we could plug this data into the <span class="in">`newdata`</span> argument of <span class="in">`predict()`</span> and get predicted values. That doesn't work here though. We get predicted values, but these don't correspond to each row of the <span class="in">`newdata`</span> dataset—instead, each row sums to 100%, showing the probability of choosing column 1, 2 or 3 in the original survey, which isn't really all that helpful here. </span>
<span id="cb106-1228"><a href="#cb106-1228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1229"><a href="#cb106-1229" aria-hidden="true" tabindex="-1"></a><span class="in">```{r preds-minivan-mlogit-wrong}</span></span>
<span id="cb106-1230"><a href="#cb106-1230" aria-hidden="true" tabindex="-1"></a><span class="in">preds_wrong &lt;- predict(model_minivans_mlogit, newdata = example_product_mix)</span></span>
<span id="cb106-1231"><a href="#cb106-1231" aria-hidden="true" tabindex="-1"></a><span class="in">preds_wrong</span></span>
<span id="cb106-1232"><a href="#cb106-1232" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1233"><a href="#cb106-1233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1234"><a href="#cb106-1234" aria-hidden="true" tabindex="-1"></a>Further complicating things, it only returns two rows because it assumes that these six hypothetical product offerings were two different choice sets, or that rows 1–3 were shown together to the respondent, followed by rows 4–6. But that's not the case, and we're not interested in that.</span>
<span id="cb106-1235"><a href="#cb106-1235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1236"><a href="#cb106-1236" aria-hidden="true" tabindex="-1"></a><span class="in">```{r preds-minivan-wrong-long}</span></span>
<span id="cb106-1237"><a href="#cb106-1237" aria-hidden="true" tabindex="-1"></a><span class="in"># Rearrange the predictions to be based on choice sets</span></span>
<span id="cb106-1238"><a href="#cb106-1238" aria-hidden="true" tabindex="-1"></a><span class="in">preds_wrong_df &lt;- as.data.frame(preds_wrong) %&gt;%</span></span>
<span id="cb106-1239"><a href="#cb106-1239" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(choice_set = row_number()) %&gt;%</span></span>
<span id="cb106-1240"><a href="#cb106-1240" aria-hidden="true" tabindex="-1"></a><span class="in">  pivot_longer(cols = -choice_set, names_to = "alternative", values_to = "probability") %&gt;% </span></span>
<span id="cb106-1241"><a href="#cb106-1241" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(alternative = as.integer(alternative))</span></span>
<span id="cb106-1242"><a href="#cb106-1242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1243"><a href="#cb106-1243" aria-hidden="true" tabindex="-1"></a><span class="in"># The probabilities within each fake choice set add to 100%</span></span>
<span id="cb106-1244"><a href="#cb106-1244" aria-hidden="true" tabindex="-1"></a><span class="in">example_product_mix %&gt;%</span></span>
<span id="cb106-1245"><a href="#cb106-1245" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(choice_set = rep(1:2, each = 3), alternative = rep(1:3, 2)) %&gt;%</span></span>
<span id="cb106-1246"><a href="#cb106-1246" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(preds_wrong_df, by = c("choice_set", "alternative"))</span></span>
<span id="cb106-1247"><a href="#cb106-1247" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1248"><a href="#cb106-1248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1249"><a href="#cb106-1249" aria-hidden="true" tabindex="-1"></a>Instead, following @ChapmanFeit:2019 (and <span class="co">[</span><span class="ot">this Stan forum post</span><span class="co">](https://discourse.mc-stan.org/t/getting-predictions-for-multinomial-model-using-brms/22335)</span>), we can manually multiply the covariates in <span class="in">`example_product_mix`</span> with the model coefficients to calculate "utility" (or predicted vales on the logit scale), which we can then exponentiate and divide to calculate market shares.</span>
<span id="cb106-1250"><a href="#cb106-1250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1251"><a href="#cb106-1251" aria-hidden="true" tabindex="-1"></a><span class="in">```{r generate-manual-predictions}</span></span>
<span id="cb106-1252"><a href="#cb106-1252" aria-hidden="true" tabindex="-1"></a><span class="in"># Create a matrix of 0s and 1s for the values in `example_product_mix`, omitting</span></span>
<span id="cb106-1253"><a href="#cb106-1253" aria-hidden="true" tabindex="-1"></a><span class="in"># the first column (seat6)</span></span>
<span id="cb106-1254"><a href="#cb106-1254" aria-hidden="true" tabindex="-1"></a><span class="in">example_product_dummy_encoded &lt;- model.matrix(</span></span>
<span id="cb106-1255"><a href="#cb106-1255" aria-hidden="true" tabindex="-1"></a><span class="in">  update(model_minivans_mlogit$formula, 0 ~ .),</span></span>
<span id="cb106-1256"><a href="#cb106-1256" aria-hidden="true" tabindex="-1"></a><span class="in">  data = example_product_mix</span></span>
<span id="cb106-1257"><a href="#cb106-1257" aria-hidden="true" tabindex="-1"></a><span class="in">)[, -1]</span></span>
<span id="cb106-1258"><a href="#cb106-1258" aria-hidden="true" tabindex="-1"></a><span class="in">example_product_dummy_encoded</span></span>
<span id="cb106-1259"><a href="#cb106-1259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1260"><a href="#cb106-1260" aria-hidden="true" tabindex="-1"></a><span class="in"># Matrix multiply the matrix of 0s and 1s with the model coefficients to get</span></span>
<span id="cb106-1261"><a href="#cb106-1261" aria-hidden="true" tabindex="-1"></a><span class="in"># logit-scale predictions, or utility</span></span>
<span id="cb106-1262"><a href="#cb106-1262" aria-hidden="true" tabindex="-1"></a><span class="in">utility &lt;- example_product_dummy_encoded %*% coef(model_minivans_mlogit)</span></span>
<span id="cb106-1263"><a href="#cb106-1263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1264"><a href="#cb106-1264" aria-hidden="true" tabindex="-1"></a><span class="in"># Divide each exponentiated utility by the sum of the exponentiated utilities to</span></span>
<span id="cb106-1265"><a href="#cb106-1265" aria-hidden="true" tabindex="-1"></a><span class="in"># get the market share</span></span>
<span id="cb106-1266"><a href="#cb106-1266" aria-hidden="true" tabindex="-1"></a><span class="in">share &lt;- exp(utility) / sum(exp(utility))</span></span>
<span id="cb106-1267"><a href="#cb106-1267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1268"><a href="#cb106-1268" aria-hidden="true" tabindex="-1"></a><span class="in"># Stick all of these in one final dataset</span></span>
<span id="cb106-1269"><a href="#cb106-1269" aria-hidden="true" tabindex="-1"></a><span class="in">bind_cols(share = share, logits = utility, example_product_mix)</span></span>
<span id="cb106-1270"><a href="#cb106-1270" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1271"><a href="#cb106-1271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1272"><a href="#cb106-1272" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip collapse="true"}</span>
<span id="cb106-1273"><a href="#cb106-1273" aria-hidden="true" tabindex="-1"></a><span class="fu">### Function version of this kind of prediction</span></span>
<span id="cb106-1274"><a href="#cb106-1274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1275"><a href="#cb106-1275" aria-hidden="true" tabindex="-1"></a>On p. 375 of @ChapmanFeit:2019 (and at <span class="co">[</span><span class="ot">this Stan forum post</span><span class="co">](https://discourse.mc-stan.org/t/getting-predictions-for-multinomial-model-using-brms/22335/)</span>), there's a function called <span class="in">`predict.mnl()`</span> that does this utility and share calculation automatically. Because this post is more didactic and because I'm more interested in the Bayesian approach, I didn't use it earlier, but it works just the same.</span>
<span id="cb106-1276"><a href="#cb106-1276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1277"><a href="#cb106-1277" aria-hidden="true" tabindex="-1"></a><span class="in">```{r predict-mnl-example}</span></span>
<span id="cb106-1278"><a href="#cb106-1278" aria-hidden="true" tabindex="-1"></a><span class="in">predict.mnl &lt;- function(model, data) {</span></span>
<span id="cb106-1279"><a href="#cb106-1279" aria-hidden="true" tabindex="-1"></a><span class="in">  # Function for predicting shares from a multinomial logit model </span></span>
<span id="cb106-1280"><a href="#cb106-1280" aria-hidden="true" tabindex="-1"></a><span class="in">  # model: mlogit object returned by mlogit()</span></span>
<span id="cb106-1281"><a href="#cb106-1281" aria-hidden="true" tabindex="-1"></a><span class="in">  # data: a data frame containing the set of designs for which you want to </span></span>
<span id="cb106-1282"><a href="#cb106-1282" aria-hidden="true" tabindex="-1"></a><span class="in">  #       predict shares. Same format at the data used to estimate model. </span></span>
<span id="cb106-1283"><a href="#cb106-1283" aria-hidden="true" tabindex="-1"></a><span class="in">  data.model &lt;- model.matrix(update(model$formula, 0 ~ .), data = data)[ , -1]</span></span>
<span id="cb106-1284"><a href="#cb106-1284" aria-hidden="true" tabindex="-1"></a><span class="in">  utility &lt;- data.model %*% model$coef</span></span>
<span id="cb106-1285"><a href="#cb106-1285" aria-hidden="true" tabindex="-1"></a><span class="in">  share &lt;- exp(utility) / sum(exp(utility))</span></span>
<span id="cb106-1286"><a href="#cb106-1286" aria-hidden="true" tabindex="-1"></a><span class="in">  cbind(share, data)</span></span>
<span id="cb106-1287"><a href="#cb106-1287" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb106-1288"><a href="#cb106-1288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1289"><a href="#cb106-1289" aria-hidden="true" tabindex="-1"></a><span class="in">predict.mnl(model_minivans_mlogit, example_product_mix)</span></span>
<span id="cb106-1290"><a href="#cb106-1290" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1291"><a href="#cb106-1291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1292"><a href="#cb106-1292" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb106-1293"><a href="#cb106-1293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1294"><a href="#cb106-1294" aria-hidden="true" tabindex="-1"></a>This new predicted <span class="in">`share`</span> column sums to one, and it shows us the predicted market share assuming these are the only six products available. The \$30,000 six-seater 2ft gas van and the \$30,000 eight-seater 2ft gas van would comprise more than 75% (0.43337 + 0.31918) of a market consisting of these six products.</span>
<span id="cb106-1295"><a href="#cb106-1295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1296"><a href="#cb106-1296" aria-hidden="true" tabindex="-1"></a><span class="fu">### Bayesian predictions</span></span>
<span id="cb106-1297"><a href="#cb106-1297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1298"><a href="#cb106-1298" aria-hidden="true" tabindex="-1"></a>If we use the categorical multinomial {brms} model we run into the same issue of getting weird predictions. Using <span class="in">`marginaleffects::avg_predictions()`</span>, we see that that 2/3rds of predictions are 0, which makes sense—if a respondent is offered 10 iterations of 3 possible choices, that would be 30 total choices, but they can only choose one option per iteration, so 20 choices (or 20/30 or 2/3) wouldn't be selected. The other three groups are each 11%, since that's the remaining 33% divided evenly across three options. Neat, I guess, but still not super helpful.</span>
<span id="cb106-1299"><a href="#cb106-1299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1300"><a href="#cb106-1300" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-brms-categorical-predictions-wrong, cache=TRUE}</span></span>
<span id="cb106-1301"><a href="#cb106-1301" aria-hidden="true" tabindex="-1"></a><span class="in">avg_predictions(model_minivans_categorical_brms)</span></span>
<span id="cb106-1302"><a href="#cb106-1302" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1303"><a href="#cb106-1303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1304"><a href="#cb106-1304" aria-hidden="true" tabindex="-1"></a>Instead of going through the manual process of matrix-multiplying a dataset of some mix of products with a single set of coefficients, we can use <span class="in">`predictions(..., type = "link")`</span> to get predicted values on the log-odds scale, or that utility value that we found before. </span>
<span id="cb106-1305"><a href="#cb106-1305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1306"><a href="#cb106-1306" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb106-1307"><a href="#cb106-1307" aria-hidden="true" tabindex="-1"></a><span class="fu">### `marginaleffects::predictions()` vs. {tidybayes} functions</span></span>
<span id="cb106-1308"><a href="#cb106-1308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1309"><a href="#cb106-1309" aria-hidden="true" tabindex="-1"></a>We can actually use either <span class="in">`marginaleffects::predictions()`</span> or {tidybayes}'s <span class="in">`*_draw()`</span> functions for these posterior predictions. They do the same thing, with slightly different syntax:</span>
<span id="cb106-1310"><a href="#cb106-1310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1311"><a href="#cb106-1311" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mfx-preds-vs-linpred, eval=FALSE}</span></span>
<span id="cb106-1312"><a href="#cb106-1312" aria-hidden="true" tabindex="-1"></a><span class="in"># Logit-scale predictions with marginaleffects::predictions()</span></span>
<span id="cb106-1313"><a href="#cb106-1313" aria-hidden="true" tabindex="-1"></a><span class="in">model_minivans_categorical_brms %&gt;% </span></span>
<span id="cb106-1314"><a href="#cb106-1314" aria-hidden="true" tabindex="-1"></a><span class="in">  predictions(newdata = example_product_mix, re_formula = NA, type = "link") %&gt;% </span></span>
<span id="cb106-1315"><a href="#cb106-1315" aria-hidden="true" tabindex="-1"></a><span class="in">  posterior_draws()</span></span>
<span id="cb106-1316"><a href="#cb106-1316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1317"><a href="#cb106-1317" aria-hidden="true" tabindex="-1"></a><span class="in"># Logit-scale predictions with tidybayes::add_linpred_draws()</span></span>
<span id="cb106-1318"><a href="#cb106-1318" aria-hidden="true" tabindex="-1"></a><span class="in">model_minivans_categorical_brms %&gt;% </span></span>
<span id="cb106-1319"><a href="#cb106-1319" aria-hidden="true" tabindex="-1"></a><span class="in">  add_linpred_draws(newdata = example_product_mix, re_formula = NA)</span></span>
<span id="cb106-1320"><a href="#cb106-1320" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1321"><a href="#cb106-1321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1322"><a href="#cb106-1322" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">Earlier in the chocolate example</span><span class="co">](#bayesian-predictions)</span>, I used <span class="in">`marginaleffects::predictions()`</span> with the Bayesian {brms} model. Here I'm going to switch to the {tidybayes} prediction functions instead, in part because these multinomial models with the <span class="in">`categorical()`</span> family are a lot more complex (though {marginaleffects} can handle them nicely), but mostly because in the actual paper I'm working on with real conjoint data, our MCMC results were generated with raw Stan code through <span class="in">`rstan`</span>, and {marginaleffects} doesn't support raw Stan models.</span>
<span id="cb106-1323"><a href="#cb106-1323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1324"><a href="#cb106-1324" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">Check out this guide</span><span class="co">](https://www.andrewheiss.com/blog/2022/09/26/guide-visualizing-types-posteriors/)</span> for the differences between {tidybayes}'s three general prediction functions: <span class="in">`predicted_draws()`</span>, <span class="in">`epred_draws()`</span>, and <span class="in">`linpred_draws()`</span>.</span>
<span id="cb106-1325"><a href="#cb106-1325" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb106-1326"><a href="#cb106-1326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1327"><a href="#cb106-1327" aria-hidden="true" tabindex="-1"></a>Additionally, we now actually have 4,000 draws in 3 categories (option 1, option 2, and option 3), so we actually have 12,000 sets of coefficients (!). To take advantage of the full posterior distribution of these coefficients, we can calculate shares within each set of draws within each of the three categories, resulting in a distribution of shares rather than single values.</span>
<span id="cb106-1328"><a href="#cb106-1328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1329"><a href="#cb106-1329" aria-hidden="true" tabindex="-1"></a><span class="in">```{r generate-product-mix-shares-brms}</span></span>
<span id="cb106-1330"><a href="#cb106-1330" aria-hidden="true" tabindex="-1"></a><span class="in">draws_df &lt;- example_product_mix %&gt;% </span></span>
<span id="cb106-1331"><a href="#cb106-1331" aria-hidden="true" tabindex="-1"></a><span class="in">  add_linpred_draws(model_minivans_categorical_brms, value = "utility", re_formula = NA)</span></span>
<span id="cb106-1332"><a href="#cb106-1332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1333"><a href="#cb106-1333" aria-hidden="true" tabindex="-1"></a><span class="in">shares_df &lt;- draws_df %&gt;% </span></span>
<span id="cb106-1334"><a href="#cb106-1334" aria-hidden="true" tabindex="-1"></a><span class="in">  # Look at each set of predicted utilities within each draw within each of the</span></span>
<span id="cb106-1335"><a href="#cb106-1335" aria-hidden="true" tabindex="-1"></a><span class="in">  # three outcomes</span></span>
<span id="cb106-1336"><a href="#cb106-1336" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(.draw, .category) %&gt;% </span></span>
<span id="cb106-1337"><a href="#cb106-1337" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(share = exp(utility) / sum(exp(utility))) %&gt;% </span></span>
<span id="cb106-1338"><a href="#cb106-1338" aria-hidden="true" tabindex="-1"></a><span class="in">  ungroup() %&gt;% </span></span>
<span id="cb106-1339"><a href="#cb106-1339" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb106-1340"><a href="#cb106-1340" aria-hidden="true" tabindex="-1"></a><span class="in">    mix_type = paste(seat, cargo, eng, price, sep = " "),</span></span>
<span id="cb106-1341"><a href="#cb106-1341" aria-hidden="true" tabindex="-1"></a><span class="in">    mix_type = fct_reorder(mix_type, share)</span></span>
<span id="cb106-1342"><a href="#cb106-1342" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb106-1343"><a href="#cb106-1343" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1344"><a href="#cb106-1344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1345"><a href="#cb106-1345" aria-hidden="true" tabindex="-1"></a>We can summarize this huge dataset of posterior shares to get medians and credible intervals, but we need to do one extra step first. Right now, we have three predictions for each mix type, one for each of the categories (i.e. option 1, option 2, and option 3.</span>
<span id="cb106-1346"><a href="#cb106-1346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1347"><a href="#cb106-1347" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-shares-brms-categorical-by-category}</span></span>
<span id="cb106-1348"><a href="#cb106-1348" aria-hidden="true" tabindex="-1"></a><span class="in">shares_df %&gt;% </span></span>
<span id="cb106-1349"><a href="#cb106-1349" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(mix_type, .category) %&gt;% </span></span>
<span id="cb106-1350"><a href="#cb106-1350" aria-hidden="true" tabindex="-1"></a><span class="in">  median_qi(share)</span></span>
<span id="cb106-1351"><a href="#cb106-1351" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1352"><a href="#cb106-1352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1353"><a href="#cb106-1353" aria-hidden="true" tabindex="-1"></a>Since those options were all randomized, we can lump them all together as a single choice. To do this we'll take the average share across the three categories (this is also called "marginalizing") within each posterior draw.</span>
<span id="cb106-1354"><a href="#cb106-1354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1355"><a href="#cb106-1355" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-shares-brms-categorical-marginalized}</span></span>
<span id="cb106-1356"><a href="#cb106-1356" aria-hidden="true" tabindex="-1"></a><span class="in">shares_marginalized &lt;- shares_df %&gt;% </span></span>
<span id="cb106-1357"><a href="#cb106-1357" aria-hidden="true" tabindex="-1"></a><span class="in">  # Marginalize across categories within each draw</span></span>
<span id="cb106-1358"><a href="#cb106-1358" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(mix_type, .draw) %&gt;% </span></span>
<span id="cb106-1359"><a href="#cb106-1359" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(share = mean(share)) %&gt;% </span></span>
<span id="cb106-1360"><a href="#cb106-1360" aria-hidden="true" tabindex="-1"></a><span class="in">  ungroup()</span></span>
<span id="cb106-1361"><a href="#cb106-1361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1362"><a href="#cb106-1362" aria-hidden="true" tabindex="-1"></a><span class="in">shares_marginalized %&gt;% </span></span>
<span id="cb106-1363"><a href="#cb106-1363" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(mix_type) %&gt;% </span></span>
<span id="cb106-1364"><a href="#cb106-1364" aria-hidden="true" tabindex="-1"></a><span class="in">  median_qi(share)</span></span>
<span id="cb106-1365"><a href="#cb106-1365" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1366"><a href="#cb106-1366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1367"><a href="#cb106-1367" aria-hidden="true" tabindex="-1"></a>And we can plot them:</span>
<span id="cb106-1368"><a href="#cb106-1368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1369"><a href="#cb106-1369" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-shares-brms-categorical}</span></span>
<span id="cb106-1370"><a href="#cb106-1370" aria-hidden="true" tabindex="-1"></a><span class="in">shares_marginalized %&gt;% </span></span>
<span id="cb106-1371"><a href="#cb106-1371" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = share, y = mix_type)) +</span></span>
<span id="cb106-1372"><a href="#cb106-1372" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye(fill = clrs[10], normalize = "xy") +</span></span>
<span id="cb106-1373"><a href="#cb106-1373" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_percent()) +</span></span>
<span id="cb106-1374"><a href="#cb106-1374" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Predicted market share", y = "Hypothetical product mix")</span></span>
<span id="cb106-1375"><a href="#cb106-1375" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1376"><a href="#cb106-1376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1377"><a href="#cb106-1377" aria-hidden="true" tabindex="-1"></a>This is great because (1) it includes the uncertainty in the estimated shares, and (2) it lets us do neat Bayesian inference and say things like "there's a 93% chance that in this market of 6 options, a \$30,000 6-passenger gas minivan with 2 feet of storage would reach at least 40% market share":</span>
<span id="cb106-1378"><a href="#cb106-1378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1379"><a href="#cb106-1379" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-shares-pd-example, out.width="80%"}</span></span>
<span id="cb106-1380"><a href="#cb106-1380" aria-hidden="true" tabindex="-1"></a><span class="in">shares_marginalized %&gt;% </span></span>
<span id="cb106-1381"><a href="#cb106-1381" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(mix_type == "6 2ft gas 30") %&gt;% </span></span>
<span id="cb106-1382"><a href="#cb106-1382" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(prop_greater_40 = sum(share &gt;= 0.4) / n())</span></span>
<span id="cb106-1383"><a href="#cb106-1383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1384"><a href="#cb106-1384" aria-hidden="true" tabindex="-1"></a><span class="in">shares_marginalized %&gt;% </span></span>
<span id="cb106-1385"><a href="#cb106-1385" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(mix_type == "6 2ft gas 30") %&gt;% </span></span>
<span id="cb106-1386"><a href="#cb106-1386" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = share, y = mix_type)) +</span></span>
<span id="cb106-1387"><a href="#cb106-1387" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye(aes(fill_ramp = after_stat(x &gt;= 0.4)), fill = clrs[10]) +</span></span>
<span id="cb106-1388"><a href="#cb106-1388" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0.4) +</span></span>
<span id="cb106-1389"><a href="#cb106-1389" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_percent()) +</span></span>
<span id="cb106-1390"><a href="#cb106-1390" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_ramp_discrete(from = colorspace::lighten(clrs[10], 0.4), guide = "none") +</span></span>
<span id="cb106-1391"><a href="#cb106-1391" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Predicted market share", y = NULL)</span></span>
<span id="cb106-1392"><a href="#cb106-1392" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1393"><a href="#cb106-1393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1394"><a href="#cb106-1394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1395"><a href="#cb106-1395" aria-hidden="true" tabindex="-1"></a><span class="fu">## AMCEs</span></span>
<span id="cb106-1396"><a href="#cb106-1396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1397"><a href="#cb106-1397" aria-hidden="true" tabindex="-1"></a>As explained in the <span class="co">[</span><span class="ot">AMCEs section for the chocolate data</span><span class="co">](#amces)</span>, in the social sciences we're less concerned about predicted market shares and more concerned about causal effects. Holding all other features constant, what is the effect of a \$5,000 increase in price or moving from 2 feet → 3 feet of storage space on the probability (or favorability) of selecting a minivan?</span>
<span id="cb106-1398"><a href="#cb106-1398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1399"><a href="#cb106-1399" aria-hidden="true" tabindex="-1"></a>In the chocolate example, we were able to use <span class="in">`marginaleffects::avg_comparisons()`</span> with the Bayesian model and get categorical contrasts automatically. This was because we cheated and used a Poisson model, since those can secretly behave like multinomial models. For the frequentist {mlogit}-based model, we had to use base R's <span class="in">`predict()`</span> instead and then collapse the predictions into the different contrasts we were interested in using <span class="in">`group_by() %&gt;% summarize()`</span>. We need to do the same thing here.</span>
<span id="cb106-1400"><a href="#cb106-1400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1401"><a href="#cb106-1401" aria-hidden="true" tabindex="-1"></a><span class="fu">### Frequentist comparisons/contrasts</span></span>
<span id="cb106-1402"><a href="#cb106-1402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1403"><a href="#cb106-1403" aria-hidden="true" tabindex="-1"></a>To help with the intuition behind this, since it's more complex this time, we'll create a data frame to show all the combinations of all the feature levels (3 seats × 2 cargos × 3 engines × 3 prices). There are 54 possible combinations:</span>
<span id="cb106-1404"><a href="#cb106-1404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1405"><a href="#cb106-1405" aria-hidden="true" tabindex="-1"></a><span class="in">```{r create-mlogit-minivans}</span></span>
<span id="cb106-1406"><a href="#cb106-1406" aria-hidden="true" tabindex="-1"></a><span class="in">van_all_combos &lt;- minivans %&gt;% </span></span>
<span id="cb106-1407"><a href="#cb106-1407" aria-hidden="true" tabindex="-1"></a><span class="in">  tidyr::expand(seat, cargo, eng, price)</span></span>
<span id="cb106-1408"><a href="#cb106-1408" aria-hidden="true" tabindex="-1"></a><span class="in">van_all_combos</span></span>
<span id="cb106-1409"><a href="#cb106-1409" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1410"><a href="#cb106-1410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1411"><a href="#cb106-1411" aria-hidden="true" tabindex="-1"></a>We want to calculate the probabilities for each of these combinations, regardless of whether the hypothetical minivan appeared as the first, second, or third option in the survey experiment.</span>
<span id="cb106-1412"><a href="#cb106-1412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1413"><a href="#cb106-1413" aria-hidden="true" tabindex="-1"></a>Fortunately, {mlogit} already did most of the work for us! One of the slots in the <span class="in">`model_minivans_mlogit`</span> object is named <span class="in">`$probabilities`</span>, which contains the a matrix of predicted probabilities for each of the 3,000 choice sets (200 respondents × 15 sets of questions)</span>
<span id="cb106-1414"><a href="#cb106-1414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1415"><a href="#cb106-1415" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-minivan-mlogit-probs}</span></span>
<span id="cb106-1416"><a href="#cb106-1416" aria-hidden="true" tabindex="-1"></a><span class="in"># Number of choice sets</span></span>
<span id="cb106-1417"><a href="#cb106-1417" aria-hidden="true" tabindex="-1"></a><span class="in">nrow(model_minivans_mlogit$probabilities)</span></span>
<span id="cb106-1418"><a href="#cb106-1418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1419"><a href="#cb106-1419" aria-hidden="true" tabindex="-1"></a><span class="in"># Probability of selecting each alternative within each choice set</span></span>
<span id="cb106-1420"><a href="#cb106-1420" aria-hidden="true" tabindex="-1"></a><span class="in">head(model_minivans_mlogit$probabilities)</span></span>
<span id="cb106-1421"><a href="#cb106-1421" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1422"><a href="#cb106-1422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1423"><a href="#cb106-1423" aria-hidden="true" tabindex="-1"></a>Working with data like this, though, is messy and untidy. Fortunately again, if we use <span class="in">`model.frame()`</span>, {mlogit} will return a long data frame with probabilities for each of the alternatives within each of the choice sets, or 9,000 rows (200 respondents × 15 sets of questions × 3 options within each question). This is the original data we used for the model, only now with columns for the fitted values on the logit scale (the <span class="in">`linpred`</span> column) and the probability scale (the <span class="in">`probabilities`</span> column).</span>
<span id="cb106-1424"><a href="#cb106-1424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1425"><a href="#cb106-1425" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-minivan-mlogit-modelframe}</span></span>
<span id="cb106-1426"><a href="#cb106-1426" aria-hidden="true" tabindex="-1"></a><span class="in">model.frame(model_minivans_mlogit)</span></span>
<span id="cb106-1427"><a href="#cb106-1427" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1428"><a href="#cb106-1428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1429"><a href="#cb106-1429" aria-hidden="true" tabindex="-1"></a>That's neat, but it's still a lot of data. Remember <span class="in">`van_all_combos`</span> from earlier, with the 54 unique combinations of seat, cargo, engine, and price? We want to know the probabilities for each of those combinations.</span>
<span id="cb106-1430"><a href="#cb106-1430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1431"><a href="#cb106-1431" aria-hidden="true" tabindex="-1"></a>We can find those with some grouping and summarizing, finding the average probability within each of the combinations:</span>
<span id="cb106-1432"><a href="#cb106-1432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1433"><a href="#cb106-1433" aria-hidden="true" tabindex="-1"></a><span class="in">```{r create-all-preds-multinomial}</span></span>
<span id="cb106-1434"><a href="#cb106-1434" aria-hidden="true" tabindex="-1"></a><span class="in">all_preds_mlogit &lt;- model.frame(model_minivans_mlogit) %&gt;% </span></span>
<span id="cb106-1435"><a href="#cb106-1435" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(seat, cargo, eng, price) %&gt;% </span></span>
<span id="cb106-1436"><a href="#cb106-1436" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(estimate = mean(probabilities))</span></span>
<span id="cb106-1437"><a href="#cb106-1437" aria-hidden="true" tabindex="-1"></a><span class="in">all_preds_mlogit</span></span>
<span id="cb106-1438"><a href="#cb106-1438" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1439"><a href="#cb106-1439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1440"><a href="#cb106-1440" aria-hidden="true" tabindex="-1"></a>Perfect. The option with 6 seats, 2 feet of cargo space, a gas engine, at \$30,000 had a 70% chance of being selected *regardless of whether it was presented as option 1, 2, or 3*.</span>
<span id="cb106-1441"><a href="#cb106-1441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1442"><a href="#cb106-1442" aria-hidden="true" tabindex="-1"></a>To find the AMCE of specific features, we can collapse and average even further. For instance, suppose we're interested in the AMCE of cargo space. We can first find the average predicted probability of selection with some grouping and summarizing, then calculate the difference between the two rows:</span>
<span id="cb106-1443"><a href="#cb106-1443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1444"><a href="#cb106-1444" aria-hidden="true" tabindex="-1"></a><span class="in">```{r manual-cargo-amce}</span></span>
<span id="cb106-1445"><a href="#cb106-1445" aria-hidden="true" tabindex="-1"></a><span class="in">manual_cargo_example &lt;- all_preds_mlogit %&gt;% </span></span>
<span id="cb106-1446"><a href="#cb106-1446" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(cargo) %&gt;% </span></span>
<span id="cb106-1447"><a href="#cb106-1447" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(avg_pred = mean(estimate))</span></span>
<span id="cb106-1448"><a href="#cb106-1448" aria-hidden="true" tabindex="-1"></a><span class="in">manual_cargo_example</span></span>
<span id="cb106-1449"><a href="#cb106-1449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1450"><a href="#cb106-1450" aria-hidden="true" tabindex="-1"></a><span class="in"># diff() way</span></span>
<span id="cb106-1451"><a href="#cb106-1451" aria-hidden="true" tabindex="-1"></a><span class="in">diff(manual_cargo_example$avg_pred)</span></span>
<span id="cb106-1452"><a href="#cb106-1452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1453"><a href="#cb106-1453" aria-hidden="true" tabindex="-1"></a><span class="in"># Tidyverse way</span></span>
<span id="cb106-1454"><a href="#cb106-1454" aria-hidden="true" tabindex="-1"></a><span class="in">manual_cargo_example %&gt;% </span></span>
<span id="cb106-1455"><a href="#cb106-1455" aria-hidden="true" tabindex="-1"></a><span class="in">  pivot_wider(names_from = cargo, values_from = avg_pred) %&gt;% </span></span>
<span id="cb106-1456"><a href="#cb106-1456" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb106-1457"><a href="#cb106-1457" aria-hidden="true" tabindex="-1"></a><span class="in">    term = "3ft - 2ft",</span></span>
<span id="cb106-1458"><a href="#cb106-1458" aria-hidden="true" tabindex="-1"></a><span class="in">    estimate = `3ft` - `2ft`</span></span>
<span id="cb106-1459"><a href="#cb106-1459" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;% </span></span>
<span id="cb106-1460"><a href="#cb106-1460" aria-hidden="true" tabindex="-1"></a><span class="in">  select(term, estimate)</span></span>
<span id="cb106-1461"><a href="#cb106-1461" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1462"><a href="#cb106-1462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1463"><a href="#cb106-1463" aria-hidden="true" tabindex="-1"></a>Holding all other features constant, the average probability (or average favorability, or average market share, or whatever we want to call it) of selecting a minivan with 2 feet of storage space is 0.292 (this is the average of the 27 predictions from <span class="in">`all_preds_mlogit`</span> where <span class="in">`cargo`</span> = <span class="in">`2ft`</span>); the average probability for a minivan with 3 feet of storage space is 0.375 (again, this is the average of the 27 predictions from <span class="in">`all_preds_mlogit`</span> where <span class="in">`cargo`</span> = <span class="in">`3ft`</span>). There's an 8.3 percentage point difference between these groups. **This is the causal effect or AMCE**: switching from 2 feet to 3 feet increases minivan favorability by 8 percentage points on average.</span>
<span id="cb106-1464"><a href="#cb106-1464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1465"><a href="#cb106-1465" aria-hidden="true" tabindex="-1"></a>We can make a big data frame with all the AMCEs we're interested in. I've hidden the code here because it's really repetitive.</span>
<span id="cb106-1466"><a href="#cb106-1466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1467"><a href="#cb106-1467" aria-hidden="true" tabindex="-1"></a><span class="in">```{r generate-all-minivan-amces-mlogit}</span></span>
<span id="cb106-1468"><a href="#cb106-1468" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb106-1469"><a href="#cb106-1469" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-summary: "Make separate datasets of predictions and combine them in one data frame"</span></span>
<span id="cb106-1470"><a href="#cb106-1470" aria-hidden="true" tabindex="-1"></a><span class="in">amce_minivan_seat_67_mlogit &lt;- all_preds_mlogit %&gt;% </span></span>
<span id="cb106-1471"><a href="#cb106-1471" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(seat) %&gt;% </span></span>
<span id="cb106-1472"><a href="#cb106-1472" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(avg_pred = mean(estimate)) %&gt;%</span></span>
<span id="cb106-1473"><a href="#cb106-1473" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(seat %in% c("6", "7")) %&gt;%</span></span>
<span id="cb106-1474"><a href="#cb106-1474" aria-hidden="true" tabindex="-1"></a><span class="in">  pivot_wider(names_from = seat, values_from = avg_pred) %&gt;% </span></span>
<span id="cb106-1475"><a href="#cb106-1475" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb106-1476"><a href="#cb106-1476" aria-hidden="true" tabindex="-1"></a><span class="in">    term = "7 - 6",</span></span>
<span id="cb106-1477"><a href="#cb106-1477" aria-hidden="true" tabindex="-1"></a><span class="in">    estimate = `7` - `6`,</span></span>
<span id="cb106-1478"><a href="#cb106-1478" aria-hidden="true" tabindex="-1"></a><span class="in">    variable = "seat"</span></span>
<span id="cb106-1479"><a href="#cb106-1479" aria-hidden="true" tabindex="-1"></a><span class="in">  )  %&gt;% </span></span>
<span id="cb106-1480"><a href="#cb106-1480" aria-hidden="true" tabindex="-1"></a><span class="in">  select(variable, term, estimate)</span></span>
<span id="cb106-1481"><a href="#cb106-1481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1482"><a href="#cb106-1482" aria-hidden="true" tabindex="-1"></a><span class="in">amce_minivan_seat_68_mlogit &lt;- all_preds_mlogit %&gt;% </span></span>
<span id="cb106-1483"><a href="#cb106-1483" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(seat) %&gt;% </span></span>
<span id="cb106-1484"><a href="#cb106-1484" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(avg_pred = mean(estimate)) %&gt;%</span></span>
<span id="cb106-1485"><a href="#cb106-1485" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(seat %in% c("6", "8")) %&gt;%</span></span>
<span id="cb106-1486"><a href="#cb106-1486" aria-hidden="true" tabindex="-1"></a><span class="in">  pivot_wider(names_from = seat, values_from = avg_pred) %&gt;% </span></span>
<span id="cb106-1487"><a href="#cb106-1487" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb106-1488"><a href="#cb106-1488" aria-hidden="true" tabindex="-1"></a><span class="in">    term = "8 - 6",</span></span>
<span id="cb106-1489"><a href="#cb106-1489" aria-hidden="true" tabindex="-1"></a><span class="in">    estimate = `8` - `6`,</span></span>
<span id="cb106-1490"><a href="#cb106-1490" aria-hidden="true" tabindex="-1"></a><span class="in">    variable = "seat"</span></span>
<span id="cb106-1491"><a href="#cb106-1491" aria-hidden="true" tabindex="-1"></a><span class="in">  )  %&gt;% </span></span>
<span id="cb106-1492"><a href="#cb106-1492" aria-hidden="true" tabindex="-1"></a><span class="in">  select(variable, term, estimate)</span></span>
<span id="cb106-1493"><a href="#cb106-1493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1494"><a href="#cb106-1494" aria-hidden="true" tabindex="-1"></a><span class="in">amce_minivan_cargo_mlogit &lt;- all_preds_mlogit %&gt;% </span></span>
<span id="cb106-1495"><a href="#cb106-1495" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(cargo) %&gt;% </span></span>
<span id="cb106-1496"><a href="#cb106-1496" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(avg_pred = mean(estimate)) %&gt;%</span></span>
<span id="cb106-1497"><a href="#cb106-1497" aria-hidden="true" tabindex="-1"></a><span class="in">  pivot_wider(names_from = cargo, values_from = avg_pred) %&gt;% </span></span>
<span id="cb106-1498"><a href="#cb106-1498" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb106-1499"><a href="#cb106-1499" aria-hidden="true" tabindex="-1"></a><span class="in">    term = "3ft - 2ft",</span></span>
<span id="cb106-1500"><a href="#cb106-1500" aria-hidden="true" tabindex="-1"></a><span class="in">    estimate = `3ft` - `2ft`,</span></span>
<span id="cb106-1501"><a href="#cb106-1501" aria-hidden="true" tabindex="-1"></a><span class="in">    variable = "cargo"</span></span>
<span id="cb106-1502"><a href="#cb106-1502" aria-hidden="true" tabindex="-1"></a><span class="in">  )  %&gt;% </span></span>
<span id="cb106-1503"><a href="#cb106-1503" aria-hidden="true" tabindex="-1"></a><span class="in">  select(variable, term, estimate)</span></span>
<span id="cb106-1504"><a href="#cb106-1504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1505"><a href="#cb106-1505" aria-hidden="true" tabindex="-1"></a><span class="in">amce_minivan_eng_gas_elec_mlogit &lt;- all_preds_mlogit %&gt;% </span></span>
<span id="cb106-1506"><a href="#cb106-1506" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(eng) %&gt;% </span></span>
<span id="cb106-1507"><a href="#cb106-1507" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(avg_pred = mean(estimate)) %&gt;%</span></span>
<span id="cb106-1508"><a href="#cb106-1508" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(eng %in% c("gas", "elec")) %&gt;%</span></span>
<span id="cb106-1509"><a href="#cb106-1509" aria-hidden="true" tabindex="-1"></a><span class="in">  pivot_wider(names_from = eng, values_from = avg_pred) %&gt;% </span></span>
<span id="cb106-1510"><a href="#cb106-1510" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb106-1511"><a href="#cb106-1511" aria-hidden="true" tabindex="-1"></a><span class="in">    term = "elec - gas",</span></span>
<span id="cb106-1512"><a href="#cb106-1512" aria-hidden="true" tabindex="-1"></a><span class="in">    estimate = elec - gas,</span></span>
<span id="cb106-1513"><a href="#cb106-1513" aria-hidden="true" tabindex="-1"></a><span class="in">    variable = "eng"</span></span>
<span id="cb106-1514"><a href="#cb106-1514" aria-hidden="true" tabindex="-1"></a><span class="in">  )  %&gt;% </span></span>
<span id="cb106-1515"><a href="#cb106-1515" aria-hidden="true" tabindex="-1"></a><span class="in">  select(variable, term, estimate)</span></span>
<span id="cb106-1516"><a href="#cb106-1516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1517"><a href="#cb106-1517" aria-hidden="true" tabindex="-1"></a><span class="in">amce_minivan_eng_gas_hyb_mlogit &lt;- all_preds_mlogit %&gt;% </span></span>
<span id="cb106-1518"><a href="#cb106-1518" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(eng) %&gt;% </span></span>
<span id="cb106-1519"><a href="#cb106-1519" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(avg_pred = mean(estimate)) %&gt;%</span></span>
<span id="cb106-1520"><a href="#cb106-1520" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(eng %in% c("gas", "hyb")) %&gt;%</span></span>
<span id="cb106-1521"><a href="#cb106-1521" aria-hidden="true" tabindex="-1"></a><span class="in">  pivot_wider(names_from = eng, values_from = avg_pred) %&gt;% </span></span>
<span id="cb106-1522"><a href="#cb106-1522" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb106-1523"><a href="#cb106-1523" aria-hidden="true" tabindex="-1"></a><span class="in">    term = "hyb - gas",</span></span>
<span id="cb106-1524"><a href="#cb106-1524" aria-hidden="true" tabindex="-1"></a><span class="in">    estimate = hyb - gas,</span></span>
<span id="cb106-1525"><a href="#cb106-1525" aria-hidden="true" tabindex="-1"></a><span class="in">    variable = "eng"</span></span>
<span id="cb106-1526"><a href="#cb106-1526" aria-hidden="true" tabindex="-1"></a><span class="in">  )  %&gt;% </span></span>
<span id="cb106-1527"><a href="#cb106-1527" aria-hidden="true" tabindex="-1"></a><span class="in">  select(variable, term, estimate)</span></span>
<span id="cb106-1528"><a href="#cb106-1528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1529"><a href="#cb106-1529" aria-hidden="true" tabindex="-1"></a><span class="in">amce_minivan_price_3035_mlogit &lt;- all_preds_mlogit %&gt;% </span></span>
<span id="cb106-1530"><a href="#cb106-1530" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(price) %&gt;% </span></span>
<span id="cb106-1531"><a href="#cb106-1531" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(avg_pred = mean(estimate)) %&gt;%</span></span>
<span id="cb106-1532"><a href="#cb106-1532" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(price %in% c("30", "35")) %&gt;%</span></span>
<span id="cb106-1533"><a href="#cb106-1533" aria-hidden="true" tabindex="-1"></a><span class="in">  pivot_wider(names_from = price, values_from = avg_pred) %&gt;% </span></span>
<span id="cb106-1534"><a href="#cb106-1534" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb106-1535"><a href="#cb106-1535" aria-hidden="true" tabindex="-1"></a><span class="in">    term = "35 - 30",</span></span>
<span id="cb106-1536"><a href="#cb106-1536" aria-hidden="true" tabindex="-1"></a><span class="in">    estimate = `35` - `30`,</span></span>
<span id="cb106-1537"><a href="#cb106-1537" aria-hidden="true" tabindex="-1"></a><span class="in">    variable = "price"</span></span>
<span id="cb106-1538"><a href="#cb106-1538" aria-hidden="true" tabindex="-1"></a><span class="in">  )  %&gt;% </span></span>
<span id="cb106-1539"><a href="#cb106-1539" aria-hidden="true" tabindex="-1"></a><span class="in">  select(variable, term, estimate)</span></span>
<span id="cb106-1540"><a href="#cb106-1540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1541"><a href="#cb106-1541" aria-hidden="true" tabindex="-1"></a><span class="in">amce_minivan_price_3040_mlogit &lt;- all_preds_mlogit %&gt;% </span></span>
<span id="cb106-1542"><a href="#cb106-1542" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(price) %&gt;% </span></span>
<span id="cb106-1543"><a href="#cb106-1543" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(avg_pred = mean(estimate)) %&gt;%</span></span>
<span id="cb106-1544"><a href="#cb106-1544" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(price %in% c("30", "40")) %&gt;%</span></span>
<span id="cb106-1545"><a href="#cb106-1545" aria-hidden="true" tabindex="-1"></a><span class="in">  pivot_wider(names_from = price, values_from = avg_pred) %&gt;% </span></span>
<span id="cb106-1546"><a href="#cb106-1546" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb106-1547"><a href="#cb106-1547" aria-hidden="true" tabindex="-1"></a><span class="in">    term = "40 - 30",</span></span>
<span id="cb106-1548"><a href="#cb106-1548" aria-hidden="true" tabindex="-1"></a><span class="in">    estimate = `40` - `30`,</span></span>
<span id="cb106-1549"><a href="#cb106-1549" aria-hidden="true" tabindex="-1"></a><span class="in">    variable = "price"</span></span>
<span id="cb106-1550"><a href="#cb106-1550" aria-hidden="true" tabindex="-1"></a><span class="in">  )  %&gt;% </span></span>
<span id="cb106-1551"><a href="#cb106-1551" aria-hidden="true" tabindex="-1"></a><span class="in">  select(variable, term, estimate)</span></span>
<span id="cb106-1552"><a href="#cb106-1552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1553"><a href="#cb106-1553" aria-hidden="true" tabindex="-1"></a><span class="in">amces_minivan_mlogit &lt;- bind_rows(</span></span>
<span id="cb106-1554"><a href="#cb106-1554" aria-hidden="true" tabindex="-1"></a><span class="in">  amce_minivan_seat_67_mlogit,</span></span>
<span id="cb106-1555"><a href="#cb106-1555" aria-hidden="true" tabindex="-1"></a><span class="in">  amce_minivan_seat_68_mlogit,</span></span>
<span id="cb106-1556"><a href="#cb106-1556" aria-hidden="true" tabindex="-1"></a><span class="in">  amce_minivan_cargo_mlogit,</span></span>
<span id="cb106-1557"><a href="#cb106-1557" aria-hidden="true" tabindex="-1"></a><span class="in">  amce_minivan_eng_gas_elec_mlogit,</span></span>
<span id="cb106-1558"><a href="#cb106-1558" aria-hidden="true" tabindex="-1"></a><span class="in">  amce_minivan_eng_gas_hyb_mlogit,</span></span>
<span id="cb106-1559"><a href="#cb106-1559" aria-hidden="true" tabindex="-1"></a><span class="in">  amce_minivan_price_3035_mlogit,</span></span>
<span id="cb106-1560"><a href="#cb106-1560" aria-hidden="true" tabindex="-1"></a><span class="in">  amce_minivan_price_3040_mlogit</span></span>
<span id="cb106-1561"><a href="#cb106-1561" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb106-1562"><a href="#cb106-1562" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1563"><a href="#cb106-1563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1564"><a href="#cb106-1564" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-all-minivan-amces-mlogit}</span></span>
<span id="cb106-1565"><a href="#cb106-1565" aria-hidden="true" tabindex="-1"></a><span class="in">amces_minivan_mlogit</span></span>
<span id="cb106-1566"><a href="#cb106-1566" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1567"><a href="#cb106-1567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1568"><a href="#cb106-1568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1569"><a href="#cb106-1569" aria-hidden="true" tabindex="-1"></a><span class="fu">### Bayesian comparisons/contrasts</span></span>
<span id="cb106-1570"><a href="#cb106-1570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1571"><a href="#cb106-1571" aria-hidden="true" tabindex="-1"></a>Unlike the chocolate example, where the outcome variable was binary, we have to do similar grouping and summarizing and marginalizing shenanigans with the Bayesian minivan model here. We could theoretically work with things like <span class="in">`marginaleffects::comparisons()`</span> or <span class="in">`marginaleffects::slopes()`</span> to extract the AMCEs from the model, but as I'll show below, there are some weird mathy things we have to deal with because of the multinomial outcome, and I think it's beyond what {marginaleffects} is designed to easily do. </span>
<span id="cb106-1572"><a href="#cb106-1572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1573"><a href="#cb106-1573" aria-hidden="true" tabindex="-1"></a>So instead we can use <span class="in">`epred_draws()`</span> from {tidybayes} and calculate posterior predictions ourselves (<span class="co">[</span><span class="ot">see this guide</span><span class="co">](https://www.andrewheiss.com/blog/2022/09/26/guide-visualizing-types-posteriors/)</span> for an overview of all of {tidybayes}'s different prediction functions).</span>
<span id="cb106-1574"><a href="#cb106-1574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1575"><a href="#cb106-1575" aria-hidden="true" tabindex="-1"></a>To illustrate why predicting things with this multinomial model is so weird, we'll first predict the probability that someone chooses a \$30,000 6-seater electric van with 2 feet of storage space. For this combination of minivan characteristics, there's a 66% chance that someone does not select it, shown as category 0. That means there's a 33% chance that someone *does* select it. Because options 1, 2 and 3 were randomized, that 33% is split evenly across categories 1, 2, and 3 in the predictions here.</span>
<span id="cb106-1576"><a href="#cb106-1576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1577"><a href="#cb106-1577" aria-hidden="true" tabindex="-1"></a><span class="in">```{r create-show-one-prediction}</span></span>
<span id="cb106-1578"><a href="#cb106-1578" aria-hidden="true" tabindex="-1"></a><span class="in">one_prediction &lt;- model_minivans_categorical_brms %&gt;% </span></span>
<span id="cb106-1579"><a href="#cb106-1579" aria-hidden="true" tabindex="-1"></a><span class="in">  epred_draws(newdata = data.frame(</span></span>
<span id="cb106-1580"><a href="#cb106-1580" aria-hidden="true" tabindex="-1"></a><span class="in">    seat = "6", cargo = "2ft", eng = "elec", price = "30", resp.id = 1)</span></span>
<span id="cb106-1581"><a href="#cb106-1581" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb106-1582"><a href="#cb106-1582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1583"><a href="#cb106-1583" aria-hidden="true" tabindex="-1"></a><span class="in">one_prediction %&gt;% </span></span>
<span id="cb106-1584"><a href="#cb106-1584" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(.category) %&gt;% </span></span>
<span id="cb106-1585"><a href="#cb106-1585" aria-hidden="true" tabindex="-1"></a><span class="in">  median_qi(.epred)</span></span>
<span id="cb106-1586"><a href="#cb106-1586" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1587"><a href="#cb106-1587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1588"><a href="#cb106-1588" aria-hidden="true" tabindex="-1"></a>We could add the predictions for categories 1, 2, and 3 together, but that would take a bit of extra data manipulation work. Instead, we can rely on the the fact that the prediction for category 0 is actually the inverse of the sum of categories 1+2+3, so we can instead just use <span class="in">`1 - .epred`</span> and only look at category 0. Even though the <span class="in">`category`</span> column here says <span class="in">`0`</span>, it's really the combined probability of choosing options 1, 2, or 3:</span>
<span id="cb106-1589"><a href="#cb106-1589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1590"><a href="#cb106-1590" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-one-prediction-reversed}</span></span>
<span id="cb106-1591"><a href="#cb106-1591" aria-hidden="true" tabindex="-1"></a><span class="in">one_prediction %&gt;% </span></span>
<span id="cb106-1592"><a href="#cb106-1592" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(.epred = 1 - .epred) %&gt;%</span></span>
<span id="cb106-1593"><a href="#cb106-1593" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(.category == 0) %&gt;% </span></span>
<span id="cb106-1594"><a href="#cb106-1594" aria-hidden="true" tabindex="-1"></a><span class="in">  median_qi(.epred)</span></span>
<span id="cb106-1595"><a href="#cb106-1595" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1596"><a href="#cb106-1596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1597"><a href="#cb106-1597" aria-hidden="true" tabindex="-1"></a>With {mlogit}, we found AMCEs by essentially calculating marginal means for specific contrasts of predicted probabilities. We created a data frame of all 54 combinations of feature levels and then grouped and summarized that data frame as needed (e.g., the average of the 27 predictions for 2 feet of cargo space and the average of the 27 predictions for 3 feed of cargo space).</span>
<span id="cb106-1598"><a href="#cb106-1598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1599"><a href="#cb106-1599" aria-hidden="true" tabindex="-1"></a>We can do the same thing with the {brms} model, but selecting only the 0 category and reversing the predicted value:</span>
<span id="cb106-1600"><a href="#cb106-1600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1601"><a href="#cb106-1601" aria-hidden="true" tabindex="-1"></a><span class="in">```{r create-all-combos-minivans}</span></span>
<span id="cb106-1602"><a href="#cb106-1602" aria-hidden="true" tabindex="-1"></a><span class="in">newdata_all_combos &lt;- minivans %&gt;% </span></span>
<span id="cb106-1603"><a href="#cb106-1603" aria-hidden="true" tabindex="-1"></a><span class="in">  tidyr::expand(seat, cargo, eng, price) %&gt;% </span></span>
<span id="cb106-1604"><a href="#cb106-1604" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(resp.id = 1)</span></span>
<span id="cb106-1605"><a href="#cb106-1605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1606"><a href="#cb106-1606" aria-hidden="true" tabindex="-1"></a><span class="in">all_preds_brms &lt;- model_minivans_categorical_brms %&gt;% </span></span>
<span id="cb106-1607"><a href="#cb106-1607" aria-hidden="true" tabindex="-1"></a><span class="in">  epred_draws(newdata = newdata_all_combos) %&gt;% </span></span>
<span id="cb106-1608"><a href="#cb106-1608" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(.category == 0) %&gt;% </span></span>
<span id="cb106-1609"><a href="#cb106-1609" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(.epred = 1 - .epred)</span></span>
<span id="cb106-1610"><a href="#cb106-1610" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1611"><a href="#cb106-1611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1612"><a href="#cb106-1612" aria-hidden="true" tabindex="-1"></a>To make sure it worked, here are the posterior medians for all the different levels. It's roughly the same as what we found with in <span class="in">`all_preds_mlogit`</span>:</span>
<span id="cb106-1613"><a href="#cb106-1613" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1614"><a href="#cb106-1614" aria-hidden="true" tabindex="-1"></a><span class="in">```{r preds-show-all-combos-minivans}</span></span>
<span id="cb106-1615"><a href="#cb106-1615" aria-hidden="true" tabindex="-1"></a><span class="in">all_preds_brms %&gt;% </span></span>
<span id="cb106-1616"><a href="#cb106-1616" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(seat, cargo, eng, price) %&gt;% </span></span>
<span id="cb106-1617"><a href="#cb106-1617" aria-hidden="true" tabindex="-1"></a><span class="in">  median_qi(.epred)</span></span>
<span id="cb106-1618"><a href="#cb106-1618" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1619"><a href="#cb106-1619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1620"><a href="#cb106-1620" aria-hidden="true" tabindex="-1"></a>To pull out specific group-level averages, we can group and summarize. For example, here are the posterior median predictions for the two levels of cargo space:</span>
<span id="cb106-1621"><a href="#cb106-1621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1622"><a href="#cb106-1622" aria-hidden="true" tabindex="-1"></a><span class="in">```{r preds-cargo-wrong}</span></span>
<span id="cb106-1623"><a href="#cb106-1623" aria-hidden="true" tabindex="-1"></a><span class="in">all_preds_brms %&gt;% </span></span>
<span id="cb106-1624"><a href="#cb106-1624" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(cargo) %&gt;% </span></span>
<span id="cb106-1625"><a href="#cb106-1625" aria-hidden="true" tabindex="-1"></a><span class="in">  median_qi(.epred)</span></span>
<span id="cb106-1626"><a href="#cb106-1626" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1627"><a href="#cb106-1627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1628"><a href="#cb106-1628" aria-hidden="true" tabindex="-1"></a>The medians here are correct and basically what we found with {mlogit}, but the credible intervals are *wildly* off (5% to 75% favorability?!). If we plot this we can see why:</span>
<span id="cb106-1629"><a href="#cb106-1629" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1630"><a href="#cb106-1630" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-preds-combo-wrong}</span></span>
<span id="cb106-1631"><a href="#cb106-1631" aria-hidden="true" tabindex="-1"></a><span class="in">all_preds_brms %&gt;% </span></span>
<span id="cb106-1632"><a href="#cb106-1632" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = .epred, y = cargo, fill = cargo)) +</span></span>
<span id="cb106-1633"><a href="#cb106-1633" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye() +</span></span>
<span id="cb106-1634"><a href="#cb106-1634" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_percent()) +</span></span>
<span id="cb106-1635"><a href="#cb106-1635" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_manual(values = clrs[c(11, 7)], guide = "none") +</span></span>
<span id="cb106-1636"><a href="#cb106-1636" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Marginal means", y = "Cargo space")</span></span>
<span id="cb106-1637"><a href="#cb106-1637" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1638"><a href="#cb106-1638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1639"><a href="#cb106-1639" aria-hidden="true" tabindex="-1"></a>hahahaha check out those mountain ranges. All those peaks come from combining the 27 different 2ft- and 3ft- posterior distributions for all the different combinations of other feature levels. </span>
<span id="cb106-1640"><a href="#cb106-1640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1641"><a href="#cb106-1641" aria-hidden="true" tabindex="-1"></a>To get the actual marginal mean for cargo space, we need to marginalize out (or average out) all those other covariates. To do this, we need to group by the <span class="in">`cargo`</span> column *and* the <span class="in">`.draw`</span> column so that we find the average within each set of MCMC draws. To help with the intuition, look how many rows are in each of these groups of <span class="in">`cargo`</span> and <span class="in">`.draw`</span>—there are 27 different estimates for each of the 4,000 draws for 2 feet and 27 different estimates for each of the 4,000 draws for 3 feet. We want to collapse (or marginalize) those 27 rows into just one average. </span>
<span id="cb106-1642"><a href="#cb106-1642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1643"><a href="#cb106-1643" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-draws-in-cargo}</span></span>
<span id="cb106-1644"><a href="#cb106-1644" aria-hidden="true" tabindex="-1"></a><span class="in">all_preds_brms %&gt;% </span></span>
<span id="cb106-1645"><a href="#cb106-1645" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(cargo, .draw) %&gt;% </span></span>
<span id="cb106-1646"><a href="#cb106-1646" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(nrows = n())</span></span>
<span id="cb106-1647"><a href="#cb106-1647" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1648"><a href="#cb106-1648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1649"><a href="#cb106-1649" aria-hidden="true" tabindex="-1"></a>To do that, we can find the average predicted value in those groups, then work with that as our main estimand. Check out these marginalized-out posteriors now—the medians are the same as before, but the credible intervals make a lot more sense:</span>
<span id="cb106-1650"><a href="#cb106-1650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1651"><a href="#cb106-1651" aria-hidden="true" tabindex="-1"></a><span class="in">```{r preds-cargo-marginalized-correct}</span></span>
<span id="cb106-1652"><a href="#cb106-1652" aria-hidden="true" tabindex="-1"></a><span class="in">preds_cargo_marginalized &lt;- all_preds_brms %&gt;% </span></span>
<span id="cb106-1653"><a href="#cb106-1653" aria-hidden="true" tabindex="-1"></a><span class="in">  # Marginalize out the other covariates</span></span>
<span id="cb106-1654"><a href="#cb106-1654" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(cargo, .draw) %&gt;%</span></span>
<span id="cb106-1655"><a href="#cb106-1655" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(avg = mean(.epred))</span></span>
<span id="cb106-1656"><a href="#cb106-1656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1657"><a href="#cb106-1657" aria-hidden="true" tabindex="-1"></a><span class="in">preds_cargo_marginalized %&gt;% </span></span>
<span id="cb106-1658"><a href="#cb106-1658" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(cargo) %&gt;% </span></span>
<span id="cb106-1659"><a href="#cb106-1659" aria-hidden="true" tabindex="-1"></a><span class="in">  median_qi()</span></span>
<span id="cb106-1660"><a href="#cb106-1660" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1661"><a href="#cb106-1661" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1662"><a href="#cb106-1662" aria-hidden="true" tabindex="-1"></a>We can confirm that marginalizing out the other covariates worked by plotting it:</span>
<span id="cb106-1663"><a href="#cb106-1663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1664"><a href="#cb106-1664" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-preds-cargo-marginalized}</span></span>
<span id="cb106-1665"><a href="#cb106-1665" aria-hidden="true" tabindex="-1"></a><span class="in">preds_cargo_marginalized %&gt;% </span></span>
<span id="cb106-1666"><a href="#cb106-1666" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = avg, y = cargo, fill = cargo)) +</span></span>
<span id="cb106-1667"><a href="#cb106-1667" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye() +</span></span>
<span id="cb106-1668"><a href="#cb106-1668" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_percent()) +</span></span>
<span id="cb106-1669"><a href="#cb106-1669" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_manual(values = clrs[c(11, 7)], guide = "none") +</span></span>
<span id="cb106-1670"><a href="#cb106-1670" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Marginal means", y = "Cargo space")</span></span>
<span id="cb106-1671"><a href="#cb106-1671" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1672"><a href="#cb106-1672" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1673"><a href="#cb106-1673" aria-hidden="true" tabindex="-1"></a>heck. yes.</span>
<span id="cb106-1674"><a href="#cb106-1674" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1675"><a href="#cb106-1675" aria-hidden="true" tabindex="-1"></a>Finally, we're actually most interested in the AMCE, or the difference between these two cargo sizes. The <span class="in">`compare_levels()`</span> function from {tidybayes} can calculate this automatically:</span>
<span id="cb106-1676"><a href="#cb106-1676" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1677"><a href="#cb106-1677" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-preds-diffs-cargo}</span></span>
<span id="cb106-1678"><a href="#cb106-1678" aria-hidden="true" tabindex="-1"></a><span class="in">preds_cargo_marginalized %&gt;%</span></span>
<span id="cb106-1679"><a href="#cb106-1679" aria-hidden="true" tabindex="-1"></a><span class="in">  compare_levels(variable = avg, by = cargo, comparison = "control") %&gt;% </span></span>
<span id="cb106-1680"><a href="#cb106-1680" aria-hidden="true" tabindex="-1"></a><span class="in">  median_qi(avg)</span></span>
<span id="cb106-1681"><a href="#cb106-1681" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1682"><a href="#cb106-1682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1683"><a href="#cb106-1683" aria-hidden="true" tabindex="-1"></a>That's it! The **causal effect** of moving from 2 feet → 3 feet of storage space, holding all other features constant, is 8 percentage points (with a 95% credible interval of 6.5 to 10 percentage points).</span>
<span id="cb106-1684"><a href="#cb106-1684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1685"><a href="#cb106-1685" aria-hidden="true" tabindex="-1"></a>We can combine all these AMCEs into a huge data frame. The marginalization process + <span class="in">`compare_levels()`</span> has to happen with one feature at a time, so we need to create several separate data frames:</span>
<span id="cb106-1686"><a href="#cb106-1686" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1687"><a href="#cb106-1687" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-preds-minivan-all-marginalized}</span></span>
<span id="cb106-1688"><a href="#cb106-1688" aria-hidden="true" tabindex="-1"></a><span class="in"># I could probably do this with purrr::map() to reduce all this repetition, but</span></span>
<span id="cb106-1689"><a href="#cb106-1689" aria-hidden="true" tabindex="-1"></a><span class="in"># whatever, it works</span></span>
<span id="cb106-1690"><a href="#cb106-1690" aria-hidden="true" tabindex="-1"></a><span class="in">amces_minivan_brms &lt;- bind_rows(</span></span>
<span id="cb106-1691"><a href="#cb106-1691" aria-hidden="true" tabindex="-1"></a><span class="in">  seat = all_preds_brms %&gt;% </span></span>
<span id="cb106-1692"><a href="#cb106-1692" aria-hidden="true" tabindex="-1"></a><span class="in">    group_by(seat, .draw) %&gt;%</span></span>
<span id="cb106-1693"><a href="#cb106-1693" aria-hidden="true" tabindex="-1"></a><span class="in">    summarize(avg = mean(.epred)) %&gt;% </span></span>
<span id="cb106-1694"><a href="#cb106-1694" aria-hidden="true" tabindex="-1"></a><span class="in">    compare_levels(variable = avg, by = seat, comparison = "control") %&gt;% </span></span>
<span id="cb106-1695"><a href="#cb106-1695" aria-hidden="true" tabindex="-1"></a><span class="in">    rename(contrast = seat),</span></span>
<span id="cb106-1696"><a href="#cb106-1696" aria-hidden="true" tabindex="-1"></a><span class="in">  cargo = all_preds_brms %&gt;% </span></span>
<span id="cb106-1697"><a href="#cb106-1697" aria-hidden="true" tabindex="-1"></a><span class="in">    group_by(cargo, .draw) %&gt;%</span></span>
<span id="cb106-1698"><a href="#cb106-1698" aria-hidden="true" tabindex="-1"></a><span class="in">    summarize(avg = mean(.epred)) %&gt;% </span></span>
<span id="cb106-1699"><a href="#cb106-1699" aria-hidden="true" tabindex="-1"></a><span class="in">    compare_levels(variable = avg, by = cargo, comparison = "control") %&gt;% </span></span>
<span id="cb106-1700"><a href="#cb106-1700" aria-hidden="true" tabindex="-1"></a><span class="in">    rename(contrast = cargo),</span></span>
<span id="cb106-1701"><a href="#cb106-1701" aria-hidden="true" tabindex="-1"></a><span class="in">  eng = all_preds_brms %&gt;% </span></span>
<span id="cb106-1702"><a href="#cb106-1702" aria-hidden="true" tabindex="-1"></a><span class="in">    group_by(eng, .draw) %&gt;%</span></span>
<span id="cb106-1703"><a href="#cb106-1703" aria-hidden="true" tabindex="-1"></a><span class="in">    summarize(avg = mean(.epred)) %&gt;% </span></span>
<span id="cb106-1704"><a href="#cb106-1704" aria-hidden="true" tabindex="-1"></a><span class="in">    compare_levels(variable = avg, by = eng, comparison = "control") %&gt;% </span></span>
<span id="cb106-1705"><a href="#cb106-1705" aria-hidden="true" tabindex="-1"></a><span class="in">    rename(contrast = eng),</span></span>
<span id="cb106-1706"><a href="#cb106-1706" aria-hidden="true" tabindex="-1"></a><span class="in">  price = all_preds_brms %&gt;% </span></span>
<span id="cb106-1707"><a href="#cb106-1707" aria-hidden="true" tabindex="-1"></a><span class="in">    group_by(price, .draw) %&gt;%</span></span>
<span id="cb106-1708"><a href="#cb106-1708" aria-hidden="true" tabindex="-1"></a><span class="in">    summarize(avg = mean(.epred)) %&gt;% </span></span>
<span id="cb106-1709"><a href="#cb106-1709" aria-hidden="true" tabindex="-1"></a><span class="in">    compare_levels(variable = avg, by = price, comparison = "control") %&gt;% </span></span>
<span id="cb106-1710"><a href="#cb106-1710" aria-hidden="true" tabindex="-1"></a><span class="in">    rename(contrast = price),</span></span>
<span id="cb106-1711"><a href="#cb106-1711" aria-hidden="true" tabindex="-1"></a><span class="in">  .id = "term"</span></span>
<span id="cb106-1712"><a href="#cb106-1712" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb106-1713"><a href="#cb106-1713" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1714"><a href="#cb106-1714" aria-hidden="true" tabindex="-1"></a><span class="in">amces_minivan_brms %&gt;% </span></span>
<span id="cb106-1715"><a href="#cb106-1715" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(term, contrast) %&gt;% </span></span>
<span id="cb106-1716"><a href="#cb106-1716" aria-hidden="true" tabindex="-1"></a><span class="in">  median_qi(avg)</span></span>
<span id="cb106-1717"><a href="#cb106-1717" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1718"><a href="#cb106-1718" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1719"><a href="#cb106-1719" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1720"><a href="#cb106-1720" aria-hidden="true" tabindex="-1"></a><span class="fu">### Plots</span></span>
<span id="cb106-1721"><a href="#cb106-1721" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1722"><a href="#cb106-1722" aria-hidden="true" tabindex="-1"></a>Again, plotting these AMCEs so that there's a reference category at 0 requires some extra data work, so I've hidden all that code for the sake of space.</span>
<span id="cb106-1723"><a href="#cb106-1723" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1724"><a href="#cb106-1724" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-minivan-variable-levels}</span></span>
<span id="cb106-1725"><a href="#cb106-1725" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb106-1726"><a href="#cb106-1726" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-summary: "Extract variable labels"</span></span>
<span id="cb106-1727"><a href="#cb106-1727" aria-hidden="true" tabindex="-1"></a><span class="in">minivan_var_levels &lt;- tibble(</span></span>
<span id="cb106-1728"><a href="#cb106-1728" aria-hidden="true" tabindex="-1"></a><span class="in">  variable = c("seat", "cargo", "eng", "price")</span></span>
<span id="cb106-1729"><a href="#cb106-1729" aria-hidden="true" tabindex="-1"></a><span class="in">) %&gt;% </span></span>
<span id="cb106-1730"><a href="#cb106-1730" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(levels = map(variable, ~{</span></span>
<span id="cb106-1731"><a href="#cb106-1731" aria-hidden="true" tabindex="-1"></a><span class="in">    x &lt;- minivans[[.x]]</span></span>
<span id="cb106-1732"><a href="#cb106-1732" aria-hidden="true" tabindex="-1"></a><span class="in">    if (is.numeric(x)) {</span></span>
<span id="cb106-1733"><a href="#cb106-1733" aria-hidden="true" tabindex="-1"></a><span class="in">      ""</span></span>
<span id="cb106-1734"><a href="#cb106-1734" aria-hidden="true" tabindex="-1"></a><span class="in">    } else if (is.factor(x)) {</span></span>
<span id="cb106-1735"><a href="#cb106-1735" aria-hidden="true" tabindex="-1"></a><span class="in">      levels(x)</span></span>
<span id="cb106-1736"><a href="#cb106-1736" aria-hidden="true" tabindex="-1"></a><span class="in">    } else {</span></span>
<span id="cb106-1737"><a href="#cb106-1737" aria-hidden="true" tabindex="-1"></a><span class="in">      sort(unique(x))</span></span>
<span id="cb106-1738"><a href="#cb106-1738" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb106-1739"><a href="#cb106-1739" aria-hidden="true" tabindex="-1"></a><span class="in">  })) %&gt;% </span></span>
<span id="cb106-1740"><a href="#cb106-1740" aria-hidden="true" tabindex="-1"></a><span class="in">  unnest(levels) %&gt;% </span></span>
<span id="cb106-1741"><a href="#cb106-1741" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(term = paste0(variable, levels))</span></span>
<span id="cb106-1742"><a href="#cb106-1742" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1743"><a href="#cb106-1743" aria-hidden="true" tabindex="-1"></a><span class="in"># Make a little lookup table for nicer feature labels</span></span>
<span id="cb106-1744"><a href="#cb106-1744" aria-hidden="true" tabindex="-1"></a><span class="in">minivan_var_lookup &lt;- tribble(</span></span>
<span id="cb106-1745"><a href="#cb106-1745" aria-hidden="true" tabindex="-1"></a><span class="in">  ~variable, ~variable_nice,</span></span>
<span id="cb106-1746"><a href="#cb106-1746" aria-hidden="true" tabindex="-1"></a><span class="in">  "seat",    "Passengers",</span></span>
<span id="cb106-1747"><a href="#cb106-1747" aria-hidden="true" tabindex="-1"></a><span class="in">  "cargo",   "Cargo space",</span></span>
<span id="cb106-1748"><a href="#cb106-1748" aria-hidden="true" tabindex="-1"></a><span class="in">  "eng",     "Engine type",</span></span>
<span id="cb106-1749"><a href="#cb106-1749" aria-hidden="true" tabindex="-1"></a><span class="in">  "price",   "Price (thousands of $)"</span></span>
<span id="cb106-1750"><a href="#cb106-1750" aria-hidden="true" tabindex="-1"></a><span class="in">) %&gt;% </span></span>
<span id="cb106-1751"><a href="#cb106-1751" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(variable_nice = fct_inorder(variable_nice))</span></span>
<span id="cb106-1752"><a href="#cb106-1752" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1753"><a href="#cb106-1753" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1754"><a href="#cb106-1754" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-amces-minivans-mlogit}</span></span>
<span id="cb106-1755"><a href="#cb106-1755" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb106-1756"><a href="#cb106-1756" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-summary: "Combine full dataset of factor levels with model comparisons and make {mlogit} plot"</span></span>
<span id="cb106-1757"><a href="#cb106-1757" aria-hidden="true" tabindex="-1"></a><span class="in">amces_minivan_mlogit_split &lt;- amces_minivan_mlogit %&gt;% </span></span>
<span id="cb106-1758"><a href="#cb106-1758" aria-hidden="true" tabindex="-1"></a><span class="in">  separate_wider_delim(</span></span>
<span id="cb106-1759"><a href="#cb106-1759" aria-hidden="true" tabindex="-1"></a><span class="in">    term,</span></span>
<span id="cb106-1760"><a href="#cb106-1760" aria-hidden="true" tabindex="-1"></a><span class="in">    delim = " - ", </span></span>
<span id="cb106-1761"><a href="#cb106-1761" aria-hidden="true" tabindex="-1"></a><span class="in">    names = c("variable_level", "reference_level")</span></span>
<span id="cb106-1762"><a href="#cb106-1762" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;% </span></span>
<span id="cb106-1763"><a href="#cb106-1763" aria-hidden="true" tabindex="-1"></a><span class="in">  rename(term = variable)</span></span>
<span id="cb106-1764"><a href="#cb106-1764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1765"><a href="#cb106-1765" aria-hidden="true" tabindex="-1"></a><span class="in">plot_data &lt;- minivan_var_levels %&gt;%</span></span>
<span id="cb106-1766"><a href="#cb106-1766" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(</span></span>
<span id="cb106-1767"><a href="#cb106-1767" aria-hidden="true" tabindex="-1"></a><span class="in">    amces_minivan_mlogit_split,</span></span>
<span id="cb106-1768"><a href="#cb106-1768" aria-hidden="true" tabindex="-1"></a><span class="in">    by = join_by(variable == term, levels == variable_level)</span></span>
<span id="cb106-1769"><a href="#cb106-1769" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;% </span></span>
<span id="cb106-1770"><a href="#cb106-1770" aria-hidden="true" tabindex="-1"></a><span class="in">  # Make these zero</span></span>
<span id="cb106-1771"><a href="#cb106-1771" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb106-1772"><a href="#cb106-1772" aria-hidden="true" tabindex="-1"></a><span class="in">    across(</span></span>
<span id="cb106-1773"><a href="#cb106-1773" aria-hidden="true" tabindex="-1"></a><span class="in">      c(estimate),</span></span>
<span id="cb106-1774"><a href="#cb106-1774" aria-hidden="true" tabindex="-1"></a><span class="in">      # This is from when this worked with marginaleffects</span></span>
<span id="cb106-1775"><a href="#cb106-1775" aria-hidden="true" tabindex="-1"></a><span class="in">      # c(estimate, conf.low, conf.high),</span></span>
<span id="cb106-1776"><a href="#cb106-1776" aria-hidden="true" tabindex="-1"></a><span class="in">      ~ ifelse(is.na(.x), 0, .x)</span></span>
<span id="cb106-1777"><a href="#cb106-1777" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb106-1778"><a href="#cb106-1778" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;% </span></span>
<span id="cb106-1779"><a href="#cb106-1779" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(minivan_var_lookup, by = join_by(variable)) %&gt;% </span></span>
<span id="cb106-1780"><a href="#cb106-1780" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(across(c(levels, variable_nice), ~fct_inorder(.)))</span></span>
<span id="cb106-1781"><a href="#cb106-1781" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1782"><a href="#cb106-1782" aria-hidden="true" tabindex="-1"></a><span class="in">p1 &lt;- ggplot(</span></span>
<span id="cb106-1783"><a href="#cb106-1783" aria-hidden="true" tabindex="-1"></a><span class="in">  plot_data,</span></span>
<span id="cb106-1784"><a href="#cb106-1784" aria-hidden="true" tabindex="-1"></a><span class="in">  aes(x = estimate, y = levels, color = variable_nice)</span></span>
<span id="cb106-1785"><a href="#cb106-1785" aria-hidden="true" tabindex="-1"></a><span class="in">) +</span></span>
<span id="cb106-1786"><a href="#cb106-1786" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0) +</span></span>
<span id="cb106-1787"><a href="#cb106-1787" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point() +</span></span>
<span id="cb106-1788"><a href="#cb106-1788" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_pp) +</span></span>
<span id="cb106-1789"><a href="#cb106-1789" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_color_manual(values = clrs[c(3, 7, 8, 9)], guide = "none") +</span></span>
<span id="cb106-1790"><a href="#cb106-1790" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(</span></span>
<span id="cb106-1791"><a href="#cb106-1791" aria-hidden="true" tabindex="-1"></a><span class="in">    x = "Percentage point change in\nprobability of minivan selection",</span></span>
<span id="cb106-1792"><a href="#cb106-1792" aria-hidden="true" tabindex="-1"></a><span class="in">    y = NULL,</span></span>
<span id="cb106-1793"><a href="#cb106-1793" aria-hidden="true" tabindex="-1"></a><span class="in">    title = "Frequentist AMCEs from {mlogit}"</span></span>
<span id="cb106-1794"><a href="#cb106-1794" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb106-1795"><a href="#cb106-1795" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_col(facets = "variable_nice", scales = "free_y", space = "free")</span></span>
<span id="cb106-1796"><a href="#cb106-1796" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1797"><a href="#cb106-1797" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1798"><a href="#cb106-1798" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-amces-minivans-brms}</span></span>
<span id="cb106-1799"><a href="#cb106-1799" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb106-1800"><a href="#cb106-1800" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-summary: "Combine full dataset of factor levels with marginalized posterior draws and make {brms} plot"</span></span>
<span id="cb106-1801"><a href="#cb106-1801" aria-hidden="true" tabindex="-1"></a><span class="in">posterior_mfx_minivan_nested &lt;- amces_minivan_brms %&gt;% </span></span>
<span id="cb106-1802"><a href="#cb106-1802" aria-hidden="true" tabindex="-1"></a><span class="in">  separate_wider_delim(</span></span>
<span id="cb106-1803"><a href="#cb106-1803" aria-hidden="true" tabindex="-1"></a><span class="in">    contrast,</span></span>
<span id="cb106-1804"><a href="#cb106-1804" aria-hidden="true" tabindex="-1"></a><span class="in">    delim = " - ", </span></span>
<span id="cb106-1805"><a href="#cb106-1805" aria-hidden="true" tabindex="-1"></a><span class="in">    names = c("variable_level", "reference_level")</span></span>
<span id="cb106-1806"><a href="#cb106-1806" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;% </span></span>
<span id="cb106-1807"><a href="#cb106-1807" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(term, variable_level) %&gt;% </span></span>
<span id="cb106-1808"><a href="#cb106-1808" aria-hidden="true" tabindex="-1"></a><span class="in">  nest()</span></span>
<span id="cb106-1809"><a href="#cb106-1809" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1810"><a href="#cb106-1810" aria-hidden="true" tabindex="-1"></a><span class="in">plot_data_minivan_bayes &lt;- minivan_var_levels %&gt;%</span></span>
<span id="cb106-1811"><a href="#cb106-1811" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(</span></span>
<span id="cb106-1812"><a href="#cb106-1812" aria-hidden="true" tabindex="-1"></a><span class="in">    posterior_mfx_minivan_nested,</span></span>
<span id="cb106-1813"><a href="#cb106-1813" aria-hidden="true" tabindex="-1"></a><span class="in">    by = join_by(variable == term, levels == variable_level)</span></span>
<span id="cb106-1814"><a href="#cb106-1814" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;%</span></span>
<span id="cb106-1815"><a href="#cb106-1815" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(data = map_if(data, is.null, ~ tibble(avg = 0))) %&gt;% </span></span>
<span id="cb106-1816"><a href="#cb106-1816" aria-hidden="true" tabindex="-1"></a><span class="in">  unnest(data) %&gt;% </span></span>
<span id="cb106-1817"><a href="#cb106-1817" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(minivan_var_lookup, by = join_by(variable)) %&gt;% </span></span>
<span id="cb106-1818"><a href="#cb106-1818" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(across(c(levels, variable_nice), ~fct_inorder(.)))</span></span>
<span id="cb106-1819"><a href="#cb106-1819" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1820"><a href="#cb106-1820" aria-hidden="true" tabindex="-1"></a><span class="in">p2 &lt;- ggplot(plot_data_minivan_bayes, aes(x = avg, y = levels, fill = variable_nice)) +</span></span>
<span id="cb106-1821"><a href="#cb106-1821" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0) +</span></span>
<span id="cb106-1822"><a href="#cb106-1822" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye(normalize = "groups") +  # Make the heights of the distributions equal within each facet</span></span>
<span id="cb106-1823"><a href="#cb106-1823" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_col(facets = "variable_nice", scales = "free_y", space = "free") +</span></span>
<span id="cb106-1824"><a href="#cb106-1824" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_pp) +</span></span>
<span id="cb106-1825"><a href="#cb106-1825" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_manual(values = clrs[c(3, 7, 8, 9)], guide = "none") +</span></span>
<span id="cb106-1826"><a href="#cb106-1826" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(</span></span>
<span id="cb106-1827"><a href="#cb106-1827" aria-hidden="true" tabindex="-1"></a><span class="in">    x = "Percentage point change in\nprobability of minivan selection",</span></span>
<span id="cb106-1828"><a href="#cb106-1828" aria-hidden="true" tabindex="-1"></a><span class="in">    y = NULL,</span></span>
<span id="cb106-1829"><a href="#cb106-1829" aria-hidden="true" tabindex="-1"></a><span class="in">    title = "Posterior Bayesian AMCEs from {brms}"</span></span>
<span id="cb106-1830"><a href="#cb106-1830" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb106-1831"><a href="#cb106-1831" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1832"><a href="#cb106-1832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1833"><a href="#cb106-1833" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1834"><a href="#cb106-1834" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-amces-minivans-both, fig.height=4.5, fig.width=8, out.width="100%"}</span></span>
<span id="cb106-1835"><a href="#cb106-1835" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: body-outset</span></span>
<span id="cb106-1836"><a href="#cb106-1836" aria-hidden="true" tabindex="-1"></a><span class="in">p1 + p2</span></span>
<span id="cb106-1837"><a href="#cb106-1837" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1838"><a href="#cb106-1838" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1839"><a href="#cb106-1839" aria-hidden="true" tabindex="-1"></a>\ </span>
<span id="cb106-1840"><a href="#cb106-1840" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1841"><a href="#cb106-1841" aria-hidden="true" tabindex="-1"></a><span class="fu"># Part 3: Minivans; repeated questions; full hierarchical multinomial logit</span></span>
<span id="cb106-1842"><a href="#cb106-1842" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1843"><a href="#cb106-1843" aria-hidden="true" tabindex="-1"></a><span class="fu">## The setup</span></span>
<span id="cb106-1844"><a href="#cb106-1844" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1845"><a href="#cb106-1845" aria-hidden="true" tabindex="-1"></a>We've cheated a little and have already used multilevel structures in the Bayesian models for the chocolate experiment and the minivan experiment. This was because these datasets had a natural panel grouping structure inside them. {mlogit} can work with panel-indexed data frames (that's the point of that strange <span class="in">`dfidx()`</span> function). By creating respondent-specific intercepts like we did with the {brms} models, we helped account for some of the variation caused by respondent differences.</span>
<span id="cb106-1846"><a href="#cb106-1846" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1847"><a href="#cb106-1847" aria-hidden="true" tabindex="-1"></a>But we can do better than that and get far richer and more complex models and estimates and predictions. In addition to using respondent-specific intercepts, we can (1) include respondent-level characteristics as covariates, and (2) include respondent-specific slopes for the minivan characteristic.</span>
<span id="cb106-1848"><a href="#cb106-1848" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1849"><a href="#cb106-1849" aria-hidden="true" tabindex="-1"></a>In the minivan data, we have data on feature levels (<span class="in">`seat`</span>, <span class="in">`cargo`</span>, <span class="in">`eng`</span>, <span class="in">`price`</span>) *and* on individual characteristics (<span class="in">`carpool`</span>). The <span class="in">`carpool`</span> variable indicates if the respondent uses their vehicle for carpooling. This is measured at the respondent level and not the choice level (i.e. someone won't stop being a carpooler during one set of choices and then resume being a carpooler for another set). </span>
<span id="cb106-1850"><a href="#cb106-1850" aria-hidden="true" tabindex="-1"></a>We can visualize where these different columns are measured by returning to the hierarchical model diagram:</span>
<span id="cb106-1851"><a href="#cb106-1851" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1852"><a href="#cb106-1852" aria-hidden="true" tabindex="-1"></a><span class="in">```{tikz minivan-multilevel-structure-annotated, engine.opts=font_opts}</span></span>
<span id="cb106-1853"><a href="#cb106-1853" aria-hidden="true" tabindex="-1"></a><span class="in">#| echo: false</span></span>
<span id="cb106-1854"><a href="#cb106-1854" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: "Multilevel experimental structure, with minivan choices $\\{y_1, y_2, y_3\\}$ nested in sets of questions in respondents, w ith variables measured at different levels"</span></span>
<span id="cb106-1855"><a href="#cb106-1855" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-align: center</span></span>
<span id="cb106-1856"><a href="#cb106-1856" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-ext: svg</span></span>
<span id="cb106-1857"><a href="#cb106-1857" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page</span></span>
<span id="cb106-1858"><a href="#cb106-1858" aria-hidden="true" tabindex="-1"></a><span class="in">#| out-width: 100%</span></span>
<span id="cb106-1859"><a href="#cb106-1859" aria-hidden="true" tabindex="-1"></a><span class="in">\usetikzlibrary{positioning}</span></span>
<span id="cb106-1860"><a href="#cb106-1860" aria-hidden="true" tabindex="-1"></a><span class="in">\usetikzlibrary{shapes.geometric}</span></span>
<span id="cb106-1861"><a href="#cb106-1861" aria-hidden="true" tabindex="-1"></a><span class="in">\usetikzlibrary{backgrounds}</span></span>
<span id="cb106-1862"><a href="#cb106-1862" aria-hidden="true" tabindex="-1"></a><span class="in">\definecolor{indiv}{HTML}{5F4690}</span></span>
<span id="cb106-1863"><a href="#cb106-1863" aria-hidden="true" tabindex="-1"></a><span class="in">\definecolor{indiv1}{HTML}{CBBAF7}</span></span>
<span id="cb106-1864"><a href="#cb106-1864" aria-hidden="true" tabindex="-1"></a><span class="in">\definecolor{choice}{HTML}{E17C05}</span></span>
<span id="cb106-1865"><a href="#cb106-1865" aria-hidden="true" tabindex="-1"></a><span class="in">\definecolor{choice1}{HTML}{F7C694}</span></span>
<span id="cb106-1866"><a href="#cb106-1866" aria-hidden="true" tabindex="-1"></a><span class="in">\begin{tikzpicture}[{every node/.append style}=draw]</span></span>
<span id="cb106-1867"><a href="#cb106-1867" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [rectangle, draw=none, fill=indiv1] (respondent1) at (0, 2.5) {Respondent 1};</span></span>
<span id="cb106-1868"><a href="#cb106-1868" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1869"><a href="#cb106-1869" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [rectangle] (q11) at (-1.5, 1) {Set $1_1$};</span></span>
<span id="cb106-1870"><a href="#cb106-1870" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [draw=none] (q21) at (0, 1) {$\dots$};</span></span>
<span id="cb106-1871"><a href="#cb106-1871" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [rectangle] (q31) at (1.5, 1) {Set $15_1$};</span></span>
<span id="cb106-1872"><a href="#cb106-1872" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1873"><a href="#cb106-1873" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [circle, fill=choice1, draw=none] (y111) at (-3.75, -0.5) {$y_{1_{1_1}}$};</span></span>
<span id="cb106-1874"><a href="#cb106-1874" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [circle, fill=choice1, draw=none] (y211) at (-2.5, -0.5) {$y_{2_{1_1}}$};</span></span>
<span id="cb106-1875"><a href="#cb106-1875" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [circle, fill=choice1, draw=none] (y311) at (-1.25, -0.5) {$y_{3_{1_1}}$};</span></span>
<span id="cb106-1876"><a href="#cb106-1876" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1877"><a href="#cb106-1877" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [draw=none] (y121) at (0, -0.5) {$\dots$};</span></span>
<span id="cb106-1878"><a href="#cb106-1878" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1879"><a href="#cb106-1879" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [circle, fill=choice1, draw=none] (y131) at (1.25, -0.5) {$y_{1_{15_1}}$};</span></span>
<span id="cb106-1880"><a href="#cb106-1880" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [circle, fill=choice1, draw=none] (y231) at (2.5, -0.5) {$y_{2_{15_1}}$};</span></span>
<span id="cb106-1881"><a href="#cb106-1881" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [circle, fill=choice1, draw=none] (y331) at (3.75, -0.5) {$y_{3_{15_1}}$};</span></span>
<span id="cb106-1882"><a href="#cb106-1882" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1883"><a href="#cb106-1883" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (respondent1) to (q11);</span></span>
<span id="cb106-1884"><a href="#cb106-1884" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (respondent1) to (q21);</span></span>
<span id="cb106-1885"><a href="#cb106-1885" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (respondent1) to (q31);</span></span>
<span id="cb106-1886"><a href="#cb106-1886" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (q11) to (y111);</span></span>
<span id="cb106-1887"><a href="#cb106-1887" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (q11) to (y211);</span></span>
<span id="cb106-1888"><a href="#cb106-1888" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (q11) to (y311);</span></span>
<span id="cb106-1889"><a href="#cb106-1889" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (q21) to (y121);</span></span>
<span id="cb106-1890"><a href="#cb106-1890" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (q31) to (y131);</span></span>
<span id="cb106-1891"><a href="#cb106-1891" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (q31) to (y231);</span></span>
<span id="cb106-1892"><a href="#cb106-1892" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (q31) to (y331);</span></span>
<span id="cb106-1893"><a href="#cb106-1893" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1894"><a href="#cb106-1894" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [draw=none] (respondent2) at (5, 2.5) {$\dots$};</span></span>
<span id="cb106-1895"><a href="#cb106-1895" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [rectangle] (y12) at (4, 1) {Set 1};</span></span>
<span id="cb106-1896"><a href="#cb106-1896" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [draw=none] (y22) at (5, 1) {$\dots$};</span></span>
<span id="cb106-1897"><a href="#cb106-1897" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [rectangle] (y32) at (6, 1) {Set 15};</span></span>
<span id="cb106-1898"><a href="#cb106-1898" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (respondent2) to (y12);</span></span>
<span id="cb106-1899"><a href="#cb106-1899" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (respondent2) to (y22);</span></span>
<span id="cb106-1900"><a href="#cb106-1900" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (respondent2) to (y32);</span></span>
<span id="cb106-1901"><a href="#cb106-1901" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1902"><a href="#cb106-1902" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [rectangle, draw=none, fill=indiv1] (respondentn) at (10, 2.5) {Respondent 200};</span></span>
<span id="cb106-1903"><a href="#cb106-1903" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [rectangle] (q1n) at (8.5, 1) {Set $1_{200}$};</span></span>
<span id="cb106-1904"><a href="#cb106-1904" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [draw=none] (q2n) at (10, 1) {$\dots$};</span></span>
<span id="cb106-1905"><a href="#cb106-1905" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [rectangle] (q3n) at (11.5, 1) {Set $15_{200}$};</span></span>
<span id="cb106-1906"><a href="#cb106-1906" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1907"><a href="#cb106-1907" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [circle, fill=choice1, draw=none] (y113) at (6.25, -0.5) {$y_{1_{1_{200}}}$};</span></span>
<span id="cb106-1908"><a href="#cb106-1908" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [circle, fill=choice1, draw=none] (y213) at (7.5, -0.5) {$y_{2_{1_{200}}}$};</span></span>
<span id="cb106-1909"><a href="#cb106-1909" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [circle, fill=choice1, draw=none] (y313) at (8.75, -0.5) {$y_{3_{1_{200}}}$};</span></span>
<span id="cb106-1910"><a href="#cb106-1910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1911"><a href="#cb106-1911" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [draw=none] (y123) at (10, -0.5) {$\dots$};</span></span>
<span id="cb106-1912"><a href="#cb106-1912" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1913"><a href="#cb106-1913" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [circle, fill=choice1, draw=none] (y133) at (11.25, -0.5) {$y_{1_{15_{200}}}$};</span></span>
<span id="cb106-1914"><a href="#cb106-1914" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [circle, fill=choice1, draw=none] (y233) at (12.5, -0.5) {$y_{2_{15_{200}}}$};</span></span>
<span id="cb106-1915"><a href="#cb106-1915" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [circle, fill=choice1, draw=none] (y333) at (13.75, -0.5) {$y_{3_{15_{200}}}$};</span></span>
<span id="cb106-1916"><a href="#cb106-1916" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1917"><a href="#cb106-1917" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (respondentn) to (q1n);</span></span>
<span id="cb106-1918"><a href="#cb106-1918" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (respondentn) to (q2n);</span></span>
<span id="cb106-1919"><a href="#cb106-1919" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (respondentn) to (q3n);</span></span>
<span id="cb106-1920"><a href="#cb106-1920" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (q1n) to (y113);</span></span>
<span id="cb106-1921"><a href="#cb106-1921" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (q1n) to (y213);</span></span>
<span id="cb106-1922"><a href="#cb106-1922" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (q1n) to (y313);</span></span>
<span id="cb106-1923"><a href="#cb106-1923" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (q2n) to (y123);</span></span>
<span id="cb106-1924"><a href="#cb106-1924" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (q3n) to (y133);</span></span>
<span id="cb106-1925"><a href="#cb106-1925" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (q3n) to (y233);</span></span>
<span id="cb106-1926"><a href="#cb106-1926" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (q3n) to (y333);</span></span>
<span id="cb106-1927"><a href="#cb106-1927" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1928"><a href="#cb106-1928" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [rectangle] (population) at (5, 4) {Population of experiment respondents};</span></span>
<span id="cb106-1929"><a href="#cb106-1929" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (population) to (respondent1);</span></span>
<span id="cb106-1930"><a href="#cb106-1930" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (population) to (respondent2);</span></span>
<span id="cb106-1931"><a href="#cb106-1931" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (population) to (respondentn);</span></span>
<span id="cb106-1932"><a href="#cb106-1932" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1933"><a href="#cb106-1933" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [rounded corners, draw=none, align=center, fill=indiv, text=white] </span></span>
<span id="cb106-1934"><a href="#cb106-1934" aria-hidden="true" tabindex="-1"></a><span class="in">    (note_respondent) at (-0.5, 3.75) </span></span>
<span id="cb106-1935"><a href="#cb106-1935" aria-hidden="true" tabindex="-1"></a><span class="in">    {\textsf{Things measured here:}\\\texttt{carpool}};</span></span>
<span id="cb106-1936"><a href="#cb106-1936" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1937"><a href="#cb106-1937" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [rounded corners, draw=none, align=center, fill=choice, text=white] </span></span>
<span id="cb106-1938"><a href="#cb106-1938" aria-hidden="true" tabindex="-1"></a><span class="in">    (note_choice) at (0, -2.25) </span></span>
<span id="cb106-1939"><a href="#cb106-1939" aria-hidden="true" tabindex="-1"></a><span class="in">    {\textsf{Things measured here:}\\\texttt{seat}, \texttt{cargo}, \texttt{eng}, \texttt{price}};</span></span>
<span id="cb106-1940"><a href="#cb106-1940" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1941"><a href="#cb106-1941" aria-hidden="true" tabindex="-1"></a><span class="in">  \begin{scope}[on background layer]</span></span>
<span id="cb106-1942"><a href="#cb106-1942" aria-hidden="true" tabindex="-1"></a><span class="in">    \draw [-, color=indiv, ultra thick] (note_respondent.center) to (respondent1);</span></span>
<span id="cb106-1943"><a href="#cb106-1943" aria-hidden="true" tabindex="-1"></a><span class="in">    \draw [-, color=indiv, thin] (note_respondent.center) to (respondentn);</span></span>
<span id="cb106-1944"><a href="#cb106-1944" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1945"><a href="#cb106-1945" aria-hidden="true" tabindex="-1"></a><span class="in">    \draw [-, color=choice, thick] (note_choice.center) to (y111);</span></span>
<span id="cb106-1946"><a href="#cb106-1946" aria-hidden="true" tabindex="-1"></a><span class="in">    \draw [-, color=choice, thick] (note_choice.center) to (y211);</span></span>
<span id="cb106-1947"><a href="#cb106-1947" aria-hidden="true" tabindex="-1"></a><span class="in">    \draw [-, color=choice, thick] (note_choice.center) to (y311);</span></span>
<span id="cb106-1948"><a href="#cb106-1948" aria-hidden="true" tabindex="-1"></a><span class="in">    \draw [-, color=choice, thick] (note_choice.center) to (y131);</span></span>
<span id="cb106-1949"><a href="#cb106-1949" aria-hidden="true" tabindex="-1"></a><span class="in">    \draw [-, color=choice, thick] (note_choice.center) to (y231);</span></span>
<span id="cb106-1950"><a href="#cb106-1950" aria-hidden="true" tabindex="-1"></a><span class="in">    \draw [-, color=choice, thick] (note_choice.center) to (y331);</span></span>
<span id="cb106-1951"><a href="#cb106-1951" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb106-1952"><a href="#cb106-1952" aria-hidden="true" tabindex="-1"></a><span class="in">    \draw [-, color=choice, ultra thin] (note_choice.center) to (y113.south);</span></span>
<span id="cb106-1953"><a href="#cb106-1953" aria-hidden="true" tabindex="-1"></a><span class="in">    \draw [-, color=choice, ultra thin] (note_choice.center) to (y213.south);</span></span>
<span id="cb106-1954"><a href="#cb106-1954" aria-hidden="true" tabindex="-1"></a><span class="in">    \draw [-, color=choice, ultra thin] (note_choice.center) to (y313.south);</span></span>
<span id="cb106-1955"><a href="#cb106-1955" aria-hidden="true" tabindex="-1"></a><span class="in">    \draw [-, color=choice, ultra thin] (note_choice.center) to (y133.south);</span></span>
<span id="cb106-1956"><a href="#cb106-1956" aria-hidden="true" tabindex="-1"></a><span class="in">    \draw [-, color=choice, ultra thin] (note_choice.center) to (y233.south);</span></span>
<span id="cb106-1957"><a href="#cb106-1957" aria-hidden="true" tabindex="-1"></a><span class="in">    \draw [-, color=choice, ultra thin] (note_choice.center) to (y333.south);</span></span>
<span id="cb106-1958"><a href="#cb106-1958" aria-hidden="true" tabindex="-1"></a><span class="in">  \end{scope}</span></span>
<span id="cb106-1959"><a href="#cb106-1959" aria-hidden="true" tabindex="-1"></a><span class="in">\end{tikzpicture}</span></span>
<span id="cb106-1960"><a href="#cb106-1960" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1961"><a href="#cb106-1961" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1962"><a href="#cb106-1962" aria-hidden="true" tabindex="-1"></a>We can use hierarchical models (or multilevel models, or mixed effects models, or whatever you want to call them) to account for choice-level and respondent-level covariates *and* incorporate respondent-level heterogeneity and covariance into the model estimates.</span>
<span id="cb106-1963"><a href="#cb106-1963" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1964"><a href="#cb106-1964" aria-hidden="true" tabindex="-1"></a>!<span class="co">[</span><span class="ot">Image by [Chelsea Parlett-Pelleriti](https://twitter.com/chelseaparlett/status/1458461737431146500)</span><span class="co">](img/chelsea-meme.jpg)</span>{width=50%}</span>
<span id="cb106-1965"><a href="#cb106-1965" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1966"><a href="#cb106-1966" aria-hidden="true" tabindex="-1"></a><span class="fu">## Important sidenote on notation</span></span>
<span id="cb106-1967"><a href="#cb106-1967" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1968"><a href="#cb106-1968" aria-hidden="true" tabindex="-1"></a>But before looking at how to incorporate that <span class="in">`carpool`</span> column into the model, we need to take a quick little detour into the world of notation. There's no consistent way of writing out multilevel models,^<span class="co">[</span><span class="ot">These are not the only approaches—section 12.5 in @GelmanHill:2007 is called "Five ways to write the same model," and they don't include the offset notation as one of their five!</span><span class="co">]</span> and accordingly, I thought it was impossible to run fully specified marketing-style hierarchical Bayesian models with {brms}—all because of notation!</span>
<span id="cb106-1969"><a href="#cb106-1969" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1970"><a href="#cb106-1970" aria-hidden="true" tabindex="-1"></a>There are a couple general ways I've seen group-level random effects written out in formal model notation: one with complete random β terms and one with random offsets from a global β term.</span>
<span id="cb106-1971"><a href="#cb106-1971" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1972"><a href="#cb106-1972" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb106-1973"><a href="#cb106-1973" aria-hidden="true" tabindex="-1"></a><span class="fu">### {brms} / {lme4} syntax</span></span>
<span id="cb106-1974"><a href="#cb106-1974" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1975"><a href="#cb106-1975" aria-hidden="true" tabindex="-1"></a>For the best overview of how to use {brms} and {lme4} with different random group-level intercept and slope specifications, <span class="co">[</span><span class="ot">check out this summary table by Ben Bolker</span><span class="co">](https://bbolker.github.io/mixedmodels-misc/glmmFAQ.html#model-specification)</span>.</span>
<span id="cb106-1976"><a href="#cb106-1976" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb106-1977"><a href="#cb106-1977" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1978"><a href="#cb106-1978" aria-hidden="true" tabindex="-1"></a><span class="fu">### Random intercepts</span></span>
<span id="cb106-1979"><a href="#cb106-1979" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1980"><a href="#cb106-1980" aria-hidden="true" tabindex="-1"></a>If you want group-specific intercept terms, you can use a formula like this:</span>
<span id="cb106-1981"><a href="#cb106-1981" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1982"><a href="#cb106-1982" aria-hidden="true" tabindex="-1"></a><span class="in">``` r</span></span>
<span id="cb106-1983"><a href="#cb106-1983" aria-hidden="true" tabindex="-1"></a><span class="fu">bf</span>(y <span class="sc">~</span> x <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> group))</span>
<span id="cb106-1984"><a href="#cb106-1984" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1985"><a href="#cb106-1985" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1986"><a href="#cb106-1986" aria-hidden="true" tabindex="-1"></a>In formal mathy terms, we can write this group-specific intercept as a complete coefficient: $\beta_{0_j}$. Each group $j$ gets its own intercept coefficient. Nice and straightforward.</span>
<span id="cb106-1987"><a href="#cb106-1987" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1988"><a href="#cb106-1988" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-1989"><a href="#cb106-1989" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb106-1990"><a href="#cb106-1990" aria-hidden="true" tabindex="-1"></a>Y_{i_j} &amp;\sim \mathcal{N}(\mu_{i_j}, \sigma_y) &amp; \text{Outcome for individual}_i \text{ within group}_j <span class="sc">\\</span></span>
<span id="cb106-1991"><a href="#cb106-1991" aria-hidden="true" tabindex="-1"></a>\mu_{i_j} &amp;= \beta_{0_j} + \beta_1 X_{i_j} &amp; \text{Linear model of within-group variation } <span class="sc">\\</span></span>
<span id="cb106-1992"><a href="#cb106-1992" aria-hidden="true" tabindex="-1"></a>\beta_{0_j} &amp;\sim \mathcal{N}(\beta_0, \sigma_0) &amp; \text{Random group-specific intercepts}</span>
<span id="cb106-1993"><a href="#cb106-1993" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb106-1994"><a href="#cb106-1994" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-1995"><a href="#cb106-1995" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1996"><a href="#cb106-1996" aria-hidden="true" tabindex="-1"></a>However, I actually like to think of these random effects in a slightly different way, where each group intercept is actually a combination of a global average ($\beta_0$) and a group-specific offset from that average ($b_{0_j}$), like this:</span>
<span id="cb106-1997"><a href="#cb106-1997" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1998"><a href="#cb106-1998" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-1999"><a href="#cb106-1999" aria-hidden="true" tabindex="-1"></a>\beta_{0_j} = \beta_0 + b_{0_j}</span>
<span id="cb106-2000"><a href="#cb106-2000" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-2001"><a href="#cb106-2001" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2002"><a href="#cb106-2002" aria-hidden="true" tabindex="-1"></a>That offset is assumed to be normally distributed with a mean of 0 ($\mathcal{N}(0, \sigma_0)$):</span>
<span id="cb106-2003"><a href="#cb106-2003" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2004"><a href="#cb106-2004" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-2005"><a href="#cb106-2005" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb106-2006"><a href="#cb106-2006" aria-hidden="true" tabindex="-1"></a>Y_{i_j} &amp;\sim \mathcal{N}(\mu_{i_j}, \sigma_y) &amp; \text{Outcome for individual}_i \text{ within group}_j <span class="sc">\\</span></span>
<span id="cb106-2007"><a href="#cb106-2007" aria-hidden="true" tabindex="-1"></a>\mu_{i_j} &amp;= (b_{0_j} + \beta_0) + \beta_1 X_{i_j} &amp; \text{Linear model of within-group variation } <span class="sc">\\</span></span>
<span id="cb106-2008"><a href="#cb106-2008" aria-hidden="true" tabindex="-1"></a>b_{0_j} &amp;\sim \mathcal{N}(0, \sigma_0) &amp; \text{Random group-specific offsets from global intercept}</span>
<span id="cb106-2009"><a href="#cb106-2009" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb106-2010"><a href="#cb106-2010" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-2011"><a href="#cb106-2011" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2012"><a href="#cb106-2012" aria-hidden="true" tabindex="-1"></a>I prefer this offset notation because it aligns with the output of {brms}, which reports population-level coefficients (i.e. the global average $\beta_0$) along with group-specific offsets from that average (i.e. $b_{0_j}$), which you can access with <span class="in">`ranef(model_name)`</span>.</span>
<span id="cb106-2013"><a href="#cb106-2013" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2014"><a href="#cb106-2014" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2015"><a href="#cb106-2015" aria-hidden="true" tabindex="-1"></a><span class="fu">### Random slopes</span></span>
<span id="cb106-2016"><a href="#cb106-2016" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2017"><a href="#cb106-2017" aria-hidden="true" tabindex="-1"></a>If you want group-specific intercepts *and* slopes, you can use a formula like this:</span>
<span id="cb106-2018"><a href="#cb106-2018" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2019"><a href="#cb106-2019" aria-hidden="true" tabindex="-1"></a><span class="in">``` r</span></span>
<span id="cb106-2020"><a href="#cb106-2020" aria-hidden="true" tabindex="-1"></a><span class="fu">bf</span>(y <span class="sc">~</span> x <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> x <span class="sc">|</span> group))</span>
<span id="cb106-2021"><a href="#cb106-2021" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-2022"><a href="#cb106-2022" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2023"><a href="#cb106-2023" aria-hidden="true" tabindex="-1"></a>The same dual syntax applies when using random slopes too. We can either use whole group-specific $\beta_{n_j}$ terms, or use offsets ($b_{n_j}$) from a global average slope ($\beta_n$). When working with random slopes, the math notation gets a little fancier because the random intercept and slope terms are actually correlated and move together across groups. The $\beta$ terms come from a multivariate (or joint) normal distribution with shared covariance. </span>
<span id="cb106-2024"><a href="#cb106-2024" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2025"><a href="#cb106-2025" aria-hidden="true" tabindex="-1"></a>With the complete β approach, we're estimating the joint distribution of $\begin{pmatrix} \beta_{0_j} <span class="sc">\\</span> \beta_{1_j} \end{pmatrix}$:</span>
<span id="cb106-2026"><a href="#cb106-2026" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2027"><a href="#cb106-2027" aria-hidden="true" tabindex="-1"></a>::: {.column-page-inset}</span>
<span id="cb106-2028"><a href="#cb106-2028" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2029"><a href="#cb106-2029" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-2030"><a href="#cb106-2030" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb106-2031"><a href="#cb106-2031" aria-hidden="true" tabindex="-1"></a>Y_{i_j} &amp;\sim \mathcal{N}(\mu_{i_j}, \sigma_y) &amp; \text{Outcome for individual}_i \text{ within group}_j <span class="sc">\\</span></span>
<span id="cb106-2032"><a href="#cb106-2032" aria-hidden="true" tabindex="-1"></a>\mu_{i_j} &amp;= \beta_{0_j} + \beta_{1_j} X_{i_j} &amp; \text{Linear model of within-group variation } <span class="sc">\\</span></span>
<span id="cb106-2033"><a href="#cb106-2033" aria-hidden="true" tabindex="-1"></a>\left(</span>
<span id="cb106-2034"><a href="#cb106-2034" aria-hidden="true" tabindex="-1"></a>  \begin{array}{c}</span>
<span id="cb106-2035"><a href="#cb106-2035" aria-hidden="true" tabindex="-1"></a>  \beta_{0_j} <span class="sc">\\</span></span>
<span id="cb106-2036"><a href="#cb106-2036" aria-hidden="true" tabindex="-1"></a>  \beta_{1_j}</span>
<span id="cb106-2037"><a href="#cb106-2037" aria-hidden="true" tabindex="-1"></a>  \end{array}</span>
<span id="cb106-2038"><a href="#cb106-2038" aria-hidden="true" tabindex="-1"></a>\right)</span>
<span id="cb106-2039"><a href="#cb106-2039" aria-hidden="true" tabindex="-1"></a>&amp;\sim \operatorname{MV}\, \mathcal{N}</span>
<span id="cb106-2040"><a href="#cb106-2040" aria-hidden="true" tabindex="-1"></a>\left(</span>
<span id="cb106-2041"><a href="#cb106-2041" aria-hidden="true" tabindex="-1"></a>  \left(</span>
<span id="cb106-2042"><a href="#cb106-2042" aria-hidden="true" tabindex="-1"></a>    \begin{array}{c}</span>
<span id="cb106-2043"><a href="#cb106-2043" aria-hidden="true" tabindex="-1"></a>    \beta_0 <span class="sc">\\</span></span>
<span id="cb106-2044"><a href="#cb106-2044" aria-hidden="true" tabindex="-1"></a>    \beta_1 <span class="sc">\\</span></span>
<span id="cb106-2045"><a href="#cb106-2045" aria-hidden="true" tabindex="-1"></a>    \end{array}</span>
<span id="cb106-2046"><a href="#cb106-2046" aria-hidden="true" tabindex="-1"></a>  \right)</span>
<span id="cb106-2047"><a href="#cb106-2047" aria-hidden="true" tabindex="-1"></a>  , \,</span>
<span id="cb106-2048"><a href="#cb106-2048" aria-hidden="true" tabindex="-1"></a>\left(</span>
<span id="cb106-2049"><a href="#cb106-2049" aria-hidden="true" tabindex="-1"></a>  \begin{array}{cc}</span>
<span id="cb106-2050"><a href="#cb106-2050" aria-hidden="true" tabindex="-1"></a>     \sigma^2_{\beta_0} &amp; \rho_{\beta_0, \beta_1}\, \sigma_{\beta_0} \sigma_{\beta_1} <span class="sc">\\</span></span>
<span id="cb106-2051"><a href="#cb106-2051" aria-hidden="true" tabindex="-1"></a>     \dots &amp; \sigma^2_{\beta_1}</span>
<span id="cb106-2052"><a href="#cb106-2052" aria-hidden="true" tabindex="-1"></a>  \end{array}</span>
<span id="cb106-2053"><a href="#cb106-2053" aria-hidden="true" tabindex="-1"></a>\right)</span>
<span id="cb106-2054"><a href="#cb106-2054" aria-hidden="true" tabindex="-1"></a>\right) &amp; \text{Random group-specific slopes and intercepts}</span>
<span id="cb106-2055"><a href="#cb106-2055" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb106-2056"><a href="#cb106-2056" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-2057"><a href="#cb106-2057" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2058"><a href="#cb106-2058" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb106-2059"><a href="#cb106-2059" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2060"><a href="#cb106-2060" aria-hidden="true" tabindex="-1"></a>With the offset approach, we're estimating the joint distribution of the offsets from the global intercept and slope, or $\begin{pmatrix} b_{0_j} <span class="sc">\\</span> b_{1_j} \end{pmatrix}$:</span>
<span id="cb106-2061"><a href="#cb106-2061" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2062"><a href="#cb106-2062" aria-hidden="true" tabindex="-1"></a>::: {.column-page-inset}</span>
<span id="cb106-2063"><a href="#cb106-2063" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2064"><a href="#cb106-2064" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-2065"><a href="#cb106-2065" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb106-2066"><a href="#cb106-2066" aria-hidden="true" tabindex="-1"></a>Y_{i_j} &amp;\sim \mathcal{N}(\mu_{i_j}, \sigma_y) &amp; \text{Outcome for individual}_i \text{ within group}_j <span class="sc">\\</span></span>
<span id="cb106-2067"><a href="#cb106-2067" aria-hidden="true" tabindex="-1"></a>\mu_{i_j} &amp;= (b_{0_j} + \beta_0) + (b_{1_j} + \beta_1) X_{i_j} &amp; \text{Linear model of within-group variation } <span class="sc">\\</span></span>
<span id="cb106-2068"><a href="#cb106-2068" aria-hidden="true" tabindex="-1"></a>\left(</span>
<span id="cb106-2069"><a href="#cb106-2069" aria-hidden="true" tabindex="-1"></a>  \begin{array}{c}</span>
<span id="cb106-2070"><a href="#cb106-2070" aria-hidden="true" tabindex="-1"></a>  b_{0_j} <span class="sc">\\</span></span>
<span id="cb106-2071"><a href="#cb106-2071" aria-hidden="true" tabindex="-1"></a>  b_{1_j}</span>
<span id="cb106-2072"><a href="#cb106-2072" aria-hidden="true" tabindex="-1"></a>  \end{array}</span>
<span id="cb106-2073"><a href="#cb106-2073" aria-hidden="true" tabindex="-1"></a>\right)</span>
<span id="cb106-2074"><a href="#cb106-2074" aria-hidden="true" tabindex="-1"></a>&amp;\sim \operatorname{MV}\, \mathcal{N}</span>
<span id="cb106-2075"><a href="#cb106-2075" aria-hidden="true" tabindex="-1"></a>\left(</span>
<span id="cb106-2076"><a href="#cb106-2076" aria-hidden="true" tabindex="-1"></a>  \left(</span>
<span id="cb106-2077"><a href="#cb106-2077" aria-hidden="true" tabindex="-1"></a>    \begin{array}{c}</span>
<span id="cb106-2078"><a href="#cb106-2078" aria-hidden="true" tabindex="-1"></a>    0 <span class="sc">\\</span></span>
<span id="cb106-2079"><a href="#cb106-2079" aria-hidden="true" tabindex="-1"></a>    0 <span class="sc">\\</span></span>
<span id="cb106-2080"><a href="#cb106-2080" aria-hidden="true" tabindex="-1"></a>    \end{array}</span>
<span id="cb106-2081"><a href="#cb106-2081" aria-hidden="true" tabindex="-1"></a>  \right)</span>
<span id="cb106-2082"><a href="#cb106-2082" aria-hidden="true" tabindex="-1"></a>  , \,</span>
<span id="cb106-2083"><a href="#cb106-2083" aria-hidden="true" tabindex="-1"></a>\left(</span>
<span id="cb106-2084"><a href="#cb106-2084" aria-hidden="true" tabindex="-1"></a>  \begin{array}{cc}</span>
<span id="cb106-2085"><a href="#cb106-2085" aria-hidden="true" tabindex="-1"></a>     \sigma^2_{\beta_0} &amp; \rho_{\beta_0, \beta_1}\, \sigma_{\beta_0} \sigma_{\beta_1} <span class="sc">\\</span></span>
<span id="cb106-2086"><a href="#cb106-2086" aria-hidden="true" tabindex="-1"></a>     \dots &amp; \sigma^2_{\beta_1}</span>
<span id="cb106-2087"><a href="#cb106-2087" aria-hidden="true" tabindex="-1"></a>  \end{array}</span>
<span id="cb106-2088"><a href="#cb106-2088" aria-hidden="true" tabindex="-1"></a>\right)</span>
<span id="cb106-2089"><a href="#cb106-2089" aria-hidden="true" tabindex="-1"></a>\right) &amp; \text{Random group-specific offsets from global intercept and slope}</span>
<span id="cb106-2090"><a href="#cb106-2090" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb106-2091"><a href="#cb106-2091" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-2092"><a href="#cb106-2092" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2093"><a href="#cb106-2093" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb106-2094"><a href="#cb106-2094" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2095"><a href="#cb106-2095" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2096"><a href="#cb106-2096" aria-hidden="true" tabindex="-1"></a><span class="fu">### Summary table</span></span>
<span id="cb106-2097"><a href="#cb106-2097" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2098"><a href="#cb106-2098" aria-hidden="true" tabindex="-1"></a>And here's a helpful little table summarizing these two types of notation (mostly for future me).</span>
<span id="cb106-2099"><a href="#cb106-2099" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2100"><a href="#cb106-2100" aria-hidden="true" tabindex="-1"></a>::: {.column-page-inset}</span>
<span id="cb106-2101"><a href="#cb106-2101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2102"><a href="#cb106-2102" aria-hidden="true" tabindex="-1"></a>|                          | Formula syntax            |                                                                                                                                                                                                                                                           Full $\beta$ notation                                                                                                                                                                                                                                                            |                                                                                                                                                                                                                                                                                                   Offset notation                                                                                                                                                                                                                                                                                                   |</span>
<span id="cb106-2103"><a href="#cb106-2103" aria-hidden="true" tabindex="-1"></a>|----------------|----------------|:------------------:|:------------------:|</span>
<span id="cb106-2104"><a href="#cb106-2104" aria-hidden="true" tabindex="-1"></a>| Random intercept         | <span class="in">`y ~ x + (1 | group)`</span>     | $$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </span>
<span id="cb106-2105"><a href="#cb106-2105" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                                                  \begin{aligned}                                                                                                                                                                                                                                   </span>
<span id="cb106-2106"><a href="#cb106-2106" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                     Y_{i_j} &amp;\sim \mathcal{N}(\mu_{i_j}, \sigma_y) <span class="sc">\\</span>                                                                                                                                                                                                                                              </span>
<span id="cb106-2107"><a href="#cb106-2107" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                       \mu_{i_j} &amp;= \beta_{0_j} + \beta_1 X_{i_j} <span class="sc">\\</span>                                                                                                                                                                                                                                                </span>
<span id="cb106-2108"><a href="#cb106-2108" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                      \beta_{0_j} &amp;\sim \mathcal{N}(\beta_0, \sigma_0)                                                                                                                                                                                                                                              </span>
<span id="cb106-2109"><a href="#cb106-2109" aria-hidden="true" tabindex="-1"></a>                                                                                                                                       \end{aligned}                                                                                                                                                                                                                                                                                                                                                                                                                                                </span>
<span id="cb106-2110"><a href="#cb106-2110" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                                                        $$                                                                                                                                                                                                                                          |                                        $$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           </span>
<span id="cb106-2111"><a href="#cb106-2111" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          \begin{aligned} </span>
<span id="cb106-2112"><a href="#cb106-2112" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       Y_{i_j} &amp;\sim \mathcal{N}(\mu_{i_j}, \sigma_y) <span class="sc">\\</span>                                                                                                                                                                                                                                                                                  </span>
<span id="cb106-2113"><a href="#cb106-2113" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     \mu_{i_j} &amp;= (b_{0_j} + \beta_0) + \beta_1 X_{i_j} <span class="sc">\\</span>                                                                                                                                                                                                                                                                                </span>
<span id="cb106-2114"><a href="#cb106-2114" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            b_{0_j} &amp;\sim \mathcal{N}(0, \sigma_0)                                                                                                                                                                                                                                                                                        </span>
<span id="cb106-2115"><a href="#cb106-2115" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         \end{aligned}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </span>
<span id="cb106-2116"><a href="#cb106-2116" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                $$        |</span>
<span id="cb106-2117"><a href="#cb106-2117" aria-hidden="true" tabindex="-1"></a>| Random intercept + slope | <span class="in">`y ~ x + (1 + x | group)`</span> | $$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </span>
<span id="cb106-2118"><a href="#cb106-2118" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                                                  \begin{aligned}                                                                                                                                                                                                                                   </span>
<span id="cb106-2119"><a href="#cb106-2119" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                     Y_{i_j} &amp;\sim \mathcal{N}(\mu_{i_j}, \sigma_y) <span class="sc">\\</span>                                                                                                                                                                                                                                              </span>
<span id="cb106-2120"><a href="#cb106-2120" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                     \mu_{i_j} &amp;= \beta_{0_j} + \beta_{1_j} X_{i_j} <span class="sc">\\</span>                                                                                                                                                                                                                                              </span>
<span id="cb106-2121"><a href="#cb106-2121" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                           \left(                                                                                                                                                                                                                                                                   </span>
<span id="cb106-2122"><a href="#cb106-2122" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                       \begin{array}{c}                                                                                                                                                                                                                                                             </span>
<span id="cb106-2123"><a href="#cb106-2123" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                        \beta_{0_j} <span class="sc">\\</span>                                                                                                                                                                                                                                                              </span>
<span id="cb106-2124"><a href="#cb106-2124" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                         \beta_{1_j}                                                                                                                                                                                                                                                                </span>
<span id="cb106-2125"><a href="#cb106-2125" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                         \end{array}                                                                                                                                                                                                                                                                </span>
<span id="cb106-2126"><a href="#cb106-2126" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                          \right)                                                                                                                                                                                                                                                                   </span>
<span id="cb106-2127"><a href="#cb106-2127" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                           &amp;\sim \operatorname{MV}\, \mathcal{N}                                                                                                                                                                                                                                                    </span>
<span id="cb106-2128"><a href="#cb106-2128" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                           \left(                                                                                                                                                                                                                                                                   </span>
<span id="cb106-2129"><a href="#cb106-2129" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                            \left(                                                                                                                                                                                                                                                                  </span>
<span id="cb106-2130"><a href="#cb106-2130" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                        \begin{array}{c}                                                                                                                                                                                                                                                            </span>
<span id="cb106-2131"><a href="#cb106-2131" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                           \beta_0 <span class="sc">\\</span>                                                                                                                                                                                                                                                               </span>
<span id="cb106-2132"><a href="#cb106-2132" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                           \beta_1 <span class="sc">\\</span>                                                                                                                                                                                                                                                               </span>
<span id="cb106-2133"><a href="#cb106-2133" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                          \end{array}                                                                                                                                                                                                                                                               </span>
<span id="cb106-2134"><a href="#cb106-2134" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                           \right)                                                                                                                                                                                                                                                                  </span>
<span id="cb106-2135"><a href="#cb106-2135" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                         , \, \Sigma                                                                                                                                                                                                                                                                </span>
<span id="cb106-2136"><a href="#cb106-2136" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                         \right) <span class="sc">\\</span>                                                                                                                                                                                                                                                                 </span>
<span id="cb106-2137"><a href="#cb106-2137" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                        \Sigma &amp;\sim                                                                                                                                                                                                                                                                </span>
<span id="cb106-2138"><a href="#cb106-2138" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                           \left(                                                                                                                                                                                                                                                                   </span>
<span id="cb106-2139"><a href="#cb106-2139" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                      \begin{array}{cc}                                                                                                                                                                                                                                                             </span>
<span id="cb106-2140"><a href="#cb106-2140" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                       \sigma^2_{\beta_0} &amp; \rho_{\beta_0, \beta_1}\, \sigma_{\beta_0} \sigma_{\beta_1} <span class="sc">\\</span>                                                                                                                                                                                                                          </span>
<span id="cb106-2141"><a href="#cb106-2141" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                   \dots &amp; \sigma^2_{\beta_1}                                                                                                                                                                                                                                                       </span>
<span id="cb106-2142"><a href="#cb106-2142" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                         \end{array}                                                                                                                                                                                                                                                                </span>
<span id="cb106-2143"><a href="#cb106-2143" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                          \right)                                                                                                                                                                                                                                                                   </span>
<span id="cb106-2144"><a href="#cb106-2144" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                      \end{aligned}                                                                                                                                                                                                                                                                 </span>
<span id="cb106-2145"><a href="#cb106-2145" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                                                        $$                                                                                                                                                                                                                                          |                                        $$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           </span>
<span id="cb106-2146"><a href="#cb106-2146" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          \begin{aligned} </span>
<span id="cb106-2147"><a href="#cb106-2147" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       Y_{i_j} &amp;\sim \mathcal{N}(\mu_{i_j}, \sigma_y) <span class="sc">\\</span>                                                                                                                                                                                                                                                                                  </span>
<span id="cb106-2148"><a href="#cb106-2148" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               \mu_{i_j} &amp;= (b_{0_j} + \beta_0) + (b_{1_j} + \beta_1) X_{i_j} <span class="sc">\\</span>                                                                                                                                                                                                                                                                          </span>
<span id="cb106-2149"><a href="#cb106-2149" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            \left(                                                                                                                                                                                                                                                                                                        </span>
<span id="cb106-2150"><a href="#cb106-2150" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \begin{array}{c}                                                                                                                                                                                                                                                                                                  </span>
<span id="cb106-2151"><a href="#cb106-2151" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           b_{0_j} <span class="sc">\\</span>                                                                                                                                                                                                                                                                                                     </span>
<span id="cb106-2152"><a href="#cb106-2152" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             b_{1_j}                                                                                                                                                                                                                                                                                                      </span>
<span id="cb106-2153"><a href="#cb106-2153" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           \end{array}                                                                                                                                                                                                                                                                                                    </span>
<span id="cb106-2154"><a href="#cb106-2154" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            \right)                                                                                                                                                                                                                                                                                                       </span>
<span id="cb106-2155"><a href="#cb106-2155" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             &amp;\sim \operatorname{MV}\, \mathcal{N}                                                                                                                                                                                                                                                                                        </span>
<span id="cb106-2156"><a href="#cb106-2156" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            \left(                                                                                                                                                                                                                                                                                                        </span>
<span id="cb106-2157"><a href="#cb106-2157" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             \left(                                                                                                                                                                                                                                                                                                       </span>
<span id="cb106-2158"><a href="#cb106-2158" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         \begin{array}{c}                                                                                                                                                                                                                                                                                                 </span>
<span id="cb106-2159"><a href="#cb106-2159" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               0 <span class="sc">\\</span>                                                                                                                                                                                                                                                                                                       </span>
<span id="cb106-2160"><a href="#cb106-2160" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               0 <span class="sc">\\</span>                                                                                                                                                                                                                                                                                                       </span>
<span id="cb106-2161"><a href="#cb106-2161" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            \end{array}                                                                                                                                                                                                                                                                                                   </span>
<span id="cb106-2162"><a href="#cb106-2162" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             \right)                                                                                                                                                                                                                                                                                                      </span>
<span id="cb106-2163"><a href="#cb106-2163" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           , \, \Sigma                                                                                                                                                                                                                                                                                                    </span>
<span id="cb106-2164"><a href="#cb106-2164" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          \right) <span class="sc">\\</span>                                                                                                                                                                                                                                                                                                      </span>
<span id="cb106-2165"><a href="#cb106-2165" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         \Sigma &amp;\sim                                                                                                                                                                                                                                                                                                     </span>
<span id="cb106-2166"><a href="#cb106-2166" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            \left(                                                                                                                                                                                                                                                                                                        </span>
<span id="cb106-2167"><a href="#cb106-2167" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \begin{array}{cc}                                                                                                                                                                                                                                                                                                 </span>
<span id="cb106-2168"><a href="#cb106-2168" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \sigma^2_{\beta_0} &amp; \rho_{\beta_0, \beta_1}\, \sigma_{\beta_0} \sigma_{\beta_1} <span class="sc">\\</span>                                                                                                                                                                                                                                                               </span>
<span id="cb106-2169"><a href="#cb106-2169" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     \dots &amp; \sigma^2_{\beta_1}                                                                                                                                                                                                                                                                                           </span>
<span id="cb106-2170"><a href="#cb106-2170" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           \end{array}                                                                                                                                                                                                                                                                                                    </span>
<span id="cb106-2171"><a href="#cb106-2171" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            \right)                                                                                                                                                                                                                                                                                                       </span>
<span id="cb106-2172"><a href="#cb106-2172" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \end{aligned}                                                                                                                                                                                                                                                                                                     </span>
<span id="cb106-2173"><a href="#cb106-2173" aria-hidden="true" tabindex="-1"></a>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                $$        |</span>
<span id="cb106-2174"><a href="#cb106-2174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2175"><a href="#cb106-2175" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb106-2176"><a href="#cb106-2176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2177"><a href="#cb106-2177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2178"><a href="#cb106-2178" aria-hidden="true" tabindex="-1"></a><span class="fu">## Translating from marketing-style Stan notation to {brms} syntax</span></span>
<span id="cb106-2179"><a href="#cb106-2179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2180"><a href="#cb106-2180" aria-hidden="true" tabindex="-1"></a>In @ChapmanFeit:2019 and in all the marketing papers I've seen that use hierarchical Bayesian models—and even one I coauthored! <span class="co">[</span><span class="ot">@ChaudhryDotsonHeiss:2021</span><span class="co">]</span> (<span class="co">[</span><span class="ot">see the appendix</span><span class="co">](https://stats.andrewheiss.com/who-cares-about-crackdowns/output/appendix.html#model-details)</span>)—they define their models using notation like this:</span>
<span id="cb106-2181"><a href="#cb106-2181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2182"><a href="#cb106-2182" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-2183"><a href="#cb106-2183" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb106-2184"><a href="#cb106-2184" aria-hidden="true" tabindex="-1"></a>\text{Choice} &amp;\sim \operatorname{Multinomial\ logit}(\beta X) &amp; \text{where } X = \text{feature levels} <span class="sc">\\</span></span>
<span id="cb106-2185"><a href="#cb106-2185" aria-hidden="true" tabindex="-1"></a>\beta &amp;\sim \operatorname{Multivariate} \mathcal{N}(\gamma Z, \Sigma) &amp; \text{where } Z = \text{individual characteristics}</span>
<span id="cb106-2186"><a href="#cb106-2186" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb106-2187"><a href="#cb106-2187" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-2188"><a href="#cb106-2188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2189"><a href="#cb106-2189" aria-hidden="true" tabindex="-1"></a>For the longest time this threw me off because it's slightly different from the two different notations we just reviewed (full βs vs. offsets from global β), and I figured that specifying a model like this with {brms} was impossible. The main reason for my confusion is that there are two different datasets involved in this model, and {brms} can only really work with one dataset. </span>
<span id="cb106-2190"><a href="#cb106-2190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2191"><a href="#cb106-2191" aria-hidden="true" tabindex="-1"></a>In raw Stan (like <span class="co">[</span><span class="ot">in this tutorial on conjoint hierarchical Bayes models</span><span class="co">](https://github.com/ksvanhorn/ART-Forum-2017-Stan-Tutorial)</span>, or in <span class="co">[</span><span class="ot">this example of a different conjoint hierarchical model</span><span class="co">](https://github.com/Bartosz-G/Conjoint-Analysis-in-R/)</span>), you'd typically work with two different datasets or matrices: one $X$ with feature levels and one $Z$ with respondent-level characteristics. (<span class="co">[</span><span class="ot">This is actually the recommended way to write hierarchical models in raw Stan!</span><span class="co">](https://mc-stan.org/docs/stan-users-guide/multivariate-hierarchical-priors.html)</span>).</span>
<span id="cb106-2192"><a href="#cb106-2192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2193"><a href="#cb106-2193" aria-hidden="true" tabindex="-1"></a>Here's what separate $X$ and $Z$ matrices would look like with the minivan data—<span class="in">`X`</span> contains the full data without respondent-level covariates like <span class="in">`carpool`</span> and it has 9,000 rows; <span class="in">`Z`</span> contains only respondent-level characteristics like <span class="in">`carpool`</span> and it only has 200 rows (one per respondent).</span>
<span id="cb106-2194"><a href="#cb106-2194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2195"><a href="#cb106-2195" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-x-z}</span></span>
<span id="cb106-2196"><a href="#cb106-2196" aria-hidden="true" tabindex="-1"></a><span class="in">X &lt;- minivans %&gt;% select(-carpool)</span></span>
<span id="cb106-2197"><a href="#cb106-2197" aria-hidden="true" tabindex="-1"></a><span class="in">X</span></span>
<span id="cb106-2198"><a href="#cb106-2198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2199"><a href="#cb106-2199" aria-hidden="true" tabindex="-1"></a><span class="in">Z &lt;- minivans %&gt;% </span></span>
<span id="cb106-2200"><a href="#cb106-2200" aria-hidden="true" tabindex="-1"></a><span class="in">  # Only keep the first row of each respondent</span></span>
<span id="cb106-2201"><a href="#cb106-2201" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(resp.id) %&gt;% slice(1) %&gt;% ungroup() %&gt;% </span></span>
<span id="cb106-2202"><a href="#cb106-2202" aria-hidden="true" tabindex="-1"></a><span class="in">  # Only keep the respondent-level columns</span></span>
<span id="cb106-2203"><a href="#cb106-2203" aria-hidden="true" tabindex="-1"></a><span class="in">  select(resp.id, carpool)</span></span>
<span id="cb106-2204"><a href="#cb106-2204" aria-hidden="true" tabindex="-1"></a><span class="in">Z</span></span>
<span id="cb106-2205"><a href="#cb106-2205" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-2206"><a href="#cb106-2206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2207"><a href="#cb106-2207" aria-hidden="true" tabindex="-1"></a><span class="in">`X`</span> and <span class="in">`Z`</span> are then passed to Stan as separate matrices and used at different places in the model fitting process. Here's what that looks like in pseudo-Stan code. The matrix of individual characteristics <span class="in">`Z`</span> is matrix-multiplied with a bunch of estimated $\gamma$ coefficients (<span class="in">`Gamma`</span> here) to generate individual-specific $\beta$ coefficients (<span class="in">`Beta`</span> here). The matrix of choices <span class="in">`X`</span> is then matrix-multiplied with the individual-specific $\beta$ coefficients to generate predicted outcomes (<span class="in">`Y`</span> here). </span>
<span id="cb106-2208"><a href="#cb106-2208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2209"><a href="#cb106-2209" aria-hidden="true" tabindex="-1"></a><span class="in">``` stan</span></span>
<span id="cb106-2210"><a href="#cb106-2210" aria-hidden="true" tabindex="-1"></a><span class="in">for (r in 1:n_respondents) {</span></span>
<span id="cb106-2211"><a href="#cb106-2211" aria-hidden="true" tabindex="-1"></a><span class="in">  // All the individual-specific slopes and intercepts</span></span>
<span id="cb106-2212"><a href="#cb106-2212" aria-hidden="true" tabindex="-1"></a><span class="in">  Beta[,r] ~ multi_normal(Gamma * Z[,r], ...);</span></span>
<span id="cb106-2213"><a href="#cb106-2213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2214"><a href="#cb106-2214" aria-hidden="true" tabindex="-1"></a><span class="in">  // All the question-level outcomes, using individual-specific slopes and intercepts</span></span>
<span id="cb106-2215"><a href="#cb106-2215" aria-hidden="true" tabindex="-1"></a><span class="in">  for (s in 1:n_questions) {</span></span>
<span id="cb106-2216"><a href="#cb106-2216" aria-hidden="true" tabindex="-1"></a><span class="in">     Y[r,s] ~ categorical_logit( X [r,s] * Beta[,r]);</span></span>
<span id="cb106-2217"><a href="#cb106-2217" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb106-2218"><a href="#cb106-2218" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb106-2219"><a href="#cb106-2219" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-2220"><a href="#cb106-2220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2221"><a href="#cb106-2221" aria-hidden="true" tabindex="-1"></a>That's a neat way of working with multilevel models, but it's different from how I've always worked with them (and it requires working with raw Stan). As seen throughout this post, I'm a fan of {brms}'s formula-style syntax for specifying multilevel models, but {brms} can only work with one dataset at a time—you can't pass it both <span class="in">`X`</span> and <span class="in">`Z`</span> like you'd do with raw Stan. So I (naively) figured that this went beyond {brms}'s abilities and was only possible with raw Stan.</span>
<span id="cb106-2222"><a href="#cb106-2222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2223"><a href="#cb106-2223" aria-hidden="true" tabindex="-1"></a>However, if we use {brms}'s <span class="co">[</span><span class="ot">special formula syntax</span><span class="co">](https://cran.r-project.org/web/packages/brms/vignettes/brms_multilevel.pdf)</span>, we can actually specify an identical model with only one dataset (again, <span class="co">[</span><span class="ot">see this for a fantastic overview of the syntax</span><span class="co">](https://bbolker.github.io/mixedmodels-misc/glmmFAQ.html#model-specification)</span>).</span>
<span id="cb106-2224"><a href="#cb106-2224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2225"><a href="#cb106-2225" aria-hidden="true" tabindex="-1"></a>First, let's look at the marketing-style syntax again:</span>
<span id="cb106-2226"><a href="#cb106-2226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2227"><a href="#cb106-2227" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-2228"><a href="#cb106-2228" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb106-2229"><a href="#cb106-2229" aria-hidden="true" tabindex="-1"></a>\text{Choice} &amp;\sim \operatorname{Multinomial\ logit}(\beta X) &amp; \text{where } X = \text{feature levels} <span class="sc">\\</span></span>
<span id="cb106-2230"><a href="#cb106-2230" aria-hidden="true" tabindex="-1"></a>\beta &amp;\sim \operatorname{Multivariate} \mathcal{N}(\gamma Z, \Sigma) &amp; \text{where } Z = \text{individual characteristics}</span>
<span id="cb106-2231"><a href="#cb106-2231" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb106-2232"><a href="#cb106-2232" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-2233"><a href="#cb106-2233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2234"><a href="#cb106-2234" aria-hidden="true" tabindex="-1"></a>This is actually just a kind of *really* compact notation. That second line with the $\beta \sim \operatorname{Multivariate}\, \mathcal{N}(\cdot)$ distribution is a shorthand version of the full-β syntax from earlier. To illustrate this, let's expand this out to a more complete formal definition of the model. Instead of using $X$ to stand in for all the feature levels and $Z$ for all the individual characteristics, we'll expand those to include all the covariates we're using. And instead of calling the distribution "Multinomial logit" we'll call it "Categorical" so it aligns with Stan. It'll make for a *really massive formula*, but it shows what's really going on.</span>
<span id="cb106-2235"><a href="#cb106-2235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2236"><a href="#cb106-2236" aria-hidden="true" tabindex="-1"></a>::: {.column-page-inset}</span>
<span id="cb106-2237"><a href="#cb106-2237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2238"><a href="#cb106-2238" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-2239"><a href="#cb106-2239" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb106-2240"><a href="#cb106-2240" aria-hidden="true" tabindex="-1"></a>&amp;\ \textbf{Multinomial probability of selection of choice}_i \textbf{ in respondent}_j <span class="sc">\\</span></span>
<span id="cb106-2241"><a href="#cb106-2241" aria-hidden="true" tabindex="-1"></a>\text{Choice}_{i_j} \sim&amp;\ \operatorname{Categorical}(\{\mu_{1,i_j}, \mu_{2,i_j}, \mu_{3,i_j}<span class="sc">\}</span>) <span class="sc">\\</span><span class="co">[</span><span class="ot">10pt</span><span class="co">]</span></span>
<span id="cb106-2242"><a href="#cb106-2242" aria-hidden="true" tabindex="-1"></a>&amp;\ \textbf{Model for probability of each option} <span class="sc">\\</span></span>
<span id="cb106-2243"><a href="#cb106-2243" aria-hidden="true" tabindex="-1"></a><span class="sc">\{</span>\mu_{1,i_j}, \mu_{2,i_j}, \mu_{3,i_j}<span class="sc">\}</span> =&amp;\ \beta_{0_j} + \beta_{1_j} \text{Seat<span class="co">[</span><span class="ot">7</span><span class="co">]</span>}_{i_j} + \beta_{2_j} \text{Seat[8]}_{i_j} + \beta_{3_j} \text{Cargo[3ft]}_{i_j} + <span class="sc">\\</span></span>
<span id="cb106-2244"><a href="#cb106-2244" aria-hidden="true" tabindex="-1"></a>&amp;\ \beta_{4_j} \text{Engine<span class="co">[</span><span class="ot">hyb</span><span class="co">]</span>}_{i_j} + \beta_{5_j} \text{Engine[elec]}_{i_j} + <span class="sc">\\</span></span>
<span id="cb106-2245"><a href="#cb106-2245" aria-hidden="true" tabindex="-1"></a>&amp;\ \beta_{6_j} \text{Price<span class="co">[</span><span class="ot">35k</span><span class="co">]</span>}_{i_j} + \beta_{7_j} \text{Price[40k]}_{i_j} <span class="sc">\\</span><span class="co">[</span><span class="ot">20pt</span><span class="co">]</span>  </span>
<span id="cb106-2246"><a href="#cb106-2246" aria-hidden="true" tabindex="-1"></a>&amp;\ \textbf{Respondent-specific slopes} <span class="sc">\\</span></span>
<span id="cb106-2247"><a href="#cb106-2247" aria-hidden="true" tabindex="-1"></a>\left(</span>
<span id="cb106-2248"><a href="#cb106-2248" aria-hidden="true" tabindex="-1"></a>  \begin{array}{c} </span>
<span id="cb106-2249"><a href="#cb106-2249" aria-hidden="true" tabindex="-1"></a>    \begin{aligned}</span>
<span id="cb106-2250"><a href="#cb106-2250" aria-hidden="true" tabindex="-1"></a>      &amp;\beta_{0_j} <span class="sc">\\</span></span>
<span id="cb106-2251"><a href="#cb106-2251" aria-hidden="true" tabindex="-1"></a>      &amp;\beta_{1_j} <span class="sc">\\</span></span>
<span id="cb106-2252"><a href="#cb106-2252" aria-hidden="true" tabindex="-1"></a>      &amp;\beta_{2_j} <span class="sc">\\</span></span>
<span id="cb106-2253"><a href="#cb106-2253" aria-hidden="true" tabindex="-1"></a>      &amp;\beta_{3_j} <span class="sc">\\</span></span>
<span id="cb106-2254"><a href="#cb106-2254" aria-hidden="true" tabindex="-1"></a>      &amp;\beta_{4_j} <span class="sc">\\</span></span>
<span id="cb106-2255"><a href="#cb106-2255" aria-hidden="true" tabindex="-1"></a>      &amp;\beta_{5_j} <span class="sc">\\</span></span>
<span id="cb106-2256"><a href="#cb106-2256" aria-hidden="true" tabindex="-1"></a>      &amp;\beta_{6_j} <span class="sc">\\</span></span>
<span id="cb106-2257"><a href="#cb106-2257" aria-hidden="true" tabindex="-1"></a>      &amp;\beta_{7_j}</span>
<span id="cb106-2258"><a href="#cb106-2258" aria-hidden="true" tabindex="-1"></a>    \end{aligned}</span>
<span id="cb106-2259"><a href="#cb106-2259" aria-hidden="true" tabindex="-1"></a>  \end{array}</span>
<span id="cb106-2260"><a href="#cb106-2260" aria-hidden="true" tabindex="-1"></a>\right) \sim&amp;\ \operatorname{Multivariate}\ \mathcal{N} \left[</span>
<span id="cb106-2261"><a href="#cb106-2261" aria-hidden="true" tabindex="-1"></a>\left(</span>
<span id="cb106-2262"><a href="#cb106-2262" aria-hidden="true" tabindex="-1"></a>  \begin{array}{c} </span>
<span id="cb106-2263"><a href="#cb106-2263" aria-hidden="true" tabindex="-1"></a>    \begin{aligned}</span>
<span id="cb106-2264"><a href="#cb106-2264" aria-hidden="true" tabindex="-1"></a>      &amp;\gamma^{\beta_{0}}_{0} + \gamma^{\beta_{0}}_{1}\text{Carpool} <span class="sc">\\</span></span>
<span id="cb106-2265"><a href="#cb106-2265" aria-hidden="true" tabindex="-1"></a>      &amp;\gamma^{\beta_{1}}_{0} + \gamma^{\beta_{1}}_{1}\text{Carpool} <span class="sc">\\</span></span>
<span id="cb106-2266"><a href="#cb106-2266" aria-hidden="true" tabindex="-1"></a>      &amp;\gamma^{\beta_{2}}_{0} + \gamma^{\beta_{2}}_{1}\text{Carpool} <span class="sc">\\</span></span>
<span id="cb106-2267"><a href="#cb106-2267" aria-hidden="true" tabindex="-1"></a>      &amp;\gamma^{\beta_{3}}_{0} + \gamma^{\beta_{3}}_{1}\text{Carpool} <span class="sc">\\</span></span>
<span id="cb106-2268"><a href="#cb106-2268" aria-hidden="true" tabindex="-1"></a>      &amp;\gamma^{\beta_{4}}_{0} + \gamma^{\beta_{4}}_{1}\text{Carpool} <span class="sc">\\</span></span>
<span id="cb106-2269"><a href="#cb106-2269" aria-hidden="true" tabindex="-1"></a>      &amp;\gamma^{\beta_{5}}_{0} + \gamma^{\beta_{5}}_{1}\text{Carpool} <span class="sc">\\</span></span>
<span id="cb106-2270"><a href="#cb106-2270" aria-hidden="true" tabindex="-1"></a>      &amp;\gamma^{\beta_{6}}_{0} + \gamma^{\beta_{6}}_{1}\text{Carpool} <span class="sc">\\</span></span>
<span id="cb106-2271"><a href="#cb106-2271" aria-hidden="true" tabindex="-1"></a>      &amp;\gamma^{\beta_{7}}_{0} + \gamma^{\beta_{7}}_{1}\text{Carpool}</span>
<span id="cb106-2272"><a href="#cb106-2272" aria-hidden="true" tabindex="-1"></a>    \end{aligned}</span>
<span id="cb106-2273"><a href="#cb106-2273" aria-hidden="true" tabindex="-1"></a>  \end{array}</span>
<span id="cb106-2274"><a href="#cb106-2274" aria-hidden="true" tabindex="-1"></a>\right)</span>
<span id="cb106-2275"><a href="#cb106-2275" aria-hidden="true" tabindex="-1"></a>, </span>
<span id="cb106-2276"><a href="#cb106-2276" aria-hidden="true" tabindex="-1"></a>\left(</span>
<span id="cb106-2277"><a href="#cb106-2277" aria-hidden="true" tabindex="-1"></a>  \begin{array}{cccccccc}</span>
<span id="cb106-2278"><a href="#cb106-2278" aria-hidden="true" tabindex="-1"></a>     \sigma^2_{\beta_{0j}} &amp; \rho_{\beta_{0j}\beta_{1j}} &amp; \rho_{\beta_{0j}\beta_{2j}} &amp; \rho_{\beta_{0j}\beta_{3j}} &amp; \rho_{\beta_{0j}\beta_{4j}} &amp; \rho_{\beta_{0j}\beta_{5j}} &amp; \rho_{\beta_{0j}\beta_{6j}} &amp; \rho_{\beta_{0j}\beta_{7j}} <span class="sc">\\</span> </span>
<span id="cb106-2279"><a href="#cb106-2279" aria-hidden="true" tabindex="-1"></a>     \dots &amp; \sigma^2_{\beta_{1j}} &amp; \rho_{\beta_{1j}\beta_{2j}} &amp; \rho_{\beta_{1j}\beta_{3j}} &amp; \rho_{\beta_{1j}\beta_{4j}} &amp; \rho_{\beta_{1j}\beta_{5j}} &amp; \rho_{\beta_{1j}\beta_{6j}} &amp; \rho_{\beta_{1j}\beta_{7j}} <span class="sc">\\</span> </span>
<span id="cb106-2280"><a href="#cb106-2280" aria-hidden="true" tabindex="-1"></a>     \dots &amp; \dots &amp; \sigma^2_{\beta_{2j}} &amp; \rho_{\beta_{2j}\beta_{3j}} &amp; \rho_{\beta_{2j}\beta_{4j}} &amp; \rho_{\beta_{2j}\beta_{5j}} &amp; \rho_{\beta_{2j}\beta_{6j}} &amp; \rho_{\beta_{2j}\beta_{7j}} <span class="sc">\\</span> </span>
<span id="cb106-2281"><a href="#cb106-2281" aria-hidden="true" tabindex="-1"></a>     \dots &amp; \dots &amp; \dots &amp; \sigma^2_{\beta_{3j}} &amp; \rho_{\beta_{3j}\beta_{4j}} &amp; \rho_{\beta_{3j}\beta_{5j}} &amp; \rho_{\beta_{3j}\beta_{6j}} &amp; \rho_{\beta_{3j}\beta_{7j}} <span class="sc">\\</span> </span>
<span id="cb106-2282"><a href="#cb106-2282" aria-hidden="true" tabindex="-1"></a>     \dots &amp; \dots &amp; \dots &amp; \dots &amp; \sigma^2_{\beta_{4j}} &amp; \rho_{\beta_{4j}\beta_{5j}} &amp; \rho_{\beta_{4j}\beta_{6j}} &amp; \rho_{\beta_{4j}\beta_{7j}} <span class="sc">\\</span> </span>
<span id="cb106-2283"><a href="#cb106-2283" aria-hidden="true" tabindex="-1"></a>     \dots &amp; \dots &amp; \dots &amp; \dots &amp; \dots &amp; \sigma^2_{\beta_{5j}} &amp; \rho_{\beta_{5j}\beta_{6j}} &amp; \rho_{\beta_{5j}\beta_{7j}} <span class="sc">\\</span> </span>
<span id="cb106-2284"><a href="#cb106-2284" aria-hidden="true" tabindex="-1"></a>     \dots &amp; \dots &amp; \dots &amp; \dots &amp; \dots &amp; \dots &amp; \sigma^2_{\beta_{6j}} &amp; \rho_{\beta_{6j}\beta_{7j}} <span class="sc">\\</span> </span>
<span id="cb106-2285"><a href="#cb106-2285" aria-hidden="true" tabindex="-1"></a>     \dots &amp; \dots &amp; \dots &amp; \dots &amp; \dots &amp; \dots &amp; \dots &amp; \sigma^2_{\beta_{7j}}</span>
<span id="cb106-2286"><a href="#cb106-2286" aria-hidden="true" tabindex="-1"></a>  \end{array}</span>
<span id="cb106-2287"><a href="#cb106-2287" aria-hidden="true" tabindex="-1"></a>\right)</span>
<span id="cb106-2288"><a href="#cb106-2288" aria-hidden="true" tabindex="-1"></a>\right]</span>
<span id="cb106-2289"><a href="#cb106-2289" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb106-2290"><a href="#cb106-2290" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-2291"><a href="#cb106-2291" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb106-2292"><a href="#cb106-2292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2293"><a href="#cb106-2293" aria-hidden="true" tabindex="-1"></a>\ </span>
<span id="cb106-2294"><a href="#cb106-2294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2295"><a href="#cb106-2295" aria-hidden="true" tabindex="-1"></a>Importantly, pay attention to where the choice-level and respondent-level variables show up in this expanded version. All the choice-level variables have respondent-specific $\beta$ coefficients, while the respondent-level variable (<span class="in">`carpool`</span>) is down in that massive multivariate normal matrix with its own $\gamma$ coefficients, helping determine the respondent-specific $\beta$ coefficients. That's great and exactly what we want, and we can do that with raw Stan, but raw Stan is no fun.</span>
<span id="cb106-2296"><a href="#cb106-2296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2297"><a href="#cb106-2297" aria-hidden="true" tabindex="-1"></a>We can create this exact same model structure with {brms} like this:</span>
<span id="cb106-2298"><a href="#cb106-2298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2299"><a href="#cb106-2299" aria-hidden="true" tabindex="-1"></a><span class="in">``` r</span></span>
<span id="cb106-2300"><a href="#cb106-2300" aria-hidden="true" tabindex="-1"></a><span class="fu">bf</span>(choice_alt <span class="sc">~</span></span>
<span id="cb106-2301"><a href="#cb106-2301" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Choice-level predictors that are nested within respondents...</span></span>
<span id="cb106-2302"><a href="#cb106-2302" aria-hidden="true" tabindex="-1"></a>  (seat <span class="sc">+</span> cargo <span class="sc">+</span> eng <span class="sc">+</span> price) <span class="sc">*</span></span>
<span id="cb106-2303"><a href="#cb106-2303" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ...interacted with all respondent-level predictors...</span></span>
<span id="cb106-2304"><a href="#cb106-2304" aria-hidden="true" tabindex="-1"></a>  (carpool) <span class="sc">+</span></span>
<span id="cb106-2305"><a href="#cb106-2305" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ... with random respondent-specific slopes for the</span></span>
<span id="cb106-2306"><a href="#cb106-2306" aria-hidden="true" tabindex="-1"></a>  <span class="co"># nested choice-level predictors</span></span>
<span id="cb106-2307"><a href="#cb106-2307" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">1</span> <span class="sc">+</span> seat <span class="sc">+</span> cargo <span class="sc">+</span> eng <span class="sc">+</span> price <span class="sc">|</span> resp.id))</span>
<span id="cb106-2308"><a href="#cb106-2308" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-2309"><a href="#cb106-2309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2310"><a href="#cb106-2310" aria-hidden="true" tabindex="-1"></a>We can confirm that this worked by using <span class="co">[</span><span class="ot">the miraculous {equatiomatic} package</span><span class="co">](https://datalorax.github.io/equatiomatic/)</span>, which automatically converts model objects into LaTeX code. {equatiomatic} doesn't work with {brms} models, but it does work with frequentist {lme4} models, so we can fit a throwaway frequentist model with this syntax (it won't actually converge and it'll give a warning, but that's fine—we don't actually care about this model) and then feed it to <span class="in">`equatiomatic::extract_eq()`</span> to see what it looks like in formal notation. </span>
<span id="cb106-2311"><a href="#cb106-2311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2312"><a href="#cb106-2312" aria-hidden="true" tabindex="-1"></a>(This is actually how I figured out the correct combination of interactions and random slopes—I kept trying different combinations that I thought were right until the math matched the huge full model above, with the $\beta$ and $\gamma$ terms in the right places.)</span>
<span id="cb106-2313"><a href="#cb106-2313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2314"><a href="#cb106-2314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2315"><a href="#cb106-2315" aria-hidden="true" tabindex="-1"></a><span class="in">```{r lme4-equatiomatic, results="asis", warning=FALSE, message=FALSE, cache=TRUE}</span></span>
<span id="cb106-2316"><a href="#cb106-2316" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page</span></span>
<span id="cb106-2317"><a href="#cb106-2317" aria-hidden="true" tabindex="-1"></a><span class="in">library(lme4)</span></span>
<span id="cb106-2318"><a href="#cb106-2318" aria-hidden="true" tabindex="-1"></a><span class="in">library(equatiomatic)</span></span>
<span id="cb106-2319"><a href="#cb106-2319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2320"><a href="#cb106-2320" aria-hidden="true" tabindex="-1"></a><span class="in">model_throwaway &lt;- lmer(</span></span>
<span id="cb106-2321"><a href="#cb106-2321" aria-hidden="true" tabindex="-1"></a><span class="in">  choice ~ (seat + cargo + eng + price) * (carpool) +</span></span>
<span id="cb106-2322"><a href="#cb106-2322" aria-hidden="true" tabindex="-1"></a><span class="in">    (1 + seat + cargo + eng + price | resp.id),</span></span>
<span id="cb106-2323"><a href="#cb106-2323" aria-hidden="true" tabindex="-1"></a><span class="in">  data = minivans</span></span>
<span id="cb106-2324"><a href="#cb106-2324" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb106-2325"><a href="#cb106-2325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2326"><a href="#cb106-2326" aria-hidden="true" tabindex="-1"></a><span class="in">print(extract_eq(model_throwaway))</span></span>
<span id="cb106-2327"><a href="#cb106-2327" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-2328"><a href="#cb106-2328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2329"><a href="#cb106-2329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2330"><a href="#cb106-2330" aria-hidden="true" tabindex="-1"></a><span class="fu">### Different variations of group-level interactions</span></span>
<span id="cb106-2331"><a href="#cb106-2331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2332"><a href="#cb106-2332" aria-hidden="true" tabindex="-1"></a>This syntax is a special R shortcut for interacting <span class="in">`carpool`</span> with each of the feature variables:</span>
<span id="cb106-2333"><a href="#cb106-2333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2334"><a href="#cb106-2334" aria-hidden="true" tabindex="-1"></a><span class="in">``` r</span></span>
<span id="cb106-2335"><a href="#cb106-2335" aria-hidden="true" tabindex="-1"></a><span class="co"># Short way</span></span>
<span id="cb106-2336"><a href="#cb106-2336" aria-hidden="true" tabindex="-1"></a>(seat <span class="sc">+</span> cargo <span class="sc">+</span> eng <span class="sc">+</span> price) <span class="sc">*</span> (carpool)</span>
<span id="cb106-2337"><a href="#cb106-2337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2338"><a href="#cb106-2338" aria-hidden="true" tabindex="-1"></a><span class="co"># This expands to this</span></span>
<span id="cb106-2339"><a href="#cb106-2339" aria-hidden="true" tabindex="-1"></a>seat<span class="sc">*</span>carpool <span class="sc">+</span> cargo<span class="sc">*</span>carpool <span class="sc">+</span> eng<span class="sc">*</span>carpool <span class="sc">+</span> price<span class="sc">*</span>carpool</span>
<span id="cb106-2340"><a href="#cb106-2340" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-2341"><a href="#cb106-2341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2342"><a href="#cb106-2342" aria-hidden="true" tabindex="-1"></a>If we had other respondent-level columns like age (<span class="in">`age`</span>) and education (<span class="in">`ed`</span>), the shortcut syntax is really helpful:</span>
<span id="cb106-2343"><a href="#cb106-2343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2344"><a href="#cb106-2344" aria-hidden="true" tabindex="-1"></a><span class="in">``` r</span></span>
<span id="cb106-2345"><a href="#cb106-2345" aria-hidden="true" tabindex="-1"></a><span class="co"># Short way</span></span>
<span id="cb106-2346"><a href="#cb106-2346" aria-hidden="true" tabindex="-1"></a>(seat <span class="sc">+</span> cargo <span class="sc">+</span> eng <span class="sc">+</span> price) <span class="sc">*</span> (carpool <span class="sc">+</span> age <span class="sc">+</span> ed)</span>
<span id="cb106-2347"><a href="#cb106-2347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2348"><a href="#cb106-2348" aria-hidden="true" tabindex="-1"></a><span class="co"># This expands to this</span></span>
<span id="cb106-2349"><a href="#cb106-2349" aria-hidden="true" tabindex="-1"></a>seat<span class="sc">*</span>carpool <span class="sc">+</span> cargo<span class="sc">*</span>carpool <span class="sc">+</span> eng<span class="sc">*</span>carpool <span class="sc">+</span> price<span class="sc">*</span>carpool <span class="sc">+</span></span>
<span id="cb106-2350"><a href="#cb106-2350" aria-hidden="true" tabindex="-1"></a>seat<span class="sc">*</span>age <span class="sc">+</span> cargo<span class="sc">*</span>age <span class="sc">+</span> eng<span class="sc">*</span>age <span class="sc">+</span> price<span class="sc">*</span>age <span class="sc">+</span></span>
<span id="cb106-2351"><a href="#cb106-2351" aria-hidden="true" tabindex="-1"></a>seat<span class="sc">*</span>ed <span class="sc">+</span> cargo<span class="sc">*</span>ed <span class="sc">+</span> eng<span class="sc">*</span>ed <span class="sc">+</span> price<span class="sc">*</span>ed</span>
<span id="cb106-2352"><a href="#cb106-2352" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-2353"><a href="#cb106-2353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2354"><a href="#cb106-2354" aria-hidden="true" tabindex="-1"></a>We don't necessarily need to fully interact everything. For instance, if we have theoretical reasons to think that carpool status is associated with seat count preferences, but not other features, we can only interact <span class="in">`seat`</span> and <span class="in">`carpool`</span>:</span>
<span id="cb106-2355"><a href="#cb106-2355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2356"><a href="#cb106-2356" aria-hidden="true" tabindex="-1"></a><span class="in">``` r</span></span>
<span id="cb106-2357"><a href="#cb106-2357" aria-hidden="true" tabindex="-1"></a><span class="fu">bf</span>(choice <span class="sc">~</span> </span>
<span id="cb106-2358"><a href="#cb106-2358" aria-hidden="true" tabindex="-1"></a>    (seat <span class="sc">*</span> carpool) <span class="sc">+</span> cargo <span class="sc">+</span> eng <span class="sc">+</span> price <span class="sc">+</span> </span>
<span id="cb106-2359"><a href="#cb106-2359" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">1</span> <span class="sc">+</span> seat <span class="sc">+</span> cargo <span class="sc">+</span> eng <span class="sc">+</span> price <span class="sc">|</span> resp.id))</span>
<span id="cb106-2360"><a href="#cb106-2360" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-2361"><a href="#cb106-2361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2362"><a href="#cb106-2362" aria-hidden="true" tabindex="-1"></a>::: {.callout-warning}</span>
<span id="cb106-2363"><a href="#cb106-2363" aria-hidden="true" tabindex="-1"></a><span class="fu">### Model running times</span></span>
<span id="cb106-2364"><a href="#cb106-2364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2365"><a href="#cb106-2365" aria-hidden="true" tabindex="-1"></a>The more individual-level interactions you add, the longer it will take for the model to run. As we'll see below, interacting <span class="in">`carpool`</span> with the four feature levels takes ≈30 minutes to fit. As you add more individual-level interactions, the running time blows up.</span>
<span id="cb106-2366"><a href="#cb106-2366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2367"><a href="#cb106-2367" aria-hidden="true" tabindex="-1"></a>In the replication code for @JensenMarbleScheve:2021, where they model a ton of individual variables, they say it takes several days to run. Our models in @ChaudhryDotsonHeiss:2021 take hours and hours to run.</span>
<span id="cb106-2368"><a href="#cb106-2368" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb106-2369"><a href="#cb106-2369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2370"><a href="#cb106-2370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2371"><a href="#cb106-2371" aria-hidden="true" tabindex="-1"></a><span class="fu">## `mlogit` model</span></span>
<span id="cb106-2372"><a href="#cb106-2372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2373"><a href="#cb106-2373" aria-hidden="true" tabindex="-1"></a>{mlogit} can estimate hierarchical models with something like this: </span>
<span id="cb106-2374"><a href="#cb106-2374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2375"><a href="#cb106-2375" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-hierarchical-mlogit, eval=FALSE}</span></span>
<span id="cb106-2376"><a href="#cb106-2376" aria-hidden="true" tabindex="-1"></a><span class="in"># Define the random parameters</span></span>
<span id="cb106-2377"><a href="#cb106-2377" aria-hidden="true" tabindex="-1"></a><span class="in">model_mlogit_rpar &lt;- rep("n", length = length(model_minivans_mlogit$coef))</span></span>
<span id="cb106-2378"><a href="#cb106-2378" aria-hidden="true" tabindex="-1"></a><span class="in">names(model_mlogit_rpar) &lt;- names(model_minivans_mlogit$coef)</span></span>
<span id="cb106-2379"><a href="#cb106-2379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2380"><a href="#cb106-2380" aria-hidden="true" tabindex="-1"></a><span class="in"># This means these random terms are all normally distributed</span></span>
<span id="cb106-2381"><a href="#cb106-2381" aria-hidden="true" tabindex="-1"></a><span class="in">model_mlogit_rpar</span></span>
<span id="cb106-2382"><a href="#cb106-2382" aria-hidden="true" tabindex="-1"></a><span class="in">#&gt; seat7    seat8 cargo3ft   enghyb  engelec  price35  price40 </span></span>
<span id="cb106-2383"><a href="#cb106-2383" aria-hidden="true" tabindex="-1"></a><span class="in">#&gt;   "n"      "n"      "n"      "n"      "n"      "n"      "n" </span></span>
<span id="cb106-2384"><a href="#cb106-2384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2385"><a href="#cb106-2385" aria-hidden="true" tabindex="-1"></a><span class="in"># Run the model with carpool as an individual-level covariate</span></span>
<span id="cb106-2386"><a href="#cb106-2386" aria-hidden="true" tabindex="-1"></a><span class="in">model_mlogit_hierarchical &lt;- mlogit(</span></span>
<span id="cb106-2387"><a href="#cb106-2387" aria-hidden="true" tabindex="-1"></a><span class="in">  choice ~ 0 + seat + eng + cargo + price | carpool,</span></span>
<span id="cb106-2388"><a href="#cb106-2388" aria-hidden="true" tabindex="-1"></a><span class="in">  data = minivans_idx,</span></span>
<span id="cb106-2389"><a href="#cb106-2389" aria-hidden="true" tabindex="-1"></a><span class="in">  panel = TRUE, rpar = model_mlogit_rpar, correlation = TRUE</span></span>
<span id="cb106-2390"><a href="#cb106-2390" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb106-2391"><a href="#cb106-2391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2392"><a href="#cb106-2392" aria-hidden="true" tabindex="-1"></a><span class="in"># Show the results</span></span>
<span id="cb106-2393"><a href="#cb106-2393" aria-hidden="true" tabindex="-1"></a><span class="in">summary(model_mlogit_hierarchical)</span></span>
<span id="cb106-2394"><a href="#cb106-2394" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-2395"><a href="#cb106-2395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2396"><a href="#cb106-2396" aria-hidden="true" tabindex="-1"></a>However, I'm not a frequentist and I'm already not a huge fan of extracting the predictions and AMCEs from these {mlogit} models. Running and interpreting and working with the results of that object is left as an exercise for the reader :). (See p. 381 in @ChapmanFeit:2019 for a worked example of how to do it.)</span>
<span id="cb106-2397"><a href="#cb106-2397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2398"><a href="#cb106-2398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2399"><a href="#cb106-2399" aria-hidden="true" tabindex="-1"></a><span class="fu">## Finally, the full {brms} model</span></span>
<span id="cb106-2400"><a href="#cb106-2400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2401"><a href="#cb106-2401" aria-hidden="true" tabindex="-1"></a>This is a really complex model with a ton of moving parts, but it's also incredibly powerful. It lets us account for individual-specific differences across each of the minivan features. For instance, whether an individual carpools probably influences their preferences for the number of seats, and maybe cargo space, but probably doesn't influence their preferences for engine type. If we had other individual-level characteristics, we could also let those influence feature preferences. Like, the number of kids an individual has probably influences seat count preferences; the individual's income probably influences their price preferences; and so on.</span>
<span id="cb106-2402"><a href="#cb106-2402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2403"><a href="#cb106-2403" aria-hidden="true" tabindex="-1"></a>Let's define the model more formally again, this time with priors for the parameters we'll be estimating:</span>
<span id="cb106-2404"><a href="#cb106-2404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2405"><a href="#cb106-2405" aria-hidden="true" tabindex="-1"></a>::: {.column-page-inset}</span>
<span id="cb106-2406"><a href="#cb106-2406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2407"><a href="#cb106-2407" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-2408"><a href="#cb106-2408" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb106-2409"><a href="#cb106-2409" aria-hidden="true" tabindex="-1"></a>&amp;\ \textbf{Multinomial probability of selection of choice}_i \textbf{ in respondent}_j <span class="sc">\\</span></span>
<span id="cb106-2410"><a href="#cb106-2410" aria-hidden="true" tabindex="-1"></a>\text{Choice}_{i_j} \sim&amp;\ \operatorname{Categorical}(\{\mu_{1,i_j}, \mu_{2,i_j}, \mu_{3,i_j}<span class="sc">\}</span>) <span class="sc">\\</span><span class="co">[</span><span class="ot">10pt</span><span class="co">]</span></span>
<span id="cb106-2411"><a href="#cb106-2411" aria-hidden="true" tabindex="-1"></a>&amp;\ \textbf{Model for probability of each option} <span class="sc">\\</span></span>
<span id="cb106-2412"><a href="#cb106-2412" aria-hidden="true" tabindex="-1"></a><span class="sc">\{</span>\mu_{1,i_j}, \mu_{2,i_j}, \mu_{3,i_j}<span class="sc">\}</span> =&amp;\ \beta_{0_j} + \beta_{1_j} \text{Seat<span class="co">[</span><span class="ot">7</span><span class="co">]</span>}_{i_j} + \beta_{2_j} \text{Seat[8]}_{i_j} + \beta_{3_j} \text{Cargo[3ft]}_{i_j} + <span class="sc">\\</span></span>
<span id="cb106-2413"><a href="#cb106-2413" aria-hidden="true" tabindex="-1"></a>&amp;\ \beta_{4_j} \text{Engine<span class="co">[</span><span class="ot">hyb</span><span class="co">]</span>}_{i_j} + \beta_{5_j} \text{Engine[elec]}_{i_j} + <span class="sc">\\</span></span>
<span id="cb106-2414"><a href="#cb106-2414" aria-hidden="true" tabindex="-1"></a>&amp;\ \beta_{6_j} \text{Price<span class="co">[</span><span class="ot">35k</span><span class="co">]</span>}_{i_j} + \beta_{7_j} \text{Price[40k]}_{i_j} <span class="sc">\\</span><span class="co">[</span><span class="ot">20pt</span><span class="co">]</span>  </span>
<span id="cb106-2415"><a href="#cb106-2415" aria-hidden="true" tabindex="-1"></a>&amp;\ \textbf{Respondent-specific slopes} <span class="sc">\\</span></span>
<span id="cb106-2416"><a href="#cb106-2416" aria-hidden="true" tabindex="-1"></a>\left(</span>
<span id="cb106-2417"><a href="#cb106-2417" aria-hidden="true" tabindex="-1"></a>  \begin{array}{c} </span>
<span id="cb106-2418"><a href="#cb106-2418" aria-hidden="true" tabindex="-1"></a>    \begin{aligned}</span>
<span id="cb106-2419"><a href="#cb106-2419" aria-hidden="true" tabindex="-1"></a>      &amp;\beta_{0_j} <span class="sc">\\</span></span>
<span id="cb106-2420"><a href="#cb106-2420" aria-hidden="true" tabindex="-1"></a>      &amp;\beta_{1_j} <span class="sc">\\</span></span>
<span id="cb106-2421"><a href="#cb106-2421" aria-hidden="true" tabindex="-1"></a>      &amp;\beta_{2_j} <span class="sc">\\</span></span>
<span id="cb106-2422"><a href="#cb106-2422" aria-hidden="true" tabindex="-1"></a>      &amp;\beta_{3_j} <span class="sc">\\</span></span>
<span id="cb106-2423"><a href="#cb106-2423" aria-hidden="true" tabindex="-1"></a>      &amp;\beta_{4_j} <span class="sc">\\</span></span>
<span id="cb106-2424"><a href="#cb106-2424" aria-hidden="true" tabindex="-1"></a>      &amp;\beta_{5_j} <span class="sc">\\</span></span>
<span id="cb106-2425"><a href="#cb106-2425" aria-hidden="true" tabindex="-1"></a>      &amp;\beta_{6_j} <span class="sc">\\</span></span>
<span id="cb106-2426"><a href="#cb106-2426" aria-hidden="true" tabindex="-1"></a>      &amp;\beta_{7_j}</span>
<span id="cb106-2427"><a href="#cb106-2427" aria-hidden="true" tabindex="-1"></a>    \end{aligned}</span>
<span id="cb106-2428"><a href="#cb106-2428" aria-hidden="true" tabindex="-1"></a>  \end{array}</span>
<span id="cb106-2429"><a href="#cb106-2429" aria-hidden="true" tabindex="-1"></a>\right) \sim&amp;\ \operatorname{Multivariate}\ \mathcal{N} \left[</span>
<span id="cb106-2430"><a href="#cb106-2430" aria-hidden="true" tabindex="-1"></a>\left(</span>
<span id="cb106-2431"><a href="#cb106-2431" aria-hidden="true" tabindex="-1"></a>  \begin{array}{c} </span>
<span id="cb106-2432"><a href="#cb106-2432" aria-hidden="true" tabindex="-1"></a>    \begin{aligned}</span>
<span id="cb106-2433"><a href="#cb106-2433" aria-hidden="true" tabindex="-1"></a>      &amp;\gamma^{\beta_{0}}_{0} + \gamma^{\beta_{0}}_{1}\text{Carpool} <span class="sc">\\</span></span>
<span id="cb106-2434"><a href="#cb106-2434" aria-hidden="true" tabindex="-1"></a>      &amp;\gamma^{\beta_{1}}_{0} + \gamma^{\beta_{1}}_{1}\text{Carpool} <span class="sc">\\</span></span>
<span id="cb106-2435"><a href="#cb106-2435" aria-hidden="true" tabindex="-1"></a>      &amp;\gamma^{\beta_{2}}_{0} + \gamma^{\beta_{2}}_{1}\text{Carpool} <span class="sc">\\</span></span>
<span id="cb106-2436"><a href="#cb106-2436" aria-hidden="true" tabindex="-1"></a>      &amp;\gamma^{\beta_{3}}_{0} + \gamma^{\beta_{3}}_{1}\text{Carpool} <span class="sc">\\</span></span>
<span id="cb106-2437"><a href="#cb106-2437" aria-hidden="true" tabindex="-1"></a>      &amp;\gamma^{\beta_{4}}_{0} + \gamma^{\beta_{4}}_{1}\text{Carpool} <span class="sc">\\</span></span>
<span id="cb106-2438"><a href="#cb106-2438" aria-hidden="true" tabindex="-1"></a>      &amp;\gamma^{\beta_{5}}_{0} + \gamma^{\beta_{5}}_{1}\text{Carpool} <span class="sc">\\</span></span>
<span id="cb106-2439"><a href="#cb106-2439" aria-hidden="true" tabindex="-1"></a>      &amp;\gamma^{\beta_{6}}_{0} + \gamma^{\beta_{6}}_{1}\text{Carpool} <span class="sc">\\</span></span>
<span id="cb106-2440"><a href="#cb106-2440" aria-hidden="true" tabindex="-1"></a>      &amp;\gamma^{\beta_{7}}_{0} + \gamma^{\beta_{7}}_{1}\text{Carpool}</span>
<span id="cb106-2441"><a href="#cb106-2441" aria-hidden="true" tabindex="-1"></a>    \end{aligned}</span>
<span id="cb106-2442"><a href="#cb106-2442" aria-hidden="true" tabindex="-1"></a>  \end{array}</span>
<span id="cb106-2443"><a href="#cb106-2443" aria-hidden="true" tabindex="-1"></a>\right)</span>
<span id="cb106-2444"><a href="#cb106-2444" aria-hidden="true" tabindex="-1"></a>, </span>
<span id="cb106-2445"><a href="#cb106-2445" aria-hidden="true" tabindex="-1"></a>\left(</span>
<span id="cb106-2446"><a href="#cb106-2446" aria-hidden="true" tabindex="-1"></a>  \begin{array}{cccccccc}</span>
<span id="cb106-2447"><a href="#cb106-2447" aria-hidden="true" tabindex="-1"></a>     \sigma^2_{\beta_{0j}} &amp; \rho_{\beta_{0j}\beta_{1j}} &amp; \rho_{\beta_{0j}\beta_{2j}} &amp; \rho_{\beta_{0j}\beta_{3j}} &amp; \rho_{\beta_{0j}\beta_{4j}} &amp; \rho_{\beta_{0j}\beta_{5j}} &amp; \rho_{\beta_{0j}\beta_{6j}} &amp; \rho_{\beta_{0j}\beta_{7j}} <span class="sc">\\</span> </span>
<span id="cb106-2448"><a href="#cb106-2448" aria-hidden="true" tabindex="-1"></a>     \dots &amp; \sigma^2_{\beta_{1j}} &amp; \rho_{\beta_{1j}\beta_{2j}} &amp; \rho_{\beta_{1j}\beta_{3j}} &amp; \rho_{\beta_{1j}\beta_{4j}} &amp; \rho_{\beta_{1j}\beta_{5j}} &amp; \rho_{\beta_{1j}\beta_{6j}} &amp; \rho_{\beta_{1j}\beta_{7j}} <span class="sc">\\</span> </span>
<span id="cb106-2449"><a href="#cb106-2449" aria-hidden="true" tabindex="-1"></a>     \dots &amp; \dots &amp; \sigma^2_{\beta_{2j}} &amp; \rho_{\beta_{2j}\beta_{3j}} &amp; \rho_{\beta_{2j}\beta_{4j}} &amp; \rho_{\beta_{2j}\beta_{5j}} &amp; \rho_{\beta_{2j}\beta_{6j}} &amp; \rho_{\beta_{2j}\beta_{7j}} <span class="sc">\\</span> </span>
<span id="cb106-2450"><a href="#cb106-2450" aria-hidden="true" tabindex="-1"></a>     \dots &amp; \dots &amp; \dots &amp; \sigma^2_{\beta_{3j}} &amp; \rho_{\beta_{3j}\beta_{4j}} &amp; \rho_{\beta_{3j}\beta_{5j}} &amp; \rho_{\beta_{3j}\beta_{6j}} &amp; \rho_{\beta_{3j}\beta_{7j}} <span class="sc">\\</span> </span>
<span id="cb106-2451"><a href="#cb106-2451" aria-hidden="true" tabindex="-1"></a>     \dots &amp; \dots &amp; \dots &amp; \dots &amp; \sigma^2_{\beta_{4j}} &amp; \rho_{\beta_{4j}\beta_{5j}} &amp; \rho_{\beta_{4j}\beta_{6j}} &amp; \rho_{\beta_{4j}\beta_{7j}} <span class="sc">\\</span> </span>
<span id="cb106-2452"><a href="#cb106-2452" aria-hidden="true" tabindex="-1"></a>     \dots &amp; \dots &amp; \dots &amp; \dots &amp; \dots &amp; \sigma^2_{\beta_{5j}} &amp; \rho_{\beta_{5j}\beta_{6j}} &amp; \rho_{\beta_{5j}\beta_{7j}} <span class="sc">\\</span> </span>
<span id="cb106-2453"><a href="#cb106-2453" aria-hidden="true" tabindex="-1"></a>     \dots &amp; \dots &amp; \dots &amp; \dots &amp; \dots &amp; \dots &amp; \sigma^2_{\beta_{6j}} &amp; \rho_{\beta_{6j}\beta_{7j}} <span class="sc">\\</span> </span>
<span id="cb106-2454"><a href="#cb106-2454" aria-hidden="true" tabindex="-1"></a>     \dots &amp; \dots &amp; \dots &amp; \dots &amp; \dots &amp; \dots &amp; \dots &amp; \sigma^2_{\beta_{7j}}</span>
<span id="cb106-2455"><a href="#cb106-2455" aria-hidden="true" tabindex="-1"></a>  \end{array}</span>
<span id="cb106-2456"><a href="#cb106-2456" aria-hidden="true" tabindex="-1"></a>\right)</span>
<span id="cb106-2457"><a href="#cb106-2457" aria-hidden="true" tabindex="-1"></a>\right] <span class="sc">\\</span><span class="co">[</span><span class="ot">10pt</span><span class="co">]</span></span>
<span id="cb106-2458"><a href="#cb106-2458" aria-hidden="true" tabindex="-1"></a>&amp;\ \textbf{Priors} <span class="sc">\\</span></span>
<span id="cb106-2459"><a href="#cb106-2459" aria-hidden="true" tabindex="-1"></a>\beta_{0 \dots 7} \sim&amp;\ \mathcal{N} (0, 3) \qquad\qquad\ <span class="co">[</span><span class="ot">\text{Prior for choice-level coefficients}</span><span class="co">]</span> <span class="sc">\\</span></span>
<span id="cb106-2460"><a href="#cb106-2460" aria-hidden="true" tabindex="-1"></a>\gamma^{\beta_{0 \dots 7}}_0 \sim&amp;\ \mathcal{N} (0, 3) \qquad\qquad\ <span class="co">[</span><span class="ot">\text{Prior for individual-level coefficients}</span><span class="co">]</span> <span class="sc">\\</span></span>
<span id="cb106-2461"><a href="#cb106-2461" aria-hidden="true" tabindex="-1"></a>\sigma_{\beta_{0 \dots 7}} \sim&amp;\ \operatorname{Exponential}(1) \qquad <span class="co">[</span><span class="ot">\text{Prior for between-respondent intercept and slope variability}</span><span class="co">]</span> <span class="sc">\\</span></span>
<span id="cb106-2462"><a href="#cb106-2462" aria-hidden="true" tabindex="-1"></a>\rho \sim&amp;\ \operatorname{LKJ}(1) \qquad\qquad <span class="co">[</span><span class="ot">\text{Prior for correlation between random slopes and intercepts}</span><span class="co">]</span></span>
<span id="cb106-2463"><a href="#cb106-2463" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb106-2464"><a href="#cb106-2464" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-2465"><a href="#cb106-2465" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb106-2466"><a href="#cb106-2466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2467"><a href="#cb106-2467" aria-hidden="true" tabindex="-1"></a>\ </span>
<span id="cb106-2468"><a href="#cb106-2468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2469"><a href="#cb106-2469" aria-hidden="true" tabindex="-1"></a>Here it is in code form. There are a couple new things here in the Stan settings. First, we're going to create 4 MCMC chains with 4,000 draws rather than 2,000—there are so many parameters to be estimated that we need to let the simulation run longer. Second, we've modified the <span class="in">`adapt_delta`</span> setting to 0.99. Conceptually, this adjusts the size of the steps the MCMC algorithm takes as it traverses the posterior space for each parameter—higher numbers make the steps smaller and more granular. This slows down the MCMC simulation, but it also helps avoid divergent transitions (or failed out-of-bounds draws).</span>
<span id="cb106-2470"><a href="#cb106-2470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2471"><a href="#cb106-2471" aria-hidden="true" tabindex="-1"></a>On my 2021 M1 MacBook Pro, running through cmdstanr with 2 CPU cores per chain, it took about 30 minutes to fit. If you're following along with this post, start running this and go get some lunch or go for a walk or something.</span>
<span id="cb106-2472"><a href="#cb106-2472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2473"><a href="#cb106-2473" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb106-2474"><a href="#cb106-2474" aria-hidden="true" tabindex="-1"></a><span class="fu">### Pre-run model</span></span>
<span id="cb106-2475"><a href="#cb106-2475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2476"><a href="#cb106-2476" aria-hidden="true" tabindex="-1"></a>Alternatively, you can download <span class="co">[</span><span class="ot">an .rds file of this completed</span><span class="co">](https://osf.io/zp6eh)</span>. This <span class="in">`brm()`</span> code load the .rds file automatically instead of rerunning the model as long as you put it in a folder named "models" in your working directory. This code uses the <span class="co">[</span><span class="ot">{osfr} package</span><span class="co">](https://docs.ropensci.org/osfr/)</span> to download <span class="co">[</span><span class="ot">the .rds file from OSF</span><span class="co">](https://osf.io/zp6eh)</span> automatically and places it where it needs to go:</span>
<span id="cb106-2477"><a href="#cb106-2477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2478"><a href="#cb106-2478" aria-hidden="true" tabindex="-1"></a><span class="in">```{r get-rds-osf-again, eval=FALSE}</span></span>
<span id="cb106-2479"><a href="#cb106-2479" aria-hidden="true" tabindex="-1"></a><span class="in">library(osfr)  # Interact with OSF via R</span></span>
<span id="cb106-2480"><a href="#cb106-2480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2481"><a href="#cb106-2481" aria-hidden="true" tabindex="-1"></a><span class="in"># Make a "models" folder if it doesn't exist already</span></span>
<span id="cb106-2482"><a href="#cb106-2482" aria-hidden="true" tabindex="-1"></a><span class="in">if (!file.exists("models")) { dir.create("models") }</span></span>
<span id="cb106-2483"><a href="#cb106-2483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2484"><a href="#cb106-2484" aria-hidden="true" tabindex="-1"></a><span class="in"># Download model_minivans_mega_mlm_brms.rds from OSF</span></span>
<span id="cb106-2485"><a href="#cb106-2485" aria-hidden="true" tabindex="-1"></a><span class="in">osf_retrieve_file("https://osf.io/zp6eh") |&gt;</span></span>
<span id="cb106-2486"><a href="#cb106-2486" aria-hidden="true" tabindex="-1"></a><span class="in">  osf_download(path = "models", conflicts = "overwrite", progress = TRUE)</span></span>
<span id="cb106-2487"><a href="#cb106-2487" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-2488"><a href="#cb106-2488" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb106-2489"><a href="#cb106-2489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2490"><a href="#cb106-2490" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-minivans-mega-mlm}</span></span>
<span id="cb106-2491"><a href="#cb106-2491" aria-hidden="true" tabindex="-1"></a><span class="in">model_minivans_mega_mlm_brms &lt;- brm(</span></span>
<span id="cb106-2492"><a href="#cb106-2492" aria-hidden="true" tabindex="-1"></a><span class="in">  bf(choice_alt ~</span></span>
<span id="cb106-2493"><a href="#cb106-2493" aria-hidden="true" tabindex="-1"></a><span class="in">    # Choice-level predictors that are nested within respondents...</span></span>
<span id="cb106-2494"><a href="#cb106-2494" aria-hidden="true" tabindex="-1"></a><span class="in">    (seat + cargo + eng + price) *</span></span>
<span id="cb106-2495"><a href="#cb106-2495" aria-hidden="true" tabindex="-1"></a><span class="in">    # ...interacted with all respondent-level predictors...</span></span>
<span id="cb106-2496"><a href="#cb106-2496" aria-hidden="true" tabindex="-1"></a><span class="in">    (carpool) +</span></span>
<span id="cb106-2497"><a href="#cb106-2497" aria-hidden="true" tabindex="-1"></a><span class="in">    # ... with random respondent-specific slopes for the</span></span>
<span id="cb106-2498"><a href="#cb106-2498" aria-hidden="true" tabindex="-1"></a><span class="in">    # nested choice-level predictors</span></span>
<span id="cb106-2499"><a href="#cb106-2499" aria-hidden="true" tabindex="-1"></a><span class="in">    (1 + seat + cargo + eng + price | ID | resp.id)),</span></span>
<span id="cb106-2500"><a href="#cb106-2500" aria-hidden="true" tabindex="-1"></a><span class="in">  data = minivans_choice_alt,</span></span>
<span id="cb106-2501"><a href="#cb106-2501" aria-hidden="true" tabindex="-1"></a><span class="in">  family = categorical(refcat = "0"),</span></span>
<span id="cb106-2502"><a href="#cb106-2502" aria-hidden="true" tabindex="-1"></a><span class="in">  prior = c(</span></span>
<span id="cb106-2503"><a href="#cb106-2503" aria-hidden="true" tabindex="-1"></a><span class="in">    prior(normal(0, 3), class = b, dpar = mu1),</span></span>
<span id="cb106-2504"><a href="#cb106-2504" aria-hidden="true" tabindex="-1"></a><span class="in">    prior(normal(0, 3), class = b, dpar = mu2),</span></span>
<span id="cb106-2505"><a href="#cb106-2505" aria-hidden="true" tabindex="-1"></a><span class="in">    prior(normal(0, 3), class = b, dpar = mu3),</span></span>
<span id="cb106-2506"><a href="#cb106-2506" aria-hidden="true" tabindex="-1"></a><span class="in">    prior(exponential(1), class = sd, dpar = mu1),</span></span>
<span id="cb106-2507"><a href="#cb106-2507" aria-hidden="true" tabindex="-1"></a><span class="in">    prior(exponential(1), class = sd, dpar = mu2),</span></span>
<span id="cb106-2508"><a href="#cb106-2508" aria-hidden="true" tabindex="-1"></a><span class="in">    prior(exponential(1), class = sd, dpar = mu3),</span></span>
<span id="cb106-2509"><a href="#cb106-2509" aria-hidden="true" tabindex="-1"></a><span class="in">    prior(lkj(1), class = cor)</span></span>
<span id="cb106-2510"><a href="#cb106-2510" aria-hidden="true" tabindex="-1"></a><span class="in">  ),</span></span>
<span id="cb106-2511"><a href="#cb106-2511" aria-hidden="true" tabindex="-1"></a><span class="in">  chains = 4, cores = 4, warmup = 1000, iter = 5000, seed = 1234,</span></span>
<span id="cb106-2512"><a href="#cb106-2512" aria-hidden="true" tabindex="-1"></a><span class="in">  backend = "cmdstanr", threads = threading(2), # refresh = 0,</span></span>
<span id="cb106-2513"><a href="#cb106-2513" aria-hidden="true" tabindex="-1"></a><span class="in">  control = list(adapt_delta = 0.9),</span></span>
<span id="cb106-2514"><a href="#cb106-2514" aria-hidden="true" tabindex="-1"></a><span class="in">  file = "models/model_minivans_mega_mlm_brms"</span></span>
<span id="cb106-2515"><a href="#cb106-2515" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb106-2516"><a href="#cb106-2516" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-2517"><a href="#cb106-2517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2518"><a href="#cb106-2518" aria-hidden="true" tabindex="-1"></a>This model is incredibly rich. We just estimated more than 5,000 parameters (!!!)—we have three sets of coefficients for each of the three options, and those are all interacted with <span class="in">`carpool`</span>, plus we have individual-specific offsets to each of those coefficients, plus all the $\rho$ terms in that massive correlation matrix.</span>
<span id="cb106-2519"><a href="#cb106-2519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2520"><a href="#cb106-2520" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-number-variables-mega-model}</span></span>
<span id="cb106-2521"><a href="#cb106-2521" aria-hidden="true" tabindex="-1"></a><span class="in">length(get_variables(model_minivans_mega_mlm_brms))</span></span>
<span id="cb106-2522"><a href="#cb106-2522" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-2523"><a href="#cb106-2523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2524"><a href="#cb106-2524" aria-hidden="true" tabindex="-1"></a>Since we're dealing with interaction terms, these raw log odds coefficients are even *less* helpful on their own. It's nearly impossible to interpret these coefficients in any meaningful way—there's no point in even trying to combine each of the individual parts of each effect (random parts, interaction parts, etc.). The only way we'll be able to interpret these things is by making predictions.</span>
<span id="cb106-2525"><a href="#cb106-2525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2526"><a href="#cb106-2526" aria-hidden="true" tabindex="-1"></a><span class="in">```{r marginalize-mlm-posterior-estimates}</span></span>
<span id="cb106-2527"><a href="#cb106-2527" aria-hidden="true" tabindex="-1"></a><span class="in">minivans_mega_marginalized &lt;- model_minivans_mega_mlm_brms %&gt;% </span></span>
<span id="cb106-2528"><a href="#cb106-2528" aria-hidden="true" tabindex="-1"></a><span class="in">  gather_draws(`^b_.*$`, regex = TRUE) %&gt;% </span></span>
<span id="cb106-2529"><a href="#cb106-2529" aria-hidden="true" tabindex="-1"></a><span class="in">  # Each variable name has "mu1", "mu2", etc. built in, like "b_mu1_seat6". This</span></span>
<span id="cb106-2530"><a href="#cb106-2530" aria-hidden="true" tabindex="-1"></a><span class="in">  # splits the .variable column into two parts based on a regular expression,</span></span>
<span id="cb106-2531"><a href="#cb106-2531" aria-hidden="true" tabindex="-1"></a><span class="in">  # creating one column for the mu part ("b_mu1_") and one for the rest of the</span></span>
<span id="cb106-2532"><a href="#cb106-2532" aria-hidden="true" tabindex="-1"></a><span class="in">  # variable name ("seat6")</span></span>
<span id="cb106-2533"><a href="#cb106-2533" aria-hidden="true" tabindex="-1"></a><span class="in">  separate_wider_regex(</span></span>
<span id="cb106-2534"><a href="#cb106-2534" aria-hidden="true" tabindex="-1"></a><span class="in">    .variable,</span></span>
<span id="cb106-2535"><a href="#cb106-2535" aria-hidden="true" tabindex="-1"></a><span class="in">    patterns = c(mu = "b_mu\\d_", .variable = ".*")</span></span>
<span id="cb106-2536"><a href="#cb106-2536" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;% </span></span>
<span id="cb106-2537"><a href="#cb106-2537" aria-hidden="true" tabindex="-1"></a><span class="in">  # Find the average of the three mu estimates for each variable within each</span></span>
<span id="cb106-2538"><a href="#cb106-2538" aria-hidden="true" tabindex="-1"></a><span class="in">  # draw, or marginalize across the three options, since they're randomized</span></span>
<span id="cb106-2539"><a href="#cb106-2539" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(.variable, .draw) %&gt;% </span></span>
<span id="cb106-2540"><a href="#cb106-2540" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(.value = mean(.value)) </span></span>
<span id="cb106-2541"><a href="#cb106-2541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2542"><a href="#cb106-2542" aria-hidden="true" tabindex="-1"></a><span class="in">minivans_mega_marginalized %&gt;% </span></span>
<span id="cb106-2543"><a href="#cb106-2543" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(.variable) %&gt;% </span></span>
<span id="cb106-2544"><a href="#cb106-2544" aria-hidden="true" tabindex="-1"></a><span class="in">  median_qi(.value)</span></span>
<span id="cb106-2545"><a href="#cb106-2545" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-2546"><a href="#cb106-2546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2547"><a href="#cb106-2547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2548"><a href="#cb106-2548" aria-hidden="true" tabindex="-1"></a><span class="fu">## Predictions</span></span>
<span id="cb106-2549"><a href="#cb106-2549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2550"><a href="#cb106-2550" aria-hidden="true" tabindex="-1"></a>In the non-hierarchical model earlier, <span class="co">[</span><span class="ot">we made marketing-style predictions</span><span class="co">](#bayesian-predictions-1)</span> by thinking of a product mix and figuring out the predicted utility and market share of each product in that mix. We can do the same thing here, but now we can incorporate individual-level characteristics too.</span>
<span id="cb106-2551"><a href="#cb106-2551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2552"><a href="#cb106-2552" aria-hidden="true" tabindex="-1"></a>Here's our example product mix again, but this time we'll repeat it twice—once with <span class="in">`carpool`</span> set to "yes" and once with it set to "no". This will let us see the predicted market share for each mix of products for a market of only carpoolers and only non-carpoolers.</span>
<span id="cb106-2553"><a href="#cb106-2553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2554"><a href="#cb106-2554" aria-hidden="true" tabindex="-1"></a><span class="in">```{r create-product-mix-carpool}</span></span>
<span id="cb106-2555"><a href="#cb106-2555" aria-hidden="true" tabindex="-1"></a><span class="in">example_product_mix &lt;- tribble(</span></span>
<span id="cb106-2556"><a href="#cb106-2556" aria-hidden="true" tabindex="-1"></a><span class="in">  ~seat, ~cargo, ~eng, ~price,</span></span>
<span id="cb106-2557"><a href="#cb106-2557" aria-hidden="true" tabindex="-1"></a><span class="in">  "7", "2ft", "hyb", "30",</span></span>
<span id="cb106-2558"><a href="#cb106-2558" aria-hidden="true" tabindex="-1"></a><span class="in">  "6", "2ft", "gas", "30",</span></span>
<span id="cb106-2559"><a href="#cb106-2559" aria-hidden="true" tabindex="-1"></a><span class="in">  "8", "2ft", "gas", "30",</span></span>
<span id="cb106-2560"><a href="#cb106-2560" aria-hidden="true" tabindex="-1"></a><span class="in">  "7", "3ft", "gas", "40",</span></span>
<span id="cb106-2561"><a href="#cb106-2561" aria-hidden="true" tabindex="-1"></a><span class="in">  "6", "2ft", "elec", "40",</span></span>
<span id="cb106-2562"><a href="#cb106-2562" aria-hidden="true" tabindex="-1"></a><span class="in">  "7", "2ft", "hyb", "35"</span></span>
<span id="cb106-2563"><a href="#cb106-2563" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb106-2564"><a href="#cb106-2564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2565"><a href="#cb106-2565" aria-hidden="true" tabindex="-1"></a><span class="in">product_mix_carpool &lt;- bind_rows(</span></span>
<span id="cb106-2566"><a href="#cb106-2566" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(example_product_mix, carpool = "yes"),</span></span>
<span id="cb106-2567"><a href="#cb106-2567" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(example_product_mix, carpool = "no")</span></span>
<span id="cb106-2568"><a href="#cb106-2568" aria-hidden="true" tabindex="-1"></a><span class="in">) %&gt;% </span></span>
<span id="cb106-2569"><a href="#cb106-2569" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(across(everything(), factor)) %&gt;% </span></span>
<span id="cb106-2570"><a href="#cb106-2570" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(eng = factor(eng, levels = levels(minivans$eng)))</span></span>
<span id="cb106-2571"><a href="#cb106-2571" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-2572"><a href="#cb106-2572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2573"><a href="#cb106-2573" aria-hidden="true" tabindex="-1"></a>We can now go through <span class="co">[</span><span class="ot">the same process from earlier</span><span class="co">](#bayesian-predictions-1)</span> where we get logit-scale predictions for this smaller dataset and find the shares inside each draw + category (options 1, 2, and 3) + carpool status group. </span>
<span id="cb106-2574"><a href="#cb106-2574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2575"><a href="#cb106-2575" aria-hidden="true" tabindex="-1"></a><span class="in">```{r create-shares-mega-model-carpool}</span></span>
<span id="cb106-2576"><a href="#cb106-2576" aria-hidden="true" tabindex="-1"></a><span class="in">draws_df &lt;- product_mix_carpool %&gt;% </span></span>
<span id="cb106-2577"><a href="#cb106-2577" aria-hidden="true" tabindex="-1"></a><span class="in">  add_linpred_draws(model_minivans_mega_mlm_brms, value = "utility", re_formula = NA)</span></span>
<span id="cb106-2578"><a href="#cb106-2578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2579"><a href="#cb106-2579" aria-hidden="true" tabindex="-1"></a><span class="in">shares_df &lt;- draws_df %&gt;% </span></span>
<span id="cb106-2580"><a href="#cb106-2580" aria-hidden="true" tabindex="-1"></a><span class="in">  # Look at each set of predicted utilities within each draw within each of the</span></span>
<span id="cb106-2581"><a href="#cb106-2581" aria-hidden="true" tabindex="-1"></a><span class="in">  # three outcomes across both levels of carpooling</span></span>
<span id="cb106-2582"><a href="#cb106-2582" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(.draw, .category, carpool) %&gt;% </span></span>
<span id="cb106-2583"><a href="#cb106-2583" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(share = exp(utility) / sum(exp(utility))) %&gt;% </span></span>
<span id="cb106-2584"><a href="#cb106-2584" aria-hidden="true" tabindex="-1"></a><span class="in">  ungroup() %&gt;% </span></span>
<span id="cb106-2585"><a href="#cb106-2585" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb106-2586"><a href="#cb106-2586" aria-hidden="true" tabindex="-1"></a><span class="in">    mix_type = paste(seat, cargo, eng, price, sep = " "),</span></span>
<span id="cb106-2587"><a href="#cb106-2587" aria-hidden="true" tabindex="-1"></a><span class="in">    mix_type = fct_reorder(mix_type, share)</span></span>
<span id="cb106-2588"><a href="#cb106-2588" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb106-2589"><a href="#cb106-2589" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-2590"><a href="#cb106-2590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2591"><a href="#cb106-2591" aria-hidden="true" tabindex="-1"></a>This new dataset contains 576,000 (!!) rows: 6 products × 2 carpool types × 3 $\mu$-specific sets of coefficients × 16,000 MCMC draws. We can summarize this to get posterior medians and credible intervals, making sure to find the average share across the three outcomes (choice 1, 2, and 3), or marginalizing across the outcome.</span>
<span id="cb106-2592"><a href="#cb106-2592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2593"><a href="#cb106-2593" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-shares-carpool}</span></span>
<span id="cb106-2594"><a href="#cb106-2594" aria-hidden="true" tabindex="-1"></a><span class="in">shares_df %&gt;% </span></span>
<span id="cb106-2595"><a href="#cb106-2595" aria-hidden="true" tabindex="-1"></a><span class="in">  # Marginalize across the three outcomes within each draw</span></span>
<span id="cb106-2596"><a href="#cb106-2596" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(mix_type, carpool, .draw) %&gt;% </span></span>
<span id="cb106-2597"><a href="#cb106-2597" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(share = mean(share)) %&gt;% </span></span>
<span id="cb106-2598"><a href="#cb106-2598" aria-hidden="true" tabindex="-1"></a><span class="in">  median_qi(share)</span></span>
<span id="cb106-2599"><a href="#cb106-2599" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-2600"><a href="#cb106-2600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2601"><a href="#cb106-2601" aria-hidden="true" tabindex="-1"></a>And we can plot them:</span>
<span id="cb106-2602"><a href="#cb106-2602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2603"><a href="#cb106-2603" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-shares-carpool, fig.width=7}</span></span>
<span id="cb106-2604"><a href="#cb106-2604" aria-hidden="true" tabindex="-1"></a><span class="in">shares_df %&gt;% </span></span>
<span id="cb106-2605"><a href="#cb106-2605" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(carpool = case_match(carpool, "no" ~ "Non-carpoolers", "yes" ~ "Carpoolers")) %&gt;% </span></span>
<span id="cb106-2606"><a href="#cb106-2606" aria-hidden="true" tabindex="-1"></a><span class="in">  # Marginalize across the three outcomes within each draw</span></span>
<span id="cb106-2607"><a href="#cb106-2607" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(mix_type, carpool, .draw) %&gt;% </span></span>
<span id="cb106-2608"><a href="#cb106-2608" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(share = mean(share)) %&gt;% </span></span>
<span id="cb106-2609"><a href="#cb106-2609" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = share, y = mix_type, slab_alpha = carpool)) +</span></span>
<span id="cb106-2610"><a href="#cb106-2610" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye(normalize = "groups", fill = clrs[10]) +</span></span>
<span id="cb106-2611"><a href="#cb106-2611" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_percent()) +</span></span>
<span id="cb106-2612"><a href="#cb106-2612" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_slab_alpha_discrete(</span></span>
<span id="cb106-2613"><a href="#cb106-2613" aria-hidden="true" tabindex="-1"></a><span class="in">    range = c(1, 0.4),</span></span>
<span id="cb106-2614"><a href="#cb106-2614" aria-hidden="true" tabindex="-1"></a><span class="in">    guide = "none"</span></span>
<span id="cb106-2615"><a href="#cb106-2615" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb106-2616"><a href="#cb106-2616" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(vars(carpool)) +</span></span>
<span id="cb106-2617"><a href="#cb106-2617" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Predicted market share", y = "Hypothetical product mix")</span></span>
<span id="cb106-2618"><a href="#cb106-2618" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-2619"><a href="#cb106-2619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2620"><a href="#cb106-2620" aria-hidden="true" tabindex="-1"></a>This is so cool! In general, the market share for these six hypothetical products is roughly the same across carpoolers and non-carpoolers, with one obvious exception—among non-carpoolers, the \$30,000 8-passenger gas minivan with 2 feet of space has 26% of the market, while among carpoolers it has 42%. Individuals who carpool apparently *really* care about the number of passengers their vehicle can carry.</span>
<span id="cb106-2621"><a href="#cb106-2621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2622"><a href="#cb106-2622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2623"><a href="#cb106-2623" aria-hidden="true" tabindex="-1"></a><span class="fu">## AMCEs</span></span>
<span id="cb106-2624"><a href="#cb106-2624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2625"><a href="#cb106-2625" aria-hidden="true" tabindex="-1"></a>To find the average marginal component effects (AMCEs), or the causal effect of moving one of these features to another value, holding all other variables constant, we can go through <span class="co">[</span><span class="ot">the same process as before</span><span class="co">](#bayesian-comparisonscontrasts-1)</span>. We'll calculate the predicted probabilities of choosing option 0, 1, 2, and 3 across a full grid of all the combinations of feature levels *and* carpool status. We'll then filter those predictions to only look at option 0 and reverse the predicted probabilities. Again, that feels weird, but it's a neat little trick—if there's a 33% chance that someone will select a specific combination of features, that would imply a 66% chance of not selecting it and an 11% chance of selecting it when it appears in option 1, option 2, and option 3. Rather than adding the probabilities within those three options together, we can do 100% − 66% to get the same 33% value, only it's automatically combined.</span>
<span id="cb106-2626"><a href="#cb106-2626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2627"><a href="#cb106-2627" aria-hidden="true" tabindex="-1"></a>Earlier we had 54 combinations—now we have 108 (54 × 2). We'll set <span class="in">`resp.id`</span> to one that's not in the dataset (201) so that these effects all deal with a generic hypothetical respondent (we could also do some fancy "integrating out" work and find population-level averages; <span class="co">[</span><span class="ot">see here for more about that</span><span class="co">](https://www.andrewheiss.com/blog/2022/11/29/conditional-marginal-marginaleffects/)</span>).</span>
<span id="cb106-2628"><a href="#cb106-2628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2629"><a href="#cb106-2629" aria-hidden="true" tabindex="-1"></a><span class="in">```{r create-all-combos-carpool}</span></span>
<span id="cb106-2630"><a href="#cb106-2630" aria-hidden="true" tabindex="-1"></a><span class="in">newdata_all_combos_carpool &lt;- minivans %&gt;% </span></span>
<span id="cb106-2631"><a href="#cb106-2631" aria-hidden="true" tabindex="-1"></a><span class="in">  tidyr::expand(seat, cargo, eng, price, carpool) %&gt;% </span></span>
<span id="cb106-2632"><a href="#cb106-2632" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(resp.id = 201)</span></span>
<span id="cb106-2633"><a href="#cb106-2633" aria-hidden="true" tabindex="-1"></a><span class="in">newdata_all_combos_carpool</span></span>
<span id="cb106-2634"><a href="#cb106-2634" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-2635"><a href="#cb106-2635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2636"><a href="#cb106-2636" aria-hidden="true" tabindex="-1"></a>Next we can plug this grid into the model, filter to only keep option 0, and reverse the predictions:</span>
<span id="cb106-2637"><a href="#cb106-2637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2638"><a href="#cb106-2638" aria-hidden="true" tabindex="-1"></a><span class="in">```{r generate-preds-all-combos-carpool}</span></span>
<span id="cb106-2639"><a href="#cb106-2639" aria-hidden="true" tabindex="-1"></a><span class="in">all_preds_brms_carpool &lt;- model_minivans_mega_mlm_brms %&gt;% </span></span>
<span id="cb106-2640"><a href="#cb106-2640" aria-hidden="true" tabindex="-1"></a><span class="in">  epred_draws(</span></span>
<span id="cb106-2641"><a href="#cb106-2641" aria-hidden="true" tabindex="-1"></a><span class="in">    newdata = newdata_all_combos_carpool,</span></span>
<span id="cb106-2642"><a href="#cb106-2642" aria-hidden="true" tabindex="-1"></a><span class="in">    re_formula = NULL, allow_new_levels = TRUE</span></span>
<span id="cb106-2643"><a href="#cb106-2643" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;% </span></span>
<span id="cb106-2644"><a href="#cb106-2644" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(.category == 0) %&gt;% </span></span>
<span id="cb106-2645"><a href="#cb106-2645" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(.epred = 1 - .epred)</span></span>
<span id="cb106-2646"><a href="#cb106-2646" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-2647"><a href="#cb106-2647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2648"><a href="#cb106-2648" aria-hidden="true" tabindex="-1"></a>This thing has 1.7 million rows in it, so we need to group and summarize to do anything useful with it. We also need to marginalize across all the other covariates when grouping (i.e. if we want the estimates for passenger seat count across carpool status, we need to average out all the other covariates).</span>
<span id="cb106-2649"><a href="#cb106-2649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2650"><a href="#cb106-2650" aria-hidden="true" tabindex="-1"></a>To test that this worked, here are the posterior marginal means for seat count:</span>
<span id="cb106-2651"><a href="#cb106-2651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2652"><a href="#cb106-2652" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-marginal-means-seat-carpool}</span></span>
<span id="cb106-2653"><a href="#cb106-2653" aria-hidden="true" tabindex="-1"></a><span class="in">preds_seat_carpool_marginalized &lt;- all_preds_brms_carpool %&gt;% </span></span>
<span id="cb106-2654"><a href="#cb106-2654" aria-hidden="true" tabindex="-1"></a><span class="in">  # Marginalize out the other covariates in each draw</span></span>
<span id="cb106-2655"><a href="#cb106-2655" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(seat, carpool, .draw) %&gt;% </span></span>
<span id="cb106-2656"><a href="#cb106-2656" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(avg = mean(.epred))</span></span>
<span id="cb106-2657"><a href="#cb106-2657" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2658"><a href="#cb106-2658" aria-hidden="true" tabindex="-1"></a><span class="in">preds_seat_carpool_marginalized %&gt;% </span></span>
<span id="cb106-2659"><a href="#cb106-2659" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(seat, carpool) %&gt;% </span></span>
<span id="cb106-2660"><a href="#cb106-2660" aria-hidden="true" tabindex="-1"></a><span class="in">  median_qi(avg)</span></span>
<span id="cb106-2661"><a href="#cb106-2661" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-2662"><a href="#cb106-2662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2663"><a href="#cb106-2663" aria-hidden="true" tabindex="-1"></a>Those credible intervals all look reasonable (i.e. not ranging from 5% to 80% or whatever), but it's hard to see any trends from just this table. Let's plot it:</span>
<span id="cb106-2664"><a href="#cb106-2664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2665"><a href="#cb106-2665" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-marginal-means-seat-carpool}</span></span>
<span id="cb106-2666"><a href="#cb106-2666" aria-hidden="true" tabindex="-1"></a><span class="in">preds_seat_carpool_marginalized %&gt;% </span></span>
<span id="cb106-2667"><a href="#cb106-2667" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = avg, y = seat)) +</span></span>
<span id="cb106-2668"><a href="#cb106-2668" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye(aes(slab_alpha = carpool), fill = clrs[3]) + </span></span>
<span id="cb106-2669"><a href="#cb106-2669" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_percent()) +</span></span>
<span id="cb106-2670"><a href="#cb106-2670" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_slab_alpha_discrete(</span></span>
<span id="cb106-2671"><a href="#cb106-2671" aria-hidden="true" tabindex="-1"></a><span class="in">    range = c(0.4, 1),</span></span>
<span id="cb106-2672"><a href="#cb106-2672" aria-hidden="true" tabindex="-1"></a><span class="in">    labels = c("Non-carpoolers", "Carpoolers"),</span></span>
<span id="cb106-2673"><a href="#cb106-2673" aria-hidden="true" tabindex="-1"></a><span class="in">    guide = guide_legend(</span></span>
<span id="cb106-2674"><a href="#cb106-2674" aria-hidden="true" tabindex="-1"></a><span class="in">      reverse = TRUE, override.aes = list(fill = "grey10"), </span></span>
<span id="cb106-2675"><a href="#cb106-2675" aria-hidden="true" tabindex="-1"></a><span class="in">      keywidth = 0.8, keyheight = 0.8</span></span>
<span id="cb106-2676"><a href="#cb106-2676" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb106-2677"><a href="#cb106-2677" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb106-2678"><a href="#cb106-2678" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(</span></span>
<span id="cb106-2679"><a href="#cb106-2679" aria-hidden="true" tabindex="-1"></a><span class="in">    x = "Marginal means",</span></span>
<span id="cb106-2680"><a href="#cb106-2680" aria-hidden="true" tabindex="-1"></a><span class="in">    y = NULL,</span></span>
<span id="cb106-2681"><a href="#cb106-2681" aria-hidden="true" tabindex="-1"></a><span class="in">    slab_alpha = NULL</span></span>
<span id="cb106-2682"><a href="#cb106-2682" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb106-2683"><a href="#cb106-2683" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(</span></span>
<span id="cb106-2684"><a href="#cb106-2684" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.position = "top",</span></span>
<span id="cb106-2685"><a href="#cb106-2685" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.justification = "left",</span></span>
<span id="cb106-2686"><a href="#cb106-2686" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.margin = margin(l = -7, t = 0)</span></span>
<span id="cb106-2687"><a href="#cb106-2687" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb106-2688"><a href="#cb106-2688" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-2689"><a href="#cb106-2689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2690"><a href="#cb106-2690" aria-hidden="true" tabindex="-1"></a>Neat! The average posterior predicted probability of choosing six seats is substantially higher for carpoolers than for non-carpoolers, while the probability for seven and eight seats is bigger for carpoolers.</span>
<span id="cb106-2691"><a href="#cb106-2691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2692"><a href="#cb106-2692" aria-hidden="true" tabindex="-1"></a>We're most interested in the AMCE though, and not the marginal means, so we'll use <span class="in">`compare_levels()`</span> to find the carpool-specific differences between the effect of moving from 6 → 7 and 6 → seats:</span>
<span id="cb106-2693"><a href="#cb106-2693" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2694"><a href="#cb106-2694" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-amces-seat-carpool}</span></span>
<span id="cb106-2695"><a href="#cb106-2695" aria-hidden="true" tabindex="-1"></a><span class="in">amces_seat_carpool &lt;- preds_seat_carpool_marginalized %&gt;% </span></span>
<span id="cb106-2696"><a href="#cb106-2696" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(carpool) %&gt;% </span></span>
<span id="cb106-2697"><a href="#cb106-2697" aria-hidden="true" tabindex="-1"></a><span class="in">  compare_levels(variable = avg, by = seat, comparison = "control") </span></span>
<span id="cb106-2698"><a href="#cb106-2698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2699"><a href="#cb106-2699" aria-hidden="true" tabindex="-1"></a><span class="in">amces_seat_carpool %&gt;% </span></span>
<span id="cb106-2700"><a href="#cb106-2700" aria-hidden="true" tabindex="-1"></a><span class="in">  median_qi(avg)</span></span>
<span id="cb106-2701"><a href="#cb106-2701" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-2702"><a href="#cb106-2702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2703"><a href="#cb106-2703" aria-hidden="true" tabindex="-1"></a>Among carpoolers, the causal effect of moving from 6 → 7 passengers, holding all other features constant, is a 5ish percentage point increase in the probability of selecting the vehicle. The effect is bigger (9ish percentage points) when moving from 6 → 8.</span>
<span id="cb106-2704"><a href="#cb106-2704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2705"><a href="#cb106-2705" aria-hidden="true" tabindex="-1"></a>Among non-carpoolers, the causal effect is reversed. Moving from 6 → 7 passengers causes a 16 percentage point decrease in the probability of selection, while moving from 6 → 8 causes a 12 percentage point decrease, holding all other features constant.</span>
<span id="cb106-2706"><a href="#cb106-2706" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2707"><a href="#cb106-2707" aria-hidden="true" tabindex="-1"></a>These effects are "significant" and have a 90–97% probability of being greater than zero for carpoolers and 98–99% probability of being less than zero for the non-carpoolers.</span>
<span id="cb106-2708"><a href="#cb106-2708" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2709"><a href="#cb106-2709" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-pd-amces-seat-carpool}</span></span>
<span id="cb106-2710"><a href="#cb106-2710" aria-hidden="true" tabindex="-1"></a><span class="in"># Calculate probability of direction</span></span>
<span id="cb106-2711"><a href="#cb106-2711" aria-hidden="true" tabindex="-1"></a><span class="in">amces_seat_carpool %&gt;% </span></span>
<span id="cb106-2712"><a href="#cb106-2712" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(seat, carpool) %&gt;% </span></span>
<span id="cb106-2713"><a href="#cb106-2713" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(p_gt_0 = sum(avg &gt; 0) / n()) %&gt;% </span></span>
<span id="cb106-2714"><a href="#cb106-2714" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(p_lt_0 = 1 - p_gt_0)</span></span>
<span id="cb106-2715"><a href="#cb106-2715" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-2716"><a href="#cb106-2716" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2717"><a href="#cb106-2717" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-amces-seat-carpool}</span></span>
<span id="cb106-2718"><a href="#cb106-2718" aria-hidden="true" tabindex="-1"></a><span class="in">amces_seat_carpool %&gt;% </span></span>
<span id="cb106-2719"><a href="#cb106-2719" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = avg, y = seat)) +</span></span>
<span id="cb106-2720"><a href="#cb106-2720" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye(aes(slab_alpha = carpool), fill = clrs[3]) +</span></span>
<span id="cb106-2721"><a href="#cb106-2721" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0) +</span></span>
<span id="cb106-2722"><a href="#cb106-2722" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_pp) +</span></span>
<span id="cb106-2723"><a href="#cb106-2723" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_slab_alpha_discrete(</span></span>
<span id="cb106-2724"><a href="#cb106-2724" aria-hidden="true" tabindex="-1"></a><span class="in">    range = c(0.4, 1),</span></span>
<span id="cb106-2725"><a href="#cb106-2725" aria-hidden="true" tabindex="-1"></a><span class="in">    labels = c("Non-carpoolers", "Carpoolers"),</span></span>
<span id="cb106-2726"><a href="#cb106-2726" aria-hidden="true" tabindex="-1"></a><span class="in">    guide = guide_legend(</span></span>
<span id="cb106-2727"><a href="#cb106-2727" aria-hidden="true" tabindex="-1"></a><span class="in">      reverse = TRUE, override.aes = list(fill = "grey10"), </span></span>
<span id="cb106-2728"><a href="#cb106-2728" aria-hidden="true" tabindex="-1"></a><span class="in">      keywidth = 0.8, keyheight = 0.8</span></span>
<span id="cb106-2729"><a href="#cb106-2729" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb106-2730"><a href="#cb106-2730" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb106-2731"><a href="#cb106-2731" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(</span></span>
<span id="cb106-2732"><a href="#cb106-2732" aria-hidden="true" tabindex="-1"></a><span class="in">    x = "Percentage point change in probability of minivan selection",</span></span>
<span id="cb106-2733"><a href="#cb106-2733" aria-hidden="true" tabindex="-1"></a><span class="in">    y = NULL,</span></span>
<span id="cb106-2734"><a href="#cb106-2734" aria-hidden="true" tabindex="-1"></a><span class="in">    slab_alpha = NULL</span></span>
<span id="cb106-2735"><a href="#cb106-2735" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb106-2736"><a href="#cb106-2736" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(</span></span>
<span id="cb106-2737"><a href="#cb106-2737" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.position = "top",</span></span>
<span id="cb106-2738"><a href="#cb106-2738" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.justification = "left",</span></span>
<span id="cb106-2739"><a href="#cb106-2739" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.margin = margin(l = -7, t = 0)</span></span>
<span id="cb106-2740"><a href="#cb106-2740" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb106-2741"><a href="#cb106-2741" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-2742"><a href="#cb106-2742" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2743"><a href="#cb106-2743" aria-hidden="true" tabindex="-1"></a>Here are all the AMCEs across carpool status:</span>
<span id="cb106-2744"><a href="#cb106-2744" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2745"><a href="#cb106-2745" aria-hidden="true" tabindex="-1"></a><span class="in">```{r calculate-all-amces-carpool}</span></span>
<span id="cb106-2746"><a href="#cb106-2746" aria-hidden="true" tabindex="-1"></a><span class="in">amces_minivan_carpool &lt;- bind_rows(</span></span>
<span id="cb106-2747"><a href="#cb106-2747" aria-hidden="true" tabindex="-1"></a><span class="in">  seat = all_preds_brms_carpool %&gt;% </span></span>
<span id="cb106-2748"><a href="#cb106-2748" aria-hidden="true" tabindex="-1"></a><span class="in">    group_by(seat, carpool, .draw) %&gt;%</span></span>
<span id="cb106-2749"><a href="#cb106-2749" aria-hidden="true" tabindex="-1"></a><span class="in">    summarize(avg = mean(.epred)) %&gt;% </span></span>
<span id="cb106-2750"><a href="#cb106-2750" aria-hidden="true" tabindex="-1"></a><span class="in">    compare_levels(variable = avg, by = seat, comparison = "control") %&gt;% </span></span>
<span id="cb106-2751"><a href="#cb106-2751" aria-hidden="true" tabindex="-1"></a><span class="in">    rename(contrast = seat),</span></span>
<span id="cb106-2752"><a href="#cb106-2752" aria-hidden="true" tabindex="-1"></a><span class="in">  cargo = all_preds_brms_carpool %&gt;% </span></span>
<span id="cb106-2753"><a href="#cb106-2753" aria-hidden="true" tabindex="-1"></a><span class="in">    group_by(cargo, carpool, .draw) %&gt;%</span></span>
<span id="cb106-2754"><a href="#cb106-2754" aria-hidden="true" tabindex="-1"></a><span class="in">    summarize(avg = mean(.epred)) %&gt;% </span></span>
<span id="cb106-2755"><a href="#cb106-2755" aria-hidden="true" tabindex="-1"></a><span class="in">    compare_levels(variable = avg, by = cargo, comparison = "control") %&gt;% </span></span>
<span id="cb106-2756"><a href="#cb106-2756" aria-hidden="true" tabindex="-1"></a><span class="in">    rename(contrast = cargo),</span></span>
<span id="cb106-2757"><a href="#cb106-2757" aria-hidden="true" tabindex="-1"></a><span class="in">  eng = all_preds_brms_carpool %&gt;% </span></span>
<span id="cb106-2758"><a href="#cb106-2758" aria-hidden="true" tabindex="-1"></a><span class="in">    group_by(eng, carpool, .draw) %&gt;%</span></span>
<span id="cb106-2759"><a href="#cb106-2759" aria-hidden="true" tabindex="-1"></a><span class="in">    summarize(avg = mean(.epred)) %&gt;% </span></span>
<span id="cb106-2760"><a href="#cb106-2760" aria-hidden="true" tabindex="-1"></a><span class="in">    compare_levels(variable = avg, by = eng, comparison = "control") %&gt;% </span></span>
<span id="cb106-2761"><a href="#cb106-2761" aria-hidden="true" tabindex="-1"></a><span class="in">    rename(contrast = eng),</span></span>
<span id="cb106-2762"><a href="#cb106-2762" aria-hidden="true" tabindex="-1"></a><span class="in">  price = all_preds_brms_carpool %&gt;% </span></span>
<span id="cb106-2763"><a href="#cb106-2763" aria-hidden="true" tabindex="-1"></a><span class="in">    group_by(price, carpool, .draw) %&gt;%</span></span>
<span id="cb106-2764"><a href="#cb106-2764" aria-hidden="true" tabindex="-1"></a><span class="in">    summarize(avg = mean(.epred)) %&gt;% </span></span>
<span id="cb106-2765"><a href="#cb106-2765" aria-hidden="true" tabindex="-1"></a><span class="in">    compare_levels(variable = avg, by = price, comparison = "control") %&gt;% </span></span>
<span id="cb106-2766"><a href="#cb106-2766" aria-hidden="true" tabindex="-1"></a><span class="in">    rename(contrast = price),</span></span>
<span id="cb106-2767"><a href="#cb106-2767" aria-hidden="true" tabindex="-1"></a><span class="in">  .id = "term"</span></span>
<span id="cb106-2768"><a href="#cb106-2768" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb106-2769"><a href="#cb106-2769" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2770"><a href="#cb106-2770" aria-hidden="true" tabindex="-1"></a><span class="in">amces_minivan_carpool %&gt;% </span></span>
<span id="cb106-2771"><a href="#cb106-2771" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(term, carpool, contrast) %&gt;% </span></span>
<span id="cb106-2772"><a href="#cb106-2772" aria-hidden="true" tabindex="-1"></a><span class="in">  median_qi(avg)</span></span>
<span id="cb106-2773"><a href="#cb106-2773" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-2774"><a href="#cb106-2774" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2775"><a href="#cb106-2775" aria-hidden="true" tabindex="-1"></a>And finally, here's a polisci-style plot of all these AMCEs, which is so so neat. An individual's carpooling behavior interacts with seat count (increasing the seat count causes carpoolers to select the minivan more often), and it also interacts a bit with cargo space (increasing the cargo space makes both types of individuals more likely to select the minivan, but moreso for carpoolers) and also with price (increasing the price makes both types of individuals less likely to select the minivan, but moreso for carpoolers). Switching from gas → hybrid and gas → electric has a negative effect on both types of consumers, and there's no carpooling-based difference.</span>
<span id="cb106-2776"><a href="#cb106-2776" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2777"><a href="#cb106-2777" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-minivan-variable-levels-again}</span></span>
<span id="cb106-2778"><a href="#cb106-2778" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb106-2779"><a href="#cb106-2779" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-summary: "Extract variable labels"</span></span>
<span id="cb106-2780"><a href="#cb106-2780" aria-hidden="true" tabindex="-1"></a><span class="in">minivan_var_levels &lt;- tibble(</span></span>
<span id="cb106-2781"><a href="#cb106-2781" aria-hidden="true" tabindex="-1"></a><span class="in">  variable = c("seat", "cargo", "eng", "price")</span></span>
<span id="cb106-2782"><a href="#cb106-2782" aria-hidden="true" tabindex="-1"></a><span class="in">) %&gt;% </span></span>
<span id="cb106-2783"><a href="#cb106-2783" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(levels = map(variable, ~{</span></span>
<span id="cb106-2784"><a href="#cb106-2784" aria-hidden="true" tabindex="-1"></a><span class="in">    x &lt;- minivans[[.x]]</span></span>
<span id="cb106-2785"><a href="#cb106-2785" aria-hidden="true" tabindex="-1"></a><span class="in">    if (is.numeric(x)) {</span></span>
<span id="cb106-2786"><a href="#cb106-2786" aria-hidden="true" tabindex="-1"></a><span class="in">      ""</span></span>
<span id="cb106-2787"><a href="#cb106-2787" aria-hidden="true" tabindex="-1"></a><span class="in">    } else if (is.factor(x)) {</span></span>
<span id="cb106-2788"><a href="#cb106-2788" aria-hidden="true" tabindex="-1"></a><span class="in">      levels(x)</span></span>
<span id="cb106-2789"><a href="#cb106-2789" aria-hidden="true" tabindex="-1"></a><span class="in">    } else {</span></span>
<span id="cb106-2790"><a href="#cb106-2790" aria-hidden="true" tabindex="-1"></a><span class="in">      sort(unique(x))</span></span>
<span id="cb106-2791"><a href="#cb106-2791" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb106-2792"><a href="#cb106-2792" aria-hidden="true" tabindex="-1"></a><span class="in">  })) %&gt;% </span></span>
<span id="cb106-2793"><a href="#cb106-2793" aria-hidden="true" tabindex="-1"></a><span class="in">  unnest(levels) %&gt;% </span></span>
<span id="cb106-2794"><a href="#cb106-2794" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(term = paste0(variable, levels))</span></span>
<span id="cb106-2795"><a href="#cb106-2795" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2796"><a href="#cb106-2796" aria-hidden="true" tabindex="-1"></a><span class="in"># Make a little lookup table for nicer feature labels</span></span>
<span id="cb106-2797"><a href="#cb106-2797" aria-hidden="true" tabindex="-1"></a><span class="in">minivan_var_lookup &lt;- tribble(</span></span>
<span id="cb106-2798"><a href="#cb106-2798" aria-hidden="true" tabindex="-1"></a><span class="in">  ~variable, ~variable_nice,</span></span>
<span id="cb106-2799"><a href="#cb106-2799" aria-hidden="true" tabindex="-1"></a><span class="in">  "seat",    "Passengers",</span></span>
<span id="cb106-2800"><a href="#cb106-2800" aria-hidden="true" tabindex="-1"></a><span class="in">  "cargo",   "Cargo space",</span></span>
<span id="cb106-2801"><a href="#cb106-2801" aria-hidden="true" tabindex="-1"></a><span class="in">  "eng",     "Engine type",</span></span>
<span id="cb106-2802"><a href="#cb106-2802" aria-hidden="true" tabindex="-1"></a><span class="in">  "price",   "Price (thousands of $)"</span></span>
<span id="cb106-2803"><a href="#cb106-2803" aria-hidden="true" tabindex="-1"></a><span class="in">) %&gt;% </span></span>
<span id="cb106-2804"><a href="#cb106-2804" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(variable_nice = fct_inorder(variable_nice))</span></span>
<span id="cb106-2805"><a href="#cb106-2805" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-2806"><a href="#cb106-2806" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2807"><a href="#cb106-2807" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-amces-minivans-carpool, fig.height=5}</span></span>
<span id="cb106-2808"><a href="#cb106-2808" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb106-2809"><a href="#cb106-2809" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-summary: "Combine full dataset of factor levels with marginalized posterior draws and make plot"</span></span>
<span id="cb106-2810"><a href="#cb106-2810" aria-hidden="true" tabindex="-1"></a><span class="in">posterior_amces_minivan_carpool_nested &lt;- amces_minivan_carpool %&gt;% </span></span>
<span id="cb106-2811"><a href="#cb106-2811" aria-hidden="true" tabindex="-1"></a><span class="in">  separate_wider_delim(</span></span>
<span id="cb106-2812"><a href="#cb106-2812" aria-hidden="true" tabindex="-1"></a><span class="in">    contrast,</span></span>
<span id="cb106-2813"><a href="#cb106-2813" aria-hidden="true" tabindex="-1"></a><span class="in">    delim = " - ", </span></span>
<span id="cb106-2814"><a href="#cb106-2814" aria-hidden="true" tabindex="-1"></a><span class="in">    names = c("variable_level", "reference_level")</span></span>
<span id="cb106-2815"><a href="#cb106-2815" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;% </span></span>
<span id="cb106-2816"><a href="#cb106-2816" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(term, variable_level) %&gt;% </span></span>
<span id="cb106-2817"><a href="#cb106-2817" aria-hidden="true" tabindex="-1"></a><span class="in">  nest()</span></span>
<span id="cb106-2818"><a href="#cb106-2818" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2819"><a href="#cb106-2819" aria-hidden="true" tabindex="-1"></a><span class="in">plot_data_minivan_carpool &lt;- minivan_var_levels %&gt;%</span></span>
<span id="cb106-2820"><a href="#cb106-2820" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(</span></span>
<span id="cb106-2821"><a href="#cb106-2821" aria-hidden="true" tabindex="-1"></a><span class="in">    posterior_amces_minivan_carpool_nested,</span></span>
<span id="cb106-2822"><a href="#cb106-2822" aria-hidden="true" tabindex="-1"></a><span class="in">    by = join_by(variable == term, levels == variable_level)</span></span>
<span id="cb106-2823"><a href="#cb106-2823" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;%</span></span>
<span id="cb106-2824"><a href="#cb106-2824" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(data = map_if(data, is.null, ~ tibble(avg = 0))) %&gt;% </span></span>
<span id="cb106-2825"><a href="#cb106-2825" aria-hidden="true" tabindex="-1"></a><span class="in">  unnest(data) %&gt;% </span></span>
<span id="cb106-2826"><a href="#cb106-2826" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(minivan_var_lookup, by = join_by(variable)) %&gt;% </span></span>
<span id="cb106-2827"><a href="#cb106-2827" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(across(c(levels, variable_nice), ~fct_inorder(.))) %&gt;% </span></span>
<span id="cb106-2828"><a href="#cb106-2828" aria-hidden="true" tabindex="-1"></a><span class="in">  # Make the missing carpool values be "yes" for the reference category</span></span>
<span id="cb106-2829"><a href="#cb106-2829" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(carpool = replace_na(carpool, "yes"))</span></span>
<span id="cb106-2830"><a href="#cb106-2830" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2831"><a href="#cb106-2831" aria-hidden="true" tabindex="-1"></a><span class="in">plot_data_minivan_carpool %&gt;% </span></span>
<span id="cb106-2832"><a href="#cb106-2832" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = avg, y = levels, fill = variable_nice)) +</span></span>
<span id="cb106-2833"><a href="#cb106-2833" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0) +</span></span>
<span id="cb106-2834"><a href="#cb106-2834" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye(aes(slab_alpha = carpool), normalize = "groups") + </span></span>
<span id="cb106-2835"><a href="#cb106-2835" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_col(facets = "variable_nice", scales = "free_y", space = "free") +</span></span>
<span id="cb106-2836"><a href="#cb106-2836" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_pp) +</span></span>
<span id="cb106-2837"><a href="#cb106-2837" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_slab_alpha_discrete(</span></span>
<span id="cb106-2838"><a href="#cb106-2838" aria-hidden="true" tabindex="-1"></a><span class="in">    range = c(0.4, 1),</span></span>
<span id="cb106-2839"><a href="#cb106-2839" aria-hidden="true" tabindex="-1"></a><span class="in">    labels = c("Non-carpoolers", "Carpoolers"),</span></span>
<span id="cb106-2840"><a href="#cb106-2840" aria-hidden="true" tabindex="-1"></a><span class="in">    guide = guide_legend(</span></span>
<span id="cb106-2841"><a href="#cb106-2841" aria-hidden="true" tabindex="-1"></a><span class="in">      reverse = TRUE, override.aes = list(fill = "grey10"), </span></span>
<span id="cb106-2842"><a href="#cb106-2842" aria-hidden="true" tabindex="-1"></a><span class="in">      keywidth = 0.8, keyheight = 0.8</span></span>
<span id="cb106-2843"><a href="#cb106-2843" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb106-2844"><a href="#cb106-2844" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb106-2845"><a href="#cb106-2845" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_manual(values = clrs[c(3, 7, 8, 9)], guide = "none") +</span></span>
<span id="cb106-2846"><a href="#cb106-2846" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(</span></span>
<span id="cb106-2847"><a href="#cb106-2847" aria-hidden="true" tabindex="-1"></a><span class="in">    x = "Percentage point change in probability of minivan selection",</span></span>
<span id="cb106-2848"><a href="#cb106-2848" aria-hidden="true" tabindex="-1"></a><span class="in">    y = NULL,</span></span>
<span id="cb106-2849"><a href="#cb106-2849" aria-hidden="true" tabindex="-1"></a><span class="in">    title = "AMCEs across respondent carpool status",</span></span>
<span id="cb106-2850"><a href="#cb106-2850" aria-hidden="true" tabindex="-1"></a><span class="in">    slab_alpha = NULL</span></span>
<span id="cb106-2851"><a href="#cb106-2851" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb106-2852"><a href="#cb106-2852" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(</span></span>
<span id="cb106-2853"><a href="#cb106-2853" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.position = "top",</span></span>
<span id="cb106-2854"><a href="#cb106-2854" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.justification = "left",</span></span>
<span id="cb106-2855"><a href="#cb106-2855" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.margin = margin(l = -7, t = 0)</span></span>
<span id="cb106-2856"><a href="#cb106-2856" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb106-2857"><a href="#cb106-2857" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-2858"><a href="#cb106-2858" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2859"><a href="#cb106-2859" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb106-2860"><a href="#cb106-2860" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2861"><a href="#cb106-2861" aria-hidden="true" tabindex="-1"></a><span class="fu"># tl;dr: Moral of the story</span></span>
<span id="cb106-2862"><a href="#cb106-2862" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2863"><a href="#cb106-2863" aria-hidden="true" tabindex="-1"></a>holy crap this might be the longest guide I've ever posted here. This is hard.</span>
<span id="cb106-2864"><a href="#cb106-2864" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2865"><a href="#cb106-2865" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb106-2866"><a href="#cb106-2866" aria-hidden="true" tabindex="-1"></a><span class="fu">### Main points</span></span>
<span id="cb106-2867"><a href="#cb106-2867" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2868"><a href="#cb106-2868" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>OLS is nice and easy, but it fails to capture all the dynamics between sets of features and individual characteristics. Use multilevel multinomial models to account for all the heterogeneity in choices and individuals.</span>
<span id="cb106-2869"><a href="#cb106-2869" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2870"><a href="#cb106-2870" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>{brms} provides a powerful, easy-to-use frontend for running complex multilevel models in Stan. There's no need to write raw Stan code if you don't want to.</span>
<span id="cb106-2871"><a href="#cb106-2871" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2872"><a href="#cb106-2872" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>This is hard stuff. Multinomial logit models are complex and weird to work with. But the power and flexibility and richness is worth it.</span>
<span id="cb106-2873"><a href="#cb106-2873" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb106-2874"><a href="#cb106-2874" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2875"><a href="#cb106-2875" aria-hidden="true" tabindex="-1"></a>Here's a general summary of the main code for all this, based on a hypothetical conjoint survey with three features, like this:</span>
<span id="cb106-2876"><a href="#cb106-2876" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2877"><a href="#cb106-2877" aria-hidden="true" tabindex="-1"></a>| Features/Attributes | Levels            |</span>
<span id="cb106-2878"><a href="#cb106-2878" aria-hidden="true" tabindex="-1"></a>|:--------------------|:------------------|</span>
<span id="cb106-2879"><a href="#cb106-2879" aria-hidden="true" tabindex="-1"></a>| Brand (<span class="in">`brand`</span>)     | A, B, C           |</span>
<span id="cb106-2880"><a href="#cb106-2880" aria-hidden="true" tabindex="-1"></a>| Color (<span class="in">`color`</span>)     | Blue, red, yellow |</span>
<span id="cb106-2881"><a href="#cb106-2881" aria-hidden="true" tabindex="-1"></a>| Size (<span class="in">`size`</span>)       | Small, large      |</span>
<span id="cb106-2882"><a href="#cb106-2882" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2883"><a href="#cb106-2883" aria-hidden="true" tabindex="-1"></a>And imagine that we have data on respondent age (<span class="in">`resp_age`</span>) and education (<span class="in">`resp_ed`</span>).</span>
<span id="cb106-2884"><a href="#cb106-2884" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2885"><a href="#cb106-2885" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Specify a full luxury multilevel model with individual-level characteristics informing choice-level coefficients like this (<span class="co">[</span><span class="ot">see here</span><span class="co">](#translating-from-marketing-style-stan-notation-to-brms-syntax)</span>):</span>
<span id="cb106-2886"><a href="#cb106-2886" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2887"><a href="#cb106-2887" aria-hidden="true" tabindex="-1"></a><span class="in">```{r example-mlm-formula, eval=FALSE, indent="  "}</span></span>
<span id="cb106-2888"><a href="#cb106-2888" aria-hidden="true" tabindex="-1"></a><span class="in">model &lt;- brm(</span></span>
<span id="cb106-2889"><a href="#cb106-2889" aria-hidden="true" tabindex="-1"></a><span class="in">  bf(choice ~</span></span>
<span id="cb106-2890"><a href="#cb106-2890" aria-hidden="true" tabindex="-1"></a><span class="in">      # Columns for feature interacted with respondent-level covariates</span></span>
<span id="cb106-2891"><a href="#cb106-2891" aria-hidden="true" tabindex="-1"></a><span class="in">      (brand + color + size) * (resp_age + resp_ed) +</span></span>
<span id="cb106-2892"><a href="#cb106-2892" aria-hidden="true" tabindex="-1"></a><span class="in">      # Respondent-specific intercepts and slopes for all features</span></span>
<span id="cb106-2893"><a href="#cb106-2893" aria-hidden="true" tabindex="-1"></a><span class="in">      (1 + brand + color + sice | ID | resp_id)),</span></span>
<span id="cb106-2894"><a href="#cb106-2894" aria-hidden="true" tabindex="-1"></a><span class="in">  family = categorical(),</span></span>
<span id="cb106-2895"><a href="#cb106-2895" aria-hidden="true" tabindex="-1"></a><span class="in">  data = data</span></span>
<span id="cb106-2896"><a href="#cb106-2896" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb106-2897"><a href="#cb106-2897" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-2898"><a href="#cb106-2898" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2899"><a href="#cb106-2899" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Find marketing-style predicted shares for hypothetical mixes of products by feeding a smaller dataset of hypothetical mixes to <span class="in">`brms::posterior_linpred()`</span> (or <span class="in">`tidybayes::linpred_draws()`</span>) to find utility (or logit-scale predictions), then calculate the share for each draw, and then marginalize (or average) the shares across the multiple choices within each draw. (<span class="co">[</span><span class="ot">See here</span><span class="co">](#predictions-2)</span>.)</span>
<span id="cb106-2900"><a href="#cb106-2900" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2901"><a href="#cb106-2901" aria-hidden="true" tabindex="-1"></a><span class="in">```{r example-shares, eval=FALSE, indent="  "}</span></span>
<span id="cb106-2902"><a href="#cb106-2902" aria-hidden="true" tabindex="-1"></a><span class="in">product_mix &lt;- tribble(</span></span>
<span id="cb106-2903"><a href="#cb106-2903" aria-hidden="true" tabindex="-1"></a><span class="in">  ~brand, ~color,   ~size,   ~resp_age,</span></span>
<span id="cb106-2904"><a href="#cb106-2904" aria-hidden="true" tabindex="-1"></a><span class="in">  "A",    "Blue",   "Small", 25,</span></span>
<span id="cb106-2905"><a href="#cb106-2905" aria-hidden="true" tabindex="-1"></a><span class="in">  "B",    "Red",    "Small", 25,</span></span>
<span id="cb106-2906"><a href="#cb106-2906" aria-hidden="true" tabindex="-1"></a><span class="in">  "C",    "Yellow", "Large", 25,</span></span>
<span id="cb106-2907"><a href="#cb106-2907" aria-hidden="true" tabindex="-1"></a><span class="in">  "A",    "Blue",   "Small", 45,</span></span>
<span id="cb106-2908"><a href="#cb106-2908" aria-hidden="true" tabindex="-1"></a><span class="in">  "B",    "Red",    "Small", 45,</span></span>
<span id="cb106-2909"><a href="#cb106-2909" aria-hidden="true" tabindex="-1"></a><span class="in">  "C",    "Yellow", "Large", 45</span></span>
<span id="cb106-2910"><a href="#cb106-2910" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb106-2911"><a href="#cb106-2911" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2912"><a href="#cb106-2912" aria-hidden="true" tabindex="-1"></a><span class="in">model %&gt;% </span></span>
<span id="cb106-2913"><a href="#cb106-2913" aria-hidden="true" tabindex="-1"></a><span class="in">  linpred_draws(newdata = product_mix, value = "utility") %&gt;% </span></span>
<span id="cb106-2914"><a href="#cb106-2914" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(.draw, .category, resp_age) %&gt;% </span></span>
<span id="cb106-2915"><a href="#cb106-2915" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(share = exp(utility) / sum(exp(utility))) %&gt;% </span></span>
<span id="cb106-2916"><a href="#cb106-2916" aria-hidden="true" tabindex="-1"></a><span class="in">  # Marginalize across the outcomes within each draw</span></span>
<span id="cb106-2917"><a href="#cb106-2917" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(brand, color, size, resp_age, .draw) %&gt;% </span></span>
<span id="cb106-2918"><a href="#cb106-2918" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(share = mean(share))</span></span>
<span id="cb106-2919"><a href="#cb106-2919" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-2920"><a href="#cb106-2920" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2921"><a href="#cb106-2921" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Find political science-style marginal means and AMCEs by feeding a *complete grid of all possible feature levels*, along with any respondent-level characteristics of interest to <span class="in">`brms::posterior_epred()`</span> (or <span class="in">`tidybayes::epred_draws()`</span>), then filter those probabilities to look only at option 0 (i.e. not choosing an option), and calculate <span class="in">`1 - prediction`</span> to reverse it. Then group by the feature level and respondent-level characteristics you're interested in, find the average of predictions, and marginalize (or average) out the other covariates in each draw. (<span class="co">[</span><span class="ot">See here</span><span class="co">](#amces-2)</span>.)</span>
<span id="cb106-2922"><a href="#cb106-2922" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2923"><a href="#cb106-2923" aria-hidden="true" tabindex="-1"></a><span class="in">```{r example-mms-and-amces, eval=FALSE, indent="  "}</span></span>
<span id="cb106-2924"><a href="#cb106-2924" aria-hidden="true" tabindex="-1"></a><span class="in">all_feature_combos_with_age &lt;- data %&gt;% </span></span>
<span id="cb106-2925"><a href="#cb106-2925" aria-hidden="true" tabindex="-1"></a><span class="in">  tidyr::expand(brand, color, size, resp_age)</span></span>
<span id="cb106-2926"><a href="#cb106-2926" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2927"><a href="#cb106-2927" aria-hidden="true" tabindex="-1"></a><span class="in">all_predictions &lt;- model %&gt;% </span></span>
<span id="cb106-2928"><a href="#cb106-2928" aria-hidden="true" tabindex="-1"></a><span class="in">  epred_draws(newdata = all_feature_combos_with_age) %&gt;% </span></span>
<span id="cb106-2929"><a href="#cb106-2929" aria-hidden="true" tabindex="-1"></a><span class="in">  # Only look at category 0 and reverse predictions</span></span>
<span id="cb106-2930"><a href="#cb106-2930" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(.category == 0) %&gt;% </span></span>
<span id="cb106-2931"><a href="#cb106-2931" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(.epred = 1 - .epred)</span></span>
<span id="cb106-2932"><a href="#cb106-2932" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2933"><a href="#cb106-2933" aria-hidden="true" tabindex="-1"></a><span class="in"># Marginal means for brand across respondent age</span></span>
<span id="cb106-2934"><a href="#cb106-2934" aria-hidden="true" tabindex="-1"></a><span class="in">all_predictions %&gt;% </span></span>
<span id="cb106-2935"><a href="#cb106-2935" aria-hidden="true" tabindex="-1"></a><span class="in">  # Marginalize out the other covariates in each draw</span></span>
<span id="cb106-2936"><a href="#cb106-2936" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(brand, resp_age, .draw) %&gt;% </span></span>
<span id="cb106-2937"><a href="#cb106-2937" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(avg = mean(.epred))</span></span>
<span id="cb106-2938"><a href="#cb106-2938" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2939"><a href="#cb106-2939" aria-hidden="true" tabindex="-1"></a><span class="in"># AMCEs for brand across respondent age</span></span>
<span id="cb106-2940"><a href="#cb106-2940" aria-hidden="true" tabindex="-1"></a><span class="in">all_predictions %&gt;% </span></span>
<span id="cb106-2941"><a href="#cb106-2941" aria-hidden="true" tabindex="-1"></a><span class="in">  # Marginalize out the other covariates in each draw</span></span>
<span id="cb106-2942"><a href="#cb106-2942" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(brand, resp_age, .draw) %&gt;% </span></span>
<span id="cb106-2943"><a href="#cb106-2943" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(avg = mean(.epred)) %&gt;% </span></span>
<span id="cb106-2944"><a href="#cb106-2944" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(resp_age) %&gt;% </span></span>
<span id="cb106-2945"><a href="#cb106-2945" aria-hidden="true" tabindex="-1"></a><span class="in">  compare_levels(variable = avg, by = brand, comparison = "control")</span></span>
<span id="cb106-2946"><a href="#cb106-2946" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-2947"><a href="#cb106-2947" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2948"><a href="#cb106-2948" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb106-2949"><a href="#cb106-2949" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2950"><a href="#cb106-2950" aria-hidden="true" tabindex="-1"></a>Fin.</span></code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
<p><span class="faux-block"><i class="fa-brands fa-creative-commons" aria-label="creative-commons"></i> 2007–2024 Andrew Heiss</span> <span class="faux-block">All content licensed under<br><a href="https://creativecommons.org/licenses/by/4.0/"><i class="fa-brands fa-creative-commons" aria-label="creative-commons"></i> <i class="fa-brands fa-creative-commons-by" aria-label="creative-commons-by"></i> Creative Commons CC BY 4.0</a></span></p>
</div>   
    <div class="nav-footer-center">
<p><span class="faux-block"><i class="fa-brands fa-orcid" aria-label="orcid"></i> <strong>ORCID</strong> <a href="https://orcid.org/0000-0002-3948-3914">0000-0002-3948-3914</a></span> <span class="faux-block"><i class="fa-solid fa-key" aria-label="key"></i> <a href="../../../../../pgp_ath.asc.txt">PGP public key</a>   <i class="fa-solid fa-fingerprint" aria-label="fingerprint"></i> Fingerprint:<br><span class="fingerprint">4AA2 FA83 A8B2 05A4 E30F<br> 610D 1382 6216 9178 36AB</span></span></p>
</div>
    <div class="nav-footer-right">
<p><span class="faux-block">Made with <i class="fa-brands fa-r-project" aria-label="r-project"></i> and <a href="https://quarto.org/">Quarto</a></span> <span class="faux-block"><a href="https://github.com/andrewheiss/ath-quarto">View the source at <i class="fa-brands fa-github" aria-label="github"></i> GitHub</a></span></p>
</div>
  </div>
</footer>


</body></html>