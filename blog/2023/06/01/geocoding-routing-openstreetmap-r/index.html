<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Andrew Heiss">
<meta name="description" content="Use R to get geocoded location and routing data from OpenStreetMap and explore our family’s impending 5,000 mile road trip around the USA">
<title>How to make fancy road trip maps with R and OpenStreetMap | Andrew Heiss – Andrew Heiss</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../../../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../../../">
<link href="../../../../..//files/favicon-512.png" rel="icon" type="image/png">
<script src="../../../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../../../site_libs/quarto-html/quarto-syntax-highlighting-17c909d5fd25ae21b861c0c7a49b2096.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../../../site_libs/bootstrap/bootstrap-5cd0811f461c8271ae6bab49df9501be.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<link href="../../../../../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../../../../../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<script src="../../../../../site_libs/quarto-contrib/iconify-2.0.0/iconify-icon.min.js"></script><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script type="text/javascript">

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-527449-5', 'auto');

ga('send', {
  hitType: 'pageview',
  'anonymizeIp': true,
});
</script><style>

      .quarto-title-block .quarto-title-banner {
        background: #170C3A;
      }
</style>
<meta property="og:title" content="How to make fancy road trip maps with R and OpenStreetMap | Andrew Heiss">
<meta property="og:description" content="Use R to get geocoded location and routing data from OpenStreetMap and explore our family’s impending 5,000 mile road trip around the USA">
<meta property="og:image" content="https://www.andrewheiss.com/blog/2023/06/01/geocoding-routing-openstreetmap-r/index_files/figure-html/plot-routes-stops-distances-1.png">
<meta property="og:site_name" content="Andrew Heiss">
<meta property="og:locale" content="en_US">
<meta property="og:image:height" content="1245">
<meta property="og:image:width" content="2016">
<meta name="twitter:title" content="How to make fancy road trip maps with R and OpenStreetMap | Andrew Heiss">
<meta name="twitter:description" content="Use R to get geocoded location and routing data from OpenStreetMap and explore our family’s impending 5,000 mile road trip around the USA">
<meta name="twitter:image" content="https://www.andrewheiss.com/blog/2023/06/01/geocoding-routing-openstreetmap-r/index_files/figure-html/plot-routes-stops-distances-1.png">
<meta name="twitter:creator" content="@andrewheiss">
<meta name="twitter:site" content="@andrewheiss">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image-height" content="1245">
<meta name="twitter:image-width" content="2016">
</head>
<body class="floating nav-fixed slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../../../index.html">
    <span class="navbar-title">Andrew Heiss</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link" href="../../../../../index.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../cv/index.html"> 
<span class="menu-text">CV</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../blog/index.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../research/index.html"> 
<span class="menu-text">Research</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../teaching/index.html"> 
<span class="menu-text">Teaching</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../talks/index.html"> 
<span class="menu-text">Talks</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../now/index.html"> 
<span class="menu-text">Now</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../uses/index.html"> 
<span class="menu-text">Uses</span></a>
  </li>  
</ul>
<ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item">
    <a class="nav-link" href="../../../../../atom.xml"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:rss" style="font-size: 1.1em;" aria-label="Icon rss from bi Iconify.design set." title="RSS"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="mailto:aheiss@gsu.edu"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:envelope" style="font-size: 1.1em;" aria-label="Icon envelope from bi Iconify.design set." title="E-mail"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://bsky.app/profile/andrew.heiss.phd" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="fa6-brands:bluesky" style="font-size: 1.1em;" aria-label="Icon bluesky from fa6-brands Iconify.design set." title="Bluesky"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://fediscience.org/users/andrew/" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:mastodon" style="font-size: 1.1em;" aria-label="Icon mastodon from bi Iconify.design set." title="Mastodon"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/andrewheiss" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:github" style="font-size: 1.1em;" aria-label="Icon github from bi Iconify.design set." title="GitHub"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.youtube.com/andrewheiss" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:youtube" style="font-size: 1.1em;" aria-label="Icon youtube from bi Iconify.design set." title="YouTube"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.heissatopia.com/"> 
<span class="menu-text"><iconify-icon inline="" icon="fa6-brands:blogger" style="font-size: 1.15em;" aria-label="Icon blogger from fa6-brands Iconify.design set." title="Blogger"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.linkedin.com/in/andrewheiss" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:linkedin" style="font-size: 1.1em;" aria-label="Icon linkedin from bi Iconify.design set." title="LinkedIn"></iconify-icon></span></a>
  </li>  
</ul>
</div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><header id="title-block-header" class="quarto-title-block default blog-post page-columns page-full"><div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">How to make fancy road trip maps with R and OpenStreetMap</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
                  <div>
        <div class="description">
          Use R to get geocoded location and routing data from OpenStreetMap and explore our family’s impending 5,000 mile road trip around the USA
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">r</div>
                <div class="quarto-category">tidyverse</div>
                <div class="quarto-category">ggplot</div>
                <div class="quarto-category">gis</div>
                <div class="quarto-category">maps</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p><a href="https://www.andrewheiss.com/">Andrew Heiss</a> <a href="https://orcid.org/0000-0002-3948-3914" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">Thursday, June 1, 2023</p>
      </div>
    </div>
    
      
      <div>
      <div class="quarto-title-meta-heading">Doi</div>
      <div class="quarto-title-meta-contents">
        <p class="doi">
          <a href="https://doi.org/10.59350/rgwda-0tv16">10.59350/rgwda-0tv16</a>
        </p>
      </div>
    </div>
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Contents</h2>
   
  <ul>
<li>
<a href="#getting-started" id="toc-getting-started" class="nav-link active" data-scroll-target="#getting-started">Getting started</a>
  <ul class="collapse">
<li><a href="#who-this-post-is-for" id="toc-who-this-post-is-for" class="nav-link" data-scroll-target="#who-this-post-is-for">Who this post is for</a></li>
  <li><a href="#packages-and-functions" id="toc-packages-and-functions" class="nav-link" data-scroll-target="#packages-and-functions">Packages and functions</a></li>
  </ul>
</li>
  <li><a href="#state-data" id="toc-state-data" class="nav-link" data-scroll-target="#state-data">State data</a></li>
  <li><a href="#stops-data" id="toc-stops-data" class="nav-link" data-scroll-target="#stops-data">Stops data</a></li>
  <li><a href="#routing" id="toc-routing" class="nav-link" data-scroll-target="#routing">Routing</a></li>
  <li><a href="#states-crossed-through" id="toc-states-crossed-through" class="nav-link" data-scroll-target="#states-crossed-through">States crossed through</a></li>
  <li><a href="#summary-statistics" id="toc-summary-statistics" class="nav-link" data-scroll-target="#summary-statistics">Summary statistics</a></li>
  <li>
<a href="#faceting" id="toc-faceting" class="nav-link" data-scroll-target="#faceting">Faceting</a>
  <ul class="collapse">
<li><a href="#fixing-state-highlighting" id="toc-fixing-state-highlighting" class="nav-link" data-scroll-target="#fixing-state-highlighting">Fixing state highlighting</a></li>
  <li><a href="#fixing-missing-destination-cities" id="toc-fixing-missing-destination-cities" class="nav-link" data-scroll-target="#fixing-missing-destination-cities">Fixing missing destination cities</a></li>
  </ul>
</li>
  <li>
<a href="#zooming-in" id="toc-zooming-in" class="nav-link" data-scroll-target="#zooming-in">Zooming in</a>
  <ul class="collapse">
<li><a href="#one-day-of-the-trip" id="toc-one-day-of-the-trip" class="nav-link" data-scroll-target="#one-day-of-the-trip">One day of the trip</a></li>
  <li><a href="#all-the-days-of-the-trip" id="toc-all-the-days-of-the-trip" class="nav-link" data-scroll-target="#all-the-days-of-the-trip">All the days of the trip</a></li>
  </ul>
</li>
  </ul></nav>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content"><p>In a couple days, I’m going to drive across the country to Utah, my home state. I haven’t been out west with my whole family in four years—not since 2019 when we moved from Spanish Fork, Utah to Atlanta, Georgia. According to Google Maps, <a href="https://goo.gl/maps/aGXJPL85LMTW2cuS9">it’s a mere 1,900 miles</a> (3,000 kilometers) through the middle of the United States and should take 28 hours, assuming no stops.</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p><img src="img/google-maps-ga-to-ut.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">Google Maps route from Atlanta, Georgia to Spanish Fork, Utah</figcaption></figure>
</div>
<p>For bonus fun though, my wife and I decided to make this trip even more adventurous and hit as many exciting stops as possible. So rather than drive through the middle of Kansas, we’re going along the southern border on the way there, visiting New Orleans, Louisiana; San Antonio, Texas; <a href="https://en.wikipedia.org/wiki/Carlsbad_Caverns_National_Park">Carlsbad Caverns</a>, New Mexico; the <a href="https://en.wikipedia.org/wiki/Grand_Canyon">Grand Canyon</a> in Arizona; and then camping for a couple days at <a href="https://en.wikipedia.org/wiki/Capitol_Reef_National_Park">Capitol Reef National Park</a> in Southern Utah before finally arriving at my aunt’s house in Spanish Fork, Utah. On the way home, we’re going across the northern part of the United States, visiting my sister in Idaho before heading towards <a href="https://en.wikipedia.org/wiki/Yellowstone_National_Park">Yellowstone</a> in Wyoming; <a href="https://en.wikipedia.org/wiki/Devils_Tower">Devil’s Tower</a> in Wyoming; <a href="https://en.wikipedia.org/wiki/Mount_Rushmore">Mount Rushmore</a> in South Dakota; and <a href="https://en.wikipedia.org/wiki/Nauvoo,_Illinois">Nauvoo, Illinois</a> (<a href="https://www.churchofjesuschrist.org/learn/locations/historic-nauvoo">Mormons!</a>). It’s going to be an awesome—but <em>way</em> longer—mega road trip.</p>
<p>To help keep six kids entertained beyond just plugging them into iPads, my wife made some road trip journals to make the experience more memorable and educational, and we’re bringing a bunch of books and extra materials about each of the stops we’ll be making so they can do research along the way.</p>
<p>I just finished revamping my <a href="https://datavizs23.classes.andrewheiss.com/">online data visualization class</a> this week since the summer semester is starting next week, so visualizing data through maps has been on my mind. In my session on visualizing maps, <a href="https://datavizs23.classes.andrewheiss.com/example/12-example.html#making-your-own-geocoded-data">I added a section on making and visualizing your own geocoded data</a> (i.e.&nbsp;plotting specific cities on a map), so I figured it would be neat to visualize this huge road trip somehow to make some maps to include in the kids’ journals.</p>
<p>Getting the latitude and longitude coordinates for specific cities or addresses is super easy—you can either <a href="https://datavizs23.classes.andrewheiss.com/example/12-example.html#making-your-own-geocoded-data">right click on Google Maps and copy specific coordinates</a>, or you can <a href="https://datavizs23.classes.andrewheiss.com/example/12-example.html#automatic-geoencoding-by-address">automate it</a> with the <a href="https://jessecambon.github.io/tidygeocoder/">{tidygeocoder} package</a> in R.</p>
<p>Getting route coordinates is a lot trickier though, since it involves all sorts of complex algorithms (accounting for road locations, speed limits, traffic, etc.). This is why Google Maps is so invaluable—it does an excellent job of figuring this out. But Google’s data is proprietary.</p>
<p>There’s an R package named <a href="https://github.com/michaeldorman/mapsapi">{mapsapi}</a> that makes it really easy to get data from the Google Maps API, and if you get an API key from Google (<a href="https://developers.google.com/maps/documentation/directions/start#create-project">following these instructions</a>), you can extract geocoded {sf}-compatible route data from Google with the <code>mp_directions()</code> function. It’s neat and quick and easy, but it’s expensive. When I first started playing with the maps API in R, I racked up $0.50 in charges just with testing a bunch of routing options. The Google Maps API gives you $200 in free credits every month and I was well below that amount, but it still was a little nervewracking to see that it was that expensive in just an hour of tinkering. Also, setting up the API key was fairly complicated (creating a Google Cloud project, setting up billing, enabling specific services, storing the API key securely on my computer, etc.), and I don’t want to go through that hassle in the future.</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p><img src="img/google-maps-api-costs.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">Google Maps API costs</figcaption></figure>
</div>
<p>I’m a fan of the <a href="https://www.openstreetmap.org/">OpenStreetMap project</a>, and it’s <a href="https://jessecambon.github.io/tidygeocoder/articles/geocoder_services.html">one of the backends</a> (through <a href="https://nominatim.org/">Nominatim</a>) for {tidygeocoder} (and I used it in a <a href="https://www.andrewheiss.com/blog/2023/04/26/middle-earth-mapping-sf-r-gis/#in-the-united-states">previous blog post</a> showing some coordinates in interactive Leaflet maps). In searching around the internet for open source alternatives to the Google Maps API, I discovered that OpenStreetMap can also do directions and routing through the <a href="http://project-osrm.org/">Open Source Routing Machine (OSRM) project</a>. You can use OSRM’s <a href="https://map.project-osrm.org">public demo server</a> for small-scale routing things, or you can <a href="https://github.com/Project-OSRM/osrm-backend#using-docker">install your own local instance through Docker</a>. And super conveniently, there’s also an R package called <a href="https://github.com/riatelab/osrm">{osrm}</a> for accessing the OSRM API. This means that it’s possible to pull geocoded routing and directions data into R in an open source (and free!) way.</p>
<p>So let’s see how to use {osrm} and make some neat road trip maps with {sf} and {ggplot2}!</p>
<section id="getting-started" class="level1"><h1>Getting started</h1>
<section id="who-this-post-is-for" class="level2"><h2 class="anchored" data-anchor-id="who-this-post-is-for">Who this post is for</h2>
<p>Here’s what I assume you know:</p>
<ul>
<li>You’re familiar with <a href="https://www.r-project.org/">R</a> and the <a href="https://www.tidyverse.org/">tidyverse</a> (particularly <a href="https://dplyr.tidyverse.org/">{dplyr}</a> and <a href="https://ggplot2.tidyverse.org/">{ggplot2}</a>).</li>
<li>You’re somewhat familiar with <a href="https://r-spatial.github.io/sf/">{sf}</a> for working with geographic data. I have a <a href="https://datavizs23.classes.andrewheiss.com/example/12-example.html">whole tutorial here</a> and a <a href="https://www.andrewheiss.com/blog/2023/04/26/middle-earth-mapping-sf-r-gis/#lightning-quick-overview-of-sf-and-shapefiles">simplified one here</a> and the <a href="https://r-spatial.github.io/sf/">{sf} documentation has a ton of helpful vignettes and blog posts</a>, and there are also two free books about it: <a href="https://r-spatial.org/book/"><em>Spatial Data Science</em></a> and <a href="https://r.geocompx.org/"><em>Geocomputation with R</em></a>. Also <a href="https://www.jessesadler.com/post/simple-feature-objects/">check this fantastic post out</a> to learn more about the anatomy of a <code>geometry</code> column with {sf}.</li>
</ul></section><section id="packages-and-functions" class="level2"><h2 class="anchored" data-anchor-id="packages-and-functions">Packages and functions</h2>
<p>Before officially getting started, let’s load all the packages we need and create some helpful functions and variables:</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>     <span class="co"># ggplot, dplyr, and friends</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span>            <span class="co"># Handle spatial data in R in a tidy way</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/walkerke/tigris">tigris</a></span><span class="op">)</span>        <span class="co"># Access geographic data from the US Census</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://jessecambon.github.io/tidygeocoder/">tidygeocoder</a></span><span class="op">)</span>  <span class="co"># Automated geocoding</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/riatelab/osrm">osrm</a></span><span class="op">)</span>          <span class="co"># Access OSRM through R</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggrepel.slowkow.com/">ggrepel</a></span><span class="op">)</span>       <span class="co"># Nicer non-overlapping labels</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://glue.tidyverse.org/">glue</a></span><span class="op">)</span>          <span class="co"># Easier string interpolation</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://scales.r-lib.org">scales</a></span><span class="op">)</span>        <span class="co"># Nicer labeling functions</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com">patchwork</a></span><span class="op">)</span>     <span class="co"># Combine plots nicely</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://paleolimbot.github.io/ggspatial/">ggspatial</a></span><span class="op">)</span>     <span class="co"># Nicer map features like scale bars</span></span>
<span></span>
<span><span class="co"># Custom ggplot theme to make pretty plots</span></span>
<span><span class="co"># Get the font at https://fonts.google.com/specimen/Overpass</span></span>
<span><span class="va">theme_roadtrip</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span>base_family <span class="op">=</span> <span class="st">"Overpass Light"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">theme</span><span class="op">(</span></span>
<span>      plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Overpass"</span>, face <span class="op">=</span> <span class="st">"bold"</span>, hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>      strip.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span></span>
<span>        family <span class="op">=</span> <span class="st">"Overpass ExtraBold"</span>, face <span class="op">=</span> <span class="st">"plain"</span>,</span>
<span>        size <span class="op">=</span> <span class="fu">rel</span><span class="op">(</span><span class="fl">1.1</span><span class="op">)</span>, hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Make labels use Overpass by default</span></span>
<span><span class="fu">update_geom_defaults</span><span class="op">(</span><span class="st">"label_repel"</span>, </span>
<span>                     <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Overpass"</span>,</span>
<span>                          fontface <span class="op">=</span> <span class="st">"plain"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">update_geom_defaults</span><span class="op">(</span><span class="st">"label"</span>, </span>
<span>                     <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Overpass"</span>,</span>
<span>                          fontface <span class="op">=</span> <span class="st">"plain"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">update_geom_defaults</span><span class="op">(</span><span class="st">"text_repel"</span>, </span>
<span>                     <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Overpass"</span>,</span>
<span>                          fontface <span class="op">=</span> <span class="st">"plain"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">update_geom_defaults</span><span class="op">(</span><span class="st">"text"</span>, </span>
<span>                     <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Overpass"</span>,</span>
<span>                          fontface <span class="op">=</span> <span class="st">"plain"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Yellowstone colors</span></span>
<span><span class="va">clrs</span> <span class="op">&lt;-</span> <span class="fu">NatParksPalettes</span><span class="fu">::</span><span class="fu">natparks.pals</span><span class="op">(</span><span class="st">"Yellowstone"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#' Format duration in minutes and hours</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' This function takes a numeric input \code{x} representing a duration in minutes,</span></span>
<span><span class="co">#' rounds it to the nearest 15 minutes, and formats the result as a string</span></span>
<span><span class="co">#' indicating the number of hours and minutes in the duration.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param x A numeric input representing a duration in minutes.</span></span>
<span><span class="co">#' @return A character vector of formatted duration strings.</span></span>
<span><span class="co">#' @examples</span></span>
<span><span class="co">#' fmt_duration(c(93, 1007, 3056))</span></span>
<span><span class="va">fmt_duration</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Round to the nearest 15 minutes</span></span>
<span>  <span class="va">n_seconds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu">seconds</span><span class="op">(</span><span class="va">x</span> <span class="op">*</span> <span class="fl">60</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">15</span> <span class="op">*</span> <span class="fl">60</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="fl">15</span> <span class="op">*</span> <span class="fl">60</span><span class="op">)</span></span>
<span>  <span class="va">n_seconds</span> <span class="op">&lt;-</span> <span class="fu">seconds_to_period</span><span class="op">(</span><span class="va">n_seconds</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">map_chr</span><span class="op">(</span><span class="va">n_seconds</span>, \<span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu">seconds</span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="fl">59</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># If this is less than an hour, don't format anything with hours</span></span>
<span>      <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"{MM} minutes"</span>, MM <span class="op">=</span> <span class="fu">minute</span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="co"># I only want to format this as a number of hours. If the duration is</span></span>
<span>      <span class="co"># longer than 24 hours, seconds_to_period() rolls over into days (i.e.</span></span>
<span>      <span class="co"># seconds_to_period(60 * 60 * 24) returns "1d 0H 0M 0S"), and it shows</span></span>
<span>      <span class="co"># zero hours. So we extract the day part of the period, multiply it by 24,</span></span>
<span>      <span class="co"># and add it to the hour component that we want to display</span></span>
<span>      <span class="va">extra_day_hours</span> <span class="op">&lt;-</span> <span class="fu">day</span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">*</span> <span class="fl">24</span></span>
<span>  </span>
<span>      <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"{HH} hour{s} {MM} minutes"</span>,</span>
<span>        HH <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu">label_comma</span><span class="op">(</span><span class="op">)</span><span class="op">(</span><span class="fu">hour</span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">+</span> <span class="va">extra_day_hours</span><span class="op">)</span>,</span>
<span>        MM <span class="op">=</span> <span class="fu">minute</span><span class="op">(</span><span class="va">n</span><span class="op">)</span>,</span>
<span>        s <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu">hour</span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span>, <span class="st">""</span>, <span class="st">"s"</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">fmt_miles</span> <span class="op">&lt;-</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu">label_number</span><span class="op">(</span>accuracy <span class="op">=</span> <span class="fl">10</span>, suffix <span class="op">=</span> <span class="st">" miles"</span>, big.mark <span class="op">=</span> <span class="st">","</span><span class="op">)</span></span>
<span></span>
<span><span class="va">miles_to_meters</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">*</span> <span class="fl">1609.344</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">meters_to_miles</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">/</span> <span class="fl">1609.344</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">km_to_miles</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">meters_to_miles</span><span class="op">(</span><span class="va">x</span> <span class="op">*</span> <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section></section><section id="state-data" class="level1 page-columns page-full"><h1>State data</h1>
<p>First we need state boundaries. We can get these from the US Census with <code>states()</code> from {tigris}:</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">us_states</span> <span class="op">&lt;-</span> <span class="fu">states</span><span class="op">(</span>resolution <span class="op">=</span> <span class="st">"20m"</span>, year <span class="op">=</span> <span class="fl">2022</span>, cb <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lower_48</span> <span class="op">&lt;-</span> <span class="va">us_states</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="va">NAME</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Alaska"</span>, <span class="st">"Hawaii"</span>, <span class="st">"Puerto Rico"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Here’s what they look like (using the <a href="https://epsg.io/102003">Albers projection for the contiguous USA</a>):</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">lower_48</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span>crs <span class="op">=</span> <span class="fu">st_crs</span><span class="op">(</span><span class="st">"ESRI:102003"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>  <span class="co"># Albers</span></span>
<span>  <span class="fu">theme_roadtrip</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p><img src="index_files/figure-html/plot-states-only-1.png" class="img-fluid figure-img" style="width:100.0%" alt="48 contiguous states"></p>
<figcaption class="margin-caption">48 contiguous states</figcaption></figure>
</div>
</div>
</div>
<p>Super quick and easy.</p>
</section><section id="stops-data" class="level1 page-columns page-full"><h1>Stops data</h1>
<p>Next we need to geocode and plot all the stops we’ll be making on the trip. I’ll stick them all in a data frame with columns indicating the direction (with a nod to Bilbo Baggins’s <a href="https://en.wikipedia.org/wiki/There_and_Back_Again_(disambiguation)">“There and Back Again”</a> journey with the dwarves in <em>The Hobbit</em>) and the day of the leg of the trip:</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">stops_raw</span> <span class="op">&lt;-</span> <span class="fu">tribble</span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">direction</span>,   <span class="op">~</span><span class="va">day</span>, <span class="op">~</span><span class="va">city</span>,</span>
<span>  <span class="st">"There"</span>,      <span class="fl">1</span>,    <span class="st">"Atlanta, Georgia"</span>, </span>
<span>  <span class="st">"There"</span>,      <span class="fl">2</span>,    <span class="st">"New Orleans, Louisiana"</span>, </span>
<span>  <span class="st">"There"</span>,      <span class="fl">3</span>,    <span class="st">"San Antonio, Texas"</span>, </span>
<span>  <span class="st">"There"</span>,      <span class="fl">4</span>,    <span class="st">"Carlsbad, New Mexico"</span>, </span>
<span>  <span class="st">"There"</span>,      <span class="fl">5</span>,    <span class="st">"Grand Canyon NP, Arizona"</span>,</span>
<span>  <span class="st">"There"</span>,      <span class="fl">6</span>,    <span class="st">"Grover, Utah"</span>,  </span>
<span>  <span class="st">"Back again"</span>, <span class="fl">1</span>,    <span class="st">"Spanish Fork, Utah"</span>, </span>
<span>  <span class="st">"Back again"</span>, <span class="fl">1</span>,    <span class="st">"Shelley, Idaho"</span>,  </span>
<span>  <span class="st">"Back again"</span>, <span class="fl">2</span>,    <span class="st">"Yellowstone NP, Wyoming"</span>,</span>
<span>  <span class="st">"Back again"</span>, <span class="fl">2</span>,    <span class="st">"Devil's Tower, Wyoming"</span>,  </span>
<span>  <span class="st">"Back again"</span>, <span class="fl">3</span>,    <span class="st">"Mount Rushmore, South Dakota"</span>, </span>
<span>  <span class="st">"Back again"</span>, <span class="fl">4</span>,    <span class="st">"Albert Lea, Minnesota"</span>, </span>
<span>  <span class="st">"Back again"</span>, <span class="fl">5</span>,    <span class="st">"Nauvoo, Illinois"</span>, </span>
<span>  <span class="st">"Back again"</span>, <span class="fl">6</span>,    <span class="st">"Atlanta, Georgia"</span></span>
<span><span class="op">)</span>  <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>direction <span class="op">=</span> <span class="fu">fct_inorder</span><span class="op">(</span><span class="va">direction</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">stops_raw</span></span>
<span><span class="co">## # A tibble: 14 × 3</span></span>
<span><span class="co">##    direction    day city                        </span></span>
<span><span class="co">##    &lt;fct&gt;      &lt;dbl&gt; &lt;chr&gt;                       </span></span>
<span><span class="co">##  1 There          1 Atlanta, Georgia            </span></span>
<span><span class="co">##  2 There          2 New Orleans, Louisiana      </span></span>
<span><span class="co">##  3 There          3 San Antonio, Texas          </span></span>
<span><span class="co">##  4 There          4 Carlsbad, New Mexico        </span></span>
<span><span class="co">##  5 There          5 Grand Canyon NP, Arizona    </span></span>
<span><span class="co">##  6 There          6 Grover, Utah                </span></span>
<span><span class="co">##  7 Back again     1 Spanish Fork, Utah          </span></span>
<span><span class="co">##  8 Back again     1 Shelley, Idaho              </span></span>
<span><span class="co">##  9 Back again     2 Yellowstone NP, Wyoming     </span></span>
<span><span class="co">## 10 Back again     2 Devil's Tower, Wyoming      </span></span>
<span><span class="co">## 11 Back again     3 Mount Rushmore, South Dakota</span></span>
<span><span class="co">## 12 Back again     4 Albert Lea, Minnesota       </span></span>
<span><span class="co">## 13 Back again     5 Nauvoo, Illinois            </span></span>
<span><span class="co">## 14 Back again     6 Atlanta, Georgia</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>I could go to Google Maps and right click on each of these places and copy the latitude/longitude coordinates, but that’s not very reproducible and involves a lot of clicking around. We can do it programmatically with <code>geocode()</code> from {tidygeocoder}, but first we need to help the API a little. With most of these places, OpenStreetMap will return the center of the city (like with Atlanta), and that’s fine. With larger places like the Grand Canyon and Yellowstone, though, OpenStreetMap will give coordinates for the middle of the parks, which are literally in the middle of nowhere and will mess up our directions (since it’s not really possible to drive to the middle of the whole Grand Canyon). To fix this we’ll make a little dataset of some more specific addresses and join it to the list of stops. We’ll geocode the more specific address column:</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">stops_addresses</span> <span class="op">&lt;-</span> <span class="fu">tribble</span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">city</span>, <span class="op">~</span><span class="va">address</span>,</span>
<span>  <span class="st">"Grand Canyon NP, Arizona"</span>, <span class="st">"Grand Canyon Visitor Center, Arizona"</span>,</span>
<span>  <span class="st">"Yellowstone NP, Wyoming"</span>, <span class="st">"Old Faithful, Teton County, Wyoming"</span>,</span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">stops_to_geocode</span> <span class="op">&lt;-</span> <span class="va">stops_raw</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">stops_addresses</span>, by <span class="op">=</span> <span class="fu">join_by</span><span class="op">(</span><span class="va">city</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Combine the address and city columns, with a preference for address</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>address <span class="op">=</span> <span class="fu">coalesce</span><span class="op">(</span><span class="va">address</span>, <span class="va">city</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">stops_to_geocode</span></span>
<span><span class="co">## # A tibble: 14 × 4</span></span>
<span><span class="co">##    direction    day city                         address                             </span></span>
<span><span class="co">##    &lt;fct&gt;      &lt;dbl&gt; &lt;chr&gt;                        &lt;chr&gt;                               </span></span>
<span><span class="co">##  1 There          1 Atlanta, Georgia             Atlanta, Georgia                    </span></span>
<span><span class="co">##  2 There          2 New Orleans, Louisiana       New Orleans, Louisiana              </span></span>
<span><span class="co">##  3 There          3 San Antonio, Texas           San Antonio, Texas                  </span></span>
<span><span class="co">##  4 There          4 Carlsbad, New Mexico         Carlsbad, New Mexico                </span></span>
<span><span class="co">##  5 There          5 Grand Canyon NP, Arizona     Grand Canyon Visitor Center, Arizona</span></span>
<span><span class="co">##  6 There          6 Grover, Utah                 Grover, Utah                        </span></span>
<span><span class="co">##  7 Back again     1 Spanish Fork, Utah           Spanish Fork, Utah                  </span></span>
<span><span class="co">##  8 Back again     1 Shelley, Idaho               Shelley, Idaho                      </span></span>
<span><span class="co">##  9 Back again     2 Yellowstone NP, Wyoming      Old Faithful, Teton County, Wyoming </span></span>
<span><span class="co">## 10 Back again     2 Devil's Tower, Wyoming       Devil's Tower, Wyoming              </span></span>
<span><span class="co">## 11 Back again     3 Mount Rushmore, South Dakota Mount Rushmore, South Dakota        </span></span>
<span><span class="co">## 12 Back again     4 Albert Lea, Minnesota        Albert Lea, Minnesota               </span></span>
<span><span class="co">## 13 Back again     5 Nauvoo, Illinois             Nauvoo, Illinois                    </span></span>
<span><span class="co">## 14 Back again     6 Atlanta, Georgia             Atlanta, Georgia</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>To get the coordinates, we’ll feed the address column to <code>geocode()</code> and then convert the resulting numeric <code>long</code> and <code>lat</code> into an official sf geometry column (with the <a href="https://en.wikipedia.org/wiki/World_Geodetic_System">WGS 84 (−180 to 180) scale</a>):</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">stops_geocoded</span> <span class="op">&lt;-</span> <span class="va">stops_to_geocode</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">geocode</span><span class="op">(</span><span class="va">address</span>, method <span class="op">=</span> <span class="st">"osm"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">st_as_sf</span><span class="op">(</span>coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"long"</span>, <span class="st">"lat"</span><span class="op">)</span>, crs <span class="op">=</span> <span class="fu">st_crs</span><span class="op">(</span><span class="st">"EPSG:4326"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">stops_geocoded</span></span>
<span><span class="co">## Simple feature collection with 14 features and 4 fields</span></span>
<span><span class="co">## Geometry type: POINT</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: -112 ymin: 29.4 xmax: -84.4 ymax: 44.6</span></span>
<span><span class="co">## Geodetic CRS:  WGS 84</span></span>
<span><span class="co">## # A tibble: 14 × 5</span></span>
<span><span class="co">##    direction    day city                         address                                  geometry</span></span>
<span><span class="co">##  * &lt;fct&gt;      &lt;dbl&gt; &lt;chr&gt;                        &lt;chr&gt;                                 &lt;POINT [°]&gt;</span></span>
<span><span class="co">##  1 There          1 Atlanta, Georgia             Atlanta, Georgia                     (-84.4 33.7)</span></span>
<span><span class="co">##  2 There          2 New Orleans, Louisiana       New Orleans, Louisiana                 (-90.1 30)</span></span>
<span><span class="co">##  3 There          3 San Antonio, Texas           San Antonio, Texas                   (-98.5 29.4)</span></span>
<span><span class="co">##  4 There          4 Carlsbad, New Mexico         Carlsbad, New Mexico                  (-104 32.4)</span></span>
<span><span class="co">##  5 There          5 Grand Canyon NP, Arizona     Grand Canyon Visitor Center, Arizona  (-112 36.1)</span></span>
<span><span class="co">##  6 There          6 Grover, Utah                 Grover, Utah                          (-111 38.2)</span></span>
<span><span class="co">##  7 Back again     1 Spanish Fork, Utah           Spanish Fork, Utah                    (-112 40.1)</span></span>
<span><span class="co">##  8 Back again     1 Shelley, Idaho               Shelley, Idaho                        (-112 43.4)</span></span>
<span><span class="co">##  9 Back again     2 Yellowstone NP, Wyoming      Old Faithful, Teton County, Wyoming   (-111 44.5)</span></span>
<span><span class="co">## 10 Back again     2 Devil's Tower, Wyoming       Devil's Tower, Wyoming                (-105 44.6)</span></span>
<span><span class="co">## 11 Back again     3 Mount Rushmore, South Dakota Mount Rushmore, South Dakota          (-103 43.9)</span></span>
<span><span class="co">## 12 Back again     4 Albert Lea, Minnesota        Albert Lea, Minnesota                (-93.4 43.6)</span></span>
<span><span class="co">## 13 Back again     5 Nauvoo, Illinois             Nauvoo, Illinois                     (-91.4 40.6)</span></span>
<span><span class="co">## 14 Back again     6 Atlanta, Georgia             Atlanta, Georgia                     (-84.4 33.7)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Atlanta is in there twice, so we’ll need to drop the last row so that we don’t plot the points and labels for it twice:</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">all_stops_unique</span> <span class="op">&lt;-</span> <span class="va">stops_geocoded</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">slice</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>And let’s plot it all:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">lower_48</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">all_stops_unique</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_label_repel</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">all_stops_unique</span>,</span>
<span>    <span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">city</span>, geometry <span class="op">=</span> <span class="va">geometry</span><span class="op">)</span>,</span>
<span>    stat <span class="op">=</span> <span class="st">"sf_coordinates"</span>, seed <span class="op">=</span> <span class="fl">1234</span>,</span>
<span>    size <span class="op">=</span> <span class="fl">3</span>, segment.color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, min.segment.length <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">annotation_scale</span><span class="op">(</span></span>
<span>    location <span class="op">=</span> <span class="st">"bl"</span>, bar_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"grey30"</span>, <span class="st">"white"</span><span class="op">)</span>,</span>
<span>    unit_category <span class="op">=</span> <span class="st">"imperial"</span>, text_family <span class="op">=</span> <span class="st">"Overpass"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span>crs <span class="op">=</span> <span class="fu">st_crs</span><span class="op">(</span><span class="st">"ESRI:102003"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>  <span class="co"># Albers</span></span>
<span>  <span class="fu">theme_roadtrip</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p><img src="index_files/figure-html/plot-stops-only-1.png" class="img-fluid figure-img" style="width:100.0%" alt="All the main stops for our road trip"></p>
<figcaption class="margin-caption">All the main stops for our road trip</figcaption></figure>
</div>
</div>
</div>
</section><section id="routing" class="level1 page-columns page-full"><h1>Routing</h1>
<p>Next we need to figure out the routes between each of these points. The <code>osrmRoute()</code> function in {osrm} takes two main arguments: (1) coordinates for the source location (<code>src</code>) and (2) coordinates for the destination location (<code>dst</code>). To make it easy to work with routing data in a dataframe, we need to manipulate the data a bit so that we get a row per route, with columns for the origin and destination cities.</p>
<p>We’ll create a copy of the geometry column in <code>stops_geocoded</code> and shift it forward one row with <code>lead()</code> and drop the last row because it doesn’t have a destination:</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">routes_raw</span> <span class="op">&lt;-</span> <span class="va">stops_geocoded</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">address</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">rename</span><span class="op">(</span></span>
<span>    origin_geometry <span class="op">=</span> <span class="va">geometry</span>,</span>
<span>    origin_city <span class="op">=</span> <span class="va">city</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    destination_geometry <span class="op">=</span> <span class="fu">lead</span><span class="op">(</span><span class="va">origin_geometry</span><span class="op">)</span>,</span>
<span>    destination_city <span class="op">=</span> <span class="fu">lead</span><span class="op">(</span><span class="va">origin_city</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu">row_number</span><span class="op">(</span><span class="op">)</span> <span class="op">!=</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">routes_raw</span></span>
<span><span class="co">## Simple feature collection with 13 features and 4 fields</span></span>
<span><span class="co">## Active geometry column: origin_geometry</span></span>
<span><span class="co">## Geometry type: POINT</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: -112 ymin: 29.4 xmax: -84.4 ymax: 44.6</span></span>
<span><span class="co">## Geodetic CRS:  WGS 84</span></span>
<span><span class="co">## # A tibble: 13 × 6</span></span>
<span><span class="co">##    direction    day origin_city                  origin_geometry destination_geometry destination_city            </span></span>
<span><span class="co">##  * &lt;fct&gt;      &lt;dbl&gt; &lt;chr&gt;                            &lt;POINT [°]&gt;          &lt;POINT [°]&gt; &lt;chr&gt;                       </span></span>
<span><span class="co">##  1 There          1 Atlanta, Georgia                (-84.4 33.7)           (-90.1 30) New Orleans, Louisiana      </span></span>
<span><span class="co">##  2 There          2 New Orleans, Louisiana            (-90.1 30)         (-98.5 29.4) San Antonio, Texas          </span></span>
<span><span class="co">##  3 There          3 San Antonio, Texas              (-98.5 29.4)          (-104 32.4) Carlsbad, New Mexico        </span></span>
<span><span class="co">##  4 There          4 Carlsbad, New Mexico             (-104 32.4)          (-112 36.1) Grand Canyon NP, Arizona    </span></span>
<span><span class="co">##  5 There          5 Grand Canyon NP, Arizona         (-112 36.1)          (-111 38.2) Grover, Utah                </span></span>
<span><span class="co">##  6 There          6 Grover, Utah                     (-111 38.2)          (-112 40.1) Spanish Fork, Utah          </span></span>
<span><span class="co">##  7 Back again     1 Spanish Fork, Utah               (-112 40.1)          (-112 43.4) Shelley, Idaho              </span></span>
<span><span class="co">##  8 Back again     1 Shelley, Idaho                   (-112 43.4)          (-111 44.5) Yellowstone NP, Wyoming     </span></span>
<span><span class="co">##  9 Back again     2 Yellowstone NP, Wyoming          (-111 44.5)          (-105 44.6) Devil's Tower, Wyoming      </span></span>
<span><span class="co">## 10 Back again     2 Devil's Tower, Wyoming           (-105 44.6)          (-103 43.9) Mount Rushmore, South Dakota</span></span>
<span><span class="co">## 11 Back again     3 Mount Rushmore, South Dakota     (-103 43.9)         (-93.4 43.6) Albert Lea, Minnesota       </span></span>
<span><span class="co">## 12 Back again     4 Albert Lea, Minnesota           (-93.4 43.6)         (-91.4 40.6) Nauvoo, Illinois            </span></span>
<span><span class="co">## 13 Back again     5 Nauvoo, Illinois                (-91.4 40.6)         (-84.4 33.7) Atlanta, Georgia</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>With the data like this, we can now feed each row individually to <code>osrmRoute</code> and get geocoded paths between each origin and destination:</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">routes_geocoded_raw</span> <span class="op">&lt;-</span> <span class="va">routes_raw</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">rowwise</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>route <span class="op">=</span> <span class="fu">osrmRoute</span><span class="op">(</span></span>
<span>    src <span class="op">=</span> <span class="va">origin_geometry</span>, </span>
<span>    dst <span class="op">=</span> <span class="va">destination_geometry</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">routes_geocoded_raw</span></span>
<span><span class="co">## Simple feature collection with 13 features and 5 fields</span></span>
<span><span class="co">## Active geometry column: origin_geometry</span></span>
<span><span class="co">## Geometry type: POINT</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: -112 ymin: 29.4 xmax: -84.4 ymax: 44.6</span></span>
<span><span class="co">## Geodetic CRS:  WGS 84</span></span>
<span><span class="co">## # A tibble: 13 × 7</span></span>
<span><span class="co">## # Rowwise: </span></span>
<span><span class="co">##    direction    day origin_city                  origin_geometry destination_geometry destination_city             route$src $dst  $duration $distance                                                                                 $geometry</span></span>
<span><span class="co">##  * &lt;fct&gt;      &lt;dbl&gt; &lt;chr&gt;                            &lt;POINT [°]&gt;          &lt;POINT [°]&gt; &lt;chr&gt;                        &lt;chr&gt;     &lt;chr&gt;     &lt;dbl&gt;     &lt;dbl&gt;                                                                          &lt;LINESTRING [°]&gt;</span></span>
<span><span class="co">##  1 There          1 Atlanta, Georgia                (-84.4 33.7)           (-90.1 30) New Orleans, Louisiana       src       dst        513.      753. (-84.4 33.7, -84.5 33.6, -84.8 33.4, -84.9 33.1, -85.1 32.9, -85.4 32.6, -85.7 32.5, -...</span></span>
<span><span class="co">##  2 There          2 New Orleans, Louisiana            (-90.1 30)         (-98.5 29.4) San Antonio, Texas           src       dst        596.      870. (-90.1 30, -90.3 30, -90.5 30.1, -90.9 30.2, -91.1 30.4, -91.3 30.5, -92.1 30.2, -93.2...</span></span>
<span><span class="co">##  3 There          3 San Antonio, Texas              (-98.5 29.4)          (-104 32.4) Carlsbad, New Mexico         src       dst        458.      727. (-98.5 29.4, -98.7 29.7, -98.9 30, -99.5 30.3, -99.8 30.5, -99.9 30.5, -100 30.4, -101...</span></span>
<span><span class="co">##  4 There          4 Carlsbad, New Mexico             (-104 32.4)          (-112 36.1) Grand Canyon NP, Arizona     src       dst        749.     1100. (-104 32.4, -104 32.5, -104 32.6, -104 32.9, -104 32.9, -104 33.3, -105 33.4, -105 33....</span></span>
<span><span class="co">##  5 There          5 Grand Canyon NP, Arizona         (-112 36.1)          (-111 38.2) Grover, Utah                 src       dst        510.      628. (-112 36.1, -112 36, -112 36, -112 36, -112 36, -112 35.9, -112 35.9, -112 35.9, -111 ...</span></span>
<span><span class="co">##  6 There          6 Grover, Utah                     (-111 38.2)          (-112 40.1) Spanish Fork, Utah           src       dst        197.      273. (-111 38.2, -111 38.2, -111 38.3, -112 38.3, -112 38.4, -112 38.4, -112 38.4, -112 38....</span></span>
<span><span class="co">##  7 Back again     1 Spanish Fork, Utah               (-112 40.1)          (-112 43.4) Shelley, Idaho               src       dst        262.      411. (-112 40.1, -112 40.2, -112 40.3, -112 40.5, -112 41, -112 41.1, -112 41.2, -112 41.6,...</span></span>
<span><span class="co">##  8 Back again     1 Shelley, Idaho                   (-112 43.4)          (-111 44.5) Yellowstone NP, Wyoming      src       dst        199.      240. (-112 43.4, -112 43.8, -112 43.9, -112 43.9, -112 44, -112 44, -111 44.1, -111 44.2, -...</span></span>
<span><span class="co">##  9 Back again     2 Yellowstone NP, Wyoming          (-111 44.5)          (-105 44.6) Devil's Tower, Wyoming       src       dst        552.      694. (-111 44.5, -111 44.4, -111 44.5, -111 44.5, -110 44.5, -110 44.6, -110 44.5, -110 44....</span></span>
<span><span class="co">## 10 Back again     2 Devil's Tower, Wyoming           (-105 44.6)          (-103 43.9) Mount Rushmore, South Dakota src       dst        161.      215. (-105 44.6, -105 44.6, -105 44.6, -105 44.6, -105 44.5, -105 44.5, -105 44.5, -105 44....</span></span>
<span><span class="co">## 11 Back again     3 Mount Rushmore, South Dakota     (-103 43.9)         (-93.4 43.6) Albert Lea, Minnesota        src       dst        548.      866. (-103 43.9, -103 43.9, -103 44, -103 44, -103 44.1, -103 44.1, -103 44.1, -102 44.1, -...</span></span>
<span><span class="co">## 12 Back again     4 Albert Lea, Minnesota           (-93.4 43.6)         (-91.4 40.6) Nauvoo, Illinois             src       dst        359.      487. (-93.4 43.6, -93.3 43.1, -92.7 43.1, -92.7 43, -92.7 43, -92.6 43, -92.5 42.7, -92.5 4...</span></span>
<span><span class="co">## 13 Back again     5 Nauvoo, Illinois                (-91.4 40.6)         (-84.4 33.7) Atlanta, Georgia             src       dst        847.     1199. (-91.4 40.6, -91.4 40.4, -91.6 40.4, -91.5 39.7, -91.4 39.7, -91.4 39.6, -91 39.2, -90...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The route details are included in a <a href="https://tidyr.tidyverse.org/articles/nest.html">nested data frame list column</a> named <code>route</code>, so we’ll need to unnest it. The resulting data frame now has three different geometry columns (!) for the origin point, destination point, and the route, so we’ll set the route column as the data frame’s primary geometry column (which makes it so we can just use <code>geom_sf(data = routes_geocoded)</code> instead of <code>geom_sf(data = routes_geocoded, aes(geometry = whatever))</code>). The route data also includes some helpful details about the distance (in kilometers) and duration (in minutes), so we’ll create nicely formatted text-based versions of these too:</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">routes_geocoded</span> <span class="op">&lt;-</span> <span class="va">routes_geocoded_raw</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">unnest</span><span class="op">(</span><span class="va">route</span>, names_sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">st_set_geometry</span><span class="op">(</span><span class="st">"route_geometry"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    distance_miles <span class="op">=</span> <span class="fu">km_to_miles</span><span class="op">(</span><span class="va">route_distance</span><span class="op">)</span>,</span>
<span>    distance_text <span class="op">=</span> <span class="fu">fmt_miles</span><span class="op">(</span><span class="va">distance_miles</span><span class="op">)</span>,</span>
<span>    duration_text <span class="op">=</span> <span class="fu">fmt_duration</span><span class="op">(</span><span class="va">route_duration</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">routes_geocoded</span></span>
<span><span class="co">## Simple feature collection with 13 features and 11 fields</span></span>
<span><span class="co">## Active geometry column: route_geometry</span></span>
<span><span class="co">## Geometry type: LINESTRING</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: -113 ymin: 29.4 xmax: -84.4 ymax: 44.9</span></span>
<span><span class="co">## Geodetic CRS:  WGS 84</span></span>
<span><span class="co">## # A tibble: 13 × 14</span></span>
<span><span class="co">##    direction    day origin_city                  origin_geometry destination_geometry destination_city             route_src route_dst route_duration route_distance                                                                            route_geometry distance_miles distance_text duration_text   </span></span>
<span><span class="co">##  * &lt;fct&gt;      &lt;dbl&gt; &lt;chr&gt;                            &lt;POINT [°]&gt;          &lt;POINT [°]&gt; &lt;chr&gt;                        &lt;chr&gt;     &lt;chr&gt;              &lt;dbl&gt;          &lt;dbl&gt;                                                                          &lt;LINESTRING [°]&gt;          &lt;dbl&gt; &lt;chr&gt;         &lt;chr&gt;           </span></span>
<span><span class="co">##  1 There          1 Atlanta, Georgia                (-84.4 33.7)           (-90.1 30) New Orleans, Louisiana       src       dst                 513.           753. (-84.4 33.7, -84.5 33.6, -84.8 33.4, -84.9 33.1, -85.1 32.9, -85.4 32.6, -85.7 32.5, -...           468. 470 miles     8 hours 30 minu…</span></span>
<span><span class="co">##  2 There          2 New Orleans, Louisiana            (-90.1 30)         (-98.5 29.4) San Antonio, Texas           src       dst                 596.           870. (-90.1 30, -90.3 30, -90.5 30.1, -90.9 30.2, -91.1 30.4, -91.3 30.5, -92.1 30.2, -93.2...           541. 540 miles     10 hours 0 minu…</span></span>
<span><span class="co">##  3 There          3 San Antonio, Texas              (-98.5 29.4)          (-104 32.4) Carlsbad, New Mexico         src       dst                 458.           727. (-98.5 29.4, -98.7 29.7, -98.9 30, -99.5 30.3, -99.8 30.5, -99.9 30.5, -100 30.4, -101...           452. 450 miles     7 hours 45 minu…</span></span>
<span><span class="co">##  4 There          4 Carlsbad, New Mexico             (-104 32.4)          (-112 36.1) Grand Canyon NP, Arizona     src       dst                 749.          1100. (-104 32.4, -104 32.5, -104 32.6, -104 32.9, -104 32.9, -104 33.3, -105 33.4, -105 33....           684. 680 miles     12 hours 30 min…</span></span>
<span><span class="co">##  5 There          5 Grand Canyon NP, Arizona         (-112 36.1)          (-111 38.2) Grover, Utah                 src       dst                 510.           628. (-112 36.1, -112 36, -112 36, -112 36, -112 36, -112 35.9, -112 35.9, -112 35.9, -111 ...           390. 390 miles     8 hours 30 minu…</span></span>
<span><span class="co">##  6 There          6 Grover, Utah                     (-111 38.2)          (-112 40.1) Spanish Fork, Utah           src       dst                 197.           273. (-111 38.2, -111 38.2, -111 38.3, -112 38.3, -112 38.4, -112 38.4, -112 38.4, -112 38....           169. 170 miles     3 hours 15 minu…</span></span>
<span><span class="co">##  7 Back again     1 Spanish Fork, Utah               (-112 40.1)          (-112 43.4) Shelley, Idaho               src       dst                 262.           411. (-112 40.1, -112 40.2, -112 40.3, -112 40.5, -112 41, -112 41.1, -112 41.2, -112 41.6,...           256. 260 miles     4 hours 15 minu…</span></span>
<span><span class="co">##  8 Back again     1 Shelley, Idaho                   (-112 43.4)          (-111 44.5) Yellowstone NP, Wyoming      src       dst                 199.           240. (-112 43.4, -112 43.8, -112 43.9, -112 43.9, -112 44, -112 44, -111 44.1, -111 44.2, -...           149. 150 miles     3 hours 15 minu…</span></span>
<span><span class="co">##  9 Back again     2 Yellowstone NP, Wyoming          (-111 44.5)          (-105 44.6) Devil's Tower, Wyoming       src       dst                 552.           694. (-111 44.5, -111 44.4, -111 44.5, -111 44.5, -110 44.5, -110 44.6, -110 44.5, -110 44....           431. 430 miles     9 hours 15 minu…</span></span>
<span><span class="co">## 10 Back again     2 Devil's Tower, Wyoming           (-105 44.6)          (-103 43.9) Mount Rushmore, South Dakota src       dst                 161.           215. (-105 44.6, -105 44.6, -105 44.6, -105 44.6, -105 44.5, -105 44.5, -105 44.5, -105 44....           133. 130 miles     2 hours 45 minu…</span></span>
<span><span class="co">## 11 Back again     3 Mount Rushmore, South Dakota     (-103 43.9)         (-93.4 43.6) Albert Lea, Minnesota        src       dst                 548.           866. (-103 43.9, -103 43.9, -103 44, -103 44, -103 44.1, -103 44.1, -103 44.1, -102 44.1, -...           538. 540 miles     9 hours 15 minu…</span></span>
<span><span class="co">## 12 Back again     4 Albert Lea, Minnesota           (-93.4 43.6)         (-91.4 40.6) Nauvoo, Illinois             src       dst                 359.           487. (-93.4 43.6, -93.3 43.1, -92.7 43.1, -92.7 43, -92.7 43, -92.6 43, -92.5 42.7, -92.5 4...           303. 300 miles     6 hours 0 minut…</span></span>
<span><span class="co">## 13 Back again     5 Nauvoo, Illinois                (-91.4 40.6)         (-84.4 33.7) Atlanta, Georgia             src       dst                 847.          1199. (-91.4 40.6, -91.4 40.4, -91.6 40.4, -91.5 39.7, -91.4 39.7, -91.4 39.6, -91 39.2, -90...           745. 750 miles     14 hours 0 minu…</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s see how this looks! Because we set the default geometry of <code>routes_geocoded</code> to the route, <code>geom_sf(data = routes_geocoded)</code> will automatically plot the <code>LINESTRING</code> geometries for the routes as paths:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">lower_48</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">routes_geocoded</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">all_stops_unique</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_label_repel</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">all_stops_unique</span>,</span>
<span>    <span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">city</span>, geometry <span class="op">=</span> <span class="va">geometry</span><span class="op">)</span>,</span>
<span>    stat <span class="op">=</span> <span class="st">"sf_coordinates"</span>, seed <span class="op">=</span> <span class="fl">1234</span>,</span>
<span>    size <span class="op">=</span> <span class="fl">3</span>, segment.color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, min.segment.length <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">annotation_scale</span><span class="op">(</span></span>
<span>    location <span class="op">=</span> <span class="st">"bl"</span>, bar_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"grey30"</span>, <span class="st">"white"</span><span class="op">)</span>,</span>
<span>    unit_category <span class="op">=</span> <span class="st">"imperial"</span>, text_family <span class="op">=</span> <span class="st">"Overpass"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span>crs <span class="op">=</span> <span class="fu">st_crs</span><span class="op">(</span><span class="st">"ESRI:102003"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>  <span class="co"># Albers</span></span>
<span>  <span class="fu">theme_roadtrip</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p><img src="index_files/figure-html/plot-routes-stops-1.png" class="img-fluid figure-img" style="width:100.0%" alt="Automatically geocoded routes between all our road trip stops"></p>
<figcaption class="margin-caption">Automatically geocoded routes between all our road trip stops</figcaption></figure>
</div>
</div>
</div>
<p>AHH that’s so cool! It works!</p>
<p>We’re not done yet though—let’s make this even fancier!</p>
</section><section id="states-crossed-through" class="level1 page-columns page-full"><h1>States crossed through</h1>
<p>We’re going to be driving through a lot of states. Let’s highlight each of the states we’ll cross through to see how many there are. To do this we can use <code>st_intersection()</code> to find which of the <code>lower_48</code> states contain a part of the different routes. We’ll then make a copy of <code>lower_48</code> with a new column indicating if we’ll visit the state:</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">states_crossed_through</span> <span class="op">&lt;-</span> <span class="fu">st_intersection</span><span class="op">(</span></span>
<span>  <span class="fu">st_transform</span><span class="op">(</span><span class="va">lower_48</span>, <span class="fu">st_crs</span><span class="op">(</span><span class="va">routes_geocoded</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="va">routes_geocoded</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># There are 32 rows here, but 18 unique states (i.e. one day will end in a state</span></span>
<span><span class="co"># and start the next day in the same state, so it gets counted twice)</span></span>
<span><span class="va">states_crossed_through</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">STATEFP</span>, <span class="va">NAME</span>, <span class="va">direction</span>, <span class="va">day</span><span class="op">)</span></span>
<span><span class="co">## Simple feature collection with 32 features and 4 fields</span></span>
<span><span class="co">## Geometry type: GEOMETRY</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: -113 ymin: 29.4 xmax: -84.4 ymax: 44.9</span></span>
<span><span class="co">## Geodetic CRS:  WGS 84</span></span>
<span><span class="co">## First 10 features:</span></span>
<span><span class="co">##      STATEFP        NAME direction day                       geometry</span></span>
<span><span class="co">## 4         13     Georgia     There   1 LINESTRING (-84.4 33.7, -84...</span></span>
<span><span class="co">## 10        22   Louisiana     There   1 LINESTRING (-89.6 30.3, -89...</span></span>
<span><span class="co">## 32        28 Mississippi     There   1 LINESTRING (-88.4 30.5, -88...</span></span>
<span><span class="co">## 41        01     Alabama     There   1 LINESTRING (-85.2 32.9, -85...</span></span>
<span><span class="co">## 1         48       Texas     There   2 LINESTRING (-93.7 30.1, -93...</span></span>
<span><span class="co">## 10.1      22   Louisiana     There   2 LINESTRING (-90.1 30, -90.3...</span></span>
<span><span class="co">## 1.1       48       Texas     There   3 LINESTRING (-98.5 29.4, -98...</span></span>
<span><span class="co">## 36        35  New Mexico     There   3 LINESTRING (-104 32, -104 3...</span></span>
<span><span class="co">## 36.1      35  New Mexico     There   4 LINESTRING (-104 32.4, -104...</span></span>
<span><span class="co">## 47        04     Arizona     There   4 LINESTRING (-109 35.4, -109...</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">states_crossed_through</span><span class="op">$</span><span class="va">NAME</span><span class="op">)</span></span>
<span><span class="co">##  [1] "Georgia"      "Louisiana"    "Mississippi"  "Alabama"      "Texas"        "New Mexico"   "Arizona"      "Utah"         "Idaho"        "Montana"      "Wyoming"      "South Dakota" "Minnesota"    "Illinois"     "Iowa"         "Kentucky"     "Missouri"     "Tennessee"</span></span>
<span></span>
<span><span class="co"># Create a column that flags if the state is cross through</span></span>
<span><span class="va">lower_48_highlighted</span> <span class="op">&lt;-</span> <span class="va">lower_48</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>visited <span class="op">=</span> <span class="va">NAME</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">states_crossed_through</span><span class="op">$</span><span class="va">NAME</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now we can fill using the <code>visited</code> column and make the visited states subtly darker:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">lower_48_highlighted</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">visited</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">routes_geocoded</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">all_stops_unique</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_label_repel</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">all_stops_unique</span>,</span>
<span>    <span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">city</span>, geometry <span class="op">=</span> <span class="va">geometry</span><span class="op">)</span>,</span>
<span>    stat <span class="op">=</span> <span class="st">"sf_coordinates"</span>, seed <span class="op">=</span> <span class="fl">1234</span>,</span>
<span>    size <span class="op">=</span> <span class="fl">3</span>, segment.color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, min.segment.length <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">annotation_scale</span><span class="op">(</span></span>
<span>    location <span class="op">=</span> <span class="st">"bl"</span>, bar_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"grey30"</span>, <span class="st">"white"</span><span class="op">)</span>,</span>
<span>    unit_category <span class="op">=</span> <span class="st">"imperial"</span>, text_family <span class="op">=</span> <span class="st">"Overpass"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"grey90"</span>, <span class="st">"grey80"</span><span class="op">)</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span>crs <span class="op">=</span> <span class="fu">st_crs</span><span class="op">(</span><span class="st">"ESRI:102003"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>  <span class="co"># Albers</span></span>
<span>  <span class="fu">theme_roadtrip</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p><img src="index_files/figure-html/plot-routes-stops-highlighted-1.png" class="img-fluid figure-img" style="width:100.0%" alt="Map of road trip route with crossed-through states highlighted"></p>
<figcaption class="margin-caption">Map of road trip route with crossed-through states highlighted</figcaption></figure>
</div>
</div>
</div>
</section><section id="summary-statistics" class="level1 page-columns page-full"><h1>Summary statistics</h1>
<p>Now that we have a list of the states we’ll cross through, let’s play with some quick summary statistics.</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">n_states</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">states_crossed_through</span><span class="op">$</span><span class="va">NAME</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">n_states</span></span>
<span><span class="co">## [1] 18</span></span>
<span></span>
<span><span class="va">total_distance</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">routes_geocoded</span><span class="op">$</span><span class="va">route_distance</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">km_to_miles</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">fmt_miles</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">total_distance</span></span>
<span><span class="co">## [1] "5,260 miles"</span></span>
<span></span>
<span><span class="va">total_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">routes_geocoded</span><span class="op">$</span><span class="va">route_duration</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">fmt_duration</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">total_time</span></span>
<span><span class="co">## [1] "99 hours 15 minutes"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><strong>We’re going to drive through 18 states, with a total distance of 5,260 miles over the span of 99 hours 15 minutes (!!)</strong></p>
<p>We can use these distance or duration columns to add some extra detail to the map:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">lower_48_highlighted</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">visited</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">routes_geocoded</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">all_stops_unique</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_label_repel</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">routes_geocoded</span>,</span>
<span>    <span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">distance_text</span>, geometry <span class="op">=</span> <span class="va">route_geometry</span><span class="op">)</span>,</span>
<span>    stat <span class="op">=</span> <span class="st">"sf_coordinates"</span>, seed <span class="op">=</span> <span class="fl">12345</span>,</span>
<span>    size <span class="op">=</span> <span class="fl">3</span>, segment.color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, min.segment.length <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    fill <span class="op">=</span> <span class="fu">colorspace</span><span class="fu">::</span><span class="fu">lighten</span><span class="op">(</span><span class="va">clrs</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span>, <span class="fl">0.8</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">annotation_scale</span><span class="op">(</span></span>
<span>    location <span class="op">=</span> <span class="st">"bl"</span>, bar_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"grey30"</span>, <span class="st">"white"</span><span class="op">)</span>,</span>
<span>    unit_category <span class="op">=</span> <span class="st">"imperial"</span>, text_family <span class="op">=</span> <span class="st">"Overpass"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"grey90"</span>, <span class="st">"grey80"</span><span class="op">)</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span>crs <span class="op">=</span> <span class="fu">st_crs</span><span class="op">(</span><span class="st">"ESRI:102003"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>  <span class="co"># Albers</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"{n_states} states; {total_distance}; and {total_time} in the car. Bring it on."</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_roadtrip</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p><img src="index_files/figure-html/plot-routes-stops-distances-1.png" class="img-fluid figure-img" style="width:100.0%" alt="Map of road trip showing the distances between each stop"></p>
<figcaption class="margin-caption">Map of road trip showing the distances between each stop</figcaption></figure>
</div>
</div>
</div>
</section><section id="faceting" class="level1 page-columns page-full"><h1>Faceting</h1>
<p>We have some nice tidy data here with columns for direction and day, which makes it easy to subset the data. We can make separate maps for the drive there and the drive back, or even separate maps for each day of the trip. Let’s add <code>facet_wrap()</code> to the plot:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">lower_48_highlighted</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">visited</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">routes_geocoded</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">all_stops_unique</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">annotation_scale</span><span class="op">(</span></span>
<span>    location <span class="op">=</span> <span class="st">"bl"</span>, bar_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"grey30"</span>, <span class="st">"white"</span><span class="op">)</span>,</span>
<span>    unit_category <span class="op">=</span> <span class="st">"imperial"</span>, text_family <span class="op">=</span> <span class="st">"Overpass"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"grey90"</span>, <span class="st">"grey80"</span><span class="op">)</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span>crs <span class="op">=</span> <span class="fu">st_crs</span><span class="op">(</span><span class="st">"ESRI:102003"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>  <span class="co"># Albers</span></span>
<span>  <span class="fu">theme_roadtrip</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">direction</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p><img src="index_files/figure-html/plot-facet-subset-issues-1.png" class="img-fluid figure-img" style="width:100.0%" alt="Road trip map faceted by direction"></p>
<figcaption class="margin-caption">Road trip map faceted by direction</figcaption></figure>
</div>
</div>
</div>
<p>There are two problems with this though:</p>
<ol type="1">
<li>The highlighted states are the same in both facets</li>
<li>The final destination point is missing in each facet (Spanish Fork, Utah in the “There” facet; Atlanta, Georgia in the “Back Again” facet)</li>
</ol>
<p>Both of these issues are fixable though.</p>
<section id="fixing-state-highlighting" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="fixing-state-highlighting">Fixing state highlighting</h2>
<p>First we need to change how we identify the states we’ll cross through. Before, we kept the unique state names, but this stripped away the details about the direction of the trip, so we’ll find all the distinct combinations of direction and state and then join that little dataset to <code>lower_48</code> to make the <code>visited</code> column:</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">states_crossed_through_better</span> <span class="op">&lt;-</span> <span class="fu">st_intersection</span><span class="op">(</span></span>
<span>  <span class="fu">st_transform</span><span class="op">(</span><span class="va">lower_48</span>, <span class="fu">st_crs</span><span class="op">(</span><span class="va">routes_geocoded</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="va">routes_geocoded</span></span>
<span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">distinct</span><span class="op">(</span><span class="va">direction</span>, <span class="va">NAME</span><span class="op">)</span></span>
<span><span class="va">states_crossed_through_better</span></span>
<span><span class="co">##       direction         NAME</span></span>
<span><span class="co">## 4         There      Georgia</span></span>
<span><span class="co">## 10        There    Louisiana</span></span>
<span><span class="co">## 32        There  Mississippi</span></span>
<span><span class="co">## 41        There      Alabama</span></span>
<span><span class="co">## 1         There        Texas</span></span>
<span><span class="co">## 36        There   New Mexico</span></span>
<span><span class="co">## 47        There      Arizona</span></span>
<span><span class="co">## 35        There         Utah</span></span>
<span><span class="co">## 12   Back again        Idaho</span></span>
<span><span class="co">## 35.2 Back again         Utah</span></span>
<span><span class="co">## 15   Back again      Montana</span></span>
<span><span class="co">## 25   Back again      Wyoming</span></span>
<span><span class="co">## 23   Back again South Dakota</span></span>
<span><span class="co">## 16   Back again    Minnesota</span></span>
<span><span class="co">## 14   Back again     Illinois</span></span>
<span><span class="co">## 18   Back again         Iowa</span></span>
<span><span class="co">## 3    Back again     Kentucky</span></span>
<span><span class="co">## 4.1  Back again      Georgia</span></span>
<span><span class="co">## 7    Back again     Missouri</span></span>
<span><span class="co">## 9    Back again    Tennessee</span></span>
<span></span>
<span><span class="va">lower_48_highlighted_better</span> <span class="op">&lt;-</span> <span class="va">lower_48</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">states_crossed_through_better</span>, by <span class="op">=</span> <span class="fu">join_by</span><span class="op">(</span><span class="va">NAME</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>visited <span class="op">=</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">direction</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">as_tibble</span><span class="op">(</span><span class="va">lower_48_highlighted_better</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 51 × 12</span></span>
<span><span class="co">##    STATEFP STATENS  AFFGEOID    GEOID STUSPS NAME       LSAD         ALAND      AWATER direction                                                                                 geometry visited</span></span>
<span><span class="co">##    &lt;chr&gt;   &lt;chr&gt;    &lt;chr&gt;       &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt;      &lt;chr&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;                                                                           &lt;MULTIPOLYGON [°]&gt; &lt;lgl&gt;  </span></span>
<span><span class="co">##  1 48      01779801 0400000US48 48    TX     Texas      00    676685555821 18974391187 There      (((-107 31.9, -107 32, -107 32, -107 32, -106 32, -106 32, -106 32, -106 32, -105 32... TRUE   </span></span>
<span><span class="co">##  2 06      01779778 0400000US06 06    CA     California 00    403673617862 20291712025 &lt;NA&gt;       (((-119 33.5, -118 33.5, -118 33.4, -118 33.4, -118 33.3, -118 33.3, -118 33.3, -118... FALSE  </span></span>
<span><span class="co">##  3 21      01779786 0400000US21 21    KY     Kentucky   00    102266581101  2384240769 Back again (((-89.5 36.6, -89.5 36.6, -89.4 36.6, -89.4 36.6, -89.3 36.6, -89.3 36.6, -89.3 36.... TRUE   </span></span>
<span><span class="co">##  4 13      01705317 0400000US13 13    GA     Georgia    00    149486268417  4418716153 There      (((-85.6 35, -85.5 35, -85.4 35, -85.4 35, -85.3 35, -85.3 35, -85 35, -85 35, -85 3... TRUE   </span></span>
<span><span class="co">##  5 13      01705317 0400000US13 13    GA     Georgia    00    149486268417  4418716153 Back again (((-85.6 35, -85.5 35, -85.4 35, -85.4 35, -85.3 35, -85.3 35, -85 35, -85 35, -85 3... TRUE   </span></span>
<span><span class="co">##  6 55      01779806 0400000US55 55    WI     Wisconsin  00    140292518676 29343193162 &lt;NA&gt;       (((-86.9 45.4, -86.8 45.5, -86.8 45.4, -86.9 45.4, -86.9 45.3, -87 45.4, -86.9 45.4)... FALSE  </span></span>
<span><span class="co">##  7 41      01155107 0400000US41 41    OR     Oregon     00    248630319014  6169061220 &lt;NA&gt;       (((-125 42.8, -124 43, -124 43, -124 43.1, -124 43.2, -124 43.2, -124 43.3, -124 43.... FALSE  </span></span>
<span><span class="co">##  8 29      01779791 0400000US29 29    MO     Missouri   00    178052253239  2487526202 Back again (((-95.8 40.6, -95.5 40.6, -95.4 40.6, -95.3 40.6, -95.2 40.6, -95.1 40.6, -94.9 40.... TRUE   </span></span>
<span><span class="co">##  9 51      01779803 0400000US51 51    VA     Virginia   00    102258178227  8528072639 &lt;NA&gt;       (((-76 37.3, -76 37.4, -76 37.4, -75.9 37.5, -75.9 37.6, -75.9 37.6, -75.9 37.7, -75... FALSE  </span></span>
<span><span class="co">## 10 47      01325873 0400000US47 47    TN     Tennessee  00    106792368794  2322190840 Back again (((-90.3 35, -90.3 35, -90.2 35.1, -90.2 35.1, -90.2 35.1, -90.1 35.1, -90.1 35.2, -... TRUE   </span></span>
<span><span class="co">## # ℹ 41 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s see how it works by adding a new <code>geom_sf()</code> layer for the highlighted states. We need to double up here with both <code>lower_48</code> and <code>lower_48_highlighted_better</code> because if we only plot the highlighted states, each facet will only contain those states and not the underlying US map, which we don’t want.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">lower_48</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html">na.omit</a></span><span class="op">(</span><span class="va">lower_48_highlighted_better</span><span class="op">)</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">visited</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">routes_geocoded</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">all_stops_unique</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">annotation_scale</span><span class="op">(</span></span>
<span>    location <span class="op">=</span> <span class="st">"bl"</span>, bar_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"grey30"</span>, <span class="st">"white"</span><span class="op">)</span>,</span>
<span>    unit_category <span class="op">=</span> <span class="st">"imperial"</span>, text_family <span class="op">=</span> <span class="st">"Overpass"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"grey80"</span><span class="op">)</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span>crs <span class="op">=</span> <span class="fu">st_crs</span><span class="op">(</span><span class="st">"ESRI:102003"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>  <span class="co"># Albers</span></span>
<span>  <span class="fu">theme_roadtrip</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">direction</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p><img src="index_files/figure-html/plot-facet-subset-issues-fixed1-1.png" class="img-fluid figure-img" style="width:100.0%" alt="Each facet now only shows the states corresponding to each direction"></p>
<figcaption class="margin-caption">Each facet now only shows the states corresponding to each direction</figcaption></figure>
</div>
</div>
</div>
<p>There, we fixed issue #1. ✅</p>
<p>Issue #2—the missing endpoint in each facet—is a little trickier to deal with, but still doable. Before messing with the real data, let’s look at a simpler toy example first. Here’s a little dataset with three different “routes” between cities. The coordinates here aren’t actually coordinates—they’re just some arbitrary numbers. But that’s okay—this basically mirrors what we have in <code>routes_geocoded</code></p>
</section><section id="fixing-missing-destination-cities" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="fixing-missing-destination-cities">Fixing missing destination cities</h2>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">example</span> <span class="op">&lt;-</span> <span class="fu">tribble</span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">day</span>, <span class="op">~</span><span class="va">origin_city</span>, <span class="op">~</span><span class="va">destination_city</span>, <span class="op">~</span><span class="va">origin_coords</span>, <span class="op">~</span><span class="va">destination_coords</span>,</span>
<span>  <span class="fl">1</span>,    <span class="st">"Atlanta"</span>,    <span class="st">"Boston"</span>,          <span class="fl">1234</span>,           <span class="fl">5678</span>,</span>
<span>  <span class="fl">2</span>,    <span class="st">"Boston"</span>,     <span class="st">"Chicago"</span>,         <span class="fl">5678</span>,           <span class="fl">91011</span>,</span>
<span>  <span class="fl">3</span>,    <span class="st">"Chicago"</span>,    <span class="st">"Denver"</span>,          <span class="fl">91011</span>,          <span class="fl">131415</span></span>
<span><span class="op">)</span> </span>
<span><span class="va">example</span></span>
<span><span class="co">## # A tibble: 3 × 5</span></span>
<span><span class="co">##     day origin_city destination_city origin_coords destination_coords</span></span>
<span><span class="co">##   &lt;dbl&gt; &lt;chr&gt;       &lt;chr&gt;                    &lt;dbl&gt;              &lt;dbl&gt;</span></span>
<span><span class="co">## 1     1 Atlanta     Boston                    1234               5678</span></span>
<span><span class="co">## 2     2 Boston      Chicago                   5678              91011</span></span>
<span><span class="co">## 3     3 Chicago     Denver                   91011             131415</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The reason we’re not getting the final point in each facet or subset is because there are only three rows here, but four cities. If we plotted the <code>origin_coords</code> column, Atlanta would be missing; if we plotted the <code>destination_coords</code> column, Denver would be missing. We need to manipulate this data so that it has 4 rows (Atlanta, Boston, Chicago, Denver), with the correct coordinates for each city.</p>
<p>There’s an easy way to do this with <code>pivot_longer()</code> from {tidyr}. We can pivot with multiple columns that follow a pattern in their names. Here, all four of the columns we care about are are prefixed <code>destination</code> or <code>origin</code>, followed by a <code>_</code>. If we specify these name settings in <code>pivot_longer()</code>, it’ll automatically create a column named <code>type</code> for destination and origin and it’ll put the rest of the data in corresponding columns:</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">example</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">pivot_longer</span><span class="op">(</span></span>
<span>    cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">origin_city</span>, <span class="va">destination_city</span>, <span class="va">origin_coords</span>, <span class="va">destination_coords</span><span class="op">)</span>,</span>
<span>    names_to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"type"</span>, <span class="st">".value"</span><span class="op">)</span>,</span>
<span>    names_sep <span class="op">=</span> <span class="st">"_"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">## # A tibble: 6 × 4</span></span>
<span><span class="co">##     day type        city    coords</span></span>
<span><span class="co">##   &lt;dbl&gt; &lt;chr&gt;       &lt;chr&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">## 1     1 origin      Atlanta   1234</span></span>
<span><span class="co">## 2     1 destination Boston    5678</span></span>
<span><span class="co">## 3     2 origin      Boston    5678</span></span>
<span><span class="co">## 4     2 destination Chicago  91011</span></span>
<span><span class="co">## 5     3 origin      Chicago  91011</span></span>
<span><span class="co">## 6     3 destination Denver  131415</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now we have one row per city, which is close to what we need. Boston and Chicago are duplicated (since they’re both destination and origin cities), so we need to filter out duplicate cities. There are lots of ways to do this—my preferred way is to group by city and keep the first row in each group using <code>slice()</code>:</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">example</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">pivot_longer</span><span class="op">(</span></span>
<span>    cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">origin_city</span>, <span class="va">destination_city</span>, <span class="va">origin_coords</span>, <span class="va">destination_coords</span><span class="op">)</span>,</span>
<span>    names_to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"type"</span>, <span class="st">".value"</span><span class="op">)</span>,</span>
<span>    names_sep <span class="op">=</span> <span class="st">"_"</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">city</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">slice</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 4 × 4</span></span>
<span><span class="co">## # Groups:   city [4]</span></span>
<span><span class="co">##     day type        city    coords</span></span>
<span><span class="co">##   &lt;dbl&gt; &lt;chr&gt;       &lt;chr&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">## 1     1 origin      Atlanta   1234</span></span>
<span><span class="co">## 2     1 destination Boston    5678</span></span>
<span><span class="co">## 3     2 destination Chicago  91011</span></span>
<span><span class="co">## 4     3 destination Denver  131415</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Woohoo! A dataset with four rows and the correct coordinates for each city. If we could plot this, we’d get both endpoints (Atlanta and Denver).</p>
<p>This same double pivot approach (magically!!) works with the special geometry columns in our actual routes data:</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">all_stops_endpoints</span> <span class="op">&lt;-</span> <span class="va">routes_geocoded</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">pivot_longer</span><span class="op">(</span></span>
<span>    cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">origin_city</span>, <span class="va">destination_city</span>, <span class="va">origin_geometry</span>, <span class="va">destination_geometry</span><span class="op">)</span>,</span>
<span>    names_to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"type"</span>, <span class="st">".value"</span><span class="op">)</span>,</span>
<span>    names_sep <span class="op">=</span> <span class="st">"_"</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">direction</span>, <span class="va">city</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">slice</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="va">direction</span>, <span class="va">day</span>, <span class="fu">desc</span><span class="op">(</span><span class="va">type</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Use "geometry" as the default geometry column instead of the routes</span></span>
<span>  <span class="fu">st_set_geometry</span><span class="op">(</span><span class="st">"geometry"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">all_stops_endpoints</span></span>
<span><span class="co">## Simple feature collection with 15 features and 11 fields</span></span>
<span><span class="co">## Active geometry column: geometry</span></span>
<span><span class="co">## Geometry type: POINT</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: -112 ymin: 29.4 xmax: -84.4 ymax: 44.6</span></span>
<span><span class="co">## Geodetic CRS:  WGS 84</span></span>
<span><span class="co">## # A tibble: 15 × 13</span></span>
<span><span class="co">## # Groups:   direction, city [15]</span></span>
<span><span class="co">##    direction    day route_src route_dst route_duration route_distance                                                                            route_geometry distance_miles distance_text duration_text       type        city                             geometry</span></span>
<span><span class="co">##    &lt;fct&gt;      &lt;dbl&gt; &lt;chr&gt;     &lt;chr&gt;              &lt;dbl&gt;          &lt;dbl&gt;                                                                          &lt;LINESTRING [°]&gt;          &lt;dbl&gt; &lt;chr&gt;         &lt;chr&gt;               &lt;chr&gt;       &lt;chr&gt;                         &lt;POINT [°]&gt;</span></span>
<span><span class="co">##  1 There          1 src       dst                 513.           753. (-84.4 33.7, -84.5 33.6, -84.8 33.4, -84.9 33.1, -85.1 32.9, -85.4 32.6, -85.7 32.5, -...           468. 470 miles     8 hours 30 minutes  origin      Atlanta, Georgia             (-84.4 33.7)</span></span>
<span><span class="co">##  2 There          1 src       dst                 513.           753. (-84.4 33.7, -84.5 33.6, -84.8 33.4, -84.9 33.1, -85.1 32.9, -85.4 32.6, -85.7 32.5, -...           468. 470 miles     8 hours 30 minutes  destination New Orleans, Louisiana         (-90.1 30)</span></span>
<span><span class="co">##  3 There          2 src       dst                 596.           870. (-90.1 30, -90.3 30, -90.5 30.1, -90.9 30.2, -91.1 30.4, -91.3 30.5, -92.1 30.2, -93.2...           541. 540 miles     10 hours 0 minutes  destination San Antonio, Texas           (-98.5 29.4)</span></span>
<span><span class="co">##  4 There          3 src       dst                 458.           727. (-98.5 29.4, -98.7 29.7, -98.9 30, -99.5 30.3, -99.8 30.5, -99.9 30.5, -100 30.4, -101...           452. 450 miles     7 hours 45 minutes  destination Carlsbad, New Mexico          (-104 32.4)</span></span>
<span><span class="co">##  5 There          4 src       dst                 749.          1100. (-104 32.4, -104 32.5, -104 32.6, -104 32.9, -104 32.9, -104 33.3, -105 33.4, -105 33....           684. 680 miles     12 hours 30 minutes destination Grand Canyon NP, Arizona      (-112 36.1)</span></span>
<span><span class="co">##  6 There          5 src       dst                 510.           628. (-112 36.1, -112 36, -112 36, -112 36, -112 36, -112 35.9, -112 35.9, -112 35.9, -111 ...           390. 390 miles     8 hours 30 minutes  destination Grover, Utah                  (-111 38.2)</span></span>
<span><span class="co">##  7 There          6 src       dst                 197.           273. (-111 38.2, -111 38.2, -111 38.3, -112 38.3, -112 38.4, -112 38.4, -112 38.4, -112 38....           169. 170 miles     3 hours 15 minutes  destination Spanish Fork, Utah            (-112 40.1)</span></span>
<span><span class="co">##  8 Back again     1 src       dst                 262.           411. (-112 40.1, -112 40.2, -112 40.3, -112 40.5, -112 41, -112 41.1, -112 41.2, -112 41.6,...           256. 260 miles     4 hours 15 minutes  origin      Spanish Fork, Utah            (-112 40.1)</span></span>
<span><span class="co">##  9 Back again     1 src       dst                 262.           411. (-112 40.1, -112 40.2, -112 40.3, -112 40.5, -112 41, -112 41.1, -112 41.2, -112 41.6,...           256. 260 miles     4 hours 15 minutes  destination Shelley, Idaho                (-112 43.4)</span></span>
<span><span class="co">## 10 Back again     1 src       dst                 199.           240. (-112 43.4, -112 43.8, -112 43.9, -112 43.9, -112 44, -112 44, -111 44.1, -111 44.2, -...           149. 150 miles     3 hours 15 minutes  destination Yellowstone NP, Wyoming       (-111 44.5)</span></span>
<span><span class="co">## 11 Back again     2 src       dst                 552.           694. (-111 44.5, -111 44.4, -111 44.5, -111 44.5, -110 44.5, -110 44.6, -110 44.5, -110 44....           431. 430 miles     9 hours 15 minutes  destination Devil's Tower, Wyoming        (-105 44.6)</span></span>
<span><span class="co">## 12 Back again     2 src       dst                 161.           215. (-105 44.6, -105 44.6, -105 44.6, -105 44.6, -105 44.5, -105 44.5, -105 44.5, -105 44....           133. 130 miles     2 hours 45 minutes  destination Mount Rushmore, South Dakota  (-103 43.9)</span></span>
<span><span class="co">## 13 Back again     3 src       dst                 548.           866. (-103 43.9, -103 43.9, -103 44, -103 44, -103 44.1, -103 44.1, -103 44.1, -102 44.1, -...           538. 540 miles     9 hours 15 minutes  destination Albert Lea, Minnesota        (-93.4 43.6)</span></span>
<span><span class="co">## 14 Back again     4 src       dst                 359.           487. (-93.4 43.6, -93.3 43.1, -92.7 43.1, -92.7 43, -92.7 43, -92.6 43, -92.5 42.7, -92.5 4...           303. 300 miles     6 hours 0 minutes   destination Nauvoo, Illinois             (-91.4 40.6)</span></span>
<span><span class="co">## 15 Back again     5 src       dst                 847.          1199. (-91.4 40.6, -91.4 40.4, -91.6 40.4, -91.5 39.7, -91.4 39.7, -91.4 39.6, -91 39.2, -90...           745. 750 miles     14 hours 0 minutes  destination Atlanta, Georgia             (-84.4 33.7)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>And plotted:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">lower_48</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html">na.omit</a></span><span class="op">(</span><span class="va">lower_48_highlighted_better</span><span class="op">)</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">visited</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">routes_geocoded</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">all_stops_endpoints</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_label_repel</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">all_stops_endpoints</span>,</span>
<span>    <span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">city</span>, geometry <span class="op">=</span> <span class="va">geometry</span><span class="op">)</span>,</span>
<span>    stat <span class="op">=</span> <span class="st">"sf_coordinates"</span>, seed <span class="op">=</span> <span class="fl">1234</span>,</span>
<span>    size <span class="op">=</span> <span class="fl">3</span>, segment.color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, min.segment.length <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">annotation_scale</span><span class="op">(</span></span>
<span>    location <span class="op">=</span> <span class="st">"bl"</span>, bar_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"grey30"</span>, <span class="st">"white"</span><span class="op">)</span>,</span>
<span>    unit_category <span class="op">=</span> <span class="st">"imperial"</span>, text_family <span class="op">=</span> <span class="st">"Overpass"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"grey80"</span><span class="op">)</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span>crs <span class="op">=</span> <span class="fu">st_crs</span><span class="op">(</span><span class="st">"ESRI:102003"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>  <span class="co"># Albers</span></span>
<span>  <span class="fu">theme_roadtrip</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">direction</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p><img src="index_files/figure-html/plot-facet-subset-issues-fixed2-1.png" class="img-fluid figure-img" style="width:100.0%" alt="Each facet now shows the destination city"></p>
<figcaption class="margin-caption">Each facet now shows the destination city</figcaption></figure>
</div>
</div>
</div>
<p>Issue #2 fixed. ✅</p>
</section></section><section id="zooming-in" class="level1 page-columns page-full"><h1>Zooming in</h1>
<p>We can also make separate maps that are zoomed in on each day of the trip in addition these bigger overarching ones. This will allow us to add more details like driving time and distances without getting too crowded on the map.</p>
<p>We’ll create a mini map of the first day by itself, and then scale up the process to make all the mini maps programmatically.</p>
<section id="one-day-of-the-trip" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="one-day-of-the-trip">One day of the trip</h2>
<p>First we’ll extract the route, cities, and states for the first day of the trip out there:</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">route_day1</span> <span class="op">&lt;-</span> <span class="va">routes_geocoded</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">direction</span> <span class="op">==</span> <span class="st">"There"</span>, <span class="va">day</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">stops_day1</span> <span class="op">&lt;-</span> <span class="va">all_stops_endpoints</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">direction</span> <span class="op">==</span> <span class="st">"There"</span>, <span class="va">day</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">states_crossed_day1</span> <span class="op">&lt;-</span> <span class="fu">st_intersection</span><span class="op">(</span></span>
<span>  <span class="fu">st_transform</span><span class="op">(</span><span class="va">lower_48</span>, <span class="fu">st_crs</span><span class="op">(</span><span class="va">route_day1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="va">route_day1</span></span>
<span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">distinct</span><span class="op">(</span><span class="va">NAME</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lower_48_highlighted_day1</span> <span class="op">&lt;-</span> <span class="va">lower_48</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>visited <span class="op">=</span> <span class="va">NAME</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">states_crossed_day1</span><span class="op">$</span><span class="va">NAME</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s plot these to make sure it worked:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">lower_48_highlighted_day1</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">visited</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">route_day1</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">stops_day1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf_label</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">stops_day1</span>, </span>
<span>    <span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">city</span><span class="op">)</span>,</span>
<span>    nudge_y <span class="op">=</span> <span class="fu">miles_to_meters</span><span class="op">(</span><span class="fl">80</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"grey90"</span>, <span class="st">"grey80"</span><span class="op">)</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span>crs <span class="op">=</span> <span class="fu">st_crs</span><span class="op">(</span><span class="st">"ESRI:102003"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>  <span class="co"># Albers</span></span>
<span>  <span class="fu">theme_roadtrip</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p><img src="index_files/figure-html/plot-day1-preliminary-1.png" class="img-fluid figure-img" style="width:100.0%" alt="Drive for the first day on the full US map"></p>
<figcaption class="margin-caption">Drive for the first day on the full US map</figcaption></figure>
</div>
</div>
</div>
<p>Yep, it worked. But we don’t need to show the whole map—we want to zoom in on just the area around the route for the day. To do this, we can use <code>st_bbox()</code> to extract a rectangle of coordinates around the route, creating a bounding box for the map that we can then use with <code>coord_sf()</code> to zoom in.</p>
<p><code>st_bbox()</code> returns a named vector of numbers with the x- and y-axis limits:</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bbox</span> <span class="op">&lt;-</span> <span class="fu">st_bbox</span><span class="op">(</span><span class="va">route_day1</span><span class="op">)</span></span>
<span><span class="va">bbox</span></span>
<span><span class="co">##  xmin  ymin  xmax  ymax </span></span>
<span><span class="co">## -90.1  30.0 -84.4  33.7</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Since the elements are all named, we can use them to specify the different values in <code>coord_sf()</code>. First we’ll temporarily stop using the <a href="https://en.wikipedia.org/wiki/Albers_projection">Albers projection</a>, since the numbers we’ve extracted with <code>st_bbox()</code> are on the <a href="https://en.wikipedia.org/wiki/World_Geodetic_System">WGS 84 (−180 to 180) scale</a> and Albers uses meters, which will make the map not work. (But we’ll fix that in a minute!)</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">lower_48_highlighted_day1</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">visited</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">route_day1</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">stops_day1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf_label</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">stops_day1</span>, </span>
<span>    <span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">city</span><span class="op">)</span>,</span>
<span>    <span class="co"># We're not using Albers, so this isn't measured in meters; it's decimal degrees</span></span>
<span>    nudge_y <span class="op">=</span> <span class="fl">0.15</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">annotation_scale</span><span class="op">(</span></span>
<span>    location <span class="op">=</span> <span class="st">"bl"</span>, bar_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"grey30"</span>, <span class="st">"white"</span><span class="op">)</span>,</span>
<span>    unit_category <span class="op">=</span> <span class="st">"imperial"</span>, text_family <span class="op">=</span> <span class="st">"Overpass"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"grey90"</span>, <span class="st">"grey80"</span><span class="op">)</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span></span>
<span>    xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">bbox</span><span class="op">[</span><span class="st">"xmin"</span><span class="op">]</span>, <span class="va">bbox</span><span class="op">[</span><span class="st">"xmax"</span><span class="op">]</span><span class="op">)</span>, </span>
<span>    ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">bbox</span><span class="op">[</span><span class="st">"ymin"</span><span class="op">]</span>, <span class="va">bbox</span><span class="op">[</span><span class="st">"ymax"</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_roadtrip</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p><img src="index_files/figure-html/plot-day1-bbox-basic-1.png" class="img-fluid figure-img" style="width:100.0%" alt="Trip for the first day, but zoomed in a little too far"></p>
<figcaption class="margin-caption">Trip for the first day, but zoomed in a little too far</figcaption></figure>
</div>
</div>
</div>
<p>We’re zoomed in (yay) but the edges of the bounding box window are too close to the points and the route, and the labels are cropped funny. Also, to shift the labels up we had to think in <a href="https://en.wikipedia.org/wiki/Decimal_degrees">decimal degrees</a> instead of meters, which I can’t do naturally. And also, we can’t change projections—because we’re specifying the bounding box coordinates in decimal degrees, we’re stuck with WGS 84 instead of Albers or any other projection. These are all fixable issues, fortunately.</p>
<p>To fix all this, we’ll expand the bounding box window by 150 miles on all sides using <code>st_buffer()</code> and then convert the coordinates to Albers before extracting the coordinates of the window for plotting:</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bbox_nice</span> <span class="op">&lt;-</span> <span class="va">route_day1</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">st_bbox</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>  <span class="co"># Extract the bounding box of the coordinates</span></span>
<span>  <span class="fu">st_as_sfc</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>  <span class="co"># Convert the bounding box matrix back to an sf object</span></span>
<span>  <span class="fu">st_buffer</span><span class="op">(</span><span class="fu">miles_to_meters</span><span class="op">(</span><span class="fl">150</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>  <span class="co"># Add 150 miles to all sides</span></span>
<span>  <span class="fu">st_transform</span><span class="op">(</span><span class="st">"ESRI:102003"</span><span class="op">)</span> <span class="op">%&gt;%</span>  <span class="co"># Switch to Albers</span></span>
<span>  <span class="fu">st_bbox</span><span class="op">(</span><span class="op">)</span>  <span class="co"># Extract the bounding box of the expanded box</span></span>
<span><span class="va">bbox_nice</span></span>
<span><span class="co">##     xmin     ymin     xmax     ymax </span></span>
<span><span class="co">##   301851 -1071395  1366321  -105313</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>These are no longer in decimal degrees, so we can use them with the Albers projection. We’ve also added a 150-mile buffer around the window, so we should have room for all the labels now. Let’s check it:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">lower_48_highlighted_day1</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">visited</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">route_day1</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">stops_day1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf_label</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">stops_day1</span>, </span>
<span>    <span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">city</span><span class="op">)</span>,</span>
<span>    <span class="co"># We're in Albers again, so we can work with meters (or miles)</span></span>
<span>    nudge_y <span class="op">=</span> <span class="fu">miles_to_meters</span><span class="op">(</span><span class="fl">30</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">annotation_scale</span><span class="op">(</span></span>
<span>    location <span class="op">=</span> <span class="st">"bl"</span>, bar_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"grey30"</span>, <span class="st">"white"</span><span class="op">)</span>,</span>
<span>    unit_category <span class="op">=</span> <span class="st">"imperial"</span>, text_family <span class="op">=</span> <span class="st">"Overpass"</span>,</span>
<span>    width_hint <span class="op">=</span> <span class="fl">0.4</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"grey90"</span>, <span class="st">"grey80"</span><span class="op">)</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span></span>
<span>    xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">bbox_nice</span><span class="op">[</span><span class="st">"xmin"</span><span class="op">]</span>, <span class="va">bbox_nice</span><span class="op">[</span><span class="st">"xmax"</span><span class="op">]</span><span class="op">)</span>, </span>
<span>    ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">bbox_nice</span><span class="op">[</span><span class="st">"ymin"</span><span class="op">]</span>, <span class="va">bbox_nice</span><span class="op">[</span><span class="st">"ymax"</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    crs <span class="op">=</span> <span class="fu">st_crs</span><span class="op">(</span><span class="st">"ESRI:102003"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_roadtrip</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p><img src="index_files/figure-html/plot-day1-bbox-buffer-albers-1.png" class="img-fluid figure-img" style="width:100.0%" alt="Trip for the first day, correctly zoomed and using the Albers projection"></p>
<figcaption class="margin-caption">Trip for the first day, correctly zoomed and using the Albers projection</figcaption></figure>
</div>
</div>
</div>
<p>Heck yeah.</p>
<p>However, the shapes look a little curved and distorted because we’re zoomed in so much. Albers is great for big countries, but on a small scale like this, WGS 84 is probably fine. That’s what Google Maps does—it only starts getting weird and curvy along horizontal latitude lines when you zoom out really far. Let’s do the first day map one last time without the Albers conversion:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bbox_nice</span> <span class="op">&lt;-</span> <span class="va">route_day1</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">st_bbox</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>  <span class="co"># Extract the bounding box of the coordinates</span></span>
<span>  <span class="fu">st_as_sfc</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>  <span class="co"># Convert the bounding box matrix back to an sf object</span></span>
<span>  <span class="fu">st_buffer</span><span class="op">(</span><span class="fu">miles_to_meters</span><span class="op">(</span><span class="fl">150</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>  <span class="co"># Add 150 miles to all sides</span></span>
<span>  <span class="fu">st_bbox</span><span class="op">(</span><span class="op">)</span>  <span class="co"># Extract the bounding box of the expanded box</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">lower_48_highlighted_day1</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">visited</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">route_day1</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">stops_day1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf_label</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">stops_day1</span>, </span>
<span>    <span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">city</span><span class="op">)</span>,</span>
<span>    <span class="co"># We're in WGS 84, so these are decimal degrees</span></span>
<span>    nudge_y <span class="op">=</span> <span class="fl">0.5</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_label_repel</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">route_day1</span>,</span>
<span>    <span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">distance_text</span>, geometry <span class="op">=</span> <span class="va">route_geometry</span><span class="op">)</span>,</span>
<span>    stat <span class="op">=</span> <span class="st">"sf_coordinates"</span>, seed <span class="op">=</span> <span class="fl">12345</span>,</span>
<span>    family <span class="op">=</span> <span class="st">"Overpass ExtraBold"</span>, fontface <span class="op">=</span> <span class="st">"plain"</span>,</span>
<span>    size <span class="op">=</span> <span class="fl">3.5</span>, fill <span class="op">=</span> <span class="fu">colorspace</span><span class="fu">::</span><span class="fu">lighten</span><span class="op">(</span><span class="va">clrs</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span>, <span class="fl">0.8</span><span class="op">)</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, </span>
<span>    segment.color <span class="op">=</span> <span class="st">"grey50"</span>, min.segment.length <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">annotation_scale</span><span class="op">(</span></span>
<span>    location <span class="op">=</span> <span class="st">"bl"</span>, bar_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"grey30"</span>, <span class="st">"white"</span><span class="op">)</span>,</span>
<span>    unit_category <span class="op">=</span> <span class="st">"imperial"</span>, text_family <span class="op">=</span> <span class="st">"Overpass"</span>,</span>
<span>    width_hint <span class="op">=</span> <span class="fl">0.3</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"grey90"</span>, <span class="st">"grey80"</span><span class="op">)</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span></span>
<span>    xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">bbox_nice</span><span class="op">[</span><span class="st">"xmin"</span><span class="op">]</span>, <span class="va">bbox_nice</span><span class="op">[</span><span class="st">"xmax"</span><span class="op">]</span><span class="op">)</span>, </span>
<span>    ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">bbox_nice</span><span class="op">[</span><span class="st">"ymin"</span><span class="op">]</span>, <span class="va">bbox_nice</span><span class="op">[</span><span class="st">"ymax"</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    crs <span class="op">=</span> <span class="fu">st_crs</span><span class="op">(</span><span class="st">"EPSG:4326"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_roadtrip</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p><img src="index_files/figure-html/plot-day1-bbox-buffer-wgs84-1.png" class="img-fluid figure-img" style="width:100.0%" alt="Trip for the first day, correctly zoomed and using the WGS 84 projection"></p>
<figcaption class="margin-caption">Trip for the first day, correctly zoomed and using the WGS 84 projection</figcaption></figure>
</div>
</div>
</div>
<p>Neat. The northern borders of Georgia, Alabama, and Mississippi are all flat here, which is great.</p>
</section><section id="all-the-days-of-the-trip" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="all-the-days-of-the-trip">All the days of the trip</h2>
<p>We successfully plotted one day of the trip. But we’ll be driving for 11 days (!) and need 11 plots. I don’t want to copy/paste this all code 11 times, so we’ll stick each major step into a function:</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Take a set of routes and do some pivoting to create a dataset that includes</span></span>
<span><span class="co"># the start and end points</span></span>
<span><span class="va">expand_endpoints</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">routes</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">routes</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">pivot_longer</span><span class="op">(</span></span>
<span>    cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">origin_city</span>, <span class="va">destination_city</span>, <span class="va">origin_geometry</span>, <span class="va">destination_geometry</span><span class="op">)</span>,</span>
<span>    names_to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"type"</span>, <span class="st">".value"</span><span class="op">)</span>,</span>
<span>    names_sep <span class="op">=</span> <span class="st">"_"</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">city</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">slice</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="va">type</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">st_set_geometry</span><span class="op">(</span><span class="st">"geometry"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Take a set of routes and return a dataset with a flag marking which states they cross</span></span>
<span><span class="va">find_states</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">routes</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># st_intersection() complains about innocuous things so suppress the warnings</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/warning.html">suppressWarnings</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">states_crossed</span> <span class="op">&lt;-</span> <span class="fu">st_intersection</span><span class="op">(</span></span>
<span>      <span class="fu">st_transform</span><span class="op">(</span><span class="va">lower_48</span>, <span class="fu">st_crs</span><span class="op">(</span><span class="va">routes</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      <span class="va">routes</span></span>
<span>    <span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>      <span class="fu">distinct</span><span class="op">(</span><span class="va">NAME</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">lower_48</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">mutate</span><span class="op">(</span>visited <span class="op">=</span> <span class="va">NAME</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">states_crossed</span><span class="op">$</span><span class="va">NAME</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Use routes, stopes, and states to build a plot</span></span>
<span><span class="va">build_day_map</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">routes</span>, <span class="va">stops</span>, <span class="va">states</span>, <span class="va">direction</span>, <span class="va">day</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">bbox_nice</span> <span class="op">&lt;-</span> <span class="va">routes</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">st_bbox</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>  <span class="co"># Extract the bounding box of the coordinates</span></span>
<span>    <span class="fu">st_as_sfc</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>  <span class="co"># Convert the bounding box matrix back to an sf object</span></span>
<span>    <span class="fu">st_buffer</span><span class="op">(</span><span class="fu">miles_to_meters</span><span class="op">(</span><span class="fl">150</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>  <span class="co"># Add 150 miles to all sides</span></span>
<span>    <span class="fu">st_bbox</span><span class="op">(</span><span class="op">)</span>  <span class="co"># Extract the bounding box of the expanded box</span></span>
<span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">states</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">visited</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">routes</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">stops</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_sf_label</span><span class="op">(</span></span>
<span>      data <span class="op">=</span> <span class="va">stops</span>,</span>
<span>      <span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">city</span><span class="op">)</span>,</span>
<span>      <span class="co"># We're in WGS 84, so these are decimal degrees</span></span>
<span>      nudge_y <span class="op">=</span> <span class="fl">0.4</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_label_repel</span><span class="op">(</span></span>
<span>      data <span class="op">=</span> <span class="va">routes</span>,</span>
<span>      <span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">distance_text</span>, geometry <span class="op">=</span> <span class="va">route_geometry</span><span class="op">)</span>,</span>
<span>      stat <span class="op">=</span> <span class="st">"sf_coordinates"</span>, seed <span class="op">=</span> <span class="fl">12345</span>,</span>
<span>      family <span class="op">=</span> <span class="st">"Overpass ExtraBold"</span>, fontface <span class="op">=</span> <span class="st">"plain"</span>,</span>
<span>      size <span class="op">=</span> <span class="fl">3.5</span>, fill <span class="op">=</span> <span class="fu">colorspace</span><span class="fu">::</span><span class="fu">lighten</span><span class="op">(</span><span class="va">clrs</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span>, <span class="fl">0.8</span><span class="op">)</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, </span>
<span>      segment.color <span class="op">=</span> <span class="st">"grey50"</span>, min.segment.length <span class="op">=</span> <span class="fl">0</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">annotation_scale</span><span class="op">(</span></span>
<span>      location <span class="op">=</span> <span class="st">"bl"</span>, bar_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"grey30"</span>, <span class="st">"white"</span><span class="op">)</span>,</span>
<span>      unit_category <span class="op">=</span> <span class="st">"imperial"</span>, text_family <span class="op">=</span> <span class="st">"Overpass"</span>,</span>
<span>      width_hint <span class="op">=</span> <span class="fl">0.4</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"grey90"</span>, <span class="st">"grey80"</span><span class="op">)</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">coord_sf</span><span class="op">(</span></span>
<span>      xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">bbox_nice</span><span class="op">[</span><span class="st">"xmin"</span><span class="op">]</span>, <span class="va">bbox_nice</span><span class="op">[</span><span class="st">"xmax"</span><span class="op">]</span><span class="op">)</span>,</span>
<span>      ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">bbox_nice</span><span class="op">[</span><span class="st">"ymin"</span><span class="op">]</span>, <span class="va">bbox_nice</span><span class="op">[</span><span class="st">"ymax"</span><span class="op">]</span><span class="op">)</span>,</span>
<span>      crs <span class="op">=</span> <span class="fu">st_crs</span><span class="op">(</span><span class="st">"EPSG:4326"</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"{direction}, day {day}"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">theme_roadtrip</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>With everything functionalized, we can do some super wild {purrr} magic. If we take <code>routes_geocoded</code> and group it by direction and day (so there’s a group per driving day), we’ll get a list column that contains the geocded coordinates for each day:</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">daily_plots</span> <span class="op">&lt;-</span> <span class="va">routes_geocoded</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">direction</span>, <span class="va">day</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">nest</span><span class="op">(</span>.key <span class="op">=</span> <span class="st">"routes"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">daily_plots</span></span>
<span><span class="co">## # A tibble: 11 × 3</span></span>
<span><span class="co">## # Groups:   direction, day [11]</span></span>
<span><span class="co">##    direction    day routes       </span></span>
<span><span class="co">##    &lt;fct&gt;      &lt;dbl&gt; &lt;list&gt;       </span></span>
<span><span class="co">##  1 There          1 &lt;sf [1 × 12]&gt;</span></span>
<span><span class="co">##  2 There          2 &lt;sf [1 × 12]&gt;</span></span>
<span><span class="co">##  3 There          3 &lt;sf [1 × 12]&gt;</span></span>
<span><span class="co">##  4 There          4 &lt;sf [1 × 12]&gt;</span></span>
<span><span class="co">##  5 There          5 &lt;sf [1 × 12]&gt;</span></span>
<span><span class="co">##  6 There          6 &lt;sf [1 × 12]&gt;</span></span>
<span><span class="co">##  7 Back again     1 &lt;sf [2 × 12]&gt;</span></span>
<span><span class="co">##  8 Back again     2 &lt;sf [2 × 12]&gt;</span></span>
<span><span class="co">##  9 Back again     3 &lt;sf [1 × 12]&gt;</span></span>
<span><span class="co">## 10 Back again     4 &lt;sf [1 × 12]&gt;</span></span>
<span><span class="co">## 11 Back again     5 &lt;sf [1 × 12]&gt;</span></span>
<span></span>
<span><span class="co"># Check the first day</span></span>
<span><span class="va">daily_plots</span><span class="op">$</span><span class="va">routes</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">## Simple feature collection with 1 feature and 9 fields</span></span>
<span><span class="co">## Active geometry column: route_geometry</span></span>
<span><span class="co">## Geometry type: LINESTRING</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: -90.1 ymin: 30 xmax: -84.4 ymax: 33.7</span></span>
<span><span class="co">## Geodetic CRS:  WGS 84</span></span>
<span><span class="co">## # A tibble: 1 × 12</span></span>
<span><span class="co">##   origin_city      origin_geometry destination_geometry destination_city       route_src route_dst route_duration route_distance                                                                            route_geometry distance_miles distance_text duration_text     </span></span>
<span><span class="co">##   &lt;chr&gt;                &lt;POINT [°]&gt;          &lt;POINT [°]&gt; &lt;chr&gt;                  &lt;chr&gt;     &lt;chr&gt;              &lt;dbl&gt;          &lt;dbl&gt;                                                                          &lt;LINESTRING [°]&gt;          &lt;dbl&gt; &lt;chr&gt;         &lt;chr&gt;             </span></span>
<span><span class="co">## 1 Atlanta, Georgia    (-84.4 33.7)           (-90.1 30) New Orleans, Louisiana src       dst                 513.           753. (-84.4 33.7, -84.5 33.6, -84.8 33.4, -84.9 33.1, -85.1 32.9, -85.4 32.6, -85.7 32.5, -...           468. 470 miles     8 hours 30 minutes</span></span>
<span></span>
<span><span class="co"># Check the first day of the return trip</span></span>
<span><span class="va">daily_plots</span><span class="op">$</span><span class="va">routes</span><span class="op">[[</span><span class="fl">7</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">## Simple feature collection with 2 features and 9 fields</span></span>
<span><span class="co">## Active geometry column: route_geometry</span></span>
<span><span class="co">## Geometry type: LINESTRING</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: -112 ymin: 40.1 xmax: -111 ymax: 44.7</span></span>
<span><span class="co">## Geodetic CRS:  WGS 84</span></span>
<span><span class="co">## # A tibble: 2 × 12</span></span>
<span><span class="co">##   origin_city        origin_geometry destination_geometry destination_city        route_src route_dst route_duration route_distance                                                                            route_geometry distance_miles distance_text duration_text     </span></span>
<span><span class="co">##   &lt;chr&gt;                  &lt;POINT [°]&gt;          &lt;POINT [°]&gt; &lt;chr&gt;                   &lt;chr&gt;     &lt;chr&gt;              &lt;dbl&gt;          &lt;dbl&gt;                                                                          &lt;LINESTRING [°]&gt;          &lt;dbl&gt; &lt;chr&gt;         &lt;chr&gt;             </span></span>
<span><span class="co">## 1 Spanish Fork, Utah     (-112 40.1)          (-112 43.4) Shelley, Idaho          src       dst                 262.           411. (-112 40.1, -112 40.2, -112 40.3, -112 40.5, -112 41, -112 41.1, -112 41.2, -112 41.6,...           256. 260 miles     4 hours 15 minutes</span></span>
<span><span class="co">## 2 Shelley, Idaho         (-112 43.4)          (-111 44.5) Yellowstone NP, Wyoming src       dst                 199.           240. (-112 43.4, -112 43.8, -112 43.9, -112 43.9, -112 44, -112 44, -111 44.1, -111 44.2, -...           149. 150 miles     3 hours 15 minutes</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We can then use <code>purrr::map()</code> and <code>purrr::pmap()</code> to feed that nested list-column data frame through the different functions to expand endpoints, find crossed-through states, and build the daily plot.</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">daily_plots</span> <span class="op">&lt;-</span> <span class="va">routes_geocoded</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">direction</span>, <span class="va">day</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">nest</span><span class="op">(</span>.key <span class="op">=</span> <span class="st">"routes"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    stops <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">routes</span>, <span class="va">expand_endpoints</span><span class="op">)</span>,</span>
<span>    states <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">routes</span>, <span class="va">find_states</span><span class="op">)</span>,</span>
<span>    plot <span class="op">=</span> <span class="fu">pmap</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">routes</span>, <span class="va">stops</span>, <span class="va">states</span>, <span class="va">direction</span>, <span class="va">day</span><span class="op">)</span>, <span class="va">build_day_map</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Before looking at the plots, check out all these nested datasets! Each day has a dataset for the routes, stops, states, and final plot, and everything is contained here in a data frame. MAGICAL.</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">daily_plots</span></span>
<span><span class="co">## # A tibble: 11 × 6</span></span>
<span><span class="co">## # Groups:   direction, day [11]</span></span>
<span><span class="co">##    direction    day routes        stops         states         plot  </span></span>
<span><span class="co">##    &lt;fct&gt;      &lt;dbl&gt; &lt;list&gt;        &lt;list&gt;        &lt;list&gt;         &lt;list&gt;</span></span>
<span><span class="co">##  1 There          1 &lt;sf [1 × 12]&gt; &lt;sf [2 × 11]&gt; &lt;sf [49 × 11]&gt; &lt;gg&gt;  </span></span>
<span><span class="co">##  2 There          2 &lt;sf [1 × 12]&gt; &lt;sf [2 × 11]&gt; &lt;sf [49 × 11]&gt; &lt;gg&gt;  </span></span>
<span><span class="co">##  3 There          3 &lt;sf [1 × 12]&gt; &lt;sf [2 × 11]&gt; &lt;sf [49 × 11]&gt; &lt;gg&gt;  </span></span>
<span><span class="co">##  4 There          4 &lt;sf [1 × 12]&gt; &lt;sf [2 × 11]&gt; &lt;sf [49 × 11]&gt; &lt;gg&gt;  </span></span>
<span><span class="co">##  5 There          5 &lt;sf [1 × 12]&gt; &lt;sf [2 × 11]&gt; &lt;sf [49 × 11]&gt; &lt;gg&gt;  </span></span>
<span><span class="co">##  6 There          6 &lt;sf [1 × 12]&gt; &lt;sf [2 × 11]&gt; &lt;sf [49 × 11]&gt; &lt;gg&gt;  </span></span>
<span><span class="co">##  7 Back again     1 &lt;sf [2 × 12]&gt; &lt;sf [3 × 11]&gt; &lt;sf [49 × 11]&gt; &lt;gg&gt;  </span></span>
<span><span class="co">##  8 Back again     2 &lt;sf [2 × 12]&gt; &lt;sf [3 × 11]&gt; &lt;sf [49 × 11]&gt; &lt;gg&gt;  </span></span>
<span><span class="co">##  9 Back again     3 &lt;sf [1 × 12]&gt; &lt;sf [2 × 11]&gt; &lt;sf [49 × 11]&gt; &lt;gg&gt;  </span></span>
<span><span class="co">## 10 Back again     4 &lt;sf [1 × 12]&gt; &lt;sf [2 × 11]&gt; &lt;sf [49 × 11]&gt; &lt;gg&gt;  </span></span>
<span><span class="co">## 11 Back again     5 &lt;sf [1 × 12]&gt; &lt;sf [2 × 11]&gt; &lt;sf [49 × 11]&gt; &lt;gg&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We can extract the plot for any single day with indexing:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">daily_plots</span><span class="op">$</span><span class="va">plot</span><span class="op">[[</span><span class="fl">10</span><span class="op">]</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p><img src="index_files/figure-html/plot-day10-indexed-1.png" class="img-fluid figure-img" style="width:100.0%" alt="Trip for the day 4 of the return trip"></p>
<figcaption class="margin-caption">Trip for the day 4 of the return trip</figcaption></figure>
</div>
</div>
</div>
<p>Or we can filter, pull, and pluck like good denizens of the tidyverse:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">daily_plots</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">direction</span> <span class="op">==</span> <span class="st">"Back again"</span>, <span class="va">day</span> <span class="op">==</span> <span class="fl">5</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">pull</span><span class="op">(</span><span class="va">plot</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">pluck</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p><img src="index_files/figure-html/plot-day5-verbose-1.png" class="img-fluid figure-img" style="width:100.0%" alt="Trip for the day 5 of the return trip"></p>
<figcaption class="margin-caption">Trip for the day 5 of the return trip</figcaption></figure>
</div>
</div>
</div>
<p>Here’s all of them simultaneously inside a <a href="https://quarto.org/docs/output-formats/html-basics.html#tabsets">Quarto tabset</a>, just for fun:</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist">
<li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-3-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-1" role="tab" aria-controls="tabset-3-1" aria-selected="true">The trip there</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-2" role="tab" aria-controls="tabset-3-2" aria-selected="false">The trip back again</a></li>
</ul>
<div class="tab-content">
<div id="tabset-3-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-3-1-tab">
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist">
<li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true">Day 1</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">Day 2</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" role="tab" aria-controls="tabset-1-3" aria-selected="false">Day 3</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-4" role="tab" aria-controls="tabset-1-4" aria-selected="false">Day 4</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-5" role="tab" aria-controls="tabset-1-5" aria-selected="false">Day 5</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-6-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-6" role="tab" aria-controls="tabset-1-6" aria-selected="false">Day 6</a></li>
</ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div class="cell" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">daily_plots</span><span class="op">$</span><span class="va">plot</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/panel-there-day1-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div class="cell" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">daily_plots</span><span class="op">$</span><span class="va">plot</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/panel-there-day2-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-3-tab">
<div class="cell" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">daily_plots</span><span class="op">$</span><span class="va">plot</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/panel-there-day3-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-4-tab">
<div class="cell" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">daily_plots</span><span class="op">$</span><span class="va">plot</span><span class="op">[[</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/panel-there-day4-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-5" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-5-tab">
<div class="cell" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">daily_plots</span><span class="op">$</span><span class="va">plot</span><span class="op">[[</span><span class="fl">5</span><span class="op">]</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/panel-there-day5-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-6" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-6-tab">
<div class="cell" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">daily_plots</span><span class="op">$</span><span class="va">plot</span><span class="op">[[</span><span class="fl">6</span><span class="op">]</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/panel-there-day6-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="tabset-3-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-2-tab">
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist">
<li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" role="tab" aria-controls="tabset-2-1" aria-selected="true">Day 1</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" role="tab" aria-controls="tabset-2-2" aria-selected="false">Day 2</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-3" role="tab" aria-controls="tabset-2-3" aria-selected="false">Day 3</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-4" role="tab" aria-controls="tabset-2-4" aria-selected="false">Day 4</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-5" role="tab" aria-controls="tabset-2-5" aria-selected="false">Day 5</a></li>
</ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-2-1-tab">
<div class="cell" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">daily_plots</span><span class="op">$</span><span class="va">plot</span><span class="op">[[</span><span class="fl">7</span><span class="op">]</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/panel-back-day1-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-2-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-2-tab">
<div class="cell" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">daily_plots</span><span class="op">$</span><span class="va">plot</span><span class="op">[[</span><span class="fl">8</span><span class="op">]</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/panel-back-day2-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-2-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-3-tab">
<div class="cell" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">daily_plots</span><span class="op">$</span><span class="va">plot</span><span class="op">[[</span><span class="fl">9</span><span class="op">]</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/panel-back-day3-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-2-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-4-tab">
<div class="cell" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">daily_plots</span><span class="op">$</span><span class="va">plot</span><span class="op">[[</span><span class="fl">10</span><span class="op">]</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/panel-back-day4-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-2-5" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-5-tab">
<div class="cell" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb51"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">daily_plots</span><span class="op">$</span><span class="va">plot</span><span class="op">[[</span><span class="fl">11</span><span class="op">]</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/panel-back-day5-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<p>Or, instead of extracting each plot individually like this, we can use <code>wrap_plots()</code> from {patchwork} to combine a whole list of plots automatically, though we have a lot less control over the plots this way—some of the maps use a landscape orientation and some use a portrait orientation, so they’re a big mess when combined like this:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">daily_plots</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">pull</span><span class="op">(</span><span class="va">plot</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">wrap_plots</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/patchwork-everything-ugly-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-screen-inset" style="width:100.0%" alt="Ugly massive plot of all the days of the trip"></p>
</figure>
</div>
</div>
</div>
<hr>
<p>Time to add some maps to road trip journals and finish packing!</p>


<!-- -->

</section></section><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{heiss2023,
  author = {Heiss, Andrew},
  title = {How to Make Fancy Road Trip Maps with {R} and
    {OpenStreetMap}},
  date = {2023-06-01},
  url = {https://www.andrewheiss.com/blog/2023/06/01/geocoding-routing-openstreetmap-r/},
  doi = {10.59350/rgwda-0tv16},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-heiss2023" class="csl-entry quarto-appendix-citeas" role="listitem">
Heiss, Andrew. 2023. <span>“How to Make Fancy Road Trip Maps with R and
OpenStreetMap.”</span> June 1, 2023. <a href="https://doi.org/10.59350/rgwda-0tv16">https://doi.org/10.59350/rgwda-0tv16</a>.
</div></div></section></div></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/www\.andrewheiss\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><script src="https://giscus.app/client.js" data-repo="andrewheiss/ath-quarto" data-repo-id="R_kgDOIg6EJQ" data-category="Blog comments" data-category-id="DIC_kwDOIg6EJc4CSz92" data-mapping="pathname" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script><input type="hidden" id="giscus-base-theme" value="light"><input type="hidden" id="giscus-alt-theme" value="dark"><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb53" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "How to make fancy road trip maps with R and OpenStreetMap"</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> 2023-06-01</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="an">description:</span><span class="co"> "Use R to get geocoded location and routing data from OpenStreetMap and explore our family's impending 5,000 mile road trip around the USA"</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="an">image:</span><span class="co"> index_files/figure-html/plot-routes-stops-distances-1.png</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a><span class="an">twitter-card:</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a><span class="co">  image: "index_files/figure-html/plot-routes-stops-distances-1.png"</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a><span class="an">open-graph:</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a><span class="co">  image: "index_files/figure-html/plot-routes-stops-distances-1.png"</span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a><span class="co">  - r</span></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a><span class="co">  - tidyverse</span></span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a><span class="co">  - ggplot</span></span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a><span class="co">  - gis</span></span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a><span class="co">  - maps</span></span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a><span class="co">    reference-location: margin</span></span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: show</span></span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a><span class="an">doi:</span><span class="co"> 10.59350/rgwda-0tv16</span></span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a><span class="an">citation:</span><span class="co"> true</span></span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setup, include=FALSE}</span></span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::opts_chunk$set(fig.align = "center", fig.retina = 3,</span></span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a><span class="in">                      fig.width = 7, fig.height = (7 / 1.618),</span></span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a><span class="in">                      out.width = "100%", collapse = TRUE,</span></span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a><span class="in">                      dev = "ragg_png",</span></span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a><span class="in">                      cache.extra = 123)  # Change number to invalidate cache</span></span>
<span id="cb53-30"><a href="#cb53-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-31"><a href="#cb53-31" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::opts_chunk$set(message = FALSE)</span></span>
<span id="cb53-32"><a href="#cb53-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-33"><a href="#cb53-33" aria-hidden="true" tabindex="-1"></a><span class="in">options(digits = 3, width = 300,</span></span>
<span id="cb53-34"><a href="#cb53-34" aria-hidden="true" tabindex="-1"></a><span class="in">        dplyr.summarise.inform = FALSE)</span></span>
<span id="cb53-35"><a href="#cb53-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-36"><a href="#cb53-36" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(1234)</span></span>
<span id="cb53-37"><a href="#cb53-37" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-38"><a href="#cb53-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-39"><a href="#cb53-39" aria-hidden="true" tabindex="-1"></a>In a couple days, I'm going to drive across the country to Utah, my home state. I haven't been out west with my whole family in four years—not since 2019 when we moved from Spanish Fork, Utah to Atlanta, Georgia. According to Google Maps, <span class="co">[</span><span class="ot">it's a mere 1,900 miles</span><span class="co">](https://goo.gl/maps/aGXJPL85LMTW2cuS9)</span> (3,000 kilometers) through the middle of the United States and should take 28 hours, assuming no stops. </span>
<span id="cb53-40"><a href="#cb53-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-41"><a href="#cb53-41" aria-hidden="true" tabindex="-1"></a><span class="al">![Google Maps route from Atlanta, Georgia to Spanish Fork, Utah](img/google-maps-ga-to-ut.png)</span></span>
<span id="cb53-42"><a href="#cb53-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-43"><a href="#cb53-43" aria-hidden="true" tabindex="-1"></a>For bonus fun though, my wife and I decided to make this trip even more adventurous and hit as many exciting stops as possible. So rather than drive through the middle of Kansas, we're going along the southern border on the way there, visiting New Orleans, Louisiana; San Antonio, Texas; <span class="co">[</span><span class="ot">Carlsbad Caverns</span><span class="co">](https://en.wikipedia.org/wiki/Carlsbad_Caverns_National_Park)</span>, New Mexico; the <span class="co">[</span><span class="ot">Grand Canyon</span><span class="co">](https://en.wikipedia.org/wiki/Grand_Canyon)</span> in Arizona; and then camping for a couple days at <span class="co">[</span><span class="ot">Capitol Reef National Park</span><span class="co">](https://en.wikipedia.org/wiki/Capitol_Reef_National_Park)</span> in Southern Utah before finally arriving at my aunt's house in Spanish Fork, Utah. On the way home, we're going across the northern part of the United States, visiting my sister in Idaho before heading towards <span class="co">[</span><span class="ot">Yellowstone</span><span class="co">](https://en.wikipedia.org/wiki/Yellowstone_National_Park)</span> in Wyoming; <span class="co">[</span><span class="ot">Devil's Tower</span><span class="co">](https://en.wikipedia.org/wiki/Devils_Tower)</span> in Wyoming; <span class="co">[</span><span class="ot">Mount Rushmore</span><span class="co">](https://en.wikipedia.org/wiki/Mount_Rushmore)</span> in South Dakota; and <span class="co">[</span><span class="ot">Nauvoo, Illinois</span><span class="co">](https://en.wikipedia.org/wiki/Nauvoo,_Illinois)</span> (<span class="co">[</span><span class="ot">Mormons!</span><span class="co">](https://www.churchofjesuschrist.org/learn/locations/historic-nauvoo)</span>). It's going to be an awesome—but *way* longer—mega road trip. </span>
<span id="cb53-44"><a href="#cb53-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-45"><a href="#cb53-45" aria-hidden="true" tabindex="-1"></a>To help keep six kids entertained beyond just plugging them into iPads, my wife made some road trip journals to make the experience more memorable and educational, and we're bringing a bunch of books and extra materials about each of the stops we'll be making so they can do research along the way.</span>
<span id="cb53-46"><a href="#cb53-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-47"><a href="#cb53-47" aria-hidden="true" tabindex="-1"></a>I just finished revamping my <span class="co">[</span><span class="ot">online data visualization class</span><span class="co">](https://datavizs23.classes.andrewheiss.com/)</span> this week since the summer semester is starting next week, so visualizing data through maps has been on my mind. In my session on visualizing maps, <span class="co">[</span><span class="ot">I added a section on making and visualizing your own geocoded data</span><span class="co">](https://datavizs23.classes.andrewheiss.com/example/12-example.html#making-your-own-geocoded-data)</span> (i.e. plotting specific cities on a map), so I figured it would be neat to visualize this huge road trip somehow to make some maps to include in the kids' journals.</span>
<span id="cb53-48"><a href="#cb53-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-49"><a href="#cb53-49" aria-hidden="true" tabindex="-1"></a>Getting the latitude and longitude coordinates for specific cities or addresses is super easy—you can either <span class="co">[</span><span class="ot">right click on Google Maps and copy specific coordinates</span><span class="co">](https://datavizs23.classes.andrewheiss.com/example/12-example.html#making-your-own-geocoded-data)</span>, or you can <span class="co">[</span><span class="ot">automate it</span><span class="co">](https://datavizs23.classes.andrewheiss.com/example/12-example.html#automatic-geoencoding-by-address)</span> with the <span class="co">[</span><span class="ot">{tidygeocoder} package</span><span class="co">](https://jessecambon.github.io/tidygeocoder/)</span> in R. </span>
<span id="cb53-50"><a href="#cb53-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-51"><a href="#cb53-51" aria-hidden="true" tabindex="-1"></a>Getting route coordinates is a lot trickier though, since it involves all sorts of complex algorithms (accounting for road locations, speed limits, traffic, etc.). This is why Google Maps is so invaluable—it does an excellent job of figuring this out. But Google's data is proprietary. </span>
<span id="cb53-52"><a href="#cb53-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-53"><a href="#cb53-53" aria-hidden="true" tabindex="-1"></a>There's an R package named <span class="co">[</span><span class="ot">{mapsapi}</span><span class="co">](https://github.com/michaeldorman/mapsapi)</span> that makes it really easy to get data from the Google Maps API, and if you get an API key from Google (<span class="co">[</span><span class="ot">following these instructions</span><span class="co">](https://developers.google.com/maps/documentation/directions/start#create-project)</span>), you can extract geocoded {sf}-compatible route data from Google with the <span class="in">`mp_directions()`</span> function. It's neat and quick and easy, but it's expensive. When I first started playing with the maps API in R, I racked up \$0.50 in charges just with testing a bunch of routing options. The Google Maps API gives you \$200 in free credits every month and I was well below that amount, but it still was a little nervewracking to see that it was that expensive in just an hour of tinkering. Also, setting up the API key was fairly complicated (creating a Google Cloud project, setting up billing, enabling specific services, storing the API key securely on my computer, etc.), and I don't want to go through that hassle in the future.</span>
<span id="cb53-54"><a href="#cb53-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-55"><a href="#cb53-55" aria-hidden="true" tabindex="-1"></a><span class="al">![Google Maps API costs](img/google-maps-api-costs.png)</span></span>
<span id="cb53-56"><a href="#cb53-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-57"><a href="#cb53-57" aria-hidden="true" tabindex="-1"></a>I'm a fan of the <span class="co">[</span><span class="ot">OpenStreetMap project</span><span class="co">](https://www.openstreetmap.org/)</span>, and it's <span class="co">[</span><span class="ot">one of the backends</span><span class="co">](https://jessecambon.github.io/tidygeocoder/articles/geocoder_services.html)</span> (through <span class="co">[</span><span class="ot">Nominatim</span><span class="co">](https://nominatim.org/)</span>) for {tidygeocoder} (and I used it in a <span class="co">[</span><span class="ot">previous blog post</span><span class="co">](https://www.andrewheiss.com/blog/2023/04/26/middle-earth-mapping-sf-r-gis/#in-the-united-states)</span> showing some coordinates in interactive Leaflet maps). In searching around the internet for open source alternatives to the Google Maps API, I discovered that OpenStreetMap can also do directions and routing through the <span class="co">[</span><span class="ot">Open Source Routing Machine (OSRM) project</span><span class="co">](http://project-osrm.org/)</span>. You can use OSRM's <span class="co">[</span><span class="ot">public demo server</span><span class="co">](https://map.project-osrm.org)</span> for small-scale routing things, or you can <span class="co">[</span><span class="ot">install your own local instance through Docker</span><span class="co">](https://github.com/Project-OSRM/osrm-backend#using-docker)</span>. And super conveniently, there's also an R package called <span class="co">[</span><span class="ot">{osrm}</span><span class="co">](https://github.com/riatelab/osrm)</span> for accessing the OSRM API. This means that it's possible to pull geocoded routing and directions data into R in an open source (and free!) way.</span>
<span id="cb53-58"><a href="#cb53-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-59"><a href="#cb53-59" aria-hidden="true" tabindex="-1"></a>So let's see how to use {osrm} and make some neat road trip maps with {sf} and {ggplot2}!</span>
<span id="cb53-60"><a href="#cb53-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-61"><a href="#cb53-61" aria-hidden="true" tabindex="-1"></a><span class="fu"># Getting started</span></span>
<span id="cb53-62"><a href="#cb53-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-63"><a href="#cb53-63" aria-hidden="true" tabindex="-1"></a><span class="fu">## Who this post is for</span></span>
<span id="cb53-64"><a href="#cb53-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-65"><a href="#cb53-65" aria-hidden="true" tabindex="-1"></a>Here's what I assume you know:</span>
<span id="cb53-66"><a href="#cb53-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-67"><a href="#cb53-67" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>You're familiar with <span class="co">[</span><span class="ot">R</span><span class="co">](https://www.r-project.org/)</span> and the <span class="co">[</span><span class="ot">tidyverse</span><span class="co">](https://www.tidyverse.org/)</span> (particularly <span class="co">[</span><span class="ot">{dplyr}</span><span class="co">](https://dplyr.tidyverse.org/)</span> and <span class="co">[</span><span class="ot">{ggplot2}</span><span class="co">](https://ggplot2.tidyverse.org/)</span>).</span>
<span id="cb53-68"><a href="#cb53-68" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>You're somewhat familiar with <span class="co">[</span><span class="ot">{sf}</span><span class="co">](https://r-spatial.github.io/sf/)</span> for working with geographic data. I have a <span class="co">[</span><span class="ot">whole tutorial here</span><span class="co">](https://datavizs23.classes.andrewheiss.com/example/12-example.html)</span> and a <span class="co">[</span><span class="ot">simplified one here</span><span class="co">](https://www.andrewheiss.com/blog/2023/04/26/middle-earth-mapping-sf-r-gis/#lightning-quick-overview-of-sf-and-shapefiles)</span> and the <span class="co">[</span><span class="ot">{sf} documentation has a ton of helpful vignettes and blog posts</span><span class="co">](https://r-spatial.github.io/sf/)</span>, and there are also two free books about it: <span class="co">[</span><span class="ot">*Spatial Data Science*</span><span class="co">](https://r-spatial.org/book/)</span> and <span class="co">[</span><span class="ot">*Geocomputation with R*</span><span class="co">](https://r.geocompx.org/)</span>. Also <span class="co">[</span><span class="ot">check this fantastic post out</span><span class="co">](https://www.jessesadler.com/post/simple-feature-objects/)</span> to learn more about the anatomy of a <span class="in">`geometry`</span> column with {sf}.</span>
<span id="cb53-69"><a href="#cb53-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-70"><a href="#cb53-70" aria-hidden="true" tabindex="-1"></a><span class="fu">## Packages and functions</span></span>
<span id="cb53-71"><a href="#cb53-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-72"><a href="#cb53-72" aria-hidden="true" tabindex="-1"></a>Before officially getting started, let’s load all the packages we need and create some helpful functions and variables:</span>
<span id="cb53-73"><a href="#cb53-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-74"><a href="#cb53-74" aria-hidden="true" tabindex="-1"></a><span class="in">```{r libraries, warning=FALSE, message=FALSE}</span></span>
<span id="cb53-75"><a href="#cb53-75" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidyverse)     # ggplot, dplyr, and friends</span></span>
<span id="cb53-76"><a href="#cb53-76" aria-hidden="true" tabindex="-1"></a><span class="in">library(sf)            # Handle spatial data in R in a tidy way</span></span>
<span id="cb53-77"><a href="#cb53-77" aria-hidden="true" tabindex="-1"></a><span class="in">library(tigris)        # Access geographic data from the US Census</span></span>
<span id="cb53-78"><a href="#cb53-78" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidygeocoder)  # Automated geocoding</span></span>
<span id="cb53-79"><a href="#cb53-79" aria-hidden="true" tabindex="-1"></a><span class="in">library(osrm)          # Access OSRM through R</span></span>
<span id="cb53-80"><a href="#cb53-80" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggrepel)       # Nicer non-overlapping labels</span></span>
<span id="cb53-81"><a href="#cb53-81" aria-hidden="true" tabindex="-1"></a><span class="in">library(glue)          # Easier string interpolation</span></span>
<span id="cb53-82"><a href="#cb53-82" aria-hidden="true" tabindex="-1"></a><span class="in">library(scales)        # Nicer labeling functions</span></span>
<span id="cb53-83"><a href="#cb53-83" aria-hidden="true" tabindex="-1"></a><span class="in">library(patchwork)     # Combine plots nicely</span></span>
<span id="cb53-84"><a href="#cb53-84" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggspatial)     # Nicer map features like scale bars</span></span>
<span id="cb53-85"><a href="#cb53-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-86"><a href="#cb53-86" aria-hidden="true" tabindex="-1"></a><span class="in"># Custom ggplot theme to make pretty plots</span></span>
<span id="cb53-87"><a href="#cb53-87" aria-hidden="true" tabindex="-1"></a><span class="in"># Get the font at https://fonts.google.com/specimen/Overpass</span></span>
<span id="cb53-88"><a href="#cb53-88" aria-hidden="true" tabindex="-1"></a><span class="in">theme_roadtrip &lt;- function() {</span></span>
<span id="cb53-89"><a href="#cb53-89" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_void(base_family = "Overpass Light") +</span></span>
<span id="cb53-90"><a href="#cb53-90" aria-hidden="true" tabindex="-1"></a><span class="in">    theme(</span></span>
<span id="cb53-91"><a href="#cb53-91" aria-hidden="true" tabindex="-1"></a><span class="in">      plot.title = element_text(family = "Overpass", face = "bold", hjust = 0.5),</span></span>
<span id="cb53-92"><a href="#cb53-92" aria-hidden="true" tabindex="-1"></a><span class="in">      strip.text = element_text(</span></span>
<span id="cb53-93"><a href="#cb53-93" aria-hidden="true" tabindex="-1"></a><span class="in">        family = "Overpass ExtraBold", face = "plain",</span></span>
<span id="cb53-94"><a href="#cb53-94" aria-hidden="true" tabindex="-1"></a><span class="in">        size = rel(1.1), hjust = 0.5)</span></span>
<span id="cb53-95"><a href="#cb53-95" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb53-96"><a href="#cb53-96" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb53-97"><a href="#cb53-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-98"><a href="#cb53-98" aria-hidden="true" tabindex="-1"></a><span class="in"># Make labels use Overpass by default</span></span>
<span id="cb53-99"><a href="#cb53-99" aria-hidden="true" tabindex="-1"></a><span class="in">update_geom_defaults("label_repel", </span></span>
<span id="cb53-100"><a href="#cb53-100" aria-hidden="true" tabindex="-1"></a><span class="in">                     list(family = "Overpass",</span></span>
<span id="cb53-101"><a href="#cb53-101" aria-hidden="true" tabindex="-1"></a><span class="in">                          fontface = "plain"))</span></span>
<span id="cb53-102"><a href="#cb53-102" aria-hidden="true" tabindex="-1"></a><span class="in">update_geom_defaults("label", </span></span>
<span id="cb53-103"><a href="#cb53-103" aria-hidden="true" tabindex="-1"></a><span class="in">                     list(family = "Overpass",</span></span>
<span id="cb53-104"><a href="#cb53-104" aria-hidden="true" tabindex="-1"></a><span class="in">                          fontface = "plain"))</span></span>
<span id="cb53-105"><a href="#cb53-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-106"><a href="#cb53-106" aria-hidden="true" tabindex="-1"></a><span class="in">update_geom_defaults("text_repel", </span></span>
<span id="cb53-107"><a href="#cb53-107" aria-hidden="true" tabindex="-1"></a><span class="in">                     list(family = "Overpass",</span></span>
<span id="cb53-108"><a href="#cb53-108" aria-hidden="true" tabindex="-1"></a><span class="in">                          fontface = "plain"))</span></span>
<span id="cb53-109"><a href="#cb53-109" aria-hidden="true" tabindex="-1"></a><span class="in">update_geom_defaults("text", </span></span>
<span id="cb53-110"><a href="#cb53-110" aria-hidden="true" tabindex="-1"></a><span class="in">                     list(family = "Overpass",</span></span>
<span id="cb53-111"><a href="#cb53-111" aria-hidden="true" tabindex="-1"></a><span class="in">                          fontface = "plain"))</span></span>
<span id="cb53-112"><a href="#cb53-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-113"><a href="#cb53-113" aria-hidden="true" tabindex="-1"></a><span class="in"># Yellowstone colors</span></span>
<span id="cb53-114"><a href="#cb53-114" aria-hidden="true" tabindex="-1"></a><span class="in">clrs &lt;- NatParksPalettes::natparks.pals("Yellowstone")</span></span>
<span id="cb53-115"><a href="#cb53-115" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-116"><a href="#cb53-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-117"><a href="#cb53-117" aria-hidden="true" tabindex="-1"></a><span class="in">```{r helper-functions}</span></span>
<span id="cb53-118"><a href="#cb53-118" aria-hidden="true" tabindex="-1"></a><span class="in">#' Format duration in minutes and hours</span></span>
<span id="cb53-119"><a href="#cb53-119" aria-hidden="true" tabindex="-1"></a><span class="in">#'</span></span>
<span id="cb53-120"><a href="#cb53-120" aria-hidden="true" tabindex="-1"></a><span class="in">#' This function takes a numeric input \code{x} representing a duration in minutes,</span></span>
<span id="cb53-121"><a href="#cb53-121" aria-hidden="true" tabindex="-1"></a><span class="in">#' rounds it to the nearest 15 minutes, and formats the result as a string</span></span>
<span id="cb53-122"><a href="#cb53-122" aria-hidden="true" tabindex="-1"></a><span class="in">#' indicating the number of hours and minutes in the duration.</span></span>
<span id="cb53-123"><a href="#cb53-123" aria-hidden="true" tabindex="-1"></a><span class="in">#'</span></span>
<span id="cb53-124"><a href="#cb53-124" aria-hidden="true" tabindex="-1"></a><span class="in">#' @param x A numeric input representing a duration in minutes.</span></span>
<span id="cb53-125"><a href="#cb53-125" aria-hidden="true" tabindex="-1"></a><span class="in">#' @return A character vector of formatted duration strings.</span></span>
<span id="cb53-126"><a href="#cb53-126" aria-hidden="true" tabindex="-1"></a><span class="in">#' @examples</span></span>
<span id="cb53-127"><a href="#cb53-127" aria-hidden="true" tabindex="-1"></a><span class="in">#' fmt_duration(c(93, 1007, 3056))</span></span>
<span id="cb53-128"><a href="#cb53-128" aria-hidden="true" tabindex="-1"></a><span class="in">fmt_duration &lt;- function(x) {</span></span>
<span id="cb53-129"><a href="#cb53-129" aria-hidden="true" tabindex="-1"></a><span class="in">  # Round to the nearest 15 minutes</span></span>
<span id="cb53-130"><a href="#cb53-130" aria-hidden="true" tabindex="-1"></a><span class="in">  n_seconds &lt;- round(seconds(x * 60) / (15 * 60)) * (15 * 60)</span></span>
<span id="cb53-131"><a href="#cb53-131" aria-hidden="true" tabindex="-1"></a><span class="in">  n_seconds &lt;- seconds_to_period(n_seconds)</span></span>
<span id="cb53-132"><a href="#cb53-132" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb53-133"><a href="#cb53-133" aria-hidden="true" tabindex="-1"></a><span class="in">  out &lt;- map_chr(n_seconds, \(n) {</span></span>
<span id="cb53-134"><a href="#cb53-134" aria-hidden="true" tabindex="-1"></a><span class="in">    if (seconds(n) &lt;= 59) {</span></span>
<span id="cb53-135"><a href="#cb53-135" aria-hidden="true" tabindex="-1"></a><span class="in">      # If this is less than an hour, don't format anything with hours</span></span>
<span id="cb53-136"><a href="#cb53-136" aria-hidden="true" tabindex="-1"></a><span class="in">      glue("{MM} minutes", MM = minute(n))</span></span>
<span id="cb53-137"><a href="#cb53-137" aria-hidden="true" tabindex="-1"></a><span class="in">    } else {</span></span>
<span id="cb53-138"><a href="#cb53-138" aria-hidden="true" tabindex="-1"></a><span class="in">      # I only want to format this as a number of hours. If the duration is</span></span>
<span id="cb53-139"><a href="#cb53-139" aria-hidden="true" tabindex="-1"></a><span class="in">      # longer than 24 hours, seconds_to_period() rolls over into days (i.e.</span></span>
<span id="cb53-140"><a href="#cb53-140" aria-hidden="true" tabindex="-1"></a><span class="in">      # seconds_to_period(60 * 60 * 24) returns "1d 0H 0M 0S"), and it shows</span></span>
<span id="cb53-141"><a href="#cb53-141" aria-hidden="true" tabindex="-1"></a><span class="in">      # zero hours. So we extract the day part of the period, multiply it by 24,</span></span>
<span id="cb53-142"><a href="#cb53-142" aria-hidden="true" tabindex="-1"></a><span class="in">      # and add it to the hour component that we want to display</span></span>
<span id="cb53-143"><a href="#cb53-143" aria-hidden="true" tabindex="-1"></a><span class="in">      extra_day_hours &lt;- day(n) * 24</span></span>
<span id="cb53-144"><a href="#cb53-144" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb53-145"><a href="#cb53-145" aria-hidden="true" tabindex="-1"></a><span class="in">      glue("{HH} hour{s} {MM} minutes",</span></span>
<span id="cb53-146"><a href="#cb53-146" aria-hidden="true" tabindex="-1"></a><span class="in">        HH = scales::label_comma()(hour(n) + extra_day_hours),</span></span>
<span id="cb53-147"><a href="#cb53-147" aria-hidden="true" tabindex="-1"></a><span class="in">        MM = minute(n),</span></span>
<span id="cb53-148"><a href="#cb53-148" aria-hidden="true" tabindex="-1"></a><span class="in">        s = ifelse(hour(n) == 1, "", "s")</span></span>
<span id="cb53-149"><a href="#cb53-149" aria-hidden="true" tabindex="-1"></a><span class="in">      )</span></span>
<span id="cb53-150"><a href="#cb53-150" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb53-151"><a href="#cb53-151" aria-hidden="true" tabindex="-1"></a><span class="in">  })</span></span>
<span id="cb53-152"><a href="#cb53-152" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb53-153"><a href="#cb53-153" aria-hidden="true" tabindex="-1"></a><span class="in">  return(out)</span></span>
<span id="cb53-154"><a href="#cb53-154" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb53-155"><a href="#cb53-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-156"><a href="#cb53-156" aria-hidden="true" tabindex="-1"></a><span class="in">fmt_miles &lt;- scales::label_number(accuracy = 10, suffix = " miles", big.mark = ",")</span></span>
<span id="cb53-157"><a href="#cb53-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-158"><a href="#cb53-158" aria-hidden="true" tabindex="-1"></a><span class="in">miles_to_meters &lt;- function(x) {</span></span>
<span id="cb53-159"><a href="#cb53-159" aria-hidden="true" tabindex="-1"></a><span class="in">  x * 1609.344</span></span>
<span id="cb53-160"><a href="#cb53-160" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb53-161"><a href="#cb53-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-162"><a href="#cb53-162" aria-hidden="true" tabindex="-1"></a><span class="in">meters_to_miles &lt;- function(x) {</span></span>
<span id="cb53-163"><a href="#cb53-163" aria-hidden="true" tabindex="-1"></a><span class="in">  x / 1609.344</span></span>
<span id="cb53-164"><a href="#cb53-164" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb53-165"><a href="#cb53-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-166"><a href="#cb53-166" aria-hidden="true" tabindex="-1"></a><span class="in">km_to_miles &lt;- function(x) {</span></span>
<span id="cb53-167"><a href="#cb53-167" aria-hidden="true" tabindex="-1"></a><span class="in">  meters_to_miles(x * 1000)</span></span>
<span id="cb53-168"><a href="#cb53-168" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb53-169"><a href="#cb53-169" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-170"><a href="#cb53-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-171"><a href="#cb53-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-172"><a href="#cb53-172" aria-hidden="true" tabindex="-1"></a><span class="fu"># State data</span></span>
<span id="cb53-173"><a href="#cb53-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-174"><a href="#cb53-174" aria-hidden="true" tabindex="-1"></a>First we need state boundaries. We can get these from the US Census with <span class="in">`states()`</span> from {tigris}:</span>
<span id="cb53-175"><a href="#cb53-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-176"><a href="#cb53-176" aria-hidden="true" tabindex="-1"></a><span class="in">```{r get-us-states-fake, eval=FALSE}</span></span>
<span id="cb53-177"><a href="#cb53-177" aria-hidden="true" tabindex="-1"></a><span class="in">us_states &lt;- states(resolution = "20m", year = 2022, cb = TRUE)</span></span>
<span id="cb53-178"><a href="#cb53-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-179"><a href="#cb53-179" aria-hidden="true" tabindex="-1"></a><span class="in">lower_48 &lt;- us_states %&gt;% </span></span>
<span id="cb53-180"><a href="#cb53-180" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(!(NAME %in% c("Alaska", "Hawaii", "Puerto Rico")))</span></span>
<span id="cb53-181"><a href="#cb53-181" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-182"><a href="#cb53-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-183"><a href="#cb53-183" aria-hidden="true" tabindex="-1"></a><span class="in">```{r get-us-states-actual, include=FALSE}</span></span>
<span id="cb53-184"><a href="#cb53-184" aria-hidden="true" tabindex="-1"></a><span class="in">states_file &lt;- "states.rds"</span></span>
<span id="cb53-185"><a href="#cb53-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-186"><a href="#cb53-186" aria-hidden="true" tabindex="-1"></a><span class="in">if (file.exists(states_file)) {</span></span>
<span id="cb53-187"><a href="#cb53-187" aria-hidden="true" tabindex="-1"></a><span class="in">  us_states &lt;- readRDS(states_file)</span></span>
<span id="cb53-188"><a href="#cb53-188" aria-hidden="true" tabindex="-1"></a><span class="in">} else {</span></span>
<span id="cb53-189"><a href="#cb53-189" aria-hidden="true" tabindex="-1"></a><span class="in">  us_states &lt;- states(resolution = "20m", year = 2022, cb = TRUE)</span></span>
<span id="cb53-190"><a href="#cb53-190" aria-hidden="true" tabindex="-1"></a><span class="in">  saveRDS(us_states, states_file)</span></span>
<span id="cb53-191"><a href="#cb53-191" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb53-192"><a href="#cb53-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-193"><a href="#cb53-193" aria-hidden="true" tabindex="-1"></a><span class="in">lower_48 &lt;- us_states %&gt;% </span></span>
<span id="cb53-194"><a href="#cb53-194" aria-hidden="true" tabindex="-1"></a><span class="in">    filter(!(NAME %in% c("Alaska", "Hawaii", "Puerto Rico")))</span></span>
<span id="cb53-195"><a href="#cb53-195" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-196"><a href="#cb53-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-197"><a href="#cb53-197" aria-hidden="true" tabindex="-1"></a>Here's what they look like (using the <span class="co">[</span><span class="ot">Albers projection for the contiguous USA</span><span class="co">](https://epsg.io/102003)</span>): </span>
<span id="cb53-198"><a href="#cb53-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-199"><a href="#cb53-199" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-states-only}</span></span>
<span id="cb53-200"><a href="#cb53-200" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: "48 contiguous states"</span></span>
<span id="cb53-201"><a href="#cb53-201" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-alt: "48 contiguous states"</span></span>
<span id="cb53-202"><a href="#cb53-202" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot() + </span></span>
<span id="cb53-203"><a href="#cb53-203" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = lower_48) +</span></span>
<span id="cb53-204"><a href="#cb53-204" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_sf(crs = st_crs("ESRI:102003")) +  # Albers</span></span>
<span id="cb53-205"><a href="#cb53-205" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_roadtrip()</span></span>
<span id="cb53-206"><a href="#cb53-206" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-207"><a href="#cb53-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-208"><a href="#cb53-208" aria-hidden="true" tabindex="-1"></a>Super quick and easy.</span>
<span id="cb53-209"><a href="#cb53-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-210"><a href="#cb53-210" aria-hidden="true" tabindex="-1"></a><span class="fu"># Stops data</span></span>
<span id="cb53-211"><a href="#cb53-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-212"><a href="#cb53-212" aria-hidden="true" tabindex="-1"></a>Next we need to geocode and plot all the stops we'll be making on the trip. I'll stick them all in a data frame with columns indicating the direction (with a nod to Bilbo Baggins's <span class="co">[</span><span class="ot">"There and Back Again"</span><span class="co">]</span>(https://en.wikipedia.org/wiki/There_and_Back_Again_(disambiguation)) journey with the dwarves in *The Hobbit*) and the day of the leg of the trip:</span>
<span id="cb53-213"><a href="#cb53-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-214"><a href="#cb53-214" aria-hidden="true" tabindex="-1"></a><span class="in">```{r create-stops-raw}</span></span>
<span id="cb53-215"><a href="#cb53-215" aria-hidden="true" tabindex="-1"></a><span class="in">stops_raw &lt;- tribble(</span></span>
<span id="cb53-216"><a href="#cb53-216" aria-hidden="true" tabindex="-1"></a><span class="in">  ~direction,   ~day, ~city,</span></span>
<span id="cb53-217"><a href="#cb53-217" aria-hidden="true" tabindex="-1"></a><span class="in">  "There",      1,    "Atlanta, Georgia", </span></span>
<span id="cb53-218"><a href="#cb53-218" aria-hidden="true" tabindex="-1"></a><span class="in">  "There",      2,    "New Orleans, Louisiana", </span></span>
<span id="cb53-219"><a href="#cb53-219" aria-hidden="true" tabindex="-1"></a><span class="in">  "There",      3,    "San Antonio, Texas", </span></span>
<span id="cb53-220"><a href="#cb53-220" aria-hidden="true" tabindex="-1"></a><span class="in">  "There",      4,    "Carlsbad, New Mexico", </span></span>
<span id="cb53-221"><a href="#cb53-221" aria-hidden="true" tabindex="-1"></a><span class="in">  "There",      5,    "Grand Canyon NP, Arizona",</span></span>
<span id="cb53-222"><a href="#cb53-222" aria-hidden="true" tabindex="-1"></a><span class="in">  "There",      6,    "Grover, Utah",  </span></span>
<span id="cb53-223"><a href="#cb53-223" aria-hidden="true" tabindex="-1"></a><span class="in">  "Back again", 1,    "Spanish Fork, Utah", </span></span>
<span id="cb53-224"><a href="#cb53-224" aria-hidden="true" tabindex="-1"></a><span class="in">  "Back again", 1,    "Shelley, Idaho",  </span></span>
<span id="cb53-225"><a href="#cb53-225" aria-hidden="true" tabindex="-1"></a><span class="in">  "Back again", 2,    "Yellowstone NP, Wyoming",</span></span>
<span id="cb53-226"><a href="#cb53-226" aria-hidden="true" tabindex="-1"></a><span class="in">  "Back again", 2,    "Devil's Tower, Wyoming",  </span></span>
<span id="cb53-227"><a href="#cb53-227" aria-hidden="true" tabindex="-1"></a><span class="in">  "Back again", 3,    "Mount Rushmore, South Dakota", </span></span>
<span id="cb53-228"><a href="#cb53-228" aria-hidden="true" tabindex="-1"></a><span class="in">  "Back again", 4,    "Albert Lea, Minnesota", </span></span>
<span id="cb53-229"><a href="#cb53-229" aria-hidden="true" tabindex="-1"></a><span class="in">  "Back again", 5,    "Nauvoo, Illinois", </span></span>
<span id="cb53-230"><a href="#cb53-230" aria-hidden="true" tabindex="-1"></a><span class="in">  "Back again", 6,    "Atlanta, Georgia"</span></span>
<span id="cb53-231"><a href="#cb53-231" aria-hidden="true" tabindex="-1"></a><span class="in">)  %&gt;% </span></span>
<span id="cb53-232"><a href="#cb53-232" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(direction = fct_inorder(direction))</span></span>
<span id="cb53-233"><a href="#cb53-233" aria-hidden="true" tabindex="-1"></a><span class="in">stops_raw</span></span>
<span id="cb53-234"><a href="#cb53-234" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-235"><a href="#cb53-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-236"><a href="#cb53-236" aria-hidden="true" tabindex="-1"></a>I could go to Google Maps and right click on each of these places and copy the latitude/longitude coordinates, but that's not very reproducible and involves a lot of clicking around. We can do it programmatically with <span class="in">`geocode()`</span> from {tidygeocoder}, but first we need to help the API a little. With most of these places, OpenStreetMap will return the center of the city (like with Atlanta), and that's fine. With larger places like the Grand Canyon and Yellowstone, though, OpenStreetMap will give coordinates for the middle of the parks, which are literally in the middle of nowhere and will mess up our directions (since it's not really possible to drive to the middle of the whole Grand Canyon). To fix this we'll make a little dataset of some more specific addresses and join it to the list of stops. We'll geocode the more specific address column:</span>
<span id="cb53-237"><a href="#cb53-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-238"><a href="#cb53-238" aria-hidden="true" tabindex="-1"></a><span class="in">```{r create-addresses-raw}</span></span>
<span id="cb53-239"><a href="#cb53-239" aria-hidden="true" tabindex="-1"></a><span class="in">stops_addresses &lt;- tribble(</span></span>
<span id="cb53-240"><a href="#cb53-240" aria-hidden="true" tabindex="-1"></a><span class="in">  ~city, ~address,</span></span>
<span id="cb53-241"><a href="#cb53-241" aria-hidden="true" tabindex="-1"></a><span class="in">  "Grand Canyon NP, Arizona", "Grand Canyon Visitor Center, Arizona",</span></span>
<span id="cb53-242"><a href="#cb53-242" aria-hidden="true" tabindex="-1"></a><span class="in">  "Yellowstone NP, Wyoming", "Old Faithful, Teton County, Wyoming",</span></span>
<span id="cb53-243"><a href="#cb53-243" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb53-244"><a href="#cb53-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-245"><a href="#cb53-245" aria-hidden="true" tabindex="-1"></a><span class="in">stops_to_geocode &lt;- stops_raw %&gt;% </span></span>
<span id="cb53-246"><a href="#cb53-246" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(stops_addresses, by = join_by(city)) %&gt;% </span></span>
<span id="cb53-247"><a href="#cb53-247" aria-hidden="true" tabindex="-1"></a><span class="in">  # Combine the address and city columns, with a preference for address</span></span>
<span id="cb53-248"><a href="#cb53-248" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(address = coalesce(address, city))</span></span>
<span id="cb53-249"><a href="#cb53-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-250"><a href="#cb53-250" aria-hidden="true" tabindex="-1"></a><span class="in">stops_to_geocode</span></span>
<span id="cb53-251"><a href="#cb53-251" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-252"><a href="#cb53-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-253"><a href="#cb53-253" aria-hidden="true" tabindex="-1"></a>To get the coordinates, we'll feed the address column to <span class="in">`geocode()`</span> and then convert the resulting numeric <span class="in">`long`</span> and <span class="in">`lat`</span> into an official sf geometry column (with the <span class="co">[</span><span class="ot">WGS 84 (−180 to 180) scale</span><span class="co">](https://en.wikipedia.org/wiki/World_Geodetic_System)</span>):</span>
<span id="cb53-254"><a href="#cb53-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-255"><a href="#cb53-255" aria-hidden="true" tabindex="-1"></a><span class="in">```{r geocode-stops-fake, eval=FALSE}</span></span>
<span id="cb53-256"><a href="#cb53-256" aria-hidden="true" tabindex="-1"></a><span class="in">stops_geocoded &lt;- stops_to_geocode %&gt;% </span></span>
<span id="cb53-257"><a href="#cb53-257" aria-hidden="true" tabindex="-1"></a><span class="in">  geocode(address, method = "osm") %&gt;%</span></span>
<span id="cb53-258"><a href="#cb53-258" aria-hidden="true" tabindex="-1"></a><span class="in">  st_as_sf(coords = c("long", "lat"), crs = st_crs("EPSG:4326"))</span></span>
<span id="cb53-259"><a href="#cb53-259" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-260"><a href="#cb53-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-261"><a href="#cb53-261" aria-hidden="true" tabindex="-1"></a><span class="in">```{r geocode-stops-actual, include=FALSE}</span></span>
<span id="cb53-262"><a href="#cb53-262" aria-hidden="true" tabindex="-1"></a><span class="in">stops_file &lt;- "stops_geocoded.rds"</span></span>
<span id="cb53-263"><a href="#cb53-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-264"><a href="#cb53-264" aria-hidden="true" tabindex="-1"></a><span class="in">if (file.exists(stops_file)) {</span></span>
<span id="cb53-265"><a href="#cb53-265" aria-hidden="true" tabindex="-1"></a><span class="in">  stops_geocoded &lt;- readRDS(stops_file)</span></span>
<span id="cb53-266"><a href="#cb53-266" aria-hidden="true" tabindex="-1"></a><span class="in">} else {</span></span>
<span id="cb53-267"><a href="#cb53-267" aria-hidden="true" tabindex="-1"></a><span class="in">  stops_geocoded &lt;- stops_to_geocode %&gt;% </span></span>
<span id="cb53-268"><a href="#cb53-268" aria-hidden="true" tabindex="-1"></a><span class="in">    geocode(address, method = "osm") %&gt;%</span></span>
<span id="cb53-269"><a href="#cb53-269" aria-hidden="true" tabindex="-1"></a><span class="in">    st_as_sf(coords = c("long", "lat"), crs = st_crs("EPSG:4326"))</span></span>
<span id="cb53-270"><a href="#cb53-270" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb53-271"><a href="#cb53-271" aria-hidden="true" tabindex="-1"></a><span class="in">  saveRDS(stops_geocoded, stops_file)</span></span>
<span id="cb53-272"><a href="#cb53-272" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb53-273"><a href="#cb53-273" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-274"><a href="#cb53-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-275"><a href="#cb53-275" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-stops-geocoded}</span></span>
<span id="cb53-276"><a href="#cb53-276" aria-hidden="true" tabindex="-1"></a><span class="in">stops_geocoded</span></span>
<span id="cb53-277"><a href="#cb53-277" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-278"><a href="#cb53-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-279"><a href="#cb53-279" aria-hidden="true" tabindex="-1"></a>Atlanta is in there twice, so we'll need to drop the last row so that we don't plot the points and labels for it twice:</span>
<span id="cb53-280"><a href="#cb53-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-281"><a href="#cb53-281" aria-hidden="true" tabindex="-1"></a><span class="in">```{r create-unique-stops}</span></span>
<span id="cb53-282"><a href="#cb53-282" aria-hidden="true" tabindex="-1"></a><span class="in">all_stops_unique &lt;- stops_geocoded %&gt;% </span></span>
<span id="cb53-283"><a href="#cb53-283" aria-hidden="true" tabindex="-1"></a><span class="in">  slice(1:(n() - 1))</span></span>
<span id="cb53-284"><a href="#cb53-284" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-285"><a href="#cb53-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-286"><a href="#cb53-286" aria-hidden="true" tabindex="-1"></a>And let's plot it all:</span>
<span id="cb53-287"><a href="#cb53-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-288"><a href="#cb53-288" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-stops-only}</span></span>
<span id="cb53-289"><a href="#cb53-289" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: All the main stops for our road trip</span></span>
<span id="cb53-290"><a href="#cb53-290" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-alt: All the main stops for our road trip</span></span>
<span id="cb53-291"><a href="#cb53-291" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot() +</span></span>
<span id="cb53-292"><a href="#cb53-292" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = lower_48) +</span></span>
<span id="cb53-293"><a href="#cb53-293" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = all_stops_unique) +</span></span>
<span id="cb53-294"><a href="#cb53-294" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_label_repel(</span></span>
<span id="cb53-295"><a href="#cb53-295" aria-hidden="true" tabindex="-1"></a><span class="in">    data = all_stops_unique,</span></span>
<span id="cb53-296"><a href="#cb53-296" aria-hidden="true" tabindex="-1"></a><span class="in">    aes(label = city, geometry = geometry),</span></span>
<span id="cb53-297"><a href="#cb53-297" aria-hidden="true" tabindex="-1"></a><span class="in">    stat = "sf_coordinates", seed = 1234,</span></span>
<span id="cb53-298"><a href="#cb53-298" aria-hidden="true" tabindex="-1"></a><span class="in">    size = 3, segment.color = clrs[3], min.segment.length = 0</span></span>
<span id="cb53-299"><a href="#cb53-299" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb53-300"><a href="#cb53-300" aria-hidden="true" tabindex="-1"></a><span class="in">  annotation_scale(</span></span>
<span id="cb53-301"><a href="#cb53-301" aria-hidden="true" tabindex="-1"></a><span class="in">    location = "bl", bar_cols = c("grey30", "white"),</span></span>
<span id="cb53-302"><a href="#cb53-302" aria-hidden="true" tabindex="-1"></a><span class="in">    unit_category = "imperial", text_family = "Overpass"</span></span>
<span id="cb53-303"><a href="#cb53-303" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb53-304"><a href="#cb53-304" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_sf(crs = st_crs("ESRI:102003")) +  # Albers</span></span>
<span id="cb53-305"><a href="#cb53-305" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_roadtrip()</span></span>
<span id="cb53-306"><a href="#cb53-306" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-307"><a href="#cb53-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-308"><a href="#cb53-308" aria-hidden="true" tabindex="-1"></a><span class="fu"># Routing</span></span>
<span id="cb53-309"><a href="#cb53-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-310"><a href="#cb53-310" aria-hidden="true" tabindex="-1"></a>Next we need to figure out the routes between each of these points. The <span class="in">`osrmRoute()`</span> function in {osrm} takes two main arguments: (1) coordinates for the source location (<span class="in">`src`</span>) and (2) coordinates for the destination location (<span class="in">`dst`</span>). To make it easy to work with routing data in a dataframe, we need to manipulate the data a bit so that we get a row per route, with columns for the origin and destination cities.</span>
<span id="cb53-311"><a href="#cb53-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-312"><a href="#cb53-312" aria-hidden="true" tabindex="-1"></a>We'll create a copy of the geometry column in <span class="in">`stops_geocoded`</span> and shift it forward one row with <span class="in">`lead()`</span> and drop the last row because it doesn't have a destination:</span>
<span id="cb53-313"><a href="#cb53-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-314"><a href="#cb53-314" aria-hidden="true" tabindex="-1"></a><span class="in">```{r create-routes-raw}</span></span>
<span id="cb53-315"><a href="#cb53-315" aria-hidden="true" tabindex="-1"></a><span class="in">routes_raw &lt;- stops_geocoded %&gt;% </span></span>
<span id="cb53-316"><a href="#cb53-316" aria-hidden="true" tabindex="-1"></a><span class="in">  select(-address) %&gt;% </span></span>
<span id="cb53-317"><a href="#cb53-317" aria-hidden="true" tabindex="-1"></a><span class="in">  rename(</span></span>
<span id="cb53-318"><a href="#cb53-318" aria-hidden="true" tabindex="-1"></a><span class="in">    origin_geometry = geometry,</span></span>
<span id="cb53-319"><a href="#cb53-319" aria-hidden="true" tabindex="-1"></a><span class="in">    origin_city = city</span></span>
<span id="cb53-320"><a href="#cb53-320" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;% </span></span>
<span id="cb53-321"><a href="#cb53-321" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb53-322"><a href="#cb53-322" aria-hidden="true" tabindex="-1"></a><span class="in">    destination_geometry = lead(origin_geometry),</span></span>
<span id="cb53-323"><a href="#cb53-323" aria-hidden="true" tabindex="-1"></a><span class="in">    destination_city = lead(origin_city)</span></span>
<span id="cb53-324"><a href="#cb53-324" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;% </span></span>
<span id="cb53-325"><a href="#cb53-325" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(row_number() != n())</span></span>
<span id="cb53-326"><a href="#cb53-326" aria-hidden="true" tabindex="-1"></a><span class="in">routes_raw</span></span>
<span id="cb53-327"><a href="#cb53-327" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-328"><a href="#cb53-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-329"><a href="#cb53-329" aria-hidden="true" tabindex="-1"></a>With the data like this, we can now feed each row individually to <span class="in">`osrmRoute`</span> and get geocoded paths between each origin and destination:</span>
<span id="cb53-330"><a href="#cb53-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-331"><a href="#cb53-331" aria-hidden="true" tabindex="-1"></a><span class="in">```{r geocode-routes-fake, eval=FALSE}</span></span>
<span id="cb53-332"><a href="#cb53-332" aria-hidden="true" tabindex="-1"></a><span class="in">routes_geocoded_raw &lt;- routes_raw %&gt;% </span></span>
<span id="cb53-333"><a href="#cb53-333" aria-hidden="true" tabindex="-1"></a><span class="in">  rowwise() %&gt;% </span></span>
<span id="cb53-334"><a href="#cb53-334" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(route = osrmRoute(</span></span>
<span id="cb53-335"><a href="#cb53-335" aria-hidden="true" tabindex="-1"></a><span class="in">    src = origin_geometry, </span></span>
<span id="cb53-336"><a href="#cb53-336" aria-hidden="true" tabindex="-1"></a><span class="in">    dst = destination_geometry)</span></span>
<span id="cb53-337"><a href="#cb53-337" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb53-338"><a href="#cb53-338" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-339"><a href="#cb53-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-340"><a href="#cb53-340" aria-hidden="true" tabindex="-1"></a><span class="in">```{r geocode-routes-actual, include=FALSE}</span></span>
<span id="cb53-341"><a href="#cb53-341" aria-hidden="true" tabindex="-1"></a><span class="in">routes_file &lt;- "routes_geocoded.rds"</span></span>
<span id="cb53-342"><a href="#cb53-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-343"><a href="#cb53-343" aria-hidden="true" tabindex="-1"></a><span class="in">if (file.exists(routes_file)) {</span></span>
<span id="cb53-344"><a href="#cb53-344" aria-hidden="true" tabindex="-1"></a><span class="in">  routes_geocoded_raw &lt;- readRDS(routes_file)</span></span>
<span id="cb53-345"><a href="#cb53-345" aria-hidden="true" tabindex="-1"></a><span class="in">} else {</span></span>
<span id="cb53-346"><a href="#cb53-346" aria-hidden="true" tabindex="-1"></a><span class="in">  routes_geocoded_raw &lt;- routes_raw %&gt;% </span></span>
<span id="cb53-347"><a href="#cb53-347" aria-hidden="true" tabindex="-1"></a><span class="in">  rowwise() %&gt;% </span></span>
<span id="cb53-348"><a href="#cb53-348" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(route = osrmRoute(</span></span>
<span id="cb53-349"><a href="#cb53-349" aria-hidden="true" tabindex="-1"></a><span class="in">    src = origin_geometry, </span></span>
<span id="cb53-350"><a href="#cb53-350" aria-hidden="true" tabindex="-1"></a><span class="in">    dst = destination_geometry)</span></span>
<span id="cb53-351"><a href="#cb53-351" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb53-352"><a href="#cb53-352" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb53-353"><a href="#cb53-353" aria-hidden="true" tabindex="-1"></a><span class="in">  saveRDS(routes_geocoded_raw, routes_file)</span></span>
<span id="cb53-354"><a href="#cb53-354" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb53-355"><a href="#cb53-355" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-356"><a href="#cb53-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-357"><a href="#cb53-357" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-routes-geocoded-raw}</span></span>
<span id="cb53-358"><a href="#cb53-358" aria-hidden="true" tabindex="-1"></a><span class="in">routes_geocoded_raw</span></span>
<span id="cb53-359"><a href="#cb53-359" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-360"><a href="#cb53-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-361"><a href="#cb53-361" aria-hidden="true" tabindex="-1"></a>The route details are included in a <span class="co">[</span><span class="ot">nested data frame list column</span><span class="co">](https://tidyr.tidyverse.org/articles/nest.html)</span> named <span class="in">`route`</span>, so we'll need to unnest it. The resulting data frame now has three different geometry columns (!) for the origin point, destination point, and the route, so we'll set the route column as the data frame's primary geometry column (which makes it so we can just use <span class="in">`geom_sf(data = routes_geocoded)`</span> instead of <span class="in">`geom_sf(data = routes_geocoded, aes(geometry = whatever))`</span>). The route data also includes some helpful details about the distance (in kilometers) and duration (in minutes), so we'll create nicely formatted text-based versions of these too:</span>
<span id="cb53-362"><a href="#cb53-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-363"><a href="#cb53-363" aria-hidden="true" tabindex="-1"></a><span class="in">```{r unnest-clean-routes-geocoded}</span></span>
<span id="cb53-364"><a href="#cb53-364" aria-hidden="true" tabindex="-1"></a><span class="in">routes_geocoded &lt;- routes_geocoded_raw %&gt;% </span></span>
<span id="cb53-365"><a href="#cb53-365" aria-hidden="true" tabindex="-1"></a><span class="in">  unnest(route, names_sep = "_") %&gt;% </span></span>
<span id="cb53-366"><a href="#cb53-366" aria-hidden="true" tabindex="-1"></a><span class="in">  st_set_geometry("route_geometry") %&gt;% </span></span>
<span id="cb53-367"><a href="#cb53-367" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb53-368"><a href="#cb53-368" aria-hidden="true" tabindex="-1"></a><span class="in">    distance_miles = km_to_miles(route_distance),</span></span>
<span id="cb53-369"><a href="#cb53-369" aria-hidden="true" tabindex="-1"></a><span class="in">    distance_text = fmt_miles(distance_miles),</span></span>
<span id="cb53-370"><a href="#cb53-370" aria-hidden="true" tabindex="-1"></a><span class="in">    duration_text = fmt_duration(route_duration)</span></span>
<span id="cb53-371"><a href="#cb53-371" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb53-372"><a href="#cb53-372" aria-hidden="true" tabindex="-1"></a><span class="in">routes_geocoded</span></span>
<span id="cb53-373"><a href="#cb53-373" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-374"><a href="#cb53-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-375"><a href="#cb53-375" aria-hidden="true" tabindex="-1"></a>Let's see how this looks! Because we set the default geometry of <span class="in">`routes_geocoded`</span> to the route, <span class="in">`geom_sf(data = routes_geocoded)`</span> will automatically plot the <span class="in">`LINESTRING`</span> geometries for the routes as paths:</span>
<span id="cb53-376"><a href="#cb53-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-377"><a href="#cb53-377" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-routes-stops}</span></span>
<span id="cb53-378"><a href="#cb53-378" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: Automatically geocoded routes between all our road trip stops</span></span>
<span id="cb53-379"><a href="#cb53-379" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-alt: Automatically geocoded routes between all our road trip stops</span></span>
<span id="cb53-380"><a href="#cb53-380" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot() +</span></span>
<span id="cb53-381"><a href="#cb53-381" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = lower_48) +</span></span>
<span id="cb53-382"><a href="#cb53-382" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = routes_geocoded, color = clrs[1]) +</span></span>
<span id="cb53-383"><a href="#cb53-383" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = all_stops_unique) +</span></span>
<span id="cb53-384"><a href="#cb53-384" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_label_repel(</span></span>
<span id="cb53-385"><a href="#cb53-385" aria-hidden="true" tabindex="-1"></a><span class="in">    data = all_stops_unique,</span></span>
<span id="cb53-386"><a href="#cb53-386" aria-hidden="true" tabindex="-1"></a><span class="in">    aes(label = city, geometry = geometry),</span></span>
<span id="cb53-387"><a href="#cb53-387" aria-hidden="true" tabindex="-1"></a><span class="in">    stat = "sf_coordinates", seed = 1234,</span></span>
<span id="cb53-388"><a href="#cb53-388" aria-hidden="true" tabindex="-1"></a><span class="in">    size = 3, segment.color = clrs[3], min.segment.length = 0</span></span>
<span id="cb53-389"><a href="#cb53-389" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb53-390"><a href="#cb53-390" aria-hidden="true" tabindex="-1"></a><span class="in">  annotation_scale(</span></span>
<span id="cb53-391"><a href="#cb53-391" aria-hidden="true" tabindex="-1"></a><span class="in">    location = "bl", bar_cols = c("grey30", "white"),</span></span>
<span id="cb53-392"><a href="#cb53-392" aria-hidden="true" tabindex="-1"></a><span class="in">    unit_category = "imperial", text_family = "Overpass"</span></span>
<span id="cb53-393"><a href="#cb53-393" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb53-394"><a href="#cb53-394" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_sf(crs = st_crs("ESRI:102003")) +  # Albers</span></span>
<span id="cb53-395"><a href="#cb53-395" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_roadtrip()</span></span>
<span id="cb53-396"><a href="#cb53-396" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-397"><a href="#cb53-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-398"><a href="#cb53-398" aria-hidden="true" tabindex="-1"></a>AHH that's so cool! It works!</span>
<span id="cb53-399"><a href="#cb53-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-400"><a href="#cb53-400" aria-hidden="true" tabindex="-1"></a>We're not done yet though—let's make this even fancier!</span>
<span id="cb53-401"><a href="#cb53-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-402"><a href="#cb53-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-403"><a href="#cb53-403" aria-hidden="true" tabindex="-1"></a><span class="fu"># States crossed through</span></span>
<span id="cb53-404"><a href="#cb53-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-405"><a href="#cb53-405" aria-hidden="true" tabindex="-1"></a>We're going to be driving through a lot of states. Let's highlight each of the states we'll cross through to see how many there are. To do this we can use <span class="in">`st_intersection()`</span> to find which of the <span class="in">`lower_48`</span> states contain a part of the different routes. We'll then make a copy of <span class="in">`lower_48`</span> with a new column indicating if we'll visit the state:</span>
<span id="cb53-406"><a href="#cb53-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-407"><a href="#cb53-407" aria-hidden="true" tabindex="-1"></a><span class="in">```{r create-states-crossed-through, warning=FALSE}</span></span>
<span id="cb53-408"><a href="#cb53-408" aria-hidden="true" tabindex="-1"></a><span class="in">states_crossed_through &lt;- st_intersection(</span></span>
<span id="cb53-409"><a href="#cb53-409" aria-hidden="true" tabindex="-1"></a><span class="in">  st_transform(lower_48, st_crs(routes_geocoded)),</span></span>
<span id="cb53-410"><a href="#cb53-410" aria-hidden="true" tabindex="-1"></a><span class="in">  routes_geocoded</span></span>
<span id="cb53-411"><a href="#cb53-411" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb53-412"><a href="#cb53-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-413"><a href="#cb53-413" aria-hidden="true" tabindex="-1"></a><span class="in"># There are 32 rows here, but 18 unique states (i.e. one day will end in a state</span></span>
<span id="cb53-414"><a href="#cb53-414" aria-hidden="true" tabindex="-1"></a><span class="in"># and start the next day in the same state, so it gets counted twice)</span></span>
<span id="cb53-415"><a href="#cb53-415" aria-hidden="true" tabindex="-1"></a><span class="in">states_crossed_through %&gt;% </span></span>
<span id="cb53-416"><a href="#cb53-416" aria-hidden="true" tabindex="-1"></a><span class="in">  select(STATEFP, NAME, direction, day)</span></span>
<span id="cb53-417"><a href="#cb53-417" aria-hidden="true" tabindex="-1"></a><span class="in">unique(states_crossed_through$NAME)</span></span>
<span id="cb53-418"><a href="#cb53-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-419"><a href="#cb53-419" aria-hidden="true" tabindex="-1"></a><span class="in"># Create a column that flags if the state is cross through</span></span>
<span id="cb53-420"><a href="#cb53-420" aria-hidden="true" tabindex="-1"></a><span class="in">lower_48_highlighted &lt;- lower_48 %&gt;% </span></span>
<span id="cb53-421"><a href="#cb53-421" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(visited = NAME %in% unique(states_crossed_through$NAME))</span></span>
<span id="cb53-422"><a href="#cb53-422" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-423"><a href="#cb53-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-424"><a href="#cb53-424" aria-hidden="true" tabindex="-1"></a>Now we can fill using the <span class="in">`visited`</span> column and make the visited states subtly darker:</span>
<span id="cb53-425"><a href="#cb53-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-426"><a href="#cb53-426" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-routes-stops-highlighted}</span></span>
<span id="cb53-427"><a href="#cb53-427" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: Map of road trip route with crossed-through states highlighted</span></span>
<span id="cb53-428"><a href="#cb53-428" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-alt: Map of road trip route with crossed-through states highlighted</span></span>
<span id="cb53-429"><a href="#cb53-429" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot() +</span></span>
<span id="cb53-430"><a href="#cb53-430" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = lower_48_highlighted, aes(fill = visited)) +</span></span>
<span id="cb53-431"><a href="#cb53-431" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = routes_geocoded, color = clrs[1]) +</span></span>
<span id="cb53-432"><a href="#cb53-432" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = all_stops_unique) +</span></span>
<span id="cb53-433"><a href="#cb53-433" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_label_repel(</span></span>
<span id="cb53-434"><a href="#cb53-434" aria-hidden="true" tabindex="-1"></a><span class="in">    data = all_stops_unique,</span></span>
<span id="cb53-435"><a href="#cb53-435" aria-hidden="true" tabindex="-1"></a><span class="in">    aes(label = city, geometry = geometry),</span></span>
<span id="cb53-436"><a href="#cb53-436" aria-hidden="true" tabindex="-1"></a><span class="in">    stat = "sf_coordinates", seed = 1234,</span></span>
<span id="cb53-437"><a href="#cb53-437" aria-hidden="true" tabindex="-1"></a><span class="in">    size = 3, segment.color = clrs[3], min.segment.length = 0</span></span>
<span id="cb53-438"><a href="#cb53-438" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb53-439"><a href="#cb53-439" aria-hidden="true" tabindex="-1"></a><span class="in">  annotation_scale(</span></span>
<span id="cb53-440"><a href="#cb53-440" aria-hidden="true" tabindex="-1"></a><span class="in">    location = "bl", bar_cols = c("grey30", "white"),</span></span>
<span id="cb53-441"><a href="#cb53-441" aria-hidden="true" tabindex="-1"></a><span class="in">    unit_category = "imperial", text_family = "Overpass"</span></span>
<span id="cb53-442"><a href="#cb53-442" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb53-443"><a href="#cb53-443" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_manual(values = c("grey90", "grey80"), guide = "none") +</span></span>
<span id="cb53-444"><a href="#cb53-444" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_sf(crs = st_crs("ESRI:102003")) +  # Albers</span></span>
<span id="cb53-445"><a href="#cb53-445" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_roadtrip()</span></span>
<span id="cb53-446"><a href="#cb53-446" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-447"><a href="#cb53-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-448"><a href="#cb53-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-449"><a href="#cb53-449" aria-hidden="true" tabindex="-1"></a><span class="fu"># Summary statistics</span></span>
<span id="cb53-450"><a href="#cb53-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-451"><a href="#cb53-451" aria-hidden="true" tabindex="-1"></a>Now that we have a list of the states we'll cross through, let's play with some quick summary statistics.</span>
<span id="cb53-452"><a href="#cb53-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-453"><a href="#cb53-453" aria-hidden="true" tabindex="-1"></a><span class="in">```{r create-summary-stats}</span></span>
<span id="cb53-454"><a href="#cb53-454" aria-hidden="true" tabindex="-1"></a><span class="in">n_states &lt;- length(unique(states_crossed_through$NAME))</span></span>
<span id="cb53-455"><a href="#cb53-455" aria-hidden="true" tabindex="-1"></a><span class="in">n_states</span></span>
<span id="cb53-456"><a href="#cb53-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-457"><a href="#cb53-457" aria-hidden="true" tabindex="-1"></a><span class="in">total_distance &lt;- sum(routes_geocoded$route_distance) %&gt;% km_to_miles() %&gt;% fmt_miles()</span></span>
<span id="cb53-458"><a href="#cb53-458" aria-hidden="true" tabindex="-1"></a><span class="in">total_distance</span></span>
<span id="cb53-459"><a href="#cb53-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-460"><a href="#cb53-460" aria-hidden="true" tabindex="-1"></a><span class="in">total_time &lt;- sum(routes_geocoded$route_duration) %&gt;% fmt_duration()</span></span>
<span id="cb53-461"><a href="#cb53-461" aria-hidden="true" tabindex="-1"></a><span class="in">total_time</span></span>
<span id="cb53-462"><a href="#cb53-462" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-463"><a href="#cb53-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-464"><a href="#cb53-464" aria-hidden="true" tabindex="-1"></a>**We're going to drive through `r n_states` states, with a total distance of `r total_distance` over the span of `r total_time` (!!)**</span>
<span id="cb53-465"><a href="#cb53-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-466"><a href="#cb53-466" aria-hidden="true" tabindex="-1"></a>We can use these distance or duration columns to add some extra detail to the map:</span>
<span id="cb53-467"><a href="#cb53-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-468"><a href="#cb53-468" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-routes-stops-distances}</span></span>
<span id="cb53-469"><a href="#cb53-469" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: "Map of road trip showing the distances between each stop"</span></span>
<span id="cb53-470"><a href="#cb53-470" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-alt: "Map of road trip showing the distances between each stop"</span></span>
<span id="cb53-471"><a href="#cb53-471" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot() +</span></span>
<span id="cb53-472"><a href="#cb53-472" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = lower_48_highlighted, aes(fill = visited)) +</span></span>
<span id="cb53-473"><a href="#cb53-473" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = routes_geocoded, color = clrs[1]) +</span></span>
<span id="cb53-474"><a href="#cb53-474" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = all_stops_unique) +</span></span>
<span id="cb53-475"><a href="#cb53-475" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_label_repel(</span></span>
<span id="cb53-476"><a href="#cb53-476" aria-hidden="true" tabindex="-1"></a><span class="in">    data = routes_geocoded,</span></span>
<span id="cb53-477"><a href="#cb53-477" aria-hidden="true" tabindex="-1"></a><span class="in">    aes(label = distance_text, geometry = route_geometry),</span></span>
<span id="cb53-478"><a href="#cb53-478" aria-hidden="true" tabindex="-1"></a><span class="in">    stat = "sf_coordinates", seed = 12345,</span></span>
<span id="cb53-479"><a href="#cb53-479" aria-hidden="true" tabindex="-1"></a><span class="in">    size = 3, segment.color = clrs[3], min.segment.length = 0,</span></span>
<span id="cb53-480"><a href="#cb53-480" aria-hidden="true" tabindex="-1"></a><span class="in">    fill = colorspace::lighten(clrs[5], 0.8)</span></span>
<span id="cb53-481"><a href="#cb53-481" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb53-482"><a href="#cb53-482" aria-hidden="true" tabindex="-1"></a><span class="in">  annotation_scale(</span></span>
<span id="cb53-483"><a href="#cb53-483" aria-hidden="true" tabindex="-1"></a><span class="in">    location = "bl", bar_cols = c("grey30", "white"),</span></span>
<span id="cb53-484"><a href="#cb53-484" aria-hidden="true" tabindex="-1"></a><span class="in">    unit_category = "imperial", text_family = "Overpass"</span></span>
<span id="cb53-485"><a href="#cb53-485" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb53-486"><a href="#cb53-486" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_manual(values = c("grey90", "grey80"), guide = "none") +</span></span>
<span id="cb53-487"><a href="#cb53-487" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_sf(crs = st_crs("ESRI:102003")) +  # Albers</span></span>
<span id="cb53-488"><a href="#cb53-488" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(title = glue("{n_states} states; {total_distance}; and {total_time} in the car. Bring it on.")) +</span></span>
<span id="cb53-489"><a href="#cb53-489" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_roadtrip()</span></span>
<span id="cb53-490"><a href="#cb53-490" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-491"><a href="#cb53-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-492"><a href="#cb53-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-493"><a href="#cb53-493" aria-hidden="true" tabindex="-1"></a><span class="fu"># Faceting</span></span>
<span id="cb53-494"><a href="#cb53-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-495"><a href="#cb53-495" aria-hidden="true" tabindex="-1"></a>We have some nice tidy data here with columns for direction and day, which makes it easy to subset the data. We can make separate maps for the drive there and the drive back, or even separate maps for each day of the trip. Let's add <span class="in">`facet_wrap()`</span> to the plot:</span>
<span id="cb53-496"><a href="#cb53-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-497"><a href="#cb53-497" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-facet-subset-issues, fig.width=7, fig.height=7}</span></span>
<span id="cb53-498"><a href="#cb53-498" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: "Road trip map faceted by direction"</span></span>
<span id="cb53-499"><a href="#cb53-499" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-alt: "Road trip map faceted by direction"</span></span>
<span id="cb53-500"><a href="#cb53-500" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot() +</span></span>
<span id="cb53-501"><a href="#cb53-501" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = lower_48_highlighted, aes(fill = visited)) +</span></span>
<span id="cb53-502"><a href="#cb53-502" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = routes_geocoded, color = clrs[1]) +</span></span>
<span id="cb53-503"><a href="#cb53-503" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = all_stops_unique) +</span></span>
<span id="cb53-504"><a href="#cb53-504" aria-hidden="true" tabindex="-1"></a><span class="in">  annotation_scale(</span></span>
<span id="cb53-505"><a href="#cb53-505" aria-hidden="true" tabindex="-1"></a><span class="in">    location = "bl", bar_cols = c("grey30", "white"),</span></span>
<span id="cb53-506"><a href="#cb53-506" aria-hidden="true" tabindex="-1"></a><span class="in">    unit_category = "imperial", text_family = "Overpass"</span></span>
<span id="cb53-507"><a href="#cb53-507" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb53-508"><a href="#cb53-508" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_manual(values = c("grey90", "grey80"), guide = "none") +</span></span>
<span id="cb53-509"><a href="#cb53-509" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_sf(crs = st_crs("ESRI:102003")) +  # Albers</span></span>
<span id="cb53-510"><a href="#cb53-510" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_roadtrip() +</span></span>
<span id="cb53-511"><a href="#cb53-511" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(vars(direction), ncol = 1)</span></span>
<span id="cb53-512"><a href="#cb53-512" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-513"><a href="#cb53-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-514"><a href="#cb53-514" aria-hidden="true" tabindex="-1"></a>There are two problems with this though:</span>
<span id="cb53-515"><a href="#cb53-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-516"><a href="#cb53-516" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>The highlighted states are the same in both facets</span>
<span id="cb53-517"><a href="#cb53-517" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>The final destination point is missing in each facet (Spanish Fork, Utah in the "There" facet; Atlanta, Georgia in the "Back Again" facet)</span>
<span id="cb53-518"><a href="#cb53-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-519"><a href="#cb53-519" aria-hidden="true" tabindex="-1"></a>Both of these issues are fixable though.</span>
<span id="cb53-520"><a href="#cb53-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-521"><a href="#cb53-521" aria-hidden="true" tabindex="-1"></a><span class="fu">## Fixing state highlighting</span></span>
<span id="cb53-522"><a href="#cb53-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-523"><a href="#cb53-523" aria-hidden="true" tabindex="-1"></a>First we need to change how we identify the states we'll cross through. Before, we kept the unique state names, but this stripped away the details about the direction of the trip, so we'll find all the distinct combinations of direction and state and then join that little dataset to <span class="in">`lower_48`</span> to make the <span class="in">`visited`</span> column:</span>
<span id="cb53-524"><a href="#cb53-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-525"><a href="#cb53-525" aria-hidden="true" tabindex="-1"></a><span class="in">```{r create-states-crossed-through-better, warning=FALSE}</span></span>
<span id="cb53-526"><a href="#cb53-526" aria-hidden="true" tabindex="-1"></a><span class="in">states_crossed_through_better &lt;- st_intersection(</span></span>
<span id="cb53-527"><a href="#cb53-527" aria-hidden="true" tabindex="-1"></a><span class="in">  st_transform(lower_48, st_crs(routes_geocoded)),</span></span>
<span id="cb53-528"><a href="#cb53-528" aria-hidden="true" tabindex="-1"></a><span class="in">  routes_geocoded</span></span>
<span id="cb53-529"><a href="#cb53-529" aria-hidden="true" tabindex="-1"></a><span class="in">) %&gt;% </span></span>
<span id="cb53-530"><a href="#cb53-530" aria-hidden="true" tabindex="-1"></a><span class="in">  distinct(direction, NAME)</span></span>
<span id="cb53-531"><a href="#cb53-531" aria-hidden="true" tabindex="-1"></a><span class="in">states_crossed_through_better</span></span>
<span id="cb53-532"><a href="#cb53-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-533"><a href="#cb53-533" aria-hidden="true" tabindex="-1"></a><span class="in">lower_48_highlighted_better &lt;- lower_48 %&gt;% </span></span>
<span id="cb53-534"><a href="#cb53-534" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(states_crossed_through_better, by = join_by(NAME)) %&gt;% </span></span>
<span id="cb53-535"><a href="#cb53-535" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(visited = !is.na(direction))</span></span>
<span id="cb53-536"><a href="#cb53-536" aria-hidden="true" tabindex="-1"></a><span class="in">as_tibble(lower_48_highlighted_better)</span></span>
<span id="cb53-537"><a href="#cb53-537" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-538"><a href="#cb53-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-539"><a href="#cb53-539" aria-hidden="true" tabindex="-1"></a>Let's see how it works by adding a new <span class="in">`geom_sf()`</span> layer for the highlighted states. We need to double up here with both <span class="in">`lower_48`</span> and <span class="in">`lower_48_highlighted_better`</span> because if we only plot the highlighted states, each facet will only contain those states and not the underlying US map, which we don't want.</span>
<span id="cb53-540"><a href="#cb53-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-541"><a href="#cb53-541" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-facet-subset-issues-fixed1, fig.width=7, fig.height=7}</span></span>
<span id="cb53-542"><a href="#cb53-542" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: Each facet now only shows the states corresponding to each direction</span></span>
<span id="cb53-543"><a href="#cb53-543" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-alt: Each facet now only shows the states corresponding to each direction</span></span>
<span id="cb53-544"><a href="#cb53-544" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot() +</span></span>
<span id="cb53-545"><a href="#cb53-545" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = lower_48) +</span></span>
<span id="cb53-546"><a href="#cb53-546" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = na.omit(lower_48_highlighted_better), aes(fill = visited)) +</span></span>
<span id="cb53-547"><a href="#cb53-547" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = routes_geocoded, color = clrs[1]) +</span></span>
<span id="cb53-548"><a href="#cb53-548" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = all_stops_unique) +</span></span>
<span id="cb53-549"><a href="#cb53-549" aria-hidden="true" tabindex="-1"></a><span class="in">  annotation_scale(</span></span>
<span id="cb53-550"><a href="#cb53-550" aria-hidden="true" tabindex="-1"></a><span class="in">    location = "bl", bar_cols = c("grey30", "white"),</span></span>
<span id="cb53-551"><a href="#cb53-551" aria-hidden="true" tabindex="-1"></a><span class="in">    unit_category = "imperial", text_family = "Overpass"</span></span>
<span id="cb53-552"><a href="#cb53-552" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb53-553"><a href="#cb53-553" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_manual(values = c("grey80"), guide = "none") +</span></span>
<span id="cb53-554"><a href="#cb53-554" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_sf(crs = st_crs("ESRI:102003")) +  # Albers</span></span>
<span id="cb53-555"><a href="#cb53-555" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_roadtrip() +</span></span>
<span id="cb53-556"><a href="#cb53-556" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(vars(direction), ncol = 1)</span></span>
<span id="cb53-557"><a href="#cb53-557" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-558"><a href="#cb53-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-559"><a href="#cb53-559" aria-hidden="true" tabindex="-1"></a>There, we fixed issue #1. <span class="in">`r emoji::emoji("check_mark_button")`</span></span>
<span id="cb53-560"><a href="#cb53-560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-561"><a href="#cb53-561" aria-hidden="true" tabindex="-1"></a>Issue #2—the missing endpoint in each facet—is a little trickier to deal with, but still doable. Before messing with the real data, let's look at a simpler toy example first. Here's a little dataset with three different "routes" between cities. The coordinates here aren't actually coordinates—they're just some arbitrary numbers. But that's okay—this basically mirrors what we have in <span class="in">`routes_geocoded`</span></span>
<span id="cb53-562"><a href="#cb53-562" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-563"><a href="#cb53-563" aria-hidden="true" tabindex="-1"></a><span class="fu">## Fixing missing destination cities</span></span>
<span id="cb53-564"><a href="#cb53-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-565"><a href="#cb53-565" aria-hidden="true" tabindex="-1"></a><span class="in">```{r create-example-data-pivot}</span></span>
<span id="cb53-566"><a href="#cb53-566" aria-hidden="true" tabindex="-1"></a><span class="in">example &lt;- tribble(</span></span>
<span id="cb53-567"><a href="#cb53-567" aria-hidden="true" tabindex="-1"></a><span class="in">  ~day, ~origin_city, ~destination_city, ~origin_coords, ~destination_coords,</span></span>
<span id="cb53-568"><a href="#cb53-568" aria-hidden="true" tabindex="-1"></a><span class="in">  1,    "Atlanta",    "Boston",          1234,           5678,</span></span>
<span id="cb53-569"><a href="#cb53-569" aria-hidden="true" tabindex="-1"></a><span class="in">  2,    "Boston",     "Chicago",         5678,           91011,</span></span>
<span id="cb53-570"><a href="#cb53-570" aria-hidden="true" tabindex="-1"></a><span class="in">  3,    "Chicago",    "Denver",          91011,          131415</span></span>
<span id="cb53-571"><a href="#cb53-571" aria-hidden="true" tabindex="-1"></a><span class="in">) </span></span>
<span id="cb53-572"><a href="#cb53-572" aria-hidden="true" tabindex="-1"></a><span class="in">example</span></span>
<span id="cb53-573"><a href="#cb53-573" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-574"><a href="#cb53-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-575"><a href="#cb53-575" aria-hidden="true" tabindex="-1"></a>The reason we're not getting the final point in each facet or subset is because there are only three rows here, but four cities. If we plotted the <span class="in">`origin_coords`</span> column, Atlanta would be missing; if we plotted the <span class="in">`destination_coords`</span> column, Denver would be missing. We need to manipulate this data so that it has 4 rows (Atlanta, Boston, Chicago, Denver), with the correct coordinates for each city. </span>
<span id="cb53-576"><a href="#cb53-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-577"><a href="#cb53-577" aria-hidden="true" tabindex="-1"></a>There's an easy way to do this with <span class="in">`pivot_longer()`</span> from {tidyr}. We can pivot with multiple columns that follow a pattern in their names. Here, all four of the columns we care about are are prefixed <span class="in">`destination`</span> or <span class="in">`origin`</span>, followed by a <span class="in">`_`</span>. If we specify these name settings in <span class="in">`pivot_longer()`</span>, it'll automatically create a column named <span class="in">`type`</span> for destination and origin and it'll put the rest of the data in corresponding columns:</span>
<span id="cb53-578"><a href="#cb53-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-579"><a href="#cb53-579" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-example-double-pivot}</span></span>
<span id="cb53-580"><a href="#cb53-580" aria-hidden="true" tabindex="-1"></a><span class="in">example %&gt;% </span></span>
<span id="cb53-581"><a href="#cb53-581" aria-hidden="true" tabindex="-1"></a><span class="in">  pivot_longer(</span></span>
<span id="cb53-582"><a href="#cb53-582" aria-hidden="true" tabindex="-1"></a><span class="in">    cols = c(origin_city, destination_city, origin_coords, destination_coords),</span></span>
<span id="cb53-583"><a href="#cb53-583" aria-hidden="true" tabindex="-1"></a><span class="in">    names_to = c("type", ".value"),</span></span>
<span id="cb53-584"><a href="#cb53-584" aria-hidden="true" tabindex="-1"></a><span class="in">    names_sep = "_"</span></span>
<span id="cb53-585"><a href="#cb53-585" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb53-586"><a href="#cb53-586" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-587"><a href="#cb53-587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-588"><a href="#cb53-588" aria-hidden="true" tabindex="-1"></a>Now we have one row per city, which is close to what we need. Boston and Chicago are duplicated (since they're both destination and origin cities), so we need to filter out duplicate cities. There are lots of ways to do this—my preferred way is to group by city and keep the first row in each group using <span class="in">`slice()`</span>:</span>
<span id="cb53-589"><a href="#cb53-589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-590"><a href="#cb53-590" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-example-double-pivot-filter}</span></span>
<span id="cb53-591"><a href="#cb53-591" aria-hidden="true" tabindex="-1"></a><span class="in">example %&gt;% </span></span>
<span id="cb53-592"><a href="#cb53-592" aria-hidden="true" tabindex="-1"></a><span class="in">  pivot_longer(</span></span>
<span id="cb53-593"><a href="#cb53-593" aria-hidden="true" tabindex="-1"></a><span class="in">    cols = c(origin_city, destination_city, origin_coords, destination_coords),</span></span>
<span id="cb53-594"><a href="#cb53-594" aria-hidden="true" tabindex="-1"></a><span class="in">    names_to = c("type", ".value"),</span></span>
<span id="cb53-595"><a href="#cb53-595" aria-hidden="true" tabindex="-1"></a><span class="in">    names_sep = "_"</span></span>
<span id="cb53-596"><a href="#cb53-596" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;% </span></span>
<span id="cb53-597"><a href="#cb53-597" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(city) %&gt;% </span></span>
<span id="cb53-598"><a href="#cb53-598" aria-hidden="true" tabindex="-1"></a><span class="in">  slice(1)</span></span>
<span id="cb53-599"><a href="#cb53-599" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-600"><a href="#cb53-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-601"><a href="#cb53-601" aria-hidden="true" tabindex="-1"></a>Woohoo! A dataset with four rows and the correct coordinates for each city. If we could plot this, we'd get both endpoints (Atlanta and Denver).</span>
<span id="cb53-602"><a href="#cb53-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-603"><a href="#cb53-603" aria-hidden="true" tabindex="-1"></a>This same double pivot approach (magically!!) works with the special geometry columns in our actual routes data:</span>
<span id="cb53-604"><a href="#cb53-604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-605"><a href="#cb53-605" aria-hidden="true" tabindex="-1"></a><span class="in">```{r create-stops-endpoints}</span></span>
<span id="cb53-606"><a href="#cb53-606" aria-hidden="true" tabindex="-1"></a><span class="in">all_stops_endpoints &lt;- routes_geocoded %&gt;% </span></span>
<span id="cb53-607"><a href="#cb53-607" aria-hidden="true" tabindex="-1"></a><span class="in">  pivot_longer(</span></span>
<span id="cb53-608"><a href="#cb53-608" aria-hidden="true" tabindex="-1"></a><span class="in">    cols = c(origin_city, destination_city, origin_geometry, destination_geometry),</span></span>
<span id="cb53-609"><a href="#cb53-609" aria-hidden="true" tabindex="-1"></a><span class="in">    names_to = c("type", ".value"),</span></span>
<span id="cb53-610"><a href="#cb53-610" aria-hidden="true" tabindex="-1"></a><span class="in">    names_sep = "_"</span></span>
<span id="cb53-611"><a href="#cb53-611" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;% </span></span>
<span id="cb53-612"><a href="#cb53-612" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(direction, city) %&gt;% </span></span>
<span id="cb53-613"><a href="#cb53-613" aria-hidden="true" tabindex="-1"></a><span class="in">  slice(1) %&gt;% </span></span>
<span id="cb53-614"><a href="#cb53-614" aria-hidden="true" tabindex="-1"></a><span class="in">  arrange(direction, day, desc(type)) %&gt;% </span></span>
<span id="cb53-615"><a href="#cb53-615" aria-hidden="true" tabindex="-1"></a><span class="in">  # Use "geometry" as the default geometry column instead of the routes</span></span>
<span id="cb53-616"><a href="#cb53-616" aria-hidden="true" tabindex="-1"></a><span class="in">  st_set_geometry("geometry")</span></span>
<span id="cb53-617"><a href="#cb53-617" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-618"><a href="#cb53-618" aria-hidden="true" tabindex="-1"></a><span class="in">all_stops_endpoints</span></span>
<span id="cb53-619"><a href="#cb53-619" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-620"><a href="#cb53-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-621"><a href="#cb53-621" aria-hidden="true" tabindex="-1"></a>And plotted:</span>
<span id="cb53-622"><a href="#cb53-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-623"><a href="#cb53-623" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-facet-subset-issues-fixed2, fig.width=7, fig.height=7}</span></span>
<span id="cb53-624"><a href="#cb53-624" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: Each facet now shows the destination city</span></span>
<span id="cb53-625"><a href="#cb53-625" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-alt: Each facet now shows the destination city</span></span>
<span id="cb53-626"><a href="#cb53-626" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot() +</span></span>
<span id="cb53-627"><a href="#cb53-627" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = lower_48) +</span></span>
<span id="cb53-628"><a href="#cb53-628" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = na.omit(lower_48_highlighted_better), aes(fill = visited)) +</span></span>
<span id="cb53-629"><a href="#cb53-629" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = routes_geocoded, color = clrs[1]) +</span></span>
<span id="cb53-630"><a href="#cb53-630" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = all_stops_endpoints) +</span></span>
<span id="cb53-631"><a href="#cb53-631" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_label_repel(</span></span>
<span id="cb53-632"><a href="#cb53-632" aria-hidden="true" tabindex="-1"></a><span class="in">    data = all_stops_endpoints,</span></span>
<span id="cb53-633"><a href="#cb53-633" aria-hidden="true" tabindex="-1"></a><span class="in">    aes(label = city, geometry = geometry),</span></span>
<span id="cb53-634"><a href="#cb53-634" aria-hidden="true" tabindex="-1"></a><span class="in">    stat = "sf_coordinates", seed = 1234,</span></span>
<span id="cb53-635"><a href="#cb53-635" aria-hidden="true" tabindex="-1"></a><span class="in">    size = 3, segment.color = clrs[3], min.segment.length = 0</span></span>
<span id="cb53-636"><a href="#cb53-636" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb53-637"><a href="#cb53-637" aria-hidden="true" tabindex="-1"></a><span class="in">  annotation_scale(</span></span>
<span id="cb53-638"><a href="#cb53-638" aria-hidden="true" tabindex="-1"></a><span class="in">    location = "bl", bar_cols = c("grey30", "white"),</span></span>
<span id="cb53-639"><a href="#cb53-639" aria-hidden="true" tabindex="-1"></a><span class="in">    unit_category = "imperial", text_family = "Overpass"</span></span>
<span id="cb53-640"><a href="#cb53-640" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb53-641"><a href="#cb53-641" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_manual(values = c("grey80"), guide = "none") +</span></span>
<span id="cb53-642"><a href="#cb53-642" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_sf(crs = st_crs("ESRI:102003")) +  # Albers</span></span>
<span id="cb53-643"><a href="#cb53-643" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_roadtrip() +</span></span>
<span id="cb53-644"><a href="#cb53-644" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(vars(direction), ncol = 1)</span></span>
<span id="cb53-645"><a href="#cb53-645" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-646"><a href="#cb53-646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-647"><a href="#cb53-647" aria-hidden="true" tabindex="-1"></a>Issue #2 fixed. <span class="in">`r emoji::emoji("check_mark_button")`</span></span>
<span id="cb53-648"><a href="#cb53-648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-649"><a href="#cb53-649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-650"><a href="#cb53-650" aria-hidden="true" tabindex="-1"></a><span class="fu"># Zooming in</span></span>
<span id="cb53-651"><a href="#cb53-651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-652"><a href="#cb53-652" aria-hidden="true" tabindex="-1"></a>We can also make separate maps that are zoomed in on each day of the trip in addition these bigger overarching ones. This will allow us to add more details like driving time and distances without getting too crowded on the map.</span>
<span id="cb53-653"><a href="#cb53-653" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-654"><a href="#cb53-654" aria-hidden="true" tabindex="-1"></a>We'll create a mini map of the first day by itself, and then scale up the process to make all the mini maps programmatically. </span>
<span id="cb53-655"><a href="#cb53-655" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-656"><a href="#cb53-656" aria-hidden="true" tabindex="-1"></a><span class="fu">## One day of the trip</span></span>
<span id="cb53-657"><a href="#cb53-657" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-658"><a href="#cb53-658" aria-hidden="true" tabindex="-1"></a>First we'll extract the route, cities, and states for the first day of the trip out there:</span>
<span id="cb53-659"><a href="#cb53-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-660"><a href="#cb53-660" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-day1, warning=FALSE}</span></span>
<span id="cb53-661"><a href="#cb53-661" aria-hidden="true" tabindex="-1"></a><span class="in">route_day1 &lt;- routes_geocoded %&gt;% </span></span>
<span id="cb53-662"><a href="#cb53-662" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(direction == "There", day == 1)</span></span>
<span id="cb53-663"><a href="#cb53-663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-664"><a href="#cb53-664" aria-hidden="true" tabindex="-1"></a><span class="in">stops_day1 &lt;- all_stops_endpoints %&gt;% </span></span>
<span id="cb53-665"><a href="#cb53-665" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(direction == "There", day == 1)</span></span>
<span id="cb53-666"><a href="#cb53-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-667"><a href="#cb53-667" aria-hidden="true" tabindex="-1"></a><span class="in">states_crossed_day1 &lt;- st_intersection(</span></span>
<span id="cb53-668"><a href="#cb53-668" aria-hidden="true" tabindex="-1"></a><span class="in">  st_transform(lower_48, st_crs(route_day1)),</span></span>
<span id="cb53-669"><a href="#cb53-669" aria-hidden="true" tabindex="-1"></a><span class="in">  route_day1</span></span>
<span id="cb53-670"><a href="#cb53-670" aria-hidden="true" tabindex="-1"></a><span class="in">) %&gt;% </span></span>
<span id="cb53-671"><a href="#cb53-671" aria-hidden="true" tabindex="-1"></a><span class="in">  distinct(NAME)</span></span>
<span id="cb53-672"><a href="#cb53-672" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-673"><a href="#cb53-673" aria-hidden="true" tabindex="-1"></a><span class="in">lower_48_highlighted_day1 &lt;- lower_48 %&gt;% </span></span>
<span id="cb53-674"><a href="#cb53-674" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(visited = NAME %in% states_crossed_day1$NAME)</span></span>
<span id="cb53-675"><a href="#cb53-675" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-676"><a href="#cb53-676" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-677"><a href="#cb53-677" aria-hidden="true" tabindex="-1"></a>Let's plot these to make sure it worked:</span>
<span id="cb53-678"><a href="#cb53-678" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-679"><a href="#cb53-679" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-day1-preliminary}</span></span>
<span id="cb53-680"><a href="#cb53-680" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: Drive for the first day on the full US map</span></span>
<span id="cb53-681"><a href="#cb53-681" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-alt: Drive for the first day on the full US map</span></span>
<span id="cb53-682"><a href="#cb53-682" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot() +</span></span>
<span id="cb53-683"><a href="#cb53-683" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = lower_48_highlighted_day1, aes(fill = visited)) +</span></span>
<span id="cb53-684"><a href="#cb53-684" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = route_day1, color = clrs[1]) +</span></span>
<span id="cb53-685"><a href="#cb53-685" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = stops_day1) +</span></span>
<span id="cb53-686"><a href="#cb53-686" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf_label(</span></span>
<span id="cb53-687"><a href="#cb53-687" aria-hidden="true" tabindex="-1"></a><span class="in">    data = stops_day1, </span></span>
<span id="cb53-688"><a href="#cb53-688" aria-hidden="true" tabindex="-1"></a><span class="in">    aes(label = city),</span></span>
<span id="cb53-689"><a href="#cb53-689" aria-hidden="true" tabindex="-1"></a><span class="in">    nudge_y = miles_to_meters(80)</span></span>
<span id="cb53-690"><a href="#cb53-690" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb53-691"><a href="#cb53-691" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_manual(values = c("grey90", "grey80"), guide = "none") +</span></span>
<span id="cb53-692"><a href="#cb53-692" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_sf(crs = st_crs("ESRI:102003")) +  # Albers</span></span>
<span id="cb53-693"><a href="#cb53-693" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_roadtrip()</span></span>
<span id="cb53-694"><a href="#cb53-694" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-695"><a href="#cb53-695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-696"><a href="#cb53-696" aria-hidden="true" tabindex="-1"></a>Yep, it worked. But we don't need to show the whole map—we want to zoom in on just the area around the route for the day. To do this, we can use <span class="in">`st_bbox()`</span> to extract a rectangle of coordinates around the route, creating a bounding box for the map that we can then use with <span class="in">`coord_sf()`</span> to zoom in.</span>
<span id="cb53-697"><a href="#cb53-697" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-698"><a href="#cb53-698" aria-hidden="true" tabindex="-1"></a><span class="in">`st_bbox()`</span> returns a named vector of numbers with the x- and y-axis limits:</span>
<span id="cb53-699"><a href="#cb53-699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-700"><a href="#cb53-700" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-bbox-basic}</span></span>
<span id="cb53-701"><a href="#cb53-701" aria-hidden="true" tabindex="-1"></a><span class="in">bbox &lt;- st_bbox(route_day1)</span></span>
<span id="cb53-702"><a href="#cb53-702" aria-hidden="true" tabindex="-1"></a><span class="in">bbox</span></span>
<span id="cb53-703"><a href="#cb53-703" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-704"><a href="#cb53-704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-705"><a href="#cb53-705" aria-hidden="true" tabindex="-1"></a>Since the elements are all named, we can use them to specify the different values in <span class="in">`coord_sf()`</span>. First we'll temporarily stop using the <span class="co">[</span><span class="ot">Albers projection</span><span class="co">](https://en.wikipedia.org/wiki/Albers_projection)</span>, since the numbers we've extracted with <span class="in">`st_bbox()`</span> are on the <span class="co">[</span><span class="ot">WGS 84 (−180 to 180) scale</span><span class="co">](https://en.wikipedia.org/wiki/World_Geodetic_System)</span> and Albers uses meters, which will make the map not work. (But we'll fix that in a minute!)</span>
<span id="cb53-706"><a href="#cb53-706" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-707"><a href="#cb53-707" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-day1-bbox-basic, warning=FALSE}</span></span>
<span id="cb53-708"><a href="#cb53-708" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: Trip for the first day, but zoomed in a little too far</span></span>
<span id="cb53-709"><a href="#cb53-709" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-alt: Trip for the first day, but zoomed in a little too far</span></span>
<span id="cb53-710"><a href="#cb53-710" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot() +</span></span>
<span id="cb53-711"><a href="#cb53-711" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = lower_48_highlighted_day1, aes(fill = visited)) +</span></span>
<span id="cb53-712"><a href="#cb53-712" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = route_day1, color = clrs[1]) +</span></span>
<span id="cb53-713"><a href="#cb53-713" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = stops_day1) +</span></span>
<span id="cb53-714"><a href="#cb53-714" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf_label(</span></span>
<span id="cb53-715"><a href="#cb53-715" aria-hidden="true" tabindex="-1"></a><span class="in">    data = stops_day1, </span></span>
<span id="cb53-716"><a href="#cb53-716" aria-hidden="true" tabindex="-1"></a><span class="in">    aes(label = city),</span></span>
<span id="cb53-717"><a href="#cb53-717" aria-hidden="true" tabindex="-1"></a><span class="in">    # We're not using Albers, so this isn't measured in meters; it's decimal degrees</span></span>
<span id="cb53-718"><a href="#cb53-718" aria-hidden="true" tabindex="-1"></a><span class="in">    nudge_y = 0.15</span></span>
<span id="cb53-719"><a href="#cb53-719" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb53-720"><a href="#cb53-720" aria-hidden="true" tabindex="-1"></a><span class="in">  annotation_scale(</span></span>
<span id="cb53-721"><a href="#cb53-721" aria-hidden="true" tabindex="-1"></a><span class="in">    location = "bl", bar_cols = c("grey30", "white"),</span></span>
<span id="cb53-722"><a href="#cb53-722" aria-hidden="true" tabindex="-1"></a><span class="in">    unit_category = "imperial", text_family = "Overpass"</span></span>
<span id="cb53-723"><a href="#cb53-723" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb53-724"><a href="#cb53-724" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_manual(values = c("grey90", "grey80"), guide = "none") +</span></span>
<span id="cb53-725"><a href="#cb53-725" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_sf(</span></span>
<span id="cb53-726"><a href="#cb53-726" aria-hidden="true" tabindex="-1"></a><span class="in">    xlim = c(bbox["xmin"], bbox["xmax"]), </span></span>
<span id="cb53-727"><a href="#cb53-727" aria-hidden="true" tabindex="-1"></a><span class="in">    ylim = c(bbox["ymin"], bbox["ymax"])</span></span>
<span id="cb53-728"><a href="#cb53-728" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb53-729"><a href="#cb53-729" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_roadtrip()</span></span>
<span id="cb53-730"><a href="#cb53-730" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-731"><a href="#cb53-731" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-732"><a href="#cb53-732" aria-hidden="true" tabindex="-1"></a>We're zoomed in (yay) but the edges of the bounding box window are too close to the points and the route, and the labels are cropped funny. Also, to shift the labels up we had to think in <span class="co">[</span><span class="ot">decimal degrees</span><span class="co">](https://en.wikipedia.org/wiki/Decimal_degrees)</span> instead of meters, which I can't do naturally. And also, we can't change projections—because we're specifying the bounding box coordinates in decimal degrees, we're stuck with WGS 84 instead of Albers or any other projection. These are all fixable issues, fortunately.</span>
<span id="cb53-733"><a href="#cb53-733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-734"><a href="#cb53-734" aria-hidden="true" tabindex="-1"></a>To fix all this, we'll expand the bounding box window by 150 miles on all sides using <span class="in">`st_buffer()`</span> and then convert the coordinates to Albers before extracting the coordinates of the window for plotting:</span>
<span id="cb53-735"><a href="#cb53-735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-736"><a href="#cb53-736" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-bbox-buffer-albers}</span></span>
<span id="cb53-737"><a href="#cb53-737" aria-hidden="true" tabindex="-1"></a><span class="in">bbox_nice &lt;- route_day1 %&gt;% </span></span>
<span id="cb53-738"><a href="#cb53-738" aria-hidden="true" tabindex="-1"></a><span class="in">  st_bbox() %&gt;%  # Extract the bounding box of the coordinates</span></span>
<span id="cb53-739"><a href="#cb53-739" aria-hidden="true" tabindex="-1"></a><span class="in">  st_as_sfc() %&gt;%  # Convert the bounding box matrix back to an sf object</span></span>
<span id="cb53-740"><a href="#cb53-740" aria-hidden="true" tabindex="-1"></a><span class="in">  st_buffer(miles_to_meters(150)) %&gt;%  # Add 150 miles to all sides</span></span>
<span id="cb53-741"><a href="#cb53-741" aria-hidden="true" tabindex="-1"></a><span class="in">  st_transform("ESRI:102003") %&gt;%  # Switch to Albers</span></span>
<span id="cb53-742"><a href="#cb53-742" aria-hidden="true" tabindex="-1"></a><span class="in">  st_bbox()  # Extract the bounding box of the expanded box</span></span>
<span id="cb53-743"><a href="#cb53-743" aria-hidden="true" tabindex="-1"></a><span class="in">bbox_nice</span></span>
<span id="cb53-744"><a href="#cb53-744" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-745"><a href="#cb53-745" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-746"><a href="#cb53-746" aria-hidden="true" tabindex="-1"></a>These are no longer in decimal degrees, so we can use them with the Albers projection. We've also added a 150-mile buffer around the window, so we should have room for all the labels now. Let's check it:</span>
<span id="cb53-747"><a href="#cb53-747" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-748"><a href="#cb53-748" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-day1-bbox-buffer-albers, warning=FALSE}</span></span>
<span id="cb53-749"><a href="#cb53-749" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: Trip for the first day, correctly zoomed and using the Albers projection</span></span>
<span id="cb53-750"><a href="#cb53-750" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-alt: Trip for the first day, correctly zoomed and using the Albers projection</span></span>
<span id="cb53-751"><a href="#cb53-751" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot() +</span></span>
<span id="cb53-752"><a href="#cb53-752" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = lower_48_highlighted_day1, aes(fill = visited)) +</span></span>
<span id="cb53-753"><a href="#cb53-753" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = route_day1, color = clrs[1]) +</span></span>
<span id="cb53-754"><a href="#cb53-754" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = stops_day1) +</span></span>
<span id="cb53-755"><a href="#cb53-755" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf_label(</span></span>
<span id="cb53-756"><a href="#cb53-756" aria-hidden="true" tabindex="-1"></a><span class="in">    data = stops_day1, </span></span>
<span id="cb53-757"><a href="#cb53-757" aria-hidden="true" tabindex="-1"></a><span class="in">    aes(label = city),</span></span>
<span id="cb53-758"><a href="#cb53-758" aria-hidden="true" tabindex="-1"></a><span class="in">    # We're in Albers again, so we can work with meters (or miles)</span></span>
<span id="cb53-759"><a href="#cb53-759" aria-hidden="true" tabindex="-1"></a><span class="in">    nudge_y = miles_to_meters(30)</span></span>
<span id="cb53-760"><a href="#cb53-760" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb53-761"><a href="#cb53-761" aria-hidden="true" tabindex="-1"></a><span class="in">  annotation_scale(</span></span>
<span id="cb53-762"><a href="#cb53-762" aria-hidden="true" tabindex="-1"></a><span class="in">    location = "bl", bar_cols = c("grey30", "white"),</span></span>
<span id="cb53-763"><a href="#cb53-763" aria-hidden="true" tabindex="-1"></a><span class="in">    unit_category = "imperial", text_family = "Overpass",</span></span>
<span id="cb53-764"><a href="#cb53-764" aria-hidden="true" tabindex="-1"></a><span class="in">    width_hint = 0.4</span></span>
<span id="cb53-765"><a href="#cb53-765" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb53-766"><a href="#cb53-766" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_manual(values = c("grey90", "grey80"), guide = "none") +</span></span>
<span id="cb53-767"><a href="#cb53-767" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_sf(</span></span>
<span id="cb53-768"><a href="#cb53-768" aria-hidden="true" tabindex="-1"></a><span class="in">    xlim = c(bbox_nice["xmin"], bbox_nice["xmax"]), </span></span>
<span id="cb53-769"><a href="#cb53-769" aria-hidden="true" tabindex="-1"></a><span class="in">    ylim = c(bbox_nice["ymin"], bbox_nice["ymax"]),</span></span>
<span id="cb53-770"><a href="#cb53-770" aria-hidden="true" tabindex="-1"></a><span class="in">    crs = st_crs("ESRI:102003")</span></span>
<span id="cb53-771"><a href="#cb53-771" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb53-772"><a href="#cb53-772" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_roadtrip()</span></span>
<span id="cb53-773"><a href="#cb53-773" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-774"><a href="#cb53-774" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-775"><a href="#cb53-775" aria-hidden="true" tabindex="-1"></a>Heck yeah.</span>
<span id="cb53-776"><a href="#cb53-776" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-777"><a href="#cb53-777" aria-hidden="true" tabindex="-1"></a>However, the shapes look a little curved and distorted because we're zoomed in so much. Albers is great for big countries, but on a small scale like this, WGS 84 is probably fine. That's what Google Maps does—it only starts getting weird and curvy along horizontal latitude lines when you zoom out really far. Let's do the first day map one last time without the Albers conversion:</span>
<span id="cb53-778"><a href="#cb53-778" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-779"><a href="#cb53-779" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-day1-bbox-buffer-wgs84, warning=FALSE, message=FALSE}</span></span>
<span id="cb53-780"><a href="#cb53-780" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: Trip for the first day, correctly zoomed and using the WGS 84 projection</span></span>
<span id="cb53-781"><a href="#cb53-781" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-alt: Trip for the first day, correctly zoomed and using the WGS 84 projection</span></span>
<span id="cb53-782"><a href="#cb53-782" aria-hidden="true" tabindex="-1"></a><span class="in">bbox_nice &lt;- route_day1 %&gt;% </span></span>
<span id="cb53-783"><a href="#cb53-783" aria-hidden="true" tabindex="-1"></a><span class="in">  st_bbox() %&gt;%  # Extract the bounding box of the coordinates</span></span>
<span id="cb53-784"><a href="#cb53-784" aria-hidden="true" tabindex="-1"></a><span class="in">  st_as_sfc() %&gt;%  # Convert the bounding box matrix back to an sf object</span></span>
<span id="cb53-785"><a href="#cb53-785" aria-hidden="true" tabindex="-1"></a><span class="in">  st_buffer(miles_to_meters(150)) %&gt;%  # Add 150 miles to all sides</span></span>
<span id="cb53-786"><a href="#cb53-786" aria-hidden="true" tabindex="-1"></a><span class="in">  st_bbox()  # Extract the bounding box of the expanded box</span></span>
<span id="cb53-787"><a href="#cb53-787" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-788"><a href="#cb53-788" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot() +</span></span>
<span id="cb53-789"><a href="#cb53-789" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = lower_48_highlighted_day1, aes(fill = visited)) +</span></span>
<span id="cb53-790"><a href="#cb53-790" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = route_day1, color = clrs[1]) +</span></span>
<span id="cb53-791"><a href="#cb53-791" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = stops_day1) +</span></span>
<span id="cb53-792"><a href="#cb53-792" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf_label(</span></span>
<span id="cb53-793"><a href="#cb53-793" aria-hidden="true" tabindex="-1"></a><span class="in">    data = stops_day1, </span></span>
<span id="cb53-794"><a href="#cb53-794" aria-hidden="true" tabindex="-1"></a><span class="in">    aes(label = city),</span></span>
<span id="cb53-795"><a href="#cb53-795" aria-hidden="true" tabindex="-1"></a><span class="in">    # We're in WGS 84, so these are decimal degrees</span></span>
<span id="cb53-796"><a href="#cb53-796" aria-hidden="true" tabindex="-1"></a><span class="in">    nudge_y = 0.5</span></span>
<span id="cb53-797"><a href="#cb53-797" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb53-798"><a href="#cb53-798" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_label_repel(</span></span>
<span id="cb53-799"><a href="#cb53-799" aria-hidden="true" tabindex="-1"></a><span class="in">    data = route_day1,</span></span>
<span id="cb53-800"><a href="#cb53-800" aria-hidden="true" tabindex="-1"></a><span class="in">    aes(label = distance_text, geometry = route_geometry),</span></span>
<span id="cb53-801"><a href="#cb53-801" aria-hidden="true" tabindex="-1"></a><span class="in">    stat = "sf_coordinates", seed = 12345,</span></span>
<span id="cb53-802"><a href="#cb53-802" aria-hidden="true" tabindex="-1"></a><span class="in">    family = "Overpass ExtraBold", fontface = "plain",</span></span>
<span id="cb53-803"><a href="#cb53-803" aria-hidden="true" tabindex="-1"></a><span class="in">    size = 3.5, fill = colorspace::lighten(clrs[5], 0.8), color = clrs[1], </span></span>
<span id="cb53-804"><a href="#cb53-804" aria-hidden="true" tabindex="-1"></a><span class="in">    segment.color = "grey50", min.segment.length = 0</span></span>
<span id="cb53-805"><a href="#cb53-805" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb53-806"><a href="#cb53-806" aria-hidden="true" tabindex="-1"></a><span class="in">  annotation_scale(</span></span>
<span id="cb53-807"><a href="#cb53-807" aria-hidden="true" tabindex="-1"></a><span class="in">    location = "bl", bar_cols = c("grey30", "white"),</span></span>
<span id="cb53-808"><a href="#cb53-808" aria-hidden="true" tabindex="-1"></a><span class="in">    unit_category = "imperial", text_family = "Overpass",</span></span>
<span id="cb53-809"><a href="#cb53-809" aria-hidden="true" tabindex="-1"></a><span class="in">    width_hint = 0.3</span></span>
<span id="cb53-810"><a href="#cb53-810" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb53-811"><a href="#cb53-811" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_manual(values = c("grey90", "grey80"), guide = "none") +</span></span>
<span id="cb53-812"><a href="#cb53-812" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_sf(</span></span>
<span id="cb53-813"><a href="#cb53-813" aria-hidden="true" tabindex="-1"></a><span class="in">    xlim = c(bbox_nice["xmin"], bbox_nice["xmax"]), </span></span>
<span id="cb53-814"><a href="#cb53-814" aria-hidden="true" tabindex="-1"></a><span class="in">    ylim = c(bbox_nice["ymin"], bbox_nice["ymax"]),</span></span>
<span id="cb53-815"><a href="#cb53-815" aria-hidden="true" tabindex="-1"></a><span class="in">    crs = st_crs("EPSG:4326")</span></span>
<span id="cb53-816"><a href="#cb53-816" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb53-817"><a href="#cb53-817" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_roadtrip()</span></span>
<span id="cb53-818"><a href="#cb53-818" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-819"><a href="#cb53-819" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-820"><a href="#cb53-820" aria-hidden="true" tabindex="-1"></a>Neat. The northern borders of Georgia, Alabama, and Mississippi are all flat here, which is great.</span>
<span id="cb53-821"><a href="#cb53-821" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-822"><a href="#cb53-822" aria-hidden="true" tabindex="-1"></a><span class="fu">## All the days of the trip</span></span>
<span id="cb53-823"><a href="#cb53-823" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-824"><a href="#cb53-824" aria-hidden="true" tabindex="-1"></a>We successfully plotted one day of the trip. But we'll be driving for 11 days (!) and need 11 plots. I don't want to copy/paste this all code 11 times, so we'll stick each major step into a function:</span>
<span id="cb53-825"><a href="#cb53-825" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-826"><a href="#cb53-826" aria-hidden="true" tabindex="-1"></a><span class="in">```{r build-functions}</span></span>
<span id="cb53-827"><a href="#cb53-827" aria-hidden="true" tabindex="-1"></a><span class="in"># Take a set of routes and do some pivoting to create a dataset that includes</span></span>
<span id="cb53-828"><a href="#cb53-828" aria-hidden="true" tabindex="-1"></a><span class="in"># the start and end points</span></span>
<span id="cb53-829"><a href="#cb53-829" aria-hidden="true" tabindex="-1"></a><span class="in">expand_endpoints &lt;- function(routes) {</span></span>
<span id="cb53-830"><a href="#cb53-830" aria-hidden="true" tabindex="-1"></a><span class="in">  routes %&gt;% </span></span>
<span id="cb53-831"><a href="#cb53-831" aria-hidden="true" tabindex="-1"></a><span class="in">    pivot_longer(</span></span>
<span id="cb53-832"><a href="#cb53-832" aria-hidden="true" tabindex="-1"></a><span class="in">    cols = c(origin_city, destination_city, origin_geometry, destination_geometry),</span></span>
<span id="cb53-833"><a href="#cb53-833" aria-hidden="true" tabindex="-1"></a><span class="in">    names_to = c("type", ".value"),</span></span>
<span id="cb53-834"><a href="#cb53-834" aria-hidden="true" tabindex="-1"></a><span class="in">    names_sep = "_"</span></span>
<span id="cb53-835"><a href="#cb53-835" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;% </span></span>
<span id="cb53-836"><a href="#cb53-836" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(city) %&gt;% </span></span>
<span id="cb53-837"><a href="#cb53-837" aria-hidden="true" tabindex="-1"></a><span class="in">  slice(1) %&gt;% </span></span>
<span id="cb53-838"><a href="#cb53-838" aria-hidden="true" tabindex="-1"></a><span class="in">  arrange(desc(type)) %&gt;% </span></span>
<span id="cb53-839"><a href="#cb53-839" aria-hidden="true" tabindex="-1"></a><span class="in">  st_set_geometry("geometry")</span></span>
<span id="cb53-840"><a href="#cb53-840" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb53-841"><a href="#cb53-841" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-842"><a href="#cb53-842" aria-hidden="true" tabindex="-1"></a><span class="in"># Take a set of routes and return a dataset with a flag marking which states they cross</span></span>
<span id="cb53-843"><a href="#cb53-843" aria-hidden="true" tabindex="-1"></a><span class="in">find_states &lt;- function(routes) {</span></span>
<span id="cb53-844"><a href="#cb53-844" aria-hidden="true" tabindex="-1"></a><span class="in">  # st_intersection() complains about innocuous things so suppress the warnings</span></span>
<span id="cb53-845"><a href="#cb53-845" aria-hidden="true" tabindex="-1"></a><span class="in">  suppressWarnings({</span></span>
<span id="cb53-846"><a href="#cb53-846" aria-hidden="true" tabindex="-1"></a><span class="in">    states_crossed &lt;- st_intersection(</span></span>
<span id="cb53-847"><a href="#cb53-847" aria-hidden="true" tabindex="-1"></a><span class="in">      st_transform(lower_48, st_crs(routes)),</span></span>
<span id="cb53-848"><a href="#cb53-848" aria-hidden="true" tabindex="-1"></a><span class="in">      routes</span></span>
<span id="cb53-849"><a href="#cb53-849" aria-hidden="true" tabindex="-1"></a><span class="in">    ) %&gt;% </span></span>
<span id="cb53-850"><a href="#cb53-850" aria-hidden="true" tabindex="-1"></a><span class="in">      distinct(NAME)</span></span>
<span id="cb53-851"><a href="#cb53-851" aria-hidden="true" tabindex="-1"></a><span class="in">  })</span></span>
<span id="cb53-852"><a href="#cb53-852" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb53-853"><a href="#cb53-853" aria-hidden="true" tabindex="-1"></a><span class="in">  lower_48 %&gt;% </span></span>
<span id="cb53-854"><a href="#cb53-854" aria-hidden="true" tabindex="-1"></a><span class="in">    mutate(visited = NAME %in% states_crossed$NAME)</span></span>
<span id="cb53-855"><a href="#cb53-855" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb53-856"><a href="#cb53-856" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-857"><a href="#cb53-857" aria-hidden="true" tabindex="-1"></a><span class="in"># Use routes, stopes, and states to build a plot</span></span>
<span id="cb53-858"><a href="#cb53-858" aria-hidden="true" tabindex="-1"></a><span class="in">build_day_map &lt;- function(routes, stops, states, direction, day) {</span></span>
<span id="cb53-859"><a href="#cb53-859" aria-hidden="true" tabindex="-1"></a><span class="in">  bbox_nice &lt;- routes %&gt;%</span></span>
<span id="cb53-860"><a href="#cb53-860" aria-hidden="true" tabindex="-1"></a><span class="in">    st_bbox() %&gt;%  # Extract the bounding box of the coordinates</span></span>
<span id="cb53-861"><a href="#cb53-861" aria-hidden="true" tabindex="-1"></a><span class="in">    st_as_sfc() %&gt;%  # Convert the bounding box matrix back to an sf object</span></span>
<span id="cb53-862"><a href="#cb53-862" aria-hidden="true" tabindex="-1"></a><span class="in">    st_buffer(miles_to_meters(150)) %&gt;%  # Add 150 miles to all sides</span></span>
<span id="cb53-863"><a href="#cb53-863" aria-hidden="true" tabindex="-1"></a><span class="in">    st_bbox()  # Extract the bounding box of the expanded box</span></span>
<span id="cb53-864"><a href="#cb53-864" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-865"><a href="#cb53-865" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot() +</span></span>
<span id="cb53-866"><a href="#cb53-866" aria-hidden="true" tabindex="-1"></a><span class="in">    geom_sf(data = states, aes(fill = visited)) +</span></span>
<span id="cb53-867"><a href="#cb53-867" aria-hidden="true" tabindex="-1"></a><span class="in">    geom_sf(data = routes, color = clrs[1]) +</span></span>
<span id="cb53-868"><a href="#cb53-868" aria-hidden="true" tabindex="-1"></a><span class="in">    geom_sf(data = stops) +</span></span>
<span id="cb53-869"><a href="#cb53-869" aria-hidden="true" tabindex="-1"></a><span class="in">    geom_sf_label(</span></span>
<span id="cb53-870"><a href="#cb53-870" aria-hidden="true" tabindex="-1"></a><span class="in">      data = stops,</span></span>
<span id="cb53-871"><a href="#cb53-871" aria-hidden="true" tabindex="-1"></a><span class="in">      aes(label = city),</span></span>
<span id="cb53-872"><a href="#cb53-872" aria-hidden="true" tabindex="-1"></a><span class="in">      # We're in WGS 84, so these are decimal degrees</span></span>
<span id="cb53-873"><a href="#cb53-873" aria-hidden="true" tabindex="-1"></a><span class="in">      nudge_y = 0.4</span></span>
<span id="cb53-874"><a href="#cb53-874" aria-hidden="true" tabindex="-1"></a><span class="in">    ) +</span></span>
<span id="cb53-875"><a href="#cb53-875" aria-hidden="true" tabindex="-1"></a><span class="in">    geom_label_repel(</span></span>
<span id="cb53-876"><a href="#cb53-876" aria-hidden="true" tabindex="-1"></a><span class="in">      data = routes,</span></span>
<span id="cb53-877"><a href="#cb53-877" aria-hidden="true" tabindex="-1"></a><span class="in">      aes(label = distance_text, geometry = route_geometry),</span></span>
<span id="cb53-878"><a href="#cb53-878" aria-hidden="true" tabindex="-1"></a><span class="in">      stat = "sf_coordinates", seed = 12345,</span></span>
<span id="cb53-879"><a href="#cb53-879" aria-hidden="true" tabindex="-1"></a><span class="in">      family = "Overpass ExtraBold", fontface = "plain",</span></span>
<span id="cb53-880"><a href="#cb53-880" aria-hidden="true" tabindex="-1"></a><span class="in">      size = 3.5, fill = colorspace::lighten(clrs[5], 0.8), color = clrs[1], </span></span>
<span id="cb53-881"><a href="#cb53-881" aria-hidden="true" tabindex="-1"></a><span class="in">      segment.color = "grey50", min.segment.length = 0</span></span>
<span id="cb53-882"><a href="#cb53-882" aria-hidden="true" tabindex="-1"></a><span class="in">    ) +</span></span>
<span id="cb53-883"><a href="#cb53-883" aria-hidden="true" tabindex="-1"></a><span class="in">    annotation_scale(</span></span>
<span id="cb53-884"><a href="#cb53-884" aria-hidden="true" tabindex="-1"></a><span class="in">      location = "bl", bar_cols = c("grey30", "white"),</span></span>
<span id="cb53-885"><a href="#cb53-885" aria-hidden="true" tabindex="-1"></a><span class="in">      unit_category = "imperial", text_family = "Overpass",</span></span>
<span id="cb53-886"><a href="#cb53-886" aria-hidden="true" tabindex="-1"></a><span class="in">      width_hint = 0.4</span></span>
<span id="cb53-887"><a href="#cb53-887" aria-hidden="true" tabindex="-1"></a><span class="in">    ) +</span></span>
<span id="cb53-888"><a href="#cb53-888" aria-hidden="true" tabindex="-1"></a><span class="in">    scale_fill_manual(values = c("grey90", "grey80"), guide = "none") +</span></span>
<span id="cb53-889"><a href="#cb53-889" aria-hidden="true" tabindex="-1"></a><span class="in">    coord_sf(</span></span>
<span id="cb53-890"><a href="#cb53-890" aria-hidden="true" tabindex="-1"></a><span class="in">      xlim = c(bbox_nice["xmin"], bbox_nice["xmax"]),</span></span>
<span id="cb53-891"><a href="#cb53-891" aria-hidden="true" tabindex="-1"></a><span class="in">      ylim = c(bbox_nice["ymin"], bbox_nice["ymax"]),</span></span>
<span id="cb53-892"><a href="#cb53-892" aria-hidden="true" tabindex="-1"></a><span class="in">      crs = st_crs("EPSG:4326")</span></span>
<span id="cb53-893"><a href="#cb53-893" aria-hidden="true" tabindex="-1"></a><span class="in">    ) +</span></span>
<span id="cb53-894"><a href="#cb53-894" aria-hidden="true" tabindex="-1"></a><span class="in">    labs(title = glue("{direction}, day {day}")) +</span></span>
<span id="cb53-895"><a href="#cb53-895" aria-hidden="true" tabindex="-1"></a><span class="in">    theme_roadtrip()</span></span>
<span id="cb53-896"><a href="#cb53-896" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb53-897"><a href="#cb53-897" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-898"><a href="#cb53-898" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-899"><a href="#cb53-899" aria-hidden="true" tabindex="-1"></a>With everything functionalized, we can do some super wild {purrr} magic. If we take <span class="in">`routes_geocoded`</span> and group it by direction and day (so there's a group per driving day), we'll get a list column that contains the geocded coordinates for each day:</span>
<span id="cb53-900"><a href="#cb53-900" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-901"><a href="#cb53-901" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-nested-data}</span></span>
<span id="cb53-902"><a href="#cb53-902" aria-hidden="true" tabindex="-1"></a><span class="in">daily_plots &lt;- routes_geocoded %&gt;% </span></span>
<span id="cb53-903"><a href="#cb53-903" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(direction, day) %&gt;% </span></span>
<span id="cb53-904"><a href="#cb53-904" aria-hidden="true" tabindex="-1"></a><span class="in">  nest(.key = "routes")</span></span>
<span id="cb53-905"><a href="#cb53-905" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-906"><a href="#cb53-906" aria-hidden="true" tabindex="-1"></a><span class="in">daily_plots</span></span>
<span id="cb53-907"><a href="#cb53-907" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-908"><a href="#cb53-908" aria-hidden="true" tabindex="-1"></a><span class="in"># Check the first day</span></span>
<span id="cb53-909"><a href="#cb53-909" aria-hidden="true" tabindex="-1"></a><span class="in">daily_plots$routes[[1]]</span></span>
<span id="cb53-910"><a href="#cb53-910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-911"><a href="#cb53-911" aria-hidden="true" tabindex="-1"></a><span class="in"># Check the first day of the return trip</span></span>
<span id="cb53-912"><a href="#cb53-912" aria-hidden="true" tabindex="-1"></a><span class="in">daily_plots$routes[[7]]</span></span>
<span id="cb53-913"><a href="#cb53-913" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-914"><a href="#cb53-914" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-915"><a href="#cb53-915" aria-hidden="true" tabindex="-1"></a>We can then use <span class="in">`purrr::map()`</span> and <span class="in">`purrr::pmap()`</span> to feed that nested list-column data frame through the different functions to expand endpoints, find crossed-through states, and build the daily plot.</span>
<span id="cb53-916"><a href="#cb53-916" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-917"><a href="#cb53-917" aria-hidden="true" tabindex="-1"></a><span class="in">```{r build-daily-plots}</span></span>
<span id="cb53-918"><a href="#cb53-918" aria-hidden="true" tabindex="-1"></a><span class="in">daily_plots &lt;- routes_geocoded %&gt;% </span></span>
<span id="cb53-919"><a href="#cb53-919" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(direction, day) %&gt;% </span></span>
<span id="cb53-920"><a href="#cb53-920" aria-hidden="true" tabindex="-1"></a><span class="in">  nest(.key = "routes") %&gt;% </span></span>
<span id="cb53-921"><a href="#cb53-921" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb53-922"><a href="#cb53-922" aria-hidden="true" tabindex="-1"></a><span class="in">    stops = map(routes, expand_endpoints),</span></span>
<span id="cb53-923"><a href="#cb53-923" aria-hidden="true" tabindex="-1"></a><span class="in">    states = map(routes, find_states),</span></span>
<span id="cb53-924"><a href="#cb53-924" aria-hidden="true" tabindex="-1"></a><span class="in">    plot = pmap(list(routes, stops, states, direction, day), build_day_map)</span></span>
<span id="cb53-925"><a href="#cb53-925" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb53-926"><a href="#cb53-926" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-927"><a href="#cb53-927" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-928"><a href="#cb53-928" aria-hidden="true" tabindex="-1"></a>Before looking at the plots, check out all these nested datasets! Each day has a dataset for the routes, stops, states, and final plot, and everything is contained here in a data frame. MAGICAL.</span>
<span id="cb53-929"><a href="#cb53-929" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-930"><a href="#cb53-930" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-daily-plots-nested-df}</span></span>
<span id="cb53-931"><a href="#cb53-931" aria-hidden="true" tabindex="-1"></a><span class="in">daily_plots</span></span>
<span id="cb53-932"><a href="#cb53-932" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-933"><a href="#cb53-933" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-934"><a href="#cb53-934" aria-hidden="true" tabindex="-1"></a>We can extract the plot for any single day with indexing:</span>
<span id="cb53-935"><a href="#cb53-935" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-936"><a href="#cb53-936" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-day10-indexed, warning=FALSE}</span></span>
<span id="cb53-937"><a href="#cb53-937" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: Trip for the day 4 of the return trip</span></span>
<span id="cb53-938"><a href="#cb53-938" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-alt: Trip for the day 4 of the return trip</span></span>
<span id="cb53-939"><a href="#cb53-939" aria-hidden="true" tabindex="-1"></a><span class="in">daily_plots$plot[[10]]</span></span>
<span id="cb53-940"><a href="#cb53-940" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-941"><a href="#cb53-941" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-942"><a href="#cb53-942" aria-hidden="true" tabindex="-1"></a>Or we can filter, pull, and pluck like good denizens of the tidyverse:</span>
<span id="cb53-943"><a href="#cb53-943" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-944"><a href="#cb53-944" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-day5-verbose, warning=FALSE}</span></span>
<span id="cb53-945"><a href="#cb53-945" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: Trip for the day 5 of the return trip</span></span>
<span id="cb53-946"><a href="#cb53-946" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-alt: Trip for the day 5 of the return trip</span></span>
<span id="cb53-947"><a href="#cb53-947" aria-hidden="true" tabindex="-1"></a><span class="in">daily_plots %&gt;% </span></span>
<span id="cb53-948"><a href="#cb53-948" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(direction == "Back again", day == 5) %&gt;% </span></span>
<span id="cb53-949"><a href="#cb53-949" aria-hidden="true" tabindex="-1"></a><span class="in">  pull(plot) %&gt;% pluck(1)</span></span>
<span id="cb53-950"><a href="#cb53-950" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-951"><a href="#cb53-951" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-952"><a href="#cb53-952" aria-hidden="true" tabindex="-1"></a>Here's all of them simultaneously inside a <span class="co">[</span><span class="ot">Quarto tabset</span><span class="co">](https://quarto.org/docs/output-formats/html-basics.html#tabsets)</span>, just for fun:</span>
<span id="cb53-953"><a href="#cb53-953" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-954"><a href="#cb53-954" aria-hidden="true" tabindex="-1"></a>:::: {.panel-tabset}</span>
<span id="cb53-955"><a href="#cb53-955" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-956"><a href="#cb53-956" aria-hidden="true" tabindex="-1"></a><span class="fu">## The trip there</span></span>
<span id="cb53-957"><a href="#cb53-957" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-958"><a href="#cb53-958" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb53-959"><a href="#cb53-959" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-960"><a href="#cb53-960" aria-hidden="true" tabindex="-1"></a><span class="fu">### Day 1</span></span>
<span id="cb53-961"><a href="#cb53-961" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-962"><a href="#cb53-962" aria-hidden="true" tabindex="-1"></a><span class="in">```{r panel-there-day1, warning=FALSE}</span></span>
<span id="cb53-963"><a href="#cb53-963" aria-hidden="true" tabindex="-1"></a><span class="in">daily_plots$plot[[1]]</span></span>
<span id="cb53-964"><a href="#cb53-964" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-965"><a href="#cb53-965" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-966"><a href="#cb53-966" aria-hidden="true" tabindex="-1"></a><span class="fu">### Day 2</span></span>
<span id="cb53-967"><a href="#cb53-967" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-968"><a href="#cb53-968" aria-hidden="true" tabindex="-1"></a><span class="in">```{r panel-there-day2, warning=FALSE}</span></span>
<span id="cb53-969"><a href="#cb53-969" aria-hidden="true" tabindex="-1"></a><span class="in">daily_plots$plot[[2]]</span></span>
<span id="cb53-970"><a href="#cb53-970" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-971"><a href="#cb53-971" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-972"><a href="#cb53-972" aria-hidden="true" tabindex="-1"></a><span class="fu">### Day 3</span></span>
<span id="cb53-973"><a href="#cb53-973" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-974"><a href="#cb53-974" aria-hidden="true" tabindex="-1"></a><span class="in">```{r panel-there-day3, warning=FALSE}</span></span>
<span id="cb53-975"><a href="#cb53-975" aria-hidden="true" tabindex="-1"></a><span class="in">daily_plots$plot[[3]]</span></span>
<span id="cb53-976"><a href="#cb53-976" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-977"><a href="#cb53-977" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-978"><a href="#cb53-978" aria-hidden="true" tabindex="-1"></a><span class="fu">### Day 4</span></span>
<span id="cb53-979"><a href="#cb53-979" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-980"><a href="#cb53-980" aria-hidden="true" tabindex="-1"></a><span class="in">```{r panel-there-day4, warning=FALSE}</span></span>
<span id="cb53-981"><a href="#cb53-981" aria-hidden="true" tabindex="-1"></a><span class="in">daily_plots$plot[[4]]</span></span>
<span id="cb53-982"><a href="#cb53-982" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-983"><a href="#cb53-983" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-984"><a href="#cb53-984" aria-hidden="true" tabindex="-1"></a><span class="fu">### Day 5</span></span>
<span id="cb53-985"><a href="#cb53-985" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-986"><a href="#cb53-986" aria-hidden="true" tabindex="-1"></a><span class="in">```{r panel-there-day5, warning=FALSE}</span></span>
<span id="cb53-987"><a href="#cb53-987" aria-hidden="true" tabindex="-1"></a><span class="in">daily_plots$plot[[5]]</span></span>
<span id="cb53-988"><a href="#cb53-988" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-989"><a href="#cb53-989" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-990"><a href="#cb53-990" aria-hidden="true" tabindex="-1"></a><span class="fu">### Day 6</span></span>
<span id="cb53-991"><a href="#cb53-991" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-992"><a href="#cb53-992" aria-hidden="true" tabindex="-1"></a><span class="in">```{r panel-there-day6, warning=FALSE}</span></span>
<span id="cb53-993"><a href="#cb53-993" aria-hidden="true" tabindex="-1"></a><span class="in">daily_plots$plot[[6]]</span></span>
<span id="cb53-994"><a href="#cb53-994" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-995"><a href="#cb53-995" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb53-996"><a href="#cb53-996" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-997"><a href="#cb53-997" aria-hidden="true" tabindex="-1"></a><span class="fu">## The trip back again</span></span>
<span id="cb53-998"><a href="#cb53-998" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-999"><a href="#cb53-999" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb53-1000"><a href="#cb53-1000" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-1001"><a href="#cb53-1001" aria-hidden="true" tabindex="-1"></a><span class="fu">### Day 1</span></span>
<span id="cb53-1002"><a href="#cb53-1002" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-1003"><a href="#cb53-1003" aria-hidden="true" tabindex="-1"></a><span class="in">```{r panel-back-day1, warning=FALSE}</span></span>
<span id="cb53-1004"><a href="#cb53-1004" aria-hidden="true" tabindex="-1"></a><span class="in">daily_plots$plot[[7]]</span></span>
<span id="cb53-1005"><a href="#cb53-1005" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-1006"><a href="#cb53-1006" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-1007"><a href="#cb53-1007" aria-hidden="true" tabindex="-1"></a><span class="fu">### Day 2</span></span>
<span id="cb53-1008"><a href="#cb53-1008" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-1009"><a href="#cb53-1009" aria-hidden="true" tabindex="-1"></a><span class="in">```{r panel-back-day2, warning=FALSE}</span></span>
<span id="cb53-1010"><a href="#cb53-1010" aria-hidden="true" tabindex="-1"></a><span class="in">daily_plots$plot[[8]]</span></span>
<span id="cb53-1011"><a href="#cb53-1011" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-1012"><a href="#cb53-1012" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-1013"><a href="#cb53-1013" aria-hidden="true" tabindex="-1"></a><span class="fu">### Day 3</span></span>
<span id="cb53-1014"><a href="#cb53-1014" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-1015"><a href="#cb53-1015" aria-hidden="true" tabindex="-1"></a><span class="in">```{r panel-back-day3, warning=FALSE}</span></span>
<span id="cb53-1016"><a href="#cb53-1016" aria-hidden="true" tabindex="-1"></a><span class="in">daily_plots$plot[[9]]</span></span>
<span id="cb53-1017"><a href="#cb53-1017" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-1018"><a href="#cb53-1018" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-1019"><a href="#cb53-1019" aria-hidden="true" tabindex="-1"></a><span class="fu">### Day 4</span></span>
<span id="cb53-1020"><a href="#cb53-1020" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-1021"><a href="#cb53-1021" aria-hidden="true" tabindex="-1"></a><span class="in">```{r panel-back-day4, warning=FALSE}</span></span>
<span id="cb53-1022"><a href="#cb53-1022" aria-hidden="true" tabindex="-1"></a><span class="in">daily_plots$plot[[10]]</span></span>
<span id="cb53-1023"><a href="#cb53-1023" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-1024"><a href="#cb53-1024" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-1025"><a href="#cb53-1025" aria-hidden="true" tabindex="-1"></a><span class="fu">### Day 5</span></span>
<span id="cb53-1026"><a href="#cb53-1026" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-1027"><a href="#cb53-1027" aria-hidden="true" tabindex="-1"></a><span class="in">```{r panel-back-day5, warning=FALSE}</span></span>
<span id="cb53-1028"><a href="#cb53-1028" aria-hidden="true" tabindex="-1"></a><span class="in">daily_plots$plot[[11]]</span></span>
<span id="cb53-1029"><a href="#cb53-1029" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-1030"><a href="#cb53-1030" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb53-1031"><a href="#cb53-1031" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-1032"><a href="#cb53-1032" aria-hidden="true" tabindex="-1"></a>::::</span>
<span id="cb53-1033"><a href="#cb53-1033" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-1034"><a href="#cb53-1034" aria-hidden="true" tabindex="-1"></a>Or, instead of extracting each plot individually like this, we can use <span class="in">`wrap_plots()`</span> from {patchwork} to combine a whole list of plots automatically, though we have a lot less control over the plots this way—some of the maps use a landscape orientation and some use a portrait orientation, so they're a big mess when combined like this:</span>
<span id="cb53-1035"><a href="#cb53-1035" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-1036"><a href="#cb53-1036" aria-hidden="true" tabindex="-1"></a><span class="in">```{r patchwork-everything-ugly, warning=FALSE, fig.width=16, fig.height=8}</span></span>
<span id="cb53-1037"><a href="#cb53-1037" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: screen-inset</span></span>
<span id="cb53-1038"><a href="#cb53-1038" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-alt: Ugly massive plot of all the days of the trip</span></span>
<span id="cb53-1039"><a href="#cb53-1039" aria-hidden="true" tabindex="-1"></a><span class="in">daily_plots %&gt;%</span></span>
<span id="cb53-1040"><a href="#cb53-1040" aria-hidden="true" tabindex="-1"></a><span class="in">  pull(plot) %&gt;% </span></span>
<span id="cb53-1041"><a href="#cb53-1041" aria-hidden="true" tabindex="-1"></a><span class="in">  wrap_plots()</span></span>
<span id="cb53-1042"><a href="#cb53-1042" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-1043"><a href="#cb53-1043" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-1044"><a href="#cb53-1044" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-1045"><a href="#cb53-1045" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb53-1046"><a href="#cb53-1046" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-1047"><a href="#cb53-1047" aria-hidden="true" tabindex="-1"></a>Time to add some maps to road trip journals and finish packing!</span></code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
<p><span class="faux-block"><i class="fa-brands fa-creative-commons" aria-label="creative-commons"></i> 2007–2024 Andrew Heiss</span> <span class="faux-block">All content licensed under<br><a href="https://creativecommons.org/licenses/by/4.0/"><i class="fa-brands fa-creative-commons" aria-label="creative-commons"></i> <i class="fa-brands fa-creative-commons-by" aria-label="creative-commons-by"></i> Creative Commons CC BY 4.0</a></span></p>
</div>   
    <div class="nav-footer-center">
<p><span class="faux-block"><i class="fa-brands fa-orcid" aria-label="orcid"></i> <strong>ORCID</strong> <a href="https://orcid.org/0000-0002-3948-3914">0000-0002-3948-3914</a></span> <span class="faux-block"><i class="fa-solid fa-key" aria-label="key"></i> <a href="../../../../../pgp_ath.asc.txt">PGP public key</a>   <i class="fa-solid fa-fingerprint" aria-label="fingerprint"></i> Fingerprint:<br><span class="fingerprint">4AA2 FA83 A8B2 05A4 E30F<br> 610D 1382 6216 9178 36AB</span></span></p>
</div>
    <div class="nav-footer-right">
<p><span class="faux-block">Made with <i class="fa-brands fa-r-project" aria-label="r-project"></i> and <a href="https://quarto.org/">Quarto</a></span> <span class="faux-block"><a href="https://github.com/andrewheiss/ath-quarto">View the source at <i class="fa-brands fa-github" aria-label="github"></i> GitHub</a></span></p>
</div>
  </div>
</footer>


</body></html>