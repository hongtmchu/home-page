<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Andrew Heiss">
<meta name="description" content="Learn how to use R, {brms}, and {marginaleffects} to analyze conjoint data and find causal and descriptive quantities of interest, both frequentistly and Bayesianly">
<title>The ultimate practical guide to conjoint analysis with R | Andrew Heiss – Andrew Heiss</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="../../../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../../../">
<link href="../../../../..//files/favicon-512.png" rel="icon" type="image/png">
<script src="../../../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../../../site_libs/quarto-html/quarto-syntax-highlighting-17c909d5fd25ae21b861c0c7a49b2096.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../../../site_libs/bootstrap/bootstrap-5cd0811f461c8271ae6bab49df9501be.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<link href="../../../../../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../../../../../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<script src="../../../../../site_libs/quarto-contrib/iconify-2.0.0/iconify-icon.min.js"></script><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script type="text/javascript">

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-527449-5', 'auto');

ga('send', {
  hitType: 'pageview',
  'anonymizeIp': true,
});
</script><style>

      .quarto-title-block .quarto-title-banner {
        background: #170C3A;
      }
</style>
<script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
<meta property="og:title" content="The ultimate practical guide to conjoint analysis with R | Andrew Heiss">
<meta property="og:description" content="Learn how to use R, {brms}, and {marginaleffects} to analyze conjoint data and find causal and descriptive quantities of interest, both frequentistly and Bayesianly">
<meta property="og:image" content="https://www.andrewheiss.com/blog/2023/07/25/conjoint-bayesian-frequentist-guide/index_files/figure-html/amce-mfx-bayes-plot-excerpt-1.png">
<meta property="og:site_name" content="Andrew Heiss">
<meta property="og:locale" content="en_US">
<meta property="og:image:height" content="864">
<meta property="og:image:width" content="1728">
<meta name="twitter:title" content="The ultimate practical guide to conjoint analysis with R | Andrew Heiss">
<meta name="twitter:description" content="Learn how to use R, {brms}, and {marginaleffects} to analyze conjoint data and find causal and descriptive quantities of interest, both frequentistly and Bayesianly">
<meta name="twitter:image" content="https://www.andrewheiss.com/blog/2023/07/25/conjoint-bayesian-frequentist-guide/index_files/figure-html/amce-mfx-bayes-plot-excerpt-1.png">
<meta name="twitter:creator" content="@andrewheiss">
<meta name="twitter:site" content="@andrewheiss">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image-height" content="864">
<meta name="twitter:image-width" content="1728">
</head>
<body class="floating nav-fixed slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../../../index.html">
    <span class="navbar-title">Andrew Heiss</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link" href="../../../../../index.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../cv/index.html"> 
<span class="menu-text">CV</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../blog/index.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../research/index.html"> 
<span class="menu-text">Research</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../teaching/index.html"> 
<span class="menu-text">Teaching</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../talks/index.html"> 
<span class="menu-text">Talks</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../now/index.html"> 
<span class="menu-text">Now</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../uses/index.html"> 
<span class="menu-text">Uses</span></a>
  </li>  
</ul>
<ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item">
    <a class="nav-link" href="../../../../../atom.xml"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:rss" style="font-size: 1.1em;" aria-label="Icon rss from bi Iconify.design set." title="RSS"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="mailto:aheiss@gsu.edu"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:envelope" style="font-size: 1.1em;" aria-label="Icon envelope from bi Iconify.design set." title="E-mail"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://bsky.app/profile/andrew.heiss.phd" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="fa6-brands:bluesky" style="font-size: 1.1em;" aria-label="Icon bluesky from fa6-brands Iconify.design set." title="Bluesky"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://fediscience.org/users/andrew/" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:mastodon" style="font-size: 1.1em;" aria-label="Icon mastodon from bi Iconify.design set." title="Mastodon"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/andrewheiss" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:github" style="font-size: 1.1em;" aria-label="Icon github from bi Iconify.design set." title="GitHub"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.youtube.com/andrewheiss" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:youtube" style="font-size: 1.1em;" aria-label="Icon youtube from bi Iconify.design set." title="YouTube"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.heissatopia.com/"> 
<span class="menu-text"><iconify-icon inline="" icon="fa6-brands:blogger" style="font-size: 1.15em;" aria-label="Icon blogger from fa6-brands Iconify.design set." title="Blogger"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.linkedin.com/in/andrewheiss" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:linkedin" style="font-size: 1.1em;" aria-label="Icon linkedin from bi Iconify.design set." title="LinkedIn"></iconify-icon></span></a>
  </li>  
</ul>
</div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><header id="title-block-header" class="quarto-title-block default blog-post page-columns page-full"><div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">The ultimate practical guide to conjoint analysis with R</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
                  <div>
        <div class="description">
          Learn how to use R, {brms}, and {marginaleffects} to analyze conjoint data and find causal and descriptive quantities of interest, both frequentistly and Bayesianly
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">r</div>
                <div class="quarto-category">tidyverse</div>
                <div class="quarto-category">ggplot</div>
                <div class="quarto-category">statistics</div>
                <div class="quarto-category">brms</div>
                <div class="quarto-category">stan</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p><a href="https://www.andrewheiss.com/">Andrew Heiss</a> <a href="https://orcid.org/0000-0002-3948-3914" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">Tuesday, July 25, 2023</p>
      </div>
    </div>
    
      
      <div>
      <div class="quarto-title-meta-heading">Doi</div>
      <div class="quarto-title-meta-contents">
        <p class="doi">
          <a href="https://doi.org/10.59350/xgwjy-dyj66">10.59350/xgwjy-dyj66</a>
        </p>
      </div>
    </div>
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Contents</h2>
   
  <ul>
<li><a href="#how-conjoint-experiments-work" id="toc-how-conjoint-experiments-work" class="nav-link active" data-scroll-target="#how-conjoint-experiments-work">How conjoint experiments work</a></li>
  <li>
<a href="#estimands-what-quantities-of-interest-can-you-get-from-conjoint-designs" id="toc-estimands-what-quantities-of-interest-can-you-get-from-conjoint-designs" class="nav-link" data-scroll-target="#estimands-what-quantities-of-interest-can-you-get-from-conjoint-designs">Estimands: what quantities of interest can you get from conjoint designs?</a>
  <ul>
<li><a href="#average-marginal-component-effect-amce" id="toc-average-marginal-component-effect-amce" class="nav-link" data-scroll-target="#average-marginal-component-effect-amce">Average marginal component effect (AMCE)</a></li>
  <li><a href="#marginal-means" id="toc-marginal-means" class="nav-link" data-scroll-target="#marginal-means">Marginal means</a></li>
  <li>
<a href="#relationship-between-amces-and-marginal-means" id="toc-relationship-between-amces-and-marginal-means" class="nav-link" data-scroll-target="#relationship-between-amces-and-marginal-means">Relationship between AMCEs and marginal means</a>
  <ul>
<li><a href="#penguin-example" id="toc-penguin-example" class="nav-link" data-scroll-target="#penguin-example">Penguin example</a></li>
  <li><a href="#conjoint-amces-and-marginal-means-finally" id="toc-conjoint-amces-and-marginal-means-finally" class="nav-link" data-scroll-target="#conjoint-amces-and-marginal-means-finally">Conjoint AMCEs and marginal means (finally!)</a></li>
  </ul>
</li>
  <li><a href="#amces-and-marginal-means-across-subgroups" id="toc-amces-and-marginal-means-across-subgroups" class="nav-link" data-scroll-target="#amces-and-marginal-means-across-subgroups">AMCEs and marginal means across subgroups</a></li>
  </ul>
</li>
  <li>
<a href="#sec-frequentist" id="toc-sec-frequentist" class="nav-link" data-scroll-target="#sec-frequentist">Finding conjoint AMCEs and marginal means frequentistly</a>
  <ul>
<li>
<a href="#amces" id="toc-amces" class="nav-link" data-scroll-target="#amces">AMCEs</a>
  <ul>
<li><a href="#automatic-estimates-with-creggamce" id="toc-automatic-estimates-with-creggamce" class="nav-link" data-scroll-target="#automatic-estimates-with-creggamce">Automatic estimates with <code>cregg::amce()</code></a></li>
  <li><a href="#ols-coefficients" id="toc-ols-coefficients" class="nav-link" data-scroll-target="#ols-coefficients">OLS coefficients</a></li>
  <li><a href="#marginal-effects-instead-of-coefficients" id="toc-marginal-effects-instead-of-coefficients" class="nav-link" data-scroll-target="#marginal-effects-instead-of-coefficients">Marginal effects instead of coefficients</a></li>
  <li>
<a href="#coefficient-plots" id="toc-coefficient-plots" class="nav-link" data-scroll-target="#coefficient-plots">Coefficient plots</a>
  <ul class="collapse">
<li><a href="#automatically-with-broom.helpers" id="toc-automatically-with-broom.helpers" class="nav-link" data-scroll-target="#automatically-with-broom.helpers">Automatically with {broom.helpers}</a></li>
  <li><a href="#manually-with-dplyr-wrangling-magic" id="toc-manually-with-dplyr-wrangling-magic" class="nav-link" data-scroll-target="#manually-with-dplyr-wrangling-magic">Manually with {dplyr} wrangling magic</a></li>
  </ul>
</li>
  <li><a href="#logistic-regression-instead-of-ols" id="toc-logistic-regression-instead-of-ols" class="nav-link" data-scroll-target="#logistic-regression-instead-of-ols">Logistic regression instead of OLS</a></li>
  </ul>
</li>
  <li>
<a href="#marginal-means-1" id="toc-marginal-means-1" class="nav-link" data-scroll-target="#marginal-means-1">Marginal means</a>
  <ul>
<li><a href="#automatic-estimates-with-creggmm" id="toc-automatic-estimates-with-creggmm" class="nav-link" data-scroll-target="#automatic-estimates-with-creggmm">Automatic estimates with <code>cregg::mm()</code></a></li>
  <li><a href="#quick-and-dirty-marginal-means" id="toc-quick-and-dirty-marginal-means" class="nav-link" data-scroll-target="#quick-and-dirty-marginal-means">Quick-and-dirty marginal means</a></li>
  <li>
<a href="#marginal-means-with-marginaleffects" id="toc-marginal-means-with-marginaleffects" class="nav-link" data-scroll-target="#marginal-means-with-marginaleffects">Marginal means with {marginaleffects}</a>
  <ul class="collapse">
<li><a href="#how-marginal_means-works" id="toc-how-marginal_means-works" class="nav-link" data-scroll-target="#how-marginal_means-works">How <code>marginal_means()</code> works</a></li>
  <li><a href="#marginal_means-with-the-full-actual-model" id="toc-marginal_means-with-the-full-actual-model" class="nav-link" data-scroll-target="#marginal_means-with-the-full-actual-model"><code>marginal_means()</code> with the full actual model</a></li>
  </ul>
</li>
  </ul>
</li>
  <li>
<a href="#subgroup-differences-in-amces-and-marginal-means" id="toc-subgroup-differences-in-amces-and-marginal-means" class="nav-link" data-scroll-target="#subgroup-differences-in-amces-and-marginal-means">Subgroup differences in AMCEs and marginal means</a>
  <ul>
<li><a href="#conditional-amces" id="toc-conditional-amces" class="nav-link" data-scroll-target="#conditional-amces">Conditional AMCEs</a></li>
  <li><a href="#conditional-marginal-means" id="toc-conditional-marginal-means" class="nav-link" data-scroll-target="#conditional-marginal-means">Conditional marginal means</a></li>
  </ul>
</li>
  </ul>
</li>
  <li>
<a href="#finding-conjoint-amces-and-marginal-means-bayesianly" id="toc-finding-conjoint-amces-and-marginal-means-bayesianly" class="nav-link" data-scroll-target="#finding-conjoint-amces-and-marginal-means-bayesianly">Finding conjoint AMCEs and marginal means Bayesianly</a>
  <ul>
<li><a href="#the-overall-model" id="toc-the-overall-model" class="nav-link" data-scroll-target="#the-overall-model">The overall model</a></li>
  <li><a href="#amces-1" id="toc-amces-1" class="nav-link" data-scroll-target="#amces-1">AMCEs</a></li>
  <li><a href="#marginal-means-2" id="toc-marginal-means-2" class="nav-link" data-scroll-target="#marginal-means-2">Marginal means</a></li>
  <li>
<a href="#subgroup-differences" id="toc-subgroup-differences" class="nav-link" data-scroll-target="#subgroup-differences">Subgroup differences</a>
  <ul>
<li><a href="#conditional-amces-1" id="toc-conditional-amces-1" class="nav-link" data-scroll-target="#conditional-amces-1">Conditional AMCEs</a></li>
  <li><a href="#conditional-marginal-means-1" id="toc-conditional-marginal-means-1" class="nav-link" data-scroll-target="#conditional-marginal-means-1">Conditional marginal means</a></li>
  </ul>
</li>
  </ul>
</li>
  </ul></nav>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content"><p>In my research, I study international nongovernmental organizations (INGOs) and look at how lots of different institutional and organizational factors influence INGO behavior. For instance, many authoritarian regimes have passed anti-NGO laws and engaged in other forms of legal crackdown, which has forced NGOs to change their programming strategies and their sources of funding.</p>
<p>In one ongoing project with <a href="https://www.suparnachaudhry.com/">Suparna Chaudhry</a> and <a href="https://marriott.byu.edu/directory/details?id=50683">Marc Dotson</a>, we look at how individual private donors feel about NGOs that face legal crackdown abroad and how the experience of crackdown interacts with donor characteristics (like how much education a person has, whether they’ve traveled abroad, what their income is, etc.) with organizational characteristics (like whether it deals with humanitarian or human rights issues, whether it has an open commitment to transparency, whether it faces legal crackdown abroad, etc.) to shape an individual’s decision to give money to an NGO.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<div class="no-row-height column-margin column-container"><div id="fn1"><p><sup>1</sup>&nbsp;<a href="https://www.andrewheiss.com/research/articles/chaudhry-heiss-ngos-philanthropy/">In earlier work with Suparna Chaudhry, we do a similar thing too</a>, just with far fewer experimental conditions.</p></div><div id="fn2"><p><sup>2</sup>&nbsp;<a href="https://stats.andrewheiss.com/why-donors-donate/preregistration.html">See our preregistration here.</a></p></div></div><p>We use a conjoint experiment to test a bunch of different hypotheses related to INGO characteristics and donor behavior<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> However, in all my previous stats training, I never learned how to analyze conjoint data or how to test specific causal claims and estimate causal effects with this kind of data. So, in the course of analyzing our INGO conjoint data, I’ve been making a guide for future-me (and anyone else who’s interested) in how to analyze conjoint survey data.</p>
<p>This is that guide.</p>
<p>I explore three main things here:</p>
<ol type="1">
<li>What kinds of causal and descriptive estimands (or quantities of interest) can you get from conjoint designs?</li>
<li>How can you estimate these things with “standard” frequentist statistics?</li>
<li>How can you estimate these things with Bayesian statistics?</li>
</ol>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Who this post is for
</div>
</div>
<div class="callout-body-container callout-body">
<p>Here’s what I assume you know:</p>
<ul>
<li>You’re familiar with <a href="https://www.r-project.org/">R</a> and the <a href="https://www.tidyverse.org/">tidyverse</a> (particularly <a href="https://dplyr.tidyverse.org/">{dplyr}</a> and <a href="https://ggplot2.tidyverse.org/">{ggplot2}</a>).</li>
<li>You’re familiar with linear regression and packages like <a href="https://broom.tidymodels.org/">{broom}</a> for converting regression results into tidy data frames and <a href="https://vincentarelbundock.github.io/marginaleffects/">{marginaleffects}</a> for calculating <a href="https://www.andrewheiss.com/blog/2022/05/20/marginalia/">marginal effects</a>.</li>
<li>You’re familiar with <a href="https://paul-buerkner.github.io/brms/">{brms}</a> for running Bayesian regression models and <a href="https://mjskay.github.io/tidybayes/">{tidybayes}</a> and <a href="https://mjskay.github.io/ggdist/">{ggdist}</a> for manipulating and plotting posterior draws.</li>
</ul>
</div>
</div>
<p>Throughout this example, I’ll use data from a political candidate conjoint experiment from <span class="citation" data-cites="HainmuellerHopkinsYamamoto:2014">Hainmueller, Hopkins, and Yamamoto (<a href="#ref-HainmuellerHopkinsYamamoto:2014" role="doc-biblioref">2014</a>)</span>. <a href="https://doi.org/10.7910/DVN/THJYQR">The data is available at the Harvard Dataverse</a> and it’s public domain, so you can also download it here if you want to follow along:</p>
<ul>
<li>
<a href="data/candidate.dta"><i class="fa-solid fa-table" aria-label="table"></i> <code>candidate.dta</code></a> (this is a Stata file)<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>
</li>
</ul>
<div class="no-row-height column-margin column-container"><div id="fn3"><p><sup>3</sup>&nbsp;booo</p></div></div><p>Let’s load some packages and data, create some helper functions and nice theme stuff, and get started!</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>        <span class="co"># ggplot, dplyr, and friends</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://haven.tidyverse.org">haven</a></span><span class="op">)</span>            <span class="co"># Read Stata files</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://broom.tidymodels.org/">broom</a></span><span class="op">)</span>            <span class="co"># Convert model objects to tidy data frames</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">cregg</span><span class="op">)</span>            <span class="co"># Automatically calculate frequentist conjoint AMCEs and MMs</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://r-survey.r-forge.r-project.org/survey/">survey</a></span><span class="op">)</span>           <span class="co"># Panel-ish regression models</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://scales.r-lib.org">scales</a></span><span class="op">)</span>           <span class="co"># Nicer labeling functions</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://marginaleffects.com/">marginaleffects</a></span><span class="op">)</span>  <span class="co"># Calculate marginal effects</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://larmarange.github.io/broom.helpers/">broom.helpers</a></span><span class="op">)</span>    <span class="co"># Add empty reference categories to tidy model data frames</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggforce.data-imaginist.com">ggforce</a></span><span class="op">)</span>          <span class="co"># For facet_col()</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/paul-buerkner/brms">brms</a></span><span class="op">)</span>             <span class="co"># The best formula-based interface to Stan</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mjskay.github.io/tidybayes/">tidybayes</a></span><span class="op">)</span>        <span class="co"># Manipulate Stan results in tidy ways</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mjskay.github.io/ggdist/">ggdist</a></span><span class="op">)</span>           <span class="co"># Fancy distribution plots</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com">patchwork</a></span><span class="op">)</span>        <span class="co"># Combine ggplot plots</span></span>
<span></span>
<span><span class="co"># Custom ggplot theme to make pretty plots</span></span>
<span><span class="co"># Get the font at https://fonts.google.com/specimen/Jost</span></span>
<span><span class="va">theme_nice</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span>base_family <span class="op">=</span> <span class="st">"Jost"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">theme</span><span class="op">(</span>panel.grid.minor <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>          plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Jost"</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>          axis.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Jost Medium"</span><span class="op">)</span>,</span>
<span>          axis.title.x <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>          axis.title.y <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>          strip.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Jost"</span>, face <span class="op">=</span> <span class="st">"bold"</span>,</span>
<span>                                    size <span class="op">=</span> <span class="fu">rel</span><span class="op">(</span><span class="fl">0.75</span><span class="op">)</span>, hjust <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>          strip.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"grey90"</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Set default theme and font stuff</span></span>
<span><span class="fu">theme_set</span><span class="op">(</span><span class="fu">theme_nice</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">update_geom_defaults</span><span class="op">(</span><span class="st">"text"</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Jost"</span>, fontface <span class="op">=</span> <span class="st">"plain"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">update_geom_defaults</span><span class="op">(</span><span class="st">"label"</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Jost"</span>, fontface <span class="op">=</span> <span class="st">"plain"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Party colors from the Urban Institute's data visualization style guide, for fun</span></span>
<span><span class="co"># http://urbaninstitute.github.io/graphics-styleguide/</span></span>
<span><span class="va">parties</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#1696d2"</span>, <span class="st">"#db2b27"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Functions for formatting things as percentage points</span></span>
<span><span class="va">label_pp</span> <span class="op">&lt;-</span> <span class="fu">label_number</span><span class="op">(</span>accuracy <span class="op">=</span> <span class="fl">1</span>, scale <span class="op">=</span> <span class="fl">100</span>, </span>
<span>                         suffix <span class="op">=</span> <span class="st">" pp."</span>, style_negative <span class="op">=</span> <span class="st">"minus"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">label_amce</span> <span class="op">&lt;-</span> <span class="fu">label_number</span><span class="op">(</span>accuracy <span class="op">=</span> <span class="fl">0.1</span>, scale <span class="op">=</span> <span class="fl">100</span>, suffix <span class="op">=</span> <span class="st">" pp."</span>, </span>
<span>                           style_negative <span class="op">=</span> <span class="st">"minus"</span>, style_positive <span class="op">=</span> <span class="st">"plus"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Data from https://doi.org/10.7910/DVN/THJYQR</span></span>
<span><span class="co"># It's public domain</span></span>
<span><span class="va">candidate</span> <span class="op">&lt;-</span> <span class="fu">read_stata</span><span class="op">(</span><span class="st">"data/candidate.dta"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">as_factor</span><span class="op">(</span><span class="op">)</span>  <span class="co"># Convert all the Stata categories to factors</span></span>
<span></span>
<span><span class="co"># Make a little lookup table for nicer feature labels</span></span>
<span><span class="va">variable_lookup</span> <span class="op">&lt;-</span> <span class="fu">tribble</span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">variable</span>,    <span class="op">~</span><span class="va">variable_nice</span>,</span>
<span>  <span class="st">"atmilitary"</span>, <span class="st">"Military"</span>,</span>
<span>  <span class="st">"atreligion"</span>, <span class="st">"Religion"</span>,</span>
<span>  <span class="st">"ated"</span>,       <span class="st">"Education"</span>,</span>
<span>  <span class="st">"atprof"</span>,     <span class="st">"Profession"</span>,</span>
<span>  <span class="st">"atmale"</span>,     <span class="st">"Gender"</span>,</span>
<span>  <span class="st">"atinc"</span>,      <span class="st">"Income"</span>,</span>
<span>  <span class="st">"atrace"</span>,     <span class="st">"Race"</span>,</span>
<span>  <span class="st">"atage"</span>,      <span class="st">"Age"</span></span>
<span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>variable_nice <span class="op">=</span> <span class="fu">fct_inorder</span><span class="op">(</span><span class="va">variable_nice</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="how-conjoint-experiments-work" class="level1"><h1>How conjoint experiments work</h1>
<p><a href="https://en.wikipedia.org/wiki/Conjoint_analysis">Conjoint experiments</a> are a special kind of randomized experiment where study participants are asked questions that have experimental manipulations. However, unlike a standard randomized experiment where one feature of interest is manipulated (like in an A/B test), conjoint experiments are choose-your-own-adventure randomized experiments. Participants are presented with 2+ possible options that have a variety of features with different levels in those features, and then they’re asked to choose one (for a binary outcome) or rate them on some sort of scale (for a continuous outcome).</p>
<p>For instance, throughout this post we’ll play with data from a conjoint experiment by <span class="citation" data-cites="HainmuellerHopkinsYamamoto:2014">Hainmueller, Hopkins, and Yamamoto (<a href="#ref-HainmuellerHopkinsYamamoto:2014" role="doc-biblioref">2014</a>)</span> where they were interested in seeing the effect of different political candidate characteristics on the probability that a respondent would select that candidate (or on candidate favorability).</p>
<p>Respondents were shown the following question multiple times and asked to choose which candidate they’d vote for. Each candidate had a set of eight features with randomly chosen levels inside each feature, like this:</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Example conjoint survey question
</div>
</div>
<div class="callout-body-container callout-body">
<table class="caption-top table">
<thead><tr class="header">
<th></th>
<th style="text-align: center;">Candidate 1</th>
<th style="text-align: center;">Candidate 2</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Military service</td>
<td style="text-align: center;">Did not serve</td>
<td style="text-align: center;">Served</td>
</tr>
<tr class="even">
<td>Religion</td>
<td style="text-align: center;">None</td>
<td style="text-align: center;">Mormon</td>
</tr>
<tr class="odd">
<td>College</td>
<td style="text-align: center;">State university</td>
<td style="text-align: center;">Ivy League university</td>
</tr>
<tr class="even">
<td>Profession</td>
<td style="text-align: center;">Lawyer</td>
<td style="text-align: center;">Business owner</td>
</tr>
<tr class="odd">
<td>Gender</td>
<td style="text-align: center;">Female</td>
<td style="text-align: center;">Female</td>
</tr>
<tr class="even">
<td>Income</td>
<td style="text-align: center;">$54,000</td>
<td style="text-align: center;">$92,000</td>
</tr>
<tr class="odd">
<td>Race/Ethnicity</td>
<td style="text-align: center;">White</td>
<td style="text-align: center;">Asian American</td>
</tr>
<tr class="even">
<td>Age</td>
<td style="text-align: center;">45</td>
<td style="text-align: center;">68</td>
</tr>
</tbody>
</table>
<div class="rounded bg-success text-white p-2">
<p><strong>If you had to choose between them, which of these two candidates would you vote for?</strong></p>
<ul>
<li><strong>Candidate 1</strong></li>
<li><strong>Candidate 2</strong></li>
</ul>
</div>
</div>
</div>
<p>Each of these eight features had different levels within them that respondents could possibly see:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 28%">
<col style="width: 71%">
</colgroup>
<thead><tr class="header">
<th>Features/Attributes</th>
<th>Levels</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Military service</td>
<td>Served, Did not serve</td>
</tr>
<tr class="even">
<td>Religion</td>
<td>None, Jewish, Catholic, Mainline protestant, Evangelical protestant, Mormon</td>
</tr>
<tr class="odd">
<td>College</td>
<td>No BA, Baptist college, Community college, State university, Small college, Ivy League university</td>
</tr>
<tr class="even">
<td>Profession</td>
<td>Business owner, Lawyer, Doctor, High school teacher, Farmer, Car dealer</td>
</tr>
<tr class="odd">
<td>Gender</td>
<td>Male, Female</td>
</tr>
<tr class="even">
<td>Income</td>
<td>$32,000; $54,000; $65,000; $92,000; $210,000; $5,100,000</td>
</tr>
<tr class="odd">
<td>Race/Ethnicity</td>
<td>White, Native American, Black, Hispanic, Caucasian, Asian American</td>
</tr>
<tr class="even">
<td>Age</td>
<td>36, 45, 52, 60, 68, 75</td>
</tr>
</tbody>
</table></section><section id="estimands-what-quantities-of-interest-can-you-get-from-conjoint-designs" class="level1 page-columns page-full"><h1>Estimands: what quantities of interest can you get from conjoint designs?</h1>
<p>There are a ton of possible combinations of features and levels that can be offered to respondents—in this candidate experiment, there are 2 × 6 × 6 × 6 × 2 × 6 × 6 × 6, or 186,624 options(!). Even in a survey with thousands of respondents, it’s unlikely that every possible version of the 186,624 potential combinations would be seen by the whole sample. Regardless, with some statistical magic, you can still find valid quantities of interest from these complex experimental designs.</p>
<p>In general, there are two types of estimands that you can find using conjoint designs: causal and descriptive <span class="citation" data-cites="LeeperHoboltTilley:2020">Leeper, Hobolt, and Tilley (<a href="#ref-LeeperHoboltTilley:2020" role="doc-biblioref">2020</a>)</span>. The exact research question you have determines what quantity of interest you’ll want to find and how you analyze the data to find it. This table summarizes the two types of estimands, how they’re calculated, and shows some example questions you can answer with them:</p>
<div class="column-page-inset">
<div id="tbl-conjoint-estimands" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-conjoint-estimands-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: Causal and descriptive estimands from conjoint designs
</figcaption><div aria-describedby="tbl-conjoint-estimands-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 8%">
<col style="width: 32%">
<col style="width: 34%">
<col style="width: 24%">
</colgroup>
<thead><tr class="header">
<th>Purpose</th>
<th>Estimand</th>
<th>Example interpretation</th>
<th>Practical calculation</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><strong>Causal inference</strong></td>
<td>
<p><strong>Average marginal component effect (AMCE)</strong></p>
<p><span class="math display">\[
\begin{aligned}
\theta =\ &amp;\textbf{E} [\text{Outcome} \mid \operatorname{do}(\text{Feature} = \text{reference level})]\ - \\
&amp;\textbf{E}[\text{Outcome} \mid \operatorname{do}(\text{Feature} = \text{level of interest})]
\end{aligned}
\]</span></p>
</td>
<td>Changing a candidate’s religion from none to Mormon decreases the probability of selection by X percentage points.</td>
<td>Categorical regression coefficients or marginal effects where one level is omitted</td>
</tr>
<tr class="even">
<td><strong>Preference description</strong></td>
<td>
<p><strong>Marginal mean (MM)</strong></p>
<p><span class="math display">\[
\theta = \textbf{E}[\text{Outcome} \mid \text{Feature = Level of interest}]
\]</span></p>
<p><em>or</em></p>
<p><span class="math display">\[
\begin{aligned}
\theta =\ &amp;\textbf{E}[\text{Outcome} \mid \text{Feature = Level of interest}]\ - \\
&amp;\textbf{E}[\text{Outcome} \mid \text{Feature = Other level of interest}]
\end{aligned}
\]</span></p>
</td>
<td>
<p>Mormon candidates are supported by X% of respondents.</p>
<p><em>or</em></p>
<p>Mormon candidates are X percentage points less likely to be selected than Catholic candidates.</p>
</td>
<td>Average outcome value conditional on different levels</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</div>
<section id="average-marginal-component-effect-amce" class="level2"><h2 class="anchored" data-anchor-id="average-marginal-component-effect-amce">Average marginal component effect (AMCE)</h2>
<p>This distinction between causal and descriptive estimands makes sense if we look at the notation for the estimands themselves. <a href="https://www.andrewheiss.com/blog/2021/09/07/do-calculus-backdoors/">In the world of do-calculus</a>, causal questions are asked using the <span class="math inline">\(\operatorname{do}()\)</span> operator, which represents <a href="https://stats.stackexchange.com/questions/211008/dox-operator-meaning">a direct intervention into a data generating process</a>. In this case, the researcher randomly sets the attributes to specific levels—the respondent does not self-select into different conditions or decide for themselves that Candidate 1 is a Catholic lawyer or that Candidate 2 is a Jewish farmer. This thus eliminates selection bias and other external confounding, leaving us with an average causal effect.</p>
<p>We can calculate (1) the average outcome when a feature is set to a level we’re interested in (e.g., when religion = Mormon), (2) the average outcome when a feature is set to some reference level (e.g., when religion = none), and (3) find the difference between the two:</p>
<p><span class="math display">\[
\begin{aligned}
\theta =\ &amp;P [\text{Candidate selection} \mid \operatorname{do}(\text{Religion} = \text{none})]\ - \\
&amp;P[\text{Candidate selection} \mid \operatorname{do}(\text{Religion} = \text{Mormon})]
\end{aligned}
\]</span></p>
<p>Practically speaking, the easiest way to think about the average marginal component effect (AMCE) is as categorical coefficients in a linear regression model.</p>
<p>In my favorite analogy for thinking about regression, <a href="https://www.andrewheiss.com/blog/2022/05/20/marginalia/#regression-sliders-switches-and-mixing-boards">model covariates can either be sliders or switches</a>:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="img/slider-switch-annotated-80.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Numeric covariates are sliders—a one unit change in X is associated with a <span class="math inline">\(\beta\)</span> unit change in Y. You can slide that X variable up and down and influence Y accordingly (a 10 unit change in X is associated with a <span class="math inline">\(10  \times \beta\)</span> change in Y; a −1 unit change in X is associated with a <span class="math inline">\(-\beta\)</span> change in Y; and so on). The <span class="math inline">\(\beta\)</span> is a slider that you can move up and down and see what happens to the outcome.</p>
<p>Categorical covariates, on the other hand, are switches. One of the categories is omitted and represents the baseline average for that category, or the average when the switch is off. The other category coefficients represent shifts in that baseline, or what happens when the switch is flipped on.</p>
<p>Here’s a quick super basic reference example with data from {palmerpenguins} (this is not actual conjoint data!). We’ll model penguin weight based on penguin species and sex:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://allisonhorst.github.io/palmerpenguins/">palmerpenguins</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">penguins</span> <span class="op">&lt;-</span> <span class="va">penguins</span> <span class="op">%&gt;%</span> <span class="fu">drop_na</span><span class="op">(</span><span class="va">sex</span><span class="op">)</span></span>
<span></span>
<span><span class="va">penguin_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">body_mass_g</span> <span class="op">~</span> <span class="va">species</span> <span class="op">+</span> <span class="va">sex</span>, data <span class="op">=</span> <span class="va">penguins</span><span class="op">)</span></span>
<span><span class="fu">tidy</span><span class="op">(</span><span class="va">penguin_model</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 4 × 5</span></span>
<span><span class="co">##   term             estimate std.error statistic   p.value</span></span>
<span><span class="co">##   &lt;chr&gt;               &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 (Intercept)        3372.       31.4   107.    4.34e-258</span></span>
<span><span class="co">## 2 speciesChinstrap     26.9      46.5     0.579 5.63e-  1</span></span>
<span><span class="co">## 3 speciesGentoo      1378.       39.1    35.2   1.05e-113</span></span>
<span><span class="co">## 4 sexmale             668.       34.7    19.2   8.73e- 56</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There are three species and two sexes of penguins, but we only get coefficients for two species (Chinstrap and Gentoo) and one sex (male) because of how regression works—one category is omitted. The coefficients here represent changes in average body mass when switching on the corresponding category. For sex, the omitted category is “female,” so the coefficient for <code>sexmale</code> shows that male penguins are 667 grams heavier than female penguins, on average. Imagine a “sex” switch—when it’s flipped up to the male position, body mass goes up. The same idea works for species—the omitted species is Adélie, so on average Chinstraps are 27 grams heavier than Adélies, and Gentoos are 1,378 grams heavier than Adélies. We can flip the “Chinstrap” or “Gentoo” switches on and increase body mass accordingly.</p>
<p>The nice thing about the slider and switch analogy is that it makes it easier to think about holding everything constant—we have switches for both species and sex, but if we just tinker with one, we’ll get the effect of being a Chinstrap or a Gentoo or a male. It’s like a mixer board:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="img/mixer-board-annotated-80.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>That’s all standard regression-with-categorical-variables stuff.</p>
<p>The magic of AMCEs is that in the case of ordinary least squares (OLS) linear regression without any squared or nonlinear terms, <strong>AMCEs are just coefficients</strong>. It’s a little more complicated with non-linear terms or models with nonlinear link functions like logistic regression—we’d need to calculate marginal effects to get the AMCEs in those cases (but <a href="#marginal-effects-instead-of-coefficients">I’ll explore that a lot more below</a>).</p>
</section><section id="marginal-means" class="level2"><h2 class="anchored" data-anchor-id="marginal-means">Marginal means</h2>
<p>The descriptive estimand, on the other hand, does not have a <span class="math inline">\(\operatorname{do}()\)</span> operator, which means that there’s no experimental intervention or causal effect. Instead, we’re working with the observed averages of different levels.</p>
<p>For instance, if we wanted to know what proportion of respondents support Mormon candidates, we could calculate this estimand:</p>
<p><span class="math display">\[
\theta = P(\text{Candidate selection} \mid \text{Religion = Mormon})
\]</span></p>
<p>Or if we wanted to know the percentage point difference between the probabilities of Mormon and Catholic candidates, we could calculate this estimand:</p>
<p><span class="math display">\[
\begin{aligned}
\theta =\ &amp;P[\text{Candidate selection} \mid \text{Religion = Mormon}]\ - \\
&amp;P[\text{Candidate selection} \mid \text{Religion = Catholic}]
\end{aligned}
\]</span></p>
<p>Importantly these aren’t causal estimands—they’re descriptive. They’re also not relative to any baseline level. They’re not regression-style “switches” but instead are group averages.</p>
<p>We can see this really quick with the penguin data (again, this isn’t related to conjoint stuff! this is just to help with the intuition). To find these marginal means, we calculate the category-specific means. We can do that without regression with some grouping and summarizing:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Marginal means for species</span></span>
<span><span class="va">penguins</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">species</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>avg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">body_mass_g</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 3 × 2</span></span>
<span><span class="co">##   species     avg</span></span>
<span><span class="co">##   &lt;fct&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 Adelie    3706.</span></span>
<span><span class="co">## 2 Chinstrap 3733.</span></span>
<span><span class="co">## 3 Gentoo    5092.</span></span>
<span></span>
<span><span class="co"># Marginal means for sex</span></span>
<span><span class="va">penguins</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">sex</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>avg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">body_mass_g</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 2 × 2</span></span>
<span><span class="co">##   sex      avg</span></span>
<span><span class="co">##   &lt;fct&gt;  &lt;dbl&gt;</span></span>
<span><span class="co">## 1 female 3862.</span></span>
<span><span class="co">## 2 male   4546.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Or we could use a couple intercept-free models to get the same values. Mathematically this is the same as grouping and summarizing, since regression is ultimately <a href="https://twitter.com/ajeanstevenson/status/1488601482505060352">just fancy averaging</a>.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="img/fancy-averaging-tweet.png" class="img-fluid figure-img" style="width:75.0%"></p>
<figcaption><a href="https://twitter.com/ajeanstevenson/status/1488601482505060352">“Many things got easier once I accepted that regression is just fancy averaging.” —@ajeanstevenson</a></figcaption></figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">bind_rows</span><span class="op">(</span></span>
<span>  <span class="fu">tidy</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">body_mass_g</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">species</span>, data <span class="op">=</span> <span class="va">penguins</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu">tidy</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">body_mass_g</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">sex</span>, data <span class="op">=</span> <span class="va">penguins</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 5 × 5</span></span>
<span><span class="co">##   term             estimate std.error statistic   p.value</span></span>
<span><span class="co">##   &lt;chr&gt;               &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 speciesAdelie       3706.      38.1      97.2 6.88e-245</span></span>
<span><span class="co">## 2 speciesChinstrap    3733.      55.9      66.8 8.16e-194</span></span>
<span><span class="co">## 3 speciesGentoo       5092.      42.2     121.  6.31e-275</span></span>
<span><span class="co">## 4 sexfemale           3862.      56.8      68.0 1.70e-196</span></span>
<span><span class="co">## 5 sexmale             4546.      56.3      80.7 8.39e-220</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Or even better, we can use <a href="https://vincentarelbundock.github.io/marginaleffects/articles/marginalmeans.html"><code>marginal_means()</code></a> from <a href="https://vincentarelbundock.github.io/marginaleffects/">{marginaleffects}</a> (<a href="#marginal-means-with-marginaleffects">way more on that below!</a>)</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">marginal_means</span><span class="op">(</span><span class="va">penguin_model</span>, newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"species"</span>, <span class="st">"sex"</span><span class="op">)</span>, wts <span class="op">=</span> <span class="st">"cells"</span><span class="op">)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     Term     Value Mean Std. Error     z Pr(&gt;|z|) 2.5 % 97.5 %</span></span>
<span><span class="co">##  species Adelie    3706       26.2 141.4   &lt;0.001  3655   3758</span></span>
<span><span class="co">##  species Chinstrap 3733       38.4  97.2   &lt;0.001  3658   3808</span></span>
<span><span class="co">##  species Gentoo    5092       29.0 175.5   &lt;0.001  5036   5149</span></span>
<span><span class="co">##  sex     female    3862       24.6 156.7   &lt;0.001  3814   3911</span></span>
<span><span class="co">##  sex     male      4546       24.4 186.1   &lt;0.001  4498   4594</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Results averaged over levels of: species, sex </span></span>
<span><span class="co">## Columns: term, value, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Regardless of how we calculate these, the numbers are the same, and they represent average penguin weights in each of the species and both of the sexes. We can answer descriptive questions about the average weight of female penguins or the difference in average weights between Gentoo and Chinstrap penguins. There’s no reference level—there are no regression switches or sliders—these are just averages.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Bonus: Market simulations
</div>
</div>
<div class="callout-body-container callout-body">
<p>There’s an extra third option that I didn’t include in <a href="#tbl-conjoint-estimands" class="quarto-xref">Table&nbsp;1</a> because it’s not used often in my worlds of public policy and political science, but it is used <em>a lot</em> in marketing. In this approach, researchers use conjoint experiments to simulate the data generating process for an overall “market” of “products” (or candidates in this running example).</p>
<p>Researchers build rich multilevel models to capture all the dynamics of the different respondent-level characteristics and the experimental features and levels and then create hypothetical “purchasers” with different covariate levels and see which combinations of individual characteristics and product characteristics influence the overall market share of products. Using the candidate experiment example, the market simulation would model the effect of different candidate features (religion, military experience, education, and so on) on the probability of choosing a candidate across individual respondent characteristics like ideology, political preferences, age, education, and so.</p>
<p>From what I’ve seen, this market simulation-based approach is really rare in social science. In fact, <a href="https://www.andrewheiss.com/research/articles/chaudhry-dotson-heiss-2021/">this paper</a> <span class="citation" data-cites="ChaudhryDotsonHeiss:2021">(<a href="#ref-ChaudhryDotsonHeiss:2021" role="doc-biblioref">Chaudhry, Dotson, and Heiss 2021</a>)</span> coauthored by Suparna Chaudhry, Marc Dotson, and me is the only political science-y one I know of! In it, we were interested in a host of different factors that drive individual preferences for charitable donations. We generated dozens of hypothetical donor personas and looked at how different categories of respondents felt about different features and how those preferences then influenced the market share of hypothetical nonprofits/NGOs.</p>
<p>For example, here we can see the average predicted donation market shares across all donor personas, segmented by persona public affairs knowledge, political ideology, and social trust across different NGO–host government relationships. NGOs with friendly relationships with their host governments will receive a greater share of donations from the market, regardless of individual political ideology or political knowledge and travelling experience.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="img/who-cares_fig4.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption>Figure 4 from <span class="citation" data-cites="ChaudhryDotsonHeiss:2021">Chaudhry, Dotson, and Heiss (<a href="#ref-ChaudhryDotsonHeiss:2021" role="doc-biblioref">2021</a>)</span></figcaption></figure>
</div>
<p>Returning to the slider + switch analogy, this kind of market simulation is like an ultimate-super-mega-huge mixer board. We had to create a Shiny dashboard (<a href="https://andrewheiss.shinyapps.io/why-donors-donate_market-simulator/">accessible here</a>) to explore all the different possible outcomes. It’s wild.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="img/simulator-screenshot.png" class="img-fluid figure-img"></p>
<figcaption>Screenshot of market simulator</figcaption></figure>
</div>
</div>
</div>
</section><section id="relationship-between-amces-and-marginal-means" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="relationship-between-amces-and-marginal-means">Relationship between AMCEs and marginal means</h2>
<p>Technically AMCEs and marginal means measure the same thing, just in different ways. Thinking about this in regression terms helps—with categorical marginal effects, the intercept for the model represents the average outcome for the omitted category, while the coefficient represents the offset from the average. The coefficient is the switch—turning it on changes the baseline reference category average by <span class="math inline">\(\beta\)</span> amount.</p>
<section id="penguin-example" class="level3"><h3 class="anchored" data-anchor-id="penguin-example">Penguin example</h3>
<p>Here’s one last example from the non-conjoint penguins data, just to drive the point home. Let’s make a super basic model that predicts weight based on sex only:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_sex_only</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">body_mass_g</span> <span class="op">~</span> <span class="va">sex</span>, data <span class="op">=</span> <span class="va">penguins</span><span class="op">)</span></span>
<span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_sex_only</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 2 × 5</span></span>
<span><span class="co">##   term        estimate std.error statistic   p.value</span></span>
<span><span class="co">##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 (Intercept)    3862.      56.8     68.0  1.70e-196</span></span>
<span><span class="co">## 2 sexmale         683.      80.0      8.54 4.90e- 16</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The intercept shows average weight for female penguins (3862 grams), while the coefficient for <code>sexmale</code> shows the change from that average when the “male” switch is turned on (683 more grams, on average).</p>
<p>We can actually use these two pieces of information to find the average penguin weight across both sexes: females are 3862.3 grams, males are 3862.3 + 683.4 = 4546 grams. We can confirm this with a quick <code>group_by() %&gt;% summarize()</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">penguins</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">sex</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>avg_weight <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">body_mass_g</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 2 × 2</span></span>
<span><span class="co">##   sex    avg_weight</span></span>
<span><span class="co">##   &lt;fct&gt;       &lt;dbl&gt;</span></span>
<span><span class="co">## 1 female      3862.</span></span>
<span><span class="co">## 2 male        4546.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Visualizing this should help even more with the general intuition. The horizontal distance between these two points is the same in each panel (683 grams). In the left panel, female weight is set at 0 since it’s the omitted reference category. In the right panel, both males and females have specific group averages. These two panels are analgous to the conjoint idea of AMCEs and marginal means.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="va">model_sex_only</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">tidy_and_attach</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">tidy_add_reference_rows</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">tidy_add_estimate_to_reference_rows</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">term</span> <span class="op">!=</span> <span class="st">"(Intercept)"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">estimate</span>, y <span class="op">=</span> <span class="va">term</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_pointrange</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xmin <span class="op">=</span> <span class="va">conf.low</span>, xmax <span class="op">=</span> <span class="va">conf.high</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">annotate</span><span class="op">(</span></span>
<span>    geom <span class="op">=</span> <span class="st">"errorbar"</span>,</span>
<span>    x <span class="op">=</span> <span class="fl">0</span>, xmin <span class="op">=</span> <span class="fl">0</span>, xmax <span class="op">=</span> <span class="fl">683.4</span>, y <span class="op">=</span> <span class="fl">1.5</span>,</span>
<span>    width <span class="op">=</span> <span class="fl">0.1</span>, color <span class="op">=</span> <span class="st">"grey70"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">annotate</span><span class="op">(</span></span>
<span>    geom <span class="op">=</span> <span class="st">"label"</span>,</span>
<span>    x <span class="op">=</span> <span class="fl">683.4</span> <span class="op">/</span> <span class="fl">2</span>, y <span class="op">=</span> <span class="fl">1.5</span>,</span>
<span>    label <span class="op">=</span> <span class="st">"683.4 grams"</span>,</span>
<span>    size <span class="op">=</span> <span class="fl">3</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Grams"</span>, y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"Relative shift in average"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"Similar to AMCEs"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">body_mass_g</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">sex</span>, data <span class="op">=</span> <span class="va">penguins</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">tidy</span><span class="op">(</span>conf.int <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">estimate</span>, y <span class="op">=</span> <span class="va">term</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_pointrange</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xmin <span class="op">=</span> <span class="va">conf.low</span>, xmax <span class="op">=</span> <span class="va">conf.high</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">annotate</span><span class="op">(</span></span>
<span>    geom <span class="op">=</span> <span class="st">"errorbar"</span>,</span>
<span>    x <span class="op">=</span> <span class="fl">3862</span>, xmin <span class="op">=</span> <span class="fl">3862</span>, xmax <span class="op">=</span> <span class="fl">4546</span>, y <span class="op">=</span> <span class="fl">1.5</span>,</span>
<span>    width <span class="op">=</span> <span class="fl">0.1</span>, color <span class="op">=</span> <span class="st">"grey70"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">annotate</span><span class="op">(</span></span>
<span>    geom <span class="op">=</span> <span class="st">"label"</span>,</span>
<span>    x <span class="op">=</span> <span class="fl">4546</span> <span class="op">-</span> <span class="op">(</span><span class="fl">683.4</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>, y <span class="op">=</span> <span class="fl">1.5</span>,</span>
<span>    label <span class="op">=</span> <span class="st">"683.4 grams"</span>,</span>
<span>    size <span class="op">=</span> <span class="fl">3</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_comma</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Grams"</span>, y <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>    title <span class="op">=</span> <span class="st">"Group averages"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"Similar to marginal means"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">p1</span> <span class="op">|</span> <span class="va">p2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-penguin-averages-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
</section><section id="conjoint-amces-and-marginal-means-finally" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="conjoint-amces-and-marginal-means-finally">Conjoint AMCEs and marginal means (finally!)</h3>
<p>Okay, with that intuition nailed down, we can finally look at conjoint results. We’ll look at the results from the candidate experiment in <span class="citation" data-cites="HainmuellerHopkinsYamamoto:2014">Hainmueller, Hopkins, and Yamamoto (<a href="#ref-HainmuellerHopkinsYamamoto:2014" role="doc-biblioref">2014</a>)</span>, which <span class="citation" data-cites="LeeperHoboltTilley:2020">Leeper, Hobolt, and Tilley (<a href="#ref-LeeperHoboltTilley:2020" role="doc-biblioref">2020</a>)</span> replicate and explore in their paper distinguishing between AMCEs and marginal means, and which we explored at the beginning of this post to show how conjoints work (i.e.&nbsp;there are seven candidate attributes like military service history, religion, gender, age, and so on).</p>
<p>Here’s an excerpt from Figure 1 in <span class="citation" data-cites="LeeperHoboltTilley:2020">Leeper, Hobolt, and Tilley (<a href="#ref-LeeperHoboltTilley:2020" role="doc-biblioref">2020</a>)</span>, which shows both the published AMCEs and the Leeper, et al.-calculated marginal means from Hainmueller, Hopkins, and Yamamoto’s original candidate study:</p>
<div class="my-4 page-columns page-full">
<div class="cell page-columns page-full" data-layout-align="center">
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="img/SVG/leeper-et-al-2019_fig1_excerpt.svg" class="img-fluid quarto-figure quarto-figure-center figure-img column-page-inset" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<p>The AMCEs in the left panel have a direct causal interpretation. In this case, holding all else equal, changing a candidate from not having military service to serving in the military increases the probability of support (or overall favorability) by 0.09, or 9 percentage points. Similarly, changing from a nonreligious candidate to a Mormon candidate decreases the probability of support by 14 percentage points (!!!).<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> There is no sex-based effect—changing a candidate from male to female has an AMCE of 0.0.</p>
<div class="no-row-height column-margin column-container"><div id="fn4"><p><sup>4</sup>&nbsp;This study was written and published in 2013, right after the 2012 presidential election between Barack Obama and Mitt Romney, a Mormon who did surprisingly well considering longstanding anti-Mormon sentiment in American politics (for more on Mormons and American politics, see <span class="citation" data-cites="Reeve:2015">Reeve (<a href="#ref-Reeve:2015" role="doc-biblioref">2015</a>)</span> and <span class="citation" data-cites="McBrideRogersErekson:2020">McBride, Rogers, and Erekson (<a href="#ref-McBrideRogersErekson:2020" role="doc-biblioref">2020</a>)</span>).</p></div></div><p>The marginal means in the right panel don’t rely on a reference category and are all centered around 50%—if there’s no difference between the the levels in a two-level feature, we’d expect the averages for each level to be 50%. We can see this with sex, where both male and female candidates have a 50% probability of selection (or 50% favorability, or however we want to interpret the outcome here).</p>
<p>With the AMCEs, we saw a 9 percentage point increase in favorability caused by military service. That same 9-point difference is visible in the marginal means: candidates without military service history have 46% favorability compared to the 54% favorability among those with military history (54−46 = 9).</p>
<p>The presence of a reference category doesn’t matter much when dealing with binary treatments like sex and military service here. If we reversed the reference category, we’d get the same causal effect but in reverse—not serving in the military causes a 9 percentage point drop in favorability.</p>
<p>The reference category matters a lot, however, in attributes with more than two levels, like religion. In the AMCE panel, all the causal effects are in reference to a candidate with no religion. Being Mormon causes a 14 percentage point drop from having no religion; being Evangelical causes a 12 percentage point drop from having no religion; and so on. Deciding which level to use as the omitted reference category matters and can seriously change the causal interpretation of the AMCEs. For instance, here it looks like there’s a serious penalty for being Mormon or Evangelical, while being Protestant, Catholic, or Jewish doesn’t matter. But that’s only the case from a certain point of view. If an Evangelical candidate were the reference category, there wouldn’t be any significant Mormon effect (but there would be a Protestant, Catholic, Jewish, and None effect).</p>

<div class="no-row-height column-margin column-container"><div class="">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="img/obiwan-pov.jpg" class="img-fluid figure-img"></p>
<figcaption>“What I told you was true… from a certain point of view”<br>—Obi-Wan Kenobi</figcaption></figure>
</div>
</div></div><p>The reference category gets in the way of making descriptive statements like “Mormon candidates see 42% favorability, while Jewish candidates see 52% favorability.” You can’t get numbers like that from the AMCEs alone unless you know the underlying favorability of the reference category and then reconstruct the other categories’ averages by hand. But researchers working with conjoint experiments try to do this with AMCEs all the time. <span class="citation" data-cites="LeeperHoboltTilley:2020">Leeper, Hobolt, and Tilley (<a href="#ref-LeeperHoboltTilley:2020" role="doc-biblioref">2020</a>)</span> argue that</p>
<blockquote class="blockquote">
<p>AMCEs are relative, not absolute, statements about preferences. As such, there is simply no predictable connection between subgroup causal effects and the levels of underlying subgroup preferences. Yet, analysts and their readers frequently interpret differences in conditional AMCEs as differences in underlying preferences <span class="citation" data-cites="LeeperHoboltTilley:2020">(<a href="#ref-LeeperHoboltTilley:2020" role="doc-biblioref">Leeper, Hobolt, and Tilley 2020, 214</a>)</span>.</p>
</blockquote>
<p><strong>The key point is this</strong>: AMCEs are relative statements, not absolute statements. If we want to talk about the causal effect of moving one attribute level (None → Mormon, None → Catholic, Male → Female, etc.), we can use AMCEs. If we want to talk about general preferences or favorabilities or probabilities or average outcomes, we need to talk about marginal means.</p>
</section></section><section id="amces-and-marginal-means-across-subgroups" class="level2"><h2 class="anchored" data-anchor-id="amces-and-marginal-means-across-subgroups">AMCEs and marginal means across subgroups</h2>
<p>This issue with relative vs.&nbsp;absolute estimands is <em>especially</em> complex when thinking about subgroups or controlling for respondent-level characteristics like political ideology, sex, education, and so on. Suppose we want to know if this Mormon penalty is bigger among Democratic respondents than Republican respondents. We could control for respondent ideology, or calculate two different AMCEs—one when Democrat = true and one when Republican = true. This seems all good and logical. And it it’s fine if you’re talking about causal effects. But once you start trying to compare overall trends across respondent-level subgroups, AMCEs will give you wrong estimates! The main argument in <span class="citation" data-cites="LeeperHoboltTilley:2020">Leeper, Hobolt, and Tilley (<a href="#ref-LeeperHoboltTilley:2020" role="doc-biblioref">2020</a>)</span> is that looking at AMCEs across respondent subgroups doesn’t work people think it does because AMCEs are relative and not absolute. The difference between the relative Mormon candidate AMCE among Democratic-leaning and Republican-leaning respondents isn’t really comparable to the party-based differences in other levels (Evangelicals, Catholics, etc.).</p>
<p><span class="citation" data-cites="LeeperHoboltTilley:2020">Leeper, Hobolt, and Tilley (<a href="#ref-LeeperHoboltTilley:2020" role="doc-biblioref">2020</a>)</span> illustrate this idea in a neat way in their Figure 2 (included below). This figure recreates the results for the “candidate sex” feature in a different candidate conjoint experiment done by <span class="citation" data-cites="TeeleKallaRosenbluth:2018">Teele, Kalla, and Rosenbluth (<a href="#ref-TeeleKallaRosenbluth:2018" role="doc-biblioref">2018</a>)</span>. In this case, unlike our running example from <span class="citation" data-cites="HainmuellerHopkinsYamamoto:2014">Hainmueller, Hopkins, and Yamamoto (<a href="#ref-HainmuellerHopkinsYamamoto:2014" role="doc-biblioref">2014</a>)</span>’s study, there <em>is</em> a sex effect—a candidate being female causes a 4.5 percentage point increase in favorability. We can see this in the top two panels, both as an AMCE of 0.045 and as marginal means (female = 0.52; male = 0.48; difference = AMCE = 0.045).</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="img/SVG/leeper-et-al-2019_fig2.svg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:75.0%"></p>
</figure>
</div>
</div>
</div>
<p>The third panel shows two different AMCEs conditional on respondent political party, and it appeared in the published study. Because AMCEs require a reference category as the baseline, and because AMCEs are relative quantities, it looks like there’s a huge party-based difference in favorability toward women candidates—being a woman causes a 7ish percentage point boost in favorability among Democrats, while it does nothing (or maybe something negative) among Republicans. These are conditional AMCEs (or CAMCEs), or the causal effect of turning on the “female” switch for a hypothetical candidate across Republican and Democratic respondents.</p>
<p>Conditional AMCEs are fine for causal work, but what trips people up often is that it’s tempting to use those conditional effects to describe actual overall patterns of preferences. Because there’s a reference category involved (male candidates), we can’t really say anything about the general respondent-party-ID-based preferences for male and female candidates. The conditional AMCE here combines the party-based difference in favorability toward female candidates (53.7% among Democrats; 49.2% among Republicans; difference of 4.5 percentage points) and the party-based difference in favorability toward male candidates (46.3% among Democrats; 50.8% among Republicans; difference of 4.5 percentage points). According to Leeper, et al.:</p>
<blockquote class="blockquote">
<p>Because Democrats and Republicans actually differ in their views of profiles containing the reference (male) category, AMCEs sum the true differences in preferences for a given feature level with the difference in preferences toward the reference category. Visual or numerical similarity of subgroup AMCEs is therefore an analytical artifact, not an accurate statement of the similarity of patterns of preferences <span class="citation" data-cites="LeeperHoboltTilley:2020">(<a href="#ref-LeeperHoboltTilley:2020" role="doc-biblioref">Leeper, Hobolt, and Tilley 2020, 215</a>)</span>.</p>
</blockquote>
<p>If we’re interested not in describing a causal effect (i.e.&nbsp;the effect of switching from male → female) but instead describing general preferences (i.e.&nbsp;the difference in overall candidate sex favorability between Republicans and Democrats), we have to look at marginal means (and the difference in marginal means) instead of conditional AMCEs. It is really tempting to look at the distance between Republicans and Democrats in the “Female” level in the third panel and say that there’s a nearly 10 percentage point difference in favorability across parties, but that’s wrong! It only looks that way because the effect sizes are all relative to the reference “Male” level.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="img/SVG/leeper-et-al-2019_fig2_excerpt.svg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:75.0%"></p>
</figure>
</div>
</div>
</div>
<p>In reality, Democrats are 4.5 percentage points less likely to select a male candidate and 4.5 percentage points more likely to select a female candidate. The differences in marginal means within party subgroups would look like this:</p>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Teele, Kalla, and Rosenbluth 2018 data from https://doi.org/10.7910/DVN/FVCGHC</span></span>
<span><span class="va">candidate_parties</span> <span class="op">&lt;-</span> <span class="fu">read_stata</span><span class="op">(</span><span class="st">"data/conjoint_data.dta"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">as_factor</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>female <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">orig_cand_gender_string</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>female <span class="op">=</span> <span class="fu">fct_relevel</span><span class="op">(</span><span class="va">female</span>, <span class="st">"Male"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>party_respondent <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span></span>
<span>    <span class="va">democrat_respondent</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="st">"Democrat"</span>,</span>
<span>    <span class="va">republican_respondent</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="st">"Republican"</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>party_respondent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">party_respondent</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">sample</span> <span class="op">==</span> <span class="st">"usa voter"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">mm_diffs</span><span class="op">(</span></span>
<span>  <span class="va">candidate_parties</span>,</span>
<span>  <span class="va">winner</span> <span class="op">~</span> <span class="va">female</span>,</span>
<span>  by <span class="op">=</span> <span class="op">~</span><span class="va">party_respondent</span></span>
<span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">estimate</span>, y <span class="op">=</span> <span class="va">level</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_pointrange</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span></span>
<span>    xmin <span class="op">=</span> <span class="va">lower</span>, xmax <span class="op">=</span> <span class="va">upper</span>, </span>
<span>    color <span class="op">=</span> <span class="st">"Republican marginal mean − Democrat marginal mean"</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="va">label_pp</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="st">"#85144b"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Difference in marginal means"</span>,</span>
<span>    y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    color <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"Difference in marginal means between\nRepublican and Democratic respondents"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"Positive differences = Republicans prefer the level"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="st">"Candidate sex"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>    legend.justification <span class="op">=</span> <span class="st">"left"</span>,</span>
<span>    legend.margin <span class="op">=</span> <span class="fu">margin</span><span class="op">(</span>l <span class="op">=</span> <span class="op">-</span><span class="fl">7</span>, t <span class="op">=</span> <span class="op">-</span><span class="fl">5</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-diff-mm-parties-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>(For more about this, see <span class="citation" data-cites="LeeperHoboltTilley:2020">Leeper, Hobolt, and Tilley (<a href="#ref-LeeperHoboltTilley:2020" role="doc-biblioref">2020</a>)</span> for a few other examples of the substantive differences between subgroup conditional AMCEs and subgroup differences-between-marginal-means.)</p>
<p><strong>Long story short</strong>: because AMCEs are relative estimands, they get weird (and can’t really be used) when using them for descriptive estimands across subgroups or when controlling for other respondent characteristics. To account for this weirdness, calculate marginal means instead and find the subgroup differences in marginal means for each level.</p>
</section></section><section id="sec-frequentist" class="level1 page-columns page-full"><h1>Finding conjoint AMCEs and marginal means frequentistly</h1>
<p>So now that we know what these two estimands are actually measuring and we have a general sense for how to calculate them (AMCE = regression coefficients where there’s an omitted reference category; marginal means = conditional averages for different category levels), let’s replicate the results from the candidate experiment in <span class="citation" data-cites="HainmuellerHopkinsYamamoto:2014">Hainmueller, Hopkins, and Yamamoto (<a href="#ref-HainmuellerHopkinsYamamoto:2014" role="doc-biblioref">2014</a>)</span>. We’ll do it the easy automatic way with <a href="https://thomasleeper.com/cregg/">Thomas Leeper’s {cregg} package</a> (named after <a href="https://en.wikipedia.org/wiki/C._J._Cregg">CJ Cregg from <em>The West Wing</em></a>), then we’ll do it more manually to see what’s going on behind the scenes.</p>
<section id="amces" class="level2"><h2 class="anchored" data-anchor-id="amces">AMCEs</h2>
<p>First we’ll calculate the average marginal component effects (AMCEs), which are the partial derivatives (or coefficients) from a linear regression model. These represent the <em>causal</em> effect of switching from some reference level to a level of interest, while holding everything else constant.</p>
<section id="automatic-estimates-with-creggamce" class="level3"><h3 class="anchored" data-anchor-id="automatic-estimates-with-creggamce">Automatic estimates with <code>cregg::amce()</code>
</h3>
<p>The <code>amce()</code> function from {cregg} calculates AMCEs automatically and returns them in a nice tidy data frame:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_candidate_amce</span> <span class="op">&lt;-</span> <span class="fu">amce</span><span class="op">(</span></span>
<span>  <span class="va">candidate</span>,</span>
<span>  <span class="va">selected</span> <span class="op">~</span> <span class="va">atmilitary</span> <span class="op">+</span> <span class="va">atreligion</span> <span class="op">+</span> <span class="va">ated</span> <span class="op">+</span></span>
<span>    <span class="va">atprof</span> <span class="op">+</span> <span class="va">atinc</span> <span class="op">+</span> <span class="va">atrace</span> <span class="op">+</span> <span class="va">atage</span> <span class="op">+</span> <span class="va">atmale</span>,</span>
<span>  id <span class="op">=</span> <span class="op">~</span><span class="va">resID</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_candidate_amce</span> <span class="op">%&gt;%</span> <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 40 × 10</span></span>
<span><span class="co">##    outcome  statistic feature          level                  estimate std.error      z            p   lower   upper</span></span>
<span><span class="co">##    &lt;chr&gt;    &lt;chr&gt;     &lt;fct&gt;            &lt;fct&gt;                     &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;        &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;</span></span>
<span><span class="co">##  1 selected amce      Military Service Did Not Serve            0        NA      NA     NA           NA      NA     </span></span>
<span><span class="co">##  2 selected amce      Military Service Served                   0.0873    0.0177  4.95   0.000000761  0.0527  0.122 </span></span>
<span><span class="co">##  3 selected amce      Religion         None                     0        NA      NA     NA           NA      NA     </span></span>
<span><span class="co">##  4 selected amce      Religion         Jewish                  -0.0373    0.0263 -1.42   0.156       -0.0889  0.0143</span></span>
<span><span class="co">##  5 selected amce      Religion         Catholic                -0.0156    0.0278 -0.561  0.575       -0.0702  0.0389</span></span>
<span><span class="co">##  6 selected amce      Religion         Mainline protestant     -0.0149    0.0308 -0.484  0.629       -0.0753  0.0455</span></span>
<span><span class="co">##  7 selected amce      Religion         Evangelical protestant  -0.117     0.0309 -3.78   0.000157    -0.178  -0.0563</span></span>
<span><span class="co">##  8 selected amce      Religion         Mormon                  -0.137     0.0307 -4.46   0.00000838  -0.197  -0.0767</span></span>
<span><span class="co">##  9 selected amce      College          No BA                    0        NA      NA     NA           NA      NA     </span></span>
<span><span class="co">## 10 selected amce      College          Baptist college          0.139     0.0289  4.82   0.00000143   0.0827  0.196 </span></span>
<span><span class="co">## # ℹ 30 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It also provides an automatic plot function. Compare this with the original—the results are identical.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist">
<li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true"><code>plot(cregg::amce())</code></a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">Original AMCE coefficent plot</a></li>
</ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model_candidate_amce</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">guides</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_nice</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"AMCEs from cregg::amce()"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-amce-automatic-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<p>Right panel of Figure 1 in <span class="citation" data-cites="LeeperHoboltTilley:2020">Leeper, Hobolt, and Tilley (<a href="#ref-LeeperHoboltTilley:2020" role="doc-biblioref">2020</a>)</span>:</p>
<img src="img/SVG/leeper-et-al-2019_fig1_amces.svg" width="100%" onerror="this.src='img/3x/leeper-et-al-2019_fig1_amces@3x.png'; this.onerror=null">
</div>
</div>
</div>
</section><section id="ols-coefficients" class="level3"><h3 class="anchored" data-anchor-id="ols-coefficients">OLS coefficients</h3>
<p>Behind the scenes, {cregg} uses <code>survey::svyglm()</code> to run OLS with ID-specific adjustments to standard errors:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">candidate_svy_design</span> <span class="op">&lt;-</span> <span class="fu">svydesign</span><span class="op">(</span></span>
<span>  ids <span class="op">=</span> <span class="op">~</span><span class="va">resID</span>,</span>
<span>  weights <span class="op">=</span> <span class="op">~</span><span class="fl">1</span>,</span>
<span>  data <span class="op">=</span> <span class="va">candidate</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_svy</span> <span class="op">&lt;-</span> <span class="fu">svyglm</span><span class="op">(</span></span>
<span>  <span class="va">selected</span> <span class="op">~</span> <span class="va">atmilitary</span> <span class="op">+</span> <span class="va">atreligion</span> <span class="op">+</span> <span class="va">ated</span> <span class="op">+</span></span>
<span>    <span class="va">atprof</span> <span class="op">+</span> <span class="va">atinc</span> <span class="op">+</span> <span class="va">atrace</span> <span class="op">+</span> <span class="va">atage</span> <span class="op">+</span> <span class="va">atmale</span>,</span>
<span>  design <span class="op">=</span> <span class="va">candidate_svy_design</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_svy</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 33 × 5</span></span>
<span><span class="co">##    term                             estimate std.error statistic  p.value</span></span>
<span><span class="co">##    &lt;chr&gt;                               &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">##  1 (Intercept)                        0.397     0.0484     8.20  9.18e-15</span></span>
<span><span class="co">##  2 atmilitaryServed                   0.0873    0.0177     4.95  1.32e- 6</span></span>
<span><span class="co">##  3 atreligionJewish                  -0.0373    0.0263    -1.42  1.58e- 1</span></span>
<span><span class="co">##  4 atreligionCatholic                -0.0156    0.0278    -0.561 5.75e- 1</span></span>
<span><span class="co">##  5 atreligionMainline protestant     -0.0149    0.0308    -0.484 6.29e- 1</span></span>
<span><span class="co">##  6 atreligionEvangelical protestant  -0.117     0.0309    -3.78  1.92e- 4</span></span>
<span><span class="co">##  7 atreligionMormon                  -0.137     0.0307    -4.46  1.22e- 5</span></span>
<span><span class="co">##  8 atedBaptist college                0.139     0.0289     4.82  2.36e- 6</span></span>
<span><span class="co">##  9 atedCommunity college              0.150     0.0290     5.17  4.44e- 7</span></span>
<span><span class="co">## 10 atedState university               0.188     0.0277     6.77  7.80e-11</span></span>
<span><span class="co">## # ℹ 23 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>These estimates and standard errors are the same results that we get from <code>cregg::amce()</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Combine the estimates from cregg::amce() with the estimates from</span></span>
<span><span class="co"># survey::svglm() just to check that they're the same (they are)</span></span>
<span><span class="va">amce_estimates</span> <span class="op">&lt;-</span> <span class="va">model_candidate_amce</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">drop_na</span><span class="op">(</span><span class="va">std.error</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">level</span>, amce_estimate <span class="op">=</span> <span class="va">estimate</span>, amce_std.error <span class="op">=</span> <span class="va">std.error</span><span class="op">)</span></span>
<span></span>
<span><span class="va">svy_estimates</span> <span class="op">&lt;-</span> <span class="va">model_svy</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">tidy</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">term</span> <span class="op">!=</span> <span class="st">"(Intercept)"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span>svy_estimate <span class="op">=</span> <span class="va">estimate</span>, svy_std.error <span class="op">=</span> <span class="va">std.error</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">bind_cols</span><span class="op">(</span><span class="va">amce_estimates</span>, <span class="va">svy_estimates</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 32 × 5</span></span>
<span><span class="co">##    level                  amce_estimate amce_std.error svy_estimate svy_std.error</span></span>
<span><span class="co">##    &lt;fct&gt;                          &lt;dbl&gt;          &lt;dbl&gt;        &lt;dbl&gt;         &lt;dbl&gt;</span></span>
<span><span class="co">##  1 Served                        0.0873         0.0177       0.0873        0.0177</span></span>
<span><span class="co">##  2 Jewish                       -0.0373         0.0263      -0.0373        0.0263</span></span>
<span><span class="co">##  3 Catholic                     -0.0156         0.0278      -0.0156        0.0278</span></span>
<span><span class="co">##  4 Mainline protestant          -0.0149         0.0308      -0.0149        0.0308</span></span>
<span><span class="co">##  5 Evangelical protestant       -0.117          0.0309      -0.117         0.0309</span></span>
<span><span class="co">##  6 Mormon                       -0.137          0.0307      -0.137         0.0307</span></span>
<span><span class="co">##  7 Baptist college               0.139          0.0289       0.139         0.0289</span></span>
<span><span class="co">##  8 Community college             0.150          0.0290       0.150         0.0290</span></span>
<span><span class="co">##  9 State university              0.188          0.0277       0.188         0.0277</span></span>
<span><span class="co">## 10 Small college                 0.178          0.0273       0.178         0.0273</span></span>
<span><span class="co">## # ℹ 22 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="marginal-effects-instead-of-coefficients" class="level3"><h3 class="anchored" data-anchor-id="marginal-effects-instead-of-coefficients">Marginal effects instead of coefficients</h3>
<p>So these OLS coefficients here are the AMCEs. That’s super straightforward.</p>
<p>That’s only true because we’re estimating a <a href="https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/index.html#linear-probability-models">linear probability model (LPM)</a> here. <code>selected</code> is a binary 0/1 variable, but we’re pretending it’s numeric and using OLS with it. In this special case, the marginal effects (slopes) are just the partial derivatives reported in the regression table.</p>
<p>But if we’re going to have interaction terms, or nonlinear terms (like polynomials), or if we’re going to use a model family that’s not OLS (like logistic regression), raw coefficients won’t work. Instead we need to calculate actual marginal effects (see <a href="https://www.andrewheiss.com/blog/2022/05/20/marginalia/">this post</a> and the <a href="https://vincentarelbundock.github.io/marginaleffects/articles/marginaleffects.html">“Get Started” page at the {marginaleffects} documentation</a> for more details about these).</p>
<p>At one point, {cregg} supported this by using the {margins} package (which makes sense—<a href="https://thomasleeper.com/">Thomas Leeper</a> developed both {cregg} and {margins}), but <a href="https://github.com/leeper/cregg/blob/main/NEWS.md#cregg-0114">starting with {cregg} version 0.1.14</a>, the {margins} support disappeared, leaving only support for OLS linear probability models.</p>
<p>We can use the <a href="https://vincentarelbundock.github.io/marginaleffects/">{marginaleffects} package</a> (the successor to {margins}) to calculate the average marginal effects/slopes for each of these effects. Here we’ll just hold all the predictors at their means (but there are <a href="https://www.andrewheiss.com/blog/2022/05/20/marginalia/#tldr-overall-summary-of-all-these-marginal-effects-approaches">a ton of different estimands</a> we could calculate). In this case they’re the same as the raw coefficients, since it’s just a linear model:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mfx_svy</span> <span class="op">&lt;-</span> <span class="va">model_svy</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">avg_slopes</span><span class="op">(</span>newdata <span class="op">=</span> <span class="st">"mean"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Combine the average marginal effects with the original coefficients just to</span></span>
<span><span class="co"># check that they're the same (they are)</span></span>
<span><span class="va">mfx_svy</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">contrast</span>, mfx_estimate <span class="op">=</span> <span class="va">estimate</span>, mfx_std.error <span class="op">=</span> <span class="va">std.error</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">svy_estimates</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 32 × 5</span></span>
<span><span class="co">##    contrast                      mfx_estimate mfx_std.error svy_estimate svy_std.error</span></span>
<span><span class="co">##    &lt;chr&gt;                                &lt;dbl&gt;         &lt;dbl&gt;        &lt;dbl&gt;         &lt;dbl&gt;</span></span>
<span><span class="co">##  1 45 - 36                            0.0259         0.0295       0.0873        0.0177</span></span>
<span><span class="co">##  2 52 - 36                            0.0236         0.0303      -0.0373        0.0263</span></span>
<span><span class="co">##  3 60 - 36                            0.00414        0.0288      -0.0156        0.0278</span></span>
<span><span class="co">##  4 68 - 36                           -0.0639         0.0294      -0.0149        0.0308</span></span>
<span><span class="co">##  5 75 - 36                           -0.146          0.0289      -0.117         0.0309</span></span>
<span><span class="co">##  6 Baptist college - No BA            0.139          0.0289      -0.137         0.0307</span></span>
<span><span class="co">##  7 Community college - No BA          0.150          0.0290       0.139         0.0289</span></span>
<span><span class="co">##  8 Ivy League university - No BA      0.269          0.0291       0.150         0.0290</span></span>
<span><span class="co">##  9 Small college - No BA              0.178          0.0273       0.188         0.0277</span></span>
<span><span class="co">## 10 State university - No BA           0.188          0.0277       0.178         0.0273</span></span>
<span><span class="co">## # ℹ 22 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="coefficient-plots" class="level3"><h3 class="anchored" data-anchor-id="coefficient-plots">Coefficient plots</h3>
<p>What about that neat coefficient plot with the reference categories? <code>tidy()</code> can’t return empty rows for the reference levels like <code>cregg::amce()</code> does, but we can make it work in a couple different ways: (1) automatically with <code>broom.helpers::tidy_add_reference_rows()</code>, or (2) manually with some data wrangling.</p>
<section id="automatically-with-broom.helpers" class="level4"><h4 class="anchored" data-anchor-id="automatically-with-broom.helpers">Automatically with {broom.helpers}</h4>
<p>The easiest way to do this is to use <code>broom.helpers::tidy_add_reference_rows()</code>, which adds the reference levels automatically with estimates of 0, so we can use <code>geom_pointrange()</code> and make basically the same plot as {cregg}:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">plot_data_manual</span> <span class="op">&lt;-</span> <span class="va">model_svy</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">tidy_and_attach</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">tidy_add_reference_rows</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">tidy_add_estimate_to_reference_rows</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">term</span> <span class="op">!=</span> <span class="st">"(Intercept)"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>term_nice <span class="op">=</span> <span class="fu">str_remove</span><span class="op">(</span><span class="va">term</span>, <span class="va">variable</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">variable_lookup</span>, by <span class="op">=</span> <span class="fu">join_by</span><span class="op">(</span><span class="va">variable</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">term_nice</span>, <span class="va">variable_nice</span><span class="op">)</span>, <span class="op">~</span><span class="fu">fct_inorder</span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span></span>
<span>  <span class="va">plot_data_manual</span>,</span>
<span>  <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">estimate</span>, y <span class="op">=</span> <span class="va">term_nice</span>, color <span class="op">=</span> <span class="va">variable_nice</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_pointrange</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xmin <span class="op">=</span> <span class="va">conf.low</span>, xmax <span class="op">=</span> <span class="va">conf.high</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="va">label_pp</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Percentage point change in probability of candidate selection"</span>,</span>
<span>    y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"AMCEs plotted with tidy_add_reference_rows()"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Automatically resize each facet height with ggforce::facet_col()</span></span>
<span>  <span class="fu">facet_col</span><span class="op">(</span>facets <span class="op">=</span> <span class="st">"variable_nice"</span>, scales <span class="op">=</span> <span class="st">"free_y"</span>, space <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-amce-broom-helper-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
</section><section id="manually-with-dplyr-wrangling-magic" class="level4"><h4 class="anchored" data-anchor-id="manually-with-dplyr-wrangling-magic">Manually with {dplyr} wrangling magic</h4>
<p>However, <code>tidy_add_reference_rows()</code> doesn’t work with {marginaleffects} objects or multilevel models or Bayesian models, so ultimately I can’t use this in the real project I’m working on :(</p>
<p>But we can get the same thing with some fancy data wrangling:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Extract all the right-hand variables</span></span>
<span><span class="va">rhs_vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/allnames.html">all.vars</a></span><span class="op">(</span><span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/formula.html">formula</a></span><span class="op">(</span><span class="va">model_svy</span><span class="op">)</span>, <span class="fl">0</span> <span class="op">~</span> <span class="va">.</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Make a data frame of all the levels of all the non-numeric things</span></span>
<span><span class="va">model_variable_levels</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span></span>
<span>  variable <span class="op">=</span> <span class="va">rhs_vars</span></span>
<span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>levels <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">variable</span>, <span class="op">~</span><span class="op">{</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">candidate</span><span class="op">[[</span><span class="va">.x</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">is.numeric</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="st">""</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">is.factor</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">unnest</span><span class="op">(</span><span class="va">levels</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>term <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">variable</span>, <span class="va">levels</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract model results</span></span>
<span><span class="va">model_results</span> <span class="op">&lt;-</span> <span class="fu">tidy</span><span class="op">(</span><span class="va">model_svy</span>, conf.int <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Combine full dataset of factor levels with model results</span></span>
<span><span class="va">plot_data</span> <span class="op">&lt;-</span> <span class="va">model_variable_levels</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">model_results</span>, by <span class="op">=</span> <span class="fu">join_by</span><span class="op">(</span><span class="va">term</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co"># Make these zero</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    <span class="fu">across</span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">estimate</span>, <span class="va">conf.low</span>, <span class="va">conf.high</span><span class="op">)</span>,</span>
<span>      <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span>, <span class="fl">0</span>, <span class="va">.x</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">term</span> <span class="op">!=</span> <span class="st">"(Intercept)"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">variable_lookup</span>, by <span class="op">=</span> <span class="fu">join_by</span><span class="op">(</span><span class="va">variable</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">levels</span>, <span class="va">variable_nice</span><span class="op">)</span>, <span class="op">~</span><span class="fu">fct_inorder</span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span></span>
<span>  <span class="va">plot_data</span>,</span>
<span>  <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">estimate</span>, y <span class="op">=</span> <span class="va">levels</span>, color <span class="op">=</span> <span class="va">variable_nice</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_pointrange</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xmin <span class="op">=</span> <span class="va">conf.low</span>, xmax <span class="op">=</span> <span class="va">conf.high</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="va">label_pp</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Percentage point change in probability of candidate selection"</span>,</span>
<span>    y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"AMCEs from fancy data wrangling"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_col</span><span class="op">(</span>facets <span class="op">=</span> <span class="st">"variable_nice"</span>, scales <span class="op">=</span> <span class="st">"free_y"</span>, space <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-amce-tidy-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>The process is a little different with marginal effects because the <code>term</code> column is for the overarching variable (e.g., <code>taxrate1</code>) and the individual levels are built as contrasts in a column named <code>contrast</code>, like <code>"&lt;10k: 5% - &lt;10k: 0%"</code>. We need to clean up that <code>contrast</code> column for joining with <code>model_variable_levels</code>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Extract marginal effects</span></span>
<span><span class="va">model_results_mfx</span> <span class="op">&lt;-</span> <span class="va">model_svy</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">avg_slopes</span><span class="op">(</span>newdata <span class="op">=</span> <span class="st">"mean"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">separate_wider_delim</span><span class="op">(</span></span>
<span>    <span class="va">contrast</span>,</span>
<span>    delim <span class="op">=</span> <span class="st">" - "</span>, </span>
<span>    names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"variable_level"</span>, <span class="st">"reference_level"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Combine full dataset of factor levels with marginal effects</span></span>
<span><span class="va">plot_data_mfx</span> <span class="op">&lt;-</span> <span class="va">model_variable_levels</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span></span>
<span>    <span class="va">model_results_mfx</span>,</span>
<span>    by <span class="op">=</span> <span class="fu">join_by</span><span class="op">(</span><span class="va">variable</span> <span class="op">==</span> <span class="va">term</span>, <span class="va">levels</span> <span class="op">==</span> <span class="va">variable_level</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co"># Make these zero</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    <span class="fu">across</span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">estimate</span>, <span class="va">conf.low</span>, <span class="va">conf.high</span><span class="op">)</span>,</span>
<span>      <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span>, <span class="fl">0</span>, <span class="va">.x</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">variable_lookup</span>, by <span class="op">=</span> <span class="fu">join_by</span><span class="op">(</span><span class="va">variable</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">levels</span>, <span class="va">variable_nice</span><span class="op">)</span>, <span class="op">~</span><span class="fu">fct_inorder</span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span></span>
<span>  <span class="va">plot_data_mfx</span>,</span>
<span>  <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">estimate</span>, y <span class="op">=</span> <span class="va">levels</span>, color <span class="op">=</span> <span class="va">variable_nice</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_pointrange</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xmin <span class="op">=</span> <span class="va">conf.low</span>, xmax <span class="op">=</span> <span class="va">conf.high</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="va">label_pp</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Percentage point change in probability of candidate selection"</span>,</span>
<span>    y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"AMCEs from OLS marginal effects"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_col</span><span class="op">(</span>facets <span class="op">=</span> <span class="st">"variable_nice"</span>, scales <span class="op">=</span> <span class="st">"free_y"</span>, space <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-amce-mfx-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
</section></section><section id="logistic-regression-instead-of-ols" class="level3"><h3 class="anchored" data-anchor-id="logistic-regression-instead-of-ols">Logistic regression instead of OLS</h3>
<p>What if you don’t want use a linear probability model and instead want to use a different family like logistic regression (which treats the outcome as actual 0 and 1 categories instead of numbers)? Or what if you have 3+ possible choices for outcomes and need to use a multinomial logistic regression model? We can still calculate AMCEs, but we can’t use raw regression coefficients. Instead we have to calculate response-scale (i.e.&nbsp;probability scale) marginal effects.</p>
<p>Let’s make a logistic regression model:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_logit</span> <span class="op">&lt;-</span> <span class="fu">survey</span><span class="fu">::</span><span class="fu">svyglm</span><span class="op">(</span></span>
<span>  <span class="va">selected</span> <span class="op">~</span> <span class="va">atmilitary</span> <span class="op">+</span> <span class="va">atreligion</span> <span class="op">+</span> <span class="va">ated</span> <span class="op">+</span></span>
<span>    <span class="va">atprof</span> <span class="op">+</span> <span class="va">atinc</span> <span class="op">+</span> <span class="va">atrace</span> <span class="op">+</span> <span class="va">atage</span> <span class="op">+</span> <span class="va">atmale</span>,</span>
<span>  design <span class="op">=</span> <span class="va">candidate_svy_design</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">binomial</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"logit"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Check out those sweet sweet uninterpretable log odds:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_logit</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 33 × 5</span></span>
<span><span class="co">##    term                             estimate std.error statistic  p.value</span></span>
<span><span class="co">##    &lt;chr&gt;                               &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">##  1 (Intercept)                       -0.466     0.215     -2.17  3.07e- 2</span></span>
<span><span class="co">##  2 atmilitaryServed                   0.385     0.0775     4.96  1.22e- 6</span></span>
<span><span class="co">##  3 atreligionJewish                  -0.162     0.116     -1.40  1.62e- 1</span></span>
<span><span class="co">##  4 atreligionCatholic                -0.0651    0.123     -0.531 5.96e- 1</span></span>
<span><span class="co">##  5 atreligionMainline protestant     -0.0634    0.136     -0.468 6.40e- 1</span></span>
<span><span class="co">##  6 atreligionEvangelical protestant  -0.510     0.137     -3.72  2.44e- 4</span></span>
<span><span class="co">##  7 atreligionMormon                  -0.600     0.137     -4.39  1.64e- 5</span></span>
<span><span class="co">##  8 atedBaptist college                0.619     0.131      4.74  3.43e- 6</span></span>
<span><span class="co">##  9 atedCommunity college              0.663     0.131      5.06  7.73e- 7</span></span>
<span><span class="co">## 10 atedState university               0.828     0.126      6.57  2.43e-10</span></span>
<span><span class="co">## # ℹ 23 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can convert these log odds into probability-scale marginal effects with <code>slopes()</code> or <code>avg_slopes()</code> from {marginaleffects}. Conceptually this involves plugging in different covariate values—here we’re plugging in all the original values in the data into the model and then collapsing the predictions into averages. (Again, <a href="https://www.andrewheiss.com/blog/2022/05/20/marginalia/#tldr-overall-summary-of-all-these-marginal-effects-approaches">see this</a> and <a href="https://vincentarelbundock.github.io/marginaleffects/articles/slopes.html">this</a> for more details about average marginal effects/slopes.)</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mfx_logit</span> <span class="op">&lt;-</span> <span class="va">model_logit</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">avg_slopes</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mfx_logit</span> <span class="op">%&gt;%</span> <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 32 × 8</span></span>
<span><span class="co">##    term  contrast                      estimate std.error statistic  p.value conf.low conf.high</span></span>
<span><span class="co">##    &lt;chr&gt; &lt;chr&gt;                            &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">##  1 atage 45 - 36                        0.0258     0.0296     0.874 3.82e- 1  -0.0321   0.0838 </span></span>
<span><span class="co">##  2 atage 52 - 36                        0.0232     0.0303     0.765 4.44e- 1  -0.0362   0.0826 </span></span>
<span><span class="co">##  3 atage 60 - 36                        0.00406    0.0289     0.141 8.88e- 1  -0.0526   0.0607 </span></span>
<span><span class="co">##  4 atage 68 - 36                       -0.0639     0.0294    -2.17  3.00e- 2  -0.122   -0.00619</span></span>
<span><span class="co">##  5 atage 75 - 36                       -0.145      0.0289    -5.03  4.86e- 7  -0.202   -0.0888 </span></span>
<span><span class="co">##  6 ated  Baptist college - No BA        0.140      0.0290     4.82  1.45e- 6   0.0828   0.196  </span></span>
<span><span class="co">##  7 ated  Community college - No BA      0.150      0.0291     5.15  2.56e- 7   0.0928   0.207  </span></span>
<span><span class="co">##  8 ated  Ivy League university - No BA  0.269      0.0291     9.26  2.11e-20   0.212    0.326  </span></span>
<span><span class="co">##  9 ated  Small college - No BA          0.178      0.0274     6.50  8.07e-11   0.124    0.231  </span></span>
<span><span class="co">## 10 ated  State university - No BA       0.188      0.0277     6.80  1.04e-11   0.134    0.243  </span></span>
<span><span class="co">## # ℹ 22 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>heck yes these percentage-point-scale estimates are basically the same as what we get from the LPM model!</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Extract marginal effects</span></span>
<span><span class="va">model_results_logit_mfx</span> <span class="op">&lt;-</span> <span class="va">mfx_logit</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">separate_wider_delim</span><span class="op">(</span></span>
<span>    <span class="va">contrast</span>,</span>
<span>    delim <span class="op">=</span> <span class="st">" - "</span>, </span>
<span>    names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"variable_level"</span>, <span class="st">"reference_level"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Combine full dataset of factor levels with marginal effects</span></span>
<span><span class="va">plot_data_logit_mfx</span> <span class="op">&lt;-</span> <span class="va">model_variable_levels</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span></span>
<span>    <span class="va">model_results_logit_mfx</span>,</span>
<span>    by <span class="op">=</span> <span class="fu">join_by</span><span class="op">(</span><span class="va">variable</span> <span class="op">==</span> <span class="va">term</span>, <span class="va">levels</span> <span class="op">==</span> <span class="va">variable_level</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co"># Make these zero</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    <span class="fu">across</span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">estimate</span>, <span class="va">conf.low</span>, <span class="va">conf.high</span><span class="op">)</span>,</span>
<span>      <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span>, <span class="fl">0</span>, <span class="va">.x</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">variable_lookup</span>, by <span class="op">=</span> <span class="fu">join_by</span><span class="op">(</span><span class="va">variable</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">levels</span>, <span class="va">variable_nice</span><span class="op">)</span>, <span class="op">~</span><span class="fu">fct_inorder</span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span></span>
<span>  <span class="va">plot_data_logit_mfx</span>,</span>
<span>  <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">estimate</span>, y <span class="op">=</span> <span class="va">levels</span>, color <span class="op">=</span> <span class="va">variable_nice</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_pointrange</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xmin <span class="op">=</span> <span class="va">conf.low</span>, xmax <span class="op">=</span> <span class="va">conf.high</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="va">label_pp</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Percentage point change in probability of candidate selection"</span>,</span>
<span>    y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"AMCEs from logistic regression marginal effects"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_col</span><span class="op">(</span>facets <span class="op">=</span> <span class="st">"variable_nice"</span>, scales <span class="op">=</span> <span class="st">"free_y"</span>, space <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-amce-mfx-logit-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
</section></section><section id="marginal-means-1" class="level2"><h2 class="anchored" data-anchor-id="marginal-means-1">Marginal means</h2>
<p>Next we’ll calculate marginal means for these different attributes and levels, which are conditional averages and not regression coefficients. These are <em>descriptive</em> estimands/quantities of interest and they don’t rely on any reference category or baseline level.</p>
<section id="automatic-estimates-with-creggmm" class="level3"><h3 class="anchored" data-anchor-id="automatic-estimates-with-creggmm">Automatic estimates with <code>cregg::mm()</code>
</h3>
<p>The <code>mm()</code> function from {cregg} calculates marginal means automatically and returns them in a nice tidy data frame. I include the package namespace prefix here (i.e.&nbsp;<code>cregg::mm()</code> instead of just <code>mm()</code>) because I’ve loaded the {brms} package and it has its own <code>mm()</code> function that’s used for creating multi-membership grouping terms (whatever those are).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">candidate_mms_auto</span> <span class="op">&lt;-</span> <span class="fu">cregg</span><span class="fu">::</span><span class="fu">mm</span><span class="op">(</span></span>
<span>  <span class="va">candidate</span>,</span>
<span>  <span class="va">selected</span> <span class="op">~</span> <span class="va">atmilitary</span> <span class="op">+</span> <span class="va">atreligion</span> <span class="op">+</span> <span class="va">ated</span> <span class="op">+</span></span>
<span>    <span class="va">atprof</span> <span class="op">+</span> <span class="va">atinc</span> <span class="op">+</span> <span class="va">atrace</span> <span class="op">+</span> <span class="va">atage</span> <span class="op">+</span> <span class="va">atmale</span>,</span>
<span>  id <span class="op">=</span> <span class="op">~</span> <span class="va">resID</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">candidate_mms_auto</span> <span class="op">%&gt;%</span> <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 40 × 10</span></span>
<span><span class="co">##    outcome  statistic feature          level                  estimate std.error     z         p lower upper</span></span>
<span><span class="co">##    &lt;chr&gt;    &lt;chr&gt;     &lt;fct&gt;            &lt;fct&gt;                     &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">##  1 selected mm        Military Service Did Not Serve             0.458   0.00907  50.5 0         0.440 0.475</span></span>
<span><span class="co">##  2 selected mm        Military Service Served                    0.543   0.00914  59.4 0         0.525 0.560</span></span>
<span><span class="co">##  3 selected mm        Religion         None                      0.556   0.0200   27.8 1.88e-170 0.517 0.595</span></span>
<span><span class="co">##  4 selected mm        Religion         Jewish                    0.520   0.0186   28.0 2.77e-172 0.484 0.557</span></span>
<span><span class="co">##  5 selected mm        Religion         Catholic                  0.526   0.0177   29.7 2.82e-193 0.491 0.560</span></span>
<span><span class="co">##  6 selected mm        Religion         Mainline protestant       0.543   0.0194   28.0 3.93e-172 0.505 0.581</span></span>
<span><span class="co">##  7 selected mm        Religion         Evangelical protestant    0.437   0.0200   21.9 4.11e-106 0.398 0.476</span></span>
<span><span class="co">##  8 selected mm        Religion         Mormon                    0.417   0.0194   21.5 7.40e-103 0.379 0.455</span></span>
<span><span class="co">##  9 selected mm        College          No BA                     0.340   0.0186   18.3 1.12e- 74 0.303 0.376</span></span>
<span><span class="co">## 10 selected mm        College          Baptist college           0.482   0.0200   24.1 3.89e-128 0.443 0.521</span></span>
<span><span class="co">## # ℹ 30 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist">
<li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" role="tab" aria-controls="tabset-2-1" aria-selected="true"><code>plot(cregg::mm())</code></a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" role="tab" aria-controls="tabset-2-2" aria-selected="false">Original AMCE coefficent plot</a></li>
</ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-2-1-tab">
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">candidate_mms_auto</span>, vline <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">guides</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_nice</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Marginal means from from cregg::mm()"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-mm-automatic-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-2-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-2-tab">
<p>Left panel of Figure 1 in <span class="citation" data-cites="LeeperHoboltTilley:2020">Leeper, Hobolt, and Tilley (<a href="#ref-LeeperHoboltTilley:2020" role="doc-biblioref">2020</a>)</span>:</p>
<img src="img/SVG/leeper-et-al-2019_fig1_mms.svg" width="100%" onerror="this.src='img/3x/leeper-et-al-2019_fig1_mms@3x.png'; this.onerror=null">
</div>
</div>
</div>
</section><section id="quick-and-dirty-marginal-means" class="level3"><h3 class="anchored" data-anchor-id="quick-and-dirty-marginal-means">Quick-and-dirty marginal means</h3>
<p>Marginal means are just conditional group averages, so we can actually get the same estimates with some basic {dplyr} grouping and summarizing. I’ll just show the averages for military and religion here for the sake of space, but the averages are the same as what we get with <code>cregg::mm()</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">candidate</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">atmilitary</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>avg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">selected</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 2 × 2</span></span>
<span><span class="co">##   atmilitary      avg</span></span>
<span><span class="co">##   &lt;fct&gt;         &lt;dbl&gt;</span></span>
<span><span class="co">## 1 Did Not Serve 0.458</span></span>
<span><span class="co">## 2 Served        0.543</span></span>
<span></span>
<span><span class="va">candidate</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">atreligion</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>avg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">selected</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 6 × 2</span></span>
<span><span class="co">##   atreligion               avg</span></span>
<span><span class="co">##   &lt;fct&gt;                  &lt;dbl&gt;</span></span>
<span><span class="co">## 1 None                   0.556</span></span>
<span><span class="co">## 2 Jewish                 0.520</span></span>
<span><span class="co">## 3 Catholic               0.526</span></span>
<span><span class="co">## 4 Mainline protestant    0.543</span></span>
<span><span class="co">## 5 Evangelical protestant 0.437</span></span>
<span><span class="co">## 6 Mormon                 0.417</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Behind the scenes, <code>cregg::mm()</code> creates simple intercept-less models for each of the categorical terms in the model and then returns their coefficients. Again, for the sake of space, here are the regression-based averages for just military and religion:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">bind_rows</span><span class="op">(</span></span>
<span>  <span class="fu">tidy</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">selected</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">atmilitary</span>, data <span class="op">=</span> <span class="va">candidate</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu">tidy</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">selected</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">atreligion</span>, data <span class="op">=</span> <span class="va">candidate</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 8 × 5</span></span>
<span><span class="co">##   term                             estimate std.error statistic   p.value</span></span>
<span><span class="co">##   &lt;chr&gt;                               &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 atmilitaryDid Not Serve             0.458    0.0120      38.3 1.16e-267</span></span>
<span><span class="co">## 2 atmilitaryServed                    0.543    0.0120      45.3 0        </span></span>
<span><span class="co">## 3 atreligionNone                      0.556    0.0205      27.1 3.39e-147</span></span>
<span><span class="co">## 4 atreligionJewish                    0.520    0.0208      25.0 9.62e-127</span></span>
<span><span class="co">## 5 atreligionCatholic                  0.526    0.0205      25.6 1.34e-132</span></span>
<span><span class="co">## 6 atreligionMainline protestant       0.543    0.0209      26.0 1.36e-136</span></span>
<span><span class="co">## 7 atreligionEvangelical protestant    0.437    0.0209      20.9 1.53e- 91</span></span>
<span><span class="co">## 8 atreligionMormon                    0.417    0.0207      20.2 8.15e- 86</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Regardless of how we calculate them, we can see that these estimates are just group averages. 46% of respondents chose candidates who didn’t serve in the military; 54% chose candidates who did; and so on.</p>
</section><section id="marginal-means-with-marginaleffects" class="level3"><h3 class="anchored" data-anchor-id="marginal-means-with-marginaleffects">Marginal means with {marginaleffects}</h3>
<p>Combining a bunch of smaller <code>group_by() %&gt;% summarize()</code> datasets, or combining a bunch of intercept-less models involves a bit of extra code and can get tedious. Plus it can get more complex when not using a linear model, or if you want interaction terms, or if you want group averages across multiple groups (i.e.&nbsp;average proportions for military across Republican and Democratic respondents). Additionally, the standard errors from these basic averages are wrong since they don’t take into account the nested structure of the data (i.e.&nbsp;respondents each have 6–12 responses).</p>
<p>To make life easier and more flexible, we can use <code>marginal_means()</code> from {marginaleffects} to calculate the unique categorical group means from a regression model.</p>
<section id="how-marginal_means-works" class="level4"><h4 class="anchored" data-anchor-id="how-marginal_means-works">How <code>marginal_means()</code> works</h4>
<p>But first we need to look at a quick example to build the intuition behind what happens with <code>marginal_means()</code>. First we’ll make a simpler regresison model with just the military and religion features. We’ll then calculate predicted values for all the levels of those features using <code>predictions()</code>—this essentially involves plugging in all the unique values of <code>atmilitary</code> and <code>atreligion</code> into the model and finding the predicted values. We’ll then reshape the results a little so that we can see the average proportions of religion conditional on military service:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_candidate_simple</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span></span>
<span>  <span class="va">selected</span> <span class="op">~</span> <span class="va">atmilitary</span> <span class="op">+</span> <span class="va">atreligion</span>, </span>
<span>  data <span class="op">=</span> <span class="va">candidate</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">predictions_simple</span> <span class="op">&lt;-</span> <span class="fu">predictions</span><span class="op">(</span></span>
<span>  <span class="va">model_candidate_simple</span>,</span>
<span>  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"atreligion"</span>, <span class="st">"atmilitary"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">predictions_simple_wide</span> <span class="op">&lt;-</span> <span class="va">predictions_simple</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">estimate</span>, <span class="va">atmilitary</span>, <span class="va">atreligion</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="st">"atmilitary"</span>, values_from <span class="op">=</span> <span class="st">"estimate"</span><span class="op">)</span></span>
<span><span class="va">predictions_simple_wide</span></span>
<span><span class="co">## # A tibble: 6 × 3</span></span>
<span><span class="co">##   atreligion             `Did Not Serve` Served</span></span>
<span><span class="co">##   &lt;fct&gt;                            &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span><span class="co">## 1 None                             0.514  0.598</span></span>
<span><span class="co">## 2 Jewish                           0.479  0.563</span></span>
<span><span class="co">## 3 Catholic                         0.483  0.567</span></span>
<span><span class="co">## 4 Mainline protestant              0.500  0.584</span></span>
<span><span class="co">## 5 Evangelical protestant           0.394  0.478</span></span>
<span><span class="co">## 6 Mormon                           0.376  0.460</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Great. The average proportion for non-military Mormons is 37.6% and for military Mormons is 46%, and so on.</p>
<p>If we find the average of these averages and add a column and row in the literal right and bottom margins of the table, we’ll have marginal means of religion and military service:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">predictions_simple_wide</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>`Religion marginal mean` <span class="op">=</span> <span class="op">(</span><span class="va">`Did Not Serve`</span> <span class="op">+</span> <span class="va">Served</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">add_row</span><span class="op">(</span></span>
<span>    atreligion <span class="op">=</span> <span class="st">"Military marginal mean"</span>, </span>
<span>    `Did Not Serve` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">predictions_simple_wide</span><span class="op">$</span><span class="va">`Did Not Serve`</span><span class="op">)</span>,</span>
<span>    Served <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">predictions_simple_wide</span><span class="op">$</span><span class="va">Served</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">## # A tibble: 7 × 4</span></span>
<span><span class="co">##   atreligion             `Did Not Serve` Served `Religion marginal mean`</span></span>
<span><span class="co">##   &lt;chr&gt;                            &lt;dbl&gt;  &lt;dbl&gt;                    &lt;dbl&gt;</span></span>
<span><span class="co">## 1 None                             0.514  0.598                    0.556</span></span>
<span><span class="co">## 2 Jewish                           0.479  0.563                    0.521</span></span>
<span><span class="co">## 3 Catholic                         0.483  0.567                    0.525</span></span>
<span><span class="co">## 4 Mainline protestant              0.500  0.584                    0.542</span></span>
<span><span class="co">## 5 Evangelical protestant           0.394  0.478                    0.436</span></span>
<span><span class="co">## 6 Mormon                           0.376  0.460                    0.418</span></span>
<span><span class="co">## 7 Military marginal mean           0.458  0.542                   NA</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To me this is wild. The marginal mean for Mormons is 41%, which is basically what we found with <code>group_by(atreligion) %&gt;% summarize()</code> earlier. The marginal mean for candidates who served in the military is 54.2%, again roughly the same as what we found with <code>group_by(atmilitary) %&gt;% summarize(...)</code>.</p>
<p>Instead of manually creating these marginal rows and columns, the <code>marginal_means()</code> function will find those values automatically for us, based on a grid of values (in <code>newdata</code>) that it’ll plug into the model. Here it’ll plug all combinations of <code>atreligion</code> and <code>atmilitary</code> into the simple model. The <code>wts = "cells"</code> argument here makes it so that the marginal mean is weighted by the actual distribution of the levels of religion and military. For instance, imagine that only 30% of rows served in the military and 70% did not. Calculating the average of those two averages by just doing <code>(Did Not Serve + Served) / 2</code> wouldn’t take that underlying distribution into account. Weighting by cells make it so that <code>marginal_means()</code> computes a weighted marginal mean proportional to each level’s frequency in the original data.</p>
<p>Let’s let <code>marginal_means()</code> work its magic:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">marginal_means_simple</span> <span class="op">&lt;-</span> <span class="fu">marginal_means</span><span class="op">(</span></span>
<span>  <span class="va">model_candidate_simple</span>,</span>
<span>  newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"atreligion"</span>, <span class="st">"atmilitary"</span><span class="op">)</span>,</span>
<span>  wts <span class="op">=</span> <span class="st">"cells"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">marginal_means_simple</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##        Term                  Value  Mean Std. Error    z Pr(&gt;|z|) 2.5 % 97.5 %</span></span>
<span><span class="co">##  atmilitary Did Not Serve          0.458     0.0119 38.5   &lt;0.001 0.434  0.481</span></span>
<span><span class="co">##  atmilitary Served                 0.543     0.0119 45.5   &lt;0.001 0.519  0.566</span></span>
<span><span class="co">##  atreligion None                   0.556     0.0204 27.2   &lt;0.001 0.516  0.596</span></span>
<span><span class="co">##  atreligion Jewish                 0.520     0.0208 25.1   &lt;0.001 0.479  0.561</span></span>
<span><span class="co">##  atreligion Catholic               0.526     0.0205 25.7   &lt;0.001 0.485  0.566</span></span>
<span><span class="co">##  atreligion Mainline protestant    0.543     0.0208 26.1   &lt;0.001 0.502  0.584</span></span>
<span><span class="co">##  atreligion Evangelical protestant 0.437     0.0208 21.0   &lt;0.001 0.396  0.477</span></span>
<span><span class="co">##  atreligion Mormon                 0.417     0.0206 20.3   &lt;0.001 0.377  0.458</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Results averaged over levels of: atmilitary, atreligion </span></span>
<span><span class="co">## Columns: term, value, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Et voilà, the averages here are basically the same as what we found in the manual version we did earlier. The only differences are due to the weighted averaging—by default <code>marginal_means()</code> assumes equal weights in the columns, so it’s literally going to just calculate <code>(Did Not Serve + Served) / 2</code>. With <code>wts = "cells"</code>, it creates a weighted average: <code>(Did Not Serve * cell_weight + Served * other_cell_weight) / 2</code>.</p>
</section><section id="marginal_means-with-the-full-actual-model" class="level4"><h4 class="anchored" data-anchor-id="marginal_means-with-the-full-actual-model">
<code>marginal_means()</code> with the full actual model</h4>
<p>Now that we understand what’s happening with <code>marginal_means()</code>, we can use it with the full <code>model_svy</code> model. We’ll find the marginal means for all the different features and make sure that we weight by cells so that we get weighted averages. Because there are so many combinations of attribute levels here, it takes a while to run:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/create-mm-mfx_d52969d33f342207792d6db0095acc4c">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># This takes a while...</span></span>
<span><span class="fu">tictoc</span><span class="fu">::</span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">mm_mfx</span> <span class="op">&lt;-</span> <span class="fu">marginal_means</span><span class="op">(</span></span>
<span>  <span class="va">model_svy</span>, </span>
<span>  newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"atmilitary"</span>, <span class="st">"atreligion"</span>, <span class="st">"ated"</span>, <span class="st">"atprof"</span>, </span>
<span>    <span class="st">"atinc"</span>, <span class="st">"atrace"</span>, <span class="st">"atage"</span>, <span class="st">"atmale"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  wts <span class="op">=</span> <span class="st">"cells"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu">tictoc</span><span class="fu">::</span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">## 82.563 sec elapsed</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The results are identical to what we find when using <code>group_by() %&gt;% summarize()</code>, but</p>
<ol type="1">
<li>the standard errors are correct (and actually present; we’d need to calculate those on our own with <code>summarize()</code> and that’s a pain), and</li>
<li>we have the ability to use other extra {marginaleffects} things like hypothesis tests, counterfactual estimates, p-value adjustments for multiple comparisons, clustered robust standard errors, and so on</li>
</ol>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist">
<li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-3-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-1" role="tab" aria-controls="tabset-3-1" aria-selected="true"><code>marginal_means()</code></a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-2" role="tab" aria-controls="tabset-3-2" aria-selected="false"><code>group_by() %&gt;% summarize()</code></a></li>
</ul>
<div class="tab-content">
<div id="tabset-3-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-3-1-tab">
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mm_mfx</span> <span class="op">%&gt;%</span> <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 40 × 8</span></span>
<span><span class="co">##    term       value                  estimate std.error statistic   p.value conf.low conf.high</span></span>
<span><span class="co">##    &lt;chr&gt;      &lt;fct&gt;                     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">##  1 atmilitary Did Not Serve             0.458   0.00913      50.1 0            0.440     0.476</span></span>
<span><span class="co">##  2 atmilitary Served                    0.543   0.00928      58.4 0            0.524     0.561</span></span>
<span><span class="co">##  3 atreligion None                      0.556   0.0195       28.5 1.64e-178    0.518     0.594</span></span>
<span><span class="co">##  4 atreligion Jewish                    0.520   0.0175       29.7 1.90e-194    0.486     0.554</span></span>
<span><span class="co">##  5 atreligion Catholic                  0.526   0.0177       29.7 3.14e-193    0.491     0.560</span></span>
<span><span class="co">##  6 atreligion Mainline protestant       0.543   0.0184       29.6 1.86e-192    0.507     0.579</span></span>
<span><span class="co">##  7 atreligion Evangelical protestant    0.437   0.0198       22.0 1.07e-107    0.398     0.475</span></span>
<span><span class="co">##  8 atreligion Mormon                    0.417   0.0189       22.1 8.22e-108    0.380     0.454</span></span>
<span><span class="co">##  9 ated       No BA                     0.340   0.0184       18.5 5.02e- 76    0.304     0.376</span></span>
<span><span class="co">## 10 ated       Baptist college           0.482   0.0198       24.4 1.63e-131    0.443     0.521</span></span>
<span><span class="co">## # ℹ 30 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-3-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-2-tab">
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">candidate</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">atmilitary</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>avg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">selected</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 2 × 2</span></span>
<span><span class="co">##   atmilitary      avg</span></span>
<span><span class="co">##   &lt;fct&gt;         &lt;dbl&gt;</span></span>
<span><span class="co">## 1 Did Not Serve 0.458</span></span>
<span><span class="co">## 2 Served        0.543</span></span>
<span></span>
<span><span class="va">candidate</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">atreligion</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>avg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">selected</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 6 × 2</span></span>
<span><span class="co">##   atreligion               avg</span></span>
<span><span class="co">##   &lt;fct&gt;                  &lt;dbl&gt;</span></span>
<span><span class="co">## 1 None                   0.556</span></span>
<span><span class="co">## 2 Jewish                 0.520</span></span>
<span><span class="co">## 3 Catholic               0.526</span></span>
<span><span class="co">## 4 Mainline protestant    0.543</span></span>
<span><span class="co">## 5 Evangelical protestant 0.437</span></span>
<span><span class="co">## 6 Mormon                 0.417</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>Since there’s no reference level to deal with, plotting these these marginal means is pretty straightforward:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">plot_mm_mfx</span> <span class="op">&lt;-</span> <span class="va">mm_mfx</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>value <span class="op">=</span> <span class="fu">fct_inorder</span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">variable_lookup</span>, by <span class="op">=</span> <span class="fu">join_by</span><span class="op">(</span><span class="va">term</span> <span class="op">==</span> <span class="va">variable</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">value</span>, <span class="va">variable_nice</span><span class="op">)</span>, <span class="op">~</span><span class="fu">fct_inorder</span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span></span>
<span>  <span class="va">plot_mm_mfx</span>,</span>
<span>  <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">estimate</span>, y <span class="op">=</span> <span class="va">value</span>, color <span class="op">=</span> <span class="va">variable_nice</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_pointrange</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xmin <span class="op">=</span> <span class="va">conf.low</span>, xmax <span class="op">=</span> <span class="va">conf.high</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_percent</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Marginal mean"</span>,</span>
<span>    y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"Marginal means with marginaleffects::marginal_means()"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_col</span><span class="op">(</span>facets <span class="op">=</span> <span class="st">"variable_nice"</span>, scales <span class="op">=</span> <span class="st">"free_y"</span>, space <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/taxes-mm-plot-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
</section></section></section><section id="subgroup-differences-in-amces-and-marginal-means" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="subgroup-differences-in-amces-and-marginal-means">Subgroup differences in AMCEs and marginal means</h2>
<p><span class="citation" data-cites="HainmuellerHopkinsYamamoto:2014">Hainmueller, Hopkins, and Yamamoto (<a href="#ref-HainmuellerHopkinsYamamoto:2014" role="doc-biblioref">2014</a>)</span> did not include any individual respondent-level characteristics in their data, so we can’t look at how these causal effects differ across individual traits like party identification (Republicans and Democrats) or education or income or anything else like that.</p>
<p>So instead we’ll invent a pretend column for respondent-level party ID! To simplify life, we’ll look at differences between fake-party-ID within the military service history attribute. Arbitrarily (and super stereotypically), we’ll say that if a respondent selected a candidate more than 60% of the time when seeing that they had served in the military, there’s a 90% chance they’re a Republican. If they didn’t select the military candidate 60% of the time, there’s a 75% chance they’re a Democrat. AGAIN THESE PROBABILITIES ARE COMPLETELY ARBITRARY AND JUST CAME FROM MY HEAD—THEY ARE NOT REAL. We’ll make a new dataset called <code>candidate_fake</code> with a column named <code>respondent_party</code> for each respondent’s fake party:</p>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Code for generating fake <code>respondent_party</code> column</summary><div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Wrap this in withr::with_seed() so that the randomness is reproducible but the</span></span>
<span><span class="co"># overall document seed doesn't get set or messed up</span></span>
<span><span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_seed.html">with_seed</a></span><span class="op">(</span><span class="fl">1234</span>, <span class="op">{</span></span>
<span>  <span class="va">respondents_party_military</span> <span class="op">&lt;-</span> <span class="va">candidate</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">resID</span>, <span class="va">atmilitary</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co"># Find the proportion of times each respondent selected the candidate when</span></span>
<span>    <span class="co"># military service history was "Served"</span></span>
<span>    <span class="fu">summarize</span><span class="op">(</span>prob_select <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">selected</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">atmilitary</span> <span class="op">==</span> <span class="st">"Served"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">atmilitary</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co"># If a respondent selected the candidate more than 60% of the time when</span></span>
<span>    <span class="co"># seeing that they had served in the military, there's a 90% chance they're</span></span>
<span>    <span class="co"># a Republican. If they didn't select the military candidate 60% of the</span></span>
<span>    <span class="co"># time, there's a 75% chance they're a Democrat.</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>respondent_party <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span></span>
<span>      <span class="va">prob_select</span> <span class="op">&gt;=</span> <span class="fl">0.6</span> <span class="op">~</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Democrat"</span>, <span class="st">"Republican"</span><span class="op">)</span>, <span class="fu">n</span><span class="op">(</span><span class="op">)</span>,</span>
<span>          replace <span class="op">=</span> <span class="cn">TRUE</span>, prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.9</span><span class="op">)</span></span>
<span>        <span class="op">)</span>,</span>
<span>      <span class="va">prob_select</span> <span class="op">&lt;</span> <span class="fl">0.6</span> <span class="op">~</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Democrat"</span>, <span class="st">"Republican"</span><span class="op">)</span>, <span class="fu">n</span><span class="op">(</span><span class="op">)</span>,</span>
<span>          replace <span class="op">=</span> <span class="cn">TRUE</span>, prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.75</span>, <span class="fl">0.25</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>    <span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>respondent_party <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">respondent_party</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">candidate_fake</span> <span class="op">&lt;-</span> <span class="va">candidate</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">respondents_party_military</span>, by <span class="op">=</span> <span class="fu">join_by</span><span class="op">(</span><span class="va">resID</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s check the average of <code>selected</code> across both the candidate military attribute and our new fake respondent party to see how all that random assignment shook out:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">candidate_fake</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">atmilitary</span>, <span class="va">respondent_party</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>avg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">selected</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 4 × 3</span></span>
<span><span class="co">## # Groups:   atmilitary [2]</span></span>
<span><span class="co">##   atmilitary    respondent_party   avg</span></span>
<span><span class="co">##   &lt;fct&gt;         &lt;fct&gt;            &lt;dbl&gt;</span></span>
<span><span class="co">## 1 Did Not Serve Democrat         0.551</span></span>
<span><span class="co">## 2 Did Not Serve Republican       0.378</span></span>
<span><span class="co">## 3 Served        Democrat         0.447</span></span>
<span><span class="co">## 4 Served        Republican       0.619</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Cool cool. Republican respondents are way more favorable towards candidates who served in the military (61.9%) than Democratic respondents (44.8%). And that kind of interpretation is actually mathematically and conceptually legal and recommended by <span class="citation" data-cites="LeeperHoboltTilley:2020">Leeper, Hobolt, and Tilley (<a href="#ref-LeeperHoboltTilley:2020" role="doc-biblioref">2020</a>)</span>—technically these are subgroup marginal means and what we should be looking at for descriptive purposes already, but more on that below.</p>
<section id="conditional-amces" class="level4"><h4 class="anchored" data-anchor-id="conditional-amces">Conditional AMCEs</h4>
<p>Let’s first look at the two different party-based causal effects of switching a candidate from having no military history to having served in the military. For the sake of simplicity we’ll just use regular OLS instead of logistic regression, and we’ll use <code>marginaleffects::avg_slopes()</code> to find the marginal since the regression model involves interaction terms. We’ll also only look at the <code>atmilitary</code> feature instead of all the features, since it’s the only one where we built in a party effect.</p>
<p>We can find conditional AMCEs with {cregg} using the <code>cj()</code> function, which is a general function for all of the different estimands that {cregg} can calculate:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">cregg</span><span class="fu">::</span><span class="fu">cj</span><span class="op">(</span></span>
<span>  <span class="va">candidate_fake</span>, </span>
<span>  <span class="va">selected</span> <span class="op">~</span> <span class="va">atmilitary</span>, </span>
<span>  id <span class="op">=</span> <span class="op">~</span><span class="va">resID</span>, </span>
<span>  estimate <span class="op">=</span> <span class="st">"amce"</span>, </span>
<span>  by <span class="op">=</span> <span class="op">~</span><span class="va">respondent_party</span></span>
<span><span class="op">)</span></span>
<span><span class="co">##           BY  outcome statistic          feature         level estimate std.error      z         p   lower    upper respondent_party</span></span>
<span><span class="co">## 1   Democrat selected      amce Military Service Did Not Serve   0.0000        NA     NA        NA      NA       NA         Democrat</span></span>
<span><span class="co">## 2   Democrat selected      amce Military Service        Served  -0.1032   0.02063 -5.003 5.655e-07 -0.1437 -0.06278         Democrat</span></span>
<span><span class="co">## 3 Republican selected      amce Military Service Did Not Serve   0.0000        NA     NA        NA      NA       NA       Republican</span></span>
<span><span class="co">## 4 Republican selected      amce Military Service        Served   0.2405   0.02246 10.710 9.095e-27  0.1965  0.28455       Republican</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can do the same thing using regression if we use an interaction term for the subgroup:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_military_party</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span></span>
<span>  <span class="va">selected</span> <span class="op">~</span> <span class="va">atmilitary</span> <span class="op">*</span> <span class="va">respondent_party</span>, </span>
<span>  data <span class="op">=</span> <span class="va">candidate_fake</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_military_party</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 4 × 5</span></span>
<span><span class="co">##   term                                        estimate std.error statistic   p.value</span></span>
<span><span class="co">##   &lt;chr&gt;                                          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 (Intercept)                                    0.551    0.0174     31.7  7.90e-194</span></span>
<span><span class="co">## 2 atmilitaryServed                              -0.103    0.0248     -4.16 3.21e-  5</span></span>
<span><span class="co">## 3 respondent_partyRepublican                    -0.172    0.0236     -7.28 3.97e- 13</span></span>
<span><span class="co">## 4 atmilitaryServed:respondent_partyRepublican    0.344    0.0335     10.3  2.48e- 24</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Those coefficients by themselves aren’t super informative without doing some tricky algebra to piece everything together. Instead, we can use <code>avg_slopes()</code> from {marginaleffects} to find the partial derivative (or AMCE) for <code>atmilitary</code> across each party. These are the same results we get from {cregg}:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">party_amces</span> <span class="op">&lt;-</span> <span class="va">model_military_party</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">avg_slopes</span><span class="op">(</span></span>
<span>    variables <span class="op">=</span> <span class="st">"atmilitary"</span>,</span>
<span>    by <span class="op">=</span> <span class="st">"respondent_party"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">party_amces</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##        Term                           Contrast respondent_party Estimate Std. Error     z Pr(&gt;|z|)  2.5 %  97.5 %</span></span>
<span><span class="co">##  atmilitary mean(Served) - mean(Did Not Serve)       Democrat     -0.103     0.0248 -4.16   &lt;0.001 -0.152 -0.0546</span></span>
<span><span class="co">##  atmilitary mean(Served) - mean(Did Not Serve)       Republican    0.241     0.0226 10.66   &lt;0.001  0.196  0.2847</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Columns: term, contrast, respondent_party, estimate, std.error, statistic, p.value, conf.low, conf.high, predicted, predicted_hi, predicted_lo</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Click to show the code since it’s so long; you can make a quick basic version of it with two calls to <code>plot(amce(...))</code>—one on data filtered to only include Democrats and one that only includes Republicans</summary><div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Clean up marginal effects</span></span>
<span><span class="va">party_amces_mfx</span> <span class="op">&lt;-</span> <span class="va">party_amces</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co"># The contrast column contains values like this:</span></span>
<span>  <span class="co">#   mean(Served) - mean(Did Not Serve)</span></span>
<span>  <span class="co"># I could probably use some fancy regex to extract those things, but here I'll</span></span>
<span>  <span class="co"># just brute force it and remove "mean(" and ")" with two separate</span></span>
<span>  <span class="co"># str_remove()s</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    contrast <span class="op">=</span> <span class="fu">str_remove_all</span><span class="op">(</span><span class="va">contrast</span>, <span class="st">"mean\\("</span><span class="op">)</span>,</span>
<span>    contrast <span class="op">=</span> <span class="fu">str_remove_all</span><span class="op">(</span><span class="va">contrast</span>, <span class="st">"\\)"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">separate_wider_delim</span><span class="op">(</span></span>
<span>    <span class="va">contrast</span>,</span>
<span>    delim <span class="op">=</span> <span class="st">" - "</span>, </span>
<span>    names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"variable_level"</span>, <span class="st">"reference_level"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Combine full dataset of factor levels with marginal effects</span></span>
<span><span class="va">plot_amces_party_mfx</span> <span class="op">&lt;-</span> <span class="fu">expand_grid</span><span class="op">(</span></span>
<span>  respondent_party <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">candidate_fake</span><span class="op">$</span><span class="va">respondent_party</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">model_variable_levels</span>, <span class="va">variable</span> <span class="op">==</span> <span class="st">"atmilitary"</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span></span>
<span>    <span class="va">party_amces_mfx</span>,</span>
<span>    by <span class="op">=</span> <span class="fu">join_by</span><span class="op">(</span><span class="va">variable</span> <span class="op">==</span> <span class="va">term</span>, <span class="va">levels</span> <span class="op">==</span> <span class="va">variable_level</span>, <span class="va">respondent_party</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co"># Make these zero</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    <span class="fu">across</span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">estimate</span>, <span class="va">conf.low</span>, <span class="va">conf.high</span><span class="op">)</span>,</span>
<span>      <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span>, <span class="fl">0</span>, <span class="va">.x</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">variable_lookup</span>, by <span class="op">=</span> <span class="fu">join_by</span><span class="op">(</span><span class="va">variable</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">levels</span>, <span class="va">variable_nice</span><span class="op">)</span>, <span class="op">~</span><span class="fu">fct_inorder</span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>estimate_nice <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span></span>
<span>    <span class="va">estimate</span> <span class="op">!=</span> <span class="fl">0</span> <span class="op">~</span> <span class="fu">label_amce</span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span>,</span>
<span>    <span class="va">estimate</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="cn">NA</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p_mfx</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span></span>
<span>  <span class="va">plot_amces_party_mfx</span>, </span>
<span>  <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">estimate</span>, y <span class="op">=</span> <span class="va">levels</span>, color <span class="op">=</span> <span class="va">respondent_party</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_pointrange</span><span class="op">(</span></span>
<span>    <span class="fu">aes</span><span class="op">(</span>xmin <span class="op">=</span> <span class="va">conf.low</span>, xmax <span class="op">=</span> <span class="va">conf.high</span><span class="op">)</span>,</span>
<span>    position <span class="op">=</span> <span class="fu">position_dodge</span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.15</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_label</span><span class="op">(</span></span>
<span>    <span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">estimate_nice</span><span class="op">)</span>, </span>
<span>    position <span class="op">=</span> <span class="fu">position_dodge</span><span class="op">(</span>width <span class="op">=</span> <span class="op">-</span><span class="fl">1.2</span><span class="op">)</span>,</span>
<span>    size <span class="op">=</span> <span class="fl">3.5</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="va">label_pp</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">parties</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Percentage point change in probability of candidate selection"</span>,</span>
<span>    y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    color <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"AMCEs by respondent party"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">variable_nice</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>    legend.justification <span class="op">=</span> <span class="st">"left"</span>,</span>
<span>    legend.margin <span class="op">=</span> <span class="fu">margin</span><span class="op">(</span>l <span class="op">=</span> <span class="op">-</span><span class="fl">7</span>, t <span class="op">=</span> <span class="op">-</span><span class="fl">5</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">p_mfx</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-mfx-party-amce-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>These have a straightforward causal interpretation. Among Democratic-identifying respondents, flipping a hypothetical candidate’s military status from “did not serve” to “serve” causes a 10 percentage point drop in favorability (or in the probability of being selected). Among Republican-identifying respondents, a candidate’s military service causes a 24 percentage point increase in favorability. Both effects are statistically significantly different from zero.</p>
</section><section id="conditional-marginal-means" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="conditional-marginal-means">Conditional marginal means</h3>
<p>If we’re describing overall trends in the data, though, these conditional AMCEs are misleading. It’s really tempting to look at this and conclude that there’s a 34ish percentage point difference between Democrats and Republicans when they’re presented with a candidate with military service, since that’s the distance between the two AMCEs in the plot. <strong>But that’s wrong!</strong> That distance is an illusion—a mirage caused by the fact that the AMCEs are based on a reference category that is set to zero.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">p_mfx</span> <span class="op">+</span></span>
<span>  <span class="fu">annotate</span><span class="op">(</span></span>
<span>    geom <span class="op">=</span> <span class="st">"errorbar"</span>,</span>
<span>    x <span class="op">=</span> <span class="fl">0</span>, xmin <span class="op">=</span> <span class="op">-</span><span class="fl">0.103</span>, xmax <span class="op">=</span> <span class="fl">0.241</span>, y <span class="op">=</span> <span class="fl">2</span>,</span>
<span>    width <span class="op">=</span> <span class="fl">0.1</span>, color <span class="op">=</span> <span class="st">"black"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">annotate</span><span class="op">(</span></span>
<span>    geom <span class="op">=</span> <span class="st">"label"</span>, </span>
<span>    x <span class="op">=</span> <span class="fl">0.241</span> <span class="op">-</span> <span class="op">(</span><span class="fl">0.241</span> <span class="op">-</span> <span class="op">-</span><span class="fl">0.103</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span>, y <span class="op">=</span> <span class="fl">2</span>,</span>
<span>    label <span class="op">=</span> <span class="st">"This difference isn't\nwhat you think it is!"</span>, </span>
<span>    size <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">annotate</span><span class="op">(</span></span>
<span>    geom <span class="op">=</span> <span class="st">"segment"</span>,</span>
<span>    x <span class="op">=</span> <span class="fl">0.05</span>, xend <span class="op">=</span> <span class="fl">0.01</span>, y <span class="op">=</span> <span class="fl">1</span>, yend <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    arrow <span class="op">=</span> <span class="fu">arrow</span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">30</span>, length <span class="op">=</span> <span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="st">"lines"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">annotate</span><span class="op">(</span></span>
<span>    geom <span class="op">=</span> <span class="st">"label"</span>, </span>
<span>    x <span class="op">=</span> <span class="fl">0</span>, y <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    label <span class="op">=</span> <span class="st">"These 0s mess things up!"</span>, </span>
<span>    size <span class="op">=</span> <span class="fl">5</span>,</span>
<span>    hjust <span class="op">=</span> <span class="op">-</span><span class="fl">0.2</span></span>
<span>  <span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-mfx-party-amce-annotated-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>To get the correct party-based difference in support for candidates, we need to find the party-based marginal means of support for the different levels of the military feature and then talk about <em>those</em> differences. <a href="#marginal-means">As discussed above</a>, this technically just involves finding the conditional averages across groups—in this case the average outcome within the two levels of “Served” and “Did not serve” between Republican and Democratic respondents. We can find these marginal means with some basic <code>group_by() %&gt;% summarize()</code> and the difference between Republican and Democratic marginal means with some pivoting and subtracting:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">party_mms_manual</span> <span class="op">&lt;-</span> <span class="va">candidate_fake</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">atmilitary</span>, <span class="va">respondent_party</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>avg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">selected</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">party_mms_manual</span></span>
<span><span class="co">## # A tibble: 4 × 3</span></span>
<span><span class="co">## # Groups:   atmilitary [2]</span></span>
<span><span class="co">##   atmilitary    respondent_party   avg</span></span>
<span><span class="co">##   &lt;fct&gt;         &lt;fct&gt;            &lt;dbl&gt;</span></span>
<span><span class="co">## 1 Did Not Serve Democrat         0.551</span></span>
<span><span class="co">## 2 Did Not Serve Republican       0.378</span></span>
<span><span class="co">## 3 Served        Democrat         0.447</span></span>
<span><span class="co">## 4 Served        Republican       0.619</span></span>
<span></span>
<span><span class="va">party_mms_manual</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="st">"respondent_party"</span>, values_from <span class="op">=</span> <span class="st">"avg"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>mm_diff <span class="op">=</span> <span class="va">Republican</span> <span class="op">-</span> <span class="va">Democrat</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 2 × 4</span></span>
<span><span class="co">## # Groups:   atmilitary [2]</span></span>
<span><span class="co">##   atmilitary    Democrat Republican mm_diff</span></span>
<span><span class="co">##   &lt;fct&gt;            &lt;dbl&gt;      &lt;dbl&gt;   &lt;dbl&gt;</span></span>
<span><span class="co">## 1 Did Not Serve    0.551      0.378  -0.172</span></span>
<span><span class="co">## 2 Served           0.447      0.619   0.172</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Or we can use <code>cregg::cj(..., estimate = "mm_diff")</code> to do that automatically:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">cj</span><span class="op">(</span></span>
<span>  <span class="va">candidate_fake</span>, </span>
<span>  <span class="va">selected</span> <span class="op">~</span> <span class="va">atmilitary</span>, </span>
<span>  id <span class="op">=</span> <span class="op">~</span><span class="va">resID</span>, </span>
<span>  estimate <span class="op">=</span> <span class="st">"mm_diff"</span>, </span>
<span>  by <span class="op">=</span> <span class="op">~</span><span class="va">respondent_party</span></span>
<span><span class="op">)</span></span>
<span><span class="co">##                      BY     statistic  outcome          feature         level estimate std.error      z         p   lower   upper respondent_party</span></span>
<span><span class="co">## 1 Republican - Democrat mm_difference selected Military Service Did Not Serve  -0.1722   0.01531 -11.25 2.361e-29 -0.2022 -0.1422       Republican</span></span>
<span><span class="co">## 2 Republican - Democrat mm_difference selected Military Service        Served   0.1715   0.01574  10.89 1.219e-27  0.1407  0.2024       Republican</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Or, to be extra thorough and allow for any type of regression family (logisitic! multinomial!) with any other types of covariates, we can find these manually with our own regression model fed through <code>marginaleffects::marginal_means()</code>. By specifying <code>cross = TRUE</code>, we get all combinations of military service and party (without it, we’d get separate marginal means for just the two levels of military and the two levels of party).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">party_mms_mfx</span> <span class="op">&lt;-</span> <span class="fu">marginal_means</span><span class="op">(</span></span>
<span>  <span class="va">model_military_party</span>,</span>
<span>  newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"atmilitary"</span>, <span class="st">"respondent_party"</span><span class="op">)</span>,</span>
<span>  cross <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  wts <span class="op">=</span> <span class="st">"cells"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">party_mms_mfx</span> <span class="op">%&gt;%</span> <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 4 × 11</span></span>
<span><span class="co">##   rowid atmilitary    respondent_party estimate std.error statistic   p.value conf.low conf.high selected   wts</span></span>
<span><span class="co">##   &lt;int&gt; &lt;fct&gt;         &lt;fct&gt;               &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">## 1     1 Did Not Serve Democrat            0.551    0.0174      31.7 1.68e-220    0.517     0.585      0.5 0.231</span></span>
<span><span class="co">## 2     2 Did Not Serve Republican          0.378    0.0160      23.6 3.56e-123    0.347     0.410      0.5 0.271</span></span>
<span><span class="co">## 3     3 Served        Democrat            0.447    0.0177      25.3 3.11e-141    0.413     0.482      0.5 0.222</span></span>
<span><span class="co">## 4     4 Served        Republican          0.619    0.0159      39.0 0            0.588     0.650      0.5 0.276</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To find the differences in those marginal means, we could pivot wider and subtract the <code>Democrat</code> column from the <code>Republican</code> column, or we can use the <code>hypothesis</code> argument in <code>marginal_means()</code> to have {marginaleffects} automatically calculate differences between categories for us without needing to pivot. If we were only concerned with one contrast, like Republican − Democrat, we could specify <code>hypothesis = "pairwise"</code> and it would subtract the two groups’ marginal means. However, we want two differences: Republican − Democrat in both the “served” and the “did not serve” levels. As seen above, <code>party_mms_mfx</code> has four rows in it. We want the differences between rows 2 and 1 (Republican − Democrat for “Did not serve”) and between rows 4 and 3 (Republican − Democrat for “Served”). We can control which rows are used when calculating differences with a vector of <a href="https://en.wikipedia.org/wiki/Linear_combination">linear combinations</a>. If we use a vector like <code>c(-1, 1, 0, 0)</code>, {marginaleffects} will essentially make the first row negative, leave the second row as is, and give no weight to (or ignore) the third and fourth row, which will calculate the difference between rows 2 and 1. Similarly, <code>c(0, 0, -1, 1)</code> will ignore rows 1 and 2 and find the difference between row 4 and 3. If we feed <code>marginal_means()</code> a matrix of these two vectors, with each vector as a column, it’ll find the differences for us:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">group_diffs_terms</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span>,</span>
<span>    <span class="fl">0</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  ncol <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">magrittr</span><span class="fu">::</span><span class="fu">set_colnames</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">candidate_fake</span><span class="op">$</span><span class="va">atmilitary</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">group_diffs_terms</span></span>
<span><span class="co">##      Did Not Serve Served</span></span>
<span><span class="co">## [1,]            -1      0</span></span>
<span><span class="co">## [2,]             1      0</span></span>
<span><span class="co">## [3,]             0     -1</span></span>
<span><span class="co">## [4,]             0      1</span></span>
<span></span>
<span><span class="va">party_mms_mfx_diff</span> <span class="op">&lt;-</span> <span class="fu">marginal_means</span><span class="op">(</span></span>
<span>  <span class="va">model_military_party</span>,</span>
<span>  newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"atmilitary"</span>, <span class="st">"respondent_party"</span><span class="op">)</span>,</span>
<span>  cross <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  wts <span class="op">=</span> <span class="st">"cells"</span>,</span>
<span>  hypothesis <span class="op">=</span> <span class="va">group_diffs_terms</span></span>
<span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">party_mms_mfx_diff</span></span>
<span><span class="co">## # A tibble: 2 × 7</span></span>
<span><span class="co">##   term          estimate std.error statistic  p.value conf.low conf.high</span></span>
<span><span class="co">##   &lt;chr&gt;            &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 Did Not Serve   -0.172    0.0236     -7.28 3.22e-13   -0.219    -0.126</span></span>
<span><span class="co">## 2 Served           0.172    0.0238      7.22 5.23e-13    0.125     0.218</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can plot these conditional marginal means along with the party-based differences:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details class="code-fold"><summary>Click to see all the plotting code</summary><div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mm_party_plot1</span> <span class="op">&lt;-</span> <span class="va">party_mms_mfx</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>estimate_nice <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span></span>
<span>    <span class="va">estimate</span> <span class="op">!=</span> <span class="fl">0</span> <span class="op">~</span> <span class="fu">label_percent</span><span class="op">(</span><span class="op">)</span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span>,</span>
<span>    <span class="va">estimate</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="cn">NA</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">estimate</span>, y <span class="op">=</span> <span class="va">atmilitary</span>, color <span class="op">=</span> <span class="va">respondent_party</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_pointrange</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xmin <span class="op">=</span> <span class="va">conf.low</span>, xmax <span class="op">=</span> <span class="va">conf.high</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_label</span><span class="op">(</span></span>
<span>    <span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">estimate_nice</span><span class="op">)</span>, </span>
<span>    position <span class="op">=</span> <span class="fu">position_dodge</span><span class="op">(</span>width <span class="op">=</span> <span class="op">-</span><span class="fl">1.2</span><span class="op">)</span>,</span>
<span>    size <span class="op">=</span> <span class="fl">3.5</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_percent</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">parties</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Marginal means"</span>,</span>
<span>    y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    color <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"Marginal means by respondent party"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="st">"Military"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>    legend.justification <span class="op">=</span> <span class="st">"left"</span>,</span>
<span>    legend.margin <span class="op">=</span> <span class="fu">margin</span><span class="op">(</span>l <span class="op">=</span> <span class="op">-</span><span class="fl">7</span>, t <span class="op">=</span> <span class="op">-</span><span class="fl">5</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">mm_party_plot2</span> <span class="op">&lt;-</span> <span class="va">party_mms_mfx_diff</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>estimate_nice <span class="op">=</span> <span class="fu">label_amce</span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">estimate</span>, y <span class="op">=</span> <span class="va">term</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_pointrange</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span></span>
<span>    xmin <span class="op">=</span> <span class="va">conf.low</span>, xmax <span class="op">=</span> <span class="va">conf.high</span>, </span>
<span>    color <span class="op">=</span> <span class="st">"Republican marginal mean − Democrat marginal mean"</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_label</span><span class="op">(</span></span>
<span>    <span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">estimate_nice</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">3.5</span>,</span>
<span>    nudge_y <span class="op">=</span> <span class="fl">0.3</span>, color <span class="op">=</span> <span class="st">"#85144b"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="va">label_pp</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="st">"#85144b"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Difference in marginal means"</span>,</span>
<span>    y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    color <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"Difference in marginal means by respondent party"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"Positive differences = Republicans prefer the level"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="st">"Military"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>    legend.justification <span class="op">=</span> <span class="st">"left"</span>,</span>
<span>    legend.margin <span class="op">=</span> <span class="fu">margin</span><span class="op">(</span>l <span class="op">=</span> <span class="op">-</span><span class="fl">7</span>, t <span class="op">=</span> <span class="op">-</span><span class="fl">5</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">mm_party_plot1</span> <span class="op">|</span> <span class="va">mm_party_plot2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/plot-mms-party-diffs-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page-right" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>These marginal means have a direct descriptive interpretation. In the left panel above we can see that Democratic respondents tend to prefer candidates that haven’t served in the military (55%) to those that have (45%), but compared to Republican respondents, this divergence isn’t as dramatic. Republicans tend to strongly prefer candidates with a military history, with 62% expressing favorability. In general, Republicans are more extreme in their preferences for and against candidates with and without military service history.</p>
<p>In the right panel we can see the differences between the parties’ marginal means within each level. There’s a 17 percentage point distance between Republican and Democratic marginal means within the served level and a 17 percentage point distance between their marginal means in the did not serve level. Overall, Republicans prefer candidates with military service; Democrats prefer candidates without military service.</p>
</section></section></section><section id="finding-conjoint-amces-and-marginal-means-bayesianly" class="level1 page-columns page-full"><h1>Finding conjoint AMCEs and marginal means Bayesianly</h1>
<p>Now that we know (1) what the AMCE actually is, and (2) that it works with logistic models, we can finally do it all Bayesianly with {brms}.</p>
<p>Why try to do this Bayesianly? <a href="https://www.andrewheiss.com/blog/2023/05/15/fancy-bayes-diffs-props/#why-bayesian-modeling">I don’t like null hypotheses and I don’t like flowcharts</a>.<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a></p>
<div class="no-row-height column-margin column-container"><div id="fn5"><p><sup>5</sup>&nbsp;See <a href="https://www.youtube.com/watch?v=cclUd_HoRlo">this video by Richard McElreath introducing his idea of “statistical rethinking”</a></p></div></div><p>Rather than choose the <a href="https://www.google.com/search?q=statistical+test+flow+chart">exact statistical test in a flowchart</a>, I can compare the posterior distributions of AMCEs or marginal means directly. And rather than define a null hypothesis, I can find the probability that the estimand I care about is different from whatever other value I’m interested in.</p>
<p>But first, a note on the complexity of all this estimation and plotting thus far. In the <a href="#sec-frequentist">“Finding conjoint AMCEs and marginal means frequentistly” section</a> above, I spent a ton of extra time showing how to calculate and plot these estimands multiple ways:</p>
<ul>
<li>find the estimands with <code>cregg::amce()</code>, <code>cregg::mm()</code>, and <code>cregg::cj(..., estimate = "diff_mm")</code>
</li>
<li>find the estimands with {dplyr}’s <code>group_by() %&gt;% summarize()</code>
</li>
<li>find the estimands with OLS regression models like <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> and <code>survey::svyglm()</code> or with logistic models like <code><a href="https://rdrr.io/r/stats/glm.html">glm()</a></code> and <code>survey::svyglm()</code> which are then fed into <code>marginaleffects::avg_slopes()</code> and <code>marginaleffects::marginal_means()</code>
</li>
<li>plot the estimands automatically with <code>plot(cregg::amce(...))</code>
</li>
<li>tidy the estimands with reference levels with <code>broom.helpers::tidy_add_reference_rows()</code> and plot them manually</li>
<li>tidy the estimands with reference levels manually with some {tidyr} and {dplyr} magic and plot them manually</li>
</ul>
<p>We have <a href="https://www.youtube.com/watch?v=kf1bu5sUXaU">a veritable smorgasbord</a> of options!</p>
<p>I did this because I generally like thinking about averages as regressions and prefer to have total control over plotting instead of relying on convenience functions like <code>cregg::amce()</code>. If I were analyzing my own conjoint data in a frequentist way, I’d use regression + {marginaleffects} + manual tidying and plotting.</p>
<p>I also showed all these options becuase if we’re going to calculate these estimands in a Bayesian way, none of the convenience functions like <code>cregg::amce()</code> or <code>broom.helpers::tidy_add_reference_rows()</code> work with Bayesian models, so we have to use the manual approach anyway. And Bayesian models have their own extra dimension of complexity, so we might as well embrace it all. As Richard McElreath says,</p>
<blockquote class="blockquote">
<p>[A]s models become more monstrous, so too does the code needed to compute predictions and display them. <strong>With power comes hardship.</strong> <strong>It’s better to see the guts of the machine than to live in awe or fear of it.</strong> <span class="citation" data-cites="McElreath:2020">(<a href="#ref-McElreath:2020" role="doc-biblioref">McElreath 2020, 391</a>)</span></p>
</blockquote>
<p>yay complexity.</p>
<section id="the-overall-model" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="the-overall-model">The overall model</h2>
<p>The easiest way for me to think about all these estimands is as moving parts (marginal effects or partial derivatives) in a regression model. We can model the whole data-generating system (i.e.&nbsp;all the candidate features and levels + any subgroups or covariates we’re interested in) and then look at individual parts of that system for the different estimands we’re interested in.</p>
<p>Each survey respondent saw multiple pairs of hypothetical candidates—some saw 4, some 5, some 6, and so on:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">candidate</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">count</span><span class="op">(</span><span class="va">resID</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>pairs_seen <span class="op">=</span> <span class="va">n</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 311 × 3</span></span>
<span><span class="co">##    resID              n pairs_seen</span></span>
<span><span class="co">##    &lt;fct&gt;          &lt;int&gt;      &lt;dbl&gt;</span></span>
<span><span class="co">##  1 A10ZOUOZZ3EOAJ    12          6</span></span>
<span><span class="co">##  2 A11F3HMX0N23V4    10          5</span></span>
<span><span class="co">##  3 A12H2RTXSAQPRH     8          4</span></span>
<span><span class="co">##  4 A13DPXX91VQ49Q    12          6</span></span>
<span><span class="co">##  5 A13KTOZC30NBS6    10          5</span></span>
<span><span class="co">##  6 A142W1RAF1TBWP    12          6</span></span>
<span><span class="co">##  7 A15A4X84A1CJPF    12          6</span></span>
<span><span class="co">##  8 A15Q5F9YWO45EI    12          6</span></span>
<span><span class="co">##  9 A1610EPXM31F9D    12          6</span></span>
<span><span class="co">## 10 A1650FELH3UL2F    10          5</span></span>
<span><span class="co">## # ℹ 301 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This means that we have a natural multilevel structure in our data. Individual candidate selection choices are nested inside respondents:</p>
<div class="cell" data-layout-align="center" data-engine.opts="{&quot;extra.preamble&quot;:[&quot;\usepackage{libertine}&quot;,&quot;\usepackage{libertinust1math}&quot;],&quot;dvisvgm.opts&quot;:&quot;--font-format=woff&quot;}">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/respondent-conjoint-structure-1.svg" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption>Multilevel conjoint data structure, with candidate choices <span class="math inline">\(y\)</span> nested in respondents</figcaption></figure>
</div>
</div>
</div>
<p>We want to model candidate selection (<code>selected</code>) based on candidate characteristics (and maybe individual respondent characteristics, if we had those). We’ll use the subscript <span class="math inline">\(i\)</span> to refer to individual candidate choices and <span class="math inline">\(j\)</span> to refer to respondents, which each contain multiple <span class="math inline">\(i\)</span>s.</p>
<p>Since candidate selection <code>selected</code> is binary, we can model it as a Bernoulli process that has a probability <span class="math inline">\(\pi_{i_j}\)</span> of success. We’ll model that <span class="math inline">\(\pi_{i_j}\)</span> using a logistic regression model with covariates for each of the levels of each candidate feature. To account for respondent-level differences in probabilities, we’ll use respondent-specific offsets (<span class="math inline">\(b_{0_j}\)</span>) from the global success rate, thus creating random intercepts. We’ll specify priors for each of the logit-scale coefficients/partial derivatives and the between respondent variability (<span class="math inline">\(\sigma_0\)</span>). If we <em>really</em> wanted we could specify priors for each individual coefficient, but for simplicity we’ll just use a normal distribution with a mean of 0 and a standard deviation of 1 for all of them (<a href="https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/index.html#super-fancy-detailed-model-with-lots-of-moving-parts-just-for-fun">since logit-scale coefficients don’t ever get really big</a>). We’ll use an exponential prior for (<span class="math inline">\(\sigma_0\)</span>) because we don’t know much about it.</p>
<p>Here’s what that all looks like more formally:</p>
<div class="column-screen-inset">
<p><span class="math display">\[
\begin{aligned}
\text{Selection}_{i_j} \sim&amp;\ \operatorname{Bernoulli}(\pi_{i_j}) &amp; \text{Probability of selection for choice}_i \text{ in respondent}_j \\
\operatorname{logit}(\pi_{i_j}) =&amp;\ (\beta_0 + b_{0_j}) + \beta_1\, \text{Military[Served]}_{i_j} + &amp; \text{Model for probability}\\
&amp;\ \beta_2\, \text{Religion[Mormon]}_{i_j} + \\
&amp;\ \beta_3\, \text{Religion[Evangelical]}_{i_j} + \\
&amp;\ \dots +\ \\
&amp;\ \beta_n\, \text{Sex[Female]}_{i_j} \\
b_{0_j} \sim&amp;\ \mathcal{N}(0, \sigma_0) &amp; \text{Respondent-specific offsets from global success rate} \\
\\
\beta_{0_c} \sim&amp;\ \mathcal{N}(0, 1) &amp; \text{Prior for global average success rate} \\
\beta_1 \dots \beta_n \sim&amp;\ \mathcal{N}(0, 1) &amp; \text{Prior for candidate feature levels} \\
\sigma_0 \sim&amp;\ \operatorname{Exponential}(1) &amp; \text{Prior for between-respondent variability}
\end{aligned}
\]</span></p>
</div>
<p>Let’s build the model!</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">priors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>  <span class="fu">prior</span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,</span>
<span>  <span class="fu">prior</span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,</span>
<span>  <span class="fu">prior</span><span class="op">(</span><span class="fu">exponential</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sd</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_brms</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span></span>
<span>  <span class="fu">bf</span><span class="op">(</span><span class="va">selected</span> <span class="op">~</span> <span class="va">atmilitary</span> <span class="op">+</span> <span class="va">atreligion</span> <span class="op">+</span> <span class="va">ated</span> <span class="op">+</span></span>
<span>    <span class="va">atprof</span> <span class="op">+</span> <span class="va">atinc</span> <span class="op">+</span> <span class="va">atrace</span> <span class="op">+</span> <span class="va">atage</span> <span class="op">+</span> <span class="va">atmale</span> <span class="op">+</span></span>
<span>    <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">resID</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">candidate</span>,</span>
<span>  family <span class="op">=</span> <span class="fu">bernoulli</span><span class="op">(</span>link <span class="op">=</span> <span class="st">"logit"</span><span class="op">)</span>,</span>
<span>  prior <span class="op">=</span> <span class="va">priors</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, iter <span class="op">=</span> <span class="fl">2000</span>, seed <span class="op">=</span> <span class="fl">1234</span>,</span>
<span>  backend <span class="op">=</span> <span class="st">"cmdstanr"</span>, threads <span class="op">=</span> <span class="fu">threading</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>, refresh <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  file <span class="op">=</span> <span class="st">"candidate_model_brms"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="amces-1" class="level2"><h2 class="anchored" data-anchor-id="amces-1">AMCEs</h2>
<p>If we’re interested in the causal effect of specific candidate levels, we need to find the average marginal component effect (AMCE). Here’s the formal definition of the no religion → Mormon AMCE, for example:</p>
<p><span class="math display">\[
\begin{aligned}
\theta =\ &amp;P [\text{Candidate selection} \mid \operatorname{do}(\text{Religion} = \text{none})]\ - \\
&amp;P[\text{Candidate selection} \mid \operatorname{do}(\text{Religion} = \text{Mormon})]
\end{aligned}
\]</span></p>
<p>We can find this AMCE (and all the other AMCEs) by calculating the marginal effect/partial derivative of each candidate-level covariate. <code>marginaleffects::avg_slopes()</code> makes this easy and gives us percentage-point-scale estimates instead of logit-scale estimates</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Dealing with respondent offsets
</div>
</div>
<div class="callout-body-container callout-body">
<p>When plugging values into <code>avg_slopes</code> (or <code>predictions()</code> or <code>marginal_means()</code> or any function that calculates predictions from a model), we have to decide how to handle the random respondent offsets (<span class="math inline">\(b_{0_j}\)</span>). <a href="https://www.andrewheiss.com/blog/2022/11/29/conditional-marginal-marginaleffects/#summary">I have a whole other blog post guide about this</a> and how absolutely maddening the nomenclature for all this is.</p>
<p>By default, <code>avg_slopes()</code> and friends will calculate the effects for a typical respondent, or a respondent where the random offset is set to 0. It invisibly uses the <code>re_formula = NA</code> argument to do this. This is also called a <em>conditional effect</em>.</p>
<p>We could also use <code>re_formula = NULL</code> to calculate the effect for respondents on average. This is also called a <em>marginal effect</em>. (ARGH I HATE THESE NAMES.). This estimate includes details from the random offsets, either by integrating them out or by using the mean and standard deviation of the random offsets to generate a simulated average respondent.</p>
<ul>
<li>Conditional effect = average respondent = <code>re_formula = NA</code> (default)</li>
<li>Marginal effect = respondents on average = <code>re_formula = NULL</code> + existing respondent levels or a new simulated respondent</li>
</ul>
<p>Again, <a href="https://www.andrewheiss.com/blog/2022/11/29/conditional-marginal-marginaleffects">see this guide for way more about these distinctions</a>. In this example here, we’ll just use conditional effects, or the effect for an average respondent.</p>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">posterior_mfx</span> <span class="op">&lt;-</span> <span class="va">model_brms</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">avg_slopes</span><span class="op">(</span>newdata <span class="op">=</span> <span class="st">"mean"</span>, allow_new_levels <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">posteriordraws</span><span class="op">(</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">posterior_mfx_nested</span> <span class="op">&lt;-</span> <span class="va">posterior_mfx</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">separate_wider_delim</span><span class="op">(</span></span>
<span>    <span class="va">contrast</span>,</span>
<span>    delim <span class="op">=</span> <span class="st">" - "</span>, </span>
<span>    names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"variable_level"</span>, <span class="st">"reference_level"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">term</span>, <span class="va">variable_level</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">nest</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Combine full dataset of factor levels with model results</span></span>
<span><span class="va">plot_data_bayes</span> <span class="op">&lt;-</span> <span class="va">model_variable_levels</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span></span>
<span>    <span class="va">posterior_mfx_nested</span>,</span>
<span>    by <span class="op">=</span> <span class="fu">join_by</span><span class="op">(</span><span class="va">variable</span> <span class="op">==</span> <span class="va">term</span>, <span class="va">levels</span> <span class="op">==</span> <span class="va">variable_level</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>data <span class="op">=</span> <span class="fu">map_if</span><span class="op">(</span><span class="va">data</span>, <span class="va">is.null</span>, <span class="op">~</span> <span class="fu">tibble</span><span class="op">(</span>draw <span class="op">=</span> <span class="fl">0</span>, estimate <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">unnest</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">variable_lookup</span>, by <span class="op">=</span> <span class="fu">join_by</span><span class="op">(</span><span class="va">variable</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">levels</span>, <span class="va">variable_nice</span><span class="op">)</span>, <span class="op">~</span><span class="fu">fct_inorder</span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">plot_data_bayes</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">draw</span>, y <span class="op">=</span> <span class="va">levels</span>, fill <span class="op">=</span> <span class="va">variable_nice</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span>normalize <span class="op">=</span> <span class="st">"groups"</span><span class="op">)</span> <span class="op">+</span>  <span class="co"># Make the heights of the distributions equal within each facet</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_col</span><span class="op">(</span>facets <span class="op">=</span> <span class="st">"variable_nice"</span>, scales <span class="op">=</span> <span class="st">"free_y"</span>, space <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="va">label_pp</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Percentage point change in probability of candidate selection"</span>,</span>
<span>    y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"Posterior AMCEs"</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/amce-mfx-bayes-plot-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>The results here are all basically the same as what we found with all the frequentist approaches earlier, but now we have full posteriors for each of these AMCEs so we can do all sorts of neat Bayesian inference things, like calculating the probability that the effect is larger than zero. For instance, there’s a 100% posterior probability that the None → Mormon effect is negative. The Business owner → Lawyer effect, on the other hand, is generally negative, but sometimes positive—there’s a 78% posterior probability that it’s negative.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">example_amces</span> <span class="op">&lt;-</span> <span class="va">posterior_mfx</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span></span>
<span>    <span class="va">term</span> <span class="op">==</span> <span class="st">"atreligion"</span> <span class="op">&amp;</span> <span class="va">contrast</span> <span class="op">==</span> <span class="st">"Mormon - None"</span> <span class="op">|</span></span>
<span>    <span class="va">term</span> <span class="op">==</span> <span class="st">"atprof"</span> <span class="op">&amp;</span> <span class="va">contrast</span> <span class="op">==</span> <span class="st">"Lawyer - Business owner"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">example_amces_p_direction</span> <span class="op">&lt;-</span> <span class="va">example_amces</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">contrast</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>prop_lt_0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">draw</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">/</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    prob_nice <span class="op">=</span> <span class="fu">label_percent</span><span class="op">(</span><span class="op">)</span><span class="op">(</span><span class="va">prop_lt_0</span><span class="op">)</span>,</span>
<span>    label <span class="op">=</span> <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"P(θ &lt; 0) = {prob_nice}"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">example_amces</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">draw</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill_ramp <span class="op">=</span> <span class="fu">after_stat</span><span class="op">(</span><span class="va">x</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">"grey50"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_text</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">example_amces_p_direction</span>, </span>
<span>    <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="op">-</span><span class="fl">0.21</span>, y <span class="op">=</span> <span class="fl">0.9</span>, label <span class="op">=</span> <span class="va">label</span><span class="op">)</span>,</span>
<span>    hjust <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="va">label_pp</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_ramp_discrete</span><span class="op">(</span>from <span class="op">=</span> <span class="st">"#FF851B"</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Percentage point change in probability of candidate selection"</span>, </span>
<span>    y <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>    title <span class="op">=</span> <span class="st">"Two example AMCEs"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="fu">fct_rev</span><span class="op">(</span><span class="va">contrast</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    axis.text.y <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"grey90"</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/amce-mfx-bayes-plot-excerpt-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
</section><section id="marginal-means-2" class="level2"><h2 class="anchored" data-anchor-id="marginal-means-2">Marginal means</h2>
<p>Instead of working with causal AMCEs, which are all relative to an omitted feature level, we can work with absolute marginal means to be more descriptive with our estimands. We could find the overall level of favorability of Mormon candidates…</p>
<p><span class="math display">\[
\theta = P(\text{Candidate selection} \mid \text{Religion = Mormon})
\]</span></p>
<p>…or the difference between Mormon and Catholic favorability…</p>
<p><span class="math display">\[
\begin{aligned}
\theta =\ &amp;P[\text{Candidate selection} \mid \text{Religion = Mormon}]\ - \\
&amp;P[\text{Candidate selection} \mid \text{Religion = Catholic}]
\end{aligned}
\]</span></p>
<p>Unfortunately <code>marginaleffects::marginal_means()</code> doesn’t work with brms models. BUT we can fake it by finding the posterior marginal means for each of the features individually and then combining them into one big data frame.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/calc-bayes-mms_97aa3325c164a84a45f00c8f971d0f5b">
<details class="code-fold"><summary>Click to show the code. It’s hidden because it’s long and repetitive.</summary><div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># There's probably a more efficient way to do with with mapping or loops or</span></span>
<span><span class="co"># whatever but I don't want to figure it out right now, so we brute force it</span></span>
<span><span class="va">posterior_mms</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span></span>
<span>  atmilitary <span class="op">=</span> <span class="fu">predictions</span><span class="op">(</span></span>
<span>    <span class="va">model_brms</span>,</span>
<span>    by <span class="op">=</span> <span class="st">"atmilitary"</span>,</span>
<span>    allow_new_levels <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">rename</span><span class="op">(</span>value <span class="op">=</span> <span class="va">atmilitary</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">posteriordraws</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  atreligion <span class="op">=</span> <span class="fu">predictions</span><span class="op">(</span></span>
<span>    <span class="va">model_brms</span>,</span>
<span>    by <span class="op">=</span> <span class="st">"atreligion"</span>,</span>
<span>    allow_new_levels <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">rename</span><span class="op">(</span>value <span class="op">=</span> <span class="va">atreligion</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">posteriordraws</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  ated <span class="op">=</span> <span class="fu">predictions</span><span class="op">(</span></span>
<span>    <span class="va">model_brms</span>,</span>
<span>    by <span class="op">=</span> <span class="st">"ated"</span>,</span>
<span>    allow_new_levels <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">rename</span><span class="op">(</span>value <span class="op">=</span> <span class="va">ated</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">posteriordraws</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  atprof <span class="op">=</span> <span class="fu">predictions</span><span class="op">(</span></span>
<span>    <span class="va">model_brms</span>,</span>
<span>    by <span class="op">=</span> <span class="st">"atprof"</span>,</span>
<span>    allow_new_levels <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">rename</span><span class="op">(</span>value <span class="op">=</span> <span class="va">atprof</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">posteriordraws</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  atprof <span class="op">=</span> <span class="fu">predictions</span><span class="op">(</span></span>
<span>    <span class="va">model_brms</span>,</span>
<span>    by <span class="op">=</span> <span class="st">"atprof"</span>,</span>
<span>    allow_new_levels <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">rename</span><span class="op">(</span>value <span class="op">=</span> <span class="va">atprof</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">posteriordraws</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  atinc <span class="op">=</span> <span class="fu">predictions</span><span class="op">(</span></span>
<span>    <span class="va">model_brms</span>,</span>
<span>    by <span class="op">=</span> <span class="st">"atinc"</span>,</span>
<span>    allow_new_levels <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">rename</span><span class="op">(</span>value <span class="op">=</span> <span class="va">atinc</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">posteriordraws</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  atrace <span class="op">=</span> <span class="fu">predictions</span><span class="op">(</span></span>
<span>    <span class="va">model_brms</span>,</span>
<span>    by <span class="op">=</span> <span class="st">"atrace"</span>,</span>
<span>    allow_new_levels <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">rename</span><span class="op">(</span>value <span class="op">=</span> <span class="va">atrace</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">posteriordraws</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  atage <span class="op">=</span> <span class="fu">predictions</span><span class="op">(</span></span>
<span>    <span class="va">model_brms</span>,</span>
<span>    by <span class="op">=</span> <span class="st">"atage"</span>,</span>
<span>    allow_new_levels <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">rename</span><span class="op">(</span>value <span class="op">=</span> <span class="va">atage</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">posteriordraws</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  atmale <span class="op">=</span> <span class="fu">predictions</span><span class="op">(</span></span>
<span>    <span class="va">model_brms</span>,</span>
<span>    by <span class="op">=</span> <span class="st">"atmale"</span>,</span>
<span>    allow_new_levels <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">rename</span><span class="op">(</span>value <span class="op">=</span> <span class="va">atmale</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">posteriordraws</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  .id <span class="op">=</span> <span class="st">"term"</span></span>
<span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">posterior_mms</span></span>
<span><span class="co">## # A tibble: 184,000 × 7</span></span>
<span><span class="co">##    term       drawid  draw value         estimate conf.low conf.high</span></span>
<span><span class="co">##    &lt;chr&gt;      &lt;fct&gt;  &lt;dbl&gt; &lt;fct&gt;            &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">##  1 atmilitary 1      0.455 Did Not Serve    0.458    0.436     0.481</span></span>
<span><span class="co">##  2 atmilitary 1      0.546 Served           0.542    0.520     0.564</span></span>
<span><span class="co">##  3 atmilitary 2      0.459 Did Not Serve    0.458    0.436     0.481</span></span>
<span><span class="co">##  4 atmilitary 2      0.531 Served           0.542    0.520     0.564</span></span>
<span><span class="co">##  5 atmilitary 3      0.463 Did Not Serve    0.458    0.436     0.481</span></span>
<span><span class="co">##  6 atmilitary 3      0.543 Served           0.542    0.520     0.564</span></span>
<span><span class="co">##  7 atmilitary 4      0.450 Did Not Serve    0.458    0.436     0.481</span></span>
<span><span class="co">##  8 atmilitary 4      0.544 Served           0.542    0.520     0.564</span></span>
<span><span class="co">##  9 atmilitary 5      0.468 Did Not Serve    0.458    0.436     0.481</span></span>
<span><span class="co">## 10 atmilitary 5      0.554 Served           0.542    0.520     0.564</span></span>
<span><span class="co">## # ℹ 183,990 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Here are the marginal means for all the levels of all candidate features:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">plot_posterior_mms</span> <span class="op">&lt;-</span> <span class="va">posterior_mms</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">variable_lookup</span>, by <span class="op">=</span> <span class="fu">join_by</span><span class="op">(</span><span class="va">term</span> <span class="op">==</span> <span class="va">variable</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">value</span>, <span class="va">variable_nice</span><span class="op">)</span>, <span class="op">~</span><span class="fu">fct_inorder</span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span><span class="fu">ggplot</span><span class="op">(</span></span>
<span>  <span class="va">plot_posterior_mms</span>,</span>
<span>  <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">draw</span>, y <span class="op">=</span> <span class="va">value</span>, fill <span class="op">=</span> <span class="va">variable_nice</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span>normalize <span class="op">=</span> <span class="st">"groups"</span><span class="op">)</span> <span class="op">+</span>  <span class="co"># Make the heights of the distributions equal within each facet</span></span>
<span>  <span class="fu">facet_col</span><span class="op">(</span>facets <span class="op">=</span> <span class="st">"variable_nice"</span>, scales <span class="op">=</span> <span class="st">"free_y"</span>, space <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_percent</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Marginal means of probabilities"</span>,</span>
<span>    y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"Posterior marginal means"</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/mm-mfx-bayes-plot-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>And here are the two we mentioned at the beginning of this section—overall favorability of Mormon candidates and the difference between Mormon and Catholic favorability. Mormon candidates have a median posterior favorability of 41.8%, with a 95% credible interval of 38–46%. The median posterior difference between Mormon and Catholic favorability is 10.8 percentage points, with a 95% credible interval of 5–16 percentage points. Neat.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mms_mormon</span> <span class="op">&lt;-</span> <span class="va">posterior_mms</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">term</span> <span class="op">==</span> <span class="st">"atreligion"</span>, <span class="va">value</span> <span class="op">==</span> <span class="st">"Mormon"</span><span class="op">)</span></span>
<span><span class="va">mms_mormon</span> <span class="op">%&gt;%</span> <span class="fu">median_qi</span><span class="op">(</span><span class="va">draw</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 1 × 6</span></span>
<span><span class="co">##    draw .lower .upper .width .point .interval</span></span>
<span><span class="co">##   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span><span class="co">## 1 0.418  0.381  0.456   0.95 median qi</span></span>
<span></span>
<span><span class="va">mms_mormon_catholic</span> <span class="op">&lt;-</span> <span class="va">posterior_mms</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">term</span> <span class="op">==</span> <span class="st">"atreligion"</span>, <span class="va">value</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Mormon"</span>, <span class="st">"Catholic"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">drawid</span>, <span class="va">draw</span>, <span class="va">value</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="st">"value"</span>, values_from <span class="op">=</span> <span class="st">"draw"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>diff <span class="op">=</span> <span class="va">Mormon</span> <span class="op">-</span> <span class="va">Catholic</span><span class="op">)</span></span>
<span><span class="va">mms_mormon_catholic</span> <span class="op">%&gt;%</span> <span class="fu">median_qi</span><span class="op">(</span><span class="va">diff</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 1 × 6</span></span>
<span><span class="co">##     diff .lower  .upper .width .point .interval</span></span>
<span><span class="co">##    &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span><span class="co">## 1 -0.107 -0.160 -0.0537   0.95 median qi</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mm1</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">mms_mormon</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">draw</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"#FF851B"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="st">"Mormon favorability"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_percent</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Marginal mean"</span>, y <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    axis.text.y <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"grey90"</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">mm2</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">mms_mormon_catholic</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">diff</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"#B10DC9"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="st">"Difference between Mormons and Catholics"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="va">label_pp</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Difference in marginal means"</span>, y <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    axis.text.y <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"grey90"</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">mm1</span> <span class="op">|</span> <span class="va">mm2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/mm-mfx-bayes-plot-excerpt-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
</section><section id="subgroup-differences" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="subgroup-differences">Subgroup differences</h2>
<p>Finally, if we’re interested in subgroup differences, we can run a separate model with an interaction term for the subgroups we’re interested in. Again, this candidate experiment didn’t include any respondent-level covariates, so we’ll use the made-up, fake respondent political party that we used earlier.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">priors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>  <span class="fu">prior</span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,</span>
<span>  <span class="fu">prior</span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,</span>
<span>  <span class="fu">prior</span><span class="op">(</span><span class="fu">exponential</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sd</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_brms_military_party</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span></span>
<span>  <span class="fu">bf</span><span class="op">(</span><span class="va">selected</span> <span class="op">~</span> <span class="va">atmilitary</span> <span class="op">*</span> <span class="va">respondent_party</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">resID</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">candidate_fake</span>,</span>
<span>  family <span class="op">=</span> <span class="fu">bernoulli</span><span class="op">(</span>link <span class="op">=</span> <span class="st">"logit"</span><span class="op">)</span>,</span>
<span>  prior <span class="op">=</span> <span class="va">priors</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, iter <span class="op">=</span> <span class="fl">2000</span>, seed <span class="op">=</span> <span class="fl">1234</span>,</span>
<span>  backend <span class="op">=</span> <span class="st">"cmdstanr"</span>, threads <span class="op">=</span> <span class="fu">threading</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>, refresh <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  file <span class="op">=</span> <span class="st">"candidate_model_brms_interaction"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="conditional-amces-1" class="level3"><h3 class="anchored" data-anchor-id="conditional-amces-1">Conditional AMCEs</h3>
<p>We can calculate two different causal estimands, the conditional AMCE across each respondent political party of switching a candidate from having no military history to having served in the military. Because this model (1) uses logit-scale coefficients and (2) splits the causal effects across a bunch of different regression terms, we’ll use <code>marginaleffects::avg_slopes()</code> to find the group-specific probability-scale marginal effects.</p>
<p>Among Republican respondents, the causal effect of a candidate switching from no military history to having military service history has a posterior median of 23.8 percentage points, with a 95% credible interval of 19–28 percentage points. For Democrats, the same causal effect is negative, with a posterior median of −9.8 percentage points and a 95% credible interval of −5 to −14.7 percentage points.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">posterior_party_amces</span> <span class="op">&lt;-</span> <span class="va">model_brms_military_party</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">avg_slopes</span><span class="op">(</span></span>
<span>    newdata <span class="op">=</span> <span class="st">"mean"</span>,</span>
<span>    variables <span class="op">=</span> <span class="st">"atmilitary"</span>,</span>
<span>    by <span class="op">=</span> <span class="st">"respondent_party"</span>,</span>
<span>    allow_new_levels <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">posteriordraws</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">posterior_party_amces</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">respondent_party</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">median_qi</span><span class="op">(</span><span class="va">draw</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 2 × 7</span></span>
<span><span class="co">##   respondent_party    draw .lower  .upper .width .point .interval</span></span>
<span><span class="co">##   &lt;fct&gt;              &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span><span class="co">## 1 Democrat         -0.0982 -0.148 -0.0481   0.95 median qi       </span></span>
<span><span class="co">## 2 Republican        0.238   0.194  0.279    0.95 median qi</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Click to show the code since it’s so long</summary><div class="sourceCode" id="cb55"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">posterior_party_amces_wide</span> <span class="op">&lt;-</span> <span class="va">posterior_party_amces</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co"># The contrast column contains values like this:</span></span>
<span>  <span class="co">#   mean(Served) - mean(Did Not Serve)</span></span>
<span>  <span class="co"># I could probably use some fancy regex to extract those things, but here I'll</span></span>
<span>  <span class="co"># just brute force it and remove "mean(" and ")" with two separate</span></span>
<span>  <span class="co"># str_remove()s</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    contrast <span class="op">=</span> <span class="fu">str_remove_all</span><span class="op">(</span><span class="va">contrast</span>, <span class="st">"mean\\("</span><span class="op">)</span>,</span>
<span>    contrast <span class="op">=</span> <span class="fu">str_remove_all</span><span class="op">(</span><span class="va">contrast</span>, <span class="st">"\\)"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">separate_wider_delim</span><span class="op">(</span></span>
<span>    <span class="va">contrast</span>,</span>
<span>    delim <span class="op">=</span> <span class="st">" - "</span>, </span>
<span>    names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"variable_level"</span>, <span class="st">"reference_level"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Combine full dataset of factor levels with marginal effects</span></span>
<span><span class="va">plot_posterior_party_amces</span> <span class="op">&lt;-</span> <span class="fu">expand_grid</span><span class="op">(</span></span>
<span>  respondent_party <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">candidate_fake</span><span class="op">$</span><span class="va">respondent_party</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">model_variable_levels</span>, <span class="va">variable</span> <span class="op">==</span> <span class="st">"atmilitary"</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span></span>
<span>    <span class="va">posterior_party_amces_wide</span>,</span>
<span>    by <span class="op">=</span> <span class="fu">join_by</span><span class="op">(</span><span class="va">variable</span> <span class="op">==</span> <span class="va">term</span>, <span class="va">levels</span> <span class="op">==</span> <span class="va">variable_level</span>, <span class="va">respondent_party</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co"># Make these zero</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    <span class="fu">across</span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">draw</span>, <span class="va">estimate</span><span class="op">)</span>,</span>
<span>      <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span>, <span class="fl">0</span>, <span class="va">.x</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">variable_lookup</span>, by <span class="op">=</span> <span class="fu">join_by</span><span class="op">(</span><span class="va">variable</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">levels</span>, <span class="va">variable_nice</span><span class="op">)</span>, <span class="op">~</span><span class="fu">fct_inorder</span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>estimate_nice <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span></span>
<span>    <span class="va">estimate</span> <span class="op">!=</span> <span class="fl">0</span> <span class="op">~</span> <span class="fu">label_amce</span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span>,</span>
<span>    <span class="va">estimate</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="cn">NA</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span></span>
<span>  <span class="va">plot_posterior_party_amces</span>, </span>
<span>  <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">draw</span>, y <span class="op">=</span> <span class="va">levels</span>, color <span class="op">=</span> <span class="va">respondent_party</span>, fill <span class="op">=</span> <span class="va">respondent_party</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span>position <span class="op">=</span> <span class="fu">position_dodge</span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.15</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="va">label_pp</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span></span>
<span>    values <span class="op">=</span> <span class="va">parties</span>,</span>
<span>    guide <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span></span>
<span>      override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>linetype <span class="op">=</span> <span class="fl">0</span>, fill <span class="op">=</span> <span class="va">parties</span><span class="op">)</span>,</span>
<span>      keywidth <span class="op">=</span> <span class="fl">0.8</span>, keyheight <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span></span>
<span>    values <span class="op">=</span> <span class="fu">colorspace</span><span class="fu">::</span><span class="fu">lighten</span><span class="op">(</span><span class="va">parties</span>, <span class="fl">0.4</span><span class="op">)</span>, </span>
<span>    guide <span class="op">=</span> <span class="st">"none"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Percentage point change in probability of candidate selection"</span>,</span>
<span>    y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    color <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"Posterior AMCEs by respondent party"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">variable_nice</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>    legend.justification <span class="op">=</span> <span class="st">"left"</span>,</span>
<span>    legend.margin <span class="op">=</span> <span class="fu">margin</span><span class="op">(</span>l <span class="op">=</span> <span class="op">-</span><span class="fl">7</span>, t <span class="op">=</span> <span class="op">-</span><span class="fl">5</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/plot-posterior-party-amce-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
</section><section id="conditional-marginal-means-1" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="conditional-marginal-means-1">Conditional marginal means</h3>
<p>And finally, we can calculate subgroup conditional marginal means to describe general party-based trends (since the relative conditional AMCEs create an illusion of difference). Again, since <code>marginaleffects::marginal_means()</code> doesn’t work with brms models, we can instead use <code>marginaleffects::predictions()</code>, which still works with the neat <code>hypothesis</code> argument for calculating contrasts.</p>
<p>In the left panel below, Democratic respondents prefer candidates that haven’t served in the military (55% median posterior; 95% credible interval: 51–58%) to those that have (45% median posterior; 95% credible interval: 41–48%). Republicans strongly prefer candidates with a military history, with a posterior median 62% expressing favorability (95% credible interval: 59–65%). In general, Republicans are more extreme in their preferences for and against candidates with and without military service history.</p>
<p>In the right panel we can see the differences between the parties’ marginal means within each level. There’s a posterior median 17 percentage point distance between Republican and Democratic marginal means within the served level and a posterior median 17 percentage point distance between their marginal means in the did not serve level (95% credible interval: 12–21 percentage points). Overall, Republicans prefer candidates with military service; Democrats prefer candidates without military service.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">posterior_party_mms</span> <span class="op">&lt;-</span> <span class="fu">predictions</span><span class="op">(</span></span>
<span>  <span class="va">model_brms_military_party</span>,</span>
<span>  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"atmilitary"</span>, <span class="st">"respondent_party"</span><span class="op">)</span>,</span>
<span>  allow_new_levels <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">posterior_draws</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">posterior_party_mms</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">atmilitary</span>, <span class="va">respondent_party</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">median_qi</span><span class="op">(</span><span class="va">draw</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 4 × 8</span></span>
<span><span class="co">##   atmilitary    respondent_party  draw .lower .upper .width .point .interval</span></span>
<span><span class="co">##   &lt;fct&gt;         &lt;fct&gt;            &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span><span class="co">## 1 Did Not Serve Democrat         0.548  0.513  0.582   0.95 median qi       </span></span>
<span><span class="co">## 2 Did Not Serve Republican       0.380  0.351  0.412   0.95 median qi       </span></span>
<span><span class="co">## 3 Served        Democrat         0.450  0.415  0.485   0.95 median qi       </span></span>
<span><span class="co">## 4 Served        Republican       0.618  0.587  0.648   0.95 median qi</span></span>
<span></span>
<span><span class="va">group_diffs_terms</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span>,</span>
<span>    <span class="fl">0</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  ncol <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">magrittr</span><span class="fu">::</span><span class="fu">set_colnames</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">candidate_fake</span><span class="op">$</span><span class="va">atmilitary</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">posterior_party_mms_diff</span> <span class="op">&lt;-</span> <span class="fu">predictions</span><span class="op">(</span></span>
<span>  <span class="va">model_brms_military_party</span>,</span>
<span>  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"atmilitary"</span>, <span class="st">"respondent_party"</span><span class="op">)</span>,</span>
<span>  allow_new_levels <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  hypothesis <span class="op">=</span> <span class="va">group_diffs_terms</span></span>
<span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">posterior_draws</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">posterior_party_mms_diff</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">term</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">median_qi</span><span class="op">(</span><span class="va">draw</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 2 × 7</span></span>
<span><span class="co">##   term            draw .lower .upper .width .point .interval</span></span>
<span><span class="co">##   &lt;chr&gt;          &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span></span>
<span><span class="co">## 1 Did Not Serve -0.167 -0.213 -0.121   0.95 median qi       </span></span>
<span><span class="co">## 2 Served         0.168  0.120  0.215   0.95 median qi</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell page-columns page-full" data-layout-align="center">
<details class="code-fold"><summary>Click to show the code since it’s so long</summary><div class="sourceCode" id="cb57"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mm_posterior_party1</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span></span>
<span>  <span class="va">posterior_party_mms</span>, </span>
<span>  <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">draw</span>, y <span class="op">=</span> <span class="va">atmilitary</span>, color <span class="op">=</span> <span class="va">respondent_party</span>, fill <span class="op">=</span> <span class="va">respondent_party</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_percent</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span></span>
<span>    values <span class="op">=</span> <span class="va">parties</span>,</span>
<span>    guide <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span></span>
<span>      override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>linetype <span class="op">=</span> <span class="fl">0</span>, fill <span class="op">=</span> <span class="va">parties</span><span class="op">)</span>,</span>
<span>      keywidth <span class="op">=</span> <span class="fl">0.8</span>, keyheight <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span></span>
<span>    values <span class="op">=</span> <span class="fu">colorspace</span><span class="fu">::</span><span class="fu">lighten</span><span class="op">(</span><span class="va">parties</span>, <span class="fl">0.4</span><span class="op">)</span>, </span>
<span>    guide <span class="op">=</span> <span class="st">"none"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Marginal means"</span>,</span>
<span>    y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    color <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"Posterior marginal means by respondent party"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="st">"Military"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>    legend.justification <span class="op">=</span> <span class="st">"left"</span>,</span>
<span>    legend.margin <span class="op">=</span> <span class="fu">margin</span><span class="op">(</span>l <span class="op">=</span> <span class="op">-</span><span class="fl">7</span>, t <span class="op">=</span> <span class="op">-</span><span class="fl">5</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">mm_posterior_party2</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span></span>
<span>  <span class="va">posterior_party_mms_diff</span>,</span>
<span>  <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">draw</span>, y <span class="op">=</span> <span class="va">term</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span></span>
<span>    color <span class="op">=</span> <span class="st">"Republican marginal mean − Democrat marginal mean"</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"Republican marginal mean − Democrat marginal mean"</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="va">label_pp</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span></span>
<span>    values <span class="op">=</span> <span class="st">"#85144b"</span>,</span>
<span>    guide <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span></span>
<span>      override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>linetype <span class="op">=</span> <span class="fl">0</span>, fill <span class="op">=</span> <span class="st">"#85144b"</span><span class="op">)</span>,</span>
<span>      keywidth <span class="op">=</span> <span class="fl">0.8</span>, keyheight <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span></span>
<span>    values <span class="op">=</span> <span class="fu">colorspace</span><span class="fu">::</span><span class="fu">lighten</span><span class="op">(</span><span class="st">"#85144b"</span>, <span class="fl">0.4</span><span class="op">)</span>, </span>
<span>    guide <span class="op">=</span> <span class="st">"none"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Difference in marginal means"</span>,</span>
<span>    y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    color <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"Difference in marginal means by respondent party"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"Positive differences = Republicans prefer the level"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="st">"Military"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>    legend.justification <span class="op">=</span> <span class="st">"left"</span>,</span>
<span>    legend.margin <span class="op">=</span> <span class="fu">margin</span><span class="op">(</span>l <span class="op">=</span> <span class="op">-</span><span class="fl">7</span>, t <span class="op">=</span> <span class="op">-</span><span class="fl">5</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">mm_posterior_party1</span> <span class="op">|</span> <span class="va">mm_posterior_party2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/plot-posterior-mms-party-diffs-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page-right" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>


<!-- -->


</section></section></section><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-ChaudhryDotsonHeiss:2021" class="csl-entry" role="listitem">
Chaudhry, Suparna, Marc Dotson, and Andrew Heiss. 2021. <span>“Who Cares about Crackdowns? Exploring the Role of Trust in Individual Philanthropy.”</span> <em>Global Policy</em> 12 (S5): 45–58. <a href="https://doi.org/10.1111/1758-5899.12984">https://doi.org/10.1111/1758-5899.12984</a>.
</div>
<div id="ref-HainmuellerHopkinsYamamoto:2014" class="csl-entry" role="listitem">
Hainmueller, Jens, Daniel J. Hopkins, and Teppei Yamamoto. 2014. <span>“Causal Inference in Conjoint Analysis: Understanding Multidimensional Choices via Stated Preference Experiments.”</span> <em>Political Analysis</em> 22 (1): 1–30. <a href="https://doi.org/10.1093/pan/mpt024">https://doi.org/10.1093/pan/mpt024</a>.
</div>
<div id="ref-LeeperHoboltTilley:2020" class="csl-entry" role="listitem">
Leeper, Thomas J., Sara B. Hobolt, and James Tilley. 2020. <span>“Measuring Subgroup Preferences in Conjoint Experiments.”</span> <em>Political Analysis</em> 28 (2): 207–21. <a href="https://doi.org/10.1017/pan.2019.30">https://doi.org/10.1017/pan.2019.30</a>.
</div>
<div id="ref-McBrideRogersErekson:2020" class="csl-entry" role="listitem">
McBride, Spencer W., Brent M. Rogers, and Keith A. Erekson, eds. 2020. <em>Contingent Citizens: Shifting Perceptions of Latter-Day Saints in American Political Culture</em>. Ithaca, New York: Cornell University Press. <a href="https://doi.org/10.1515/9781501716744">https://doi.org/10.1515/9781501716744</a>.
</div>
<div id="ref-McElreath:2020" class="csl-entry" role="listitem">
McElreath, Richard. 2020. <em>Statistical Rethinking: A Bayesian Course with Examples in R and Stan</em>. 2nd ed. Boca Raton, Florida: Chapman and Hall / CRC.
</div>
<div id="ref-Reeve:2015" class="csl-entry" role="listitem">
Reeve, W. Paul. 2015. <em>Religion of a Different Color: Race and the Mormon Struggle for Whiteness</em>. Oxford: Oxford University Press. <a href="https://doi.org/10.1093/acprof:oso/9780199754076.001.0001">https://doi.org/10.1093/acprof:oso/9780199754076.001.0001</a>.
</div>
<div id="ref-TeeleKallaRosenbluth:2018" class="csl-entry" role="listitem">
Teele, Dawn Langan, Joshua Kalla, and Frances Rosenbluth. 2018. <span>“The Ties That Double Bind: Social Roles and Women’s Underrepresentation in Politics.”</span> <em>American Political Science Review</em> 112 (3): 525–41. <a href="https://doi.org/10.1017/S0003055418000217">https://doi.org/10.1017/S0003055418000217</a>.
</div>
</div></section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{heiss2023,
  author = {Heiss, Andrew},
  title = {The Ultimate Practical Guide to Conjoint Analysis with {R}},
  date = {2023-07-25},
  url = {https://www.andrewheiss.com/blog/2023/07/25/conjoint-bayesian-frequentist-guide/},
  doi = {10.59350/xgwjy-dyj66},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-heiss2023" class="csl-entry quarto-appendix-citeas" role="listitem">
Heiss, Andrew. 2023. <span>“The Ultimate Practical Guide to Conjoint
Analysis with R.”</span> July 25, 2023. <a href="https://doi.org/10.59350/xgwjy-dyj66">https://doi.org/10.59350/xgwjy-dyj66</a>.
</div></div></section></div></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/www\.andrewheiss\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><script src="https://giscus.app/client.js" data-repo="andrewheiss/ath-quarto" data-repo-id="R_kgDOIg6EJQ" data-category="Blog comments" data-category-id="DIC_kwDOIg6EJc4CSz92" data-mapping="pathname" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script><input type="hidden" id="giscus-base-theme" value="light"><input type="hidden" id="giscus-alt-theme" value="dark"><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb58" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "The ultimate practical guide to conjoint analysis with R"</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> 2023-07-25</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="an">description:</span><span class="co"> "Learn how to use R, {brms}, and {marginaleffects} to analyze conjoint data and find causal and descriptive quantities of interest, both frequentistly and Bayesianly"</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="an">image:</span><span class="co"> index_files/figure-html/amce-mfx-bayes-plot-excerpt-1.png</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a><span class="an">twitter-card:</span></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a><span class="co">  image: "index_files/figure-html/amce-mfx-bayes-plot-excerpt-1.png"</span></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a><span class="an">open-graph:</span></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a><span class="co">  image: "index_files/figure-html/amce-mfx-bayes-plot-excerpt-1.png"</span></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span></span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a><span class="co">  - r</span></span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a><span class="co">  - tidyverse</span></span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a><span class="co">  - ggplot</span></span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a><span class="co">  - statistics</span></span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a><span class="co">  - brms</span></span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a><span class="co">  - stan</span></span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a><span class="an">toc-depth:</span><span class="co"> 5</span></span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a><span class="co"># toc-expand: 2</span></span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a><span class="co">    fig-cap-location: bottom</span></span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a><span class="an">bibliography:</span><span class="co"> references.json</span></span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a><span class="an">doi:</span><span class="co"> 10.59350/xgwjy-dyj66</span></span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a><span class="an">citation:</span><span class="co"> true</span></span>
<span id="cb58-25"><a href="#cb58-25" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb58-26"><a href="#cb58-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-27"><a href="#cb58-27" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setup, include=FALSE}</span></span>
<span id="cb58-28"><a href="#cb58-28" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::opts_chunk$set(</span></span>
<span id="cb58-29"><a href="#cb58-29" aria-hidden="true" tabindex="-1"></a><span class="in">  fig.width = 6,</span></span>
<span id="cb58-30"><a href="#cb58-30" aria-hidden="true" tabindex="-1"></a><span class="in">  fig.height = 6 * 0.618,</span></span>
<span id="cb58-31"><a href="#cb58-31" aria-hidden="true" tabindex="-1"></a><span class="in">  fig.retina = 3,</span></span>
<span id="cb58-32"><a href="#cb58-32" aria-hidden="true" tabindex="-1"></a><span class="in">  dev = "ragg_png",</span></span>
<span id="cb58-33"><a href="#cb58-33" aria-hidden="true" tabindex="-1"></a><span class="in">  fig.align = "center",</span></span>
<span id="cb58-34"><a href="#cb58-34" aria-hidden="true" tabindex="-1"></a><span class="in">  out.width = "90%",</span></span>
<span id="cb58-35"><a href="#cb58-35" aria-hidden="true" tabindex="-1"></a><span class="in">  collapse = TRUE,</span></span>
<span id="cb58-36"><a href="#cb58-36" aria-hidden="true" tabindex="-1"></a><span class="in">  cache.extra = 123  # Change number to invalidate cache</span></span>
<span id="cb58-37"><a href="#cb58-37" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb58-38"><a href="#cb58-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-39"><a href="#cb58-39" aria-hidden="true" tabindex="-1"></a><span class="in">options(</span></span>
<span id="cb58-40"><a href="#cb58-40" aria-hidden="true" tabindex="-1"></a><span class="in">  digits = 4,</span></span>
<span id="cb58-41"><a href="#cb58-41" aria-hidden="true" tabindex="-1"></a><span class="in">  width = 300,</span></span>
<span id="cb58-42"><a href="#cb58-42" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr.summarise.inform = FALSE</span></span>
<span id="cb58-43"><a href="#cb58-43" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb58-44"><a href="#cb58-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-45"><a href="#cb58-45" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(1234)</span></span>
<span id="cb58-46"><a href="#cb58-46" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-47"><a href="#cb58-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-48"><a href="#cb58-48" aria-hidden="true" tabindex="-1"></a><span class="in">```{r tikz-stuff, include=FALSE}</span></span>
<span id="cb58-49"><a href="#cb58-49" aria-hidden="true" tabindex="-1"></a><span class="in"># Necessary for using dvisvgm on macOS</span></span>
<span id="cb58-50"><a href="#cb58-50" aria-hidden="true" tabindex="-1"></a><span class="in"># See https://www.andrewheiss.com/blog/2021/08/27/tikz-knitr-html-svg-fun/</span></span>
<span id="cb58-51"><a href="#cb58-51" aria-hidden="true" tabindex="-1"></a><span class="in">Sys.setenv(LIBGS = "/usr/local/share/ghostscript/9.53.3/lib/libgs.dylib.9.53")</span></span>
<span id="cb58-52"><a href="#cb58-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-53"><a href="#cb58-53" aria-hidden="true" tabindex="-1"></a><span class="in">font_opts &lt;- list(extra.preamble = c("\\usepackage{libertine}", </span></span>
<span id="cb58-54"><a href="#cb58-54" aria-hidden="true" tabindex="-1"></a><span class="in">                                     "\\usepackage{libertinust1math}"),</span></span>
<span id="cb58-55"><a href="#cb58-55" aria-hidden="true" tabindex="-1"></a><span class="in">                  dvisvgm.opts = "--font-format=woff")</span></span>
<span id="cb58-56"><a href="#cb58-56" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-57"><a href="#cb58-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-58"><a href="#cb58-58" aria-hidden="true" tabindex="-1"></a>In my research, I study international nongovernmental organizations (INGOs) and look at how lots of different institutional and organizational factors influence INGO behavior. For instance, many authoritarian regimes have passed anti-NGO laws and engaged in other forms of legal crackdown, which has forced NGOs to change their programming strategies and their sources of funding.</span>
<span id="cb58-59"><a href="#cb58-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-60"><a href="#cb58-60" aria-hidden="true" tabindex="-1"></a>In one ongoing project with <span class="co">[</span><span class="ot">Suparna Chaudhry</span><span class="co">](https://www.suparnachaudhry.com/)</span> and <span class="co">[</span><span class="ot">Marc Dotson</span><span class="co">](https://marriott.byu.edu/directory/details?id=50683)</span>, we look at how individual private donors feel about NGOs that face legal crackdown abroad and how the experience of crackdown interacts with donor characteristics (like how much education a person has, whether they've traveled abroad, what their income is, etc.) with organizational characteristics (like whether it deals with humanitarian or human rights issues, whether it has an open commitment to transparency, whether it faces legal crackdown abroad, etc.) to shape an individual's decision to give money to an NGO.^[<span class="co">[</span><span class="ot">In earlier work with Suparna Chaudhry, we do a similar thing too</span><span class="co">](https://www.andrewheiss.com/research/articles/chaudhry-heiss-ngos-philanthropy/)</span>, just with far fewer experimental conditions.]</span>
<span id="cb58-61"><a href="#cb58-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-62"><a href="#cb58-62" aria-hidden="true" tabindex="-1"></a>We use a conjoint experiment to test a bunch of different hypotheses related to INGO characteristics and donor behavior^[<span class="co">[</span><span class="ot">See our preregistration here.</span><span class="co">](https://stats.andrewheiss.com/why-donors-donate/preregistration.html)</span>] However, in all my previous stats training, I never learned how to analyze conjoint data or how to test specific causal claims and estimate causal effects with this kind of data. So, in the course of analyzing our INGO conjoint data, I've been making a guide for future-me (and anyone else who's interested) in how to analyze conjoint survey data. </span>
<span id="cb58-63"><a href="#cb58-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-64"><a href="#cb58-64" aria-hidden="true" tabindex="-1"></a>This is that guide. </span>
<span id="cb58-65"><a href="#cb58-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-66"><a href="#cb58-66" aria-hidden="true" tabindex="-1"></a>I explore three main things here:</span>
<span id="cb58-67"><a href="#cb58-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-68"><a href="#cb58-68" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>What kinds of causal and descriptive estimands (or quantities of interest) can you get from conjoint designs?</span>
<span id="cb58-69"><a href="#cb58-69" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>How can you estimate these things with "standard" frequentist statistics?</span>
<span id="cb58-70"><a href="#cb58-70" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>How can you estimate these things with Bayesian statistics?</span>
<span id="cb58-71"><a href="#cb58-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-72"><a href="#cb58-72" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb58-73"><a href="#cb58-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-74"><a href="#cb58-74" aria-hidden="true" tabindex="-1"></a><span class="fu">### Who this post is for</span></span>
<span id="cb58-75"><a href="#cb58-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-76"><a href="#cb58-76" aria-hidden="true" tabindex="-1"></a>Here's what I assume you know:</span>
<span id="cb58-77"><a href="#cb58-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-78"><a href="#cb58-78" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>You're familiar with <span class="co">[</span><span class="ot">R</span><span class="co">](https://www.r-project.org/)</span> and the <span class="co">[</span><span class="ot">tidyverse</span><span class="co">](https://www.tidyverse.org/)</span> (particularly <span class="co">[</span><span class="ot">{dplyr}</span><span class="co">](https://dplyr.tidyverse.org/)</span> and <span class="co">[</span><span class="ot">{ggplot2}</span><span class="co">](https://ggplot2.tidyverse.org/)</span>).</span>
<span id="cb58-79"><a href="#cb58-79" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>You're familiar with linear regression and packages like <span class="co">[</span><span class="ot">{broom}</span><span class="co">](https://broom.tidymodels.org/)</span> for converting regression results into tidy data frames and <span class="co">[</span><span class="ot">{marginaleffects}</span><span class="co">](https://vincentarelbundock.github.io/marginaleffects/)</span> for calculating <span class="co">[</span><span class="ot">marginal effects</span><span class="co">](https://www.andrewheiss.com/blog/2022/05/20/marginalia/)</span>.</span>
<span id="cb58-80"><a href="#cb58-80" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>You're familiar with <span class="co">[</span><span class="ot">{brms}</span><span class="co">](https://paul-buerkner.github.io/brms/)</span> for running Bayesian regression models and <span class="co">[</span><span class="ot">{tidybayes}</span><span class="co">](https://mjskay.github.io/tidybayes/)</span> and <span class="co">[</span><span class="ot">{ggdist}</span><span class="co">](https://mjskay.github.io/ggdist/)</span> for manipulating and plotting posterior draws.</span>
<span id="cb58-81"><a href="#cb58-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-82"><a href="#cb58-82" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb58-83"><a href="#cb58-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-84"><a href="#cb58-84" aria-hidden="true" tabindex="-1"></a>Throughout this example, I'll use data from a political candidate conjoint experiment from @HainmuellerHopkinsYamamoto:2014. <span class="co">[</span><span class="ot">The data is available at the Harvard Dataverse</span><span class="co">](https://doi.org/10.7910/DVN/THJYQR)</span> and it's public domain, so you can also download it here if you want to follow along:</span>
<span id="cb58-85"><a href="#cb58-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-86"><a href="#cb58-86" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">{{&lt; fa table &gt;}} `candidate.dta`</span><span class="co">](data/candidate.dta)</span> (this is a Stata file)^<span class="co">[</span><span class="ot">booo</span><span class="co">]</span></span>
<span id="cb58-87"><a href="#cb58-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-88"><a href="#cb58-88" aria-hidden="true" tabindex="-1"></a>Let's load some packages and data, create some helper functions and nice theme stuff, and get started!</span>
<span id="cb58-89"><a href="#cb58-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-90"><a href="#cb58-90" aria-hidden="true" tabindex="-1"></a><span class="in">```{r libraries-data, warning=FALSE, message=FALSE}</span></span>
<span id="cb58-91"><a href="#cb58-91" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidyverse)        # ggplot, dplyr, and friends</span></span>
<span id="cb58-92"><a href="#cb58-92" aria-hidden="true" tabindex="-1"></a><span class="in">library(haven)            # Read Stata files</span></span>
<span id="cb58-93"><a href="#cb58-93" aria-hidden="true" tabindex="-1"></a><span class="in">library(broom)            # Convert model objects to tidy data frames</span></span>
<span id="cb58-94"><a href="#cb58-94" aria-hidden="true" tabindex="-1"></a><span class="in">library(cregg)            # Automatically calculate frequentist conjoint AMCEs and MMs</span></span>
<span id="cb58-95"><a href="#cb58-95" aria-hidden="true" tabindex="-1"></a><span class="in">library(survey)           # Panel-ish regression models</span></span>
<span id="cb58-96"><a href="#cb58-96" aria-hidden="true" tabindex="-1"></a><span class="in">library(scales)           # Nicer labeling functions</span></span>
<span id="cb58-97"><a href="#cb58-97" aria-hidden="true" tabindex="-1"></a><span class="in">library(marginaleffects)  # Calculate marginal effects</span></span>
<span id="cb58-98"><a href="#cb58-98" aria-hidden="true" tabindex="-1"></a><span class="in">library(broom.helpers)    # Add empty reference categories to tidy model data frames</span></span>
<span id="cb58-99"><a href="#cb58-99" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggforce)          # For facet_col()</span></span>
<span id="cb58-100"><a href="#cb58-100" aria-hidden="true" tabindex="-1"></a><span class="in">library(brms)             # The best formula-based interface to Stan</span></span>
<span id="cb58-101"><a href="#cb58-101" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidybayes)        # Manipulate Stan results in tidy ways</span></span>
<span id="cb58-102"><a href="#cb58-102" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggdist)           # Fancy distribution plots</span></span>
<span id="cb58-103"><a href="#cb58-103" aria-hidden="true" tabindex="-1"></a><span class="in">library(patchwork)        # Combine ggplot plots</span></span>
<span id="cb58-104"><a href="#cb58-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-105"><a href="#cb58-105" aria-hidden="true" tabindex="-1"></a><span class="in"># Custom ggplot theme to make pretty plots</span></span>
<span id="cb58-106"><a href="#cb58-106" aria-hidden="true" tabindex="-1"></a><span class="in"># Get the font at https://fonts.google.com/specimen/Jost</span></span>
<span id="cb58-107"><a href="#cb58-107" aria-hidden="true" tabindex="-1"></a><span class="in">theme_nice &lt;- function() {</span></span>
<span id="cb58-108"><a href="#cb58-108" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_minimal(base_family = "Jost") +</span></span>
<span id="cb58-109"><a href="#cb58-109" aria-hidden="true" tabindex="-1"></a><span class="in">    theme(panel.grid.minor = element_blank(),</span></span>
<span id="cb58-110"><a href="#cb58-110" aria-hidden="true" tabindex="-1"></a><span class="in">          plot.title = element_text(family = "Jost", face = "bold"),</span></span>
<span id="cb58-111"><a href="#cb58-111" aria-hidden="true" tabindex="-1"></a><span class="in">          axis.title = element_text(family = "Jost Medium"),</span></span>
<span id="cb58-112"><a href="#cb58-112" aria-hidden="true" tabindex="-1"></a><span class="in">          axis.title.x = element_text(hjust = 0),</span></span>
<span id="cb58-113"><a href="#cb58-113" aria-hidden="true" tabindex="-1"></a><span class="in">          axis.title.y = element_text(hjust = 1),</span></span>
<span id="cb58-114"><a href="#cb58-114" aria-hidden="true" tabindex="-1"></a><span class="in">          strip.text = element_text(family = "Jost", face = "bold",</span></span>
<span id="cb58-115"><a href="#cb58-115" aria-hidden="true" tabindex="-1"></a><span class="in">                                    size = rel(0.75), hjust = 0),</span></span>
<span id="cb58-116"><a href="#cb58-116" aria-hidden="true" tabindex="-1"></a><span class="in">          strip.background = element_rect(fill = "grey90", color = NA))</span></span>
<span id="cb58-117"><a href="#cb58-117" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb58-118"><a href="#cb58-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-119"><a href="#cb58-119" aria-hidden="true" tabindex="-1"></a><span class="in"># Set default theme and font stuff</span></span>
<span id="cb58-120"><a href="#cb58-120" aria-hidden="true" tabindex="-1"></a><span class="in">theme_set(theme_nice())</span></span>
<span id="cb58-121"><a href="#cb58-121" aria-hidden="true" tabindex="-1"></a><span class="in">update_geom_defaults("text", list(family = "Jost", fontface = "plain"))</span></span>
<span id="cb58-122"><a href="#cb58-122" aria-hidden="true" tabindex="-1"></a><span class="in">update_geom_defaults("label", list(family = "Jost", fontface = "plain"))</span></span>
<span id="cb58-123"><a href="#cb58-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-124"><a href="#cb58-124" aria-hidden="true" tabindex="-1"></a><span class="in"># Party colors from the Urban Institute's data visualization style guide, for fun</span></span>
<span id="cb58-125"><a href="#cb58-125" aria-hidden="true" tabindex="-1"></a><span class="in"># http://urbaninstitute.github.io/graphics-styleguide/</span></span>
<span id="cb58-126"><a href="#cb58-126" aria-hidden="true" tabindex="-1"></a><span class="in">parties &lt;- c("#1696d2", "#db2b27")</span></span>
<span id="cb58-127"><a href="#cb58-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-128"><a href="#cb58-128" aria-hidden="true" tabindex="-1"></a><span class="in"># Functions for formatting things as percentage points</span></span>
<span id="cb58-129"><a href="#cb58-129" aria-hidden="true" tabindex="-1"></a><span class="in">label_pp &lt;- label_number(accuracy = 1, scale = 100, </span></span>
<span id="cb58-130"><a href="#cb58-130" aria-hidden="true" tabindex="-1"></a><span class="in">                         suffix = " pp.", style_negative = "minus")</span></span>
<span id="cb58-131"><a href="#cb58-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-132"><a href="#cb58-132" aria-hidden="true" tabindex="-1"></a><span class="in">label_amce &lt;- label_number(accuracy = 0.1, scale = 100, suffix = " pp.", </span></span>
<span id="cb58-133"><a href="#cb58-133" aria-hidden="true" tabindex="-1"></a><span class="in">                           style_negative = "minus", style_positive = "plus")</span></span>
<span id="cb58-134"><a href="#cb58-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-135"><a href="#cb58-135" aria-hidden="true" tabindex="-1"></a><span class="in"># Data from https://doi.org/10.7910/DVN/THJYQR</span></span>
<span id="cb58-136"><a href="#cb58-136" aria-hidden="true" tabindex="-1"></a><span class="in"># It's public domain</span></span>
<span id="cb58-137"><a href="#cb58-137" aria-hidden="true" tabindex="-1"></a><span class="in">candidate &lt;- read_stata("data/candidate.dta") %&gt;% </span></span>
<span id="cb58-138"><a href="#cb58-138" aria-hidden="true" tabindex="-1"></a><span class="in">  as_factor()  # Convert all the Stata categories to factors</span></span>
<span id="cb58-139"><a href="#cb58-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-140"><a href="#cb58-140" aria-hidden="true" tabindex="-1"></a><span class="in"># Make a little lookup table for nicer feature labels</span></span>
<span id="cb58-141"><a href="#cb58-141" aria-hidden="true" tabindex="-1"></a><span class="in">variable_lookup &lt;- tribble(</span></span>
<span id="cb58-142"><a href="#cb58-142" aria-hidden="true" tabindex="-1"></a><span class="in">  ~variable,    ~variable_nice,</span></span>
<span id="cb58-143"><a href="#cb58-143" aria-hidden="true" tabindex="-1"></a><span class="in">  "atmilitary", "Military",</span></span>
<span id="cb58-144"><a href="#cb58-144" aria-hidden="true" tabindex="-1"></a><span class="in">  "atreligion", "Religion",</span></span>
<span id="cb58-145"><a href="#cb58-145" aria-hidden="true" tabindex="-1"></a><span class="in">  "ated",       "Education",</span></span>
<span id="cb58-146"><a href="#cb58-146" aria-hidden="true" tabindex="-1"></a><span class="in">  "atprof",     "Profession",</span></span>
<span id="cb58-147"><a href="#cb58-147" aria-hidden="true" tabindex="-1"></a><span class="in">  "atmale",     "Gender",</span></span>
<span id="cb58-148"><a href="#cb58-148" aria-hidden="true" tabindex="-1"></a><span class="in">  "atinc",      "Income",</span></span>
<span id="cb58-149"><a href="#cb58-149" aria-hidden="true" tabindex="-1"></a><span class="in">  "atrace",     "Race",</span></span>
<span id="cb58-150"><a href="#cb58-150" aria-hidden="true" tabindex="-1"></a><span class="in">  "atage",      "Age"</span></span>
<span id="cb58-151"><a href="#cb58-151" aria-hidden="true" tabindex="-1"></a><span class="in">) %&gt;% </span></span>
<span id="cb58-152"><a href="#cb58-152" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(variable_nice = fct_inorder(variable_nice))</span></span>
<span id="cb58-153"><a href="#cb58-153" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-154"><a href="#cb58-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-155"><a href="#cb58-155" aria-hidden="true" tabindex="-1"></a><span class="fu"># How conjoint experiments work</span></span>
<span id="cb58-156"><a href="#cb58-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-157"><a href="#cb58-157" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">Conjoint experiments</span><span class="co">](https://en.wikipedia.org/wiki/Conjoint_analysis)</span> are a special kind of randomized experiment where study participants are asked questions that have experimental manipulations. However, unlike a standard randomized experiment where one feature of interest is manipulated (like in an A/B test), conjoint experiments are choose-your-own-adventure randomized experiments. Participants are presented with 2+ possible options that have a variety of features with different levels in those features, and then they're asked to choose one (for a binary outcome) or rate them on some sort of scale (for a continuous outcome).</span>
<span id="cb58-158"><a href="#cb58-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-159"><a href="#cb58-159" aria-hidden="true" tabindex="-1"></a>For instance, throughout this post we'll play with data from a conjoint experiment by @HainmuellerHopkinsYamamoto:2014 where they were interested in seeing the effect of different political candidate characteristics on the probability that a respondent would select that candidate (or on candidate favorability).</span>
<span id="cb58-160"><a href="#cb58-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-161"><a href="#cb58-161" aria-hidden="true" tabindex="-1"></a>Respondents were shown the following question multiple times and asked to choose which candidate they'd vote for. Each candidate had a set of eight features with randomly chosen levels inside each feature, like this:</span>
<span id="cb58-162"><a href="#cb58-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-163"><a href="#cb58-163" aria-hidden="true" tabindex="-1"></a>:::: {.callout-tip}</span>
<span id="cb58-164"><a href="#cb58-164" aria-hidden="true" tabindex="-1"></a><span class="fu">### Example conjoint survey question</span></span>
<span id="cb58-165"><a href="#cb58-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-166"><a href="#cb58-166" aria-hidden="true" tabindex="-1"></a>|                  |    Candidate 1   |      Candidate 2      |</span>
<span id="cb58-167"><a href="#cb58-167" aria-hidden="true" tabindex="-1"></a>|------------------|:----------------:|:---------------------:|</span>
<span id="cb58-168"><a href="#cb58-168" aria-hidden="true" tabindex="-1"></a>| Military service | Did not serve    | Served                |</span>
<span id="cb58-169"><a href="#cb58-169" aria-hidden="true" tabindex="-1"></a>| Religion         | None             | Mormon                |</span>
<span id="cb58-170"><a href="#cb58-170" aria-hidden="true" tabindex="-1"></a>| College          | State university | Ivy League university |</span>
<span id="cb58-171"><a href="#cb58-171" aria-hidden="true" tabindex="-1"></a>| Profession       | Lawyer           | Business owner        |</span>
<span id="cb58-172"><a href="#cb58-172" aria-hidden="true" tabindex="-1"></a>| Gender           | Female           | Female                |</span>
<span id="cb58-173"><a href="#cb58-173" aria-hidden="true" tabindex="-1"></a>| Income           | \$54,000         | \$92,000              |</span>
<span id="cb58-174"><a href="#cb58-174" aria-hidden="true" tabindex="-1"></a>| Race/Ethnicity   | White            | Asian American        |</span>
<span id="cb58-175"><a href="#cb58-175" aria-hidden="true" tabindex="-1"></a>| Age              | 45               | 68                    |</span>
<span id="cb58-176"><a href="#cb58-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-177"><a href="#cb58-177" aria-hidden="true" tabindex="-1"></a>::: {.rounded .bg-success .text-white .p-2}</span>
<span id="cb58-178"><a href="#cb58-178" aria-hidden="true" tabindex="-1"></a>**If you had to choose between them, which of these two candidates would you vote for?**</span>
<span id="cb58-179"><a href="#cb58-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-180"><a href="#cb58-180" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Candidate 1**</span>
<span id="cb58-181"><a href="#cb58-181" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Candidate 2**</span>
<span id="cb58-182"><a href="#cb58-182" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb58-183"><a href="#cb58-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-184"><a href="#cb58-184" aria-hidden="true" tabindex="-1"></a>::::</span>
<span id="cb58-185"><a href="#cb58-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-186"><a href="#cb58-186" aria-hidden="true" tabindex="-1"></a>Each of these eight features had different levels within them that respondents could possibly see:</span>
<span id="cb58-187"><a href="#cb58-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-188"><a href="#cb58-188" aria-hidden="true" tabindex="-1"></a>| Features/Attributes | Levels                                                                                            |</span>
<span id="cb58-189"><a href="#cb58-189" aria-hidden="true" tabindex="-1"></a>|----------------------|------------------------------------------------------|</span>
<span id="cb58-190"><a href="#cb58-190" aria-hidden="true" tabindex="-1"></a>| Military service    | Served, Did not serve                                                                             |</span>
<span id="cb58-191"><a href="#cb58-191" aria-hidden="true" tabindex="-1"></a>| Religion            | None, Jewish, Catholic, Mainline protestant, Evangelical protestant, Mormon                       |</span>
<span id="cb58-192"><a href="#cb58-192" aria-hidden="true" tabindex="-1"></a>| College             | No BA, Baptist college, Community college, State university, Small college, Ivy League university |</span>
<span id="cb58-193"><a href="#cb58-193" aria-hidden="true" tabindex="-1"></a>| Profession          | Business owner, Lawyer, Doctor, High school teacher, Farmer, Car dealer                           |</span>
<span id="cb58-194"><a href="#cb58-194" aria-hidden="true" tabindex="-1"></a>| Gender              | Male, Female                                                                                      |</span>
<span id="cb58-195"><a href="#cb58-195" aria-hidden="true" tabindex="-1"></a>| Income              | \$32,000; \$54,000; \$65,000; \$92,000; \$210,000; \$5,100,000                                    |</span>
<span id="cb58-196"><a href="#cb58-196" aria-hidden="true" tabindex="-1"></a>| Race/Ethnicity      | White, Native American, Black, Hispanic, Caucasian, Asian American                                |</span>
<span id="cb58-197"><a href="#cb58-197" aria-hidden="true" tabindex="-1"></a>| Age                 | 36, 45, 52, 60, 68, 75                                                                            |</span>
<span id="cb58-198"><a href="#cb58-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-199"><a href="#cb58-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-200"><a href="#cb58-200" aria-hidden="true" tabindex="-1"></a><span class="fu"># Estimands: what quantities of interest can you get from conjoint designs?</span></span>
<span id="cb58-201"><a href="#cb58-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-202"><a href="#cb58-202" aria-hidden="true" tabindex="-1"></a>There are a ton of possible combinations of features and levels that can be offered to respondents—in this candidate experiment, there are 2 × 6 × 6 × 6 × 2 × 6 × 6 × 6, or <span class="in">`r label_comma()(2 * 6 * 6 * 6 * 2 * 6 * 6 * 6)`</span> options(!). Even in a survey with thousands of respondents, it's unlikely that every possible version of the <span class="in">`r label_comma()(2 * 6 * 6 * 6 * 2 * 6 * 6 * 6)`</span> potential combinations would be seen by the whole sample. Regardless, with some statistical magic, you can still find valid quantities of interest from these complex experimental designs.</span>
<span id="cb58-203"><a href="#cb58-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-204"><a href="#cb58-204" aria-hidden="true" tabindex="-1"></a>In general, there are two types of estimands that you can find using conjoint designs: causal and descriptive @LeeperHoboltTilley:2020. The exact research question you have determines what quantity of interest you'll want to find and how you analyze the data to find it. This table summarizes the two types of estimands, how they're calculated, and shows some example questions you can answer with them:</span>
<span id="cb58-205"><a href="#cb58-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-206"><a href="#cb58-206" aria-hidden="true" tabindex="-1"></a>::: {.column-page-inset}</span>
<span id="cb58-207"><a href="#cb58-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-208"><a href="#cb58-208" aria-hidden="true" tabindex="-1"></a>+----------------------------+--------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------+</span>
<span id="cb58-209"><a href="#cb58-209" aria-hidden="true" tabindex="-1"></a>| Purpose                    | Estimand                                                                                                     | Example interpretation                                                                                             | Practical calculation                                                              |</span>
<span id="cb58-210"><a href="#cb58-210" aria-hidden="true" tabindex="-1"></a>+============================+==============================================================================================================+====================================================================================================================+====================================================================================+</span>
<span id="cb58-211"><a href="#cb58-211" aria-hidden="true" tabindex="-1"></a>| **Causal inference**       | **Average marginal component effect (AMCE)**                                                                 | Changing a candidate's religion from none to Mormon decreases the probability of selection by X percentage points. | Categorical regression coefficients or marginal effects where one level is omitted |</span>
<span id="cb58-212"><a href="#cb58-212" aria-hidden="true" tabindex="-1"></a>|                            |                                                                                                              |                                                                                                                    |                                                                                    |</span>
<span id="cb58-213"><a href="#cb58-213" aria-hidden="true" tabindex="-1"></a>|                            | $$                                                                                                           |                                                                                                                    |                                                                                    |</span>
<span id="cb58-214"><a href="#cb58-214" aria-hidden="true" tabindex="-1"></a>|                            | \begin{aligned}                                                                                              |                                                                                                                    |                                                                                    |</span>
<span id="cb58-215"><a href="#cb58-215" aria-hidden="true" tabindex="-1"></a>|                            | \theta =\ &amp;\textbf{E} <span class="co">[</span><span class="ot">\text{Outcome} \mid \operatorname{do}(\text{Feature} = \text{reference level})</span><span class="co">]</span>\ - <span class="sc">\\</span> |                                                                                                                    |                                                                                    |</span>
<span id="cb58-216"><a href="#cb58-216" aria-hidden="true" tabindex="-1"></a>|                            | &amp;\textbf{E}<span class="co">[</span><span class="ot">\text{Outcome} \mid \operatorname{do}(\text{Feature} = \text{level of interest})</span><span class="co">]</span>                |                                                                                                                    |                                                                                    |</span>
<span id="cb58-217"><a href="#cb58-217" aria-hidden="true" tabindex="-1"></a>|                            | \end{aligned}                                                                                                |                                                                                                                    |                                                                                    |</span>
<span id="cb58-218"><a href="#cb58-218" aria-hidden="true" tabindex="-1"></a>|                            | $$                                                                                                           |                                                                                                                    |                                                                                    |</span>
<span id="cb58-219"><a href="#cb58-219" aria-hidden="true" tabindex="-1"></a>+----------------------------+--------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------+</span>
<span id="cb58-220"><a href="#cb58-220" aria-hidden="true" tabindex="-1"></a>| **Preference description** | **Marginal mean (MM)**                                                                                       | Mormon candidates are supported by X% of respondents.                                                              | Average outcome value conditional on different levels                              |</span>
<span id="cb58-221"><a href="#cb58-221" aria-hidden="true" tabindex="-1"></a>|                            |                                                                                                              |                                                                                                                    |                                                                                    |</span>
<span id="cb58-222"><a href="#cb58-222" aria-hidden="true" tabindex="-1"></a>|                            | $$                                                                                                           | *or*                                                                                                               |                                                                                    |</span>
<span id="cb58-223"><a href="#cb58-223" aria-hidden="true" tabindex="-1"></a>|                            | \theta = \textbf{E}<span class="co">[</span><span class="ot">\text{Outcome} \mid \text{Feature = Level of interest}</span><span class="co">]</span>                                  |                                                                                                                    |                                                                                    |</span>
<span id="cb58-224"><a href="#cb58-224" aria-hidden="true" tabindex="-1"></a>|                            | $$                                                                                                           | Mormon candidates are X percentage points less likely to be selected than Catholic candidates.                     |                                                                                    |</span>
<span id="cb58-225"><a href="#cb58-225" aria-hidden="true" tabindex="-1"></a>|                            |                                                                                                              |                                                                                                                    |                                                                                    |</span>
<span id="cb58-226"><a href="#cb58-226" aria-hidden="true" tabindex="-1"></a>|                            | *or*                                                                                                         |                                                                                                                    |                                                                                    |</span>
<span id="cb58-227"><a href="#cb58-227" aria-hidden="true" tabindex="-1"></a>|                            |                                                                                                              |                                                                                                                    |                                                                                    |</span>
<span id="cb58-228"><a href="#cb58-228" aria-hidden="true" tabindex="-1"></a>|                            | $$                                                                                                           |                                                                                                                    |                                                                                    |</span>
<span id="cb58-229"><a href="#cb58-229" aria-hidden="true" tabindex="-1"></a>|                            | \begin{aligned}                                                                                              |                                                                                                                    |                                                                                    |</span>
<span id="cb58-230"><a href="#cb58-230" aria-hidden="true" tabindex="-1"></a>|                            | \theta =\ &amp;\textbf{E}<span class="co">[</span><span class="ot">\text{Outcome} \mid \text{Feature = Level of interest}</span><span class="co">]</span>\ - <span class="sc">\\</span>                          |                                                                                                                    |                                                                                    |</span>
<span id="cb58-231"><a href="#cb58-231" aria-hidden="true" tabindex="-1"></a>|                            | &amp;\textbf{E}<span class="co">[</span><span class="ot">\text{Outcome} \mid \text{Feature = Other level of interest}</span><span class="co">]</span>                                    |                                                                                                                    |                                                                                    |</span>
<span id="cb58-232"><a href="#cb58-232" aria-hidden="true" tabindex="-1"></a>|                            | \end{aligned}                                                                                                |                                                                                                                    |                                                                                    |</span>
<span id="cb58-233"><a href="#cb58-233" aria-hidden="true" tabindex="-1"></a>|                            | $$                                                                                                           |                                                                                                                    |                                                                                    |</span>
<span id="cb58-234"><a href="#cb58-234" aria-hidden="true" tabindex="-1"></a>+----------------------------+--------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------+</span>
<span id="cb58-235"><a href="#cb58-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-236"><a href="#cb58-236" aria-hidden="true" tabindex="-1"></a>: Causal and descriptive estimands from conjoint designs {#tbl-conjoint-estimands}</span>
<span id="cb58-237"><a href="#cb58-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-238"><a href="#cb58-238" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb58-239"><a href="#cb58-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-240"><a href="#cb58-240" aria-hidden="true" tabindex="-1"></a><span class="fu">## Average marginal component effect (AMCE)</span></span>
<span id="cb58-241"><a href="#cb58-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-242"><a href="#cb58-242" aria-hidden="true" tabindex="-1"></a>This distinction between causal and descriptive estimands makes sense if we look at the notation for the estimands themselves. <span class="co">[</span><span class="ot">In the world of do-calculus</span><span class="co">](https://www.andrewheiss.com/blog/2021/09/07/do-calculus-backdoors/)</span>, causal questions are asked using the $\operatorname{do}()$ operator, which represents <span class="co">[</span><span class="ot">a direct intervention into a data generating process</span><span class="co">](https://stats.stackexchange.com/questions/211008/dox-operator-meaning)</span>. In this case, the researcher randomly sets the attributes to specific levels—the respondent does not self-select into different conditions or decide for themselves that Candidate 1 is a Catholic lawyer or that Candidate 2 is a Jewish farmer. This thus eliminates selection bias and other external confounding, leaving us with an average causal effect. </span>
<span id="cb58-243"><a href="#cb58-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-244"><a href="#cb58-244" aria-hidden="true" tabindex="-1"></a>We can calculate (1) the average outcome when a feature is set to a level we're interested in (e.g., when religion = Mormon), (2) the average outcome when a feature is set to some reference level (e.g., when religion = none), and (3) find the difference between the two:</span>
<span id="cb58-245"><a href="#cb58-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-246"><a href="#cb58-246" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb58-247"><a href="#cb58-247" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb58-248"><a href="#cb58-248" aria-hidden="true" tabindex="-1"></a>\theta =\ &amp;P <span class="co">[</span><span class="ot">\text{Candidate selection} \mid \operatorname{do}(\text{Religion} = \text{none})</span><span class="co">]</span>\ - <span class="sc">\\</span></span>
<span id="cb58-249"><a href="#cb58-249" aria-hidden="true" tabindex="-1"></a>&amp;P<span class="co">[</span><span class="ot">\text{Candidate selection} \mid \operatorname{do}(\text{Religion} = \text{Mormon})</span><span class="co">]</span></span>
<span id="cb58-250"><a href="#cb58-250" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb58-251"><a href="#cb58-251" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb58-252"><a href="#cb58-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-253"><a href="#cb58-253" aria-hidden="true" tabindex="-1"></a>Practically speaking, the easiest way to think about the average marginal component effect (AMCE) is as categorical coefficients in a linear regression model.</span>
<span id="cb58-254"><a href="#cb58-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-255"><a href="#cb58-255" aria-hidden="true" tabindex="-1"></a>In my favorite analogy for thinking about regression, <span class="co">[</span><span class="ot">model covariates can either be sliders or switches</span><span class="co">](https://www.andrewheiss.com/blog/2022/05/20/marginalia/#regression-sliders-switches-and-mixing-boards)</span>:</span>
<span id="cb58-256"><a href="#cb58-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-257"><a href="#cb58-257" aria-hidden="true" tabindex="-1"></a><span class="in">```{r slider-switch, echo=FALSE, out.width="100%", fig.align="center"}</span></span>
<span id="cb58-258"><a href="#cb58-258" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::include_graphics("img/slider-switch-annotated-80.jpg")</span></span>
<span id="cb58-259"><a href="#cb58-259" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-260"><a href="#cb58-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-261"><a href="#cb58-261" aria-hidden="true" tabindex="-1"></a>Numeric covariates are sliders—a one unit change in X is associated with a $\beta$ unit change in Y. You can slide that X variable up and down and influence Y accordingly (a 10 unit change in X is associated with a $10  \times \beta$ change in Y; a −1 unit change in X is associated with a $-\beta$ change in Y; and so on). The $\beta$ is a slider that you can move up and down and see what happens to the outcome.</span>
<span id="cb58-262"><a href="#cb58-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-263"><a href="#cb58-263" aria-hidden="true" tabindex="-1"></a>Categorical covariates, on the other hand, are switches. One of the categories is omitted and represents the baseline average for that category, or the average when the switch is off. The other category coefficients represent shifts in that baseline, or what happens when the switch is flipped on.</span>
<span id="cb58-264"><a href="#cb58-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-265"><a href="#cb58-265" aria-hidden="true" tabindex="-1"></a>Here's a quick super basic reference example with data from {palmerpenguins} (this is not actual conjoint data!). We'll model penguin weight based on penguin species and sex:</span>
<span id="cb58-266"><a href="#cb58-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-267"><a href="#cb58-267" aria-hidden="true" tabindex="-1"></a><span class="in">```{r penguin-model-example}</span></span>
<span id="cb58-268"><a href="#cb58-268" aria-hidden="true" tabindex="-1"></a><span class="in">library(palmerpenguins)</span></span>
<span id="cb58-269"><a href="#cb58-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-270"><a href="#cb58-270" aria-hidden="true" tabindex="-1"></a><span class="in">penguins &lt;- penguins %&gt;% drop_na(sex)</span></span>
<span id="cb58-271"><a href="#cb58-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-272"><a href="#cb58-272" aria-hidden="true" tabindex="-1"></a><span class="in">penguin_model &lt;- lm(body_mass_g ~ species + sex, data = penguins)</span></span>
<span id="cb58-273"><a href="#cb58-273" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(penguin_model)</span></span>
<span id="cb58-274"><a href="#cb58-274" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-275"><a href="#cb58-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-276"><a href="#cb58-276" aria-hidden="true" tabindex="-1"></a>There are three species and two sexes of penguins, but we only get coefficients for two species (Chinstrap and Gentoo) and one sex (male) because of how regression works—one category is omitted. The coefficients here represent changes in average body mass when switching on the corresponding category. For sex, the omitted category is "female," so the coefficient for <span class="in">`sexmale`</span> shows that male penguins are 667 grams heavier than female penguins, on average. Imagine a "sex" switch—when it's flipped up to the male position, body mass goes up. The same idea works for species—the omitted species is Adélie, so on average Chinstraps are 27 grams heavier than Adélies, and Gentoos are 1,378 grams heavier than Adélies. We can flip the "Chinstrap" or "Gentoo" switches on and increase body mass accordingly. </span>
<span id="cb58-277"><a href="#cb58-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-278"><a href="#cb58-278" aria-hidden="true" tabindex="-1"></a>The nice thing about the slider and switch analogy is that it makes it easier to think about holding everything constant—we have switches for both species and sex, but if we just tinker with one, we'll get the effect of being a Chinstrap or a Gentoo or a male. It's like a mixer board:</span>
<span id="cb58-279"><a href="#cb58-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-280"><a href="#cb58-280" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mixer-board, echo=FALSE, out.width="100%", fig.align="center"}</span></span>
<span id="cb58-281"><a href="#cb58-281" aria-hidden="true" tabindex="-1"></a><span class="in"># Original via Wikimedia commons: https://commons.wikimedia.org/wiki/File:Yamaha_Audio_Mixer_Board.jpg</span></span>
<span id="cb58-282"><a href="#cb58-282" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::include_graphics("img/mixer-board-annotated-80.jpg")</span></span>
<span id="cb58-283"><a href="#cb58-283" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-284"><a href="#cb58-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-285"><a href="#cb58-285" aria-hidden="true" tabindex="-1"></a>That's all standard regression-with-categorical-variables stuff.</span>
<span id="cb58-286"><a href="#cb58-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-287"><a href="#cb58-287" aria-hidden="true" tabindex="-1"></a>The magic of AMCEs is that in the case of ordinary least squares (OLS) linear regression without any squared or nonlinear terms, **AMCEs are just coefficients**. It's a little more complicated with non-linear terms or models with nonlinear link functions like logistic regression—we'd need to calculate marginal effects to get the AMCEs in those cases (but <span class="co">[</span><span class="ot">I'll explore that a lot more below</span><span class="co">](#marginal-effects-instead-of-coefficients)</span>).</span>
<span id="cb58-288"><a href="#cb58-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-289"><a href="#cb58-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-290"><a href="#cb58-290" aria-hidden="true" tabindex="-1"></a><span class="fu">## Marginal means</span></span>
<span id="cb58-291"><a href="#cb58-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-292"><a href="#cb58-292" aria-hidden="true" tabindex="-1"></a>The descriptive estimand, on the other hand, does not have a $\operatorname{do}()$ operator, which means that there's no experimental intervention or causal effect. Instead, we're working with the observed averages of different levels. </span>
<span id="cb58-293"><a href="#cb58-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-294"><a href="#cb58-294" aria-hidden="true" tabindex="-1"></a>For instance, if we wanted to know what proportion of respondents support Mormon candidates, we could calculate this estimand:</span>
<span id="cb58-295"><a href="#cb58-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-296"><a href="#cb58-296" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb58-297"><a href="#cb58-297" aria-hidden="true" tabindex="-1"></a>\theta = P(\text{Candidate selection} \mid \text{Religion = Mormon})</span>
<span id="cb58-298"><a href="#cb58-298" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb58-299"><a href="#cb58-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-300"><a href="#cb58-300" aria-hidden="true" tabindex="-1"></a>Or if we wanted to know the percentage point difference between the probabilities of Mormon and Catholic candidates, we could calculate this estimand:</span>
<span id="cb58-301"><a href="#cb58-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-302"><a href="#cb58-302" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb58-303"><a href="#cb58-303" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb58-304"><a href="#cb58-304" aria-hidden="true" tabindex="-1"></a>\theta =\ &amp;P<span class="co">[</span><span class="ot">\text{Candidate selection} \mid \text{Religion = Mormon}</span><span class="co">]</span>\ - <span class="sc">\\</span></span>
<span id="cb58-305"><a href="#cb58-305" aria-hidden="true" tabindex="-1"></a>&amp;P<span class="co">[</span><span class="ot">\text{Candidate selection} \mid \text{Religion = Catholic}</span><span class="co">]</span></span>
<span id="cb58-306"><a href="#cb58-306" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb58-307"><a href="#cb58-307" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb58-308"><a href="#cb58-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-309"><a href="#cb58-309" aria-hidden="true" tabindex="-1"></a>Importantly these aren't causal estimands—they're descriptive. They're also not relative to any baseline level. They're not regression-style "switches" but instead are group averages.</span>
<span id="cb58-310"><a href="#cb58-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-311"><a href="#cb58-311" aria-hidden="true" tabindex="-1"></a>We can see this really quick with the penguin data (again, this isn't related to conjoint stuff! this is just to help with the intuition). To find these marginal means, we calculate the category-specific means. We can do that without regression with some grouping and summarizing:</span>
<span id="cb58-312"><a href="#cb58-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-313"><a href="#cb58-313" aria-hidden="true" tabindex="-1"></a><span class="in">```{r penguin-mm-dplyr}</span></span>
<span id="cb58-314"><a href="#cb58-314" aria-hidden="true" tabindex="-1"></a><span class="in"># Marginal means for species</span></span>
<span id="cb58-315"><a href="#cb58-315" aria-hidden="true" tabindex="-1"></a><span class="in">penguins %&gt;% </span></span>
<span id="cb58-316"><a href="#cb58-316" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(species) %&gt;% </span></span>
<span id="cb58-317"><a href="#cb58-317" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(avg = mean(body_mass_g))</span></span>
<span id="cb58-318"><a href="#cb58-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-319"><a href="#cb58-319" aria-hidden="true" tabindex="-1"></a><span class="in"># Marginal means for sex</span></span>
<span id="cb58-320"><a href="#cb58-320" aria-hidden="true" tabindex="-1"></a><span class="in">penguins %&gt;% </span></span>
<span id="cb58-321"><a href="#cb58-321" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(sex) %&gt;% </span></span>
<span id="cb58-322"><a href="#cb58-322" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(avg = mean(body_mass_g))</span></span>
<span id="cb58-323"><a href="#cb58-323" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-324"><a href="#cb58-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-325"><a href="#cb58-325" aria-hidden="true" tabindex="-1"></a>Or we could use a couple intercept-free models to get the same values. Mathematically this is the same as grouping and summarizing, since regression is ultimately <span class="co">[</span><span class="ot">just fancy averaging</span><span class="co">](https://twitter.com/ajeanstevenson/status/1488601482505060352)</span>.</span>
<span id="cb58-326"><a href="#cb58-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-327"><a href="#cb58-327" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fancy-average-tweet, echo=FALSE, out.width="75%"}</span></span>
<span id="cb58-328"><a href="#cb58-328" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: '["Many things got easier once I accepted that regression is just fancy averaging." —\@ajeanstevenson](https://twitter.com/ajeanstevenson/status/1488601482505060352)'</span></span>
<span id="cb58-329"><a href="#cb58-329" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::include_graphics("img/fancy-averaging-tweet.png")</span></span>
<span id="cb58-330"><a href="#cb58-330" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-331"><a href="#cb58-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-332"><a href="#cb58-332" aria-hidden="true" tabindex="-1"></a><span class="in">```{r penguin-mm-models}</span></span>
<span id="cb58-333"><a href="#cb58-333" aria-hidden="true" tabindex="-1"></a><span class="in">bind_rows(</span></span>
<span id="cb58-334"><a href="#cb58-334" aria-hidden="true" tabindex="-1"></a><span class="in">  tidy(lm(body_mass_g ~ 0 + species, data = penguins)),</span></span>
<span id="cb58-335"><a href="#cb58-335" aria-hidden="true" tabindex="-1"></a><span class="in">  tidy(lm(body_mass_g ~ 0 + sex, data = penguins))</span></span>
<span id="cb58-336"><a href="#cb58-336" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb58-337"><a href="#cb58-337" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-338"><a href="#cb58-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-339"><a href="#cb58-339" aria-hidden="true" tabindex="-1"></a>Or even better, we can use <span class="co">[</span><span class="ot">`marginal_means()`</span><span class="co">](https://vincentarelbundock.github.io/marginaleffects/articles/marginalmeans.html)</span> from <span class="co">[</span><span class="ot">{marginaleffects}</span><span class="co">](https://vincentarelbundock.github.io/marginaleffects/)</span> (<span class="co">[</span><span class="ot">way more on that below!</span><span class="co">](#marginal-means-with-marginaleffects)</span>)</span>
<span id="cb58-340"><a href="#cb58-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-341"><a href="#cb58-341" aria-hidden="true" tabindex="-1"></a><span class="in">```{r penguin-mm-mfx}</span></span>
<span id="cb58-342"><a href="#cb58-342" aria-hidden="true" tabindex="-1"></a><span class="in">marginal_means(penguin_model, newdata = c("species", "sex"), wts = "cells")</span></span>
<span id="cb58-343"><a href="#cb58-343" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-344"><a href="#cb58-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-345"><a href="#cb58-345" aria-hidden="true" tabindex="-1"></a>Regardless of how we calculate these, the numbers are the same, and they represent average penguin weights in each of the species and both of the sexes. We can answer descriptive questions about the average weight of female penguins or the difference in average weights between Gentoo and Chinstrap penguins. There's no reference level—there are no regression switches or sliders—these are just averages.</span>
<span id="cb58-346"><a href="#cb58-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-347"><a href="#cb58-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-348"><a href="#cb58-348" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb58-349"><a href="#cb58-349" aria-hidden="true" tabindex="-1"></a><span class="fu">## Bonus: Market simulations</span></span>
<span id="cb58-350"><a href="#cb58-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-351"><a href="#cb58-351" aria-hidden="true" tabindex="-1"></a>There's an extra third option that I didn't include in @tbl-conjoint-estimands because it's not used often in my worlds of public policy and political science, but it is used *a lot* in marketing. In this approach, researchers use conjoint experiments to simulate the data generating process for an overall "market" of "products" (or candidates in this running example). </span>
<span id="cb58-352"><a href="#cb58-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-353"><a href="#cb58-353" aria-hidden="true" tabindex="-1"></a>Researchers build rich multilevel models to capture all the dynamics of the different respondent-level characteristics and the experimental features and levels and then create hypothetical "purchasers" with different covariate levels and see which combinations of individual characteristics and product characteristics influence the overall market share of products. Using the candidate experiment example, the market simulation would model the effect of different candidate features (religion, military experience, education, and so on) on the probability of choosing a candidate across individual respondent characteristics like ideology, political preferences, age, education, and so.</span>
<span id="cb58-354"><a href="#cb58-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-355"><a href="#cb58-355" aria-hidden="true" tabindex="-1"></a>From what I've seen, this market simulation-based approach is really rare in social science. In fact, <span class="co">[</span><span class="ot">this paper</span><span class="co">](https://www.andrewheiss.com/research/articles/chaudhry-dotson-heiss-2021/)</span> <span class="co">[</span><span class="ot">@ChaudhryDotsonHeiss:2021</span><span class="co">]</span> coauthored by Suparna Chaudhry, Marc Dotson, and me is the only political science-y one I know of! In it, we were interested in a host of different factors that drive individual preferences for charitable donations. We generated dozens of hypothetical donor personas and looked at how different categories of respondents felt about different features and how those preferences then influenced the market share of hypothetical nonprofits/NGOs.</span>
<span id="cb58-356"><a href="#cb58-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-357"><a href="#cb58-357" aria-hidden="true" tabindex="-1"></a>For example, here we can see the average predicted donation market shares across all donor personas, segmented by persona public affairs knowledge, political ideology, and social trust across different NGO–host government relationships. NGOs with friendly relationships with their host governments will receive a greater share of donations from the market, regardless of individual political ideology or political knowledge and travelling experience.</span>
<span id="cb58-358"><a href="#cb58-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-359"><a href="#cb58-359" aria-hidden="true" tabindex="-1"></a><span class="al">![Figure 4 from @ChaudhryDotsonHeiss:2021](img/who-cares_fig4.png)</span>{width=80%}</span>
<span id="cb58-360"><a href="#cb58-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-361"><a href="#cb58-361" aria-hidden="true" tabindex="-1"></a>Returning to the slider + switch analogy, this kind of market simulation is like an ultimate-super-mega-huge mixer board. We had to create a Shiny dashboard (<span class="co">[</span><span class="ot">accessible here</span><span class="co">](https://andrewheiss.shinyapps.io/why-donors-donate_market-simulator/)</span>) to explore all the different possible outcomes. It's wild.</span>
<span id="cb58-362"><a href="#cb58-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-363"><a href="#cb58-363" aria-hidden="true" tabindex="-1"></a><span class="al">![Screenshot of market simulator](img/simulator-screenshot.png)</span> </span>
<span id="cb58-364"><a href="#cb58-364" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb58-365"><a href="#cb58-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-366"><a href="#cb58-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-367"><a href="#cb58-367" aria-hidden="true" tabindex="-1"></a><span class="fu">## Relationship between AMCEs and marginal means</span></span>
<span id="cb58-368"><a href="#cb58-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-369"><a href="#cb58-369" aria-hidden="true" tabindex="-1"></a>Technically AMCEs and marginal means measure the same thing, just in different ways. Thinking about this in regression terms helps—with categorical marginal effects, the intercept for the model represents the average outcome for the omitted category, while the coefficient represents the offset from the average. The coefficient is the switch—turning it on changes the baseline reference category average by $\beta$ amount. </span>
<span id="cb58-370"><a href="#cb58-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-371"><a href="#cb58-371" aria-hidden="true" tabindex="-1"></a><span class="fu">### Penguin example</span></span>
<span id="cb58-372"><a href="#cb58-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-373"><a href="#cb58-373" aria-hidden="true" tabindex="-1"></a>Here's one last example from the non-conjoint penguins data, just to drive the point home. Let's make a super basic model that predicts weight based on sex only:</span>
<span id="cb58-374"><a href="#cb58-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-375"><a href="#cb58-375" aria-hidden="true" tabindex="-1"></a><span class="in">```{r penguin-model-sex-only}</span></span>
<span id="cb58-376"><a href="#cb58-376" aria-hidden="true" tabindex="-1"></a><span class="in">model_sex_only &lt;- lm(body_mass_g ~ sex, data = penguins)</span></span>
<span id="cb58-377"><a href="#cb58-377" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_sex_only)</span></span>
<span id="cb58-378"><a href="#cb58-378" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-379"><a href="#cb58-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-380"><a href="#cb58-380" aria-hidden="true" tabindex="-1"></a>The intercept shows average weight for female penguins (3862 grams), while the coefficient for <span class="in">`sexmale`</span> shows the change from that average when the "male" switch is turned on (683 more grams, on average).</span>
<span id="cb58-381"><a href="#cb58-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-382"><a href="#cb58-382" aria-hidden="true" tabindex="-1"></a>We can actually use these two pieces of information to find the average penguin weight across both sexes: females are 3862.3 grams, males are 3862.3 + 683.4 = 4546 grams. We can confirm this with a quick <span class="in">`group_by() %&gt;% summarize()`</span>:</span>
<span id="cb58-383"><a href="#cb58-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-384"><a href="#cb58-384" aria-hidden="true" tabindex="-1"></a><span class="in">```{r penguin-dplyr-sex-only}</span></span>
<span id="cb58-385"><a href="#cb58-385" aria-hidden="true" tabindex="-1"></a><span class="in">penguins %&gt;% </span></span>
<span id="cb58-386"><a href="#cb58-386" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(sex) %&gt;% </span></span>
<span id="cb58-387"><a href="#cb58-387" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(avg_weight = mean(body_mass_g))</span></span>
<span id="cb58-388"><a href="#cb58-388" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-389"><a href="#cb58-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-390"><a href="#cb58-390" aria-hidden="true" tabindex="-1"></a>Visualizing this should help even more with the general intuition. The horizontal distance between these two points is the same in each panel (683 grams). In the left panel, female weight is set at 0 since it's the omitted reference category. In the right panel, both males and females have specific group averages. These two panels are analgous to the conjoint idea of AMCEs and marginal means.</span>
<span id="cb58-391"><a href="#cb58-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-392"><a href="#cb58-392" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-penguin-averages, warning=FALSE, fig.width=6, fig.height=2}</span></span>
<span id="cb58-393"><a href="#cb58-393" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb58-394"><a href="#cb58-394" aria-hidden="true" tabindex="-1"></a><span class="in">p1 &lt;- model_sex_only %&gt;%</span></span>
<span id="cb58-395"><a href="#cb58-395" aria-hidden="true" tabindex="-1"></a><span class="in">  tidy_and_attach() %&gt;%</span></span>
<span id="cb58-396"><a href="#cb58-396" aria-hidden="true" tabindex="-1"></a><span class="in">  tidy_add_reference_rows() %&gt;%</span></span>
<span id="cb58-397"><a href="#cb58-397" aria-hidden="true" tabindex="-1"></a><span class="in">  tidy_add_estimate_to_reference_rows() %&gt;%</span></span>
<span id="cb58-398"><a href="#cb58-398" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(term != "(Intercept)") %&gt;%</span></span>
<span id="cb58-399"><a href="#cb58-399" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = estimate, y = term)) +</span></span>
<span id="cb58-400"><a href="#cb58-400" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_pointrange(aes(xmin = conf.low, xmax = conf.high)) +</span></span>
<span id="cb58-401"><a href="#cb58-401" aria-hidden="true" tabindex="-1"></a><span class="in">  annotate(</span></span>
<span id="cb58-402"><a href="#cb58-402" aria-hidden="true" tabindex="-1"></a><span class="in">    geom = "errorbar",</span></span>
<span id="cb58-403"><a href="#cb58-403" aria-hidden="true" tabindex="-1"></a><span class="in">    x = 0, xmin = 0, xmax = 683.4, y = 1.5,</span></span>
<span id="cb58-404"><a href="#cb58-404" aria-hidden="true" tabindex="-1"></a><span class="in">    width = 0.1, color = "grey70"</span></span>
<span id="cb58-405"><a href="#cb58-405" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb58-406"><a href="#cb58-406" aria-hidden="true" tabindex="-1"></a><span class="in">  annotate(</span></span>
<span id="cb58-407"><a href="#cb58-407" aria-hidden="true" tabindex="-1"></a><span class="in">    geom = "label",</span></span>
<span id="cb58-408"><a href="#cb58-408" aria-hidden="true" tabindex="-1"></a><span class="in">    x = 683.4 / 2, y = 1.5,</span></span>
<span id="cb58-409"><a href="#cb58-409" aria-hidden="true" tabindex="-1"></a><span class="in">    label = "683.4 grams",</span></span>
<span id="cb58-410"><a href="#cb58-410" aria-hidden="true" tabindex="-1"></a><span class="in">    size = 3</span></span>
<span id="cb58-411"><a href="#cb58-411" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb58-412"><a href="#cb58-412" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(</span></span>
<span id="cb58-413"><a href="#cb58-413" aria-hidden="true" tabindex="-1"></a><span class="in">    x = "Grams", y = NULL,</span></span>
<span id="cb58-414"><a href="#cb58-414" aria-hidden="true" tabindex="-1"></a><span class="in">    title = "Relative shift in average",</span></span>
<span id="cb58-415"><a href="#cb58-415" aria-hidden="true" tabindex="-1"></a><span class="in">    subtitle = "Similar to AMCEs"</span></span>
<span id="cb58-416"><a href="#cb58-416" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb58-417"><a href="#cb58-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-418"><a href="#cb58-418" aria-hidden="true" tabindex="-1"></a><span class="in">p2 &lt;- lm(body_mass_g ~ 0 + sex, data = penguins) %&gt;%</span></span>
<span id="cb58-419"><a href="#cb58-419" aria-hidden="true" tabindex="-1"></a><span class="in">  tidy(conf.int = TRUE) %&gt;%</span></span>
<span id="cb58-420"><a href="#cb58-420" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = estimate, y = term)) +</span></span>
<span id="cb58-421"><a href="#cb58-421" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_pointrange(aes(xmin = conf.low, xmax = conf.high)) +</span></span>
<span id="cb58-422"><a href="#cb58-422" aria-hidden="true" tabindex="-1"></a><span class="in">  annotate(</span></span>
<span id="cb58-423"><a href="#cb58-423" aria-hidden="true" tabindex="-1"></a><span class="in">    geom = "errorbar",</span></span>
<span id="cb58-424"><a href="#cb58-424" aria-hidden="true" tabindex="-1"></a><span class="in">    x = 3862, xmin = 3862, xmax = 4546, y = 1.5,</span></span>
<span id="cb58-425"><a href="#cb58-425" aria-hidden="true" tabindex="-1"></a><span class="in">    width = 0.1, color = "grey70"</span></span>
<span id="cb58-426"><a href="#cb58-426" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb58-427"><a href="#cb58-427" aria-hidden="true" tabindex="-1"></a><span class="in">  annotate(</span></span>
<span id="cb58-428"><a href="#cb58-428" aria-hidden="true" tabindex="-1"></a><span class="in">    geom = "label",</span></span>
<span id="cb58-429"><a href="#cb58-429" aria-hidden="true" tabindex="-1"></a><span class="in">    x = 4546 - (683.4/2), y = 1.5,</span></span>
<span id="cb58-430"><a href="#cb58-430" aria-hidden="true" tabindex="-1"></a><span class="in">    label = "683.4 grams",</span></span>
<span id="cb58-431"><a href="#cb58-431" aria-hidden="true" tabindex="-1"></a><span class="in">    size = 3</span></span>
<span id="cb58-432"><a href="#cb58-432" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb58-433"><a href="#cb58-433" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_comma()) +</span></span>
<span id="cb58-434"><a href="#cb58-434" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(</span></span>
<span id="cb58-435"><a href="#cb58-435" aria-hidden="true" tabindex="-1"></a><span class="in">    x = "Grams", y = NULL, </span></span>
<span id="cb58-436"><a href="#cb58-436" aria-hidden="true" tabindex="-1"></a><span class="in">    title = "Group averages",</span></span>
<span id="cb58-437"><a href="#cb58-437" aria-hidden="true" tabindex="-1"></a><span class="in">    subtitle = "Similar to marginal means"</span></span>
<span id="cb58-438"><a href="#cb58-438" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb58-439"><a href="#cb58-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-440"><a href="#cb58-440" aria-hidden="true" tabindex="-1"></a><span class="in">p1 | p2</span></span>
<span id="cb58-441"><a href="#cb58-441" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-442"><a href="#cb58-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-443"><a href="#cb58-443" aria-hidden="true" tabindex="-1"></a><span class="fu">### Conjoint AMCEs and marginal means (finally!)</span></span>
<span id="cb58-444"><a href="#cb58-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-445"><a href="#cb58-445" aria-hidden="true" tabindex="-1"></a>Okay, with that intuition nailed down, we can finally look at conjoint results. We'll look at the results from the candidate experiment in @HainmuellerHopkinsYamamoto:2014, which @LeeperHoboltTilley:2020 replicate and explore in their paper distinguishing between AMCEs and marginal means, and which we explored at the beginning of this post to show how conjoints work (i.e. there are seven candidate attributes like military service history, religion, gender, age, and so on).</span>
<span id="cb58-446"><a href="#cb58-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-447"><a href="#cb58-447" aria-hidden="true" tabindex="-1"></a>Here's an excerpt from Figure 1 in @LeeperHoboltTilley:2020, which shows both the published AMCEs and the Leeper, et al.-calculated marginal means from Hainmueller, Hopkins, and Yamamoto's original candidate study:</span>
<span id="cb58-448"><a href="#cb58-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-449"><a href="#cb58-449" aria-hidden="true" tabindex="-1"></a>::: {.column-page-inset .my-4}</span>
<span id="cb58-450"><a href="#cb58-450" aria-hidden="true" tabindex="-1"></a><span class="in">```{r leeper-et-al-fig1-excerpt, echo=FALSE, out.width="100%"}</span></span>
<span id="cb58-451"><a href="#cb58-451" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::include_graphics("img/SVG/leeper-et-al-2019_fig1_excerpt.svg")</span></span>
<span id="cb58-452"><a href="#cb58-452" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-453"><a href="#cb58-453" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb58-454"><a href="#cb58-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-455"><a href="#cb58-455" aria-hidden="true" tabindex="-1"></a>The AMCEs in the left panel have a direct causal interpretation. In this case, holding all else equal, changing a candidate from not having military service to serving in the military increases the probability of support (or overall favorability) by 0.09, or 9 percentage points. Similarly, changing from a nonreligious candidate to a Mormon candidate decreases the probability of support by 14 percentage points (!!!).^<span class="co">[</span><span class="ot">This study was written and published in 2013, right after the 2012 presidential election between Barack Obama and Mitt Romney, a Mormon who did surprisingly well considering longstanding anti-Mormon sentiment in American politics (for more on Mormons and American politics, see @Reeve:2015 and @McBrideRogersErekson:2020).</span><span class="co">]</span> There is no sex-based effect—changing a candidate from male to female has an AMCE of 0.0. </span>
<span id="cb58-456"><a href="#cb58-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-457"><a href="#cb58-457" aria-hidden="true" tabindex="-1"></a>The marginal means in the right panel don't rely on a reference category and are all centered around 50%—if there's no difference between the the levels in a two-level feature, we'd expect the averages for each level to be 50%. We can see this with sex, where both male and female candidates have a 50% probability of selection (or 50% favorability, or however we want to interpret the outcome here). </span>
<span id="cb58-458"><a href="#cb58-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-459"><a href="#cb58-459" aria-hidden="true" tabindex="-1"></a>With the AMCEs, we saw a 9 percentage point increase in favorability caused by military service. That same 9-point difference is visible in the marginal means: candidates without military service history have 46% favorability compared to the 54% favorability among those with military history (54−46 = 9).</span>
<span id="cb58-460"><a href="#cb58-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-461"><a href="#cb58-461" aria-hidden="true" tabindex="-1"></a>The presence of a reference category doesn't matter much when dealing with binary treatments like sex and military service here. If we reversed the reference category, we'd get the same causal effect but in reverse—not serving in the military causes a 9 percentage point drop in favorability. </span>
<span id="cb58-462"><a href="#cb58-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-463"><a href="#cb58-463" aria-hidden="true" tabindex="-1"></a>The reference category matters a lot, however, in attributes with more than two levels, like religion. In the AMCE panel, all the causal effects are in reference to a candidate with no religion. Being Mormon causes a 14 percentage point drop from having no religion; being Evangelical causes a 12 percentage point drop from having no religion; and so on. Deciding which level to use as the omitted reference category matters and can seriously change the causal interpretation of the AMCEs. For instance, here it looks like there's a serious penalty for being Mormon or Evangelical, while being Protestant, Catholic, or Jewish doesn't matter. But that's only the case from a certain point of view. If an Evangelical candidate were the reference category, there wouldn't be any significant Mormon effect (but there would be a Protestant, Catholic, Jewish, and None effect).</span>
<span id="cb58-464"><a href="#cb58-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-465"><a href="#cb58-465" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb58-466"><a href="#cb58-466" aria-hidden="true" tabindex="-1"></a><span class="al">!["What I told you was true… from a certain point of view"&lt;br&gt;—Obi-Wan Kenobi](img/obiwan-pov.jpg)</span></span>
<span id="cb58-467"><a href="#cb58-467" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb58-468"><a href="#cb58-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-469"><a href="#cb58-469" aria-hidden="true" tabindex="-1"></a>The reference category gets in the way of making descriptive statements like "Mormon candidates see 42% favorability, while Jewish candidates see 52% favorability." You can't get numbers like that from the AMCEs alone unless you know the underlying favorability of the reference category and then reconstruct the other categories' averages by hand. But researchers working with conjoint experiments try to do this with AMCEs all the time. @LeeperHoboltTilley:2020 argue that </span>
<span id="cb58-470"><a href="#cb58-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-471"><a href="#cb58-471" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; AMCEs are relative, not absolute, statements about preferences. As such, there is simply no predictable connection between subgroup causal effects and the levels of underlying subgroup preferences. Yet, analysts and their readers frequently interpret differences in conditional AMCEs as differences in underlying preferences </span><span class="co">[</span><span class="ot">@LeeperHoboltTilley:2020, 214</span><span class="co">]</span><span class="at">.</span></span>
<span id="cb58-472"><a href="#cb58-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-473"><a href="#cb58-473" aria-hidden="true" tabindex="-1"></a>**The key point is this**: AMCEs are relative statements, not absolute statements. If we want to talk about the causal effect of moving one attribute level (None → Mormon, None → Catholic, Male → Female, etc.), we can use AMCEs. If we want to talk about general preferences or favorabilities or probabilities or average outcomes, we need to talk about marginal means.</span>
<span id="cb58-474"><a href="#cb58-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-475"><a href="#cb58-475" aria-hidden="true" tabindex="-1"></a><span class="fu">## AMCEs and marginal means across subgroups</span></span>
<span id="cb58-476"><a href="#cb58-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-477"><a href="#cb58-477" aria-hidden="true" tabindex="-1"></a>This issue with relative vs. absolute estimands is *especially* complex when thinking about subgroups or controlling for respondent-level characteristics like political ideology, sex, education, and so on. Suppose we want to know if this Mormon penalty is bigger among Democratic respondents than Republican respondents. We could control for respondent ideology, or calculate two different AMCEs—one when Democrat = true and one when Republican = true. This seems all good and logical. And it it's fine if you're talking about causal effects. But once you start trying to compare overall trends across respondent-level subgroups, AMCEs will give you wrong estimates! The main argument in @LeeperHoboltTilley:2020 is that looking at AMCEs across respondent subgroups doesn't work people think it does because AMCEs are relative and not absolute. The difference between the relative Mormon candidate AMCE among Democratic-leaning and Republican-leaning respondents isn't really comparable to the party-based differences in other levels (Evangelicals, Catholics, etc.).</span>
<span id="cb58-478"><a href="#cb58-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-479"><a href="#cb58-479" aria-hidden="true" tabindex="-1"></a>@LeeperHoboltTilley:2020 illustrate this idea in a neat way in their Figure 2 (included below). This figure recreates the results for the "candidate sex" feature in a different candidate conjoint experiment done by @TeeleKallaRosenbluth:2018. In this case, unlike our running example from @HainmuellerHopkinsYamamoto:2014's study, there *is* a sex effect—a candidate being female causes a 4.5 percentage point increase in favorability. We can see this in the top two panels, both as an AMCE of 0.045 and as marginal means (female = 0.52; male = 0.48; difference = AMCE = 0.045). </span>
<span id="cb58-480"><a href="#cb58-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-481"><a href="#cb58-481" aria-hidden="true" tabindex="-1"></a><span class="in">```{r leeper-et-al-fig2, echo=FALSE, out.width="75%"}</span></span>
<span id="cb58-482"><a href="#cb58-482" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::include_graphics("img/SVG/leeper-et-al-2019_fig2.svg")</span></span>
<span id="cb58-483"><a href="#cb58-483" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-484"><a href="#cb58-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-485"><a href="#cb58-485" aria-hidden="true" tabindex="-1"></a>The third panel shows two different AMCEs conditional on respondent political party, and it appeared in the published study. Because AMCEs require a reference category as the baseline, and because AMCEs are relative quantities, it looks like there's a huge party-based difference in favorability toward women candidates—being a woman causes a 7ish percentage point boost in favorability among Democrats, while it does nothing (or maybe something negative) among Republicans. These are conditional AMCEs (or CAMCEs), or the causal effect of turning on the "female" switch for a hypothetical candidate across Republican and Democratic respondents.</span>
<span id="cb58-486"><a href="#cb58-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-487"><a href="#cb58-487" aria-hidden="true" tabindex="-1"></a>Conditional AMCEs are fine for causal work, but what trips people up often is that it's tempting to use those conditional effects to describe actual overall patterns of preferences. Because there's a reference category involved (male candidates), we can't really say anything about the general respondent-party-ID-based preferences for male and female candidates. The conditional AMCE here combines the party-based difference in favorability toward female candidates (53.7% among Democrats; 49.2% among Republicans; difference of 4.5 percentage points) and the party-based difference in favorability toward male candidates (46.3% among Democrats; 50.8% among Republicans; difference of 4.5 percentage points). According to Leeper, et al.:</span>
<span id="cb58-488"><a href="#cb58-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-489"><a href="#cb58-489" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Because Democrats and Republicans actually differ in their views of profiles containing the reference (male) category, AMCEs sum the true differences in preferences for a given feature level with the difference in preferences toward the reference category. Visual or numerical similarity of subgroup AMCEs is therefore an analytical artifact, not an accurate statement of the similarity of patterns of preferences </span><span class="co">[</span><span class="ot">@LeeperHoboltTilley:2020, 215</span><span class="co">]</span><span class="at">.</span></span>
<span id="cb58-490"><a href="#cb58-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-491"><a href="#cb58-491" aria-hidden="true" tabindex="-1"></a>If we're interested not in describing a causal effect (i.e. the effect of switching from male → female) but instead describing general preferences (i.e. the difference in overall candidate sex favorability between Republicans and Democrats), we have to look at marginal means (and the difference in marginal means) instead of conditional AMCEs. It is really tempting to look at the distance between Republicans and Democrats in the "Female" level in the third panel and say that there's a nearly 10 percentage point difference in favorability across parties, but that's wrong! It only looks that way because the effect sizes are all relative to the reference "Male" level. </span>
<span id="cb58-492"><a href="#cb58-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-493"><a href="#cb58-493" aria-hidden="true" tabindex="-1"></a><span class="in">```{r leeper-et-al-fig2-excerpt, echo=FALSE, out.width="75%"}</span></span>
<span id="cb58-494"><a href="#cb58-494" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::include_graphics("img/SVG/leeper-et-al-2019_fig2_excerpt.svg")</span></span>
<span id="cb58-495"><a href="#cb58-495" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-496"><a href="#cb58-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-497"><a href="#cb58-497" aria-hidden="true" tabindex="-1"></a>In reality, Democrats are 4.5 percentage points less likely to select a male candidate and 4.5 percentage points more likely to select a female candidate. The differences in marginal means within party subgroups would look like this:</span>
<span id="cb58-498"><a href="#cb58-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-499"><a href="#cb58-499" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-diff-mm-parties, warning=FALSE, fig.width=6, fig.height=3}</span></span>
<span id="cb58-500"><a href="#cb58-500" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb58-501"><a href="#cb58-501" aria-hidden="true" tabindex="-1"></a><span class="in"># Teele, Kalla, and Rosenbluth 2018 data from https://doi.org/10.7910/DVN/FVCGHC</span></span>
<span id="cb58-502"><a href="#cb58-502" aria-hidden="true" tabindex="-1"></a><span class="in">candidate_parties &lt;- read_stata("data/conjoint_data.dta") %&gt;% </span></span>
<span id="cb58-503"><a href="#cb58-503" aria-hidden="true" tabindex="-1"></a><span class="in">  as_factor() %&gt;%</span></span>
<span id="cb58-504"><a href="#cb58-504" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(female = factor(orig_cand_gender_string)) %&gt;% </span></span>
<span id="cb58-505"><a href="#cb58-505" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(female = fct_relevel(female, "Male")) %&gt;% </span></span>
<span id="cb58-506"><a href="#cb58-506" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(party_respondent = case_when(</span></span>
<span id="cb58-507"><a href="#cb58-507" aria-hidden="true" tabindex="-1"></a><span class="in">    democrat_respondent == 1 ~ "Democrat",</span></span>
<span id="cb58-508"><a href="#cb58-508" aria-hidden="true" tabindex="-1"></a><span class="in">    republican_respondent == 1 ~ "Republican"</span></span>
<span id="cb58-509"><a href="#cb58-509" aria-hidden="true" tabindex="-1"></a><span class="in">  )) %&gt;% </span></span>
<span id="cb58-510"><a href="#cb58-510" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(party_respondent = factor(party_respondent)) %&gt;% </span></span>
<span id="cb58-511"><a href="#cb58-511" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(sample == "usa voter")</span></span>
<span id="cb58-512"><a href="#cb58-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-513"><a href="#cb58-513" aria-hidden="true" tabindex="-1"></a><span class="in">mm_diffs(</span></span>
<span id="cb58-514"><a href="#cb58-514" aria-hidden="true" tabindex="-1"></a><span class="in">  candidate_parties,</span></span>
<span id="cb58-515"><a href="#cb58-515" aria-hidden="true" tabindex="-1"></a><span class="in">  winner ~ female,</span></span>
<span id="cb58-516"><a href="#cb58-516" aria-hidden="true" tabindex="-1"></a><span class="in">  by = ~party_respondent</span></span>
<span id="cb58-517"><a href="#cb58-517" aria-hidden="true" tabindex="-1"></a><span class="in">) %&gt;%</span></span>
<span id="cb58-518"><a href="#cb58-518" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = estimate, y = level)) +</span></span>
<span id="cb58-519"><a href="#cb58-519" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0) +</span></span>
<span id="cb58-520"><a href="#cb58-520" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_pointrange(aes(</span></span>
<span id="cb58-521"><a href="#cb58-521" aria-hidden="true" tabindex="-1"></a><span class="in">    xmin = lower, xmax = upper, </span></span>
<span id="cb58-522"><a href="#cb58-522" aria-hidden="true" tabindex="-1"></a><span class="in">    color = "Republican marginal mean − Democrat marginal mean"</span></span>
<span id="cb58-523"><a href="#cb58-523" aria-hidden="true" tabindex="-1"></a><span class="in">  )) +</span></span>
<span id="cb58-524"><a href="#cb58-524" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_pp) +</span></span>
<span id="cb58-525"><a href="#cb58-525" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_color_manual(values = "#85144b") +</span></span>
<span id="cb58-526"><a href="#cb58-526" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(</span></span>
<span id="cb58-527"><a href="#cb58-527" aria-hidden="true" tabindex="-1"></a><span class="in">    x = "Difference in marginal means",</span></span>
<span id="cb58-528"><a href="#cb58-528" aria-hidden="true" tabindex="-1"></a><span class="in">    y = NULL,</span></span>
<span id="cb58-529"><a href="#cb58-529" aria-hidden="true" tabindex="-1"></a><span class="in">    color = NULL,</span></span>
<span id="cb58-530"><a href="#cb58-530" aria-hidden="true" tabindex="-1"></a><span class="in">    title = "Difference in marginal means between\nRepublican and Democratic respondents",</span></span>
<span id="cb58-531"><a href="#cb58-531" aria-hidden="true" tabindex="-1"></a><span class="in">    subtitle = "Positive differences = Republicans prefer the level"</span></span>
<span id="cb58-532"><a href="#cb58-532" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb58-533"><a href="#cb58-533" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(vars("Candidate sex")) +</span></span>
<span id="cb58-534"><a href="#cb58-534" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(</span></span>
<span id="cb58-535"><a href="#cb58-535" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.position = "bottom",</span></span>
<span id="cb58-536"><a href="#cb58-536" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.justification = "left",</span></span>
<span id="cb58-537"><a href="#cb58-537" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.margin = margin(l = -7, t = -5)</span></span>
<span id="cb58-538"><a href="#cb58-538" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb58-539"><a href="#cb58-539" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-540"><a href="#cb58-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-541"><a href="#cb58-541" aria-hidden="true" tabindex="-1"></a>(For more about this, see @LeeperHoboltTilley:2020 for a few other examples of the substantive differences between subgroup conditional AMCEs and subgroup differences-between-marginal-means.)</span>
<span id="cb58-542"><a href="#cb58-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-543"><a href="#cb58-543" aria-hidden="true" tabindex="-1"></a>**Long story short**: because AMCEs are relative estimands, they get weird (and can't really be used) when using them for descriptive estimands across subgroups or when controlling for other respondent characteristics. To account for this weirdness, calculate marginal means instead and find the subgroup differences in marginal means for each level.</span>
<span id="cb58-544"><a href="#cb58-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-545"><a href="#cb58-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-546"><a href="#cb58-546" aria-hidden="true" tabindex="-1"></a><span class="fu"># Finding conjoint AMCEs and marginal means frequentistly {#sec-frequentist}</span></span>
<span id="cb58-547"><a href="#cb58-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-548"><a href="#cb58-548" aria-hidden="true" tabindex="-1"></a>So now that we know what these two estimands are actually measuring and we have a general sense for how to calculate them (AMCE = regression coefficients where there's an omitted reference category; marginal means = conditional averages for different category levels), let's replicate the results from the candidate experiment in @HainmuellerHopkinsYamamoto:2014. We'll do it the easy automatic way with <span class="co">[</span><span class="ot">Thomas Leeper's {cregg} package</span><span class="co">](https://thomasleeper.com/cregg/)</span> (named after <span class="co">[</span><span class="ot">CJ Cregg from *The West Wing*</span><span class="co">](https://en.wikipedia.org/wiki/C._J._Cregg)</span>), then we'll do it more manually to see what's going on behind the scenes.</span>
<span id="cb58-549"><a href="#cb58-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-550"><a href="#cb58-550" aria-hidden="true" tabindex="-1"></a><span class="fu">## AMCEs</span></span>
<span id="cb58-551"><a href="#cb58-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-552"><a href="#cb58-552" aria-hidden="true" tabindex="-1"></a>First we'll calculate the average marginal component effects (AMCEs), which are the partial derivatives (or coefficients) from a linear regression model. These represent the *causal* effect of switching from some reference level to a level of interest, while holding everything else constant.</span>
<span id="cb58-553"><a href="#cb58-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-554"><a href="#cb58-554" aria-hidden="true" tabindex="-1"></a><span class="fu">### Automatic estimates with `cregg::amce()`</span></span>
<span id="cb58-555"><a href="#cb58-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-556"><a href="#cb58-556" aria-hidden="true" tabindex="-1"></a>The <span class="in">`amce()`</span> function from {cregg} calculates AMCEs automatically and returns them in a nice tidy data frame:</span>
<span id="cb58-557"><a href="#cb58-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-558"><a href="#cb58-558" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-amce, warning=FALSE}</span></span>
<span id="cb58-559"><a href="#cb58-559" aria-hidden="true" tabindex="-1"></a><span class="in">model_candidate_amce &lt;- amce(</span></span>
<span id="cb58-560"><a href="#cb58-560" aria-hidden="true" tabindex="-1"></a><span class="in">  candidate,</span></span>
<span id="cb58-561"><a href="#cb58-561" aria-hidden="true" tabindex="-1"></a><span class="in">  selected ~ atmilitary + atreligion + ated +</span></span>
<span id="cb58-562"><a href="#cb58-562" aria-hidden="true" tabindex="-1"></a><span class="in">    atprof + atinc + atrace + atage + atmale,</span></span>
<span id="cb58-563"><a href="#cb58-563" aria-hidden="true" tabindex="-1"></a><span class="in">  id = ~resID</span></span>
<span id="cb58-564"><a href="#cb58-564" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb58-565"><a href="#cb58-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-566"><a href="#cb58-566" aria-hidden="true" tabindex="-1"></a><span class="in">model_candidate_amce %&gt;% as_tibble()</span></span>
<span id="cb58-567"><a href="#cb58-567" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-568"><a href="#cb58-568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-569"><a href="#cb58-569" aria-hidden="true" tabindex="-1"></a>It also provides an automatic plot function. Compare this with the original—the results are identical.</span>
<span id="cb58-570"><a href="#cb58-570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-571"><a href="#cb58-571" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb58-572"><a href="#cb58-572" aria-hidden="true" tabindex="-1"></a><span class="fu">### `plot(cregg::amce())`</span></span>
<span id="cb58-573"><a href="#cb58-573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-574"><a href="#cb58-574" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-amce-automatic, fig.width=6, fig.height=8}</span></span>
<span id="cb58-575"><a href="#cb58-575" aria-hidden="true" tabindex="-1"></a><span class="in">plot(model_candidate_amce) + </span></span>
<span id="cb58-576"><a href="#cb58-576" aria-hidden="true" tabindex="-1"></a><span class="in">  guides(color = "none") +</span></span>
<span id="cb58-577"><a href="#cb58-577" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice() +</span></span>
<span id="cb58-578"><a href="#cb58-578" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(title = "AMCEs from cregg::amce()")</span></span>
<span id="cb58-579"><a href="#cb58-579" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-580"><a href="#cb58-580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-581"><a href="#cb58-581" aria-hidden="true" tabindex="-1"></a><span class="fu">### Original AMCE coefficent plot</span></span>
<span id="cb58-582"><a href="#cb58-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-583"><a href="#cb58-583" aria-hidden="true" tabindex="-1"></a>Right panel of Figure 1 in @LeeperHoboltTilley:2020:</span>
<span id="cb58-584"><a href="#cb58-584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-585"><a href="#cb58-585" aria-hidden="true" tabindex="-1"></a><span class="in">```{=html}</span></span>
<span id="cb58-586"><a href="#cb58-586" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;img src="img/SVG/leeper-et-al-2019_fig1_amces.svg" width="100%" onerror="this.src='img/3x/leeper-et-al-2019_fig1_amces@3x.png'; this.onerror=null"&gt;</span></span>
<span id="cb58-587"><a href="#cb58-587" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-588"><a href="#cb58-588" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb58-589"><a href="#cb58-589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-590"><a href="#cb58-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-591"><a href="#cb58-591" aria-hidden="true" tabindex="-1"></a><span class="fu">### OLS coefficients</span></span>
<span id="cb58-592"><a href="#cb58-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-593"><a href="#cb58-593" aria-hidden="true" tabindex="-1"></a>Behind the scenes, {cregg} uses <span class="in">`survey::svyglm()`</span> to run OLS with ID-specific adjustments to standard errors:</span>
<span id="cb58-594"><a href="#cb58-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-595"><a href="#cb58-595" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-svyglm}</span></span>
<span id="cb58-596"><a href="#cb58-596" aria-hidden="true" tabindex="-1"></a><span class="in">candidate_svy_design &lt;- svydesign(</span></span>
<span id="cb58-597"><a href="#cb58-597" aria-hidden="true" tabindex="-1"></a><span class="in">  ids = ~resID,</span></span>
<span id="cb58-598"><a href="#cb58-598" aria-hidden="true" tabindex="-1"></a><span class="in">  weights = ~1,</span></span>
<span id="cb58-599"><a href="#cb58-599" aria-hidden="true" tabindex="-1"></a><span class="in">  data = candidate</span></span>
<span id="cb58-600"><a href="#cb58-600" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb58-601"><a href="#cb58-601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-602"><a href="#cb58-602" aria-hidden="true" tabindex="-1"></a><span class="in">model_svy &lt;- svyglm(</span></span>
<span id="cb58-603"><a href="#cb58-603" aria-hidden="true" tabindex="-1"></a><span class="in">  selected ~ atmilitary + atreligion + ated +</span></span>
<span id="cb58-604"><a href="#cb58-604" aria-hidden="true" tabindex="-1"></a><span class="in">    atprof + atinc + atrace + atage + atmale,</span></span>
<span id="cb58-605"><a href="#cb58-605" aria-hidden="true" tabindex="-1"></a><span class="in">  design = candidate_svy_design</span></span>
<span id="cb58-606"><a href="#cb58-606" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb58-607"><a href="#cb58-607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-608"><a href="#cb58-608" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_svy)</span></span>
<span id="cb58-609"><a href="#cb58-609" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-610"><a href="#cb58-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-611"><a href="#cb58-611" aria-hidden="true" tabindex="-1"></a>These estimates and standard errors are the same results that we get from <span class="in">`cregg::amce()`</span>:</span>
<span id="cb58-612"><a href="#cb58-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-613"><a href="#cb58-613" aria-hidden="true" tabindex="-1"></a><span class="in">```{r check-amce-svy-results}</span></span>
<span id="cb58-614"><a href="#cb58-614" aria-hidden="true" tabindex="-1"></a><span class="in"># Combine the estimates from cregg::amce() with the estimates from</span></span>
<span id="cb58-615"><a href="#cb58-615" aria-hidden="true" tabindex="-1"></a><span class="in"># survey::svglm() just to check that they're the same (they are)</span></span>
<span id="cb58-616"><a href="#cb58-616" aria-hidden="true" tabindex="-1"></a><span class="in">amce_estimates &lt;- model_candidate_amce %&gt;% </span></span>
<span id="cb58-617"><a href="#cb58-617" aria-hidden="true" tabindex="-1"></a><span class="in">  as_tibble() %&gt;% </span></span>
<span id="cb58-618"><a href="#cb58-618" aria-hidden="true" tabindex="-1"></a><span class="in">  drop_na(std.error) %&gt;% </span></span>
<span id="cb58-619"><a href="#cb58-619" aria-hidden="true" tabindex="-1"></a><span class="in">  select(level, amce_estimate = estimate, amce_std.error = std.error)</span></span>
<span id="cb58-620"><a href="#cb58-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-621"><a href="#cb58-621" aria-hidden="true" tabindex="-1"></a><span class="in">svy_estimates &lt;- model_svy %&gt;% </span></span>
<span id="cb58-622"><a href="#cb58-622" aria-hidden="true" tabindex="-1"></a><span class="in">  tidy() %&gt;% </span></span>
<span id="cb58-623"><a href="#cb58-623" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(term != "(Intercept)") %&gt;% </span></span>
<span id="cb58-624"><a href="#cb58-624" aria-hidden="true" tabindex="-1"></a><span class="in">  select(svy_estimate = estimate, svy_std.error = std.error)</span></span>
<span id="cb58-625"><a href="#cb58-625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-626"><a href="#cb58-626" aria-hidden="true" tabindex="-1"></a><span class="in">bind_cols(amce_estimates, svy_estimates)</span></span>
<span id="cb58-627"><a href="#cb58-627" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-628"><a href="#cb58-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-629"><a href="#cb58-629" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-630"><a href="#cb58-630" aria-hidden="true" tabindex="-1"></a><span class="fu">### Marginal effects instead of coefficients</span></span>
<span id="cb58-631"><a href="#cb58-631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-632"><a href="#cb58-632" aria-hidden="true" tabindex="-1"></a>So these OLS coefficients here are the AMCEs. That's super straightforward.</span>
<span id="cb58-633"><a href="#cb58-633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-634"><a href="#cb58-634" aria-hidden="true" tabindex="-1"></a>That's only true because we're estimating a <span class="co">[</span><span class="ot">linear probability model (LPM)</span><span class="co">](https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/index.html#linear-probability-models)</span> here. <span class="in">`selected`</span> is a binary 0/1 variable, but we're pretending it's numeric and using OLS with it. In this special case, the marginal effects (slopes) are just the partial derivatives reported in the regression table.</span>
<span id="cb58-635"><a href="#cb58-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-636"><a href="#cb58-636" aria-hidden="true" tabindex="-1"></a>But if we're going to have interaction terms, or nonlinear terms (like polynomials), or if we're going to use a model family that's not OLS (like logistic regression), raw coefficients won't work. Instead we need to calculate actual marginal effects (see <span class="co">[</span><span class="ot">this post</span><span class="co">](https://www.andrewheiss.com/blog/2022/05/20/marginalia/)</span> and the <span class="co">[</span><span class="ot">"Get Started" page at the {marginaleffects} documentation</span><span class="co">](https://vincentarelbundock.github.io/marginaleffects/articles/marginaleffects.html)</span> for more details about these). </span>
<span id="cb58-637"><a href="#cb58-637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-638"><a href="#cb58-638" aria-hidden="true" tabindex="-1"></a>At one point, {cregg} supported this by using the {margins} package (which makes sense—<span class="co">[</span><span class="ot">Thomas Leeper</span><span class="co">](https://thomasleeper.com/)</span> developed both {cregg} and {margins}), but <span class="co">[</span><span class="ot">starting with {cregg} version 0.1.14</span><span class="co">](https://github.com/leeper/cregg/blob/main/NEWS.md#cregg-0114)</span>, the {margins} support disappeared, leaving only support for OLS linear probability models. </span>
<span id="cb58-639"><a href="#cb58-639" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-640"><a href="#cb58-640" aria-hidden="true" tabindex="-1"></a>We can use the <span class="co">[</span><span class="ot">{marginaleffects} package</span><span class="co">](https://vincentarelbundock.github.io/marginaleffects/)</span> (the successor to {margins}) to calculate the average marginal effects/slopes for each of these effects. Here we'll just hold all the predictors at their means (but there are <span class="co">[</span><span class="ot">a ton of different estimands</span><span class="co">](https://www.andrewheiss.com/blog/2022/05/20/marginalia/#tldr-overall-summary-of-all-these-marginal-effects-approaches)</span> we could calculate). In this case they're the same as the raw coefficients, since it's just a linear model:</span>
<span id="cb58-641"><a href="#cb58-641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-642"><a href="#cb58-642" aria-hidden="true" tabindex="-1"></a><span class="in">```{r candidate-svy-mfx}</span></span>
<span id="cb58-643"><a href="#cb58-643" aria-hidden="true" tabindex="-1"></a><span class="in">mfx_svy &lt;- model_svy %&gt;% </span></span>
<span id="cb58-644"><a href="#cb58-644" aria-hidden="true" tabindex="-1"></a><span class="in">  avg_slopes(newdata = "mean")</span></span>
<span id="cb58-645"><a href="#cb58-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-646"><a href="#cb58-646" aria-hidden="true" tabindex="-1"></a><span class="in"># Combine the average marginal effects with the original coefficients just to</span></span>
<span id="cb58-647"><a href="#cb58-647" aria-hidden="true" tabindex="-1"></a><span class="in"># check that they're the same (they are)</span></span>
<span id="cb58-648"><a href="#cb58-648" aria-hidden="true" tabindex="-1"></a><span class="in">mfx_svy %&gt;% </span></span>
<span id="cb58-649"><a href="#cb58-649" aria-hidden="true" tabindex="-1"></a><span class="in">  select(contrast, mfx_estimate = estimate, mfx_std.error = std.error) %&gt;% </span></span>
<span id="cb58-650"><a href="#cb58-650" aria-hidden="true" tabindex="-1"></a><span class="in">  cbind(svy_estimates) %&gt;% </span></span>
<span id="cb58-651"><a href="#cb58-651" aria-hidden="true" tabindex="-1"></a><span class="in">  as_tibble()</span></span>
<span id="cb58-652"><a href="#cb58-652" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-653"><a href="#cb58-653" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-654"><a href="#cb58-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-655"><a href="#cb58-655" aria-hidden="true" tabindex="-1"></a><span class="fu">### Coefficient plots</span></span>
<span id="cb58-656"><a href="#cb58-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-657"><a href="#cb58-657" aria-hidden="true" tabindex="-1"></a>What about that neat coefficient plot with the reference categories? <span class="in">`tidy()`</span> can't return empty rows for the reference levels like <span class="in">`cregg::amce()`</span> does, but we can make it work in a couple different ways: (1) automatically with <span class="in">`broom.helpers::tidy_add_reference_rows()`</span>, or (2) manually with some data wrangling.</span>
<span id="cb58-658"><a href="#cb58-658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-659"><a href="#cb58-659" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Automatically with {broom.helpers}</span></span>
<span id="cb58-660"><a href="#cb58-660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-661"><a href="#cb58-661" aria-hidden="true" tabindex="-1"></a>The easiest way to do this is to use <span class="in">`broom.helpers::tidy_add_reference_rows()`</span>, which adds the reference levels automatically with estimates of 0, so we can use <span class="in">`geom_pointrange()`</span> and make basically the same plot as {cregg}:</span>
<span id="cb58-662"><a href="#cb58-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-663"><a href="#cb58-663" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-amce-broom-helper, fig.width=6, fig.height=8, warning=FALSE}</span></span>
<span id="cb58-664"><a href="#cb58-664" aria-hidden="true" tabindex="-1"></a><span class="in">plot_data_manual &lt;- model_svy %&gt;% </span></span>
<span id="cb58-665"><a href="#cb58-665" aria-hidden="true" tabindex="-1"></a><span class="in">  tidy_and_attach() %&gt;% </span></span>
<span id="cb58-666"><a href="#cb58-666" aria-hidden="true" tabindex="-1"></a><span class="in">  tidy_add_reference_rows() %&gt;% </span></span>
<span id="cb58-667"><a href="#cb58-667" aria-hidden="true" tabindex="-1"></a><span class="in">  tidy_add_estimate_to_reference_rows() %&gt;% </span></span>
<span id="cb58-668"><a href="#cb58-668" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(term != "(Intercept)") %&gt;% </span></span>
<span id="cb58-669"><a href="#cb58-669" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(term_nice = str_remove(term, variable)) %&gt;% </span></span>
<span id="cb58-670"><a href="#cb58-670" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(variable_lookup, by = join_by(variable)) %&gt;% </span></span>
<span id="cb58-671"><a href="#cb58-671" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(across(c(term_nice, variable_nice), ~fct_inorder(.)))</span></span>
<span id="cb58-672"><a href="#cb58-672" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-673"><a href="#cb58-673" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(</span></span>
<span id="cb58-674"><a href="#cb58-674" aria-hidden="true" tabindex="-1"></a><span class="in">  plot_data_manual,</span></span>
<span id="cb58-675"><a href="#cb58-675" aria-hidden="true" tabindex="-1"></a><span class="in">  aes(x = estimate, y = term_nice, color = variable_nice)</span></span>
<span id="cb58-676"><a href="#cb58-676" aria-hidden="true" tabindex="-1"></a><span class="in">) +</span></span>
<span id="cb58-677"><a href="#cb58-677" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0) +</span></span>
<span id="cb58-678"><a href="#cb58-678" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_pointrange(aes(xmin = conf.low, xmax = conf.high)) +</span></span>
<span id="cb58-679"><a href="#cb58-679" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_pp) +</span></span>
<span id="cb58-680"><a href="#cb58-680" aria-hidden="true" tabindex="-1"></a><span class="in">  guides(color = "none") +</span></span>
<span id="cb58-681"><a href="#cb58-681" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(</span></span>
<span id="cb58-682"><a href="#cb58-682" aria-hidden="true" tabindex="-1"></a><span class="in">    x = "Percentage point change in probability of candidate selection",</span></span>
<span id="cb58-683"><a href="#cb58-683" aria-hidden="true" tabindex="-1"></a><span class="in">    y = NULL,</span></span>
<span id="cb58-684"><a href="#cb58-684" aria-hidden="true" tabindex="-1"></a><span class="in">    title = "AMCEs plotted with tidy_add_reference_rows()"</span></span>
<span id="cb58-685"><a href="#cb58-685" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb58-686"><a href="#cb58-686" aria-hidden="true" tabindex="-1"></a><span class="in">  # Automatically resize each facet height with ggforce::facet_col()</span></span>
<span id="cb58-687"><a href="#cb58-687" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_col(facets = "variable_nice", scales = "free_y", space = "free")</span></span>
<span id="cb58-688"><a href="#cb58-688" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-689"><a href="#cb58-689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-690"><a href="#cb58-690" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-691"><a href="#cb58-691" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Manually with {dplyr} wrangling magic</span></span>
<span id="cb58-692"><a href="#cb58-692" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-693"><a href="#cb58-693" aria-hidden="true" tabindex="-1"></a>However, <span class="in">`tidy_add_reference_rows()`</span> doesn't work with {marginaleffects} objects or multilevel models or Bayesian models, so ultimately I can't use this in the real project I'm working on :(</span>
<span id="cb58-694"><a href="#cb58-694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-695"><a href="#cb58-695" aria-hidden="true" tabindex="-1"></a>But we can get the same thing with some fancy data wrangling:</span>
<span id="cb58-696"><a href="#cb58-696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-697"><a href="#cb58-697" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-amce-tidy, fig.width=6, fig.height=8, warning=FALSE}</span></span>
<span id="cb58-698"><a href="#cb58-698" aria-hidden="true" tabindex="-1"></a><span class="in"># Extract all the right-hand variables</span></span>
<span id="cb58-699"><a href="#cb58-699" aria-hidden="true" tabindex="-1"></a><span class="in">rhs_vars &lt;- all.vars(stats::update(formula(model_svy), 0 ~ .))</span></span>
<span id="cb58-700"><a href="#cb58-700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-701"><a href="#cb58-701" aria-hidden="true" tabindex="-1"></a><span class="in"># Make a data frame of all the levels of all the non-numeric things</span></span>
<span id="cb58-702"><a href="#cb58-702" aria-hidden="true" tabindex="-1"></a><span class="in">model_variable_levels &lt;- tibble(</span></span>
<span id="cb58-703"><a href="#cb58-703" aria-hidden="true" tabindex="-1"></a><span class="in">  variable = rhs_vars</span></span>
<span id="cb58-704"><a href="#cb58-704" aria-hidden="true" tabindex="-1"></a><span class="in">) %&gt;% </span></span>
<span id="cb58-705"><a href="#cb58-705" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(levels = map(variable, ~{</span></span>
<span id="cb58-706"><a href="#cb58-706" aria-hidden="true" tabindex="-1"></a><span class="in">    x &lt;- candidate[[.x]]</span></span>
<span id="cb58-707"><a href="#cb58-707" aria-hidden="true" tabindex="-1"></a><span class="in">    if (is.numeric(x)) {</span></span>
<span id="cb58-708"><a href="#cb58-708" aria-hidden="true" tabindex="-1"></a><span class="in">      ""</span></span>
<span id="cb58-709"><a href="#cb58-709" aria-hidden="true" tabindex="-1"></a><span class="in">    } else if (is.factor(x)) {</span></span>
<span id="cb58-710"><a href="#cb58-710" aria-hidden="true" tabindex="-1"></a><span class="in">      levels(x)</span></span>
<span id="cb58-711"><a href="#cb58-711" aria-hidden="true" tabindex="-1"></a><span class="in">    } else {</span></span>
<span id="cb58-712"><a href="#cb58-712" aria-hidden="true" tabindex="-1"></a><span class="in">      sort(unique(x))</span></span>
<span id="cb58-713"><a href="#cb58-713" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb58-714"><a href="#cb58-714" aria-hidden="true" tabindex="-1"></a><span class="in">  })) %&gt;% </span></span>
<span id="cb58-715"><a href="#cb58-715" aria-hidden="true" tabindex="-1"></a><span class="in">  unnest(levels) %&gt;% </span></span>
<span id="cb58-716"><a href="#cb58-716" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(term = paste0(variable, levels))</span></span>
<span id="cb58-717"><a href="#cb58-717" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-718"><a href="#cb58-718" aria-hidden="true" tabindex="-1"></a><span class="in"># Extract model results</span></span>
<span id="cb58-719"><a href="#cb58-719" aria-hidden="true" tabindex="-1"></a><span class="in">model_results &lt;- tidy(model_svy, conf.int = TRUE)</span></span>
<span id="cb58-720"><a href="#cb58-720" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-721"><a href="#cb58-721" aria-hidden="true" tabindex="-1"></a><span class="in"># Combine full dataset of factor levels with model results</span></span>
<span id="cb58-722"><a href="#cb58-722" aria-hidden="true" tabindex="-1"></a><span class="in">plot_data &lt;- model_variable_levels %&gt;%</span></span>
<span id="cb58-723"><a href="#cb58-723" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(model_results, by = join_by(term)) %&gt;%</span></span>
<span id="cb58-724"><a href="#cb58-724" aria-hidden="true" tabindex="-1"></a><span class="in">  # Make these zero</span></span>
<span id="cb58-725"><a href="#cb58-725" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb58-726"><a href="#cb58-726" aria-hidden="true" tabindex="-1"></a><span class="in">    across(</span></span>
<span id="cb58-727"><a href="#cb58-727" aria-hidden="true" tabindex="-1"></a><span class="in">      c(estimate, conf.low, conf.high),</span></span>
<span id="cb58-728"><a href="#cb58-728" aria-hidden="true" tabindex="-1"></a><span class="in">      ~ ifelse(is.na(.x), 0, .x)</span></span>
<span id="cb58-729"><a href="#cb58-729" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb58-730"><a href="#cb58-730" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;% </span></span>
<span id="cb58-731"><a href="#cb58-731" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(term != "(Intercept)") %&gt;% </span></span>
<span id="cb58-732"><a href="#cb58-732" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(variable_lookup, by = join_by(variable)) %&gt;% </span></span>
<span id="cb58-733"><a href="#cb58-733" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(across(c(levels, variable_nice), ~fct_inorder(.)))</span></span>
<span id="cb58-734"><a href="#cb58-734" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-735"><a href="#cb58-735" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(</span></span>
<span id="cb58-736"><a href="#cb58-736" aria-hidden="true" tabindex="-1"></a><span class="in">  plot_data,</span></span>
<span id="cb58-737"><a href="#cb58-737" aria-hidden="true" tabindex="-1"></a><span class="in">  aes(x = estimate, y = levels, color = variable_nice)</span></span>
<span id="cb58-738"><a href="#cb58-738" aria-hidden="true" tabindex="-1"></a><span class="in">) +</span></span>
<span id="cb58-739"><a href="#cb58-739" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0) +</span></span>
<span id="cb58-740"><a href="#cb58-740" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_pointrange(aes(xmin = conf.low, xmax = conf.high)) +</span></span>
<span id="cb58-741"><a href="#cb58-741" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_pp) +</span></span>
<span id="cb58-742"><a href="#cb58-742" aria-hidden="true" tabindex="-1"></a><span class="in">  guides(color = "none") +</span></span>
<span id="cb58-743"><a href="#cb58-743" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(</span></span>
<span id="cb58-744"><a href="#cb58-744" aria-hidden="true" tabindex="-1"></a><span class="in">    x = "Percentage point change in probability of candidate selection",</span></span>
<span id="cb58-745"><a href="#cb58-745" aria-hidden="true" tabindex="-1"></a><span class="in">    y = NULL,</span></span>
<span id="cb58-746"><a href="#cb58-746" aria-hidden="true" tabindex="-1"></a><span class="in">    title = "AMCEs from fancy data wrangling"</span></span>
<span id="cb58-747"><a href="#cb58-747" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb58-748"><a href="#cb58-748" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_col(facets = "variable_nice", scales = "free_y", space = "free")</span></span>
<span id="cb58-749"><a href="#cb58-749" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-750"><a href="#cb58-750" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-751"><a href="#cb58-751" aria-hidden="true" tabindex="-1"></a>The process is a little different with marginal effects because the <span class="in">`term`</span> column is for the overarching variable (e.g., <span class="in">`taxrate1`</span>) and the individual levels are built as contrasts in a column named <span class="in">`contrast`</span>, like <span class="in">`"&lt;10k: 5% - &lt;10k: 0%"`</span>. We need to clean up that <span class="in">`contrast`</span> column for joining with <span class="in">`model_variable_levels`</span>.</span>
<span id="cb58-752"><a href="#cb58-752" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-753"><a href="#cb58-753" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-amce-mfx, fig.width=6, fig.height=8}</span></span>
<span id="cb58-754"><a href="#cb58-754" aria-hidden="true" tabindex="-1"></a><span class="in"># Extract marginal effects</span></span>
<span id="cb58-755"><a href="#cb58-755" aria-hidden="true" tabindex="-1"></a><span class="in">model_results_mfx &lt;- model_svy %&gt;%</span></span>
<span id="cb58-756"><a href="#cb58-756" aria-hidden="true" tabindex="-1"></a><span class="in">  avg_slopes(newdata = "mean") %&gt;%</span></span>
<span id="cb58-757"><a href="#cb58-757" aria-hidden="true" tabindex="-1"></a><span class="in">  separate_wider_delim(</span></span>
<span id="cb58-758"><a href="#cb58-758" aria-hidden="true" tabindex="-1"></a><span class="in">    contrast,</span></span>
<span id="cb58-759"><a href="#cb58-759" aria-hidden="true" tabindex="-1"></a><span class="in">    delim = " - ", </span></span>
<span id="cb58-760"><a href="#cb58-760" aria-hidden="true" tabindex="-1"></a><span class="in">    names = c("variable_level", "reference_level")</span></span>
<span id="cb58-761"><a href="#cb58-761" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb58-762"><a href="#cb58-762" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-763"><a href="#cb58-763" aria-hidden="true" tabindex="-1"></a><span class="in"># Combine full dataset of factor levels with marginal effects</span></span>
<span id="cb58-764"><a href="#cb58-764" aria-hidden="true" tabindex="-1"></a><span class="in">plot_data_mfx &lt;- model_variable_levels %&gt;%</span></span>
<span id="cb58-765"><a href="#cb58-765" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(</span></span>
<span id="cb58-766"><a href="#cb58-766" aria-hidden="true" tabindex="-1"></a><span class="in">    model_results_mfx,</span></span>
<span id="cb58-767"><a href="#cb58-767" aria-hidden="true" tabindex="-1"></a><span class="in">    by = join_by(variable == term, levels == variable_level)</span></span>
<span id="cb58-768"><a href="#cb58-768" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;%</span></span>
<span id="cb58-769"><a href="#cb58-769" aria-hidden="true" tabindex="-1"></a><span class="in">  # Make these zero</span></span>
<span id="cb58-770"><a href="#cb58-770" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb58-771"><a href="#cb58-771" aria-hidden="true" tabindex="-1"></a><span class="in">    across(</span></span>
<span id="cb58-772"><a href="#cb58-772" aria-hidden="true" tabindex="-1"></a><span class="in">      c(estimate, conf.low, conf.high),</span></span>
<span id="cb58-773"><a href="#cb58-773" aria-hidden="true" tabindex="-1"></a><span class="in">      ~ ifelse(is.na(.x), 0, .x)</span></span>
<span id="cb58-774"><a href="#cb58-774" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb58-775"><a href="#cb58-775" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;% </span></span>
<span id="cb58-776"><a href="#cb58-776" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(variable_lookup, by = join_by(variable)) %&gt;% </span></span>
<span id="cb58-777"><a href="#cb58-777" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(across(c(levels, variable_nice), ~fct_inorder(.)))</span></span>
<span id="cb58-778"><a href="#cb58-778" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-779"><a href="#cb58-779" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(</span></span>
<span id="cb58-780"><a href="#cb58-780" aria-hidden="true" tabindex="-1"></a><span class="in">  plot_data_mfx,</span></span>
<span id="cb58-781"><a href="#cb58-781" aria-hidden="true" tabindex="-1"></a><span class="in">  aes(x = estimate, y = levels, color = variable_nice)</span></span>
<span id="cb58-782"><a href="#cb58-782" aria-hidden="true" tabindex="-1"></a><span class="in">) +</span></span>
<span id="cb58-783"><a href="#cb58-783" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0) +</span></span>
<span id="cb58-784"><a href="#cb58-784" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_pointrange(aes(xmin = conf.low, xmax = conf.high)) +</span></span>
<span id="cb58-785"><a href="#cb58-785" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_pp) +</span></span>
<span id="cb58-786"><a href="#cb58-786" aria-hidden="true" tabindex="-1"></a><span class="in">  guides(color = "none") +</span></span>
<span id="cb58-787"><a href="#cb58-787" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(</span></span>
<span id="cb58-788"><a href="#cb58-788" aria-hidden="true" tabindex="-1"></a><span class="in">    x = "Percentage point change in probability of candidate selection",</span></span>
<span id="cb58-789"><a href="#cb58-789" aria-hidden="true" tabindex="-1"></a><span class="in">    y = NULL,</span></span>
<span id="cb58-790"><a href="#cb58-790" aria-hidden="true" tabindex="-1"></a><span class="in">    title = "AMCEs from OLS marginal effects"</span></span>
<span id="cb58-791"><a href="#cb58-791" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb58-792"><a href="#cb58-792" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_col(facets = "variable_nice", scales = "free_y", space = "free")</span></span>
<span id="cb58-793"><a href="#cb58-793" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-794"><a href="#cb58-794" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-795"><a href="#cb58-795" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-796"><a href="#cb58-796" aria-hidden="true" tabindex="-1"></a><span class="fu">### Logistic regression instead of OLS</span></span>
<span id="cb58-797"><a href="#cb58-797" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-798"><a href="#cb58-798" aria-hidden="true" tabindex="-1"></a>What if you don't want use a linear probability model and instead want to use a different family like logistic regression (which treats the outcome as actual 0 and 1 categories instead of numbers)? Or what if you have 3+ possible choices for outcomes and need to use a multinomial logistic regression model? We can still calculate AMCEs, but we can't use raw regression coefficients. Instead we have to calculate response-scale (i.e. probability scale) marginal effects.</span>
<span id="cb58-799"><a href="#cb58-799" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-800"><a href="#cb58-800" aria-hidden="true" tabindex="-1"></a>Let's make a logistic regression model:</span>
<span id="cb58-801"><a href="#cb58-801" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-802"><a href="#cb58-802" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-logit}</span></span>
<span id="cb58-803"><a href="#cb58-803" aria-hidden="true" tabindex="-1"></a><span class="in">model_logit &lt;- survey::svyglm(</span></span>
<span id="cb58-804"><a href="#cb58-804" aria-hidden="true" tabindex="-1"></a><span class="in">  selected ~ atmilitary + atreligion + ated +</span></span>
<span id="cb58-805"><a href="#cb58-805" aria-hidden="true" tabindex="-1"></a><span class="in">    atprof + atinc + atrace + atage + atmale,</span></span>
<span id="cb58-806"><a href="#cb58-806" aria-hidden="true" tabindex="-1"></a><span class="in">  design = candidate_svy_design,</span></span>
<span id="cb58-807"><a href="#cb58-807" aria-hidden="true" tabindex="-1"></a><span class="in">  family = binomial(link = "logit")</span></span>
<span id="cb58-808"><a href="#cb58-808" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb58-809"><a href="#cb58-809" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-810"><a href="#cb58-810" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-811"><a href="#cb58-811" aria-hidden="true" tabindex="-1"></a>Check out those sweet sweet uninterpretable log odds:</span>
<span id="cb58-812"><a href="#cb58-812" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-813"><a href="#cb58-813" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-model-logit}</span></span>
<span id="cb58-814"><a href="#cb58-814" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_logit)</span></span>
<span id="cb58-815"><a href="#cb58-815" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-816"><a href="#cb58-816" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-817"><a href="#cb58-817" aria-hidden="true" tabindex="-1"></a>We can convert these log odds into probability-scale marginal effects with <span class="in">`slopes()`</span> or <span class="in">`avg_slopes()`</span> from {marginaleffects}. Conceptually this involves plugging in different covariate values—here we're plugging in all the original values in the data into the model and then collapsing the predictions into averages. (Again, <span class="co">[</span><span class="ot">see this</span><span class="co">](https://www.andrewheiss.com/blog/2022/05/20/marginalia/#tldr-overall-summary-of-all-these-marginal-effects-approaches)</span> and <span class="co">[</span><span class="ot">this</span><span class="co">](https://vincentarelbundock.github.io/marginaleffects/articles/slopes.html)</span> for more details about average marginal effects/slopes.)</span>
<span id="cb58-818"><a href="#cb58-818" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-819"><a href="#cb58-819" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-model-logit-mfx}</span></span>
<span id="cb58-820"><a href="#cb58-820" aria-hidden="true" tabindex="-1"></a><span class="in">mfx_logit &lt;- model_logit %&gt;% </span></span>
<span id="cb58-821"><a href="#cb58-821" aria-hidden="true" tabindex="-1"></a><span class="in">  avg_slopes()</span></span>
<span id="cb58-822"><a href="#cb58-822" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-823"><a href="#cb58-823" aria-hidden="true" tabindex="-1"></a><span class="in">mfx_logit %&gt;% as_tibble()</span></span>
<span id="cb58-824"><a href="#cb58-824" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-825"><a href="#cb58-825" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-826"><a href="#cb58-826" aria-hidden="true" tabindex="-1"></a>heck yes these percentage-point-scale estimates are basically the same as what we get from the LPM model!</span>
<span id="cb58-827"><a href="#cb58-827" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-828"><a href="#cb58-828" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-amce-mfx-logit, fig.width=6, fig.height=8}</span></span>
<span id="cb58-829"><a href="#cb58-829" aria-hidden="true" tabindex="-1"></a><span class="in"># Extract marginal effects</span></span>
<span id="cb58-830"><a href="#cb58-830" aria-hidden="true" tabindex="-1"></a><span class="in">model_results_logit_mfx &lt;- mfx_logit %&gt;%</span></span>
<span id="cb58-831"><a href="#cb58-831" aria-hidden="true" tabindex="-1"></a><span class="in">  separate_wider_delim(</span></span>
<span id="cb58-832"><a href="#cb58-832" aria-hidden="true" tabindex="-1"></a><span class="in">    contrast,</span></span>
<span id="cb58-833"><a href="#cb58-833" aria-hidden="true" tabindex="-1"></a><span class="in">    delim = " - ", </span></span>
<span id="cb58-834"><a href="#cb58-834" aria-hidden="true" tabindex="-1"></a><span class="in">    names = c("variable_level", "reference_level")</span></span>
<span id="cb58-835"><a href="#cb58-835" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb58-836"><a href="#cb58-836" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-837"><a href="#cb58-837" aria-hidden="true" tabindex="-1"></a><span class="in"># Combine full dataset of factor levels with marginal effects</span></span>
<span id="cb58-838"><a href="#cb58-838" aria-hidden="true" tabindex="-1"></a><span class="in">plot_data_logit_mfx &lt;- model_variable_levels %&gt;%</span></span>
<span id="cb58-839"><a href="#cb58-839" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(</span></span>
<span id="cb58-840"><a href="#cb58-840" aria-hidden="true" tabindex="-1"></a><span class="in">    model_results_logit_mfx,</span></span>
<span id="cb58-841"><a href="#cb58-841" aria-hidden="true" tabindex="-1"></a><span class="in">    by = join_by(variable == term, levels == variable_level)</span></span>
<span id="cb58-842"><a href="#cb58-842" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;%</span></span>
<span id="cb58-843"><a href="#cb58-843" aria-hidden="true" tabindex="-1"></a><span class="in">  # Make these zero</span></span>
<span id="cb58-844"><a href="#cb58-844" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb58-845"><a href="#cb58-845" aria-hidden="true" tabindex="-1"></a><span class="in">    across(</span></span>
<span id="cb58-846"><a href="#cb58-846" aria-hidden="true" tabindex="-1"></a><span class="in">      c(estimate, conf.low, conf.high),</span></span>
<span id="cb58-847"><a href="#cb58-847" aria-hidden="true" tabindex="-1"></a><span class="in">      ~ ifelse(is.na(.x), 0, .x)</span></span>
<span id="cb58-848"><a href="#cb58-848" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb58-849"><a href="#cb58-849" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;% </span></span>
<span id="cb58-850"><a href="#cb58-850" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(variable_lookup, by = join_by(variable)) %&gt;% </span></span>
<span id="cb58-851"><a href="#cb58-851" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(across(c(levels, variable_nice), ~fct_inorder(.)))</span></span>
<span id="cb58-852"><a href="#cb58-852" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-853"><a href="#cb58-853" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(</span></span>
<span id="cb58-854"><a href="#cb58-854" aria-hidden="true" tabindex="-1"></a><span class="in">  plot_data_logit_mfx,</span></span>
<span id="cb58-855"><a href="#cb58-855" aria-hidden="true" tabindex="-1"></a><span class="in">  aes(x = estimate, y = levels, color = variable_nice)</span></span>
<span id="cb58-856"><a href="#cb58-856" aria-hidden="true" tabindex="-1"></a><span class="in">) +</span></span>
<span id="cb58-857"><a href="#cb58-857" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0) +</span></span>
<span id="cb58-858"><a href="#cb58-858" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_pointrange(aes(xmin = conf.low, xmax = conf.high)) +</span></span>
<span id="cb58-859"><a href="#cb58-859" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_pp) +</span></span>
<span id="cb58-860"><a href="#cb58-860" aria-hidden="true" tabindex="-1"></a><span class="in">  guides(color = "none") +</span></span>
<span id="cb58-861"><a href="#cb58-861" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(</span></span>
<span id="cb58-862"><a href="#cb58-862" aria-hidden="true" tabindex="-1"></a><span class="in">    x = "Percentage point change in probability of candidate selection",</span></span>
<span id="cb58-863"><a href="#cb58-863" aria-hidden="true" tabindex="-1"></a><span class="in">    y = NULL,</span></span>
<span id="cb58-864"><a href="#cb58-864" aria-hidden="true" tabindex="-1"></a><span class="in">    title = "AMCEs from logistic regression marginal effects"</span></span>
<span id="cb58-865"><a href="#cb58-865" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb58-866"><a href="#cb58-866" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_col(facets = "variable_nice", scales = "free_y", space = "free")</span></span>
<span id="cb58-867"><a href="#cb58-867" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-868"><a href="#cb58-868" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-869"><a href="#cb58-869" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-870"><a href="#cb58-870" aria-hidden="true" tabindex="-1"></a><span class="fu">## Marginal means</span></span>
<span id="cb58-871"><a href="#cb58-871" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-872"><a href="#cb58-872" aria-hidden="true" tabindex="-1"></a>Next we'll calculate marginal means for these different attributes and levels, which are conditional averages and not regression coefficients. These are *descriptive* estimands/quantities of interest and they don't rely on any reference category or baseline level.</span>
<span id="cb58-873"><a href="#cb58-873" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-874"><a href="#cb58-874" aria-hidden="true" tabindex="-1"></a><span class="fu">### Automatic estimates with `cregg::mm()`</span></span>
<span id="cb58-875"><a href="#cb58-875" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-876"><a href="#cb58-876" aria-hidden="true" tabindex="-1"></a>The <span class="in">`mm()`</span> function from {cregg} calculates marginal means automatically and returns them in a nice tidy data frame. I include the package namespace prefix here (i.e. <span class="in">`cregg::mm()`</span> instead of just <span class="in">`mm()`</span>) because I've loaded the {brms} package and it has its own <span class="in">`mm()`</span> function that's used for creating multi-membership grouping terms (whatever those are).</span>
<span id="cb58-877"><a href="#cb58-877" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-878"><a href="#cb58-878" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mm-cregg, warning=FALSE}</span></span>
<span id="cb58-879"><a href="#cb58-879" aria-hidden="true" tabindex="-1"></a><span class="in">candidate_mms_auto &lt;- cregg::mm(</span></span>
<span id="cb58-880"><a href="#cb58-880" aria-hidden="true" tabindex="-1"></a><span class="in">  candidate,</span></span>
<span id="cb58-881"><a href="#cb58-881" aria-hidden="true" tabindex="-1"></a><span class="in">  selected ~ atmilitary + atreligion + ated +</span></span>
<span id="cb58-882"><a href="#cb58-882" aria-hidden="true" tabindex="-1"></a><span class="in">    atprof + atinc + atrace + atage + atmale,</span></span>
<span id="cb58-883"><a href="#cb58-883" aria-hidden="true" tabindex="-1"></a><span class="in">  id = ~ resID</span></span>
<span id="cb58-884"><a href="#cb58-884" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb58-885"><a href="#cb58-885" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-886"><a href="#cb58-886" aria-hidden="true" tabindex="-1"></a><span class="in">candidate_mms_auto %&gt;% as_tibble()</span></span>
<span id="cb58-887"><a href="#cb58-887" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-888"><a href="#cb58-888" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-889"><a href="#cb58-889" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb58-890"><a href="#cb58-890" aria-hidden="true" tabindex="-1"></a><span class="fu">### `plot(cregg::mm())`</span></span>
<span id="cb58-891"><a href="#cb58-891" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-892"><a href="#cb58-892" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-mm-automatic, fig.width=6, fig.height=8}</span></span>
<span id="cb58-893"><a href="#cb58-893" aria-hidden="true" tabindex="-1"></a><span class="in">plot(candidate_mms_auto, vline = 0.5) + </span></span>
<span id="cb58-894"><a href="#cb58-894" aria-hidden="true" tabindex="-1"></a><span class="in">  guides(color = "none") +</span></span>
<span id="cb58-895"><a href="#cb58-895" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_nice() +</span></span>
<span id="cb58-896"><a href="#cb58-896" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(title = "Marginal means from from cregg::mm()")</span></span>
<span id="cb58-897"><a href="#cb58-897" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-898"><a href="#cb58-898" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-899"><a href="#cb58-899" aria-hidden="true" tabindex="-1"></a><span class="fu">### Original AMCE coefficent plot</span></span>
<span id="cb58-900"><a href="#cb58-900" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-901"><a href="#cb58-901" aria-hidden="true" tabindex="-1"></a>Left panel of Figure 1 in @LeeperHoboltTilley:2020:</span>
<span id="cb58-902"><a href="#cb58-902" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-903"><a href="#cb58-903" aria-hidden="true" tabindex="-1"></a><span class="in">```{=html}</span></span>
<span id="cb58-904"><a href="#cb58-904" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;img src="img/SVG/leeper-et-al-2019_fig1_mms.svg" width="100%" onerror="this.src='img/3x/leeper-et-al-2019_fig1_mms@3x.png'; this.onerror=null"&gt;</span></span>
<span id="cb58-905"><a href="#cb58-905" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-906"><a href="#cb58-906" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb58-907"><a href="#cb58-907" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-908"><a href="#cb58-908" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-909"><a href="#cb58-909" aria-hidden="true" tabindex="-1"></a><span class="fu">### Quick-and-dirty marginal means</span></span>
<span id="cb58-910"><a href="#cb58-910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-911"><a href="#cb58-911" aria-hidden="true" tabindex="-1"></a>Marginal means are just conditional group averages, so we can actually get the same estimates with some basic {dplyr} grouping and summarizing. I'll just show the averages for military and religion here for the sake of space, but the averages are the same as what we get with <span class="in">`cregg::mm()`</span>:</span>
<span id="cb58-912"><a href="#cb58-912" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-913"><a href="#cb58-913" aria-hidden="true" tabindex="-1"></a><span class="in">```{r calculate-mm-dplyr}</span></span>
<span id="cb58-914"><a href="#cb58-914" aria-hidden="true" tabindex="-1"></a><span class="in">candidate %&gt;% </span></span>
<span id="cb58-915"><a href="#cb58-915" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(atmilitary) %&gt;% </span></span>
<span id="cb58-916"><a href="#cb58-916" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(avg = mean(selected))</span></span>
<span id="cb58-917"><a href="#cb58-917" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-918"><a href="#cb58-918" aria-hidden="true" tabindex="-1"></a><span class="in">candidate %&gt;% </span></span>
<span id="cb58-919"><a href="#cb58-919" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(atreligion) %&gt;% </span></span>
<span id="cb58-920"><a href="#cb58-920" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(avg = mean(selected))</span></span>
<span id="cb58-921"><a href="#cb58-921" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-922"><a href="#cb58-922" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-923"><a href="#cb58-923" aria-hidden="true" tabindex="-1"></a>Behind the scenes, <span class="in">`cregg::mm()`</span> creates simple intercept-less models for each of the categorical terms in the model and then returns their coefficients. Again, for the sake of space, here are the regression-based averages for just military and religion:</span>
<span id="cb58-924"><a href="#cb58-924" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-925"><a href="#cb58-925" aria-hidden="true" tabindex="-1"></a><span class="in">```{r calculate-mm-regression}</span></span>
<span id="cb58-926"><a href="#cb58-926" aria-hidden="true" tabindex="-1"></a><span class="in">bind_rows(</span></span>
<span id="cb58-927"><a href="#cb58-927" aria-hidden="true" tabindex="-1"></a><span class="in">  tidy(lm(selected ~ 0 + atmilitary, data = candidate)),</span></span>
<span id="cb58-928"><a href="#cb58-928" aria-hidden="true" tabindex="-1"></a><span class="in">  tidy(lm(selected ~ 0 + atreligion, data = candidate))</span></span>
<span id="cb58-929"><a href="#cb58-929" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb58-930"><a href="#cb58-930" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-931"><a href="#cb58-931" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-932"><a href="#cb58-932" aria-hidden="true" tabindex="-1"></a>Regardless of how we calculate them, we can see that these estimates are just group averages. 46% of respondents chose candidates who didn't serve in the military; 54% chose candidates who did; and so on.</span>
<span id="cb58-933"><a href="#cb58-933" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-934"><a href="#cb58-934" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-935"><a href="#cb58-935" aria-hidden="true" tabindex="-1"></a><span class="fu">### Marginal means with {marginaleffects}</span></span>
<span id="cb58-936"><a href="#cb58-936" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-937"><a href="#cb58-937" aria-hidden="true" tabindex="-1"></a>Combining a bunch of smaller <span class="in">`group_by() %&gt;% summarize()`</span> datasets, or combining a bunch of intercept-less models involves a bit of extra code and can get tedious. Plus it can get more complex when not using a linear model, or if you want interaction terms, or if you want group averages across multiple groups (i.e. average proportions for military across Republican and Democratic respondents). Additionally, the standard errors from these basic averages are wrong since they don't take into account the nested structure of the data (i.e. respondents each have 6–12 responses). </span>
<span id="cb58-938"><a href="#cb58-938" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-939"><a href="#cb58-939" aria-hidden="true" tabindex="-1"></a>To make life easier and more flexible, we can use <span class="in">`marginal_means()`</span> from {marginaleffects} to calculate the unique categorical group means from a regression model.</span>
<span id="cb58-940"><a href="#cb58-940" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-941"><a href="#cb58-941" aria-hidden="true" tabindex="-1"></a><span class="fu">#### How `marginal_means()` works</span></span>
<span id="cb58-942"><a href="#cb58-942" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-943"><a href="#cb58-943" aria-hidden="true" tabindex="-1"></a>But first we need to look at a quick example to build the intuition behind what happens with <span class="in">`marginal_means()`</span>. First we'll make a simpler regresison model with just the military and religion features. We'll then calculate predicted values for all the levels of those features using <span class="in">`predictions()`</span>—this essentially involves plugging in all the unique values of <span class="in">`atmilitary`</span> and <span class="in">`atreligion`</span> into the model and finding the predicted values. We'll then reshape the results a little so that we can see the average proportions of religion conditional on military service:</span>
<span id="cb58-944"><a href="#cb58-944" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-945"><a href="#cb58-945" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mm-example-basic}</span></span>
<span id="cb58-946"><a href="#cb58-946" aria-hidden="true" tabindex="-1"></a><span class="in">model_candidate_simple &lt;- lm(</span></span>
<span id="cb58-947"><a href="#cb58-947" aria-hidden="true" tabindex="-1"></a><span class="in">  selected ~ atmilitary + atreligion, </span></span>
<span id="cb58-948"><a href="#cb58-948" aria-hidden="true" tabindex="-1"></a><span class="in">  data = candidate</span></span>
<span id="cb58-949"><a href="#cb58-949" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb58-950"><a href="#cb58-950" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-951"><a href="#cb58-951" aria-hidden="true" tabindex="-1"></a><span class="in">predictions_simple &lt;- predictions(</span></span>
<span id="cb58-952"><a href="#cb58-952" aria-hidden="true" tabindex="-1"></a><span class="in">  model_candidate_simple,</span></span>
<span id="cb58-953"><a href="#cb58-953" aria-hidden="true" tabindex="-1"></a><span class="in">  by = c("atreligion", "atmilitary")</span></span>
<span id="cb58-954"><a href="#cb58-954" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb58-955"><a href="#cb58-955" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-956"><a href="#cb58-956" aria-hidden="true" tabindex="-1"></a><span class="in">predictions_simple_wide &lt;- predictions_simple %&gt;% </span></span>
<span id="cb58-957"><a href="#cb58-957" aria-hidden="true" tabindex="-1"></a><span class="in">  select(estimate, atmilitary, atreligion) %&gt;% </span></span>
<span id="cb58-958"><a href="#cb58-958" aria-hidden="true" tabindex="-1"></a><span class="in">  pivot_wider(names_from = "atmilitary", values_from = "estimate")</span></span>
<span id="cb58-959"><a href="#cb58-959" aria-hidden="true" tabindex="-1"></a><span class="in">predictions_simple_wide</span></span>
<span id="cb58-960"><a href="#cb58-960" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-961"><a href="#cb58-961" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-962"><a href="#cb58-962" aria-hidden="true" tabindex="-1"></a>Great. The average proportion for non-military Mormons is 37.6% and for military Mormons is 46%, and so on.</span>
<span id="cb58-963"><a href="#cb58-963" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-964"><a href="#cb58-964" aria-hidden="true" tabindex="-1"></a>If we find the average of these averages and add a column and row in the literal right and bottom margins of the table, we'll have marginal means of religion and military service:</span>
<span id="cb58-965"><a href="#cb58-965" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-966"><a href="#cb58-966" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mm-example-basic-margins}</span></span>
<span id="cb58-967"><a href="#cb58-967" aria-hidden="true" tabindex="-1"></a><span class="in">predictions_simple_wide %&gt;% </span></span>
<span id="cb58-968"><a href="#cb58-968" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(`Religion marginal mean` = (`Did Not Serve` + Served) / 2) %&gt;% </span></span>
<span id="cb58-969"><a href="#cb58-969" aria-hidden="true" tabindex="-1"></a><span class="in">  add_row(</span></span>
<span id="cb58-970"><a href="#cb58-970" aria-hidden="true" tabindex="-1"></a><span class="in">    atreligion = "Military marginal mean", </span></span>
<span id="cb58-971"><a href="#cb58-971" aria-hidden="true" tabindex="-1"></a><span class="in">    `Did Not Serve` = mean(predictions_simple_wide$`Did Not Serve`),</span></span>
<span id="cb58-972"><a href="#cb58-972" aria-hidden="true" tabindex="-1"></a><span class="in">    Served = mean(predictions_simple_wide$Served)</span></span>
<span id="cb58-973"><a href="#cb58-973" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb58-974"><a href="#cb58-974" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-975"><a href="#cb58-975" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-976"><a href="#cb58-976" aria-hidden="true" tabindex="-1"></a>To me this is wild. The marginal mean for Mormons is 41%, which is basically what we found with <span class="in">`group_by(atreligion) %&gt;% summarize()`</span> earlier. The marginal mean for candidates who served in the military is 54.2%, again roughly the same as what we found with <span class="in">`group_by(atmilitary) %&gt;% summarize(...)`</span>.</span>
<span id="cb58-977"><a href="#cb58-977" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-978"><a href="#cb58-978" aria-hidden="true" tabindex="-1"></a>Instead of manually creating these marginal rows and columns, the <span class="in">`marginal_means()`</span> function will find those values automatically for us, based on a grid of values (in <span class="in">`newdata`</span>) that it'll plug into the model. Here it'll plug all combinations of <span class="in">`atreligion`</span> and <span class="in">`atmilitary`</span> into the simple model. The <span class="in">`wts = "cells"`</span> argument here makes it so that the marginal mean is weighted by the actual distribution of the levels of religion and military. For instance, imagine that only 30% of rows served in the military and 70% did not. Calculating the average of those two averages by just doing <span class="in">`(Did Not Serve + Served) / 2`</span> wouldn't take that underlying distribution into account. Weighting by cells make it so that <span class="in">`marginal_means()`</span> computes a weighted marginal mean proportional to each level's frequency in the original data.</span>
<span id="cb58-979"><a href="#cb58-979" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-980"><a href="#cb58-980" aria-hidden="true" tabindex="-1"></a>Let's let <span class="in">`marginal_means()`</span> work its magic:</span>
<span id="cb58-981"><a href="#cb58-981" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-982"><a href="#cb58-982" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mm-example-cells}</span></span>
<span id="cb58-983"><a href="#cb58-983" aria-hidden="true" tabindex="-1"></a><span class="in">marginal_means_simple &lt;- marginal_means(</span></span>
<span id="cb58-984"><a href="#cb58-984" aria-hidden="true" tabindex="-1"></a><span class="in">  model_candidate_simple,</span></span>
<span id="cb58-985"><a href="#cb58-985" aria-hidden="true" tabindex="-1"></a><span class="in">  newdata = c("atreligion", "atmilitary"),</span></span>
<span id="cb58-986"><a href="#cb58-986" aria-hidden="true" tabindex="-1"></a><span class="in">  wts = "cells"</span></span>
<span id="cb58-987"><a href="#cb58-987" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb58-988"><a href="#cb58-988" aria-hidden="true" tabindex="-1"></a><span class="in">marginal_means_simple</span></span>
<span id="cb58-989"><a href="#cb58-989" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-990"><a href="#cb58-990" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-991"><a href="#cb58-991" aria-hidden="true" tabindex="-1"></a>Et voilà, the averages here are basically the same as what we found in the manual version we did earlier. The only differences are due to the weighted averaging—by default <span class="in">`marginal_means()`</span> assumes equal weights in the columns, so it's literally going to just calculate <span class="in">`(Did Not Serve + Served) / 2`</span>. With <span class="in">`wts = "cells"`</span>, it creates a weighted average: <span class="in">`(Did Not Serve * cell_weight + Served * other_cell_weight) / 2`</span>.</span>
<span id="cb58-992"><a href="#cb58-992" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-993"><a href="#cb58-993" aria-hidden="true" tabindex="-1"></a><span class="fu">#### `marginal_means()` with the full actual model</span></span>
<span id="cb58-994"><a href="#cb58-994" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-995"><a href="#cb58-995" aria-hidden="true" tabindex="-1"></a>Now that we understand what's happening with <span class="in">`marginal_means()`</span>, we can use it with the full <span class="in">`model_svy`</span> model. We'll find the marginal means for all the different features and make sure that we weight by cells so that we get weighted averages. Because there are so many combinations of attribute levels here, it takes a while to run:</span>
<span id="cb58-996"><a href="#cb58-996" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-997"><a href="#cb58-997" aria-hidden="true" tabindex="-1"></a><span class="in">```{r create-mm-mfx, cache=TRUE}</span></span>
<span id="cb58-998"><a href="#cb58-998" aria-hidden="true" tabindex="-1"></a><span class="in"># This takes a while...</span></span>
<span id="cb58-999"><a href="#cb58-999" aria-hidden="true" tabindex="-1"></a><span class="in">tictoc::tic()</span></span>
<span id="cb58-1000"><a href="#cb58-1000" aria-hidden="true" tabindex="-1"></a><span class="in">mm_mfx &lt;- marginal_means(</span></span>
<span id="cb58-1001"><a href="#cb58-1001" aria-hidden="true" tabindex="-1"></a><span class="in">  model_svy, </span></span>
<span id="cb58-1002"><a href="#cb58-1002" aria-hidden="true" tabindex="-1"></a><span class="in">  newdata = c(</span></span>
<span id="cb58-1003"><a href="#cb58-1003" aria-hidden="true" tabindex="-1"></a><span class="in">    "atmilitary", "atreligion", "ated", "atprof", </span></span>
<span id="cb58-1004"><a href="#cb58-1004" aria-hidden="true" tabindex="-1"></a><span class="in">    "atinc", "atrace", "atage", "atmale"</span></span>
<span id="cb58-1005"><a href="#cb58-1005" aria-hidden="true" tabindex="-1"></a><span class="in">  ),</span></span>
<span id="cb58-1006"><a href="#cb58-1006" aria-hidden="true" tabindex="-1"></a><span class="in">  wts = "cells"</span></span>
<span id="cb58-1007"><a href="#cb58-1007" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb58-1008"><a href="#cb58-1008" aria-hidden="true" tabindex="-1"></a><span class="in">tictoc::toc()</span></span>
<span id="cb58-1009"><a href="#cb58-1009" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-1010"><a href="#cb58-1010" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1011"><a href="#cb58-1011" aria-hidden="true" tabindex="-1"></a>The results are identical to what we find when using <span class="in">`group_by() %&gt;% summarize()`</span>, but </span>
<span id="cb58-1012"><a href="#cb58-1012" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1013"><a href="#cb58-1013" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>the standard errors are correct (and actually present; we'd need to calculate those on our own with <span class="in">`summarize()`</span> and that's a pain), and </span>
<span id="cb58-1014"><a href="#cb58-1014" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>we have the ability to use other extra {marginaleffects} things like hypothesis tests, counterfactual estimates, p-value adjustments for multiple comparisons, clustered robust standard errors, and so on</span>
<span id="cb58-1015"><a href="#cb58-1015" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1016"><a href="#cb58-1016" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb58-1017"><a href="#cb58-1017" aria-hidden="true" tabindex="-1"></a><span class="fu">#### `marginal_means()`</span></span>
<span id="cb58-1018"><a href="#cb58-1018" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1019"><a href="#cb58-1019" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-mm-mfx}</span></span>
<span id="cb58-1020"><a href="#cb58-1020" aria-hidden="true" tabindex="-1"></a><span class="in">mm_mfx %&gt;% as_tibble()</span></span>
<span id="cb58-1021"><a href="#cb58-1021" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-1022"><a href="#cb58-1022" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1023"><a href="#cb58-1023" aria-hidden="true" tabindex="-1"></a><span class="fu">#### `group_by() %&gt;% summarize()`</span></span>
<span id="cb58-1024"><a href="#cb58-1024" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1025"><a href="#cb58-1025" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-mm-dplyr-manual}</span></span>
<span id="cb58-1026"><a href="#cb58-1026" aria-hidden="true" tabindex="-1"></a><span class="in">candidate %&gt;% </span></span>
<span id="cb58-1027"><a href="#cb58-1027" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(atmilitary) %&gt;% </span></span>
<span id="cb58-1028"><a href="#cb58-1028" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(avg = mean(selected))</span></span>
<span id="cb58-1029"><a href="#cb58-1029" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1030"><a href="#cb58-1030" aria-hidden="true" tabindex="-1"></a><span class="in">candidate %&gt;% </span></span>
<span id="cb58-1031"><a href="#cb58-1031" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(atreligion) %&gt;% </span></span>
<span id="cb58-1032"><a href="#cb58-1032" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(avg = mean(selected))</span></span>
<span id="cb58-1033"><a href="#cb58-1033" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-1034"><a href="#cb58-1034" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1035"><a href="#cb58-1035" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb58-1036"><a href="#cb58-1036" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1037"><a href="#cb58-1037" aria-hidden="true" tabindex="-1"></a>Since there's no reference level to deal with, plotting these these marginal means is pretty straightforward:</span>
<span id="cb58-1038"><a href="#cb58-1038" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1039"><a href="#cb58-1039" aria-hidden="true" tabindex="-1"></a><span class="in">```{r taxes-mm-plot, fig.width=6, fig.height=8.5}</span></span>
<span id="cb58-1040"><a href="#cb58-1040" aria-hidden="true" tabindex="-1"></a><span class="in">plot_mm_mfx &lt;- mm_mfx %&gt;% </span></span>
<span id="cb58-1041"><a href="#cb58-1041" aria-hidden="true" tabindex="-1"></a><span class="in">  as_tibble() %&gt;% </span></span>
<span id="cb58-1042"><a href="#cb58-1042" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(value = fct_inorder(value)) %&gt;%</span></span>
<span id="cb58-1043"><a href="#cb58-1043" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(variable_lookup, by = join_by(term == variable)) %&gt;% </span></span>
<span id="cb58-1044"><a href="#cb58-1044" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(across(c(value, variable_nice), ~fct_inorder(.)))</span></span>
<span id="cb58-1045"><a href="#cb58-1045" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1046"><a href="#cb58-1046" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(</span></span>
<span id="cb58-1047"><a href="#cb58-1047" aria-hidden="true" tabindex="-1"></a><span class="in">  plot_mm_mfx,</span></span>
<span id="cb58-1048"><a href="#cb58-1048" aria-hidden="true" tabindex="-1"></a><span class="in">  aes(x = estimate, y = value, color = variable_nice)</span></span>
<span id="cb58-1049"><a href="#cb58-1049" aria-hidden="true" tabindex="-1"></a><span class="in">) +</span></span>
<span id="cb58-1050"><a href="#cb58-1050" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0.5) +</span></span>
<span id="cb58-1051"><a href="#cb58-1051" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_pointrange(aes(xmin = conf.low, xmax = conf.high)) +</span></span>
<span id="cb58-1052"><a href="#cb58-1052" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_percent()) +</span></span>
<span id="cb58-1053"><a href="#cb58-1053" aria-hidden="true" tabindex="-1"></a><span class="in">  guides(color = "none") +</span></span>
<span id="cb58-1054"><a href="#cb58-1054" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(</span></span>
<span id="cb58-1055"><a href="#cb58-1055" aria-hidden="true" tabindex="-1"></a><span class="in">    x = "Marginal mean",</span></span>
<span id="cb58-1056"><a href="#cb58-1056" aria-hidden="true" tabindex="-1"></a><span class="in">    y = NULL,</span></span>
<span id="cb58-1057"><a href="#cb58-1057" aria-hidden="true" tabindex="-1"></a><span class="in">    title = "Marginal means with marginaleffects::marginal_means()"</span></span>
<span id="cb58-1058"><a href="#cb58-1058" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb58-1059"><a href="#cb58-1059" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_col(facets = "variable_nice", scales = "free_y", space = "free")</span></span>
<span id="cb58-1060"><a href="#cb58-1060" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-1061"><a href="#cb58-1061" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1062"><a href="#cb58-1062" aria-hidden="true" tabindex="-1"></a><span class="fu">## Subgroup differences in AMCEs and marginal means</span></span>
<span id="cb58-1063"><a href="#cb58-1063" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1064"><a href="#cb58-1064" aria-hidden="true" tabindex="-1"></a>@HainmuellerHopkinsYamamoto:2014 did not include any individual respondent-level characteristics in their data, so we can't look at how these causal effects differ across individual traits like party identification (Republicans and Democrats) or education or income or anything else like that. </span>
<span id="cb58-1065"><a href="#cb58-1065" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1066"><a href="#cb58-1066" aria-hidden="true" tabindex="-1"></a>So instead we'll invent a pretend column for respondent-level party ID! To simplify life, we'll look at differences between fake-party-ID within the military service history attribute. Arbitrarily (and super stereotypically), we'll say that if a respondent selected a candidate more than 60% of the time when seeing that they had served in the military, there's a 90% chance they're a Republican. If they didn't select the military candidate 60% of the time, there's a 75% chance they're a Democrat. AGAIN THESE PROBABILITIES ARE COMPLETELY ARBITRARY AND JUST CAME FROM MY HEAD—THEY ARE NOT REAL. We'll make a new dataset called <span class="in">`candidate_fake`</span> with a column named <span class="in">`respondent_party`</span> for each respondent's fake party:</span>
<span id="cb58-1067"><a href="#cb58-1067" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1068"><a href="#cb58-1068" aria-hidden="true" tabindex="-1"></a><span class="in">```{r create-fake-respondent-party}</span></span>
<span id="cb58-1069"><a href="#cb58-1069" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb58-1070"><a href="#cb58-1070" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-summary: Code for generating fake `respondent_party` column</span></span>
<span id="cb58-1071"><a href="#cb58-1071" aria-hidden="true" tabindex="-1"></a><span class="in"># Wrap this in withr::with_seed() so that the randomness is reproducible but the</span></span>
<span id="cb58-1072"><a href="#cb58-1072" aria-hidden="true" tabindex="-1"></a><span class="in"># overall document seed doesn't get set or messed up</span></span>
<span id="cb58-1073"><a href="#cb58-1073" aria-hidden="true" tabindex="-1"></a><span class="in">withr::with_seed(1234, {</span></span>
<span id="cb58-1074"><a href="#cb58-1074" aria-hidden="true" tabindex="-1"></a><span class="in">  respondents_party_military &lt;- candidate %&gt;%</span></span>
<span id="cb58-1075"><a href="#cb58-1075" aria-hidden="true" tabindex="-1"></a><span class="in">    group_by(resID, atmilitary) %&gt;%</span></span>
<span id="cb58-1076"><a href="#cb58-1076" aria-hidden="true" tabindex="-1"></a><span class="in">    # Find the proportion of times each respondent selected the candidate when</span></span>
<span id="cb58-1077"><a href="#cb58-1077" aria-hidden="true" tabindex="-1"></a><span class="in">    # military service history was "Served"</span></span>
<span id="cb58-1078"><a href="#cb58-1078" aria-hidden="true" tabindex="-1"></a><span class="in">    summarize(prob_select = mean(selected)) %&gt;%</span></span>
<span id="cb58-1079"><a href="#cb58-1079" aria-hidden="true" tabindex="-1"></a><span class="in">    filter(atmilitary == "Served") %&gt;%</span></span>
<span id="cb58-1080"><a href="#cb58-1080" aria-hidden="true" tabindex="-1"></a><span class="in">    select(-atmilitary) %&gt;%</span></span>
<span id="cb58-1081"><a href="#cb58-1081" aria-hidden="true" tabindex="-1"></a><span class="in">    ungroup() %&gt;%</span></span>
<span id="cb58-1082"><a href="#cb58-1082" aria-hidden="true" tabindex="-1"></a><span class="in">    # If a respondent selected the candidate more than 60% of the time when</span></span>
<span id="cb58-1083"><a href="#cb58-1083" aria-hidden="true" tabindex="-1"></a><span class="in">    # seeing that they had served in the military, there's a 90% chance they're</span></span>
<span id="cb58-1084"><a href="#cb58-1084" aria-hidden="true" tabindex="-1"></a><span class="in">    # a Republican. If they didn't select the military candidate 60% of the</span></span>
<span id="cb58-1085"><a href="#cb58-1085" aria-hidden="true" tabindex="-1"></a><span class="in">    # time, there's a 75% chance they're a Democrat.</span></span>
<span id="cb58-1086"><a href="#cb58-1086" aria-hidden="true" tabindex="-1"></a><span class="in">    mutate(respondent_party = case_when(</span></span>
<span id="cb58-1087"><a href="#cb58-1087" aria-hidden="true" tabindex="-1"></a><span class="in">      prob_select &gt;= 0.6 ~</span></span>
<span id="cb58-1088"><a href="#cb58-1088" aria-hidden="true" tabindex="-1"></a><span class="in">        sample(</span></span>
<span id="cb58-1089"><a href="#cb58-1089" aria-hidden="true" tabindex="-1"></a><span class="in">          c("Democrat", "Republican"), n(),</span></span>
<span id="cb58-1090"><a href="#cb58-1090" aria-hidden="true" tabindex="-1"></a><span class="in">          replace = TRUE, prob = c(0.1, 0.9)</span></span>
<span id="cb58-1091"><a href="#cb58-1091" aria-hidden="true" tabindex="-1"></a><span class="in">        ),</span></span>
<span id="cb58-1092"><a href="#cb58-1092" aria-hidden="true" tabindex="-1"></a><span class="in">      prob_select &lt; 0.6 ~</span></span>
<span id="cb58-1093"><a href="#cb58-1093" aria-hidden="true" tabindex="-1"></a><span class="in">        sample(</span></span>
<span id="cb58-1094"><a href="#cb58-1094" aria-hidden="true" tabindex="-1"></a><span class="in">          c("Democrat", "Republican"), n(),</span></span>
<span id="cb58-1095"><a href="#cb58-1095" aria-hidden="true" tabindex="-1"></a><span class="in">          replace = TRUE, prob = c(0.75, 0.25)</span></span>
<span id="cb58-1096"><a href="#cb58-1096" aria-hidden="true" tabindex="-1"></a><span class="in">        )</span></span>
<span id="cb58-1097"><a href="#cb58-1097" aria-hidden="true" tabindex="-1"></a><span class="in">    )) %&gt;%</span></span>
<span id="cb58-1098"><a href="#cb58-1098" aria-hidden="true" tabindex="-1"></a><span class="in">    mutate(respondent_party = factor(respondent_party))</span></span>
<span id="cb58-1099"><a href="#cb58-1099" aria-hidden="true" tabindex="-1"></a><span class="in">})</span></span>
<span id="cb58-1100"><a href="#cb58-1100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1101"><a href="#cb58-1101" aria-hidden="true" tabindex="-1"></a><span class="in">candidate_fake &lt;- candidate %&gt;% </span></span>
<span id="cb58-1102"><a href="#cb58-1102" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(respondents_party_military, by = join_by(resID))</span></span>
<span id="cb58-1103"><a href="#cb58-1103" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-1104"><a href="#cb58-1104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1105"><a href="#cb58-1105" aria-hidden="true" tabindex="-1"></a>Let's check the average of <span class="in">`selected`</span> across both the candidate military attribute and our new fake respondent party to see how all that random assignment shook out:</span>
<span id="cb58-1106"><a href="#cb58-1106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1107"><a href="#cb58-1107" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-fake-respondent-party}</span></span>
<span id="cb58-1108"><a href="#cb58-1108" aria-hidden="true" tabindex="-1"></a><span class="in">candidate_fake %&gt;% </span></span>
<span id="cb58-1109"><a href="#cb58-1109" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(atmilitary, respondent_party) %&gt;% </span></span>
<span id="cb58-1110"><a href="#cb58-1110" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(avg = mean(selected))</span></span>
<span id="cb58-1111"><a href="#cb58-1111" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-1112"><a href="#cb58-1112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1113"><a href="#cb58-1113" aria-hidden="true" tabindex="-1"></a>Cool cool. Republican respondents are way more favorable towards candidates who served in the military (61.9%) than Democratic respondents (44.8%). And that kind of interpretation is actually mathematically and conceptually legal and recommended by @LeeperHoboltTilley:2020—technically these are subgroup marginal means and what we should be looking at for descriptive purposes already, but more on that below.</span>
<span id="cb58-1114"><a href="#cb58-1114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1115"><a href="#cb58-1115" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Conditional AMCEs</span></span>
<span id="cb58-1116"><a href="#cb58-1116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1117"><a href="#cb58-1117" aria-hidden="true" tabindex="-1"></a>Let's first look at the two different party-based causal effects of switching a candidate from having no military history to having served in the military. For the sake of simplicity we'll just use regular OLS instead of logistic regression, and we'll use <span class="in">`marginaleffects::avg_slopes()`</span> to find the marginal since the regression model involves interaction terms. We'll also only look at the <span class="in">`atmilitary`</span> feature instead of all the features, since it's the only one where we built in a party effect.</span>
<span id="cb58-1118"><a href="#cb58-1118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1119"><a href="#cb58-1119" aria-hidden="true" tabindex="-1"></a>We can find conditional AMCEs with {cregg} using the <span class="in">`cj()`</span> function, which is a general function for all of the different estimands that {cregg} can calculate:</span>
<span id="cb58-1120"><a href="#cb58-1120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1121"><a href="#cb58-1121" aria-hidden="true" tabindex="-1"></a><span class="in">```{r find-party-amce-cregg, warning=FALSE}</span></span>
<span id="cb58-1122"><a href="#cb58-1122" aria-hidden="true" tabindex="-1"></a><span class="in">cregg::cj(</span></span>
<span id="cb58-1123"><a href="#cb58-1123" aria-hidden="true" tabindex="-1"></a><span class="in">  candidate_fake, </span></span>
<span id="cb58-1124"><a href="#cb58-1124" aria-hidden="true" tabindex="-1"></a><span class="in">  selected ~ atmilitary, </span></span>
<span id="cb58-1125"><a href="#cb58-1125" aria-hidden="true" tabindex="-1"></a><span class="in">  id = ~resID, </span></span>
<span id="cb58-1126"><a href="#cb58-1126" aria-hidden="true" tabindex="-1"></a><span class="in">  estimate = "amce", </span></span>
<span id="cb58-1127"><a href="#cb58-1127" aria-hidden="true" tabindex="-1"></a><span class="in">  by = ~respondent_party</span></span>
<span id="cb58-1128"><a href="#cb58-1128" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb58-1129"><a href="#cb58-1129" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-1130"><a href="#cb58-1130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1131"><a href="#cb58-1131" aria-hidden="true" tabindex="-1"></a>We can do the same thing using regression if we use an interaction term for the subgroup:</span>
<span id="cb58-1132"><a href="#cb58-1132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1133"><a href="#cb58-1133" aria-hidden="true" tabindex="-1"></a><span class="in">```{r find-party-amce-lm}</span></span>
<span id="cb58-1134"><a href="#cb58-1134" aria-hidden="true" tabindex="-1"></a><span class="in">model_military_party &lt;- lm(</span></span>
<span id="cb58-1135"><a href="#cb58-1135" aria-hidden="true" tabindex="-1"></a><span class="in">  selected ~ atmilitary * respondent_party, </span></span>
<span id="cb58-1136"><a href="#cb58-1136" aria-hidden="true" tabindex="-1"></a><span class="in">  data = candidate_fake</span></span>
<span id="cb58-1137"><a href="#cb58-1137" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb58-1138"><a href="#cb58-1138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1139"><a href="#cb58-1139" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_military_party)</span></span>
<span id="cb58-1140"><a href="#cb58-1140" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-1141"><a href="#cb58-1141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1142"><a href="#cb58-1142" aria-hidden="true" tabindex="-1"></a>Those coefficients by themselves aren't super informative without doing some tricky algebra to piece everything together. Instead, we can use <span class="in">`avg_slopes()`</span> from {marginaleffects} to find the partial derivative (or AMCE) for <span class="in">`atmilitary`</span> across each party. These are the same results we get from {cregg}:</span>
<span id="cb58-1143"><a href="#cb58-1143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1144"><a href="#cb58-1144" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mfx-party-amce}</span></span>
<span id="cb58-1145"><a href="#cb58-1145" aria-hidden="true" tabindex="-1"></a><span class="in">party_amces &lt;- model_military_party %&gt;% </span></span>
<span id="cb58-1146"><a href="#cb58-1146" aria-hidden="true" tabindex="-1"></a><span class="in">  avg_slopes(</span></span>
<span id="cb58-1147"><a href="#cb58-1147" aria-hidden="true" tabindex="-1"></a><span class="in">    variables = "atmilitary",</span></span>
<span id="cb58-1148"><a href="#cb58-1148" aria-hidden="true" tabindex="-1"></a><span class="in">    by = "respondent_party"</span></span>
<span id="cb58-1149"><a href="#cb58-1149" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb58-1150"><a href="#cb58-1150" aria-hidden="true" tabindex="-1"></a><span class="in">party_amces</span></span>
<span id="cb58-1151"><a href="#cb58-1151" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-1152"><a href="#cb58-1152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1153"><a href="#cb58-1153" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-mfx-party-amce, fig.width=6, fig.height=3, warning=FALSE}</span></span>
<span id="cb58-1154"><a href="#cb58-1154" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb58-1155"><a href="#cb58-1155" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-summary: "Click to show the code since it's so long; you can make a </span></span>
<span id="cb58-1156"><a href="#cb58-1156" aria-hidden="true" tabindex="-1"></a><span class="in">#|   quick basic version of it with two calls to `plot(amce(...))`—one on data </span></span>
<span id="cb58-1157"><a href="#cb58-1157" aria-hidden="true" tabindex="-1"></a><span class="in">#|   filtered to only include Democrats and one that only includes Republicans"</span></span>
<span id="cb58-1158"><a href="#cb58-1158" aria-hidden="true" tabindex="-1"></a><span class="in"># Clean up marginal effects</span></span>
<span id="cb58-1159"><a href="#cb58-1159" aria-hidden="true" tabindex="-1"></a><span class="in">party_amces_mfx &lt;- party_amces %&gt;%</span></span>
<span id="cb58-1160"><a href="#cb58-1160" aria-hidden="true" tabindex="-1"></a><span class="in">  # The contrast column contains values like this:</span></span>
<span id="cb58-1161"><a href="#cb58-1161" aria-hidden="true" tabindex="-1"></a><span class="in">  #   mean(Served) - mean(Did Not Serve)</span></span>
<span id="cb58-1162"><a href="#cb58-1162" aria-hidden="true" tabindex="-1"></a><span class="in">  # I could probably use some fancy regex to extract those things, but here I'll</span></span>
<span id="cb58-1163"><a href="#cb58-1163" aria-hidden="true" tabindex="-1"></a><span class="in">  # just brute force it and remove "mean(" and ")" with two separate</span></span>
<span id="cb58-1164"><a href="#cb58-1164" aria-hidden="true" tabindex="-1"></a><span class="in">  # str_remove()s</span></span>
<span id="cb58-1165"><a href="#cb58-1165" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb58-1166"><a href="#cb58-1166" aria-hidden="true" tabindex="-1"></a><span class="in">    contrast = str_remove_all(contrast, "mean\\("),</span></span>
<span id="cb58-1167"><a href="#cb58-1167" aria-hidden="true" tabindex="-1"></a><span class="in">    contrast = str_remove_all(contrast, "\\)")</span></span>
<span id="cb58-1168"><a href="#cb58-1168" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;% </span></span>
<span id="cb58-1169"><a href="#cb58-1169" aria-hidden="true" tabindex="-1"></a><span class="in">  separate_wider_delim(</span></span>
<span id="cb58-1170"><a href="#cb58-1170" aria-hidden="true" tabindex="-1"></a><span class="in">    contrast,</span></span>
<span id="cb58-1171"><a href="#cb58-1171" aria-hidden="true" tabindex="-1"></a><span class="in">    delim = " - ", </span></span>
<span id="cb58-1172"><a href="#cb58-1172" aria-hidden="true" tabindex="-1"></a><span class="in">    names = c("variable_level", "reference_level")</span></span>
<span id="cb58-1173"><a href="#cb58-1173" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb58-1174"><a href="#cb58-1174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1175"><a href="#cb58-1175" aria-hidden="true" tabindex="-1"></a><span class="in"># Combine full dataset of factor levels with marginal effects</span></span>
<span id="cb58-1176"><a href="#cb58-1176" aria-hidden="true" tabindex="-1"></a><span class="in">plot_amces_party_mfx &lt;- expand_grid(</span></span>
<span id="cb58-1177"><a href="#cb58-1177" aria-hidden="true" tabindex="-1"></a><span class="in">  respondent_party = levels(candidate_fake$respondent_party),</span></span>
<span id="cb58-1178"><a href="#cb58-1178" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(model_variable_levels, variable == "atmilitary")</span></span>
<span id="cb58-1179"><a href="#cb58-1179" aria-hidden="true" tabindex="-1"></a><span class="in">) %&gt;%</span></span>
<span id="cb58-1180"><a href="#cb58-1180" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(</span></span>
<span id="cb58-1181"><a href="#cb58-1181" aria-hidden="true" tabindex="-1"></a><span class="in">    party_amces_mfx,</span></span>
<span id="cb58-1182"><a href="#cb58-1182" aria-hidden="true" tabindex="-1"></a><span class="in">    by = join_by(variable == term, levels == variable_level, respondent_party)</span></span>
<span id="cb58-1183"><a href="#cb58-1183" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;%</span></span>
<span id="cb58-1184"><a href="#cb58-1184" aria-hidden="true" tabindex="-1"></a><span class="in">  # Make these zero</span></span>
<span id="cb58-1185"><a href="#cb58-1185" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb58-1186"><a href="#cb58-1186" aria-hidden="true" tabindex="-1"></a><span class="in">    across(</span></span>
<span id="cb58-1187"><a href="#cb58-1187" aria-hidden="true" tabindex="-1"></a><span class="in">      c(estimate, conf.low, conf.high),</span></span>
<span id="cb58-1188"><a href="#cb58-1188" aria-hidden="true" tabindex="-1"></a><span class="in">      ~ ifelse(is.na(.x), 0, .x)</span></span>
<span id="cb58-1189"><a href="#cb58-1189" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb58-1190"><a href="#cb58-1190" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;% </span></span>
<span id="cb58-1191"><a href="#cb58-1191" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(variable_lookup, by = join_by(variable)) %&gt;% </span></span>
<span id="cb58-1192"><a href="#cb58-1192" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(across(c(levels, variable_nice), ~fct_inorder(.))) %&gt;% </span></span>
<span id="cb58-1193"><a href="#cb58-1193" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(estimate_nice = case_when(</span></span>
<span id="cb58-1194"><a href="#cb58-1194" aria-hidden="true" tabindex="-1"></a><span class="in">    estimate != 0 ~ label_amce(estimate),</span></span>
<span id="cb58-1195"><a href="#cb58-1195" aria-hidden="true" tabindex="-1"></a><span class="in">    estimate == 0 ~ NA</span></span>
<span id="cb58-1196"><a href="#cb58-1196" aria-hidden="true" tabindex="-1"></a><span class="in">  ))</span></span>
<span id="cb58-1197"><a href="#cb58-1197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1198"><a href="#cb58-1198" aria-hidden="true" tabindex="-1"></a><span class="in">p_mfx &lt;- ggplot(</span></span>
<span id="cb58-1199"><a href="#cb58-1199" aria-hidden="true" tabindex="-1"></a><span class="in">  plot_amces_party_mfx, </span></span>
<span id="cb58-1200"><a href="#cb58-1200" aria-hidden="true" tabindex="-1"></a><span class="in">  aes(x = estimate, y = levels, color = respondent_party)) +</span></span>
<span id="cb58-1201"><a href="#cb58-1201" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0) +</span></span>
<span id="cb58-1202"><a href="#cb58-1202" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_pointrange(</span></span>
<span id="cb58-1203"><a href="#cb58-1203" aria-hidden="true" tabindex="-1"></a><span class="in">    aes(xmin = conf.low, xmax = conf.high),</span></span>
<span id="cb58-1204"><a href="#cb58-1204" aria-hidden="true" tabindex="-1"></a><span class="in">    position = position_dodge(width = 0.15)</span></span>
<span id="cb58-1205"><a href="#cb58-1205" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb58-1206"><a href="#cb58-1206" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_label(</span></span>
<span id="cb58-1207"><a href="#cb58-1207" aria-hidden="true" tabindex="-1"></a><span class="in">    aes(label = estimate_nice), </span></span>
<span id="cb58-1208"><a href="#cb58-1208" aria-hidden="true" tabindex="-1"></a><span class="in">    position = position_dodge(width = -1.2),</span></span>
<span id="cb58-1209"><a href="#cb58-1209" aria-hidden="true" tabindex="-1"></a><span class="in">    size = 3.5, show.legend = FALSE</span></span>
<span id="cb58-1210"><a href="#cb58-1210" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb58-1211"><a href="#cb58-1211" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_pp) +</span></span>
<span id="cb58-1212"><a href="#cb58-1212" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_color_manual(values = parties) +</span></span>
<span id="cb58-1213"><a href="#cb58-1213" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(</span></span>
<span id="cb58-1214"><a href="#cb58-1214" aria-hidden="true" tabindex="-1"></a><span class="in">    x = "Percentage point change in probability of candidate selection",</span></span>
<span id="cb58-1215"><a href="#cb58-1215" aria-hidden="true" tabindex="-1"></a><span class="in">    y = NULL,</span></span>
<span id="cb58-1216"><a href="#cb58-1216" aria-hidden="true" tabindex="-1"></a><span class="in">    color = NULL,</span></span>
<span id="cb58-1217"><a href="#cb58-1217" aria-hidden="true" tabindex="-1"></a><span class="in">    title = "AMCEs by respondent party"</span></span>
<span id="cb58-1218"><a href="#cb58-1218" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb58-1219"><a href="#cb58-1219" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(vars(variable_nice)) +</span></span>
<span id="cb58-1220"><a href="#cb58-1220" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(</span></span>
<span id="cb58-1221"><a href="#cb58-1221" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.position = "bottom",</span></span>
<span id="cb58-1222"><a href="#cb58-1222" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.justification = "left",</span></span>
<span id="cb58-1223"><a href="#cb58-1223" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.margin = margin(l = -7, t = -5)</span></span>
<span id="cb58-1224"><a href="#cb58-1224" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb58-1225"><a href="#cb58-1225" aria-hidden="true" tabindex="-1"></a><span class="in">p_mfx</span></span>
<span id="cb58-1226"><a href="#cb58-1226" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-1227"><a href="#cb58-1227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1228"><a href="#cb58-1228" aria-hidden="true" tabindex="-1"></a>These have a straightforward causal interpretation. Among Democratic-identifying respondents, flipping a hypothetical candidate's military status from "did not serve" to "serve" causes a 10 percentage point drop in favorability (or in the probability of being selected). Among Republican-identifying respondents, a candidate's military service causes a 24 percentage point increase in favorability. Both effects are statistically significantly different from zero.</span>
<span id="cb58-1229"><a href="#cb58-1229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1230"><a href="#cb58-1230" aria-hidden="true" tabindex="-1"></a><span class="fu">### Conditional marginal means</span></span>
<span id="cb58-1231"><a href="#cb58-1231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1232"><a href="#cb58-1232" aria-hidden="true" tabindex="-1"></a>If we're describing overall trends in the data, though, these conditional AMCEs are misleading. It's really tempting to look at this and conclude that there's a 34ish percentage point difference between Democrats and Republicans when they're presented with a candidate with military service, since that's the distance between the two AMCEs in the plot. **But that's wrong!** That distance is an illusion—a mirage caused by the fact that the AMCEs are based on a reference category that is set to zero.</span>
<span id="cb58-1233"><a href="#cb58-1233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1234"><a href="#cb58-1234" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-mfx-party-amce-annotated, fig.width=6, fig.height=3, warning=FALSE}</span></span>
<span id="cb58-1235"><a href="#cb58-1235" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb58-1236"><a href="#cb58-1236" aria-hidden="true" tabindex="-1"></a><span class="in">p_mfx +</span></span>
<span id="cb58-1237"><a href="#cb58-1237" aria-hidden="true" tabindex="-1"></a><span class="in">  annotate(</span></span>
<span id="cb58-1238"><a href="#cb58-1238" aria-hidden="true" tabindex="-1"></a><span class="in">    geom = "errorbar",</span></span>
<span id="cb58-1239"><a href="#cb58-1239" aria-hidden="true" tabindex="-1"></a><span class="in">    x = 0, xmin = -0.103, xmax = 0.241, y = 2,</span></span>
<span id="cb58-1240"><a href="#cb58-1240" aria-hidden="true" tabindex="-1"></a><span class="in">    width = 0.1, color = "black"</span></span>
<span id="cb58-1241"><a href="#cb58-1241" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb58-1242"><a href="#cb58-1242" aria-hidden="true" tabindex="-1"></a><span class="in">  annotate(</span></span>
<span id="cb58-1243"><a href="#cb58-1243" aria-hidden="true" tabindex="-1"></a><span class="in">    geom = "label", </span></span>
<span id="cb58-1244"><a href="#cb58-1244" aria-hidden="true" tabindex="-1"></a><span class="in">    x = 0.241 - (0.241 - -0.103) / 2, y = 2,</span></span>
<span id="cb58-1245"><a href="#cb58-1245" aria-hidden="true" tabindex="-1"></a><span class="in">    label = "This difference isn't\nwhat you think it is!", </span></span>
<span id="cb58-1246"><a href="#cb58-1246" aria-hidden="true" tabindex="-1"></a><span class="in">    size = 5,</span></span>
<span id="cb58-1247"><a href="#cb58-1247" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb58-1248"><a href="#cb58-1248" aria-hidden="true" tabindex="-1"></a><span class="in">  annotate(</span></span>
<span id="cb58-1249"><a href="#cb58-1249" aria-hidden="true" tabindex="-1"></a><span class="in">    geom = "segment",</span></span>
<span id="cb58-1250"><a href="#cb58-1250" aria-hidden="true" tabindex="-1"></a><span class="in">    x = 0.05, xend = 0.01, y = 1, yend = 1,</span></span>
<span id="cb58-1251"><a href="#cb58-1251" aria-hidden="true" tabindex="-1"></a><span class="in">    arrow = arrow(angle = 30, length = grid::unit(0.5, "lines"))</span></span>
<span id="cb58-1252"><a href="#cb58-1252" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb58-1253"><a href="#cb58-1253" aria-hidden="true" tabindex="-1"></a><span class="in">  annotate(</span></span>
<span id="cb58-1254"><a href="#cb58-1254" aria-hidden="true" tabindex="-1"></a><span class="in">    geom = "label", </span></span>
<span id="cb58-1255"><a href="#cb58-1255" aria-hidden="true" tabindex="-1"></a><span class="in">    x = 0, y = 1,</span></span>
<span id="cb58-1256"><a href="#cb58-1256" aria-hidden="true" tabindex="-1"></a><span class="in">    label = "These 0s mess things up!", </span></span>
<span id="cb58-1257"><a href="#cb58-1257" aria-hidden="true" tabindex="-1"></a><span class="in">    size = 5,</span></span>
<span id="cb58-1258"><a href="#cb58-1258" aria-hidden="true" tabindex="-1"></a><span class="in">    hjust = -0.2</span></span>
<span id="cb58-1259"><a href="#cb58-1259" aria-hidden="true" tabindex="-1"></a><span class="in">  ) </span></span>
<span id="cb58-1260"><a href="#cb58-1260" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-1261"><a href="#cb58-1261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1262"><a href="#cb58-1262" aria-hidden="true" tabindex="-1"></a>To get the correct party-based difference in support for candidates, we need to find the party-based marginal means of support for the different levels of the military feature and then talk about *those* differences. <span class="co">[</span><span class="ot">As discussed above</span><span class="co">](#marginal-means)</span>, this technically just involves finding the conditional averages across groups—in this case the average outcome within the two levels of "Served" and "Did not serve" between Republican and Democratic respondents. We can find these marginal means with some basic <span class="in">`group_by() %&gt;% summarize()`</span> and the difference between Republican and Democratic marginal means with some pivoting and subtracting:</span>
<span id="cb58-1263"><a href="#cb58-1263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1264"><a href="#cb58-1264" aria-hidden="true" tabindex="-1"></a><span class="in">```{r find-party-mms-manual}</span></span>
<span id="cb58-1265"><a href="#cb58-1265" aria-hidden="true" tabindex="-1"></a><span class="in">party_mms_manual &lt;- candidate_fake %&gt;% </span></span>
<span id="cb58-1266"><a href="#cb58-1266" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(atmilitary, respondent_party) %&gt;% </span></span>
<span id="cb58-1267"><a href="#cb58-1267" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(avg = mean(selected))</span></span>
<span id="cb58-1268"><a href="#cb58-1268" aria-hidden="true" tabindex="-1"></a><span class="in">party_mms_manual</span></span>
<span id="cb58-1269"><a href="#cb58-1269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1270"><a href="#cb58-1270" aria-hidden="true" tabindex="-1"></a><span class="in">party_mms_manual %&gt;% </span></span>
<span id="cb58-1271"><a href="#cb58-1271" aria-hidden="true" tabindex="-1"></a><span class="in">  pivot_wider(names_from = "respondent_party", values_from = "avg") %&gt;% </span></span>
<span id="cb58-1272"><a href="#cb58-1272" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(mm_diff = Republican - Democrat)</span></span>
<span id="cb58-1273"><a href="#cb58-1273" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-1274"><a href="#cb58-1274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1275"><a href="#cb58-1275" aria-hidden="true" tabindex="-1"></a>Or we can use <span class="in">`cregg::cj(..., estimate = "mm_diff")`</span> to do that automatically:</span>
<span id="cb58-1276"><a href="#cb58-1276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1277"><a href="#cb58-1277" aria-hidden="true" tabindex="-1"></a><span class="in">```{r find-party-mms-cregg, warning=FALSE}</span></span>
<span id="cb58-1278"><a href="#cb58-1278" aria-hidden="true" tabindex="-1"></a><span class="in">cj(</span></span>
<span id="cb58-1279"><a href="#cb58-1279" aria-hidden="true" tabindex="-1"></a><span class="in">  candidate_fake, </span></span>
<span id="cb58-1280"><a href="#cb58-1280" aria-hidden="true" tabindex="-1"></a><span class="in">  selected ~ atmilitary, </span></span>
<span id="cb58-1281"><a href="#cb58-1281" aria-hidden="true" tabindex="-1"></a><span class="in">  id = ~resID, </span></span>
<span id="cb58-1282"><a href="#cb58-1282" aria-hidden="true" tabindex="-1"></a><span class="in">  estimate = "mm_diff", </span></span>
<span id="cb58-1283"><a href="#cb58-1283" aria-hidden="true" tabindex="-1"></a><span class="in">  by = ~respondent_party</span></span>
<span id="cb58-1284"><a href="#cb58-1284" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb58-1285"><a href="#cb58-1285" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-1286"><a href="#cb58-1286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1287"><a href="#cb58-1287" aria-hidden="true" tabindex="-1"></a>Or, to be extra thorough and allow for any type of regression family (logisitic! multinomial!) with any other types of covariates, we can find these manually with our own regression model fed through <span class="in">`marginaleffects::marginal_means()`</span>. By specifying <span class="in">`cross = TRUE`</span>, we get all combinations of military service and party (without it, we'd get separate marginal means for just the two levels of military and the two levels of party).</span>
<span id="cb58-1288"><a href="#cb58-1288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1289"><a href="#cb58-1289" aria-hidden="true" tabindex="-1"></a><span class="in">```{r find-party-mms-mfx}</span></span>
<span id="cb58-1290"><a href="#cb58-1290" aria-hidden="true" tabindex="-1"></a><span class="in">party_mms_mfx &lt;- marginal_means(</span></span>
<span id="cb58-1291"><a href="#cb58-1291" aria-hidden="true" tabindex="-1"></a><span class="in">  model_military_party,</span></span>
<span id="cb58-1292"><a href="#cb58-1292" aria-hidden="true" tabindex="-1"></a><span class="in">  newdata = c("atmilitary", "respondent_party"),</span></span>
<span id="cb58-1293"><a href="#cb58-1293" aria-hidden="true" tabindex="-1"></a><span class="in">  cross = TRUE,</span></span>
<span id="cb58-1294"><a href="#cb58-1294" aria-hidden="true" tabindex="-1"></a><span class="in">  wts = "cells"</span></span>
<span id="cb58-1295"><a href="#cb58-1295" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb58-1296"><a href="#cb58-1296" aria-hidden="true" tabindex="-1"></a><span class="in">party_mms_mfx %&gt;% as_tibble()</span></span>
<span id="cb58-1297"><a href="#cb58-1297" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-1298"><a href="#cb58-1298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1299"><a href="#cb58-1299" aria-hidden="true" tabindex="-1"></a>To find the differences in those marginal means, we could pivot wider and subtract the <span class="in">`Democrat`</span> column from the <span class="in">`Republican`</span> column, or we can use the <span class="in">`hypothesis`</span> argument in <span class="in">`marginal_means()`</span> to have {marginaleffects} automatically calculate differences between categories for us without needing to pivot. If we were only concerned with one contrast, like Republican − Democrat, we could specify <span class="in">`hypothesis = "pairwise"`</span> and it would subtract the two groups' marginal means. However, we want two differences: Republican − Democrat in both the "served" and the "did not serve" levels. As seen above, <span class="in">`party_mms_mfx`</span> has four rows in it. We want the differences between rows 2 and 1 (Republican − Democrat for "Did not serve") and between rows 4 and 3 (Republican − Democrat for "Served"). We can control which rows are used when calculating differences with a vector of <span class="co">[</span><span class="ot">linear combinations</span><span class="co">](https://en.wikipedia.org/wiki/Linear_combination)</span>. If we use a vector like <span class="in">`c(-1, 1, 0, 0)`</span>, {marginaleffects} will essentially make the first row negative, leave the second row as is, and give no weight to (or ignore) the third and fourth row, which will calculate the difference between rows 2 and 1. Similarly, <span class="in">`c(0, 0, -1, 1)`</span> will ignore rows 1 and 2 and find the difference between row 4 and 3. If we feed <span class="in">`marginal_means()`</span> a matrix of these two vectors, with each vector as a column, it'll find the differences for us:</span>
<span id="cb58-1300"><a href="#cb58-1300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1301"><a href="#cb58-1301" aria-hidden="true" tabindex="-1"></a><span class="in">```{r find-mms-diff-party}</span></span>
<span id="cb58-1302"><a href="#cb58-1302" aria-hidden="true" tabindex="-1"></a><span class="in">group_diffs_terms &lt;- matrix(</span></span>
<span id="cb58-1303"><a href="#cb58-1303" aria-hidden="true" tabindex="-1"></a><span class="in">  c(-1, 1, 0, 0,</span></span>
<span id="cb58-1304"><a href="#cb58-1304" aria-hidden="true" tabindex="-1"></a><span class="in">    0, 0, -1, 1),</span></span>
<span id="cb58-1305"><a href="#cb58-1305" aria-hidden="true" tabindex="-1"></a><span class="in">  ncol = 2</span></span>
<span id="cb58-1306"><a href="#cb58-1306" aria-hidden="true" tabindex="-1"></a><span class="in">) %&gt;% </span></span>
<span id="cb58-1307"><a href="#cb58-1307" aria-hidden="true" tabindex="-1"></a><span class="in">  magrittr::set_colnames(levels(candidate_fake$atmilitary))</span></span>
<span id="cb58-1308"><a href="#cb58-1308" aria-hidden="true" tabindex="-1"></a><span class="in">group_diffs_terms</span></span>
<span id="cb58-1309"><a href="#cb58-1309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1310"><a href="#cb58-1310" aria-hidden="true" tabindex="-1"></a><span class="in">party_mms_mfx_diff &lt;- marginal_means(</span></span>
<span id="cb58-1311"><a href="#cb58-1311" aria-hidden="true" tabindex="-1"></a><span class="in">  model_military_party,</span></span>
<span id="cb58-1312"><a href="#cb58-1312" aria-hidden="true" tabindex="-1"></a><span class="in">  newdata = c("atmilitary", "respondent_party"),</span></span>
<span id="cb58-1313"><a href="#cb58-1313" aria-hidden="true" tabindex="-1"></a><span class="in">  cross = TRUE,</span></span>
<span id="cb58-1314"><a href="#cb58-1314" aria-hidden="true" tabindex="-1"></a><span class="in">  wts = "cells",</span></span>
<span id="cb58-1315"><a href="#cb58-1315" aria-hidden="true" tabindex="-1"></a><span class="in">  hypothesis = group_diffs_terms</span></span>
<span id="cb58-1316"><a href="#cb58-1316" aria-hidden="true" tabindex="-1"></a><span class="in">) %&gt;% </span></span>
<span id="cb58-1317"><a href="#cb58-1317" aria-hidden="true" tabindex="-1"></a><span class="in">  as_tibble()</span></span>
<span id="cb58-1318"><a href="#cb58-1318" aria-hidden="true" tabindex="-1"></a><span class="in">party_mms_mfx_diff</span></span>
<span id="cb58-1319"><a href="#cb58-1319" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-1320"><a href="#cb58-1320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1321"><a href="#cb58-1321" aria-hidden="true" tabindex="-1"></a>We can plot these conditional marginal means along with the party-based differences:</span>
<span id="cb58-1322"><a href="#cb58-1322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1323"><a href="#cb58-1323" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-mms-party-diffs, fig.width=11, fig.height=3.5, out.width="100%", warning=FALSE}</span></span>
<span id="cb58-1324"><a href="#cb58-1324" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb58-1325"><a href="#cb58-1325" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-summary: "Click to see all the plotting code"</span></span>
<span id="cb58-1326"><a href="#cb58-1326" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-right</span></span>
<span id="cb58-1327"><a href="#cb58-1327" aria-hidden="true" tabindex="-1"></a><span class="in">mm_party_plot1 &lt;- party_mms_mfx %&gt;% </span></span>
<span id="cb58-1328"><a href="#cb58-1328" aria-hidden="true" tabindex="-1"></a><span class="in">  as_tibble() %&gt;% </span></span>
<span id="cb58-1329"><a href="#cb58-1329" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(estimate_nice = case_when(</span></span>
<span id="cb58-1330"><a href="#cb58-1330" aria-hidden="true" tabindex="-1"></a><span class="in">    estimate != 0 ~ label_percent()(estimate),</span></span>
<span id="cb58-1331"><a href="#cb58-1331" aria-hidden="true" tabindex="-1"></a><span class="in">    estimate == 0 ~ NA</span></span>
<span id="cb58-1332"><a href="#cb58-1332" aria-hidden="true" tabindex="-1"></a><span class="in">  )) %&gt;% </span></span>
<span id="cb58-1333"><a href="#cb58-1333" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = estimate, y = atmilitary, color = respondent_party)) +</span></span>
<span id="cb58-1334"><a href="#cb58-1334" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0.5) +</span></span>
<span id="cb58-1335"><a href="#cb58-1335" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_pointrange(aes(xmin = conf.low, xmax = conf.high)) +</span></span>
<span id="cb58-1336"><a href="#cb58-1336" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_label(</span></span>
<span id="cb58-1337"><a href="#cb58-1337" aria-hidden="true" tabindex="-1"></a><span class="in">    aes(label = estimate_nice), </span></span>
<span id="cb58-1338"><a href="#cb58-1338" aria-hidden="true" tabindex="-1"></a><span class="in">    position = position_dodge(width = -1.2),</span></span>
<span id="cb58-1339"><a href="#cb58-1339" aria-hidden="true" tabindex="-1"></a><span class="in">    size = 3.5, show.legend = FALSE</span></span>
<span id="cb58-1340"><a href="#cb58-1340" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb58-1341"><a href="#cb58-1341" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_percent()) +</span></span>
<span id="cb58-1342"><a href="#cb58-1342" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_color_manual(values = parties) +</span></span>
<span id="cb58-1343"><a href="#cb58-1343" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(</span></span>
<span id="cb58-1344"><a href="#cb58-1344" aria-hidden="true" tabindex="-1"></a><span class="in">    x = "Marginal means",</span></span>
<span id="cb58-1345"><a href="#cb58-1345" aria-hidden="true" tabindex="-1"></a><span class="in">    y = NULL,</span></span>
<span id="cb58-1346"><a href="#cb58-1346" aria-hidden="true" tabindex="-1"></a><span class="in">    color = NULL,</span></span>
<span id="cb58-1347"><a href="#cb58-1347" aria-hidden="true" tabindex="-1"></a><span class="in">    title = "Marginal means by respondent party"</span></span>
<span id="cb58-1348"><a href="#cb58-1348" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb58-1349"><a href="#cb58-1349" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(vars("Military")) +</span></span>
<span id="cb58-1350"><a href="#cb58-1350" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(</span></span>
<span id="cb58-1351"><a href="#cb58-1351" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.position = "bottom",</span></span>
<span id="cb58-1352"><a href="#cb58-1352" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.justification = "left",</span></span>
<span id="cb58-1353"><a href="#cb58-1353" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.margin = margin(l = -7, t = -5)</span></span>
<span id="cb58-1354"><a href="#cb58-1354" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb58-1355"><a href="#cb58-1355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1356"><a href="#cb58-1356" aria-hidden="true" tabindex="-1"></a><span class="in">mm_party_plot2 &lt;- party_mms_mfx_diff %&gt;% </span></span>
<span id="cb58-1357"><a href="#cb58-1357" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(estimate_nice = label_amce(estimate)) %&gt;% </span></span>
<span id="cb58-1358"><a href="#cb58-1358" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = estimate, y = term)) +</span></span>
<span id="cb58-1359"><a href="#cb58-1359" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0) +</span></span>
<span id="cb58-1360"><a href="#cb58-1360" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_pointrange(aes(</span></span>
<span id="cb58-1361"><a href="#cb58-1361" aria-hidden="true" tabindex="-1"></a><span class="in">    xmin = conf.low, xmax = conf.high, </span></span>
<span id="cb58-1362"><a href="#cb58-1362" aria-hidden="true" tabindex="-1"></a><span class="in">    color = "Republican marginal mean − Democrat marginal mean"</span></span>
<span id="cb58-1363"><a href="#cb58-1363" aria-hidden="true" tabindex="-1"></a><span class="in">  )) +</span></span>
<span id="cb58-1364"><a href="#cb58-1364" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_label(</span></span>
<span id="cb58-1365"><a href="#cb58-1365" aria-hidden="true" tabindex="-1"></a><span class="in">    aes(label = estimate_nice), size = 3.5,</span></span>
<span id="cb58-1366"><a href="#cb58-1366" aria-hidden="true" tabindex="-1"></a><span class="in">    nudge_y = 0.3, color = "#85144b"</span></span>
<span id="cb58-1367"><a href="#cb58-1367" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb58-1368"><a href="#cb58-1368" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_pp) +</span></span>
<span id="cb58-1369"><a href="#cb58-1369" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_color_manual(values = "#85144b") +</span></span>
<span id="cb58-1370"><a href="#cb58-1370" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(</span></span>
<span id="cb58-1371"><a href="#cb58-1371" aria-hidden="true" tabindex="-1"></a><span class="in">    x = "Difference in marginal means",</span></span>
<span id="cb58-1372"><a href="#cb58-1372" aria-hidden="true" tabindex="-1"></a><span class="in">    y = NULL,</span></span>
<span id="cb58-1373"><a href="#cb58-1373" aria-hidden="true" tabindex="-1"></a><span class="in">    color = NULL,</span></span>
<span id="cb58-1374"><a href="#cb58-1374" aria-hidden="true" tabindex="-1"></a><span class="in">    title = "Difference in marginal means by respondent party",</span></span>
<span id="cb58-1375"><a href="#cb58-1375" aria-hidden="true" tabindex="-1"></a><span class="in">    subtitle = "Positive differences = Republicans prefer the level"</span></span>
<span id="cb58-1376"><a href="#cb58-1376" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb58-1377"><a href="#cb58-1377" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(vars("Military")) +</span></span>
<span id="cb58-1378"><a href="#cb58-1378" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(</span></span>
<span id="cb58-1379"><a href="#cb58-1379" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.position = "bottom",</span></span>
<span id="cb58-1380"><a href="#cb58-1380" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.justification = "left",</span></span>
<span id="cb58-1381"><a href="#cb58-1381" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.margin = margin(l = -7, t = -5)</span></span>
<span id="cb58-1382"><a href="#cb58-1382" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb58-1383"><a href="#cb58-1383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1384"><a href="#cb58-1384" aria-hidden="true" tabindex="-1"></a><span class="in">mm_party_plot1 | mm_party_plot2</span></span>
<span id="cb58-1385"><a href="#cb58-1385" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-1386"><a href="#cb58-1386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1387"><a href="#cb58-1387" aria-hidden="true" tabindex="-1"></a>These marginal means have a direct descriptive interpretation. In the left panel above we can see that Democratic respondents tend to prefer candidates that haven't served in the military (55%) to those that have (45%), but compared to Republican respondents, this divergence isn't as dramatic. Republicans tend to strongly prefer candidates with a military history, with 62% expressing favorability. In general, Republicans are more extreme in their preferences for and against candidates with and without military service history. </span>
<span id="cb58-1388"><a href="#cb58-1388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1389"><a href="#cb58-1389" aria-hidden="true" tabindex="-1"></a>In the right panel we can see the differences between the parties' marginal means within each level. There's a 17 percentage point distance between Republican and Democratic marginal means within the served level and a 17 percentage point distance between their marginal means in the did not serve level. Overall, Republicans prefer candidates with military service; Democrats prefer candidates without military service.</span>
<span id="cb58-1390"><a href="#cb58-1390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1391"><a href="#cb58-1391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1392"><a href="#cb58-1392" aria-hidden="true" tabindex="-1"></a><span class="fu"># Finding conjoint AMCEs and marginal means Bayesianly</span></span>
<span id="cb58-1393"><a href="#cb58-1393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1394"><a href="#cb58-1394" aria-hidden="true" tabindex="-1"></a>Now that we know (1) what the AMCE actually is, and (2) that it works with logistic models, we can finally do it all Bayesianly with {brms}.</span>
<span id="cb58-1395"><a href="#cb58-1395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1396"><a href="#cb58-1396" aria-hidden="true" tabindex="-1"></a>Why try to do this Bayesianly? <span class="co">[</span><span class="ot">I don't like null hypotheses and I don't like flowcharts</span><span class="co">](https://www.andrewheiss.com/blog/2023/05/15/fancy-bayes-diffs-props/#why-bayesian-modeling)</span>.^<span class="co">[</span><span class="ot">See [this video by Richard McElreath introducing his idea of "statistical rethinking"](https://www.youtube.com/watch?v=cclUd_HoRlo)</span><span class="co">]</span></span>
<span id="cb58-1397"><a href="#cb58-1397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1398"><a href="#cb58-1398" aria-hidden="true" tabindex="-1"></a>Rather than choose the <span class="co">[</span><span class="ot">exact statistical test in a flowchart</span><span class="co">](https://www.google.com/search?q=statistical+test+flow+chart)</span>, I can compare the posterior distributions of AMCEs or marginal means directly. And rather than define a null hypothesis, I can find the probability that the estimand I care about is different from whatever other value I'm interested in.</span>
<span id="cb58-1399"><a href="#cb58-1399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1400"><a href="#cb58-1400" aria-hidden="true" tabindex="-1"></a>But first, a note on the complexity of all this estimation and plotting thus far. In the <span class="co">[</span><span class="ot">"Finding conjoint AMCEs and marginal means frequentistly" section</span><span class="co">](#sec-frequentist)</span> above, I spent a ton of extra time showing how to calculate and plot these estimands multiple ways:</span>
<span id="cb58-1401"><a href="#cb58-1401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1402"><a href="#cb58-1402" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>find the estimands with <span class="in">`cregg::amce()`</span>, <span class="in">`cregg::mm()`</span>, and <span class="in">`cregg::cj(..., estimate = "diff_mm")`</span></span>
<span id="cb58-1403"><a href="#cb58-1403" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>find the estimands with {dplyr}'s <span class="in">`group_by() %&gt;% summarize()`</span></span>
<span id="cb58-1404"><a href="#cb58-1404" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>find the estimands with OLS regression models like <span class="in">`lm()`</span> and <span class="in">`survey::svyglm()`</span> or with logistic models like <span class="in">`glm()`</span> and <span class="in">`survey::svyglm()`</span> which are then fed into <span class="in">`marginaleffects::avg_slopes()`</span> and <span class="in">`marginaleffects::marginal_means()`</span></span>
<span id="cb58-1405"><a href="#cb58-1405" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>plot the estimands automatically with <span class="in">`plot(cregg::amce(...))`</span></span>
<span id="cb58-1406"><a href="#cb58-1406" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>tidy the estimands with reference levels with <span class="in">`broom.helpers::tidy_add_reference_rows()`</span> and plot them manually</span>
<span id="cb58-1407"><a href="#cb58-1407" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>tidy the estimands with reference levels manually with some {tidyr} and {dplyr} magic and plot them manually</span>
<span id="cb58-1408"><a href="#cb58-1408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1409"><a href="#cb58-1409" aria-hidden="true" tabindex="-1"></a>We have <span class="co">[</span><span class="ot">a veritable smorgasbord</span><span class="co">](https://www.youtube.com/watch?v=kf1bu5sUXaU)</span> of options!</span>
<span id="cb58-1410"><a href="#cb58-1410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1411"><a href="#cb58-1411" aria-hidden="true" tabindex="-1"></a>I did this because I generally like thinking about averages as regressions and prefer to have total control over plotting instead of relying on convenience functions like <span class="in">`cregg::amce()`</span>. If I were analyzing my own conjoint data in a frequentist way, I'd use regression + {marginaleffects} + manual tidying and plotting.</span>
<span id="cb58-1412"><a href="#cb58-1412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1413"><a href="#cb58-1413" aria-hidden="true" tabindex="-1"></a>I also showed all these options becuase if we're going to calculate these estimands in a Bayesian way, none of the convenience functions like <span class="in">`cregg::amce()`</span> or <span class="in">`broom.helpers::tidy_add_reference_rows()`</span> work with Bayesian models, so we have to use the manual approach anyway. And Bayesian models have their own extra dimension of complexity, so we might as well embrace it all. As Richard McElreath says,</span>
<span id="cb58-1414"><a href="#cb58-1414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1415"><a href="#cb58-1415" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; </span><span class="co">[</span><span class="ot">A</span><span class="co">]</span><span class="at">s models become more monstrous, so too does the code needed to compute predictions and display them. **With power comes hardship.** **It's better to see the guts of the machine than to live in awe or fear of it.** </span><span class="co">[</span><span class="ot">@McElreath:2020, 391</span><span class="co">]</span></span>
<span id="cb58-1416"><a href="#cb58-1416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1417"><a href="#cb58-1417" aria-hidden="true" tabindex="-1"></a>yay complexity.</span>
<span id="cb58-1418"><a href="#cb58-1418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1419"><a href="#cb58-1419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1420"><a href="#cb58-1420" aria-hidden="true" tabindex="-1"></a><span class="fu">## The overall model</span></span>
<span id="cb58-1421"><a href="#cb58-1421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1422"><a href="#cb58-1422" aria-hidden="true" tabindex="-1"></a>The easiest way for me to think about all these estimands is as moving parts (marginal effects or partial derivatives) in a regression model. We can model the whole data-generating system (i.e. all the candidate features and levels + any subgroups or covariates we're interested in) and then look at individual parts of that system for the different estimands we're interested in.</span>
<span id="cb58-1423"><a href="#cb58-1423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1424"><a href="#cb58-1424" aria-hidden="true" tabindex="-1"></a>Each survey respondent saw multiple pairs of hypothetical candidates—some saw 4, some 5, some 6, and so on:</span>
<span id="cb58-1425"><a href="#cb58-1425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1426"><a href="#cb58-1426" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-pairs-seen}</span></span>
<span id="cb58-1427"><a href="#cb58-1427" aria-hidden="true" tabindex="-1"></a><span class="in">candidate %&gt;% </span></span>
<span id="cb58-1428"><a href="#cb58-1428" aria-hidden="true" tabindex="-1"></a><span class="in">  count(resID) %&gt;% </span></span>
<span id="cb58-1429"><a href="#cb58-1429" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(pairs_seen = n / 2)</span></span>
<span id="cb58-1430"><a href="#cb58-1430" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-1431"><a href="#cb58-1431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1432"><a href="#cb58-1432" aria-hidden="true" tabindex="-1"></a>This means that we have a natural multilevel structure in our data. Individual candidate selection choices are nested inside respondents:</span>
<span id="cb58-1433"><a href="#cb58-1433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1434"><a href="#cb58-1434" aria-hidden="true" tabindex="-1"></a><span class="in">```{tikz respondent-conjoint-structure, engine.opts=font_opts}</span></span>
<span id="cb58-1435"><a href="#cb58-1435" aria-hidden="true" tabindex="-1"></a><span class="in">#| echo: false</span></span>
<span id="cb58-1436"><a href="#cb58-1436" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: "Multilevel conjoint data structure, with candidate choices $y$ nested in respondents"</span></span>
<span id="cb58-1437"><a href="#cb58-1437" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-align: center</span></span>
<span id="cb58-1438"><a href="#cb58-1438" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-ext: svg</span></span>
<span id="cb58-1439"><a href="#cb58-1439" aria-hidden="true" tabindex="-1"></a><span class="in">#| out-width: 100%</span></span>
<span id="cb58-1440"><a href="#cb58-1440" aria-hidden="true" tabindex="-1"></a><span class="in">\usetikzlibrary{positioning}</span></span>
<span id="cb58-1441"><a href="#cb58-1441" aria-hidden="true" tabindex="-1"></a><span class="in">\usetikzlibrary{shapes.geometric}</span></span>
<span id="cb58-1442"><a href="#cb58-1442" aria-hidden="true" tabindex="-1"></a><span class="in">\begin{tikzpicture}[{every node/.append style}=draw]</span></span>
<span id="cb58-1443"><a href="#cb58-1443" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [rectangle] (respondent1) at (0, 2.5) {Respondent 1};</span></span>
<span id="cb58-1444"><a href="#cb58-1444" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [ellipse] (y11) at (-1.5, 1) {$y_{1_1}$};</span></span>
<span id="cb58-1445"><a href="#cb58-1445" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [ellipse] (y21) at (0, 1) {$y_{2_1}$};</span></span>
<span id="cb58-1446"><a href="#cb58-1446" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [ellipse] (y31) at (1.5, 1) {$y_{3_1}$};</span></span>
<span id="cb58-1447"><a href="#cb58-1447" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (respondent1) to (y11);</span></span>
<span id="cb58-1448"><a href="#cb58-1448" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (respondent1) to (y21);</span></span>
<span id="cb58-1449"><a href="#cb58-1449" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (respondent1) to (y31);</span></span>
<span id="cb58-1450"><a href="#cb58-1450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1451"><a href="#cb58-1451" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [rectangle] (respondent2) at (4.5, 2.5) {Respondent 2};</span></span>
<span id="cb58-1452"><a href="#cb58-1452" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [ellipse] (y12) at (3, 1) {$y_{1_2}$};</span></span>
<span id="cb58-1453"><a href="#cb58-1453" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [ellipse] (y22) at (4.5, 1) {$y_{2_2}$};</span></span>
<span id="cb58-1454"><a href="#cb58-1454" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [ellipse] (y32) at (6, 1) {$y_{3_2}$};</span></span>
<span id="cb58-1455"><a href="#cb58-1455" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (respondent2) to (y12);</span></span>
<span id="cb58-1456"><a href="#cb58-1456" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (respondent2) to (y22);</span></span>
<span id="cb58-1457"><a href="#cb58-1457" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (respondent2) to (y32);</span></span>
<span id="cb58-1458"><a href="#cb58-1458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1459"><a href="#cb58-1459" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [ellipse, draw=white] (dots_top) at (7.25, 2.5) {$\dots$};</span></span>
<span id="cb58-1460"><a href="#cb58-1460" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [ellipse, draw=white] (dots_bottom) at (7.25, 1) {$\dots$};</span></span>
<span id="cb58-1461"><a href="#cb58-1461" aria-hidden="true" tabindex="-1"></a><span class="in">    \draw [-latex] (dots_top) to (dots_bottom);</span></span>
<span id="cb58-1462"><a href="#cb58-1462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1463"><a href="#cb58-1463" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [rectangle] (respondentn) at (10, 2.5) {Respondent $n$};</span></span>
<span id="cb58-1464"><a href="#cb58-1464" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [ellipse] (y1n) at (8.5, 1) {$y_{1_n}$};</span></span>
<span id="cb58-1465"><a href="#cb58-1465" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [ellipse] (y2n) at (10, 1) {$y_{2_n}$};</span></span>
<span id="cb58-1466"><a href="#cb58-1466" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [ellipse] (y3n) at (11.5, 1) {$y_{3_n}$};</span></span>
<span id="cb58-1467"><a href="#cb58-1467" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (respondentn) to (y1n);</span></span>
<span id="cb58-1468"><a href="#cb58-1468" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (respondentn) to (y2n);</span></span>
<span id="cb58-1469"><a href="#cb58-1469" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (respondentn) to (y3n);</span></span>
<span id="cb58-1470"><a href="#cb58-1470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1471"><a href="#cb58-1471" aria-hidden="true" tabindex="-1"></a><span class="in">  \node [rectangle] (population) at (5, 4) {Population of survey respondents};</span></span>
<span id="cb58-1472"><a href="#cb58-1472" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (population) to (respondent1);</span></span>
<span id="cb58-1473"><a href="#cb58-1473" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (population) to (respondent2);</span></span>
<span id="cb58-1474"><a href="#cb58-1474" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (population) to (dots_top);</span></span>
<span id="cb58-1475"><a href="#cb58-1475" aria-hidden="true" tabindex="-1"></a><span class="in">  \draw [-latex] (population) to (respondentn);</span></span>
<span id="cb58-1476"><a href="#cb58-1476" aria-hidden="true" tabindex="-1"></a><span class="in">\end{tikzpicture}</span></span>
<span id="cb58-1477"><a href="#cb58-1477" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-1478"><a href="#cb58-1478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1479"><a href="#cb58-1479" aria-hidden="true" tabindex="-1"></a>We want to model candidate selection (<span class="in">`selected`</span>) based on candidate characteristics (and maybe individual respondent characteristics, if we had those). We'll use the subscript $i$ to refer to individual candidate choices and $j$ to refer to respondents, which each contain multiple $i$s.</span>
<span id="cb58-1480"><a href="#cb58-1480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1481"><a href="#cb58-1481" aria-hidden="true" tabindex="-1"></a>Since candidate selection <span class="in">`selected`</span> is binary, we can model it as a Bernoulli process that has a probability $\pi_{i_j}$ of success. We'll model that $\pi_{i_j}$ using a logistic regression model with covariates for each of the levels of each candidate feature. To account for respondent-level differences in probabilities, we'll use respondent-specific offsets ($b_{0_j}$) from the global success rate, thus creating random intercepts. We'll specify priors for each of the logit-scale coefficients/partial derivatives and the between respondent variability ($\sigma_0$). If we *really* wanted we could specify priors for each individual coefficient, but for simplicity we'll just use a normal distribution with a mean of 0 and a standard deviation of 1 for all of them (<span class="co">[</span><span class="ot">since logit-scale coefficients don't ever get really big</span><span class="co">](https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/index.html#super-fancy-detailed-model-with-lots-of-moving-parts-just-for-fun)</span>). We'll use an exponential prior for ($\sigma_0$) because we don't know much about it.</span>
<span id="cb58-1482"><a href="#cb58-1482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1483"><a href="#cb58-1483" aria-hidden="true" tabindex="-1"></a>Here's what that all looks like more formally:</span>
<span id="cb58-1484"><a href="#cb58-1484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1485"><a href="#cb58-1485" aria-hidden="true" tabindex="-1"></a>::: {.column-screen-inset}</span>
<span id="cb58-1486"><a href="#cb58-1486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1487"><a href="#cb58-1487" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb58-1488"><a href="#cb58-1488" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb58-1489"><a href="#cb58-1489" aria-hidden="true" tabindex="-1"></a>\text{Selection}_{i_j} \sim&amp;\ \operatorname{Bernoulli}(\pi_{i_j}) &amp; \text{Probability of selection for choice}_i \text{ in respondent}_j <span class="sc">\\</span></span>
<span id="cb58-1490"><a href="#cb58-1490" aria-hidden="true" tabindex="-1"></a>\operatorname{logit}(\pi_{i_j}) =&amp;\ (\beta_0 + b_{0_j}) + \beta_1\, \text{Military<span class="co">[</span><span class="ot">Served</span><span class="co">]</span>}_{i_j} + &amp; \text{Model for probability}<span class="sc">\\</span></span>
<span id="cb58-1491"><a href="#cb58-1491" aria-hidden="true" tabindex="-1"></a>&amp;\ \beta_2\, \text{Religion<span class="co">[</span><span class="ot">Mormon</span><span class="co">]</span>}_{i_j} + <span class="sc">\\</span></span>
<span id="cb58-1492"><a href="#cb58-1492" aria-hidden="true" tabindex="-1"></a>&amp;\ \beta_3\, \text{Religion<span class="co">[</span><span class="ot">Evangelical</span><span class="co">]</span>}_{i_j} + <span class="sc">\\</span></span>
<span id="cb58-1493"><a href="#cb58-1493" aria-hidden="true" tabindex="-1"></a>&amp;\ \dots +\ <span class="sc">\\</span></span>
<span id="cb58-1494"><a href="#cb58-1494" aria-hidden="true" tabindex="-1"></a>&amp;\ \beta_n\, \text{Sex<span class="co">[</span><span class="ot">Female</span><span class="co">]</span>}_{i_j} <span class="sc">\\</span></span>
<span id="cb58-1495"><a href="#cb58-1495" aria-hidden="true" tabindex="-1"></a>b_{0_j} \sim&amp;\ \mathcal{N}(0, \sigma_0) &amp; \text{Respondent-specific offsets from global success rate} <span class="sc">\\</span></span>
<span id="cb58-1496"><a href="#cb58-1496" aria-hidden="true" tabindex="-1"></a><span class="sc">\\</span></span>
<span id="cb58-1497"><a href="#cb58-1497" aria-hidden="true" tabindex="-1"></a>\beta_{0_c} \sim&amp;\ \mathcal{N}(0, 1) &amp; \text{Prior for global average success rate} <span class="sc">\\</span></span>
<span id="cb58-1498"><a href="#cb58-1498" aria-hidden="true" tabindex="-1"></a>\beta_1 \dots \beta_n \sim&amp;\ \mathcal{N}(0, 1) &amp; \text{Prior for candidate feature levels} <span class="sc">\\</span></span>
<span id="cb58-1499"><a href="#cb58-1499" aria-hidden="true" tabindex="-1"></a>\sigma_0 \sim&amp;\ \operatorname{Exponential}(1) &amp; \text{Prior for between-respondent variability}</span>
<span id="cb58-1500"><a href="#cb58-1500" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb58-1501"><a href="#cb58-1501" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb58-1502"><a href="#cb58-1502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1503"><a href="#cb58-1503" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb58-1504"><a href="#cb58-1504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1505"><a href="#cb58-1505" aria-hidden="true" tabindex="-1"></a>Let's build the model!</span>
<span id="cb58-1506"><a href="#cb58-1506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1507"><a href="#cb58-1507" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-brms}</span></span>
<span id="cb58-1508"><a href="#cb58-1508" aria-hidden="true" tabindex="-1"></a><span class="in">priors &lt;- c(</span></span>
<span id="cb58-1509"><a href="#cb58-1509" aria-hidden="true" tabindex="-1"></a><span class="in">  prior(normal(0, 1), class = Intercept),</span></span>
<span id="cb58-1510"><a href="#cb58-1510" aria-hidden="true" tabindex="-1"></a><span class="in">  prior(normal(0, 1), class = b),</span></span>
<span id="cb58-1511"><a href="#cb58-1511" aria-hidden="true" tabindex="-1"></a><span class="in">  prior(exponential(1), class = sd)</span></span>
<span id="cb58-1512"><a href="#cb58-1512" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb58-1513"><a href="#cb58-1513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1514"><a href="#cb58-1514" aria-hidden="true" tabindex="-1"></a><span class="in">model_brms &lt;- brm(</span></span>
<span id="cb58-1515"><a href="#cb58-1515" aria-hidden="true" tabindex="-1"></a><span class="in">  bf(selected ~ atmilitary + atreligion + ated +</span></span>
<span id="cb58-1516"><a href="#cb58-1516" aria-hidden="true" tabindex="-1"></a><span class="in">    atprof + atinc + atrace + atage + atmale +</span></span>
<span id="cb58-1517"><a href="#cb58-1517" aria-hidden="true" tabindex="-1"></a><span class="in">    (1 | resID)),</span></span>
<span id="cb58-1518"><a href="#cb58-1518" aria-hidden="true" tabindex="-1"></a><span class="in">  data = candidate,</span></span>
<span id="cb58-1519"><a href="#cb58-1519" aria-hidden="true" tabindex="-1"></a><span class="in">  family = bernoulli(link = "logit"),</span></span>
<span id="cb58-1520"><a href="#cb58-1520" aria-hidden="true" tabindex="-1"></a><span class="in">  prior = priors,</span></span>
<span id="cb58-1521"><a href="#cb58-1521" aria-hidden="true" tabindex="-1"></a><span class="in">  chains = 4, cores = 4, iter = 2000, seed = 1234,</span></span>
<span id="cb58-1522"><a href="#cb58-1522" aria-hidden="true" tabindex="-1"></a><span class="in">  backend = "cmdstanr", threads = threading(2), refresh = 0,</span></span>
<span id="cb58-1523"><a href="#cb58-1523" aria-hidden="true" tabindex="-1"></a><span class="in">  file = "candidate_model_brms"</span></span>
<span id="cb58-1524"><a href="#cb58-1524" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb58-1525"><a href="#cb58-1525" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-1526"><a href="#cb58-1526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1527"><a href="#cb58-1527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1528"><a href="#cb58-1528" aria-hidden="true" tabindex="-1"></a><span class="fu">## AMCEs</span></span>
<span id="cb58-1529"><a href="#cb58-1529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1530"><a href="#cb58-1530" aria-hidden="true" tabindex="-1"></a>If we're interested in the causal effect of specific candidate levels, we need to find the average marginal component effect (AMCE). Here's the formal definition of the no religion → Mormon AMCE, for example: </span>
<span id="cb58-1531"><a href="#cb58-1531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1532"><a href="#cb58-1532" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb58-1533"><a href="#cb58-1533" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb58-1534"><a href="#cb58-1534" aria-hidden="true" tabindex="-1"></a>\theta =\ &amp;P <span class="co">[</span><span class="ot">\text{Candidate selection} \mid \operatorname{do}(\text{Religion} = \text{none})</span><span class="co">]</span>\ - <span class="sc">\\</span></span>
<span id="cb58-1535"><a href="#cb58-1535" aria-hidden="true" tabindex="-1"></a>&amp;P<span class="co">[</span><span class="ot">\text{Candidate selection} \mid \operatorname{do}(\text{Religion} = \text{Mormon})</span><span class="co">]</span></span>
<span id="cb58-1536"><a href="#cb58-1536" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb58-1537"><a href="#cb58-1537" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb58-1538"><a href="#cb58-1538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1539"><a href="#cb58-1539" aria-hidden="true" tabindex="-1"></a>We can find this AMCE (and all the other AMCEs) by calculating the marginal effect/partial derivative of each candidate-level covariate. <span class="in">`marginaleffects::avg_slopes()`</span> makes this easy and gives us percentage-point-scale estimates instead of logit-scale estimates</span>
<span id="cb58-1540"><a href="#cb58-1540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1541"><a href="#cb58-1541" aria-hidden="true" tabindex="-1"></a>::: {.callout-important}</span>
<span id="cb58-1542"><a href="#cb58-1542" aria-hidden="true" tabindex="-1"></a><span class="fu">### Dealing with respondent offsets</span></span>
<span id="cb58-1543"><a href="#cb58-1543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1544"><a href="#cb58-1544" aria-hidden="true" tabindex="-1"></a>When plugging values into <span class="in">`avg_slopes`</span> (or <span class="in">`predictions()`</span> or <span class="in">`marginal_means()`</span> or any function that calculates predictions from a model), we have to decide how to handle the random respondent offsets ($b_{0_j}$). <span class="co">[</span><span class="ot">I have a whole other blog post guide about this</span><span class="co">](https://www.andrewheiss.com/blog/2022/11/29/conditional-marginal-marginaleffects/#summary)</span> and how absolutely maddening the nomenclature for all this is.</span>
<span id="cb58-1545"><a href="#cb58-1545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1546"><a href="#cb58-1546" aria-hidden="true" tabindex="-1"></a>By default, <span class="in">`avg_slopes()`</span> and friends will calculate the effects for a typical respondent, or a respondent where the random offset is set to 0. It invisibly uses the <span class="in">`re_formula = NA`</span> argument to do this. This is also called a *conditional effect*.</span>
<span id="cb58-1547"><a href="#cb58-1547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1548"><a href="#cb58-1548" aria-hidden="true" tabindex="-1"></a>We could also use <span class="in">`re_formula = NULL`</span> to calculate the effect for respondents on average. This is also called a *marginal effect*. (ARGH I HATE THESE NAMES.). This estimate includes details from the random offsets, either by integrating them out or by using the mean and standard deviation of the random offsets to generate a simulated average respondent.</span>
<span id="cb58-1549"><a href="#cb58-1549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1550"><a href="#cb58-1550" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Conditional effect = average respondent = <span class="in">`re_formula = NA`</span> (default)</span>
<span id="cb58-1551"><a href="#cb58-1551" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Marginal effect = respondents on average = <span class="in">`re_formula = NULL`</span> + existing respondent levels or a new simulated respondent</span>
<span id="cb58-1552"><a href="#cb58-1552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1553"><a href="#cb58-1553" aria-hidden="true" tabindex="-1"></a>Again, <span class="co">[</span><span class="ot">see this guide for way more about these distinctions</span><span class="co">](https://www.andrewheiss.com/blog/2022/11/29/conditional-marginal-marginaleffects)</span>. In this example here, we'll just use conditional effects, or the effect for an average respondent.</span>
<span id="cb58-1554"><a href="#cb58-1554" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb58-1555"><a href="#cb58-1555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1556"><a href="#cb58-1556" aria-hidden="true" tabindex="-1"></a><span class="in">```{r amce-mfx-bayes-plot, fig.width=6, fig.height=9.5}</span></span>
<span id="cb58-1557"><a href="#cb58-1557" aria-hidden="true" tabindex="-1"></a><span class="in">posterior_mfx &lt;- model_brms %&gt;% </span></span>
<span id="cb58-1558"><a href="#cb58-1558" aria-hidden="true" tabindex="-1"></a><span class="in">  avg_slopes(newdata = "mean", allow_new_levels = TRUE) %&gt;% </span></span>
<span id="cb58-1559"><a href="#cb58-1559" aria-hidden="true" tabindex="-1"></a><span class="in">  posteriordraws() </span></span>
<span id="cb58-1560"><a href="#cb58-1560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1561"><a href="#cb58-1561" aria-hidden="true" tabindex="-1"></a><span class="in">posterior_mfx_nested &lt;- posterior_mfx %&gt;% </span></span>
<span id="cb58-1562"><a href="#cb58-1562" aria-hidden="true" tabindex="-1"></a><span class="in">  separate_wider_delim(</span></span>
<span id="cb58-1563"><a href="#cb58-1563" aria-hidden="true" tabindex="-1"></a><span class="in">    contrast,</span></span>
<span id="cb58-1564"><a href="#cb58-1564" aria-hidden="true" tabindex="-1"></a><span class="in">    delim = " - ", </span></span>
<span id="cb58-1565"><a href="#cb58-1565" aria-hidden="true" tabindex="-1"></a><span class="in">    names = c("variable_level", "reference_level")</span></span>
<span id="cb58-1566"><a href="#cb58-1566" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;% </span></span>
<span id="cb58-1567"><a href="#cb58-1567" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(term, variable_level) %&gt;% </span></span>
<span id="cb58-1568"><a href="#cb58-1568" aria-hidden="true" tabindex="-1"></a><span class="in">  nest()</span></span>
<span id="cb58-1569"><a href="#cb58-1569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1570"><a href="#cb58-1570" aria-hidden="true" tabindex="-1"></a><span class="in"># Combine full dataset of factor levels with model results</span></span>
<span id="cb58-1571"><a href="#cb58-1571" aria-hidden="true" tabindex="-1"></a><span class="in">plot_data_bayes &lt;- model_variable_levels %&gt;%</span></span>
<span id="cb58-1572"><a href="#cb58-1572" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(</span></span>
<span id="cb58-1573"><a href="#cb58-1573" aria-hidden="true" tabindex="-1"></a><span class="in">    posterior_mfx_nested,</span></span>
<span id="cb58-1574"><a href="#cb58-1574" aria-hidden="true" tabindex="-1"></a><span class="in">    by = join_by(variable == term, levels == variable_level)</span></span>
<span id="cb58-1575"><a href="#cb58-1575" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;%</span></span>
<span id="cb58-1576"><a href="#cb58-1576" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(data = map_if(data, is.null, ~ tibble(draw = 0, estimate = 0))) %&gt;% </span></span>
<span id="cb58-1577"><a href="#cb58-1577" aria-hidden="true" tabindex="-1"></a><span class="in">  unnest(data) %&gt;% </span></span>
<span id="cb58-1578"><a href="#cb58-1578" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(variable_lookup, by = join_by(variable)) %&gt;% </span></span>
<span id="cb58-1579"><a href="#cb58-1579" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(across(c(levels, variable_nice), ~fct_inorder(.)))</span></span>
<span id="cb58-1580"><a href="#cb58-1580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1581"><a href="#cb58-1581" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(plot_data_bayes, aes(x = draw, y = levels, fill = variable_nice)) +</span></span>
<span id="cb58-1582"><a href="#cb58-1582" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0) +</span></span>
<span id="cb58-1583"><a href="#cb58-1583" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye(normalize = "groups") +  # Make the heights of the distributions equal within each facet</span></span>
<span id="cb58-1584"><a href="#cb58-1584" aria-hidden="true" tabindex="-1"></a><span class="in">  guides(fill = "none") +</span></span>
<span id="cb58-1585"><a href="#cb58-1585" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_col(facets = "variable_nice", scales = "free_y", space = "free") +</span></span>
<span id="cb58-1586"><a href="#cb58-1586" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_pp) +</span></span>
<span id="cb58-1587"><a href="#cb58-1587" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(</span></span>
<span id="cb58-1588"><a href="#cb58-1588" aria-hidden="true" tabindex="-1"></a><span class="in">    x = "Percentage point change in probability of candidate selection",</span></span>
<span id="cb58-1589"><a href="#cb58-1589" aria-hidden="true" tabindex="-1"></a><span class="in">    y = NULL,</span></span>
<span id="cb58-1590"><a href="#cb58-1590" aria-hidden="true" tabindex="-1"></a><span class="in">    title = "Posterior AMCEs"</span></span>
<span id="cb58-1591"><a href="#cb58-1591" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb58-1592"><a href="#cb58-1592" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-1593"><a href="#cb58-1593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1594"><a href="#cb58-1594" aria-hidden="true" tabindex="-1"></a>The results here are all basically the same as what we found with all the frequentist approaches earlier, but now we have full posteriors for each of these AMCEs so we can do all sorts of neat Bayesian inference things, like calculating the probability that the effect is larger than zero. For instance, there's a 100% posterior probability that the None → Mormon effect is negative. The Business owner → Lawyer effect, on the other hand, is generally negative, but sometimes positive—there's a 78% posterior probability that it's negative.</span>
<span id="cb58-1595"><a href="#cb58-1595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1596"><a href="#cb58-1596" aria-hidden="true" tabindex="-1"></a><span class="in">```{r amce-mfx-bayes-plot-excerpt, fig.width=6, fig.height=3}</span></span>
<span id="cb58-1597"><a href="#cb58-1597" aria-hidden="true" tabindex="-1"></a><span class="in">example_amces &lt;- posterior_mfx %&gt;% </span></span>
<span id="cb58-1598"><a href="#cb58-1598" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(</span></span>
<span id="cb58-1599"><a href="#cb58-1599" aria-hidden="true" tabindex="-1"></a><span class="in">    term == "atreligion" &amp; contrast == "Mormon - None" |</span></span>
<span id="cb58-1600"><a href="#cb58-1600" aria-hidden="true" tabindex="-1"></a><span class="in">    term == "atprof" &amp; contrast == "Lawyer - Business owner"</span></span>
<span id="cb58-1601"><a href="#cb58-1601" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb58-1602"><a href="#cb58-1602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1603"><a href="#cb58-1603" aria-hidden="true" tabindex="-1"></a><span class="in">example_amces_p_direction &lt;- example_amces %&gt;% </span></span>
<span id="cb58-1604"><a href="#cb58-1604" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(contrast) %&gt;% </span></span>
<span id="cb58-1605"><a href="#cb58-1605" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(prop_lt_0 = sum(draw &lt; 0) / n()) %&gt;% </span></span>
<span id="cb58-1606"><a href="#cb58-1606" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb58-1607"><a href="#cb58-1607" aria-hidden="true" tabindex="-1"></a><span class="in">    prob_nice = label_percent()(prop_lt_0),</span></span>
<span id="cb58-1608"><a href="#cb58-1608" aria-hidden="true" tabindex="-1"></a><span class="in">    label = glue::glue("P(θ &lt; 0) = {prob_nice}")</span></span>
<span id="cb58-1609"><a href="#cb58-1609" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb58-1610"><a href="#cb58-1610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1611"><a href="#cb58-1611" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(example_amces, aes(x = draw)) +</span></span>
<span id="cb58-1612"><a href="#cb58-1612" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye(aes(fill_ramp = after_stat(x &gt; 0)), fill = "grey50") +</span></span>
<span id="cb58-1613"><a href="#cb58-1613" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0) +</span></span>
<span id="cb58-1614"><a href="#cb58-1614" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_text(</span></span>
<span id="cb58-1615"><a href="#cb58-1615" aria-hidden="true" tabindex="-1"></a><span class="in">    data = example_amces_p_direction, </span></span>
<span id="cb58-1616"><a href="#cb58-1616" aria-hidden="true" tabindex="-1"></a><span class="in">    aes(x = -0.21, y = 0.9, label = label),</span></span>
<span id="cb58-1617"><a href="#cb58-1617" aria-hidden="true" tabindex="-1"></a><span class="in">    hjust = 0</span></span>
<span id="cb58-1618"><a href="#cb58-1618" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb58-1619"><a href="#cb58-1619" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_pp) +</span></span>
<span id="cb58-1620"><a href="#cb58-1620" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_ramp_discrete(from = "#FF851B", guide = "none") +</span></span>
<span id="cb58-1621"><a href="#cb58-1621" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(</span></span>
<span id="cb58-1622"><a href="#cb58-1622" aria-hidden="true" tabindex="-1"></a><span class="in">    x = "Percentage point change in probability of candidate selection", </span></span>
<span id="cb58-1623"><a href="#cb58-1623" aria-hidden="true" tabindex="-1"></a><span class="in">    y = NULL, </span></span>
<span id="cb58-1624"><a href="#cb58-1624" aria-hidden="true" tabindex="-1"></a><span class="in">    title = "Two example AMCEs"</span></span>
<span id="cb58-1625"><a href="#cb58-1625" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb58-1626"><a href="#cb58-1626" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(vars(fct_rev(contrast))) +</span></span>
<span id="cb58-1627"><a href="#cb58-1627" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(</span></span>
<span id="cb58-1628"><a href="#cb58-1628" aria-hidden="true" tabindex="-1"></a><span class="in">    axis.text.y = element_blank(),</span></span>
<span id="cb58-1629"><a href="#cb58-1629" aria-hidden="true" tabindex="-1"></a><span class="in">    panel.grid = element_blank(),</span></span>
<span id="cb58-1630"><a href="#cb58-1630" aria-hidden="true" tabindex="-1"></a><span class="in">    panel.background = element_rect(color = "grey90", linewidth = 0.5)</span></span>
<span id="cb58-1631"><a href="#cb58-1631" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb58-1632"><a href="#cb58-1632" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-1633"><a href="#cb58-1633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1634"><a href="#cb58-1634" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1635"><a href="#cb58-1635" aria-hidden="true" tabindex="-1"></a><span class="fu">## Marginal means</span></span>
<span id="cb58-1636"><a href="#cb58-1636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1637"><a href="#cb58-1637" aria-hidden="true" tabindex="-1"></a>Instead of working with causal AMCEs, which are all relative to an omitted feature level, we can work with absolute marginal means to be more descriptive with our estimands. We could find the overall level of favorability of Mormon candidates…</span>
<span id="cb58-1638"><a href="#cb58-1638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1639"><a href="#cb58-1639" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb58-1640"><a href="#cb58-1640" aria-hidden="true" tabindex="-1"></a>\theta = P(\text{Candidate selection} \mid \text{Religion = Mormon})</span>
<span id="cb58-1641"><a href="#cb58-1641" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb58-1642"><a href="#cb58-1642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1643"><a href="#cb58-1643" aria-hidden="true" tabindex="-1"></a>…or the difference between Mormon and Catholic favorability…</span>
<span id="cb58-1644"><a href="#cb58-1644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1645"><a href="#cb58-1645" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb58-1646"><a href="#cb58-1646" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb58-1647"><a href="#cb58-1647" aria-hidden="true" tabindex="-1"></a>\theta =\ &amp;P<span class="co">[</span><span class="ot">\text{Candidate selection} \mid \text{Religion = Mormon}</span><span class="co">]</span>\ - <span class="sc">\\</span></span>
<span id="cb58-1648"><a href="#cb58-1648" aria-hidden="true" tabindex="-1"></a>&amp;P<span class="co">[</span><span class="ot">\text{Candidate selection} \mid \text{Religion = Catholic}</span><span class="co">]</span></span>
<span id="cb58-1649"><a href="#cb58-1649" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb58-1650"><a href="#cb58-1650" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb58-1651"><a href="#cb58-1651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1652"><a href="#cb58-1652" aria-hidden="true" tabindex="-1"></a>Unfortunately <span class="in">`marginaleffects::marginal_means()`</span> doesn't work with brms models. BUT we can fake it by finding the posterior marginal means for each of the features individually and then combining them into one big data frame.</span>
<span id="cb58-1653"><a href="#cb58-1653" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1654"><a href="#cb58-1654" aria-hidden="true" tabindex="-1"></a><span class="in">```{r calc-bayes-mms, cache=TRUE}</span></span>
<span id="cb58-1655"><a href="#cb58-1655" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb58-1656"><a href="#cb58-1656" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-summary: "Click to show the code. It's hidden because it's long and repetitive."</span></span>
<span id="cb58-1657"><a href="#cb58-1657" aria-hidden="true" tabindex="-1"></a><span class="in"># There's probably a more efficient way to do with with mapping or loops or</span></span>
<span id="cb58-1658"><a href="#cb58-1658" aria-hidden="true" tabindex="-1"></a><span class="in"># whatever but I don't want to figure it out right now, so we brute force it</span></span>
<span id="cb58-1659"><a href="#cb58-1659" aria-hidden="true" tabindex="-1"></a><span class="in">posterior_mms &lt;- bind_rows(</span></span>
<span id="cb58-1660"><a href="#cb58-1660" aria-hidden="true" tabindex="-1"></a><span class="in">  atmilitary = predictions(</span></span>
<span id="cb58-1661"><a href="#cb58-1661" aria-hidden="true" tabindex="-1"></a><span class="in">    model_brms,</span></span>
<span id="cb58-1662"><a href="#cb58-1662" aria-hidden="true" tabindex="-1"></a><span class="in">    by = "atmilitary",</span></span>
<span id="cb58-1663"><a href="#cb58-1663" aria-hidden="true" tabindex="-1"></a><span class="in">    allow_new_levels = TRUE</span></span>
<span id="cb58-1664"><a href="#cb58-1664" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;% rename(value = atmilitary) %&gt;% posteriordraws(),</span></span>
<span id="cb58-1665"><a href="#cb58-1665" aria-hidden="true" tabindex="-1"></a><span class="in">  atreligion = predictions(</span></span>
<span id="cb58-1666"><a href="#cb58-1666" aria-hidden="true" tabindex="-1"></a><span class="in">    model_brms,</span></span>
<span id="cb58-1667"><a href="#cb58-1667" aria-hidden="true" tabindex="-1"></a><span class="in">    by = "atreligion",</span></span>
<span id="cb58-1668"><a href="#cb58-1668" aria-hidden="true" tabindex="-1"></a><span class="in">    allow_new_levels = TRUE</span></span>
<span id="cb58-1669"><a href="#cb58-1669" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;% rename(value = atreligion) %&gt;% posteriordraws(),</span></span>
<span id="cb58-1670"><a href="#cb58-1670" aria-hidden="true" tabindex="-1"></a><span class="in">  ated = predictions(</span></span>
<span id="cb58-1671"><a href="#cb58-1671" aria-hidden="true" tabindex="-1"></a><span class="in">    model_brms,</span></span>
<span id="cb58-1672"><a href="#cb58-1672" aria-hidden="true" tabindex="-1"></a><span class="in">    by = "ated",</span></span>
<span id="cb58-1673"><a href="#cb58-1673" aria-hidden="true" tabindex="-1"></a><span class="in">    allow_new_levels = TRUE</span></span>
<span id="cb58-1674"><a href="#cb58-1674" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;% rename(value = ated) %&gt;% posteriordraws(),</span></span>
<span id="cb58-1675"><a href="#cb58-1675" aria-hidden="true" tabindex="-1"></a><span class="in">  atprof = predictions(</span></span>
<span id="cb58-1676"><a href="#cb58-1676" aria-hidden="true" tabindex="-1"></a><span class="in">    model_brms,</span></span>
<span id="cb58-1677"><a href="#cb58-1677" aria-hidden="true" tabindex="-1"></a><span class="in">    by = "atprof",</span></span>
<span id="cb58-1678"><a href="#cb58-1678" aria-hidden="true" tabindex="-1"></a><span class="in">    allow_new_levels = TRUE</span></span>
<span id="cb58-1679"><a href="#cb58-1679" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;% rename(value = atprof) %&gt;% posteriordraws(),</span></span>
<span id="cb58-1680"><a href="#cb58-1680" aria-hidden="true" tabindex="-1"></a><span class="in">  atprof = predictions(</span></span>
<span id="cb58-1681"><a href="#cb58-1681" aria-hidden="true" tabindex="-1"></a><span class="in">    model_brms,</span></span>
<span id="cb58-1682"><a href="#cb58-1682" aria-hidden="true" tabindex="-1"></a><span class="in">    by = "atprof",</span></span>
<span id="cb58-1683"><a href="#cb58-1683" aria-hidden="true" tabindex="-1"></a><span class="in">    allow_new_levels = TRUE</span></span>
<span id="cb58-1684"><a href="#cb58-1684" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;% rename(value = atprof) %&gt;% posteriordraws(),</span></span>
<span id="cb58-1685"><a href="#cb58-1685" aria-hidden="true" tabindex="-1"></a><span class="in">  atinc = predictions(</span></span>
<span id="cb58-1686"><a href="#cb58-1686" aria-hidden="true" tabindex="-1"></a><span class="in">    model_brms,</span></span>
<span id="cb58-1687"><a href="#cb58-1687" aria-hidden="true" tabindex="-1"></a><span class="in">    by = "atinc",</span></span>
<span id="cb58-1688"><a href="#cb58-1688" aria-hidden="true" tabindex="-1"></a><span class="in">    allow_new_levels = TRUE</span></span>
<span id="cb58-1689"><a href="#cb58-1689" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;% rename(value = atinc) %&gt;% posteriordraws(),</span></span>
<span id="cb58-1690"><a href="#cb58-1690" aria-hidden="true" tabindex="-1"></a><span class="in">  atrace = predictions(</span></span>
<span id="cb58-1691"><a href="#cb58-1691" aria-hidden="true" tabindex="-1"></a><span class="in">    model_brms,</span></span>
<span id="cb58-1692"><a href="#cb58-1692" aria-hidden="true" tabindex="-1"></a><span class="in">    by = "atrace",</span></span>
<span id="cb58-1693"><a href="#cb58-1693" aria-hidden="true" tabindex="-1"></a><span class="in">    allow_new_levels = TRUE</span></span>
<span id="cb58-1694"><a href="#cb58-1694" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;% rename(value = atrace) %&gt;% posteriordraws(),</span></span>
<span id="cb58-1695"><a href="#cb58-1695" aria-hidden="true" tabindex="-1"></a><span class="in">  atage = predictions(</span></span>
<span id="cb58-1696"><a href="#cb58-1696" aria-hidden="true" tabindex="-1"></a><span class="in">    model_brms,</span></span>
<span id="cb58-1697"><a href="#cb58-1697" aria-hidden="true" tabindex="-1"></a><span class="in">    by = "atage",</span></span>
<span id="cb58-1698"><a href="#cb58-1698" aria-hidden="true" tabindex="-1"></a><span class="in">    allow_new_levels = TRUE</span></span>
<span id="cb58-1699"><a href="#cb58-1699" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;% rename(value = atage) %&gt;% posteriordraws(),</span></span>
<span id="cb58-1700"><a href="#cb58-1700" aria-hidden="true" tabindex="-1"></a><span class="in">  atmale = predictions(</span></span>
<span id="cb58-1701"><a href="#cb58-1701" aria-hidden="true" tabindex="-1"></a><span class="in">    model_brms,</span></span>
<span id="cb58-1702"><a href="#cb58-1702" aria-hidden="true" tabindex="-1"></a><span class="in">    by = "atmale",</span></span>
<span id="cb58-1703"><a href="#cb58-1703" aria-hidden="true" tabindex="-1"></a><span class="in">    allow_new_levels = TRUE</span></span>
<span id="cb58-1704"><a href="#cb58-1704" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;% rename(value = atmale) %&gt;% posteriordraws(),</span></span>
<span id="cb58-1705"><a href="#cb58-1705" aria-hidden="true" tabindex="-1"></a><span class="in">  .id = "term"</span></span>
<span id="cb58-1706"><a href="#cb58-1706" aria-hidden="true" tabindex="-1"></a><span class="in">) %&gt;% </span></span>
<span id="cb58-1707"><a href="#cb58-1707" aria-hidden="true" tabindex="-1"></a><span class="in">  as_tibble()</span></span>
<span id="cb58-1708"><a href="#cb58-1708" aria-hidden="true" tabindex="-1"></a><span class="in">posterior_mms</span></span>
<span id="cb58-1709"><a href="#cb58-1709" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-1710"><a href="#cb58-1710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1711"><a href="#cb58-1711" aria-hidden="true" tabindex="-1"></a>Here are the marginal means for all the levels of all candidate features:</span>
<span id="cb58-1712"><a href="#cb58-1712" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1713"><a href="#cb58-1713" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mm-mfx-bayes-plot, fig.width=6, fig.height=9.5}</span></span>
<span id="cb58-1714"><a href="#cb58-1714" aria-hidden="true" tabindex="-1"></a><span class="in">plot_posterior_mms &lt;- posterior_mms %&gt;% </span></span>
<span id="cb58-1715"><a href="#cb58-1715" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(variable_lookup, by = join_by(term == variable)) %&gt;% </span></span>
<span id="cb58-1716"><a href="#cb58-1716" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(across(c(value, variable_nice), ~fct_inorder(.)))</span></span>
<span id="cb58-1717"><a href="#cb58-1717" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb58-1718"><a href="#cb58-1718" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(</span></span>
<span id="cb58-1719"><a href="#cb58-1719" aria-hidden="true" tabindex="-1"></a><span class="in">  plot_posterior_mms,</span></span>
<span id="cb58-1720"><a href="#cb58-1720" aria-hidden="true" tabindex="-1"></a><span class="in">  aes(x = draw, y = value, fill = variable_nice)</span></span>
<span id="cb58-1721"><a href="#cb58-1721" aria-hidden="true" tabindex="-1"></a><span class="in">) +</span></span>
<span id="cb58-1722"><a href="#cb58-1722" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0.5) +</span></span>
<span id="cb58-1723"><a href="#cb58-1723" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye(normalize = "groups") +  # Make the heights of the distributions equal within each facet</span></span>
<span id="cb58-1724"><a href="#cb58-1724" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_col(facets = "variable_nice", scales = "free_y", space = "free") +</span></span>
<span id="cb58-1725"><a href="#cb58-1725" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_percent()) +</span></span>
<span id="cb58-1726"><a href="#cb58-1726" aria-hidden="true" tabindex="-1"></a><span class="in">  guides(fill = "none") +</span></span>
<span id="cb58-1727"><a href="#cb58-1727" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(</span></span>
<span id="cb58-1728"><a href="#cb58-1728" aria-hidden="true" tabindex="-1"></a><span class="in">    x = "Marginal means of probabilities",</span></span>
<span id="cb58-1729"><a href="#cb58-1729" aria-hidden="true" tabindex="-1"></a><span class="in">    y = NULL,</span></span>
<span id="cb58-1730"><a href="#cb58-1730" aria-hidden="true" tabindex="-1"></a><span class="in">    title = "Posterior marginal means"</span></span>
<span id="cb58-1731"><a href="#cb58-1731" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb58-1732"><a href="#cb58-1732" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-1733"><a href="#cb58-1733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1734"><a href="#cb58-1734" aria-hidden="true" tabindex="-1"></a>And here are the two we mentioned at the beginning of this section—overall favorability of Mormon candidates and the difference between Mormon and Catholic favorability. Mormon candidates have a median posterior favorability of 41.8%, with a 95% credible interval of 38–46%. The median posterior difference between Mormon and Catholic favorability is 10.8 percentage points, with a 95% credible interval of 5–16 percentage points. Neat.</span>
<span id="cb58-1735"><a href="#cb58-1735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1736"><a href="#cb58-1736" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mms-bayes-medians-cis}</span></span>
<span id="cb58-1737"><a href="#cb58-1737" aria-hidden="true" tabindex="-1"></a><span class="in">mms_mormon &lt;- posterior_mms %&gt;% </span></span>
<span id="cb58-1738"><a href="#cb58-1738" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(term == "atreligion", value == "Mormon")</span></span>
<span id="cb58-1739"><a href="#cb58-1739" aria-hidden="true" tabindex="-1"></a><span class="in">mms_mormon %&gt;% median_qi(draw)</span></span>
<span id="cb58-1740"><a href="#cb58-1740" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1741"><a href="#cb58-1741" aria-hidden="true" tabindex="-1"></a><span class="in">mms_mormon_catholic &lt;- posterior_mms %&gt;% </span></span>
<span id="cb58-1742"><a href="#cb58-1742" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(term == "atreligion", value %in% c("Mormon", "Catholic")) %&gt;% </span></span>
<span id="cb58-1743"><a href="#cb58-1743" aria-hidden="true" tabindex="-1"></a><span class="in">  select(drawid, draw, value) %&gt;% </span></span>
<span id="cb58-1744"><a href="#cb58-1744" aria-hidden="true" tabindex="-1"></a><span class="in">  pivot_wider(names_from = "value", values_from = "draw") %&gt;% </span></span>
<span id="cb58-1745"><a href="#cb58-1745" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(diff = Mormon - Catholic)</span></span>
<span id="cb58-1746"><a href="#cb58-1746" aria-hidden="true" tabindex="-1"></a><span class="in">mms_mormon_catholic %&gt;% median_qi(diff)</span></span>
<span id="cb58-1747"><a href="#cb58-1747" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-1748"><a href="#cb58-1748" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1749"><a href="#cb58-1749" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mm-mfx-bayes-plot-excerpt, fig.width=6, fig.height=3}</span></span>
<span id="cb58-1750"><a href="#cb58-1750" aria-hidden="true" tabindex="-1"></a><span class="in">mm1 &lt;- ggplot(mms_mormon, aes(x = draw)) +</span></span>
<span id="cb58-1751"><a href="#cb58-1751" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye(fill = "#FF851B") +</span></span>
<span id="cb58-1752"><a href="#cb58-1752" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(vars("Mormon favorability")) +</span></span>
<span id="cb58-1753"><a href="#cb58-1753" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_percent()) +</span></span>
<span id="cb58-1754"><a href="#cb58-1754" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Marginal mean", y = NULL) +</span></span>
<span id="cb58-1755"><a href="#cb58-1755" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(</span></span>
<span id="cb58-1756"><a href="#cb58-1756" aria-hidden="true" tabindex="-1"></a><span class="in">    axis.text.y = element_blank(),</span></span>
<span id="cb58-1757"><a href="#cb58-1757" aria-hidden="true" tabindex="-1"></a><span class="in">    panel.grid = element_blank(),</span></span>
<span id="cb58-1758"><a href="#cb58-1758" aria-hidden="true" tabindex="-1"></a><span class="in">    panel.background = element_rect(color = "grey90", linewidth = 0.5)</span></span>
<span id="cb58-1759"><a href="#cb58-1759" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb58-1760"><a href="#cb58-1760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1761"><a href="#cb58-1761" aria-hidden="true" tabindex="-1"></a><span class="in">mm2 &lt;- ggplot(mms_mormon_catholic, aes(x = diff)) +</span></span>
<span id="cb58-1762"><a href="#cb58-1762" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye(fill = "#B10DC9") +</span></span>
<span id="cb58-1763"><a href="#cb58-1763" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(vars("Difference between Mormons and Catholics")) +</span></span>
<span id="cb58-1764"><a href="#cb58-1764" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_pp) +</span></span>
<span id="cb58-1765"><a href="#cb58-1765" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Difference in marginal means", y = NULL) +</span></span>
<span id="cb58-1766"><a href="#cb58-1766" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(</span></span>
<span id="cb58-1767"><a href="#cb58-1767" aria-hidden="true" tabindex="-1"></a><span class="in">    axis.text.y = element_blank(),</span></span>
<span id="cb58-1768"><a href="#cb58-1768" aria-hidden="true" tabindex="-1"></a><span class="in">    panel.grid = element_blank(),</span></span>
<span id="cb58-1769"><a href="#cb58-1769" aria-hidden="true" tabindex="-1"></a><span class="in">    panel.background = element_rect(color = "grey90", linewidth = 0.5)</span></span>
<span id="cb58-1770"><a href="#cb58-1770" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb58-1771"><a href="#cb58-1771" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1772"><a href="#cb58-1772" aria-hidden="true" tabindex="-1"></a><span class="in">mm1 | mm2</span></span>
<span id="cb58-1773"><a href="#cb58-1773" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-1774"><a href="#cb58-1774" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1775"><a href="#cb58-1775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1776"><a href="#cb58-1776" aria-hidden="true" tabindex="-1"></a><span class="fu">## Subgroup differences</span></span>
<span id="cb58-1777"><a href="#cb58-1777" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1778"><a href="#cb58-1778" aria-hidden="true" tabindex="-1"></a>Finally, if we're interested in subgroup differences, we can run a separate model with an interaction term for the subgroups we're interested in. Again, this candidate experiment didn't include any respondent-level covariates, so we'll use the made-up, fake respondent political party that we used earlier. </span>
<span id="cb58-1779"><a href="#cb58-1779" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1780"><a href="#cb58-1780" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-brms-interaction}</span></span>
<span id="cb58-1781"><a href="#cb58-1781" aria-hidden="true" tabindex="-1"></a><span class="in">priors &lt;- c(</span></span>
<span id="cb58-1782"><a href="#cb58-1782" aria-hidden="true" tabindex="-1"></a><span class="in">  prior(normal(0, 1), class = Intercept),</span></span>
<span id="cb58-1783"><a href="#cb58-1783" aria-hidden="true" tabindex="-1"></a><span class="in">  prior(normal(0, 1), class = b),</span></span>
<span id="cb58-1784"><a href="#cb58-1784" aria-hidden="true" tabindex="-1"></a><span class="in">  prior(exponential(1), class = sd)</span></span>
<span id="cb58-1785"><a href="#cb58-1785" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb58-1786"><a href="#cb58-1786" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1787"><a href="#cb58-1787" aria-hidden="true" tabindex="-1"></a><span class="in">model_brms_military_party &lt;- brm(</span></span>
<span id="cb58-1788"><a href="#cb58-1788" aria-hidden="true" tabindex="-1"></a><span class="in">  bf(selected ~ atmilitary * respondent_party + (1 | resID)),</span></span>
<span id="cb58-1789"><a href="#cb58-1789" aria-hidden="true" tabindex="-1"></a><span class="in">  data = candidate_fake,</span></span>
<span id="cb58-1790"><a href="#cb58-1790" aria-hidden="true" tabindex="-1"></a><span class="in">  family = bernoulli(link = "logit"),</span></span>
<span id="cb58-1791"><a href="#cb58-1791" aria-hidden="true" tabindex="-1"></a><span class="in">  prior = priors,</span></span>
<span id="cb58-1792"><a href="#cb58-1792" aria-hidden="true" tabindex="-1"></a><span class="in">  chains = 4, cores = 4, iter = 2000, seed = 1234,</span></span>
<span id="cb58-1793"><a href="#cb58-1793" aria-hidden="true" tabindex="-1"></a><span class="in">  backend = "cmdstanr", threads = threading(2), refresh = 0,</span></span>
<span id="cb58-1794"><a href="#cb58-1794" aria-hidden="true" tabindex="-1"></a><span class="in">  file = "candidate_model_brms_interaction"</span></span>
<span id="cb58-1795"><a href="#cb58-1795" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb58-1796"><a href="#cb58-1796" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-1797"><a href="#cb58-1797" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1798"><a href="#cb58-1798" aria-hidden="true" tabindex="-1"></a><span class="fu">### Conditional AMCEs</span></span>
<span id="cb58-1799"><a href="#cb58-1799" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1800"><a href="#cb58-1800" aria-hidden="true" tabindex="-1"></a>We can calculate two different causal estimands, the conditional AMCE across each respondent political party of switching a candidate from having no military history to having served in the military. Because this model (1) uses logit-scale coefficients and (2) splits the causal effects across a bunch of different regression terms, we'll use <span class="in">`marginaleffects::avg_slopes()`</span> to find the group-specific probability-scale marginal effects.</span>
<span id="cb58-1801"><a href="#cb58-1801" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1802"><a href="#cb58-1802" aria-hidden="true" tabindex="-1"></a>Among Republican respondents, the causal effect of a candidate switching from no military history to having military service history has a posterior median of 23.8 percentage points, with a 95% credible interval of 19–28 percentage points. For Democrats, the same causal effect is negative, with a posterior median of −9.8 percentage points and a 95% credible interval of −5 to −14.7 percentage points.</span>
<span id="cb58-1803"><a href="#cb58-1803" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1804"><a href="#cb58-1804" aria-hidden="true" tabindex="-1"></a><span class="in">```{r calc-bayes-party-amces}</span></span>
<span id="cb58-1805"><a href="#cb58-1805" aria-hidden="true" tabindex="-1"></a><span class="in">posterior_party_amces &lt;- model_brms_military_party %&gt;% </span></span>
<span id="cb58-1806"><a href="#cb58-1806" aria-hidden="true" tabindex="-1"></a><span class="in">  avg_slopes(</span></span>
<span id="cb58-1807"><a href="#cb58-1807" aria-hidden="true" tabindex="-1"></a><span class="in">    newdata = "mean",</span></span>
<span id="cb58-1808"><a href="#cb58-1808" aria-hidden="true" tabindex="-1"></a><span class="in">    variables = "atmilitary",</span></span>
<span id="cb58-1809"><a href="#cb58-1809" aria-hidden="true" tabindex="-1"></a><span class="in">    by = "respondent_party",</span></span>
<span id="cb58-1810"><a href="#cb58-1810" aria-hidden="true" tabindex="-1"></a><span class="in">    allow_new_levels = TRUE</span></span>
<span id="cb58-1811"><a href="#cb58-1811" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;% </span></span>
<span id="cb58-1812"><a href="#cb58-1812" aria-hidden="true" tabindex="-1"></a><span class="in">  posteriordraws()</span></span>
<span id="cb58-1813"><a href="#cb58-1813" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1814"><a href="#cb58-1814" aria-hidden="true" tabindex="-1"></a><span class="in">posterior_party_amces %&gt;% </span></span>
<span id="cb58-1815"><a href="#cb58-1815" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(respondent_party) %&gt;% </span></span>
<span id="cb58-1816"><a href="#cb58-1816" aria-hidden="true" tabindex="-1"></a><span class="in">  median_qi(draw)</span></span>
<span id="cb58-1817"><a href="#cb58-1817" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-1818"><a href="#cb58-1818" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1819"><a href="#cb58-1819" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-posterior-party-amce, fig.width=6, fig.height=3, warning=FALSE}</span></span>
<span id="cb58-1820"><a href="#cb58-1820" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb58-1821"><a href="#cb58-1821" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-summary: "Click to show the code since it's so long"</span></span>
<span id="cb58-1822"><a href="#cb58-1822" aria-hidden="true" tabindex="-1"></a><span class="in">posterior_party_amces_wide &lt;- posterior_party_amces %&gt;%</span></span>
<span id="cb58-1823"><a href="#cb58-1823" aria-hidden="true" tabindex="-1"></a><span class="in">  # The contrast column contains values like this:</span></span>
<span id="cb58-1824"><a href="#cb58-1824" aria-hidden="true" tabindex="-1"></a><span class="in">  #   mean(Served) - mean(Did Not Serve)</span></span>
<span id="cb58-1825"><a href="#cb58-1825" aria-hidden="true" tabindex="-1"></a><span class="in">  # I could probably use some fancy regex to extract those things, but here I'll</span></span>
<span id="cb58-1826"><a href="#cb58-1826" aria-hidden="true" tabindex="-1"></a><span class="in">  # just brute force it and remove "mean(" and ")" with two separate</span></span>
<span id="cb58-1827"><a href="#cb58-1827" aria-hidden="true" tabindex="-1"></a><span class="in">  # str_remove()s</span></span>
<span id="cb58-1828"><a href="#cb58-1828" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb58-1829"><a href="#cb58-1829" aria-hidden="true" tabindex="-1"></a><span class="in">    contrast = str_remove_all(contrast, "mean\\("),</span></span>
<span id="cb58-1830"><a href="#cb58-1830" aria-hidden="true" tabindex="-1"></a><span class="in">    contrast = str_remove_all(contrast, "\\)")</span></span>
<span id="cb58-1831"><a href="#cb58-1831" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;% </span></span>
<span id="cb58-1832"><a href="#cb58-1832" aria-hidden="true" tabindex="-1"></a><span class="in">  separate_wider_delim(</span></span>
<span id="cb58-1833"><a href="#cb58-1833" aria-hidden="true" tabindex="-1"></a><span class="in">    contrast,</span></span>
<span id="cb58-1834"><a href="#cb58-1834" aria-hidden="true" tabindex="-1"></a><span class="in">    delim = " - ", </span></span>
<span id="cb58-1835"><a href="#cb58-1835" aria-hidden="true" tabindex="-1"></a><span class="in">    names = c("variable_level", "reference_level")</span></span>
<span id="cb58-1836"><a href="#cb58-1836" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb58-1837"><a href="#cb58-1837" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1838"><a href="#cb58-1838" aria-hidden="true" tabindex="-1"></a><span class="in"># Combine full dataset of factor levels with marginal effects</span></span>
<span id="cb58-1839"><a href="#cb58-1839" aria-hidden="true" tabindex="-1"></a><span class="in">plot_posterior_party_amces &lt;- expand_grid(</span></span>
<span id="cb58-1840"><a href="#cb58-1840" aria-hidden="true" tabindex="-1"></a><span class="in">  respondent_party = levels(candidate_fake$respondent_party),</span></span>
<span id="cb58-1841"><a href="#cb58-1841" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(model_variable_levels, variable == "atmilitary")</span></span>
<span id="cb58-1842"><a href="#cb58-1842" aria-hidden="true" tabindex="-1"></a><span class="in">) %&gt;%</span></span>
<span id="cb58-1843"><a href="#cb58-1843" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(</span></span>
<span id="cb58-1844"><a href="#cb58-1844" aria-hidden="true" tabindex="-1"></a><span class="in">    posterior_party_amces_wide,</span></span>
<span id="cb58-1845"><a href="#cb58-1845" aria-hidden="true" tabindex="-1"></a><span class="in">    by = join_by(variable == term, levels == variable_level, respondent_party)</span></span>
<span id="cb58-1846"><a href="#cb58-1846" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;%</span></span>
<span id="cb58-1847"><a href="#cb58-1847" aria-hidden="true" tabindex="-1"></a><span class="in">  # Make these zero</span></span>
<span id="cb58-1848"><a href="#cb58-1848" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb58-1849"><a href="#cb58-1849" aria-hidden="true" tabindex="-1"></a><span class="in">    across(</span></span>
<span id="cb58-1850"><a href="#cb58-1850" aria-hidden="true" tabindex="-1"></a><span class="in">      c(draw, estimate),</span></span>
<span id="cb58-1851"><a href="#cb58-1851" aria-hidden="true" tabindex="-1"></a><span class="in">      ~ ifelse(is.na(.x), 0, .x)</span></span>
<span id="cb58-1852"><a href="#cb58-1852" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb58-1853"><a href="#cb58-1853" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;% </span></span>
<span id="cb58-1854"><a href="#cb58-1854" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(variable_lookup, by = join_by(variable)) %&gt;% </span></span>
<span id="cb58-1855"><a href="#cb58-1855" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(across(c(levels, variable_nice), ~fct_inorder(.))) %&gt;% </span></span>
<span id="cb58-1856"><a href="#cb58-1856" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(estimate_nice = case_when(</span></span>
<span id="cb58-1857"><a href="#cb58-1857" aria-hidden="true" tabindex="-1"></a><span class="in">    estimate != 0 ~ label_amce(estimate),</span></span>
<span id="cb58-1858"><a href="#cb58-1858" aria-hidden="true" tabindex="-1"></a><span class="in">    estimate == 0 ~ NA</span></span>
<span id="cb58-1859"><a href="#cb58-1859" aria-hidden="true" tabindex="-1"></a><span class="in">  ))</span></span>
<span id="cb58-1860"><a href="#cb58-1860" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1861"><a href="#cb58-1861" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(</span></span>
<span id="cb58-1862"><a href="#cb58-1862" aria-hidden="true" tabindex="-1"></a><span class="in">  plot_posterior_party_amces, </span></span>
<span id="cb58-1863"><a href="#cb58-1863" aria-hidden="true" tabindex="-1"></a><span class="in">  aes(x = draw, y = levels, color = respondent_party, fill = respondent_party)) +</span></span>
<span id="cb58-1864"><a href="#cb58-1864" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0) +</span></span>
<span id="cb58-1865"><a href="#cb58-1865" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye(position = position_dodge(width = 0.15)) +</span></span>
<span id="cb58-1866"><a href="#cb58-1866" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_pp) +</span></span>
<span id="cb58-1867"><a href="#cb58-1867" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_color_manual(</span></span>
<span id="cb58-1868"><a href="#cb58-1868" aria-hidden="true" tabindex="-1"></a><span class="in">    values = parties,</span></span>
<span id="cb58-1869"><a href="#cb58-1869" aria-hidden="true" tabindex="-1"></a><span class="in">    guide = guide_legend(</span></span>
<span id="cb58-1870"><a href="#cb58-1870" aria-hidden="true" tabindex="-1"></a><span class="in">      override.aes = list(linetype = 0, fill = parties),</span></span>
<span id="cb58-1871"><a href="#cb58-1871" aria-hidden="true" tabindex="-1"></a><span class="in">      keywidth = 0.8, keyheight = 0.8)</span></span>
<span id="cb58-1872"><a href="#cb58-1872" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb58-1873"><a href="#cb58-1873" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_manual(</span></span>
<span id="cb58-1874"><a href="#cb58-1874" aria-hidden="true" tabindex="-1"></a><span class="in">    values = colorspace::lighten(parties, 0.4), </span></span>
<span id="cb58-1875"><a href="#cb58-1875" aria-hidden="true" tabindex="-1"></a><span class="in">    guide = "none"</span></span>
<span id="cb58-1876"><a href="#cb58-1876" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb58-1877"><a href="#cb58-1877" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(</span></span>
<span id="cb58-1878"><a href="#cb58-1878" aria-hidden="true" tabindex="-1"></a><span class="in">    x = "Percentage point change in probability of candidate selection",</span></span>
<span id="cb58-1879"><a href="#cb58-1879" aria-hidden="true" tabindex="-1"></a><span class="in">    y = NULL,</span></span>
<span id="cb58-1880"><a href="#cb58-1880" aria-hidden="true" tabindex="-1"></a><span class="in">    color = NULL,</span></span>
<span id="cb58-1881"><a href="#cb58-1881" aria-hidden="true" tabindex="-1"></a><span class="in">    title = "Posterior AMCEs by respondent party"</span></span>
<span id="cb58-1882"><a href="#cb58-1882" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb58-1883"><a href="#cb58-1883" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(vars(variable_nice)) +</span></span>
<span id="cb58-1884"><a href="#cb58-1884" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(</span></span>
<span id="cb58-1885"><a href="#cb58-1885" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.position = "bottom",</span></span>
<span id="cb58-1886"><a href="#cb58-1886" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.justification = "left",</span></span>
<span id="cb58-1887"><a href="#cb58-1887" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.margin = margin(l = -7, t = -5)</span></span>
<span id="cb58-1888"><a href="#cb58-1888" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb58-1889"><a href="#cb58-1889" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-1890"><a href="#cb58-1890" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1891"><a href="#cb58-1891" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1892"><a href="#cb58-1892" aria-hidden="true" tabindex="-1"></a><span class="fu">### Conditional marginal means</span></span>
<span id="cb58-1893"><a href="#cb58-1893" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1894"><a href="#cb58-1894" aria-hidden="true" tabindex="-1"></a>And finally, we can calculate subgroup conditional marginal means to describe general party-based trends (since the relative conditional AMCEs create an illusion of difference). Again, since <span class="in">`marginaleffects::marginal_means()`</span> doesn't work with brms models, we can instead use <span class="in">`marginaleffects::predictions()`</span>, which still works with the neat <span class="in">`hypothesis`</span> argument for calculating contrasts.</span>
<span id="cb58-1895"><a href="#cb58-1895" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1896"><a href="#cb58-1896" aria-hidden="true" tabindex="-1"></a>In the left panel below, Democratic respondents prefer candidates that haven't served in the military (55% median posterior; 95% credible interval: 51–58%) to those that have (45% median posterior; 95% credible interval: 41–48%). Republicans strongly prefer candidates with a military history, with a posterior median 62% expressing favorability (95% credible interval: 59–65%). In general, Republicans are more extreme in their preferences for and against candidates with and without military service history.</span>
<span id="cb58-1897"><a href="#cb58-1897" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1898"><a href="#cb58-1898" aria-hidden="true" tabindex="-1"></a>In the right panel we can see the differences between the parties' marginal means within each level. There’s a posterior median 17 percentage point distance between Republican and Democratic marginal means within the served level and a posterior median 17 percentage point distance between their marginal means in the did not serve level (95% credible interval: 12–21 percentage points). Overall, Republicans prefer candidates with military service; Democrats prefer candidates without military service.</span>
<span id="cb58-1899"><a href="#cb58-1899" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1900"><a href="#cb58-1900" aria-hidden="true" tabindex="-1"></a><span class="in">```{r calc-bayes-party-mms}</span></span>
<span id="cb58-1901"><a href="#cb58-1901" aria-hidden="true" tabindex="-1"></a><span class="in">posterior_party_mms &lt;- predictions(</span></span>
<span id="cb58-1902"><a href="#cb58-1902" aria-hidden="true" tabindex="-1"></a><span class="in">  model_brms_military_party,</span></span>
<span id="cb58-1903"><a href="#cb58-1903" aria-hidden="true" tabindex="-1"></a><span class="in">  by = c("atmilitary", "respondent_party"),</span></span>
<span id="cb58-1904"><a href="#cb58-1904" aria-hidden="true" tabindex="-1"></a><span class="in">  allow_new_levels = TRUE</span></span>
<span id="cb58-1905"><a href="#cb58-1905" aria-hidden="true" tabindex="-1"></a><span class="in">) %&gt;% </span></span>
<span id="cb58-1906"><a href="#cb58-1906" aria-hidden="true" tabindex="-1"></a><span class="in">  posterior_draws()</span></span>
<span id="cb58-1907"><a href="#cb58-1907" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1908"><a href="#cb58-1908" aria-hidden="true" tabindex="-1"></a><span class="in">posterior_party_mms %&gt;% </span></span>
<span id="cb58-1909"><a href="#cb58-1909" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(atmilitary, respondent_party) %&gt;% </span></span>
<span id="cb58-1910"><a href="#cb58-1910" aria-hidden="true" tabindex="-1"></a><span class="in">  median_qi(draw)</span></span>
<span id="cb58-1911"><a href="#cb58-1911" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1912"><a href="#cb58-1912" aria-hidden="true" tabindex="-1"></a><span class="in">group_diffs_terms &lt;- matrix(</span></span>
<span id="cb58-1913"><a href="#cb58-1913" aria-hidden="true" tabindex="-1"></a><span class="in">  c(-1, 1, 0, 0,</span></span>
<span id="cb58-1914"><a href="#cb58-1914" aria-hidden="true" tabindex="-1"></a><span class="in">    0, 0, -1, 1),</span></span>
<span id="cb58-1915"><a href="#cb58-1915" aria-hidden="true" tabindex="-1"></a><span class="in">  ncol = 2</span></span>
<span id="cb58-1916"><a href="#cb58-1916" aria-hidden="true" tabindex="-1"></a><span class="in">) %&gt;% </span></span>
<span id="cb58-1917"><a href="#cb58-1917" aria-hidden="true" tabindex="-1"></a><span class="in">  magrittr::set_colnames(levels(candidate_fake$atmilitary))</span></span>
<span id="cb58-1918"><a href="#cb58-1918" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1919"><a href="#cb58-1919" aria-hidden="true" tabindex="-1"></a><span class="in">posterior_party_mms_diff &lt;- predictions(</span></span>
<span id="cb58-1920"><a href="#cb58-1920" aria-hidden="true" tabindex="-1"></a><span class="in">  model_brms_military_party,</span></span>
<span id="cb58-1921"><a href="#cb58-1921" aria-hidden="true" tabindex="-1"></a><span class="in">  by = c("atmilitary", "respondent_party"),</span></span>
<span id="cb58-1922"><a href="#cb58-1922" aria-hidden="true" tabindex="-1"></a><span class="in">  allow_new_levels = TRUE,</span></span>
<span id="cb58-1923"><a href="#cb58-1923" aria-hidden="true" tabindex="-1"></a><span class="in">  hypothesis = group_diffs_terms</span></span>
<span id="cb58-1924"><a href="#cb58-1924" aria-hidden="true" tabindex="-1"></a><span class="in">) %&gt;% </span></span>
<span id="cb58-1925"><a href="#cb58-1925" aria-hidden="true" tabindex="-1"></a><span class="in">  posterior_draws()</span></span>
<span id="cb58-1926"><a href="#cb58-1926" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1927"><a href="#cb58-1927" aria-hidden="true" tabindex="-1"></a><span class="in">posterior_party_mms_diff %&gt;% </span></span>
<span id="cb58-1928"><a href="#cb58-1928" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(term) %&gt;% </span></span>
<span id="cb58-1929"><a href="#cb58-1929" aria-hidden="true" tabindex="-1"></a><span class="in">  median_qi(draw)</span></span>
<span id="cb58-1930"><a href="#cb58-1930" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-1931"><a href="#cb58-1931" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1932"><a href="#cb58-1932" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-posterior-mms-party-diffs, fig.width=11, fig.height=3.5, out.width="100%"}</span></span>
<span id="cb58-1933"><a href="#cb58-1933" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb58-1934"><a href="#cb58-1934" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-summary: "Click to show the code since it's so long"</span></span>
<span id="cb58-1935"><a href="#cb58-1935" aria-hidden="true" tabindex="-1"></a><span class="in">#| column: page-right</span></span>
<span id="cb58-1936"><a href="#cb58-1936" aria-hidden="true" tabindex="-1"></a><span class="in">mm_posterior_party1 &lt;- ggplot(</span></span>
<span id="cb58-1937"><a href="#cb58-1937" aria-hidden="true" tabindex="-1"></a><span class="in">  posterior_party_mms, </span></span>
<span id="cb58-1938"><a href="#cb58-1938" aria-hidden="true" tabindex="-1"></a><span class="in">  aes(x = draw, y = atmilitary, color = respondent_party, fill = respondent_party)</span></span>
<span id="cb58-1939"><a href="#cb58-1939" aria-hidden="true" tabindex="-1"></a><span class="in">) +</span></span>
<span id="cb58-1940"><a href="#cb58-1940" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0.5) +</span></span>
<span id="cb58-1941"><a href="#cb58-1941" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye() +</span></span>
<span id="cb58-1942"><a href="#cb58-1942" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_percent()) +</span></span>
<span id="cb58-1943"><a href="#cb58-1943" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_color_manual(</span></span>
<span id="cb58-1944"><a href="#cb58-1944" aria-hidden="true" tabindex="-1"></a><span class="in">    values = parties,</span></span>
<span id="cb58-1945"><a href="#cb58-1945" aria-hidden="true" tabindex="-1"></a><span class="in">    guide = guide_legend(</span></span>
<span id="cb58-1946"><a href="#cb58-1946" aria-hidden="true" tabindex="-1"></a><span class="in">      override.aes = list(linetype = 0, fill = parties),</span></span>
<span id="cb58-1947"><a href="#cb58-1947" aria-hidden="true" tabindex="-1"></a><span class="in">      keywidth = 0.8, keyheight = 0.8)</span></span>
<span id="cb58-1948"><a href="#cb58-1948" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb58-1949"><a href="#cb58-1949" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_manual(</span></span>
<span id="cb58-1950"><a href="#cb58-1950" aria-hidden="true" tabindex="-1"></a><span class="in">    values = colorspace::lighten(parties, 0.4), </span></span>
<span id="cb58-1951"><a href="#cb58-1951" aria-hidden="true" tabindex="-1"></a><span class="in">    guide = "none"</span></span>
<span id="cb58-1952"><a href="#cb58-1952" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb58-1953"><a href="#cb58-1953" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(</span></span>
<span id="cb58-1954"><a href="#cb58-1954" aria-hidden="true" tabindex="-1"></a><span class="in">    x = "Marginal means",</span></span>
<span id="cb58-1955"><a href="#cb58-1955" aria-hidden="true" tabindex="-1"></a><span class="in">    y = NULL,</span></span>
<span id="cb58-1956"><a href="#cb58-1956" aria-hidden="true" tabindex="-1"></a><span class="in">    color = NULL,</span></span>
<span id="cb58-1957"><a href="#cb58-1957" aria-hidden="true" tabindex="-1"></a><span class="in">    title = "Posterior marginal means by respondent party"</span></span>
<span id="cb58-1958"><a href="#cb58-1958" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb58-1959"><a href="#cb58-1959" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(vars("Military")) +</span></span>
<span id="cb58-1960"><a href="#cb58-1960" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(</span></span>
<span id="cb58-1961"><a href="#cb58-1961" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.position = "bottom",</span></span>
<span id="cb58-1962"><a href="#cb58-1962" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.justification = "left",</span></span>
<span id="cb58-1963"><a href="#cb58-1963" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.margin = margin(l = -7, t = -5)</span></span>
<span id="cb58-1964"><a href="#cb58-1964" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb58-1965"><a href="#cb58-1965" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-1966"><a href="#cb58-1966" aria-hidden="true" tabindex="-1"></a><span class="in">mm_posterior_party2 &lt;- ggplot(</span></span>
<span id="cb58-1967"><a href="#cb58-1967" aria-hidden="true" tabindex="-1"></a><span class="in">  posterior_party_mms_diff,</span></span>
<span id="cb58-1968"><a href="#cb58-1968" aria-hidden="true" tabindex="-1"></a><span class="in">  aes(x = draw, y = term)</span></span>
<span id="cb58-1969"><a href="#cb58-1969" aria-hidden="true" tabindex="-1"></a><span class="in">) +</span></span>
<span id="cb58-1970"><a href="#cb58-1970" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = 0) +</span></span>
<span id="cb58-1971"><a href="#cb58-1971" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye(aes(</span></span>
<span id="cb58-1972"><a href="#cb58-1972" aria-hidden="true" tabindex="-1"></a><span class="in">    color = "Republican marginal mean − Democrat marginal mean",</span></span>
<span id="cb58-1973"><a href="#cb58-1973" aria-hidden="true" tabindex="-1"></a><span class="in">    fill = "Republican marginal mean − Democrat marginal mean"</span></span>
<span id="cb58-1974"><a href="#cb58-1974" aria-hidden="true" tabindex="-1"></a><span class="in">  )) +</span></span>
<span id="cb58-1975"><a href="#cb58-1975" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(labels = label_pp) +</span></span>
<span id="cb58-1976"><a href="#cb58-1976" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_color_manual(</span></span>
<span id="cb58-1977"><a href="#cb58-1977" aria-hidden="true" tabindex="-1"></a><span class="in">    values = "#85144b",</span></span>
<span id="cb58-1978"><a href="#cb58-1978" aria-hidden="true" tabindex="-1"></a><span class="in">    guide = guide_legend(</span></span>
<span id="cb58-1979"><a href="#cb58-1979" aria-hidden="true" tabindex="-1"></a><span class="in">      override.aes = list(linetype = 0, fill = "#85144b"),</span></span>
<span id="cb58-1980"><a href="#cb58-1980" aria-hidden="true" tabindex="-1"></a><span class="in">      keywidth = 0.8, keyheight = 0.8)</span></span>
<span id="cb58-1981"><a href="#cb58-1981" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb58-1982"><a href="#cb58-1982" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_manual(</span></span>
<span id="cb58-1983"><a href="#cb58-1983" aria-hidden="true" tabindex="-1"></a><span class="in">    values = colorspace::lighten("#85144b", 0.4), </span></span>
<span id="cb58-1984"><a href="#cb58-1984" aria-hidden="true" tabindex="-1"></a><span class="in">    guide = "none"</span></span>
<span id="cb58-1985"><a href="#cb58-1985" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb58-1986"><a href="#cb58-1986" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(</span></span>
<span id="cb58-1987"><a href="#cb58-1987" aria-hidden="true" tabindex="-1"></a><span class="in">    x = "Difference in marginal means",</span></span>
<span id="cb58-1988"><a href="#cb58-1988" aria-hidden="true" tabindex="-1"></a><span class="in">    y = NULL,</span></span>
<span id="cb58-1989"><a href="#cb58-1989" aria-hidden="true" tabindex="-1"></a><span class="in">    color = NULL,</span></span>
<span id="cb58-1990"><a href="#cb58-1990" aria-hidden="true" tabindex="-1"></a><span class="in">    title = "Difference in marginal means by respondent party",</span></span>
<span id="cb58-1991"><a href="#cb58-1991" aria-hidden="true" tabindex="-1"></a><span class="in">    subtitle = "Positive differences = Republicans prefer the level"</span></span>
<span id="cb58-1992"><a href="#cb58-1992" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb58-1993"><a href="#cb58-1993" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(vars("Military")) +</span></span>
<span id="cb58-1994"><a href="#cb58-1994" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(</span></span>
<span id="cb58-1995"><a href="#cb58-1995" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.position = "bottom",</span></span>
<span id="cb58-1996"><a href="#cb58-1996" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.justification = "left",</span></span>
<span id="cb58-1997"><a href="#cb58-1997" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.margin = margin(l = -7, t = -5)</span></span>
<span id="cb58-1998"><a href="#cb58-1998" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb58-1999"><a href="#cb58-1999" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-2000"><a href="#cb58-2000" aria-hidden="true" tabindex="-1"></a><span class="in">mm_posterior_party1 | mm_posterior_party2</span></span>
<span id="cb58-2001"><a href="#cb58-2001" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
<p><span class="faux-block"><i class="fa-brands fa-creative-commons" aria-label="creative-commons"></i> 2007–2024 Andrew Heiss</span> <span class="faux-block">All content licensed under<br><a href="https://creativecommons.org/licenses/by/4.0/"><i class="fa-brands fa-creative-commons" aria-label="creative-commons"></i> <i class="fa-brands fa-creative-commons-by" aria-label="creative-commons-by"></i> Creative Commons CC BY 4.0</a></span></p>
</div>   
    <div class="nav-footer-center">
<p><span class="faux-block"><i class="fa-brands fa-orcid" aria-label="orcid"></i> <strong>ORCID</strong> <a href="https://orcid.org/0000-0002-3948-3914">0000-0002-3948-3914</a></span> <span class="faux-block"><i class="fa-solid fa-key" aria-label="key"></i> <a href="../../../../../pgp_ath.asc.txt">PGP public key</a>   <i class="fa-solid fa-fingerprint" aria-label="fingerprint"></i> Fingerprint:<br><span class="fingerprint">4AA2 FA83 A8B2 05A4 E30F<br> 610D 1382 6216 9178 36AB</span></span></p>
</div>
    <div class="nav-footer-right">
<p><span class="faux-block">Made with <i class="fa-brands fa-r-project" aria-label="r-project"></i> and <a href="https://quarto.org/">Quarto</a></span> <span class="faux-block"><a href="https://github.com/andrewheiss/ath-quarto">View the source at <i class="fa-brands fa-github" aria-label="github"></i> GitHub</a></span></p>
</div>
  </div>
</footer>


</body></html>