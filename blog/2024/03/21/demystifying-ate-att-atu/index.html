<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Andrew Heiss">
<meta name="description" content="Explore why we care about the ATE, ATT, and ATU and figure out how to calculate them with observational data">
<title>Demystifying causal inference estimands: ATE, ATT, and ATU | Andrew Heiss – Andrew Heiss</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="../../../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../../../">
<link href="../../../../..//files/favicon-512.png" rel="icon" type="image/png">
<script src="../../../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../../../site_libs/quarto-html/quarto-syntax-highlighting-17c909d5fd25ae21b861c0c7a49b2096.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../../../site_libs/bootstrap/bootstrap-5cd0811f461c8271ae6bab49df9501be.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<link href="../../../../../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../../../../../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<script src="../../../../../site_libs/quarto-contrib/iconify-2.0.0/iconify-icon.min.js"></script><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script type="text/javascript">

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-527449-5', 'auto');

ga('send', {
  hitType: 'pageview',
  'anonymizeIp': true,
});
</script><style>

      .quarto-title-block .quarto-title-banner {
        background: #170C3A;
      }
</style>
<script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
<meta property="og:title" content="Demystifying causal inference estimands: ATE, ATT, and ATU | Andrew Heiss">
<meta property="og:description" content="Explore why we care about the ATE, ATT, and ATU and figure out how to calculate them with observational data">
<meta property="og:image" content="https://www.andrewheiss.com/blog/2024/03/21/demystifying-ate-att-atu/index_files/figure-html/fig-propensity-weighted-ate-1.png">
<meta property="og:site_name" content="Andrew Heiss">
<meta property="og:locale" content="en_US">
<meta property="og:image:height" content="1296">
<meta property="og:image:width" content="1728">
<meta name="twitter:title" content="Demystifying causal inference estimands: ATE, ATT, and ATU | Andrew Heiss">
<meta name="twitter:description" content="Explore why we care about the ATE, ATT, and ATU and figure out how to calculate them with observational data">
<meta name="twitter:image" content="https://www.andrewheiss.com/blog/2024/03/21/demystifying-ate-att-atu/index_files/figure-html/fig-propensity-weighted-ate-1.png">
<meta name="twitter:creator" content="@andrewheiss">
<meta name="twitter:site" content="@andrewheiss">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image-height" content="1296">
<meta name="twitter:image-width" content="1728">
</head>
<body class="floating nav-fixed slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../../../index.html">
    <span class="navbar-title">Andrew Heiss</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link" href="../../../../../index.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../cv/index.html"> 
<span class="menu-text">CV</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../blog/index.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../research/index.html"> 
<span class="menu-text">Research</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../teaching/index.html"> 
<span class="menu-text">Teaching</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../talks/index.html"> 
<span class="menu-text">Talks</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../now/index.html"> 
<span class="menu-text">Now</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../uses/index.html"> 
<span class="menu-text">Uses</span></a>
  </li>  
</ul>
<ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item">
    <a class="nav-link" href="../../../../../atom.xml"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:rss" style="font-size: 1.1em;" aria-label="Icon rss from bi Iconify.design set." title="RSS"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="mailto:aheiss@gsu.edu"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:envelope" style="font-size: 1.1em;" aria-label="Icon envelope from bi Iconify.design set." title="E-mail"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://bsky.app/profile/andrew.heiss.phd" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="fa6-brands:bluesky" style="font-size: 1.1em;" aria-label="Icon bluesky from fa6-brands Iconify.design set." title="Bluesky"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://fediscience.org/users/andrew/" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:mastodon" style="font-size: 1.1em;" aria-label="Icon mastodon from bi Iconify.design set." title="Mastodon"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/andrewheiss" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:github" style="font-size: 1.1em;" aria-label="Icon github from bi Iconify.design set." title="GitHub"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.youtube.com/andrewheiss" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:youtube" style="font-size: 1.1em;" aria-label="Icon youtube from bi Iconify.design set." title="YouTube"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.heissatopia.com/"> 
<span class="menu-text"><iconify-icon inline="" icon="fa6-brands:blogger" style="font-size: 1.15em;" aria-label="Icon blogger from fa6-brands Iconify.design set." title="Blogger"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.linkedin.com/in/andrewheiss" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:linkedin" style="font-size: 1.1em;" aria-label="Icon linkedin from bi Iconify.design set." title="LinkedIn"></iconify-icon></span></a>
  </li>  
</ul>
</div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><header id="title-block-header" class="quarto-title-block default blog-post page-columns page-full"><div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">Demystifying causal inference estimands: ATE, ATT, and ATU</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
                  <div>
        <div class="description">
          Explore why we care about the ATE, ATT, and ATU and figure out how to calculate them with observational data
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">r</div>
                <div class="quarto-category">tidyverse</div>
                <div class="quarto-category">causal inference</div>
                <div class="quarto-category">DAGs</div>
                <div class="quarto-category">inverse probability weighting</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p><a href="https://www.andrewheiss.com/">Andrew Heiss</a> <a href="https://orcid.org/0000-0002-3948-3914" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">Thursday, March 21, 2024</p>
      </div>
    </div>
    
      
      <div>
      <div class="quarto-title-meta-heading">Doi</div>
      <div class="quarto-title-meta-contents">
        <p class="doi">
          <a href="https://doi.org/10.59350/c9z3a-rcq16">10.59350/c9z3a-rcq16</a>
        </p>
      </div>
    </div>
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Contents</h2>
   
  <ul>
<li>
<a href="#quick-crash-course-in-potential-outcomes" id="toc-quick-crash-course-in-potential-outcomes" class="nav-link active" data-scroll-target="#quick-crash-course-in-potential-outcomes">Quick crash course in potential outcomes</a>
  <ul class="collapse">
<li><a href="#individual-level-causal-effects-ice-or-delta" id="toc-individual-level-causal-effects-ice-or-delta" class="nav-link" data-scroll-target="#individual-level-causal-effects-ice-or-delta">Individual-level causal effects (ICE or <span class="math inline">\(\delta\)</span>)</a></li>
  <li><a href="#average-treatment-effects-ate" id="toc-average-treatment-effects-ate" class="nav-link" data-scroll-target="#average-treatment-effects-ate">Average treatment effects (ATE)</a></li>
  <li><a href="#average-treatment-effect-on-the-treated-att" id="toc-average-treatment-effect-on-the-treated-att" class="nav-link" data-scroll-target="#average-treatment-effect-on-the-treated-att">Average treatment effect on the treated (ATT)</a></li>
  <li><a href="#average-treatment-effect-on-the-untreated-atu" id="toc-average-treatment-effect-on-the-untreated-atu" class="nav-link" data-scroll-target="#average-treatment-effect-on-the-untreated-atu">Average treatment effect on the untreated (ATU)</a></li>
  <li><a href="#selection-bias" id="toc-selection-bias" class="nav-link" data-scroll-target="#selection-bias">Selection bias</a></li>
  <li><a href="#finding-the-ate-from-observational-data" id="toc-finding-the-ate-from-observational-data" class="nav-link" data-scroll-target="#finding-the-ate-from-observational-data">Finding the ATE from observational data</a></li>
  </ul>
</li>
  <li><a href="#moving-beyond-the-ate" id="toc-moving-beyond-the-ate" class="nav-link" data-scroll-target="#moving-beyond-the-ate">Moving beyond the ATE</a></li>
  <li>
<a href="#plain-translations-and-true-values" id="toc-plain-translations-and-true-values" class="nav-link" data-scroll-target="#plain-translations-and-true-values">Plain translations and true values</a>
  <ul class="collapse">
<li><a href="#ate" id="toc-ate" class="nav-link" data-scroll-target="#ate">ATE</a></li>
  <li><a href="#att" id="toc-att" class="nav-link" data-scroll-target="#att">ATT</a></li>
  <li><a href="#atu" id="toc-atu" class="nav-link" data-scroll-target="#atu">ATU</a></li>
  </ul>
</li>
  <li><a href="#selection-bias-and-the-ate-att-and-atu" id="toc-selection-bias-and-the-ate-att-and-atu" class="nav-link" data-scroll-target="#selection-bias-and-the-ate-att-and-atu">Selection bias and the ATE, ATT, and ATU</a></li>
  <li>
<a href="#finding-these-estimands-with-non-potential-outcome-based-data" id="toc-finding-these-estimands-with-non-potential-outcome-based-data" class="nav-link" data-scroll-target="#finding-these-estimands-with-non-potential-outcome-based-data">Finding these estimands with non-potential-outcome-based data</a>
  <ul class="collapse">
<li><a href="#ate-1" id="toc-ate-1" class="nav-link" data-scroll-target="#ate-1">ATE</a></li>
  <li><a href="#att-1" id="toc-att-1" class="nav-link" data-scroll-target="#att-1">ATT</a></li>
  <li><a href="#atu-1" id="toc-atu-1" class="nav-link" data-scroll-target="#atu-1">ATU</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  </ul>
</li>
  <li><a href="#what-about-other-methods" id="toc-what-about-other-methods" class="nav-link" data-scroll-target="#what-about-other-methods">What about other methods?</a></li>
  </ul></nav>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content"><style>
  .no-stripe .gt_table tr.odd {
    --bs-table-striped-bg: transparent;
  }

  .gt_footnote {
    text-align: left !important;
  }
</style>
<p>In <a href="https://evalsp24.classes.andrewheiss.com/">my causal inference class</a>, I spend <a href="https://evalsp24.classes.andrewheiss.com/content/05-content.html">just one week</a> talking about the <a href="https://en.wikipedia.org/wiki/Rubin_causal_model">Rubin causal model</a> and potential outcomes. This view of causality argues that for any kind of intervention (passing a new policy, participation in a nonprofit program, taking a specific kind of medicine, etc.), people will have one of two possible outcomes:</p>
<ol type="1">
<li>What would happen if they receive the intervention or treatment, and</li>
<li>What would happen if they do not receive the treatment</li>
</ol>
<p>These two outcomes are <em>potential outcomes</em>. Both are plausible, but only one will happen in real life. These potential outcomes lead to a bunch of different causal estimands we might be interested in, like the average treatment effect.</p>
<p>I give such short shrift to potential outcomes largely because the bulk of the class approaches the idea of causal inference through Judea Pearl-style DAGs instead of potential outcomes. It’s a strange arrangement that I’ve stumbled into: the potential outcomes approach is incredibly popular and widespread in social sciences (particularly in economics), while causal models and DAGs are more popular in fields like epidemiology. For unfathomable reasons, there’s a weird animosity between these two worlds. Judea Pearl regularly needles social scientists on Twitter for not using DAGs and clinging to potential outcomes, while Nobel-winning econometricians decry DAGs. It’s weird.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<div class="no-row-height column-margin column-container"><div id="fn1"><p><sup>1</sup>&nbsp;Though <a href="https://doi.org/10.1080/1350178X.2022.2088085">this neat paper by a DAG-using economist</a> tries to bridge that gap <span class="citation" data-cites="Huntington-Klein:2022">(<a href="#ref-Huntington-Klein:2022" role="doc-biblioref">Huntington-Klein 2022</a>)</span>.</p></div></div><p>As a social scientist myself, you’d think I’d have embraced the potential outcomes approach, but for whatever reason, it never stuck and it was always confusing to me. When I came across Judea Pearl’s <em>The Book of Why</em> <span class="citation" data-cites="PearlMackenzie:2020">(<a href="#ref-PearlMackenzie:2020" role="doc-biblioref">Pearl and Mackenzie 2020</a>)</span> a few years ago, I fell in love with the world of DAGs. They made sense—far more sense than the weird decompositional algebra behind average treatment effects, average treatment on the treated effects, average treatment on the untreated effects, and so on.</p>
<p>I’m not the only social science convert to DAGs. The general social science methods textbook <a href="https://www.cambridge.org/core/books/counterfactuals-and-causal-inference/5CC81E6DF63C5E5A8B88F79D45E1D1B7"><em>Counterfactuals and Causal Inference</em></a> <span class="citation" data-cites="MorganWinship:2014">(<a href="#ref-MorganWinship:2014" role="doc-biblioref">Morgan and Winship 2014</a>)</span> started popularizing DAGs in 2007, two modern phenomenal econometrics textbooks—<a href="https://theeffectbook.net/"><em>The Effect</em></a> <span class="citation" data-cites="Huntington-Klein:2021">(<a href="#ref-Huntington-Klein:2021" role="doc-biblioref">Huntington-Klein 2021</a>)</span> and <a href="https://mixtape.scunning.com/"><em>Causal Inference: The Mixtape</em></a> <span class="citation" data-cites="Cunningham:2021">(<a href="#ref-Cunningham:2021" role="doc-biblioref">Cunningham 2021</a>)</span>—feature DAGs throughout (despite that discipline’s weird aversion to them), and the latest version of the fantastic Bayesian <a href="https://xcelab.net/rm/statistical-rethinking/"><em>Statistical Rethinking</em></a> <span class="citation" data-cites="McElreath:2020">(<a href="#ref-McElreath:2020" role="doc-biblioref">McElreath 2020</a>)</span> uses them extensively.</p>
<p>Despite all these newer DAG-based approaches in social science, in my class, I never really revisit the potential outcomes framework after that one week. We do all sorts of causal effects estimation with DAG-based adjustment through matching and inverse probability weighting, and quasi-experimental design-based approaches like difference-in-differences, regression discontinuity, and instrumental variables, but beyond emphasizing the fact that methods like regression discontinuity and instrumental variables only return <em>local</em> average treatment effects, we don’t really ever talk about ATEs and ATTs and ATUs again.</p>
<p>This has always bugged me.</p>
<p>Beyond introducing the idea that we can’t find individual-level causal effects without a time machine, thinking about potential outcomes is neat, I guess, but not exactly relevant to all the other methods we cover. <strong>I know that’s wrong!</strong> But that’s how my mental model of these estimands has worked. All these other methods give some sort of general average causal effect, but I’m never sure which exact flavor of causal effect it is (or if the exact flavor matters).</p>
<p>But <a href="https://arxiv.org/abs/2106.10577">a newer working paper</a> by <span class="citation" data-cites="GreiferStuart:2023">Greifer and Stuart (<a href="#ref-GreiferStuart:2023" role="doc-biblioref">2023</a>)</span> has finally helped me realize why these different estimands matter and what the subtle differences between them are.</p>
<p>So in this post, I’ll extend the basic standard ATE/ATT/ATU example to reflect a more realistic, larger dataset, and I’ll use propensity score weighting to estimate each estimand. I’ll also follow Greifer and Stuart’s example and translate these estimands into policy-relevant English equivalents (they use medical terminology; I’m not that kind of doctor and I work with social science and policy interventions).</p>
<p>But first, I <em>highly</em> recommend <a href="https://arxiv.org/abs/2106.10577">reading through their paper really quick</a>. It’s not too long and and it’s not too mathy—it’s succinct and accessible and a good primer for all these estimands.</p>
<p>(And before we start, let’s load some R packages.)</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://wilkelab.org/ggtext/">ggtext</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-causal/ggdag">ggdag</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://www.dagitty.net">dagitty</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://gt.rstudio.com">gt</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://broom.tidymodels.org/">broom</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://marginaleffects.com/">marginaleffects</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ngreifer.github.io/WeightIt/">WeightIt</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define a nice color palette from {MoMAColors}</span></span>
<span><span class="co"># https://github.com/BlakeRMills/MoMAColors</span></span>
<span><span class="va">clrs</span> <span class="op">&lt;-</span> <span class="fu">MoMAColors</span><span class="fu">::</span><span class="fu">moma.colors</span><span class="op">(</span><span class="st">"ustwo"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Download Mulish from https://fonts.google.com/specimen/Mulish</span></span>
<span><span class="va">theme_nice</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span>base_family <span class="op">=</span> <span class="st">"Mulish"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">theme</span><span class="op">(</span></span>
<span>      panel.grid.minor <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>      plot.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"white"</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>,</span>
<span>      plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>      axis.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>      strip.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>      strip.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"grey80"</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>,</span>
<span>      legend.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">theme_set</span><span class="op">(</span><span class="fu">theme_nice</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">update_geom_defaults</span><span class="op">(</span><span class="st">"text"</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Mulish"</span>, fontface <span class="op">=</span> <span class="st">"plain"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">update_geom_defaults</span><span class="op">(</span><span class="st">"label"</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Mulish"</span>, fontface <span class="op">=</span> <span class="st">"plain"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">update_geom_defaults</span><span class="op">(</span><span class="fu">ggdag</span><span class="fu">:::</span><span class="va">GeomDagText</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Mulish"</span>, fontface <span class="op">=</span> <span class="st">"plain"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">update_geom_defaults</span><span class="op">(</span><span class="fu">ggtext</span><span class="fu">::</span><span class="va">GeomRichText</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Mulish"</span>, fontface <span class="op">=</span> <span class="st">"plain"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="quick-crash-course-in-potential-outcomes" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="quick-crash-course-in-potential-outcomes">Quick crash course in potential outcomes</h2>
<p>Before getting into the subtle differences between the various potential outcomes-related estimands, it’s helpful to get a general sense for how these things work. So let’s take a super abbreviated crash course in the potential outcomes framework.</p>
<p>Every causal inference textbook ever written will include a table like <a href="#tbl-basic-po" class="quarto-xref">Table&nbsp;1</a> to illustrate potential outcomes. To make this idea a little more mathy, we’ll call the treatment or intervention <span class="math inline">\(X\)</span>, the outcome that would happen if treated <span class="math inline">\(Y^1\)</span>, and the outcome that would happen if not treated <span class="math inline">\(Y^0\)</span>.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> We’ll use <span class="math inline">\(\delta\)</span> for the difference between <span class="math inline">\(Y^1\)</span> and <span class="math inline">\(Y^0\)</span>, or the individual-level causal effect.</p>
<div class="no-row-height column-margin column-container"><div id="fn2"><p><sup>2</sup>&nbsp;The notation for all this varies wildly across disciplines. Economists call the treatment <span class="math inline">\(D\)</span> for mysterious reasons; epidemiologists will often call it <span class="math inline">\(A\)</span>; I’ve seen political science papers call it <span class="math inline">\(T\)</span> (which at least makes more sense than <span class="math inline">\(D\)</span> or <span class="math inline">\(A\)</span>, since “treatment” starts with T). In my class I call it <span class="math inline">\(X\)</span>, which follows what a lot of other people do (like this guide to <a href="https://egap.org/resource/10-strategies-for-figuring-out-if-x-caused-y/">“10 Strategies for Figuring Out if X Caused Y”</a>).</p></div></div><div class="cell no-stripe" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">basic_po</span> <span class="op">&lt;-</span> <span class="fu">tribble</span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">id</span>, <span class="op">~</span><span class="va">age</span>,    <span class="op">~</span><span class="va">treated</span>, <span class="op">~</span><span class="va">outcome_1</span>, <span class="op">~</span><span class="va">outcome_0</span>,</span>
<span>  <span class="fl">1</span>,   <span class="st">"Old"</span>,   <span class="fl">1</span>,        <span class="fl">80</span>,         <span class="fl">60</span>,</span>
<span>  <span class="fl">2</span>,   <span class="st">"Old"</span>,   <span class="fl">1</span>,        <span class="fl">75</span>,         <span class="fl">70</span>,</span>
<span>  <span class="fl">3</span>,   <span class="st">"Old"</span>,   <span class="fl">1</span>,        <span class="fl">85</span>,         <span class="fl">80</span>,</span>
<span>  <span class="fl">4</span>,   <span class="st">"Old"</span>,   <span class="fl">0</span>,        <span class="fl">70</span>,         <span class="fl">60</span>,</span>
<span>  <span class="fl">5</span>,   <span class="st">"Young"</span>, <span class="fl">1</span>,        <span class="fl">75</span>,         <span class="fl">70</span>,</span>
<span>  <span class="fl">6</span>,   <span class="st">"Young"</span>, <span class="fl">0</span>,        <span class="fl">80</span>,         <span class="fl">80</span>,</span>
<span>  <span class="fl">7</span>,   <span class="st">"Young"</span>, <span class="fl">0</span>,        <span class="fl">90</span>,         <span class="fl">100</span>,</span>
<span>  <span class="fl">8</span>,   <span class="st">"Young"</span>, <span class="fl">0</span>,        <span class="fl">85</span>,         <span class="fl">80</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    ice <span class="op">=</span> <span class="va">outcome_1</span> <span class="op">-</span> <span class="va">outcome_0</span>,</span>
<span>    outcome <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">treated</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">outcome_1</span>, <span class="va">outcome_0</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">basic_po</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span></span>
<span>    <span class="va">id</span>, <span class="va">age</span>, <span class="va">treated</span>, <span class="va">outcome_1</span>, <span class="va">outcome_0</span>, <span class="va">ice</span>, <span class="va">outcome</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">gt</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">sub_missing</span><span class="op">(</span>missing_text <span class="op">=</span> <span class="st">"…"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">fmt_number</span><span class="op">(</span></span>
<span>    columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu">starts_with</span><span class="op">(</span><span class="st">"outcome"</span><span class="op">)</span>, <span class="va">ice</span><span class="op">)</span>,</span>
<span>    decimals <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span></span>
<span>  <span class="co"># Column labels</span></span>
<span>  <span class="fu">cols_label</span><span class="op">(</span></span>
<span>    id <span class="op">=</span> <span class="st">"ID"</span>,</span>
<span>    age <span class="op">=</span> <span class="fu">md</span><span class="op">(</span><span class="st">"$Z_i$"</span><span class="op">)</span>,</span>
<span>    treated <span class="op">=</span> <span class="fu">md</span><span class="op">(</span><span class="st">"$X_i$"</span><span class="op">)</span>,</span>
<span>    outcome_0 <span class="op">=</span> <span class="fu">md</span><span class="op">(</span><span class="st">"$Y^0_i$"</span><span class="op">)</span>,</span>
<span>    outcome_1 <span class="op">=</span> <span class="fu">md</span><span class="op">(</span><span class="st">"$Y^1_i$"</span><span class="op">)</span>,</span>
<span>    outcome <span class="op">=</span> <span class="fu">md</span><span class="op">(</span><span class="st">"$Y_i$"</span><span class="op">)</span>,</span>
<span>    ice <span class="op">=</span> <span class="fu">md</span><span class="op">(</span><span class="st">"$Y^1_i - Y^0_i$"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  </span>
<span>  <span class="co"># Level 1 spanner labels</span></span>
<span>  <span class="fu">tab_spanner</span><span class="op">(</span></span>
<span>    label <span class="op">=</span> <span class="st">"Age"</span>, columns <span class="op">=</span> <span class="va">age</span>, </span>
<span>    level <span class="op">=</span> <span class="fl">1</span>, id <span class="op">=</span> <span class="st">"level1_a_po"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tab_spanner</span><span class="op">(</span></span>
<span>    label <span class="op">=</span> <span class="st">"Treated"</span>, columns <span class="op">=</span> <span class="va">treated</span>, </span>
<span>    level <span class="op">=</span> <span class="fl">1</span>, id <span class="op">=</span> <span class="st">"level1_b_po"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tab_spanner</span><span class="op">(</span></span>
<span>    label <span class="op">=</span> <span class="st">"Potential outcomes"</span>,</span>
<span>    columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">outcome_1</span>, <span class="va">outcome_0</span><span class="op">)</span>,</span>
<span>    level <span class="op">=</span> <span class="fl">1</span>, id <span class="op">=</span> <span class="st">"level1_c_po"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tab_spanner</span><span class="op">(</span></span>
<span>    label <span class="op">=</span> <span class="st">"ICE or \\(\\delta_i\\)"</span>, columns <span class="op">=</span> <span class="va">ice</span>, </span>
<span>    level <span class="op">=</span> <span class="fl">1</span>, id <span class="op">=</span> <span class="st">"level1_d_po"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tab_spanner</span><span class="op">(</span></span>
<span>    label <span class="op">=</span> <span class="st">"Outcome"</span>, columns <span class="op">=</span> <span class="va">outcome</span>, </span>
<span>    level <span class="op">=</span> <span class="fl">1</span>, id <span class="op">=</span> <span class="st">"level1_e_po"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  </span>
<span>  <span class="co"># Level 2 spanner labels</span></span>
<span>  <span class="fu">tab_spanner</span><span class="op">(</span></span>
<span>    label <span class="op">=</span> <span class="st">"Confounder"</span>,</span>
<span>    columns <span class="op">=</span> <span class="va">age</span>,</span>
<span>    level <span class="op">=</span> <span class="fl">2</span>, id <span class="op">=</span> <span class="st">"level2_a_po"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tab_spanner</span><span class="op">(</span></span>
<span>    label <span class="op">=</span> <span class="st">"Treatment"</span>, columns <span class="op">=</span> <span class="va">treated</span>, </span>
<span>    level <span class="op">=</span> <span class="fl">2</span>, id <span class="op">=</span> <span class="st">"level2_b_po"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tab_spanner</span><span class="op">(</span></span>
<span>    label <span class="op">=</span> <span class="st">"Unobservable"</span>,</span>
<span>    columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">outcome_1</span>, <span class="va">outcome_0</span>, <span class="va">ice</span><span class="op">)</span>, </span>
<span>    level <span class="op">=</span> <span class="fl">2</span>, id <span class="op">=</span> <span class="st">"level2_c_po"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tab_spanner</span><span class="op">(</span></span>
<span>    label <span class="op">=</span> <span class="st">"Realized"</span>, columns <span class="op">=</span> <span class="va">outcome</span>, </span>
<span>    level <span class="op">=</span> <span class="fl">2</span>, id <span class="op">=</span> <span class="st">"level2_d_po"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  </span>
<span>  <span class="co"># Style stuff</span></span>
<span>  <span class="fu">tab_style</span><span class="op">(</span></span>
<span>    style <span class="op">=</span> <span class="fu">cell_text</span><span class="op">(</span>align <span class="op">=</span> <span class="st">"center"</span><span class="op">)</span>,</span>
<span>    locations <span class="op">=</span> <span class="fu">cells_column_labels</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tab_style</span><span class="op">(</span></span>
<span>    style <span class="op">=</span> <span class="fu">cell_text</span><span class="op">(</span>align <span class="op">=</span> <span class="st">"center"</span><span class="op">)</span>,</span>
<span>    locations <span class="op">=</span> <span class="fu">cells_body</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tab_style</span><span class="op">(</span></span>
<span>    style <span class="op">=</span> <span class="fu">cell_text</span><span class="op">(</span>weight <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>    locations <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>      <span class="fu">cells_column_spanners</span><span class="op">(</span>spanners <span class="op">=</span> <span class="fu">starts_with</span><span class="op">(</span><span class="st">"level1"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      <span class="fu">cells_column_labels</span><span class="op">(</span>columns <span class="op">=</span> <span class="st">"id"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tab_style</span><span class="op">(</span></span>
<span>    style <span class="op">=</span> <span class="fu">cell_text</span><span class="op">(</span>style <span class="op">=</span> <span class="st">"italic"</span><span class="op">)</span>,</span>
<span>    locations <span class="op">=</span> <span class="fu">cells_column_spanners</span><span class="op">(</span>spanners <span class="op">=</span> <span class="fu">starts_with</span><span class="op">(</span><span class="st">"level2"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  </span>
<span>  <span class="fu">tab_style</span><span class="op">(</span></span>
<span>    style <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>      <span class="fu">cell_fill</span><span class="op">(</span>color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    locations <span class="op">=</span> <span class="fu">cells_body</span><span class="op">(</span>rows <span class="op">=</span> <span class="va">treated</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tab_footnote</span><span class="op">(</span></span>
<span>    footnote <span class="op">=</span> <span class="st">"ICE = individual causal effect"</span>,</span>
<span>    locations <span class="op">=</span> <span class="fu">cells_column_spanners</span><span class="op">(</span>spanners <span class="op">=</span> <span class="st">"level1_d_po"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">opt_footnote_marks</span><span class="op">(</span>marks <span class="op">=</span> <span class="st">"standard"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">opt_horizontal_padding</span><span class="op">(</span>scale <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">opt_table_font</span><span class="op">(</span>font <span class="op">=</span> <span class="st">"Jost"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div id="tbl-basic-po" class="cell no-stripe quarto-float quarto-figure quarto-figure-center anchored" data-layout-align="center">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-basic-po-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: Standard table showing potential outcomes, individual causal effects, and realized outcomes
</figcaption><div aria-describedby="tbl-basic-po-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<div id="hoomgmmiqp" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#hoomgmmiqp table {
  font-family: Jost, system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#hoomgmmiqp thead, #hoomgmmiqp tbody, #hoomgmmiqp tfoot, #hoomgmmiqp tr, #hoomgmmiqp td, #hoomgmmiqp th {
  border-style: none;
}

#hoomgmmiqp p {
  margin: 0;
  padding: 0;
}

#hoomgmmiqp .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#hoomgmmiqp .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#hoomgmmiqp .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 15px;
  padding-right: 15px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#hoomgmmiqp .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 15px;
  padding-right: 15px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#hoomgmmiqp .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#hoomgmmiqp .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#hoomgmmiqp .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#hoomgmmiqp .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 15px;
  padding-right: 15px;
  overflow-x: hidden;
}

#hoomgmmiqp .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#hoomgmmiqp .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#hoomgmmiqp .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#hoomgmmiqp .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#hoomgmmiqp .gt_spanner_row {
  border-bottom-style: hidden;
}

#hoomgmmiqp .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#hoomgmmiqp .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#hoomgmmiqp .gt_from_md > :first-child {
  margin-top: 0;
}

#hoomgmmiqp .gt_from_md > :last-child {
  margin-bottom: 0;
}

#hoomgmmiqp .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#hoomgmmiqp .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 15px;
  padding-right: 15px;
}

#hoomgmmiqp .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 15px;
  padding-right: 15px;
  vertical-align: top;
}

#hoomgmmiqp .gt_row_group_first td {
  border-top-width: 2px;
}

#hoomgmmiqp .gt_row_group_first th {
  border-top-width: 2px;
}

#hoomgmmiqp .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
}

#hoomgmmiqp .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#hoomgmmiqp .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#hoomgmmiqp .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#hoomgmmiqp .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
}

#hoomgmmiqp .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#hoomgmmiqp .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#hoomgmmiqp .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#hoomgmmiqp .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#hoomgmmiqp .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#hoomgmmiqp .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 15px;
  padding-right: 15px;
}

#hoomgmmiqp .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#hoomgmmiqp .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 15px;
  padding-right: 15px;
}

#hoomgmmiqp .gt_left {
  text-align: left;
}

#hoomgmmiqp .gt_center {
  text-align: center;
}

#hoomgmmiqp .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#hoomgmmiqp .gt_font_normal {
  font-weight: normal;
}

#hoomgmmiqp .gt_font_bold {
  font-weight: bold;
}

#hoomgmmiqp .gt_font_italic {
  font-style: italic;
}

#hoomgmmiqp .gt_super {
  font-size: 65%;
}

#hoomgmmiqp .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#hoomgmmiqp .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#hoomgmmiqp .gt_indent_1 {
  text-indent: 5px;
}

#hoomgmmiqp .gt_indent_2 {
  text-indent: 10px;
}

#hoomgmmiqp .gt_indent_3 {
  text-indent: 15px;
}

#hoomgmmiqp .gt_indent_4 {
  text-indent: 20px;
}

#hoomgmmiqp .gt_indent_5 {
  text-indent: 25px;
}

#hoomgmmiqp .katex-display {
  display: inline-flex !important;
  margin-bottom: 0.75em !important;
}
</style>
<table class="gt_table do-not-create-environment cell no-stripe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<colgroup>
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
</colgroup>
<thead>
<tr class="gt_col_headings gt_spanner_row header">
<th class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" style="text-align: center; font-style: italic; font-style: italic; font-style: italic; font-style: italic;" scope="col"></th>
<th id="Confounder" class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" style="text-align: center; font-style: italic; font-style: italic; font-style: italic; font-style: italic;" scope="col"><span class="gt_column_spanner">Confounder</span></th>
<th id="Treatment" class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" style="text-align: center; font-style: italic; font-style: italic; font-style: italic; font-style: italic;" scope="col"><span class="gt_column_spanner">Treatment</span></th>
<th colspan="3" id="Unobservable" class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" style="text-align: center; font-style: italic; font-style: italic; font-style: italic; font-style: italic;" scope="colgroup"><span class="gt_column_spanner">Unobservable</span></th>
<th id="Realized" class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" style="text-align: center; font-style: italic; font-style: italic; font-style: italic; font-style: italic;" scope="col"><span class="gt_column_spanner">Realized</span></th>
</tr>
<tr class="gt_col_headings gt_spanner_row even">
<th rowspan="2" id="ID" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;" scope="col">ID</th>
<th id="Age" class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;" scope="col"><span class="gt_column_spanner">Age</span></th>
<th id="Treated" class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;" scope="col"><span class="gt_column_spanner">Treated</span></th>
<th colspan="2" id="Potential outcomes" class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;" scope="colgroup"><span class="gt_column_spanner">Potential outcomes</span></th>
<th id="ICE or \(\delta_i\)<span class=&quot;gt_footnote_marks gt_asterisk&quot; style=&quot;white-space:nowrap;font-style:italic;font-weight:normal;&quot;><sup>*</sup></span>" class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;" scope="col"><span class="gt_column_spanner">ICE or \(\delta_i\)<span class="gt_footnote_marks gt_asterisk" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>*</sup></span></span></th>
<th id="Outcome" class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;" scope="col"><span class="gt_column_spanner">Outcome</span></th>
</tr>
<tr class="gt_col_headings header">
<th id="<div data-qmd=&quot;$Z_i$&quot;><div class='gt_from_md'><p>\(Z_i\)</p>
</div></div>" class="gt_col_heading gt_columns_bottom_border gt_left" style="text-align: center;" data-quarto-table-cell-role="th" scope="col"><p><span class="math inline">\(Z_i\)</span></p></th>
<th id="<div data-qmd=&quot;$X_i$&quot;><div class='gt_from_md'><p>\(X_i\)</p>
</div></div>" class="gt_col_heading gt_columns_bottom_border gt_right" style="text-align: center;" data-quarto-table-cell-role="th" scope="col"><p><span class="math inline">\(X_i\)</span></p></th>
<th id="<div data-qmd=&quot;$Y^1_i$&quot;><div class='gt_from_md'><p>\(Y^1_i\)</p>
</div></div>" class="gt_col_heading gt_columns_bottom_border gt_right" style="text-align: center;" data-quarto-table-cell-role="th" scope="col"><p><span class="math inline">\(Y^1_i\)</span></p></th>
<th id="<div data-qmd=&quot;$Y^0_i$&quot;><div class='gt_from_md'><p>\(Y^0_i\)</p>
</div></div>" class="gt_col_heading gt_columns_bottom_border gt_right" style="text-align: center;" data-quarto-table-cell-role="th" scope="col"><p><span class="math inline">\(Y^0_i\)</span></p></th>
<th id="<div data-qmd=&quot;$Y^1_i - Y^0_i$&quot;><div class='gt_from_md'><p>\(Y^1_i - Y^0_i\)</p>
</div></div>" class="gt_col_heading gt_columns_bottom_border gt_right" style="text-align: center;" data-quarto-table-cell-role="th" scope="col"><p><span class="math inline">\(Y^1_i - Y^0_i\)</span></p></th>
<th id="<div data-qmd=&quot;$Y_i$&quot;><div class='gt_from_md'><p>\(Y_i\)</p>
</div></div>" class="gt_col_heading gt_columns_bottom_border gt_right" style="text-align: center;" data-quarto-table-cell-role="th" scope="col"><p><span class="math inline">\(Y_i\)</span></p></th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_right" headers="id" style="text-align: center; background-color: rgba(255,204,61,0.5);">1</td>
<td class="gt_row gt_left" headers="age" style="text-align: center; background-color: rgba(255,204,61,0.5);">Old</td>
<td class="gt_row gt_right" headers="treated" style="text-align: center; background-color: rgba(255,204,61,0.5);">1</td>
<td class="gt_row gt_right" headers="outcome_1" style="text-align: center; background-color: rgba(255,204,61,0.5);">80</td>
<td class="gt_row gt_right" headers="outcome_0" style="text-align: center; background-color: rgba(255,204,61,0.5);">60</td>
<td class="gt_row gt_right" headers="ice" style="text-align: center; background-color: rgba(255,204,61,0.5);">20</td>
<td class="gt_row gt_right" headers="outcome" style="text-align: center; background-color: rgba(255,204,61,0.5);">80</td>
</tr>
<tr class="even">
<td class="gt_row gt_right" headers="id" style="text-align: center; background-color: rgba(255,204,61,0.5);">2</td>
<td class="gt_row gt_left" headers="age" style="text-align: center; background-color: rgba(255,204,61,0.5);">Old</td>
<td class="gt_row gt_right" headers="treated" style="text-align: center; background-color: rgba(255,204,61,0.5);">1</td>
<td class="gt_row gt_right" headers="outcome_1" style="text-align: center; background-color: rgba(255,204,61,0.5);">75</td>
<td class="gt_row gt_right" headers="outcome_0" style="text-align: center; background-color: rgba(255,204,61,0.5);">70</td>
<td class="gt_row gt_right" headers="ice" style="text-align: center; background-color: rgba(255,204,61,0.5);">5</td>
<td class="gt_row gt_right" headers="outcome" style="text-align: center; background-color: rgba(255,204,61,0.5);">75</td>
</tr>
<tr class="odd">
<td class="gt_row gt_right" headers="id" style="text-align: center; background-color: rgba(255,204,61,0.5);">3</td>
<td class="gt_row gt_left" headers="age" style="text-align: center; background-color: rgba(255,204,61,0.5);">Old</td>
<td class="gt_row gt_right" headers="treated" style="text-align: center; background-color: rgba(255,204,61,0.5);">1</td>
<td class="gt_row gt_right" headers="outcome_1" style="text-align: center; background-color: rgba(255,204,61,0.5);">85</td>
<td class="gt_row gt_right" headers="outcome_0" style="text-align: center; background-color: rgba(255,204,61,0.5);">80</td>
<td class="gt_row gt_right" headers="ice" style="text-align: center; background-color: rgba(255,204,61,0.5);">5</td>
<td class="gt_row gt_right" headers="outcome" style="text-align: center; background-color: rgba(255,204,61,0.5);">85</td>
</tr>
<tr class="even">
<td class="gt_row gt_right" style="text-align: center;" headers="id">4</td>
<td class="gt_row gt_left" style="text-align: center;" headers="age">Old</td>
<td class="gt_row gt_right" style="text-align: center;" headers="treated">0</td>
<td class="gt_row gt_right" style="text-align: center;" headers="outcome_1">70</td>
<td class="gt_row gt_right" style="text-align: center;" headers="outcome_0">60</td>
<td class="gt_row gt_right" style="text-align: center;" headers="ice">10</td>
<td class="gt_row gt_right" style="text-align: center;" headers="outcome">60</td>
</tr>
<tr class="odd">
<td class="gt_row gt_right" headers="id" style="text-align: center; background-color: rgba(255,204,61,0.5);">5</td>
<td class="gt_row gt_left" headers="age" style="text-align: center; background-color: rgba(255,204,61,0.5);">Young</td>
<td class="gt_row gt_right" headers="treated" style="text-align: center; background-color: rgba(255,204,61,0.5);">1</td>
<td class="gt_row gt_right" headers="outcome_1" style="text-align: center; background-color: rgba(255,204,61,0.5);">75</td>
<td class="gt_row gt_right" headers="outcome_0" style="text-align: center; background-color: rgba(255,204,61,0.5);">70</td>
<td class="gt_row gt_right" headers="ice" style="text-align: center; background-color: rgba(255,204,61,0.5);">5</td>
<td class="gt_row gt_right" headers="outcome" style="text-align: center; background-color: rgba(255,204,61,0.5);">75</td>
</tr>
<tr class="even">
<td class="gt_row gt_right" style="text-align: center;" headers="id">6</td>
<td class="gt_row gt_left" style="text-align: center;" headers="age">Young</td>
<td class="gt_row gt_right" style="text-align: center;" headers="treated">0</td>
<td class="gt_row gt_right" style="text-align: center;" headers="outcome_1">80</td>
<td class="gt_row gt_right" style="text-align: center;" headers="outcome_0">80</td>
<td class="gt_row gt_right" style="text-align: center;" headers="ice">0</td>
<td class="gt_row gt_right" style="text-align: center;" headers="outcome">80</td>
</tr>
<tr class="odd">
<td class="gt_row gt_right" style="text-align: center;" headers="id">7</td>
<td class="gt_row gt_left" style="text-align: center;" headers="age">Young</td>
<td class="gt_row gt_right" style="text-align: center;" headers="treated">0</td>
<td class="gt_row gt_right" style="text-align: center;" headers="outcome_1">90</td>
<td class="gt_row gt_right" style="text-align: center;" headers="outcome_0">100</td>
<td class="gt_row gt_right" style="text-align: center;" headers="ice">−10</td>
<td class="gt_row gt_right" style="text-align: center;" headers="outcome">100</td>
</tr>
<tr class="even">
<td class="gt_row gt_right" style="text-align: center;" headers="id">8</td>
<td class="gt_row gt_left" style="text-align: center;" headers="age">Young</td>
<td class="gt_row gt_right" style="text-align: center;" headers="treated">0</td>
<td class="gt_row gt_right" style="text-align: center;" headers="outcome_1">85</td>
<td class="gt_row gt_right" style="text-align: center;" headers="outcome_0">80</td>
<td class="gt_row gt_right" style="text-align: center;" headers="ice">5</td>
<td class="gt_row gt_right" style="text-align: center;" headers="outcome">80</td>
</tr>
</tbody>
<tfoot class="gt_footnotes"><tr class="odd">
<td colspan="7" class="gt_footnote" style="text-align: center;">
<span class="gt_footnote_marks gt_asterisk" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>*</sup></span> ICE = individual causal effect</td>
</tr></tfoot>
</table>
</div>
</div>
</div>
</figure>
</div>
</div>
<section id="individual-level-causal-effects-ice-or-delta" class="level3"><h3 class="anchored" data-anchor-id="individual-level-causal-effects-ice-or-delta">Individual-level causal effects (ICE or <span class="math inline">\(\delta\)</span>)</h3>
<p>Each person in <a href="#tbl-basic-po" class="quarto-xref">Table&nbsp;1</a> has two potential outcomes. Person 1, for instance, would have an outcome of 80 (<span class="math inline">\(Y^1\)</span>) if they receive the treatment <span class="math inline">\(X\)</span>, but only an outcome of 60 (<span class="math inline">\(Y^0\)</span>) if they don’t. Their <em>individual-level causal effect</em> (<span class="math inline">\(\delta\)</span>) is 20. This represents the effect of the treatment for just that one person, and it’s only measurable with a time machine or some way to observe parallel universes.</p>
</section><section id="average-treatment-effects-ate" class="level3"><h3 class="anchored" data-anchor-id="average-treatment-effects-ate">Average treatment effects (ATE)</h3>
<p>If we could compare all these people in Universe A and Universe B and measure their individual causal effects, we could calculate the <em>average treatment effect</em> (ATE), or the effect of the intervention across the whole population. Officially, the ATE is the average of the <span class="math inline">\(\delta\)</span> column, or the average of <span class="math inline">\(Y^1 - Y^0\)</span>:</p>
<p><span class="math display">\[
\begin{aligned}
\text{ATE} &amp;= E[\delta_i] &amp; \text{ or} \\
\text{ATE} &amp;= E[Y^1_i - Y^0_i]
\end{aligned}
\]</span></p>
<p>Given the data in <a href="#tbl-basic-po" class="quarto-xref">Table&nbsp;1</a>, the ATE is 5—it’s the average of the <span class="math inline">\(\delta\)</span> column:</p>
<p><span class="math display">\[
\text{ATE} = \frac{20 + 5 + 5 + 5 + 10 + 0 + -10 + 5}{8} = 5
\]</span></p>
<p>Neat.</p>
</section><section id="average-treatment-effect-on-the-treated-att" class="level3"><h3 class="anchored" data-anchor-id="average-treatment-effect-on-the-treated-att">Average treatment effect on the treated (ATT)</h3>
<p>There are a couple other causal effects we can measure. We might want to know how big the effect is just for those who received the treatment. This is called the <em>average treatment effect on the treated</em> (ATT), and is the average of the individual causal effects just among those who were treated. Officially, it’s defined like this:</p>
<p><span class="math display">\[
\begin{aligned}
\text{ATT} &amp;= E[\delta_i \mid X_i = 1] &amp; \text{or} \\
\text{ATT} &amp;= E[Y^1_i - Y^0_i \mid X_i = 1]
\end{aligned}
\]</span></p>
<p>In this case, that means we’re only looking at the average <span class="math inline">\(\delta\)</span> for rows 1, 2, 3, and 5 in <a href="#tbl-basic-po" class="quarto-xref">Table&nbsp;1</a>:</p>
<p><span class="math display">\[
\text{ATT} = \frac{20 + 5 + 5 + 5}{4} = 8.75
\]</span></p>
</section><section id="average-treatment-effect-on-the-untreated-atu" class="level3"><h3 class="anchored" data-anchor-id="average-treatment-effect-on-the-untreated-atu">Average treatment effect on the untreated (ATU)</h3>
<p>We can also calculate the <em>average treatment effect on the untreated</em> (ATU; sometimes called the ATC (for effect on the control group)) by finding the average of the individual causal effects among those who were not treated:</p>
<p><span class="math display">\[
\begin{aligned}
\text{ATU} &amp;= E[\delta_i \mid X_i = 0] &amp; \text{or} \\
\text{ATU} &amp;= E[Y^1_i - Y^0_i \mid X_i = 0]
\end{aligned}
\]</span></p>
<p>Here, we’re only looking at the average <span class="math inline">\(\delta\)</span> for rows 4, 6, 7, and 8 in <a href="#tbl-basic-po" class="quarto-xref">Table&nbsp;1</a>:</p>
<p><span class="math display">\[
\text{ATU} = \frac{10 + 0 - 10 + 5}{4} = 1.25
\]</span></p>
</section><section id="selection-bias" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="selection-bias">Selection bias</h3>
<p>There’s a neat relationship between the ATE, ATT, and ATU—the ATE is technically a weighted average of the ATT added to the weighted average of the ATU (here <span class="math inline">\(\pi\)</span> means “proportion”, not 3.1415):</p>
<p><span class="math display">\[
\text{ATE} = (\pi_\text{Treated} \times \text{ATT}) + (\pi_\text{Untreated} \times \text{ATU})
\]</span></p>
<p>Applying this to <a href="#tbl-basic-po" class="quarto-xref">Table&nbsp;1</a>, we can get the same ATE:</p>
<p><span class="math display">\[
\begin{aligned}
\text{ATE} &amp;= (\frac{4}{8} \times 8.75) + (\frac{4}{8} \times 1.25) \\
&amp;= 4.375 + 0.625 \\
&amp;= 5
\end{aligned}
\]</span></p>
<p>One reason it’s helpful to decompose the ATE into these two parts like this is that it shows that there’s some systematic difference between the treated and untreated people. This difference is called <em>selection bias</em>. People who chose to be treated did so for reasons known only to them.<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></p>
<div class="no-row-height column-margin column-container"><div id="fn3"><p><sup>3</sup>&nbsp;Not only do we need a time machine for good causal inference, we also need a machine that can read minds.</p></div></div><p>We can see the selection bias in an alternative decomposition of the ATE:</p>
<p><span class="math display">\[
\text{ATE} = \text{ATT} + \text{Selection bias}
\]</span></p>
<p>The fact that the ATT (8.75) is bigger than the ATE (5) here is a sign the two groups are different. This intervention, whatever it is, has a big effect on the treated people who signed up for it, likely because they somehow knew that the intervention would be helpful for them. Those who were untreated have a really low ATU (1.25)—they likely didn’t sign up for the intervention because they knew that it wouldn’t do much for them.</p>
</section><section id="finding-the-ate-from-observational-data" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="finding-the-ate-from-observational-data">Finding the ATE from observational data</h3>
<p>This is all well and good, but we don’t have time machines. This is the <em>fundamental problem of causal inference</em>—we have no idea what each person’s <span class="math inline">\(\delta\)</span> is. We actually only see this in real life:</p>
<div class="cell no-stripe" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">basic_po</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span></span>
<span>    <span class="va">id</span>, <span class="va">age</span>, <span class="va">treated</span>, <span class="va">outcome</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">gt</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">fmt_number</span><span class="op">(</span></span>
<span>    columns <span class="op">=</span> <span class="st">"outcome"</span>,</span>
<span>    decimals <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span></span>
<span>  <span class="co"># Column labels</span></span>
<span>  <span class="fu">cols_label</span><span class="op">(</span></span>
<span>    id <span class="op">=</span> <span class="st">"ID"</span>,</span>
<span>    age <span class="op">=</span> <span class="fu">md</span><span class="op">(</span><span class="st">"$Z_i$"</span><span class="op">)</span>,</span>
<span>    treated <span class="op">=</span> <span class="fu">md</span><span class="op">(</span><span class="st">"$X_i$"</span><span class="op">)</span>,</span>
<span>    outcome <span class="op">=</span> <span class="fu">md</span><span class="op">(</span><span class="st">"$Y_i$"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  </span>
<span>  <span class="co"># Level 1 spanner labels</span></span>
<span>  <span class="fu">tab_spanner</span><span class="op">(</span></span>
<span>    label <span class="op">=</span> <span class="st">"Age"</span>, columns <span class="op">=</span> <span class="va">age</span>, </span>
<span>    level <span class="op">=</span> <span class="fl">1</span>, id <span class="op">=</span> <span class="st">"level1_a_po_obs"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tab_spanner</span><span class="op">(</span></span>
<span>    label <span class="op">=</span> <span class="st">"Treated"</span>, columns <span class="op">=</span> <span class="va">treated</span>, </span>
<span>    level <span class="op">=</span> <span class="fl">1</span>, id <span class="op">=</span> <span class="st">"level1_b_po_obs"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tab_spanner</span><span class="op">(</span></span>
<span>    label <span class="op">=</span> <span class="st">"Outcome"</span>, columns <span class="op">=</span> <span class="va">outcome</span>, </span>
<span>    level <span class="op">=</span> <span class="fl">1</span>, id <span class="op">=</span> <span class="st">"level1_c_po_obs"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  </span>
<span>  <span class="co"># Level 2 spanner labels</span></span>
<span>  <span class="fu">tab_spanner</span><span class="op">(</span></span>
<span>    label <span class="op">=</span> <span class="st">"Confounder"</span>,</span>
<span>    columns <span class="op">=</span> <span class="va">age</span>,</span>
<span>    level <span class="op">=</span> <span class="fl">2</span>, id <span class="op">=</span> <span class="st">"level2_a_po_obs"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tab_spanner</span><span class="op">(</span></span>
<span>    label <span class="op">=</span> <span class="st">"Treatment"</span>, columns <span class="op">=</span> <span class="va">treated</span>, </span>
<span>    level <span class="op">=</span> <span class="fl">2</span>, id <span class="op">=</span> <span class="st">"level2_b_po_obs"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tab_spanner</span><span class="op">(</span></span>
<span>    label <span class="op">=</span> <span class="st">"Realized"</span>, columns <span class="op">=</span> <span class="va">outcome</span>, </span>
<span>    level <span class="op">=</span> <span class="fl">2</span>, id <span class="op">=</span> <span class="st">"level2_c_po_obs"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  </span>
<span>  <span class="co"># Style stuff</span></span>
<span>  <span class="fu">tab_style</span><span class="op">(</span></span>
<span>    style <span class="op">=</span> <span class="fu">cell_text</span><span class="op">(</span>align <span class="op">=</span> <span class="st">"center"</span><span class="op">)</span>,</span>
<span>    locations <span class="op">=</span> <span class="fu">cells_column_labels</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tab_style</span><span class="op">(</span></span>
<span>    style <span class="op">=</span> <span class="fu">cell_text</span><span class="op">(</span>align <span class="op">=</span> <span class="st">"center"</span><span class="op">)</span>,</span>
<span>    locations <span class="op">=</span> <span class="fu">cells_body</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tab_style</span><span class="op">(</span></span>
<span>    style <span class="op">=</span> <span class="fu">cell_text</span><span class="op">(</span>weight <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>    locations <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>      <span class="fu">cells_column_spanners</span><span class="op">(</span>spanners <span class="op">=</span> <span class="fu">starts_with</span><span class="op">(</span><span class="st">"level1"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      <span class="fu">cells_column_labels</span><span class="op">(</span>columns <span class="op">=</span> <span class="st">"id"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tab_style</span><span class="op">(</span></span>
<span>    style <span class="op">=</span> <span class="fu">cell_text</span><span class="op">(</span>style <span class="op">=</span> <span class="st">"italic"</span><span class="op">)</span>,</span>
<span>    locations <span class="op">=</span> <span class="fu">cells_column_spanners</span><span class="op">(</span>spanners <span class="op">=</span> <span class="fu">starts_with</span><span class="op">(</span><span class="st">"level2"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span></span>
<span>  <span class="fu">tab_style</span><span class="op">(</span></span>
<span>    style <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>      <span class="fu">cell_fill</span><span class="op">(</span>color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    locations <span class="op">=</span> <span class="fu">cells_body</span><span class="op">(</span>rows <span class="op">=</span> <span class="va">treated</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">opt_horizontal_padding</span><span class="op">(</span>scale <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">opt_table_font</span><span class="op">(</span>font <span class="op">=</span> <span class="st">"Jost"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div id="tbl-basic-realized" class="cell no-stripe quarto-float quarto-figure quarto-figure-center anchored" data-layout-align="center">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-basic-realized-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2: Observed version of <a href="#tbl-basic-po" class="quarto-xref">Table&nbsp;1</a> showing only the realized outcome
</figcaption><div aria-describedby="tbl-basic-realized-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<div id="cojetdyxkv" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#cojetdyxkv table {
  font-family: Jost, system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#cojetdyxkv thead, #cojetdyxkv tbody, #cojetdyxkv tfoot, #cojetdyxkv tr, #cojetdyxkv td, #cojetdyxkv th {
  border-style: none;
}

#cojetdyxkv p {
  margin: 0;
  padding: 0;
}

#cojetdyxkv .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#cojetdyxkv .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#cojetdyxkv .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 15px;
  padding-right: 15px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#cojetdyxkv .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 15px;
  padding-right: 15px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#cojetdyxkv .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#cojetdyxkv .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#cojetdyxkv .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#cojetdyxkv .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 15px;
  padding-right: 15px;
  overflow-x: hidden;
}

#cojetdyxkv .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#cojetdyxkv .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#cojetdyxkv .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#cojetdyxkv .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#cojetdyxkv .gt_spanner_row {
  border-bottom-style: hidden;
}

#cojetdyxkv .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#cojetdyxkv .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#cojetdyxkv .gt_from_md > :first-child {
  margin-top: 0;
}

#cojetdyxkv .gt_from_md > :last-child {
  margin-bottom: 0;
}

#cojetdyxkv .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#cojetdyxkv .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 15px;
  padding-right: 15px;
}

#cojetdyxkv .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 15px;
  padding-right: 15px;
  vertical-align: top;
}

#cojetdyxkv .gt_row_group_first td {
  border-top-width: 2px;
}

#cojetdyxkv .gt_row_group_first th {
  border-top-width: 2px;
}

#cojetdyxkv .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
}

#cojetdyxkv .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#cojetdyxkv .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#cojetdyxkv .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#cojetdyxkv .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
}

#cojetdyxkv .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#cojetdyxkv .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#cojetdyxkv .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#cojetdyxkv .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#cojetdyxkv .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#cojetdyxkv .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 15px;
  padding-right: 15px;
}

#cojetdyxkv .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#cojetdyxkv .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 15px;
  padding-right: 15px;
}

#cojetdyxkv .gt_left {
  text-align: left;
}

#cojetdyxkv .gt_center {
  text-align: center;
}

#cojetdyxkv .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#cojetdyxkv .gt_font_normal {
  font-weight: normal;
}

#cojetdyxkv .gt_font_bold {
  font-weight: bold;
}

#cojetdyxkv .gt_font_italic {
  font-style: italic;
}

#cojetdyxkv .gt_super {
  font-size: 65%;
}

#cojetdyxkv .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#cojetdyxkv .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#cojetdyxkv .gt_indent_1 {
  text-indent: 5px;
}

#cojetdyxkv .gt_indent_2 {
  text-indent: 10px;
}

#cojetdyxkv .gt_indent_3 {
  text-indent: 15px;
}

#cojetdyxkv .gt_indent_4 {
  text-indent: 20px;
}

#cojetdyxkv .gt_indent_5 {
  text-indent: 25px;
}

#cojetdyxkv .katex-display {
  display: inline-flex !important;
  margin-bottom: 0.75em !important;
}
</style>
<table class="gt_table do-not-create-environment cell no-stripe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<colgroup>
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="gt_col_headings gt_spanner_row header">
<th class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" style="text-align: center; font-style: italic; font-style: italic; font-style: italic;" scope="col"></th>
<th id="Confounder" class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" style="text-align: center; font-style: italic; font-style: italic; font-style: italic;" scope="col"><span class="gt_column_spanner">Confounder</span></th>
<th id="Treatment" class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" style="text-align: center; font-style: italic; font-style: italic; font-style: italic;" scope="col"><span class="gt_column_spanner">Treatment</span></th>
<th id="Realized" class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" style="text-align: center; font-style: italic; font-style: italic; font-style: italic;" scope="col"><span class="gt_column_spanner">Realized</span></th>
</tr>
<tr class="gt_col_headings gt_spanner_row even">
<th rowspan="2" id="ID" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;" scope="col">ID</th>
<th id="Age" class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;" scope="col"><span class="gt_column_spanner">Age</span></th>
<th id="Treated" class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;" scope="col"><span class="gt_column_spanner">Treated</span></th>
<th id="Outcome" class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;" scope="col"><span class="gt_column_spanner">Outcome</span></th>
</tr>
<tr class="gt_col_headings header">
<th id="<div data-qmd=&quot;$Z_i$&quot;><div class='gt_from_md'><p>\(Z_i\)</p>
</div></div>" class="gt_col_heading gt_columns_bottom_border gt_left" style="text-align: center;" data-quarto-table-cell-role="th" scope="col"><p><span class="math inline">\(Z_i\)</span></p></th>
<th id="<div data-qmd=&quot;$X_i$&quot;><div class='gt_from_md'><p>\(X_i\)</p>
</div></div>" class="gt_col_heading gt_columns_bottom_border gt_right" style="text-align: center;" data-quarto-table-cell-role="th" scope="col"><p><span class="math inline">\(X_i\)</span></p></th>
<th id="<div data-qmd=&quot;$Y_i$&quot;><div class='gt_from_md'><p>\(Y_i\)</p>
</div></div>" class="gt_col_heading gt_columns_bottom_border gt_right" style="text-align: center;" data-quarto-table-cell-role="th" scope="col"><p><span class="math inline">\(Y_i\)</span></p></th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_right" headers="id" style="text-align: center; background-color: rgba(255,204,61,0.5);">1</td>
<td class="gt_row gt_left" headers="age" style="text-align: center; background-color: rgba(255,204,61,0.5);">Old</td>
<td class="gt_row gt_right" headers="treated" style="text-align: center; background-color: rgba(255,204,61,0.5);">1</td>
<td class="gt_row gt_right" headers="outcome" style="text-align: center; background-color: rgba(255,204,61,0.5);">80</td>
</tr>
<tr class="even">
<td class="gt_row gt_right" headers="id" style="text-align: center; background-color: rgba(255,204,61,0.5);">2</td>
<td class="gt_row gt_left" headers="age" style="text-align: center; background-color: rgba(255,204,61,0.5);">Old</td>
<td class="gt_row gt_right" headers="treated" style="text-align: center; background-color: rgba(255,204,61,0.5);">1</td>
<td class="gt_row gt_right" headers="outcome" style="text-align: center; background-color: rgba(255,204,61,0.5);">75</td>
</tr>
<tr class="odd">
<td class="gt_row gt_right" headers="id" style="text-align: center; background-color: rgba(255,204,61,0.5);">3</td>
<td class="gt_row gt_left" headers="age" style="text-align: center; background-color: rgba(255,204,61,0.5);">Old</td>
<td class="gt_row gt_right" headers="treated" style="text-align: center; background-color: rgba(255,204,61,0.5);">1</td>
<td class="gt_row gt_right" headers="outcome" style="text-align: center; background-color: rgba(255,204,61,0.5);">85</td>
</tr>
<tr class="even">
<td class="gt_row gt_right" style="text-align: center;" headers="id">4</td>
<td class="gt_row gt_left" style="text-align: center;" headers="age">Old</td>
<td class="gt_row gt_right" style="text-align: center;" headers="treated">0</td>
<td class="gt_row gt_right" style="text-align: center;" headers="outcome">60</td>
</tr>
<tr class="odd">
<td class="gt_row gt_right" headers="id" style="text-align: center; background-color: rgba(255,204,61,0.5);">5</td>
<td class="gt_row gt_left" headers="age" style="text-align: center; background-color: rgba(255,204,61,0.5);">Young</td>
<td class="gt_row gt_right" headers="treated" style="text-align: center; background-color: rgba(255,204,61,0.5);">1</td>
<td class="gt_row gt_right" headers="outcome" style="text-align: center; background-color: rgba(255,204,61,0.5);">75</td>
</tr>
<tr class="even">
<td class="gt_row gt_right" style="text-align: center;" headers="id">6</td>
<td class="gt_row gt_left" style="text-align: center;" headers="age">Young</td>
<td class="gt_row gt_right" style="text-align: center;" headers="treated">0</td>
<td class="gt_row gt_right" style="text-align: center;" headers="outcome">80</td>
</tr>
<tr class="odd">
<td class="gt_row gt_right" style="text-align: center;" headers="id">7</td>
<td class="gt_row gt_left" style="text-align: center;" headers="age">Young</td>
<td class="gt_row gt_right" style="text-align: center;" headers="treated">0</td>
<td class="gt_row gt_right" style="text-align: center;" headers="outcome">100</td>
</tr>
<tr class="even">
<td class="gt_row gt_right" style="text-align: center;" headers="id">8</td>
<td class="gt_row gt_left" style="text-align: center;" headers="age">Young</td>
<td class="gt_row gt_right" style="text-align: center;" headers="treated">0</td>
<td class="gt_row gt_right" style="text-align: center;" headers="outcome">80</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</figure>
</div>
</div>
<p>We could try to find the ATE by finding the average outcome among the treated (<span class="math inline">\(\bar{Y}_\text{Treated}\)</span>) and subtracting it from the average outcome among the untreated (<span class="math inline">\(\bar{Y}_\text{Untreated}\)</span>):</p>
<p><span class="math display">\[
\begin{aligned}
\text{ATE}_\text{naive} &amp;= \bar{Y}_\text{Treated} - \bar{Y}_\text{Untreated} \\
&amp;= \frac{80 + 75 + 85 + 75}{4} - \frac{60 + 80 + 100 + 80}{4} \\
&amp;= 78.75 - 80 \\
&amp;= -1.25
\end{aligned}
\]</span></p>
<p>But this is horribly wrong. Selection bias is distorting the causal effect here. Treated people sought out treatment because they knew it would be good for them. We can’t compare the two groups directly like this because of the systematic differences between them.</p>
<p>We need to somehow account for the fact that the two groups are different. We’ve been ignoring one column in this table all this time—age (<span class="math inline">\(Z\)</span>). It looks like age is highly correlated with treatment status here. 75% of people who signed up for the treatment were old; 75% of people who didn’t sign up for the treatment were young.<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> In DAG terms, age seems to be a confounder—it causes both the choice to receive treatment and the ultimate value of the outcome. Age opens up a backdoor relationship between treatment and outcome and messes up the causal effect. If we can somehow statistically account for age, we’ll be left with a more accurate estimate of the actual ATE.</p>
<div class="no-row-height column-margin column-container"><div id="fn4"><p><sup>4</sup>&nbsp;Maybe this treatment is a colonoscopy? idk—use your imagination.</p></div></div><div class="cell page-columns page-full" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">basic_dag</span> <span class="op">&lt;-</span> <span class="fu">dagify</span><span class="op">(</span></span>
<span>  <span class="va">Y</span> <span class="op">~</span> <span class="va">X</span> <span class="op">+</span> <span class="va">Z</span>,</span>
<span>  <span class="va">X</span> <span class="op">~</span> <span class="va">Z</span>,</span>
<span>  exposure <span class="op">=</span> <span class="st">"X"</span>,</span>
<span>  outcome <span class="op">=</span> <span class="st">"Y"</span>,</span>
<span>  coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>X <span class="op">=</span> <span class="fl">1</span>, Y <span class="op">=</span> <span class="fl">3</span>, Z <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>    y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>X <span class="op">=</span> <span class="fl">1</span>, Y <span class="op">=</span> <span class="fl">1</span>, Z <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">basic_dag_plot</span> <span class="op">&lt;-</span> <span class="va">basic_dag</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tidy_dagitty</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>var_type <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span></span>
<span>    <span class="va">name</span> <span class="op">==</span> <span class="st">"X"</span> <span class="op">~</span> <span class="st">"Exposure"</span>,</span>
<span>    <span class="va">name</span> <span class="op">==</span> <span class="st">"Y"</span> <span class="op">~</span> <span class="st">"Outcome"</span>,</span>
<span>    <span class="fu">str_detect</span><span class="op">(</span><span class="va">name</span>, <span class="st">"Z"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"Confounder"</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>var_label <span class="op">=</span> <span class="fu">case_match</span><span class="op">(</span><span class="va">name</span>,</span>
<span>    <span class="st">"X"</span> <span class="op">~</span> <span class="st">"Treatment"</span>,</span>
<span>    <span class="st">"Y"</span> <span class="op">~</span> <span class="st">"Outcome"</span>,</span>
<span>    <span class="st">"Z"</span> <span class="op">~</span> <span class="st">"Age"</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">basic_dag_plot</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, xend <span class="op">=</span> <span class="va">xend</span>, yend <span class="op">=</span> <span class="va">yend</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_dag_edges</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_dag_point</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">var_type</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_richtext</span><span class="op">(</span></span>
<span>    <span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">name</span><span class="op">)</span>, fontface <span class="op">=</span> <span class="st">"bold"</span>, color <span class="op">=</span> <span class="st">"white"</span>,</span>
<span>    fill <span class="op">=</span> <span class="cn">NA</span>, label.color <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>    label.padding <span class="op">=</span> <span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, <span class="st">"pt"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_dag_text</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">basic_dag_plot</span>, <span class="va">var_type</span> <span class="op">!=</span> <span class="st">"Confounder"</span><span class="op">)</span>, <span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">var_label</span><span class="op">)</span>, </span>
<span>    nudge_y <span class="op">=</span> <span class="op">-</span><span class="fl">0.25</span>, color <span class="op">=</span> <span class="st">"black"</span>, size <span class="op">=</span> <span class="fl">11</span>, size.unit <span class="op">=</span> <span class="st">"pt"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_dag_text</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">basic_dag_plot</span>, <span class="va">var_type</span> <span class="op">==</span> <span class="st">"Confounder"</span><span class="op">)</span>, <span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">var_label</span><span class="op">)</span>, </span>
<span>    nudge_y <span class="op">=</span> <span class="fl">0.26</span>, color <span class="op">=</span> <span class="st">"black"</span>, size <span class="op">=</span> <span class="fl">11</span>, size.unit <span class="op">=</span> <span class="st">"pt"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">1</span>, <span class="fl">6</span><span class="op">)</span><span class="op">]</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_dag</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div id="fig-dag-basic" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure page-columns page-full"><div aria-describedby="fig-dag-basic-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_files/figure-html/fig-dag-basic-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:70.0%">
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-dag-basic-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: DAG showing that age confounds the relationship between treatment and outcome
</figcaption></figure>
</div>
</div>
</div>
<p>There are lots of ways to adjust for age here (there are whole textbooks about this; matching, inverse probability weighting, etc.). One simple way is to stratify by age and find the sum of weighted averages for old and young people, like this:</p>
<p><span class="math display">\[
\text{ATE} = (\pi_\text{Old} \times \text{Effect}_\text{Old}) + (\pi_\text{Young} \times \text{Effect}_\text{Young})
\]</span></p>
<p>With the data from the table, we get:</p>
<p><span class="math display">\[
\begin{aligned}
\text{Effect}_\text{Stratified} &amp;= (\pi_\text{Treated} \times \bar{Y}_\text{Treated}) - (\pi_\text{Untreated} \times \bar{Y}_\text{Untreated}) \\[20pt]
\text{Effect}_\text{Old} &amp;= \frac{80 + 75 + 85}{3} - \frac{60}{1} &amp;&amp;= 20 \\
\text{Effect}_\text{Young} &amp;= \frac{75}{1} - \frac{80 + 100 + 80}{3} &amp;&amp;= -11.667 \\[20pt]
\text{ATE} &amp;= (\frac{4}{8} \times 20) + (\frac{4}{8} \times -11.667) &amp;&amp;= 4.1667
\end{aligned}
\]</span></p>
<p>4.1667 isn’t quite the true ATE of 5, but it’s surprisingly close! If we had more than 8 rows of data, we’d get even closer (as long as age was really truly the only confounder).</p>
</section></section><section id="moving-beyond-the-ate" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="moving-beyond-the-ate">Moving beyond the ATE</h2>
<p>Walking through a table like this is a useful exercise. It illustrates how individual causal effects are unobservable. It shows how we could theoretically find the average treatment effect of some intervention. It highlights the role selection bias and confounding play in distorting causal effects. It points to ways of accounting for confounding through statistical adjustment.</p>
<p>But for me personally, that’s about all the utility I’ve gotten out of tables like this. One aesthetic reason is that these numbers are all really generic—people get an outcome of 80 or 60 or whatever, but 80 or 60 <em>what</em>? It’s left up to the reader’s imagination.</p>
<p>More importantly, though, I’ve always figured that the ATT and ATU that you calculate from these kinds of tables were extra peripheral estimands that you found on your way to calculating the ATE, and that all you should really care about is the ATE.</p>
<p><strong>But that’s wrong!</strong></p>
<p>So to rectify this, let’s explore the nuances of different flavors of treatment effects using a more involved potential outcomes dataset that’s more realistic, based on a hypothetical international development intervention designed to reduce the risk of malaria through the use of anti-mosquito bed nets.<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a> The data is observational and non-experimental—people choose to use the nets or not based on personal preferences. In this case, income and health confound the net → malaria risk relationship: income influences health, and both income and health influence the choice to use a net and overall malaria risk.</p>
<div class="no-row-height column-margin column-container"><div id="fn5"><p><sup>5</sup>&nbsp;I used a similar dataset <a href="https://www.andrewheiss.com/blog/2020/12/01/ipw-binary-continuous/index.html#binary-treatments">back in this blog post</a>, and I use similar data in my class too; this version is new and improved though, with more explicit confounding and differences between the ATE, ATT, and ATU built in.</p></div></div><div class="cell page-columns page-full" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mosquito_dag</span> <span class="op">&lt;-</span> <span class="fu">dagitty</span><span class="op">(</span><span class="st">'</span></span>
<span><span class="st">dag {</span></span>
<span><span class="st">"X" [exposure,pos="1,1"]</span></span>
<span><span class="st">"Y" [outcome,pos="4,1"]</span></span>
<span><span class="st">"Z&lt;sub&gt;1&lt;/sub&gt;" [pos="2,2"]</span></span>
<span><span class="st">"Z&lt;sub&gt;2&lt;/sub&gt;" [pos="3,2"]</span></span>
<span><span class="st">"Z&lt;sub&gt;2&lt;/sub&gt;" -&gt; "Y"</span></span>
<span><span class="st">"Z&lt;sub&gt;2&lt;/sub&gt;" -&gt; "X"</span></span>
<span><span class="st">"Z&lt;sub&gt;1&lt;/sub&gt;" -&gt; "Y"</span></span>
<span><span class="st">"Z&lt;sub&gt;1&lt;/sub&gt;" -&gt; "Z&lt;sub&gt;2&lt;/sub&gt;"</span></span>
<span><span class="st">"Z&lt;sub&gt;1&lt;/sub&gt;" -&gt; "X"</span></span>
<span><span class="st">"X" -&gt; "Y"</span></span>
<span><span class="st">}'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dag_plot</span> <span class="op">&lt;-</span> <span class="va">mosquito_dag</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tidy_dagitty</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>var_type <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span></span>
<span>    <span class="va">name</span> <span class="op">==</span> <span class="st">"X"</span> <span class="op">~</span> <span class="st">"Exposure"</span>,</span>
<span>    <span class="va">name</span> <span class="op">==</span> <span class="st">"Y"</span> <span class="op">~</span> <span class="st">"Outcome"</span>,</span>
<span>    <span class="fu">str_detect</span><span class="op">(</span><span class="va">name</span>, <span class="st">"Z"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"Confounder"</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>var_label <span class="op">=</span> <span class="fu">case_match</span><span class="op">(</span><span class="va">name</span>,</span>
<span>    <span class="st">"X"</span> <span class="op">~</span> <span class="st">"Mosquito net"</span>,</span>
<span>    <span class="st">"Y"</span> <span class="op">~</span> <span class="st">"Malaria risk"</span>,</span>
<span>    <span class="st">"Z&lt;sub&gt;1&lt;/sub&gt;"</span> <span class="op">~</span> <span class="st">"Income"</span>,</span>
<span>    <span class="st">"Z&lt;sub&gt;2&lt;/sub&gt;"</span> <span class="op">~</span> <span class="st">"Health"</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">dag_plot</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, xend <span class="op">=</span> <span class="va">xend</span>, yend <span class="op">=</span> <span class="va">yend</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_dag_edges</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_dag_point</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">var_type</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_richtext</span><span class="op">(</span></span>
<span>    <span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">name</span><span class="op">)</span>, fontface <span class="op">=</span> <span class="st">"bold"</span>, color <span class="op">=</span> <span class="st">"white"</span>,</span>
<span>    fill <span class="op">=</span> <span class="cn">NA</span>, label.color <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>    label.padding <span class="op">=</span> <span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, <span class="st">"pt"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_dag_text</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">dag_plot</span>, <span class="va">var_type</span> <span class="op">!=</span> <span class="st">"Confounder"</span><span class="op">)</span>, <span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">var_label</span><span class="op">)</span>, </span>
<span>    nudge_y <span class="op">=</span> <span class="op">-</span><span class="fl">0.15</span>, color <span class="op">=</span> <span class="st">"black"</span>, size <span class="op">=</span> <span class="fl">11</span>, size.unit <span class="op">=</span> <span class="st">"pt"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_dag_text</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">dag_plot</span>, <span class="va">var_type</span> <span class="op">==</span> <span class="st">"Confounder"</span><span class="op">)</span>, <span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">var_label</span><span class="op">)</span>, </span>
<span>    nudge_y <span class="op">=</span> <span class="fl">0.16</span>, color <span class="op">=</span> <span class="st">"black"</span>, size <span class="op">=</span> <span class="fl">11</span>, size.unit <span class="op">=</span> <span class="st">"pt"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">1</span>, <span class="fl">6</span><span class="op">)</span><span class="op">]</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_dag</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div id="fig-dag-mosquito" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure page-columns page-full"><div aria-describedby="fig-dag-mosquito-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_files/figure-html/fig-dag-mosquito-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%">
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-dag-mosquito-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: DAG showing the relationship between mosquito net use and malaria risk, confounded by health and income
</figcaption></figure>
</div>
</div>
</div>
<p><strong>In this dataset, the true ATE is −15.</strong> Using a bed net causes a 15-unit decrease in malaria risk across the whole population on average.</p>
<p>In the interest of space, I’ve hidden the data generation code below. You can also download a CSV version of it here if you want to follow along but not run all the code:</p>
<ul>
<li><a href="mosquito_nets_v2.csv"><i class="fa-solid fa-file-csv" aria-label="file-csv"></i> <code>mosquito_nets_v2.csv</code></a></li>
</ul>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Code for generating synthetic mosquito net data</summary><div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_seed.html">with_seed</a></span><span class="op">(</span><span class="fl">1234</span>, <span class="op">{</span></span>
<span>  <span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">1500</span></span>
<span>  </span>
<span>  <span class="va">nets</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span></span>
<span>    <span class="co"># Generate exogenous variables</span></span>
<span>    id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span>,</span>
<span>    income <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">500</span>, <span class="fl">100</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="co"># Generate health, which depends on income</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span></span>
<span>      health <span class="op">=</span> <span class="op">(</span><span class="fl">0.1</span> <span class="op">*</span> <span class="va">income</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>      health <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmin</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="va">health</span>, <span class="fl">0</span><span class="op">)</span>, <span class="fl">100</span><span class="op">)</span>  <span class="co"># Force values to 0-100 range</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="co"># Generate net usage (treatment), which depends on health and income</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span></span>
<span>      <span class="co"># Make people with high health and high income a lot more likely to</span></span>
<span>      <span class="co"># self-select into treatment</span></span>
<span>      income_high <span class="op">=</span> <span class="va">income</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">income</span>, <span class="fl">0.8</span><span class="op">)</span>,</span>
<span>      health_high <span class="op">=</span> <span class="va">health</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">health</span>, <span class="fl">0.8</span><span class="op">)</span>,</span>
<span>      </span>
<span>      <span class="co"># Create latent propensity scores based on logit formula</span></span>
<span>      net_prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html">plogis</a></span><span class="op">(</span></span>
<span>        <span class="op">-</span><span class="fl">3</span> <span class="op">+</span> <span class="op">(</span><span class="va">income</span> <span class="op">/</span> <span class="fl">300</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">health</span> <span class="op">/</span> <span class="fl">40</span><span class="op">)</span> <span class="op">+</span> </span>
<span>          <span class="op">(</span><span class="fl">0.9</span> <span class="op">*</span> <span class="va">income_high</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">0.5</span> <span class="op">*</span> <span class="va">health_high</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      </span>
<span>      <span class="co"># Assign to treatment</span></span>
<span>      net <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, </span>
<span>        <span class="co"># Fancy little trick---increase the latent propensity score by 5</span></span>
<span>        <span class="co"># percentage points for people already more likely (i.e. p &gt; 50%) to</span></span>
<span>        <span class="co"># receive treatment and decrease the propensity score by 8 percentage</span></span>
<span>        <span class="co"># points for those already less likely to receive treatment</span></span>
<span>        prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span></span>
<span>          <span class="va">net_prob</span> <span class="op">&gt;</span> <span class="fl">0.5</span>, </span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmin</a></span><span class="op">(</span><span class="va">net_prob</span> <span class="op">+</span> <span class="fl">0.05</span>, <span class="fl">0.98</span><span class="op">)</span>, </span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="va">net_prob</span> <span class="op">-</span> <span class="fl">0.08</span>, <span class="fl">0.02</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="co"># Generate potential and actual outcomes</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span></span>
<span>      <span class="co"># Individual outcomes in a world where individuals are not treated</span></span>
<span>      malaria_risk_0 <span class="op">=</span> <span class="fl">90</span> <span class="op">+</span> <span class="op">(</span><span class="op">-</span><span class="fl">0.2</span> <span class="op">*</span> <span class="va">health</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="op">-</span><span class="fl">0.05</span> <span class="op">*</span> <span class="va">income</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">0</span>, <span class="fl">6</span><span class="op">)</span>,</span>
<span>      malaria_risk_0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmin</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="va">malaria_risk_0</span>, <span class="fl">0</span><span class="op">)</span>, <span class="fl">100</span><span class="op">)</span>,  <span class="co"># Force values to 0-100</span></span>
<span>      </span>
<span>      <span class="co"># Individual outcomes in a world where individuals are treated</span></span>
<span>      <span class="co"># Basically risk_0 + a baseline treatment effect + extra treatment effect</span></span>
<span>      <span class="co"># boosts because of income and health</span></span>
<span>      malaria_risk_1 <span class="op">=</span> <span class="va">malaria_risk_0</span> <span class="op">-</span> </span>
<span>        <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">-</span> <span class="op">(</span><span class="fl">0.015</span> <span class="op">*</span> <span class="va">income</span><span class="op">)</span> <span class="op">-</span> <span class="op">(</span><span class="fl">0.09</span> <span class="op">*</span> <span class="va">health</span><span class="op">)</span>,</span>
<span>      malaria_risk_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmin</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="va">malaria_risk_1</span>, <span class="fl">0</span><span class="op">)</span>, <span class="fl">100</span><span class="op">)</span>,  <span class="co"># Force values to 0-100</span></span>
<span>      </span>
<span>      <span class="co"># Round stuff</span></span>
<span>      malaria_risk_0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">malaria_risk_0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>      malaria_risk_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">malaria_risk_1</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>      </span>
<span>      ice <span class="op">=</span> <span class="va">malaria_risk_1</span> <span class="op">-</span> <span class="va">malaria_risk_0</span>,</span>
<span>      </span>
<span>      <span class="co"># Actual realized outcome</span></span>
<span>      malaria_risk <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">net</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">malaria_risk_1</span>, <span class="va">malaria_risk_0</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="co"># Round more stuff</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">income</span>, <span class="va">health</span><span class="op">)</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">.</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="co"># Only keep some columns</span></span>
<span>    <span class="fu">select</span><span class="op">(</span></span>
<span>      <span class="va">id</span>, <span class="va">income</span>, <span class="va">income_high</span>, <span class="va">health</span>, <span class="va">health_high</span>, <span class="va">net</span>,</span>
<span>      <span class="fu">starts_with</span><span class="op">(</span><span class="st">"malaria"</span><span class="op">)</span>, <span class="va">ice</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">write_csv</span><span class="op">(</span><span class="va">nets</span>, <span class="st">"mosquito_nets_v2.csv"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We have four main variables in this data:</p>
<ul>
<li>
<strong>Net use</strong> <em>(Treatment)</em>: Binary 0/1, TRUE/FALSE variable indicating if the person uses a bed net.</li>
<li>
<strong>Malaria risk</strong> <em>(Outcome)</em>: Scale from 0–100, with higher values representing greater risk.</li>
<li>
<strong>Income</strong> <em>(Confounder)</em>: Weekly income, measured in dollars. Higher income causes a higher probability of using a net; people above the 80th percentile get an extra boost in probability.</li>
<li>
<strong>Health</strong> <em>(Confounder)</em>: Health status, scale from 0–100, with higher values representing better health. Better health causes a higher probability of using a net; people above the 80th percentile get an extra boost in probability.</li>
</ul>
<p><a href="#tbl-nets-po" class="quarto-xref">Table&nbsp;3</a> shows a small excerpt of the data, with people using nets highlighted in yellow to mimic standard example potential outcome tables like <a href="#tbl-basic-po" class="quarto-xref">Table&nbsp;1</a>.</p>
<div class="cell no-stripe" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">excerpt</span> <span class="op">&lt;-</span> <span class="va">nets</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">slice</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">14</span>, <span class="fl">15</span>, <span class="fl">29</span>, <span class="fl">4</span>, <span class="fl">35</span>, <span class="fl">37</span>, <span class="fl">73</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="va">id</span><span class="op">)</span></span>
<span></span>
<span><span class="va">excerpt</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">add_row</span><span class="op">(</span>id <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span></span>
<span>    <span class="va">id</span>, <span class="va">income</span>, <span class="va">health</span>, <span class="va">net</span>, </span>
<span>    <span class="va">malaria_risk_1</span>, <span class="va">malaria_risk_0</span>, <span class="va">ice</span>, <span class="va">malaria_risk</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">gt</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">sub_missing</span><span class="op">(</span>missing_text <span class="op">=</span> <span class="st">"…"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">fmt_number</span><span class="op">(</span></span>
<span>    columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu">starts_with</span><span class="op">(</span><span class="st">"malaria_risk"</span><span class="op">)</span>, <span class="va">ice</span><span class="op">)</span>,</span>
<span>    decimals <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">fmt_number</span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">income</span>, <span class="va">health</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  </span>
<span>  <span class="co"># Column labels</span></span>
<span>  <span class="fu">cols_label</span><span class="op">(</span></span>
<span>    id <span class="op">=</span> <span class="st">"ID"</span>,</span>
<span>    income <span class="op">=</span> <span class="fu">md</span><span class="op">(</span><span class="st">"$Z_{1_i}$"</span><span class="op">)</span>,</span>
<span>    health <span class="op">=</span> <span class="fu">md</span><span class="op">(</span><span class="st">"$Z_{2_i}$"</span><span class="op">)</span>,</span>
<span>    net <span class="op">=</span> <span class="fu">md</span><span class="op">(</span><span class="st">"$X_i$"</span><span class="op">)</span>,</span>
<span>    malaria_risk_0 <span class="op">=</span> <span class="fu">md</span><span class="op">(</span><span class="st">"$Y^0_i$"</span><span class="op">)</span>,</span>
<span>    malaria_risk_1 <span class="op">=</span> <span class="fu">md</span><span class="op">(</span><span class="st">"$Y^1_i$"</span><span class="op">)</span>,</span>
<span>    malaria_risk <span class="op">=</span> <span class="fu">md</span><span class="op">(</span><span class="st">"$Y_i$"</span><span class="op">)</span>,</span>
<span>    ice <span class="op">=</span> <span class="fu">md</span><span class="op">(</span><span class="st">"$Y^1_i - Y^0_i$"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  </span>
<span>  <span class="co"># Level 1 spanner labels</span></span>
<span>  <span class="fu">tab_spanner</span><span class="op">(</span></span>
<span>    label <span class="op">=</span> <span class="st">"Income"</span>, columns <span class="op">=</span> <span class="va">income</span>, </span>
<span>    level <span class="op">=</span> <span class="fl">1</span>, id <span class="op">=</span> <span class="st">"level1_a"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tab_spanner</span><span class="op">(</span></span>
<span>    label <span class="op">=</span> <span class="st">"Health"</span>, columns <span class="op">=</span> <span class="va">health</span>, </span>
<span>    level <span class="op">=</span> <span class="fl">1</span>, id <span class="op">=</span> <span class="st">"level1_b"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tab_spanner</span><span class="op">(</span></span>
<span>    label <span class="op">=</span> <span class="st">"Net use"</span>, columns <span class="op">=</span> <span class="va">net</span>, </span>
<span>    level <span class="op">=</span> <span class="fl">1</span>, id <span class="op">=</span> <span class="st">"level1_c"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tab_spanner</span><span class="op">(</span></span>
<span>    label <span class="op">=</span> <span class="st">"Potential outcomes"</span>,</span>
<span>    columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">malaria_risk_1</span>, <span class="va">malaria_risk_0</span><span class="op">)</span>,</span>
<span>    level <span class="op">=</span> <span class="fl">1</span>, id <span class="op">=</span> <span class="st">"level1_d"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tab_spanner</span><span class="op">(</span></span>
<span>    label <span class="op">=</span> <span class="st">"ICE or \\(\\delta_i\\)"</span>, columns <span class="op">=</span> <span class="va">ice</span>, </span>
<span>    level <span class="op">=</span> <span class="fl">1</span>, id <span class="op">=</span> <span class="st">"level1_e"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tab_spanner</span><span class="op">(</span></span>
<span>    label <span class="op">=</span> <span class="st">"Outcome"</span>, columns <span class="op">=</span> <span class="va">malaria_risk</span>, </span>
<span>    level <span class="op">=</span> <span class="fl">1</span>, id <span class="op">=</span> <span class="st">"level1_f"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  </span>
<span>  <span class="co"># Level 2 spanner labels</span></span>
<span>  <span class="fu">tab_spanner</span><span class="op">(</span></span>
<span>    label <span class="op">=</span> <span class="st">"Confounders"</span>,</span>
<span>    columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">income</span>, <span class="va">health</span><span class="op">)</span>,</span>
<span>    level <span class="op">=</span> <span class="fl">2</span>, id <span class="op">=</span> <span class="st">"level2_a"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tab_spanner</span><span class="op">(</span></span>
<span>    label <span class="op">=</span> <span class="st">"Treatment"</span>, columns <span class="op">=</span> <span class="va">net</span>, </span>
<span>    level <span class="op">=</span> <span class="fl">2</span>, id <span class="op">=</span> <span class="st">"level2_b"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tab_spanner</span><span class="op">(</span></span>
<span>    label <span class="op">=</span> <span class="st">"Unobservable"</span>,</span>
<span>    columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">malaria_risk_1</span>, <span class="va">malaria_risk_0</span>, <span class="va">ice</span><span class="op">)</span>, </span>
<span>    level <span class="op">=</span> <span class="fl">2</span>, id <span class="op">=</span> <span class="st">"level2_c"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tab_spanner</span><span class="op">(</span></span>
<span>    label <span class="op">=</span> <span class="st">"Realized"</span>, columns <span class="op">=</span> <span class="va">malaria_risk</span>, </span>
<span>    level <span class="op">=</span> <span class="fl">2</span>, id <span class="op">=</span> <span class="st">"level2_d"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  </span>
<span>  <span class="co"># Style stuff</span></span>
<span>  <span class="fu">tab_style</span><span class="op">(</span></span>
<span>    style <span class="op">=</span> <span class="fu">cell_text</span><span class="op">(</span>align <span class="op">=</span> <span class="st">"center"</span><span class="op">)</span>,</span>
<span>    locations <span class="op">=</span> <span class="fu">cells_column_labels</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tab_style</span><span class="op">(</span></span>
<span>    style <span class="op">=</span> <span class="fu">cell_text</span><span class="op">(</span>align <span class="op">=</span> <span class="st">"center"</span><span class="op">)</span>,</span>
<span>    locations <span class="op">=</span> <span class="fu">cells_body</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tab_style</span><span class="op">(</span></span>
<span>    style <span class="op">=</span> <span class="fu">cell_text</span><span class="op">(</span>weight <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>    locations <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>      <span class="fu">cells_column_spanners</span><span class="op">(</span>spanners <span class="op">=</span> <span class="fu">starts_with</span><span class="op">(</span><span class="st">"level1"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      <span class="fu">cells_column_labels</span><span class="op">(</span>columns <span class="op">=</span> <span class="st">"id"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tab_style</span><span class="op">(</span></span>
<span>    style <span class="op">=</span> <span class="fu">cell_text</span><span class="op">(</span>style <span class="op">=</span> <span class="st">"italic"</span><span class="op">)</span>,</span>
<span>    locations <span class="op">=</span> <span class="fu">cells_column_spanners</span><span class="op">(</span>spanners <span class="op">=</span> <span class="fu">starts_with</span><span class="op">(</span><span class="st">"level2"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  </span>
<span>  <span class="fu">tab_style</span><span class="op">(</span></span>
<span>    style <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>      <span class="fu">cell_fill</span><span class="op">(</span>color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    locations <span class="op">=</span> <span class="fu">cells_body</span><span class="op">(</span>rows <span class="op">=</span> <span class="va">net</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tab_footnote</span><span class="op">(</span></span>
<span>    footnote <span class="op">=</span> <span class="st">"ICE = individual causal effect"</span>,</span>
<span>    locations <span class="op">=</span> <span class="fu">cells_column_spanners</span><span class="op">(</span>spanners <span class="op">=</span> <span class="st">"level1_e"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">opt_footnote_marks</span><span class="op">(</span>marks <span class="op">=</span> <span class="st">"standard"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">opt_horizontal_padding</span><span class="op">(</span>scale <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">opt_table_font</span><span class="op">(</span>font <span class="op">=</span> <span class="st">"Jost"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div id="tbl-nets-po" class="cell no-stripe quarto-float quarto-figure quarto-figure-center anchored" data-layout-align="center">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-nets-po-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;3: Potential outcomes, individual causal effects, and realized outcomes for synthetic mosquito net data
</figcaption><div aria-describedby="tbl-nets-po-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<div id="inhkxtufuq" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#inhkxtufuq table {
  font-family: Jost, system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#inhkxtufuq thead, #inhkxtufuq tbody, #inhkxtufuq tfoot, #inhkxtufuq tr, #inhkxtufuq td, #inhkxtufuq th {
  border-style: none;
}

#inhkxtufuq p {
  margin: 0;
  padding: 0;
}

#inhkxtufuq .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#inhkxtufuq .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#inhkxtufuq .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 15px;
  padding-right: 15px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#inhkxtufuq .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 15px;
  padding-right: 15px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#inhkxtufuq .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#inhkxtufuq .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#inhkxtufuq .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#inhkxtufuq .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 15px;
  padding-right: 15px;
  overflow-x: hidden;
}

#inhkxtufuq .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#inhkxtufuq .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#inhkxtufuq .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#inhkxtufuq .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#inhkxtufuq .gt_spanner_row {
  border-bottom-style: hidden;
}

#inhkxtufuq .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#inhkxtufuq .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#inhkxtufuq .gt_from_md > :first-child {
  margin-top: 0;
}

#inhkxtufuq .gt_from_md > :last-child {
  margin-bottom: 0;
}

#inhkxtufuq .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#inhkxtufuq .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 15px;
  padding-right: 15px;
}

#inhkxtufuq .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 15px;
  padding-right: 15px;
  vertical-align: top;
}

#inhkxtufuq .gt_row_group_first td {
  border-top-width: 2px;
}

#inhkxtufuq .gt_row_group_first th {
  border-top-width: 2px;
}

#inhkxtufuq .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
}

#inhkxtufuq .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#inhkxtufuq .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#inhkxtufuq .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#inhkxtufuq .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
}

#inhkxtufuq .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#inhkxtufuq .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#inhkxtufuq .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#inhkxtufuq .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#inhkxtufuq .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#inhkxtufuq .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 15px;
  padding-right: 15px;
}

#inhkxtufuq .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#inhkxtufuq .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 15px;
  padding-right: 15px;
}

#inhkxtufuq .gt_left {
  text-align: left;
}

#inhkxtufuq .gt_center {
  text-align: center;
}

#inhkxtufuq .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#inhkxtufuq .gt_font_normal {
  font-weight: normal;
}

#inhkxtufuq .gt_font_bold {
  font-weight: bold;
}

#inhkxtufuq .gt_font_italic {
  font-style: italic;
}

#inhkxtufuq .gt_super {
  font-size: 65%;
}

#inhkxtufuq .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#inhkxtufuq .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#inhkxtufuq .gt_indent_1 {
  text-indent: 5px;
}

#inhkxtufuq .gt_indent_2 {
  text-indent: 10px;
}

#inhkxtufuq .gt_indent_3 {
  text-indent: 15px;
}

#inhkxtufuq .gt_indent_4 {
  text-indent: 20px;
}

#inhkxtufuq .gt_indent_5 {
  text-indent: 25px;
}

#inhkxtufuq .katex-display {
  display: inline-flex !important;
  margin-bottom: 0.75em !important;
}
</style>
<table class="gt_table do-not-create-environment cell no-stripe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<colgroup>
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
</colgroup>
<thead>
<tr class="gt_col_headings gt_spanner_row header">
<th class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" style="text-align: center; font-style: italic; font-style: italic; font-style: italic; font-style: italic;" scope="col"></th>
<th colspan="2" id="Confounders" class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" style="text-align: center; font-style: italic; font-style: italic; font-style: italic; font-style: italic;" scope="colgroup"><span class="gt_column_spanner">Confounders</span></th>
<th id="Treatment" class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" style="text-align: center; font-style: italic; font-style: italic; font-style: italic; font-style: italic;" scope="col"><span class="gt_column_spanner">Treatment</span></th>
<th colspan="3" id="Unobservable" class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" style="text-align: center; font-style: italic; font-style: italic; font-style: italic; font-style: italic;" scope="colgroup"><span class="gt_column_spanner">Unobservable</span></th>
<th id="Realized" class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" style="text-align: center; font-style: italic; font-style: italic; font-style: italic; font-style: italic;" scope="col"><span class="gt_column_spanner">Realized</span></th>
</tr>
<tr class="gt_col_headings gt_spanner_row even">
<th rowspan="2" id="ID" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;" scope="col">ID</th>
<th id="Income" class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;" scope="col"><span class="gt_column_spanner">Income</span></th>
<th id="Health" class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;" scope="col"><span class="gt_column_spanner">Health</span></th>
<th id="Net use" class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;" scope="col"><span class="gt_column_spanner">Net use</span></th>
<th colspan="2" id="Potential outcomes" class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;" scope="colgroup"><span class="gt_column_spanner">Potential outcomes</span></th>
<th id="ICE or \(\delta_i\)<span class=&quot;gt_footnote_marks gt_asterisk&quot; style=&quot;white-space:nowrap;font-style:italic;font-weight:normal;&quot;><sup>*</sup></span>" class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;" scope="col"><span class="gt_column_spanner">ICE or \(\delta_i\)<span class="gt_footnote_marks gt_asterisk" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>*</sup></span></span></th>
<th id="Outcome" class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;" scope="col"><span class="gt_column_spanner">Outcome</span></th>
</tr>
<tr class="gt_col_headings header">
<th id="<div data-qmd=&quot;$Z_{1_i}$&quot;><div class='gt_from_md'><p>\(Z_{1_i}\)</p>
</div></div>" class="gt_col_heading gt_columns_bottom_border gt_right" style="text-align: center;" data-quarto-table-cell-role="th" scope="col"><p><span class="math inline">\(Z_{1_i}\)</span></p></th>
<th id="<div data-qmd=&quot;$Z_{2_i}$&quot;><div class='gt_from_md'><p>\(Z_{2_i}\)</p>
</div></div>" class="gt_col_heading gt_columns_bottom_border gt_right" style="text-align: center;" data-quarto-table-cell-role="th" scope="col"><p><span class="math inline">\(Z_{2_i}\)</span></p></th>
<th id="<div data-qmd=&quot;$X_i$&quot;><div class='gt_from_md'><p>\(X_i\)</p>
</div></div>" class="gt_col_heading gt_columns_bottom_border gt_right" style="text-align: center;" data-quarto-table-cell-role="th" scope="col"><p><span class="math inline">\(X_i\)</span></p></th>
<th id="<div data-qmd=&quot;$Y^1_i$&quot;><div class='gt_from_md'><p>\(Y^1_i\)</p>
</div></div>" class="gt_col_heading gt_columns_bottom_border gt_right" style="text-align: center;" data-quarto-table-cell-role="th" scope="col"><p><span class="math inline">\(Y^1_i\)</span></p></th>
<th id="<div data-qmd=&quot;$Y^0_i$&quot;><div class='gt_from_md'><p>\(Y^0_i\)</p>
</div></div>" class="gt_col_heading gt_columns_bottom_border gt_right" style="text-align: center;" data-quarto-table-cell-role="th" scope="col"><p><span class="math inline">\(Y^0_i\)</span></p></th>
<th id="<div data-qmd=&quot;$Y^1_i - Y^0_i$&quot;><div class='gt_from_md'><p>\(Y^1_i - Y^0_i\)</p>
</div></div>" class="gt_col_heading gt_columns_bottom_border gt_right" style="text-align: center;" data-quarto-table-cell-role="th" scope="col"><p><span class="math inline">\(Y^1_i - Y^0_i\)</span></p></th>
<th id="<div data-qmd=&quot;$Y_i$&quot;><div class='gt_from_md'><p>\(Y_i\)</p>
</div></div>" class="gt_col_heading gt_columns_bottom_border gt_right" style="text-align: center;" data-quarto-table-cell-role="th" scope="col"><p><span class="math inline">\(Y_i\)</span></p></th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_right" headers="id" style="text-align: center; background-color: rgba(255,204,61,0.5);">3</td>
<td class="gt_row gt_right" headers="income" style="text-align: center; background-color: rgba(255,204,61,0.5);">608</td>
<td class="gt_row gt_right" headers="health" style="text-align: center; background-color: rgba(255,204,61,0.5);">54</td>
<td class="gt_row gt_right" headers="net" style="text-align: center; background-color: rgba(255,204,61,0.5);">1</td>
<td class="gt_row gt_right" headers="malaria_risk_1" style="text-align: center; background-color: rgba(255,204,61,0.5);">34.9</td>
<td class="gt_row gt_right" headers="malaria_risk_0" style="text-align: center; background-color: rgba(255,204,61,0.5);">52.7</td>
<td class="gt_row gt_right" headers="ice" style="text-align: center; background-color: rgba(255,204,61,0.5);">−17.8</td>
<td class="gt_row gt_right" headers="malaria_risk" style="text-align: center; background-color: rgba(255,204,61,0.5);">34.9</td>
</tr>
<tr class="even">
<td class="gt_row gt_right" style="text-align: center;" headers="id">4</td>
<td class="gt_row gt_right" style="text-align: center;" headers="income">265</td>
<td class="gt_row gt_right" style="text-align: center;" headers="health">21</td>
<td class="gt_row gt_right" style="text-align: center;" headers="net">0</td>
<td class="gt_row gt_right" style="text-align: center;" headers="malaria_risk_1">73.0</td>
<td class="gt_row gt_right" style="text-align: center;" headers="malaria_risk_0">82.8</td>
<td class="gt_row gt_right" style="text-align: center;" headers="ice">−9.8</td>
<td class="gt_row gt_right" style="text-align: center;" headers="malaria_risk">82.8</td>
</tr>
<tr class="odd">
<td class="gt_row gt_right" headers="id" style="text-align: center; background-color: rgba(255,204,61,0.5);">14</td>
<td class="gt_row gt_right" headers="income" style="text-align: center; background-color: rgba(255,204,61,0.5);">506</td>
<td class="gt_row gt_right" headers="health" style="text-align: center; background-color: rgba(255,204,61,0.5);">58</td>
<td class="gt_row gt_right" headers="net" style="text-align: center; background-color: rgba(255,204,61,0.5);">1</td>
<td class="gt_row gt_right" headers="malaria_risk_1" style="text-align: center; background-color: rgba(255,204,61,0.5);">22.5</td>
<td class="gt_row gt_right" headers="malaria_risk_0" style="text-align: center; background-color: rgba(255,204,61,0.5);">39.4</td>
<td class="gt_row gt_right" headers="ice" style="text-align: center; background-color: rgba(255,204,61,0.5);">−16.9</td>
<td class="gt_row gt_right" headers="malaria_risk" style="text-align: center; background-color: rgba(255,204,61,0.5);">22.5</td>
</tr>
<tr class="even">
<td class="gt_row gt_right" headers="id" style="text-align: center; background-color: rgba(255,204,61,0.5);">15</td>
<td class="gt_row gt_right" headers="income" style="text-align: center; background-color: rgba(255,204,61,0.5);">596</td>
<td class="gt_row gt_right" headers="health" style="text-align: center; background-color: rgba(255,204,61,0.5);">62</td>
<td class="gt_row gt_right" headers="net" style="text-align: center; background-color: rgba(255,204,61,0.5);">1</td>
<td class="gt_row gt_right" headers="malaria_risk_1" style="text-align: center; background-color: rgba(255,204,61,0.5);">43.0</td>
<td class="gt_row gt_right" headers="malaria_risk_0" style="text-align: center; background-color: rgba(255,204,61,0.5);">59.0</td>
<td class="gt_row gt_right" headers="ice" style="text-align: center; background-color: rgba(255,204,61,0.5);">−16.0</td>
<td class="gt_row gt_right" headers="malaria_risk" style="text-align: center; background-color: rgba(255,204,61,0.5);">43.0</td>
</tr>
<tr class="odd">
<td class="gt_row gt_right" headers="id" style="text-align: center; background-color: rgba(255,204,61,0.5);">29</td>
<td class="gt_row gt_right" headers="income" style="text-align: center; background-color: rgba(255,204,61,0.5);">498</td>
<td class="gt_row gt_right" headers="health" style="text-align: center; background-color: rgba(255,204,61,0.5);">61</td>
<td class="gt_row gt_right" headers="net" style="text-align: center; background-color: rgba(255,204,61,0.5);">1</td>
<td class="gt_row gt_right" headers="malaria_risk_1" style="text-align: center; background-color: rgba(255,204,61,0.5);">40.0</td>
<td class="gt_row gt_right" headers="malaria_risk_0" style="text-align: center; background-color: rgba(255,204,61,0.5);">55.6</td>
<td class="gt_row gt_right" headers="ice" style="text-align: center; background-color: rgba(255,204,61,0.5);">−15.6</td>
<td class="gt_row gt_right" headers="malaria_risk" style="text-align: center; background-color: rgba(255,204,61,0.5);">40.0</td>
</tr>
<tr class="even">
<td class="gt_row gt_right" style="text-align: center;" headers="id">35</td>
<td class="gt_row gt_right" style="text-align: center;" headers="income">337</td>
<td class="gt_row gt_right" style="text-align: center;" headers="health">42</td>
<td class="gt_row gt_right" style="text-align: center;" headers="net">0</td>
<td class="gt_row gt_right" style="text-align: center;" headers="malaria_risk_1">57.6</td>
<td class="gt_row gt_right" style="text-align: center;" headers="malaria_risk_0">68.0</td>
<td class="gt_row gt_right" style="text-align: center;" headers="ice">−10.4</td>
<td class="gt_row gt_right" style="text-align: center;" headers="malaria_risk">68.0</td>
</tr>
<tr class="odd">
<td class="gt_row gt_right" style="text-align: center;" headers="id">37</td>
<td class="gt_row gt_right" style="text-align: center;" headers="income">282</td>
<td class="gt_row gt_right" style="text-align: center;" headers="health">28</td>
<td class="gt_row gt_right" style="text-align: center;" headers="net">0</td>
<td class="gt_row gt_right" style="text-align: center;" headers="malaria_risk_1">50.5</td>
<td class="gt_row gt_right" style="text-align: center;" headers="malaria_risk_0">59.4</td>
<td class="gt_row gt_right" style="text-align: center;" headers="ice">−8.9</td>
<td class="gt_row gt_right" style="text-align: center;" headers="malaria_risk">59.4</td>
</tr>
<tr class="even">
<td class="gt_row gt_right" style="text-align: center;" headers="id">73</td>
<td class="gt_row gt_right" style="text-align: center;" headers="income">463</td>
<td class="gt_row gt_right" style="text-align: center;" headers="health">37</td>
<td class="gt_row gt_right" style="text-align: center;" headers="net">0</td>
<td class="gt_row gt_right" style="text-align: center;" headers="malaria_risk_1">47.9</td>
<td class="gt_row gt_right" style="text-align: center;" headers="malaria_risk_0">59.4</td>
<td class="gt_row gt_right" style="text-align: center;" headers="ice">−11.5</td>
<td class="gt_row gt_right" style="text-align: center;" headers="malaria_risk">59.4</td>
</tr>
<tr class="odd">
<td class="gt_row gt_right" style="text-align: center;" headers="id">…</td>
<td class="gt_row gt_right" style="text-align: center;" headers="income">…</td>
<td class="gt_row gt_right" style="text-align: center;" headers="health">…</td>
<td class="gt_row gt_right" style="text-align: center;" headers="net">…</td>
<td class="gt_row gt_right" style="text-align: center;" headers="malaria_risk_1">…</td>
<td class="gt_row gt_right" style="text-align: center;" headers="malaria_risk_0">…</td>
<td class="gt_row gt_right" style="text-align: center;" headers="ice">…</td>
<td class="gt_row gt_right" style="text-align: center;" headers="malaria_risk">…</td>
</tr>
</tbody>
<tfoot class="gt_footnotes"><tr class="odd">
<td colspan="8" class="gt_footnote" style="text-align: center;">
<span class="gt_footnote_marks gt_asterisk" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>*</sup></span> ICE = individual causal effect</td>
</tr></tfoot>
</table>
</div>
</div>
</div>
</figure>
</div>
</div>
<p>Let’s use this data to explore and calculate three different estimands from <span class="citation" data-cites="GreiferStuart:2023">Greifer and Stuart (<a href="#ref-GreiferStuart:2023" role="doc-biblioref">2023</a>)</span>: the ATE, the ATT, and the ATU. For each estimand, we’ll do this:</p>
<ol type="1">
<li>Give a plain translation of what the estimand measures and explanation about why we would care about it</li>
<li>Calculate the estimand using the true-but-unobservable individual causal effects (ICE), or <span class="math inline">\(\delta\)</span>
</li>
<li>Calculate the estimand using propensity score-based weighting and g-computation</li>
</ol></section><section id="plain-translations-and-true-values" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="plain-translations-and-true-values">Plain translations and true values</h2>
<p>Here’s what the synthetic <code>nets</code> data looks like—we have columns for each of the columns in <a href="#tbl-nets-po" class="quarto-xref">Table&nbsp;3</a>, as well as some indicators for whether income and health are above the 80th percentile:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">nets</span> <span class="op">|&gt;</span> <span class="fu">glimpse</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">## Rows: 1,500</span></span>
<span><span class="co">## Columns: 10</span></span>
<span><span class="co">## $ id             &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, …</span></span>
<span><span class="co">## $ income         &lt;dbl&gt; 379, 528, 608, 265, 543, 551, 443, 445, 444, 411, 452, 400, 422, 506, 596, 489, 449, 409, 416, 742, 513, 451, 456, 546, 431, 355, 557, 398, 498, 406, 610, 452, 429, 450, 337, 383, 282, 366, 471, 453, 645, 393, 414, 472, 401, 403, 389, 375, 448, 450, 319, 442, 389, 399, 484, …</span></span>
<span><span class="co">## $ income_high    &lt;lgl&gt; FALSE, FALSE, TRUE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, TRUE, FALSE, FALSE, FALSE, FALSE, TRUE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, TRUE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE,…</span></span>
<span><span class="co">## $ health         &lt;dbl&gt; 56, 39, 54, 21, 51, 51, 49, 32, 39, 36, 41, 34, 54, 58, 62, 35, 74, 50, 54, 55, 49, 53, 49, 61, 49, 31, 53, 31, 61, 21, 58, 53, 41, 59, 42, 30, 28, 37, 50, 40, 58, 37, 51, 58, 34, 41, 29, 30, 39, 32, 12, 52, 43, 32, 58, 74, 41, 54, 78, 40, 51, 64, 41, 37, 29, 61, 48, 56, 79,…</span></span>
<span><span class="co">## $ health_high    &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, TRUE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FAL…</span></span>
<span><span class="co">## $ net            &lt;int&gt; 0, 0, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 0, 1, 0, 1, 0, 0, 0, 1, 0, 1, 0, 0, 0, 1, 0, 0, 1, 0, 1, 0, 1, 0, 0, 1, 0, 0, 0, 1, 1, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 1, 1, 0, 1, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 1, 1,…</span></span>
<span><span class="co">## $ malaria_risk_0 &lt;dbl&gt; 50.1, 59.4, 52.7, 82.8, 42.5, 54.0, 57.4, 68.8, 61.1, 54.9, 54.9, 66.6, 52.8, 39.4, 59.0, 60.7, 57.4, 54.9, 56.4, 29.2, 64.5, 61.4, 51.5, 52.0, 62.1, 60.1, 45.7, 67.7, 55.6, 70.3, 46.3, 53.9, 66.3, 58.5, 68.0, 51.7, 59.4, 61.6, 55.4, 64.7, 47.3, 59.0, 53.0, 68.9, 68.6, 64.5,…</span></span>
<span><span class="co">## $ malaria_risk_1 &lt;dbl&gt; 35.1, 42.9, 34.9, 73.0, 25.7, 38.9, 43.5, 56.1, 48.0, 41.1, 40.2, 53.0, 37.4, 22.5, 43.0, 46.6, 42.8, 41.1, 41.9, 10.8, 47.9, 46.6, 37.6, 34.8, 47.8, 47.7, 28.6, 54.4, 40.0, 60.2, 27.4, 39.7, 52.8, 42.6, 57.6, 39.8, 50.5, 50.6, 38.3, 52.9, 30.3, 48.5, 38.1, 54.4, 56.7, 51.2,…</span></span>
<span><span class="co">## $ malaria_risk   &lt;dbl&gt; 50.1, 59.4, 34.9, 82.8, 42.5, 38.9, 43.5, 56.1, 48.0, 41.1, 54.9, 66.6, 52.8, 22.5, 43.0, 60.7, 42.8, 54.9, 41.9, 29.2, 64.5, 61.4, 37.6, 52.0, 47.8, 60.1, 45.7, 67.7, 40.0, 70.3, 46.3, 39.7, 66.3, 42.6, 68.0, 39.8, 59.4, 61.6, 38.3, 64.7, 47.3, 59.0, 38.1, 54.4, 68.6, 51.2,…</span></span>
<span><span class="co">## $ ice            &lt;dbl&gt; -15.0, -16.5, -17.8, -9.8, -16.8, -15.1, -13.9, -12.7, -13.1, -13.8, -14.7, -13.6, -15.4, -16.9, -16.0, -14.1, -14.6, -13.8, -14.5, -18.4, -16.6, -14.8, -13.9, -17.2, -14.3, -12.4, -17.1, -13.3, -15.6, -10.1, -18.9, -14.2, -13.5, -15.9, -10.4, -11.9, -8.9, -11.0, -17.1, -11.…</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="ate" class="level3"><h3 class="anchored" data-anchor-id="ate">ATE</h3>
<p>The average treatment effect (ATE) is what I’ve always assumed people always want to find when doing causal inference. It represents the effect of using bed nets across the whole population, even if people wouldn’t ordinarily receive the treatment. It’s a really broad estimand, so it’s good for policies with a wide scope that might influence an entire population, like if a government is considering rolling out free or subsidized bed nets to everyone in the country.</p>
<p>We calculate this by taking the average of all individual causal effects:</p>
<p><span class="math display">\[
\begin{aligned}
\text{ATE} &amp;= E[\delta_i] &amp; \text{ or} \\
\text{ATE} &amp;= E[Y^1_i - Y^0_i]
\end{aligned}
\]</span></p>
<p>Conceptually this is the same as imagining two hypothetical worlds: in Universe A we give everyone a bed net (even if they don’t need it), and in Universe B we give nobody a bed net. We then calculate the difference in individual causal effects between those worlds.</p>
<p>If we look at just the eight rows of the bed net data in <a href="#tbl-nets-po" class="quarto-xref">Table&nbsp;3</a>, the ATE would be −13.36:</p>
<p><span class="math display">\[
\frac{(-17.8) + (-9.8) + (-16.9) + (-16) + (-15.6) + (-10.4) + (-8.9) + (-11.5)}{8} = -13.36
\]</span></p>
<p>We can calculate it with the full data by taking the average of the ICE column. It’s −15.0, which is what I baked into the data:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">nets</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co"># I included the alternative versions here just to show that it's </span></span>
<span>  <span class="co"># the average of Y1 - average of Y0</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span></span>
<span>    ATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">ice</span><span class="op">)</span>,</span>
<span>    ATE_alt1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">malaria_risk_1</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">malaria_risk_0</span><span class="op">)</span>,</span>
<span>    ATE_alt2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">malaria_risk_1</span> <span class="op">-</span> <span class="va">malaria_risk_0</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">## # A tibble: 1 × 3</span></span>
<span><span class="co">##     ATE ATE_alt1 ATE_alt2</span></span>
<span><span class="co">##   &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">## 1 -15.0    -15.0    -15.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="att" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="att">ATT</h3>
<p>The average treatment effect on the treated (ATT) is narrower than the ATE, but (surprisingly!) is often more useful and policy relevant! It represents the effect of using bed nets, but only for people who use bed nets. That feels weird, so here are a few other examples:</p>
<div class="cell no-stripe" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tribble</span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">ATE</span>, <span class="op">~</span><span class="va">ATT</span>,</span>
<span>  <span class="st">"Effect of mosquito bed nets for everyone in the country"</span>, <span class="st">"Effect of mosquito bed nets for people who use bed nets"</span>,</span>
<span>  <span class="st">"Effect of military service for typical applicants to the military"</span>, <span class="st">"Effect of military service for typical soldiers"</span>,</span>
<span>  <span class="st">"Effect of a job training program on all residents in a state"</span>, <span class="st">"Effect of a job training program on everyone who used it"</span>,</span>
<span>  <span class="st">"Effect of a new cancer medicine on everyone in the world"</span>, <span class="st">"Effect of a new cancer medicine on people with cancer"</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">gt</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tab_style</span><span class="op">(</span></span>
<span>    style <span class="op">=</span> <span class="fu">cell_text</span><span class="op">(</span>weight <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>    locations <span class="op">=</span> <span class="fu">cells_column_labels</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tab_style</span><span class="op">(</span></span>
<span>    style <span class="op">=</span> <span class="fu">cell_text</span><span class="op">(</span>v_align <span class="op">=</span> <span class="st">"top"</span><span class="op">)</span>,</span>
<span>    locations <span class="op">=</span> <span class="fu">cells_body</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tab_footnote</span><span class="op">(</span></span>
<span>    footnote <span class="op">=</span> <span class="fu">html</span><span class="op">(</span><span class="st">"Example via &lt;a href='https://stats.stackexchange.com/a/455012/3025'&gt;this Cross Validated response&lt;/a&gt;"</span><span class="op">)</span>,</span>
<span>    locations <span class="op">=</span> <span class="fu">cells_body</span><span class="op">(</span>columns <span class="op">=</span> <span class="va">ATE</span>, rows <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">opt_footnote_marks</span><span class="op">(</span>marks <span class="op">=</span> <span class="st">"standard"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">opt_horizontal_padding</span><span class="op">(</span>scale <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">opt_table_font</span><span class="op">(</span>font <span class="op">=</span> <span class="st">"Jost"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div id="tbl-ate-vs-att" class="cell no-stripe quarto-float quarto-figure quarto-figure-center anchored" data-layout-align="center">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-ate-vs-att-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;4: Different types of causal effects that can be found as ATEs and ATTs
</figcaption><div aria-describedby="tbl-ate-vs-att-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<div id="zpfvrsoywl" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#zpfvrsoywl table {
  font-family: Jost, system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#zpfvrsoywl thead, #zpfvrsoywl tbody, #zpfvrsoywl tfoot, #zpfvrsoywl tr, #zpfvrsoywl td, #zpfvrsoywl th {
  border-style: none;
}

#zpfvrsoywl p {
  margin: 0;
  padding: 0;
}

#zpfvrsoywl .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#zpfvrsoywl .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#zpfvrsoywl .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 15px;
  padding-right: 15px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#zpfvrsoywl .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 15px;
  padding-right: 15px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#zpfvrsoywl .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#zpfvrsoywl .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#zpfvrsoywl .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#zpfvrsoywl .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 15px;
  padding-right: 15px;
  overflow-x: hidden;
}

#zpfvrsoywl .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#zpfvrsoywl .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#zpfvrsoywl .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#zpfvrsoywl .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#zpfvrsoywl .gt_spanner_row {
  border-bottom-style: hidden;
}

#zpfvrsoywl .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#zpfvrsoywl .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#zpfvrsoywl .gt_from_md > :first-child {
  margin-top: 0;
}

#zpfvrsoywl .gt_from_md > :last-child {
  margin-bottom: 0;
}

#zpfvrsoywl .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#zpfvrsoywl .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 15px;
  padding-right: 15px;
}

#zpfvrsoywl .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 15px;
  padding-right: 15px;
  vertical-align: top;
}

#zpfvrsoywl .gt_row_group_first td {
  border-top-width: 2px;
}

#zpfvrsoywl .gt_row_group_first th {
  border-top-width: 2px;
}

#zpfvrsoywl .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
}

#zpfvrsoywl .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#zpfvrsoywl .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#zpfvrsoywl .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#zpfvrsoywl .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
}

#zpfvrsoywl .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#zpfvrsoywl .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#zpfvrsoywl .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#zpfvrsoywl .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#zpfvrsoywl .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#zpfvrsoywl .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 15px;
  padding-right: 15px;
}

#zpfvrsoywl .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#zpfvrsoywl .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 15px;
  padding-right: 15px;
}

#zpfvrsoywl .gt_left {
  text-align: left;
}

#zpfvrsoywl .gt_center {
  text-align: center;
}

#zpfvrsoywl .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#zpfvrsoywl .gt_font_normal {
  font-weight: normal;
}

#zpfvrsoywl .gt_font_bold {
  font-weight: bold;
}

#zpfvrsoywl .gt_font_italic {
  font-style: italic;
}

#zpfvrsoywl .gt_super {
  font-size: 65%;
}

#zpfvrsoywl .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#zpfvrsoywl .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#zpfvrsoywl .gt_indent_1 {
  text-indent: 5px;
}

#zpfvrsoywl .gt_indent_2 {
  text-indent: 10px;
}

#zpfvrsoywl .gt_indent_3 {
  text-indent: 15px;
}

#zpfvrsoywl .gt_indent_4 {
  text-indent: 20px;
}

#zpfvrsoywl .gt_indent_5 {
  text-indent: 25px;
}

#zpfvrsoywl .katex-display {
  display: inline-flex !important;
  margin-bottom: 0.75em !important;
}
</style>
<table class="gt_table do-not-create-environment cell no-stripe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead><tr class="gt_col_headings header">
<th id="ATE" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="font-weight: bold" scope="col">ATE</th>
<th id="ATT" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="font-weight: bold" scope="col">ATT</th>
</tr></thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="ATE" style="vertical-align: top">Effect of mosquito bed nets for everyone in the country</td>
<td class="gt_row gt_left" headers="ATT" style="vertical-align: top">Effect of mosquito bed nets for people who use bed nets</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="ATE" style="vertical-align: top">Effect of military service for typical applicants to the military<span class="gt_footnote_marks gt_asterisk" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>*</sup></span>
</td>
<td class="gt_row gt_left" headers="ATT" style="vertical-align: top">Effect of military service for typical soldiers</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="ATE" style="vertical-align: top">Effect of a job training program on all residents in a state</td>
<td class="gt_row gt_left" headers="ATT" style="vertical-align: top">Effect of a job training program on everyone who used it</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="ATE" style="vertical-align: top">Effect of a new cancer medicine on everyone in the world</td>
<td class="gt_row gt_left" headers="ATT" style="vertical-align: top">Effect of a new cancer medicine on people with cancer</td>
</tr>
</tbody>
<tfoot class="gt_footnotes"><tr class="odd">
<td colspan="2" class="gt_footnote">
<span class="gt_footnote_marks gt_asterisk" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>*</sup></span> Example via <a href="https://stats.stackexchange.com/a/455012/3025">this Cross Validated response</a>
</td>
</tr></tfoot>
</table>
</div>
</div>
</div>
</figure>
</div>
</div>
<p>The ATT feels a lot more useful for policy purposes. In medicine, it feels wrong to judge the effectiveness of a new drug based on the effect it would have on every person; in program evaluation, it feels wrong to judge the effectiveness of a training program on everyone, even if they wouldn’t ever use it.</p>
<p><strong>Both the ATE and the ATT are useful estimands for policy!</strong><a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a></p>
<div class="no-row-height column-margin column-container"><div id="fn6"><p><sup>6</sup>&nbsp;See <span class="citation" data-cites="HoImaiKing:2007">Ho et al. (<a href="#ref-HoImaiKing:2007" role="doc-biblioref">2007, 204</a>)</span> and <span class="citation" data-cites="GreiferStuart:2023">Greifer and Stuart (<a href="#ref-GreiferStuart:2023" role="doc-biblioref">2023</a>)</span>.</p></div></div><p>Conceptually, we can imagine two parallel worlds again: in Universe A we give everyone who’s currently using a bed net a net, and in Universe B we take away those nets. We then calculate the difference between those worlds. The ATT thus represents the effect of <em>withholding</em> nets from those who would have used them <span class="citation" data-cites="GreiferStuart:2023">(<a href="#ref-GreiferStuart:2023" role="doc-biblioref">Greifer and Stuart 2023, 7</a>)</span>.</p>
<p>BUT(!!!), thinking about the ATT feels wrong and weird—it feels like we’re abandoning the whole idea of a control group and only looking at the treated group—which is why I’ve always been confused about this estimand.</p>
<p>And I’m not alone! In forums and Q&amp;A sites, people always wonder the same thing. Take <a href="https://stats.stackexchange.com/a/308501/3025">this comment to this response on Cross Validated</a>, for instance:</p>
<blockquote class="blockquote">
<p>I’m a statistician, and I never have understood why someone would want to measure the ATT instead of the ATE. It’s important to have a control group to account for regression to the mean effects &amp; other factors - you’re missing this when you use the ATT</p>
</blockquote>
<p>It really does feel like we’re only looking at treated people. Like this official formula here:</p>
<p><span class="math display">\[
\begin{aligned}
\text{ATT} &amp;= E[\delta_i \mid X_i = 1] &amp; \text{or} \\
\text{ATT} &amp;= E[Y^1_i - Y^0_i \mid X_i = 1]
\end{aligned}
\]</span></p>
<p>That conditional <span class="math inline">\([\dots \mid X = 1]\)</span> part says that we’re only looking at treated people. And when we calculate it with hypothetical data, we really truly only look at the treated people. If we only look at the eight rows in <a href="#tbl-nets-po" class="quarto-xref">Table&nbsp;3</a>, the ATT would be −16.58:</p>
<p><span class="math display">\[
\frac{(-17.8) + (-16.9) + (-16) + (-15.6)}{4} = -16.58
\]</span></p>
<p>We can calculate it with the full data by taking the average of the ICE column after filtering the data so that we only look at people using a net. It’s −16.3, higher than the ATE (implying selection bias).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">nets</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">net</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>ATT <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">ice</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 1 × 1</span></span>
<span><span class="co">##     ATT</span></span>
<span><span class="co">##   &lt;dbl&gt;</span></span>
<span><span class="co">## 1 -16.3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This is why the ATT is weird for me (and lots of other people). We’re no longer finding the difference between treated and untreated people; we’re looking only at treated people and somehow finding a causal effect, which feels wrong.</p>
<p>I actually think that <a href="#tbl-nets-po" class="quarto-xref">Table&nbsp;3</a> here is making things more confusing for thinking about the ATT with observed data! Any causal effect is the difference between two numbers. Because we have time machine-based data, we’re finding the difference between what would have happened in Universe A and Universe B, just for treated people. In real life, though, where we don’t have a time machine, we can’t find that difference. We still need to compare treated people with untreated people! We’ll just do some extra statistical work to make the untreated people more comparable to the treated people.</p>
<p>So, <strong>with hypothetical data we compare treated people to their parallel selves and we ignore the untreated; with real data we compare treated people to untreated people</strong> (at least, in part; as we’ll see below, we use information from the untreated people to estimate possible average causal effects for just the treated people).</p>
</section><section id="atu" class="level3"><h3 class="anchored" data-anchor-id="atu">ATU</h3>
<p>The average treatment effect for the untreated (ATU) is just like the ATT, but in reverse. It represents the effect of using bed nets for people who aren’t using them.</p>
<p>Let’s go back to the two parallel worlds: in Universe A we give everyone who’s <em>not</em> currently using a bed net a net, and in Universe B we take away those nets. We then calculate the difference between those worlds. The ATU represents the effect of <em>expanding</em> treatment to those who did not receive it <span class="citation" data-cites="GreiferStuart:2023">(<a href="#ref-GreiferStuart:2023" role="doc-biblioref">Greifer and Stuart 2023, 7</a>)</span>.</p>
<p>We calculate this with hypothetical data by taking the average of the individual causal effects for untreated people:</p>
<p><span class="math display">\[
\begin{aligned}
\text{ATU} &amp;= E[\delta_i \mid X_i = 0] &amp; \text{or} \\
\text{ATU} &amp;= E[Y^1_i - Y^0_i \mid X_i = 0]
\end{aligned}
\]</span></p>
<p>If we look at just <a href="#tbl-nets-po" class="quarto-xref">Table&nbsp;3</a>, the ATU would be −10.15:</p>
<p><span class="math display">\[
\frac{(-9.8) + (-10.4) + (-8.9) + (-11.5)}{4} = -10.15
\]</span></p>
<p>We can calculate it with the full data by taking the average of the ICE column after filtering the data so that we only look at people <em>not</em> using a net. It’s −13.6, lower than the ATE (again, implying selection bias).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">nets</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">net</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>ATU <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">ice</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 1 × 1</span></span>
<span><span class="co">##     ATU</span></span>
<span><span class="co">##   &lt;dbl&gt;</span></span>
<span><span class="co">## 1 -13.6</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Just like the ATT, with hypothetical data we compare untreated people to their parallel selves and we ignore the treated. With real data, we’ll compare untreated people to treated people, with some statistical shenanigans to make the two groups comparable and remove confounding and selection bias.</p>
</section></section><section id="selection-bias-and-the-ate-att-and-atu" class="level2"><h2 class="anchored" data-anchor-id="selection-bias-and-the-ate-att-and-atu">Selection bias and the ATE, ATT, and ATU</h2>
<p>Before we calculate these different treatment effects with the realized outcomes instead of the hypothetical potential outcomes, let’s look really quick at the practical difference between the true ATE, ATT, and ATU. All three estimands are useful for policymaking!</p>
<p>The ATE is −15, implying that mosquito nets cause a 15 point reduction in malaria risk for every person in the country. This includes people who live at high elevations where mosquitoes don’t live, people who live near mosquito-infested swamps, people who are rich enough to buy <a href="https://en.wikipedia.org/wiki/Mosquito_laser">Bill Gates’s mosquito laser</a>, and people who can’t afford a net but would really like to use one. If we worked in the Ministry of Health and wanted to know if we should make a new national program that gave everyone a free bed net, the overall reduction in risk is −15, which is probably pretty good!</p>
<p>The ATT is −16.29, which is bigger than the ATE. The effect of net usage is bigger for people who are already using the nets. This is because of underlying systematic reasons, or selection bias. Those using nets want to use them because they need them more or can access them more easily—they might live in areas more prone to mosquitoes, or they can afford to buy their own nets, or something else. They know themselves and understand some notion of their personal individual causal effect and seek out nets. If we removed access to their nets, it would have a strong effect.</p>
<p>The ATU is −13.63, which is smaller than the ATE. The effect of net usage is smaller for people who aren’t using the nets. Again, this is because of selection bias. Those not using nets are likely not using them for systematic reasons—they live far away from mosquitoes, they’ve received a future malaria vaccine, they have some other form of mosquito abatement, or something else. Because they can read their own minds, they know that mosquito net use won’t do much for them personally, so they don’t seek out nets. If we expanded access to nets to them, they wouldn’t benefit as much.</p>
<p>And one final note about the ATE—as we saw before, it includes both the ATT and the ATU. Because it’s the average for everyone in the whole population, it’s the sum of the weighted averages of these two estimands:</p>
<p><span class="math display">\[
\text{ATE} = (\pi_\text{Net users} \times \text{ATT}) + (\pi_\text{Net non-users} \times \text{ATU})
\]</span></p>
<p>We can confirm this with the data:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">effect_types</span> <span class="op">&lt;-</span> <span class="va">nets</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">net</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span></span>
<span>    effect <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">ice</span><span class="op">)</span>,</span>
<span>    n <span class="op">=</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    prop <span class="op">=</span> <span class="va">n</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>,</span>
<span>    weighted_effect <span class="op">=</span> <span class="va">effect</span> <span class="op">*</span> <span class="va">prop</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>estimand <span class="op">=</span> <span class="fu">case_match</span><span class="op">(</span><span class="va">net</span>, <span class="fl">0</span> <span class="op">~</span> <span class="st">"ATU"</span>, <span class="fl">1</span> <span class="op">~</span> <span class="st">"ATT"</span><span class="op">)</span>, .before <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">effect_types</span></span>
<span><span class="co">## # A tibble: 2 × 6</span></span>
<span><span class="co">##   estimand   net effect     n  prop weighted_effect</span></span>
<span><span class="co">##   &lt;chr&gt;    &lt;int&gt;  &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt;           &lt;dbl&gt;</span></span>
<span><span class="co">## 1 ATU          0  -13.6   715 0.477           -6.50</span></span>
<span><span class="co">## 2 ATT          1  -16.3   785 0.523           -8.52</span></span>
<span></span>
<span><span class="va">effect_types</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>ATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">weighted_effect</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 1 × 1</span></span>
<span><span class="co">##     ATE</span></span>
<span><span class="co">##   &lt;dbl&gt;</span></span>
<span><span class="co">## 1 -15.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="finding-these-estimands-with-non-potential-outcome-based-data" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="finding-these-estimands-with-non-potential-outcome-based-data">Finding these estimands with non-potential-outcome-based data</h2>
<p>So far we’ve calculated the ATE, ATT, and ATU with data based on a time machine. In real life, we can only see this:</p>
<div class="cell no-stripe" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">excerpt</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">add_row</span><span class="op">(</span>id <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span></span>
<span>    <span class="va">id</span>, <span class="va">income</span>, <span class="va">health</span>, <span class="va">net</span>, <span class="va">malaria_risk</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">gt</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">sub_missing</span><span class="op">(</span>missing_text <span class="op">=</span> <span class="st">"…"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">fmt_number</span><span class="op">(</span></span>
<span>    columns <span class="op">=</span> <span class="va">malaria_risk</span>,</span>
<span>    decimals <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">fmt_number</span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">income</span>, <span class="va">health</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  </span>
<span>  <span class="co"># Column labels</span></span>
<span>  <span class="fu">cols_label</span><span class="op">(</span></span>
<span>    id <span class="op">=</span> <span class="st">"ID"</span>,</span>
<span>    income <span class="op">=</span> <span class="fu">md</span><span class="op">(</span><span class="st">"$Z_{1_i}$"</span><span class="op">)</span>,</span>
<span>    health <span class="op">=</span> <span class="fu">md</span><span class="op">(</span><span class="st">"$Z_{2_i}$"</span><span class="op">)</span>,</span>
<span>    net <span class="op">=</span> <span class="fu">md</span><span class="op">(</span><span class="st">"$X_i$"</span><span class="op">)</span>,</span>
<span>    malaria_risk <span class="op">=</span> <span class="fu">md</span><span class="op">(</span><span class="st">"$Y_i$"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  </span>
<span>  <span class="co"># Level 1 spanner labels</span></span>
<span>  <span class="fu">tab_spanner</span><span class="op">(</span></span>
<span>    label <span class="op">=</span> <span class="st">"Income"</span>, columns <span class="op">=</span> <span class="va">income</span>, </span>
<span>    level <span class="op">=</span> <span class="fl">1</span>, id <span class="op">=</span> <span class="st">"level1_a_obs"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tab_spanner</span><span class="op">(</span></span>
<span>    label <span class="op">=</span> <span class="st">"Health"</span>, columns <span class="op">=</span> <span class="va">health</span>, </span>
<span>    level <span class="op">=</span> <span class="fl">1</span>, id <span class="op">=</span> <span class="st">"level1_b_obs"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tab_spanner</span><span class="op">(</span></span>
<span>    label <span class="op">=</span> <span class="st">"Net use"</span>, columns <span class="op">=</span> <span class="va">net</span>, </span>
<span>    level <span class="op">=</span> <span class="fl">1</span>, id <span class="op">=</span> <span class="st">"level1_c_obs"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tab_spanner</span><span class="op">(</span></span>
<span>    label <span class="op">=</span> <span class="st">"Outcome"</span>, columns <span class="op">=</span> <span class="va">malaria_risk</span>, </span>
<span>    level <span class="op">=</span> <span class="fl">1</span>, id <span class="op">=</span> <span class="st">"level1_d_obs"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  </span>
<span>  <span class="co"># Level 2 spanner labels</span></span>
<span>  <span class="fu">tab_spanner</span><span class="op">(</span></span>
<span>    label <span class="op">=</span> <span class="st">"Confounders"</span>,</span>
<span>    columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">income</span>, <span class="va">health</span><span class="op">)</span>,</span>
<span>    level <span class="op">=</span> <span class="fl">2</span>, id <span class="op">=</span> <span class="st">"level2_a_obs"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tab_spanner</span><span class="op">(</span></span>
<span>    label <span class="op">=</span> <span class="st">"Treatment"</span>, columns <span class="op">=</span> <span class="va">net</span>, </span>
<span>    level <span class="op">=</span> <span class="fl">2</span>, id <span class="op">=</span> <span class="st">"level2_b_obs"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tab_spanner</span><span class="op">(</span></span>
<span>    label <span class="op">=</span> <span class="st">"Realized"</span>, columns <span class="op">=</span> <span class="va">malaria_risk</span>, </span>
<span>    level <span class="op">=</span> <span class="fl">2</span>, id <span class="op">=</span> <span class="st">"level2_c_obs"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  </span>
<span>  <span class="co"># Style stuff</span></span>
<span>  <span class="fu">tab_style</span><span class="op">(</span></span>
<span>    style <span class="op">=</span> <span class="fu">cell_text</span><span class="op">(</span>align <span class="op">=</span> <span class="st">"center"</span><span class="op">)</span>,</span>
<span>    locations <span class="op">=</span> <span class="fu">cells_column_labels</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tab_style</span><span class="op">(</span></span>
<span>    style <span class="op">=</span> <span class="fu">cell_text</span><span class="op">(</span>align <span class="op">=</span> <span class="st">"center"</span><span class="op">)</span>,</span>
<span>    locations <span class="op">=</span> <span class="fu">cells_body</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tab_style</span><span class="op">(</span></span>
<span>    style <span class="op">=</span> <span class="fu">cell_text</span><span class="op">(</span>weight <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>    locations <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>      <span class="fu">cells_column_spanners</span><span class="op">(</span>spanners <span class="op">=</span> <span class="fu">starts_with</span><span class="op">(</span><span class="st">"level1"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      <span class="fu">cells_column_labels</span><span class="op">(</span>columns <span class="op">=</span> <span class="st">"id"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tab_style</span><span class="op">(</span></span>
<span>    style <span class="op">=</span> <span class="fu">cell_text</span><span class="op">(</span>style <span class="op">=</span> <span class="st">"italic"</span><span class="op">)</span>,</span>
<span>    locations <span class="op">=</span> <span class="fu">cells_column_spanners</span><span class="op">(</span>spanners <span class="op">=</span> <span class="fu">starts_with</span><span class="op">(</span><span class="st">"level2"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  </span>
<span>  <span class="fu">tab_style</span><span class="op">(</span></span>
<span>    style <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>      <span class="fu">cell_fill</span><span class="op">(</span>color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    locations <span class="op">=</span> <span class="fu">cells_body</span><span class="op">(</span>rows <span class="op">=</span> <span class="va">net</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">opt_horizontal_padding</span><span class="op">(</span>scale <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">opt_table_font</span><span class="op">(</span>font <span class="op">=</span> <span class="st">"Jost"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div id="tbl-nets-realized" class="cell no-stripe quarto-float quarto-figure quarto-figure-center anchored" data-layout-align="center">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-nets-realized-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;5: Observed version of <a href="#tbl-nets-po" class="quarto-xref">Table&nbsp;3</a> showing only the realized outcome
</figcaption><div aria-describedby="tbl-nets-realized-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<div id="kcyxfehquq" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#kcyxfehquq table {
  font-family: Jost, system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#kcyxfehquq thead, #kcyxfehquq tbody, #kcyxfehquq tfoot, #kcyxfehquq tr, #kcyxfehquq td, #kcyxfehquq th {
  border-style: none;
}

#kcyxfehquq p {
  margin: 0;
  padding: 0;
}

#kcyxfehquq .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#kcyxfehquq .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#kcyxfehquq .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 15px;
  padding-right: 15px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#kcyxfehquq .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 15px;
  padding-right: 15px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#kcyxfehquq .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#kcyxfehquq .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#kcyxfehquq .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#kcyxfehquq .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 15px;
  padding-right: 15px;
  overflow-x: hidden;
}

#kcyxfehquq .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#kcyxfehquq .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#kcyxfehquq .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#kcyxfehquq .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#kcyxfehquq .gt_spanner_row {
  border-bottom-style: hidden;
}

#kcyxfehquq .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#kcyxfehquq .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#kcyxfehquq .gt_from_md > :first-child {
  margin-top: 0;
}

#kcyxfehquq .gt_from_md > :last-child {
  margin-bottom: 0;
}

#kcyxfehquq .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#kcyxfehquq .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 15px;
  padding-right: 15px;
}

#kcyxfehquq .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 15px;
  padding-right: 15px;
  vertical-align: top;
}

#kcyxfehquq .gt_row_group_first td {
  border-top-width: 2px;
}

#kcyxfehquq .gt_row_group_first th {
  border-top-width: 2px;
}

#kcyxfehquq .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
}

#kcyxfehquq .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#kcyxfehquq .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#kcyxfehquq .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#kcyxfehquq .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
}

#kcyxfehquq .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#kcyxfehquq .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#kcyxfehquq .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#kcyxfehquq .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#kcyxfehquq .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#kcyxfehquq .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 15px;
  padding-right: 15px;
}

#kcyxfehquq .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#kcyxfehquq .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 15px;
  padding-right: 15px;
}

#kcyxfehquq .gt_left {
  text-align: left;
}

#kcyxfehquq .gt_center {
  text-align: center;
}

#kcyxfehquq .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#kcyxfehquq .gt_font_normal {
  font-weight: normal;
}

#kcyxfehquq .gt_font_bold {
  font-weight: bold;
}

#kcyxfehquq .gt_font_italic {
  font-style: italic;
}

#kcyxfehquq .gt_super {
  font-size: 65%;
}

#kcyxfehquq .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#kcyxfehquq .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#kcyxfehquq .gt_indent_1 {
  text-indent: 5px;
}

#kcyxfehquq .gt_indent_2 {
  text-indent: 10px;
}

#kcyxfehquq .gt_indent_3 {
  text-indent: 15px;
}

#kcyxfehquq .gt_indent_4 {
  text-indent: 20px;
}

#kcyxfehquq .gt_indent_5 {
  text-indent: 25px;
}

#kcyxfehquq .katex-display {
  display: inline-flex !important;
  margin-bottom: 0.75em !important;
}
</style>
<table class="gt_table do-not-create-environment cell no-stripe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<colgroup>
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
</colgroup>
<thead>
<tr class="gt_col_headings gt_spanner_row header">
<th class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" style="text-align: center; font-style: italic; font-style: italic; font-style: italic;" scope="col"></th>
<th colspan="2" id="Confounders" class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" style="text-align: center; font-style: italic; font-style: italic; font-style: italic;" scope="colgroup"><span class="gt_column_spanner">Confounders</span></th>
<th id="Treatment" class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" style="text-align: center; font-style: italic; font-style: italic; font-style: italic;" scope="col"><span class="gt_column_spanner">Treatment</span></th>
<th id="Realized" class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" style="text-align: center; font-style: italic; font-style: italic; font-style: italic;" scope="col"><span class="gt_column_spanner">Realized</span></th>
</tr>
<tr class="gt_col_headings gt_spanner_row even">
<th rowspan="2" id="ID" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;" scope="col">ID</th>
<th id="Income" class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;" scope="col"><span class="gt_column_spanner">Income</span></th>
<th id="Health" class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;" scope="col"><span class="gt_column_spanner">Health</span></th>
<th id="Net use" class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;" scope="col"><span class="gt_column_spanner">Net use</span></th>
<th id="Outcome" class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" style="text-align: center; font-weight: bold;" scope="col"><span class="gt_column_spanner">Outcome</span></th>
</tr>
<tr class="gt_col_headings header">
<th id="<div data-qmd=&quot;$Z_{1_i}$&quot;><div class='gt_from_md'><p>\(Z_{1_i}\)</p>
</div></div>" class="gt_col_heading gt_columns_bottom_border gt_right" style="text-align: center;" data-quarto-table-cell-role="th" scope="col"><p><span class="math inline">\(Z_{1_i}\)</span></p></th>
<th id="<div data-qmd=&quot;$Z_{2_i}$&quot;><div class='gt_from_md'><p>\(Z_{2_i}\)</p>
</div></div>" class="gt_col_heading gt_columns_bottom_border gt_right" style="text-align: center;" data-quarto-table-cell-role="th" scope="col"><p><span class="math inline">\(Z_{2_i}\)</span></p></th>
<th id="<div data-qmd=&quot;$X_i$&quot;><div class='gt_from_md'><p>\(X_i\)</p>
</div></div>" class="gt_col_heading gt_columns_bottom_border gt_right" style="text-align: center;" data-quarto-table-cell-role="th" scope="col"><p><span class="math inline">\(X_i\)</span></p></th>
<th id="<div data-qmd=&quot;$Y_i$&quot;><div class='gt_from_md'><p>\(Y_i\)</p>
</div></div>" class="gt_col_heading gt_columns_bottom_border gt_right" style="text-align: center;" data-quarto-table-cell-role="th" scope="col"><p><span class="math inline">\(Y_i\)</span></p></th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_right" headers="id" style="text-align: center; background-color: rgba(255,204,61,0.5);">3</td>
<td class="gt_row gt_right" headers="income" style="text-align: center; background-color: rgba(255,204,61,0.5);">608</td>
<td class="gt_row gt_right" headers="health" style="text-align: center; background-color: rgba(255,204,61,0.5);">54</td>
<td class="gt_row gt_right" headers="net" style="text-align: center; background-color: rgba(255,204,61,0.5);">1</td>
<td class="gt_row gt_right" headers="malaria_risk" style="text-align: center; background-color: rgba(255,204,61,0.5);">34.9</td>
</tr>
<tr class="even">
<td class="gt_row gt_right" style="text-align: center;" headers="id">4</td>
<td class="gt_row gt_right" style="text-align: center;" headers="income">265</td>
<td class="gt_row gt_right" style="text-align: center;" headers="health">21</td>
<td class="gt_row gt_right" style="text-align: center;" headers="net">0</td>
<td class="gt_row gt_right" style="text-align: center;" headers="malaria_risk">82.8</td>
</tr>
<tr class="odd">
<td class="gt_row gt_right" headers="id" style="text-align: center; background-color: rgba(255,204,61,0.5);">14</td>
<td class="gt_row gt_right" headers="income" style="text-align: center; background-color: rgba(255,204,61,0.5);">506</td>
<td class="gt_row gt_right" headers="health" style="text-align: center; background-color: rgba(255,204,61,0.5);">58</td>
<td class="gt_row gt_right" headers="net" style="text-align: center; background-color: rgba(255,204,61,0.5);">1</td>
<td class="gt_row gt_right" headers="malaria_risk" style="text-align: center; background-color: rgba(255,204,61,0.5);">22.5</td>
</tr>
<tr class="even">
<td class="gt_row gt_right" headers="id" style="text-align: center; background-color: rgba(255,204,61,0.5);">15</td>
<td class="gt_row gt_right" headers="income" style="text-align: center; background-color: rgba(255,204,61,0.5);">596</td>
<td class="gt_row gt_right" headers="health" style="text-align: center; background-color: rgba(255,204,61,0.5);">62</td>
<td class="gt_row gt_right" headers="net" style="text-align: center; background-color: rgba(255,204,61,0.5);">1</td>
<td class="gt_row gt_right" headers="malaria_risk" style="text-align: center; background-color: rgba(255,204,61,0.5);">43.0</td>
</tr>
<tr class="odd">
<td class="gt_row gt_right" headers="id" style="text-align: center; background-color: rgba(255,204,61,0.5);">29</td>
<td class="gt_row gt_right" headers="income" style="text-align: center; background-color: rgba(255,204,61,0.5);">498</td>
<td class="gt_row gt_right" headers="health" style="text-align: center; background-color: rgba(255,204,61,0.5);">61</td>
<td class="gt_row gt_right" headers="net" style="text-align: center; background-color: rgba(255,204,61,0.5);">1</td>
<td class="gt_row gt_right" headers="malaria_risk" style="text-align: center; background-color: rgba(255,204,61,0.5);">40.0</td>
</tr>
<tr class="even">
<td class="gt_row gt_right" style="text-align: center;" headers="id">35</td>
<td class="gt_row gt_right" style="text-align: center;" headers="income">337</td>
<td class="gt_row gt_right" style="text-align: center;" headers="health">42</td>
<td class="gt_row gt_right" style="text-align: center;" headers="net">0</td>
<td class="gt_row gt_right" style="text-align: center;" headers="malaria_risk">68.0</td>
</tr>
<tr class="odd">
<td class="gt_row gt_right" style="text-align: center;" headers="id">37</td>
<td class="gt_row gt_right" style="text-align: center;" headers="income">282</td>
<td class="gt_row gt_right" style="text-align: center;" headers="health">28</td>
<td class="gt_row gt_right" style="text-align: center;" headers="net">0</td>
<td class="gt_row gt_right" style="text-align: center;" headers="malaria_risk">59.4</td>
</tr>
<tr class="even">
<td class="gt_row gt_right" style="text-align: center;" headers="id">73</td>
<td class="gt_row gt_right" style="text-align: center;" headers="income">463</td>
<td class="gt_row gt_right" style="text-align: center;" headers="health">37</td>
<td class="gt_row gt_right" style="text-align: center;" headers="net">0</td>
<td class="gt_row gt_right" style="text-align: center;" headers="malaria_risk">59.4</td>
</tr>
<tr class="odd">
<td class="gt_row gt_right" style="text-align: center;" headers="id">…</td>
<td class="gt_row gt_right" style="text-align: center;" headers="income">…</td>
<td class="gt_row gt_right" style="text-align: center;" headers="health">…</td>
<td class="gt_row gt_right" style="text-align: center;" headers="net">…</td>
<td class="gt_row gt_right" style="text-align: center;" headers="malaria_risk">…</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</figure>
</div>
</div>
<p><span class="math inline">\(\delta_i\)</span> is gone; we only have <span class="math inline">\(Y_i\)</span>. Instead of comparing and finding the differences between individuals and their parallel selves, we need to find the differences between treated and untreated people <em>while removing the selection bias and confounding caused by income and health</em>.</p>
<p>In the initial example in <a href="#tbl-basic-po" class="quarto-xref">Table&nbsp;1</a>, there was just one confounder (old vs.&nbsp;young), and we adjusted for it by stratifying by age, combining the weighted averages for old and young people. Basic stratification like that is a lot harder to do here. Both income and health are continuous—we can’t just find weighted averages of rich vs.&nbsp;poor and sick vs.&nbsp;healthy people. We’ve got to do something fancier to make comparable comparison groups, like matching or weighting.</p>
<p>Importantly, <strong>we have to match or weight in a way that is appropriate to the estimand we care about.</strong> The matching procedure that we follow for finding the ATE can’t be used for finding the ATT; the weighting process that we use for the ATU is different from what we use for the ATE. This is the main argument in <span class="citation" data-cites="GreiferStuart:2023">Greifer and Stuart (<a href="#ref-GreiferStuart:2023" role="doc-biblioref">2023</a>)</span>—the choice of estimand determines the process of statistical adjustment.</p>
<p>Noah Greifer has two incredible parallel guides to doing this adjustment with both <a href="https://ngreifer.github.io/WeightIt/articles/estimating-effects.html">weighting with {WeightIt}</a> and <a href="https://kosukeimai.github.io/MatchIt/articles/estimating-effects.html">matching with {MatchIt}</a>. We’ll illustrate this with propensity score weighting, but the same principles apply to matching (and the code is almost identical!)</p>
<p>Covering the exact mechanics of probability weighting goes beyond the scope of this blog post! Check out these resources to learn more:</p>
<ul>
<li>Chapter 12 in <span class="citation" data-cites="HernanRobins:2024">Hernán and Robins (<a href="#ref-HernanRobins:2024" role="doc-biblioref">2024</a>)</span>
</li>
<li>Section 10.7 in <span class="citation" data-cites="Heiss:2021">Heiss (<a href="#ref-Heiss:2021" role="doc-biblioref">2021</a>)</span>
</li>
<li>Lucy D’Agostino McGowan’s <a href="https://livefreeordichotomize.com/posts/2019-01-17-understanding-propensity-score-weighting/">“Understanding propensity score weighting”</a>
</li>
<li>Noah Greifer’s {WeightIt} vignette, <a href="https://ngreifer.github.io/WeightIt/articles/estimating-effects.html">“Estimating Effects After Weighting”</a>
</li>
<li>My <a href="https://evalsp24.classes.andrewheiss.com/example/matching-ipw.html">guide to matching and inverse probability weighting</a> from my causal inference class and <a href="https://evalsp24.classes.andrewheiss.com/content/07-content.html">the corresponding lecture video</a>
</li>
</ul>
<p>In general, with weighting we use confounders to predict the probability of choosing treatment, and then use these propensity scores to reweight the treated and untreated groups so that they resemble each other, thus removing any influence that the confounders have on the choice to select into treatment. My mental model of weighting is that we create pseudo-populations of treated and untreated people that feel like what would happen if we had randomly assigned everyone to treatment or control conditions—it’s like creating fake treatment and control groups.</p>
<section id="ate-1" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="ate-1">ATE</h3>
<p>To find the ATE, we need to adjust both the treated and untreated groups so that they are comparable. The most common way to do this is to create inverse probability weights, where all treated people get a weight of <span class="math inline">\(\frac{1}{p_i}\)</span> and all untreated people get a weight of <span class="math inline">\(\frac{1}{1 - p_i}\)</span> (where <span class="math inline">\(p_i\)</span> refers to each person’s propensity scores).</p>
<p>Practically speaking, this gives more weight to more unusual and unexpected observations. For instance, someone with a high predicted probability (90%) of choosing to use a net who then uses a net isn’t really notable and will have a low weight (<span class="math inline">\(\frac{1}{0.9}\)</span>, or 1.111). Someone else with a high probability (90% again) of choosing a net who <em>doesn’t</em> use a net will have a high weight (<span class="math inline">\(\frac{1}{1 - 0.9}\)</span>, or 10). This makes it so that the should-have-probably-used-a-net person is more comparable to the corresponding untreated people.</p>
<p>Visualization helps a lot with this intuition!</p>
<p>First, we’ll use logistic regression to calculate the predicted probabilities of using a net. We’ll then create inverse probability weights with this formula, which uses the fact that <code>net</code> is stored as 0 or 1 to assign the correct treated vs.&nbsp;untreated weight:</p>
<p><span class="math display">\[
\frac{\text{Treatment}}{\text{Propensity}} + \frac{1 - \text{Treatment}}{1 - \text{Propensity}}
\]</span></p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Logistic regression model to predict net usage</span></span>
<span><span class="va">model_treatment</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span></span>
<span>  <span class="va">net</span> <span class="op">~</span> <span class="va">income</span> <span class="op">+</span> <span class="va">health</span>, </span>
<span>  data <span class="op">=</span> <span class="va">nets</span>, </span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">binomial</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"logit"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plug original data into the model to generate predicted probabilities</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># (Here I'm using broom::augment_columns(), but you can also use </span></span>
<span><span class="co">#  marginaleffects::predictions() or even base R's predict())</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Create a new column for the weights</span></span>
<span><span class="va">nets_with_weights</span> <span class="op">&lt;-</span> <span class="fu">augment_columns</span><span class="op">(</span></span>
<span>  <span class="va">model_treatment</span>,</span>
<span>  data <span class="op">=</span> <span class="va">nets</span>,</span>
<span>  type.predict <span class="op">=</span> <span class="st">"response"</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">rename</span><span class="op">(</span>propensity <span class="op">=</span> <span class="va">.fitted</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>wts_ate <span class="op">=</span> <span class="op">(</span><span class="va">net</span> <span class="op">/</span> <span class="va">propensity</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">net</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">propensity</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># See if it worked</span></span>
<span><span class="va">nets_with_weights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">id</span>, <span class="va">income</span>, <span class="va">health</span>, <span class="va">net</span>, <span class="va">malaria_risk</span>, <span class="va">propensity</span>, <span class="va">wts_ate</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 1,500 × 7</span></span>
<span><span class="co">##       id income health   net malaria_risk propensity wts_ate</span></span>
<span><span class="co">##    &lt;int&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;int&gt;        &lt;dbl&gt;      &lt;dbl&gt;   &lt;dbl&gt;</span></span>
<span><span class="co">##  1     1    379     56     0         50.1     0.393     1.65</span></span>
<span><span class="co">##  2     2    528     39     0         59.4     0.427     1.75</span></span>
<span><span class="co">##  3     3    608     54     1         34.9     0.760     1.32</span></span>
<span><span class="co">##  4     4    265     21     0         82.8     0.0368    1.04</span></span>
<span><span class="co">##  5     5    543     51     0         42.5     0.622     2.65</span></span>
<span><span class="co">##  6     6    551     51     1         38.9     0.636     1.57</span></span>
<span><span class="co">##  7     7    443     49     1         43.5     0.412     2.43</span></span>
<span><span class="co">##  8     8    445     32     1         56.1     0.213     4.69</span></span>
<span><span class="co">##  9     9    444     39     1         48       0.286     3.50</span></span>
<span><span class="co">## 10    10    411     36     1         41.1     0.209     4.78</span></span>
<span><span class="co">## # ℹ 1,490 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Alternatively, we can use the {WeightIt} package to do the same thing:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Get ATE-focused weights for the treatment model</span></span>
<span><span class="va">weights_ate</span> <span class="op">&lt;-</span> <span class="fu">weightit</span><span class="op">(</span></span>
<span>  <span class="va">net</span> <span class="op">~</span> <span class="va">income</span> <span class="op">+</span> <span class="va">health</span>, </span>
<span>  data <span class="op">=</span> <span class="va">nets</span>, </span>
<span>  method <span class="op">=</span> <span class="st">"glm"</span>, </span>
<span>  estimand <span class="op">=</span> <span class="st">"ATE"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add the weights as a column in the data</span></span>
<span><span class="va">nets_with_weights</span><span class="op">$</span><span class="va">wts_ate_automatic</span> <span class="op">&lt;-</span> <span class="va">weights_ate</span><span class="op">$</span><span class="va">weights</span></span>
<span></span>
<span><span class="co"># They're the same!</span></span>
<span><span class="va">nets_with_weights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">id</span>, <span class="va">wts_ate</span>, <span class="va">wts_ate_automatic</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 6 × 3</span></span>
<span><span class="co">##      id wts_ate wts_ate_automatic</span></span>
<span><span class="co">##   &lt;int&gt;   &lt;dbl&gt;             &lt;dbl&gt;</span></span>
<span><span class="co">## 1     1    1.65              1.65</span></span>
<span><span class="co">## 2     2    1.75              1.75</span></span>
<span><span class="co">## 3     3    1.32              1.32</span></span>
<span><span class="co">## 4     4    1.04              1.04</span></span>
<span><span class="co">## 5     5    2.65              2.65</span></span>
<span><span class="co">## 6     6    1.57              1.57</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s copy <a href="https://livefreeordichotomize.com/posts/2019-01-17-understanding-propensity-score-weighting/">Lucy D’Agostino McGowan’s approach</a> and visualize the distribution of these propensity scores across treatment status:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">plot_data_weights_ate</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span></span>
<span>  propensity <span class="op">=</span> <span class="va">weights_ate</span><span class="op">$</span><span class="va">ps</span>,</span>
<span>  weight <span class="op">=</span> <span class="va">weights_ate</span><span class="op">$</span><span class="va">weights</span>,</span>
<span>  treatment <span class="op">=</span> <span class="va">weights_ate</span><span class="op">$</span><span class="va">treat</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">plot_data_weights_ate</span>, <span class="va">treatment</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>, </span>
<span>    bins <span class="op">=</span> <span class="fl">50</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">propensity</span>, fill <span class="op">=</span> <span class="st">"Treated people"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">plot_data_weights_ate</span>, <span class="va">treatment</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span>, </span>
<span>    bins <span class="op">=</span> <span class="fl">50</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">propensity</span>, y <span class="op">=</span> <span class="op">-</span><span class="fu">after_stat</span><span class="op">(</span><span class="va">count</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">"Untreated people"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, color <span class="op">=</span> <span class="st">"white"</span>, linewidth <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu">label_percent</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>label <span class="op">=</span> <span class="va">abs</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">clrs</span><span class="op">[</span><span class="fl">6</span><span class="op">]</span><span class="op">)</span>, guide <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>reverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Propensity"</span>, y <span class="op">=</span> <span class="st">"Count"</span>, fill <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">"top"</span>,</span>
<span>    legend.key.size <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0.65</span>, <span class="st">"lines"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div id="fig-propensity-treated-untreated" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure page-columns page-full"><div aria-describedby="fig-propensity-treated-untreated-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_files/figure-html/fig-propensity-treated-untreated-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%">
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-propensity-treated-untreated-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Mirrored histogram showing the distribution of propensity scores for treated and untreated people
</figcaption></figure>
</div>
</div>
</div>
<p>In general, the people who used nets had a higher probability of using them, while the people who didn’t use nets had a lower probability of using them. That’s to be expected.</p>
<p>But there are some people who had a low probability of using nets who <em>did</em> use them, and some people who had a high probability of using nets who <em>did not</em> use them. That’s curious and weird. These people are arguably very similar (i.e.&nbsp;with similar income and health), but for whatever reason, they didn’t do what the model predicted they should do.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">plot_data_weights_ate</span>, <span class="va">treatment</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>, </span>
<span>    bins <span class="op">=</span> <span class="fl">50</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">propensity</span>, fill <span class="op">=</span> <span class="st">"Treated people"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">plot_data_weights_ate</span>, <span class="va">treatment</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span>, </span>
<span>    bins <span class="op">=</span> <span class="fl">50</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">propensity</span>, y <span class="op">=</span> <span class="op">-</span><span class="fu">after_stat</span><span class="op">(</span><span class="va">count</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">"Untreated people"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">annotate</span><span class="op">(</span></span>
<span>    geom <span class="op">=</span> <span class="st">"rect"</span>, xmin <span class="op">=</span> <span class="fl">0</span>, xmax <span class="op">=</span> <span class="fl">0.55</span>, ymin <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, ymax <span class="op">=</span> <span class="fl">23</span>,</span>
<span>    fill <span class="op">=</span> <span class="fu">alpha</span><span class="op">(</span><span class="va">clrs</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, <span class="fl">0.1</span><span class="op">)</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, linewidth <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">annotate</span><span class="op">(</span></span>
<span>    geom <span class="op">=</span> <span class="st">"text"</span>, x <span class="op">=</span> <span class="fl">0.01</span>, y <span class="op">=</span> <span class="fl">21.5</span>, </span>
<span>    label <span class="op">=</span> <span class="st">"Treated people who were\nunlikely to be treated.\nWeird!"</span>,</span>
<span>    color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, fontface <span class="op">=</span> <span class="st">"bold"</span>, hjust <span class="op">=</span> <span class="fl">0</span>, vjust <span class="op">=</span> <span class="fl">1</span>, lineheight <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">annotate</span><span class="op">(</span></span>
<span>    geom <span class="op">=</span> <span class="st">"rect"</span>, xmin <span class="op">=</span> <span class="fl">0.58</span>, xmax <span class="op">=</span> <span class="fl">1</span>, ymin <span class="op">=</span> <span class="fl">1</span>, ymax <span class="op">=</span> <span class="op">-</span><span class="fl">27.5</span>,</span>
<span>    fill <span class="op">=</span> <span class="fu">alpha</span><span class="op">(</span><span class="va">clrs</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, <span class="fl">0.1</span><span class="op">)</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, linewidth <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">annotate</span><span class="op">(</span></span>
<span>    geom <span class="op">=</span> <span class="st">"text"</span>, x <span class="op">=</span> <span class="fl">0.99</span>, y <span class="op">=</span> <span class="op">-</span><span class="fl">26</span>, </span>
<span>    label <span class="op">=</span> <span class="st">"Weird!\nUntreated people who\nwere likely to be treated."</span>,</span>
<span>    color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, fontface <span class="op">=</span> <span class="st">"bold"</span>, hjust <span class="op">=</span> <span class="fl">1</span>, vjust <span class="op">=</span> <span class="fl">0</span>, lineheight <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, color <span class="op">=</span> <span class="st">"white"</span>, linewidth <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu">label_percent</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>label <span class="op">=</span> <span class="va">abs</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">clrs</span><span class="op">[</span><span class="fl">6</span><span class="op">]</span><span class="op">)</span>, guide <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>reverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Propensity"</span>, y <span class="op">=</span> <span class="st">"Count"</span>, fill <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">"top"</span>,</span>
<span>    legend.key.size <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0.65</span>, <span class="st">"lines"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div id="fig-propensity-weird-highlight" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure page-columns page-full"><div aria-describedby="fig-propensity-weird-highlight-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_files/figure-html/fig-propensity-weird-highlight-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%">
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-propensity-weird-highlight-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Mirrored histogram showing “weird” parts of the population: treated people who were unlikely to be treated, and untreated people who were likely to be treated
</figcaption></figure>
</div>
</div>
</div>
<p>If we scale everyone’s importance according to their inverse probability weights, we can give more importance to these “weird” untreated-but-should-have-been-treated and treated-but-shouldn’t-have-been-treated people, making them more balanced compared to their treated-and-should-have-been-treated and untreated-and-should-have-been-untreated counterparts. The fainter histogram here represents the adjusted and reweighted pseudo-populations of net users and non-net users. These two pseudo-populations are now free of the confounding coming from health and income and are arguably more comparable, acting more like randomized treatment and control groups.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">plot_data_weights_ate</span>, <span class="va">treatment</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>, </span>
<span>    bins <span class="op">=</span> <span class="fl">50</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">propensity</span>, weight <span class="op">=</span> <span class="va">weight</span>, fill <span class="op">=</span> <span class="st">"Treated pseudo-population"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">plot_data_weights_ate</span>, <span class="va">treatment</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span>, </span>
<span>    bins <span class="op">=</span> <span class="fl">50</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">propensity</span>, weight <span class="op">=</span> <span class="va">weight</span>, y <span class="op">=</span> <span class="op">-</span><span class="fu">after_stat</span><span class="op">(</span><span class="va">count</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">"Untreated psuedo-population"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">plot_data_weights_ate</span>, <span class="va">treatment</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>, </span>
<span>    bins <span class="op">=</span> <span class="fl">50</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">propensity</span>, fill <span class="op">=</span> <span class="st">"Treated people"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">plot_data_weights_ate</span>, <span class="va">treatment</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span>, </span>
<span>    bins <span class="op">=</span> <span class="fl">50</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">propensity</span>, y <span class="op">=</span> <span class="op">-</span><span class="fu">after_stat</span><span class="op">(</span><span class="va">count</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">"Untreated people"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">annotate</span><span class="op">(</span></span>
<span>    geom <span class="op">=</span> <span class="st">"text"</span>, x <span class="op">=</span> <span class="fl">0.5</span>, y <span class="op">=</span> <span class="fl">60</span>, label <span class="op">=</span> <span class="st">"More weight here"</span>, </span>
<span>    hjust <span class="op">=</span> <span class="fl">0.5</span>, fontface <span class="op">=</span> <span class="st">"bold"</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">annotate</span><span class="op">(</span></span>
<span>    geom <span class="op">=</span> <span class="st">"segment"</span>, x <span class="op">=</span> <span class="fl">0.48</span>, xend <span class="op">=</span> <span class="fl">0.17</span>, y <span class="op">=</span> <span class="fl">55</span>, yend <span class="op">=</span> <span class="fl">25</span>, color <span class="op">=</span> <span class="st">"white"</span>, </span>
<span>    arrow <span class="op">=</span> <span class="fu">arrow</span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">15</span>, length <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0.5</span>, <span class="st">"lines"</span><span class="op">)</span><span class="op">)</span>, linewidth <span class="op">=</span> <span class="fl">2.5</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">annotate</span><span class="op">(</span></span>
<span>    geom <span class="op">=</span> <span class="st">"segment"</span>, x <span class="op">=</span> <span class="fl">0.48</span>, xend <span class="op">=</span> <span class="fl">0.17</span>, y <span class="op">=</span> <span class="fl">55</span>, yend <span class="op">=</span> <span class="fl">25</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, </span>
<span>    arrow <span class="op">=</span> <span class="fu">arrow</span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">15</span>, length <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0.5</span>, <span class="st">"lines"</span><span class="op">)</span><span class="op">)</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">annotate</span><span class="op">(</span></span>
<span>    geom <span class="op">=</span> <span class="st">"segment"</span>, x <span class="op">=</span> <span class="fl">0.52</span>, xend <span class="op">=</span> <span class="fl">0.8</span>, y <span class="op">=</span> <span class="fl">55</span>, yend <span class="op">=</span> <span class="op">-</span><span class="fl">20</span>, color <span class="op">=</span> <span class="st">"white"</span>, </span>
<span>    arrow <span class="op">=</span> <span class="fu">arrow</span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">15</span>, length <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0.5</span>, <span class="st">"lines"</span><span class="op">)</span><span class="op">)</span>, linewidth <span class="op">=</span> <span class="fl">2.5</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">annotate</span><span class="op">(</span></span>
<span>    geom <span class="op">=</span> <span class="st">"segment"</span>, x <span class="op">=</span> <span class="fl">0.52</span>, xend <span class="op">=</span> <span class="fl">0.8</span>, y <span class="op">=</span> <span class="fl">55</span>, yend <span class="op">=</span> <span class="op">-</span><span class="fl">20</span>, color <span class="op">=</span> <span class="va">clrs</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, </span>
<span>    arrow <span class="op">=</span> <span class="fu">arrow</span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">15</span>, length <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0.5</span>, <span class="st">"lines"</span><span class="op">)</span><span class="op">)</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, color <span class="op">=</span> <span class="st">"white"</span>, linewidth <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu">label_percent</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>label <span class="op">=</span> <span class="va">abs</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span></span>
<span>    values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="fu">colorspace</span><span class="fu">::</span><span class="fu">lighten</span><span class="op">(</span><span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="fl">0.5</span><span class="op">)</span>, <span class="va">clrs</span><span class="op">[</span><span class="fl">6</span><span class="op">]</span>, <span class="fu">colorspace</span><span class="fu">::</span><span class="fu">lighten</span><span class="op">(</span><span class="va">clrs</span><span class="op">[</span><span class="fl">6</span><span class="op">]</span>, <span class="fl">0.65</span><span class="op">)</span><span class="op">)</span>, </span>
<span>    guide <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>reverse <span class="op">=</span> <span class="cn">FALSE</span>, nrow <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Propensity"</span>, y <span class="op">=</span> <span class="st">"Count"</span>, fill <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">"top"</span>,</span>
<span>    legend.key.size <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0.65</span>, <span class="st">"lines"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div id="fig-propensity-weighted-ate" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure page-columns page-full"><div aria-describedby="fig-propensity-weighted-ate-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_files/figure-html/fig-propensity-weighted-ate-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%">
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-propensity-weighted-ate-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Mirrored histogram showing pseudo-populations of treated and untreated people that have been reweighted to be more comparable and unconfounded
</figcaption></figure>
</div>
</div>
</div>
<p>To find the ATE using these weights, we can fit a regression model for the outcome. We’ll then use an approach called <a href="https://ngreifer.github.io/WeightIt/articles/estimating-effects.html#g-computation"><em>g-computation</em></a> to find the marginal causal effect (i.e.&nbsp;the causal effect of flipping net from “no” to “yes”). G-computation is a neat approach that feels more like the original potential outcomes framework we looked at earlier. It involves a few steps:</p>
<ol type="1">
<li>Fit a regression model predicting the outcome, like <code>lm(malaria_risk ~ net, weights = w_ate, ...)</code>
</li>
<li>Use the model to generate a set of predictions where we pretend that every person used a net (i.e.&nbsp;set <code>net = 1</code>)</li>
<li>Use the model to generate a set of predictions where we pretend that every person did not use a net (i.e.&nbsp;set <code>net = 0</code>)</li>
<li>Calculate the difference in the two sets of predictions to create a sort of predicted individual causal effect, then find the average of <em>that</em>. This is the ATE.</li>
</ol>
<p>That looks really complicated and involved and feels like a lot of coding work, but {marignaleffects} makes this incredibly easy (there’s even <a href="https://marginaleffects.com/vignettes/gcomputation.html">a chapter dedicated to it in the documentation</a>). Basically, all we have to do is use <code>avg_comparisons(model_outcome, variables = list(net = 0:1))</code>, or even more simply <code>avg_comparisons(model_outcome, variables = "net")</code>. This will do all the work of setting everyone’s treatment to 0, to 1, and finding the difference. We can do fancier things with it too, like finding robust and/or clustered standard errors, or <a href="https://ngreifer.github.io/WeightIt/articles/estimating-effects.html#using-bootstrapping-to-estimate-confidence-intervals">bootstrapping the standard errors</a>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Fit an outcome model using the inverse probability weights</span></span>
<span><span class="va">model_outcome_ate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span></span>
<span>  <span class="va">malaria_risk</span> <span class="op">~</span> <span class="va">net</span>, </span>
<span>  data <span class="op">=</span> <span class="va">nets_with_weights</span>, </span>
<span>  weights <span class="op">=</span> <span class="va">wts_ate_automatic</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Automatic g-computation with {marginaleffects}! This sets the "net" column to</span></span>
<span><span class="co"># each possible value of net (0 and 1) for the whole dataset, then calculates</span></span>
<span><span class="co"># the difference between the two sets of predictions</span></span>
<span><span class="fu">avg_comparisons</span><span class="op">(</span><span class="va">model_outcome_ate</span>, variables <span class="op">=</span> <span class="st">"net"</span><span class="op">)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##  Term Contrast Estimate Std. Error     z Pr(&gt;|z|)     S 2.5 % 97.5 %</span></span>
<span><span class="co">##   net    1 - 0    -14.7      0.559 -26.2   &lt;0.001 500.6 -15.8  -13.6</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Columns: term, contrast, estimate, std.error, statistic, p.value, s.value, conf.low, conf.high </span></span>
<span><span class="co">## Type:  response</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Based on our inverse probability weighting approach, the ATE from observational data (i.e.&nbsp;not using the unknowable individual potential outcomes) is −14.7, which is super close to the true ATE of −15.0!</p>
</section><section id="att-1" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="att-1">ATT</h3>
<p>That ATE shows the effect of the net program for <em>everyone</em>, even people who have no need for a net. If we’re interested in making this a universal program, the ATE is useful. If we’re interested in what the program is currently doing for people using it, or what would happen if we expanded it to just those not using it, we’d need to find the ATT or ATU instead.</p>
<p>We can do this with matching and weighting, but <em>we cannot use the same matching and weighting that we used to find the ATE.</em> When reweighting the data for estimating the ATT, we should not do anything that messes with the weights of the treated group. Since we’re interested in the effect of the program on just the treated people, we need to create a pseudo-control group that looks like the treated group. There are lots of different ways to do this (and <span class="citation" data-cites="GreiferStuart:2023">Greifer and Stuart (<a href="#ref-GreiferStuart:2023" role="doc-biblioref">2023</a>)</span> cover them). One common way is to give a weight of 1 to all the treated people and a weight of <span class="math inline">\(\frac{p_i}{1 - p_i}\)</span> for all the untreated people.</p>
<p>The process is the same—fit a model that predicts if people use a net, use those predictions to generate weights, then fit an outcome model using those weights. With the ATT-specific weights, we’ll create an untreated pseudo-population that is statistically comparable (and unconfounded) in relation to the actually treated population.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Get ATT-focused weights for the treatment model</span></span>
<span><span class="va">weights_att</span> <span class="op">&lt;-</span> <span class="fu">weightit</span><span class="op">(</span></span>
<span>  <span class="va">net</span> <span class="op">~</span> <span class="va">income</span> <span class="op">+</span> <span class="va">health</span>, </span>
<span>  data <span class="op">=</span> <span class="va">nets</span>, </span>
<span>  method <span class="op">=</span> <span class="st">"glm"</span>, </span>
<span>  estimand <span class="op">=</span> <span class="st">"ATT"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add the weights as a column in the data</span></span>
<span><span class="va">nets_with_weights</span><span class="op">$</span><span class="va">wts_att</span> <span class="op">&lt;-</span> <span class="va">weights_att</span><span class="op">$</span><span class="va">weights</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Our fancy weighted histogram looks like this:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">plot_data_weights_att</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span></span>
<span>  propensity <span class="op">=</span> <span class="va">weights_att</span><span class="op">$</span><span class="va">ps</span>,</span>
<span>  weight <span class="op">=</span> <span class="va">weights_att</span><span class="op">$</span><span class="va">weights</span>,</span>
<span>  treatment <span class="op">=</span> <span class="va">weights_att</span><span class="op">$</span><span class="va">treat</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">plot_data_weights_att</span>, <span class="va">treatment</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span>, </span>
<span>    bins <span class="op">=</span> <span class="fl">50</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">propensity</span>, weight <span class="op">=</span> <span class="va">weight</span>, y <span class="op">=</span> <span class="op">-</span><span class="fu">after_stat</span><span class="op">(</span><span class="va">count</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">"Untreated psuedo-population"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">plot_data_weights_att</span>, <span class="va">treatment</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>, </span>
<span>    bins <span class="op">=</span> <span class="fl">50</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">propensity</span>, fill <span class="op">=</span> <span class="st">"Treated people"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">plot_data_weights_att</span>, <span class="va">treatment</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span>, </span>
<span>    bins <span class="op">=</span> <span class="fl">50</span>, alpha <span class="op">=</span> <span class="fl">0.5</span>, </span>
<span>    <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">propensity</span>, y <span class="op">=</span> <span class="op">-</span><span class="fu">after_stat</span><span class="op">(</span><span class="va">count</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">"Untreated people"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, color <span class="op">=</span> <span class="st">"white"</span>, linewidth <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu">label_percent</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>label <span class="op">=</span> <span class="va">abs</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span></span>
<span>    values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">"grey50"</span>, <span class="fu">colorspace</span><span class="fu">::</span><span class="fu">lighten</span><span class="op">(</span><span class="va">clrs</span><span class="op">[</span><span class="fl">6</span><span class="op">]</span>, <span class="fl">0.65</span><span class="op">)</span><span class="op">)</span>, </span>
<span>    guide <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>reverse <span class="op">=</span> <span class="cn">FALSE</span>, nrow <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Propensity"</span>, y <span class="op">=</span> <span class="st">"Count"</span>, fill <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">"top"</span>,</span>
<span>    legend.key.size <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0.65</span>, <span class="st">"lines"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div id="fig-propensity-weighted-att" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure page-columns page-full"><div aria-describedby="fig-propensity-weighted-att-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_files/figure-html/fig-propensity-weighted-att-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%">
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-propensity-weighted-att-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: Mirrored histogram comparing the distribution of treated people with the reweighted pseudo-population of untreated people; because this is for the ATT, treated people were not reweighted
</figcaption></figure>
</div>
</div>
</div>
<p>The treated people are untouched—they all have a weight of 1, and we don’t mess with them. Untreated people with high probability of using a net are given more weight to make them look more like the treated people.</p>
<p>Fitting the outcome model is the same as finding the ATE—we’ll just use the special ATT weights:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Fit an outcome model using the ATT weights</span></span>
<span><span class="va">model_outcome_att</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span></span>
<span>  <span class="va">malaria_risk</span> <span class="op">~</span> <span class="va">net</span>, </span>
<span>  data <span class="op">=</span> <span class="va">nets_with_weights</span>, </span>
<span>  weights <span class="op">=</span> <span class="va">wts_att</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The main difference is that when we do the g-computation, we <em>only look at treated people</em>. Using only this part of the population, we’ll set all their values to 1, then set all their values to 0, and then find the difference.</p>
<p><strong>This is the key to finding the effect of the program only in the treated part of the population!</strong> Remember how when we had access to everyone’s individual causal effects, we were able to find the ATT by looking at the average of all the treated peoples’ <span class="math inline">\(\delta\)</span> column? G-computation lets us essentially recreate that process. Here’s how it works:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Do g-computation *only* on treated observations</span></span>
<span><span class="fu">avg_comparisons</span><span class="op">(</span></span>
<span>  <span class="va">model_outcome_att</span>, </span>
<span>  variables <span class="op">=</span> <span class="st">"net"</span>, </span>
<span>  newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">nets</span>, <span class="va">net</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##  Term Contrast Estimate Std. Error     z Pr(&gt;|z|)     S 2.5 % 97.5 %</span></span>
<span><span class="co">##   net    1 - 0    -17.6      0.497 -35.4   &lt;0.001 907.4 -18.5  -16.6</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Columns: term, contrast, estimate, std.error, statistic, p.value, s.value, conf.low, conf.high </span></span>
<span><span class="co">## Type:  response</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The estimated observational ATT is −17.6, which is (1) bigger than the ATE, as expected, and (2) close-ish to the true ATT of −16.3!</p>
</section><section id="atu-1" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="atu-1">ATU</h3>
<p>If we’re interested in what would happen if we expanded the program to people not using it, we can find the ATU. The process is the same as the ATT, just in reverse. We’ll create a pseudo-population of net users by giving a weight of 1 to all untreated people and giving a weight of <span class="math inline">\(\frac{1-p_i}{p_i}\)</span> to all treated people.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Get ATU-focused weights for the treatment model</span></span>
<span><span class="va">weights_atu</span> <span class="op">&lt;-</span> <span class="fu">weightit</span><span class="op">(</span></span>
<span>  <span class="va">net</span> <span class="op">~</span> <span class="va">income</span> <span class="op">+</span> <span class="va">health</span>, </span>
<span>  data <span class="op">=</span> <span class="va">nets</span>, </span>
<span>  method <span class="op">=</span> <span class="st">"glm"</span>, </span>
<span>  estimand <span class="op">=</span> <span class="st">"ATC"</span>  <span class="co"># WeightIt calls this ATC instead of ATU</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add the weights as a column in the data</span></span>
<span><span class="va">nets_with_weights</span><span class="op">$</span><span class="va">wts_atu</span> <span class="op">&lt;-</span> <span class="va">weights_atu</span><span class="op">$</span><span class="va">weights</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here’s what that looks like as a weighted histogram:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">plot_data_weights_atu</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span></span>
<span>  propensity <span class="op">=</span> <span class="va">weights_atu</span><span class="op">$</span><span class="va">ps</span>,</span>
<span>  weight <span class="op">=</span> <span class="va">weights_atu</span><span class="op">$</span><span class="va">weights</span>,</span>
<span>  treatment <span class="op">=</span> <span class="va">weights_atu</span><span class="op">$</span><span class="va">treat</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">plot_data_weights_atu</span>, <span class="va">treatment</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>, </span>
<span>    bins <span class="op">=</span> <span class="fl">50</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">propensity</span>, weight <span class="op">=</span> <span class="va">weight</span>, fill <span class="op">=</span> <span class="st">"Treated pseudo-population"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">plot_data_weights_atu</span>, <span class="va">treatment</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>, </span>
<span>    bins <span class="op">=</span> <span class="fl">50</span>, alpha <span class="op">=</span> <span class="fl">0.5</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">propensity</span>, fill <span class="op">=</span> <span class="st">"Treated people"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">plot_data_weights_atu</span>, <span class="va">treatment</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span>, </span>
<span>    bins <span class="op">=</span> <span class="fl">50</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">propensity</span>, y <span class="op">=</span> <span class="op">-</span><span class="fu">after_stat</span><span class="op">(</span><span class="va">count</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">"Untreated people"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, color <span class="op">=</span> <span class="st">"white"</span>, linewidth <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu">label_percent</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>label <span class="op">=</span> <span class="va">abs</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span></span>
<span>    values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"grey50"</span>, <span class="fu">colorspace</span><span class="fu">::</span><span class="fu">lighten</span><span class="op">(</span><span class="va">clrs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="fl">0.5</span><span class="op">)</span>, <span class="va">clrs</span><span class="op">[</span><span class="fl">6</span><span class="op">]</span>, <span class="fu">colorspace</span><span class="fu">::</span><span class="fu">lighten</span><span class="op">(</span><span class="va">clrs</span><span class="op">[</span><span class="fl">6</span><span class="op">]</span>, <span class="fl">0.65</span><span class="op">)</span><span class="op">)</span>, </span>
<span>    guide <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>reverse <span class="op">=</span> <span class="cn">FALSE</span>, nrow <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Propensity"</span>, y <span class="op">=</span> <span class="st">"Count"</span>, fill <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">"top"</span>,</span>
<span>    legend.key.size <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0.65</span>, <span class="st">"lines"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div id="fig-propensity-weighted-atu" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure page-columns page-full"><div aria-describedby="fig-propensity-weighted-atu-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_files/figure-html/fig-propensity-weighted-atu-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%">
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-propensity-weighted-atu-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7: Mirrored histogram comparing the distribution of untreated people with the reweighted pseudo-population of treated people; because this is for the ATU, untreated people were not reweighted
</figcaption></figure>
</div>
</div>
</div>
<p>The low-probability net users get a lot more weight so that they’re comparable to the untreated group.</p>
<p>The outcome model process is the same as before—we just use the ATU-specific weights. When doing the g-computation, we <em>only use untreated people</em>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Fit an outcome model using the ATU weights</span></span>
<span><span class="va">model_outcome_atu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span></span>
<span>  <span class="va">malaria_risk</span> <span class="op">~</span> <span class="va">net</span>, </span>
<span>  data <span class="op">=</span> <span class="va">nets_with_weights</span>, </span>
<span>  weights <span class="op">=</span> <span class="va">wts_atu</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Do g-computation *only* on untreated observations</span></span>
<span><span class="fu">avg_comparisons</span><span class="op">(</span></span>
<span>  <span class="va">model_outcome_atu</span>, </span>
<span>  variables <span class="op">=</span> <span class="st">"net"</span>, </span>
<span>  newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">nets</span>, <span class="va">net</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##  Term Contrast Estimate Std. Error   z Pr(&gt;|z|)     S 2.5 % 97.5 %</span></span>
<span><span class="co">##   net    1 - 0    -11.7      0.511 -23   &lt;0.001 385.0 -12.7  -10.7</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Columns: term, contrast, estimate, std.error, statistic, p.value, s.value, conf.low, conf.high </span></span>
<span><span class="co">## Type:  response</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The estimated observational ATU is −11.7, which is (1) smaller than the ATE, as expected, and (2) close-ish to the true ATU of −13.6!</p>
</section><section id="summary" class="level3"><h3 class="anchored" data-anchor-id="summary">Summary</h3>
<p>Finally, let’s show these estimands all together, with some basic interpretation of what they all mean:</p>
<div class="cell" data-layout-align="center">
<div id="tbl-summary" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-layout-align="center">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-summary-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;6: Summary of the three main estimands
</figcaption><div aria-describedby="tbl-summary-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<div id="dxxfqztmav" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#dxxfqztmav table {
  font-family: Jost, system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#dxxfqztmav thead, #dxxfqztmav tbody, #dxxfqztmav tfoot, #dxxfqztmav tr, #dxxfqztmav td, #dxxfqztmav th {
  border-style: none;
}

#dxxfqztmav p {
  margin: 0;
  padding: 0;
}

#dxxfqztmav .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#dxxfqztmav .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#dxxfqztmav .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 15px;
  padding-right: 15px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#dxxfqztmav .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 15px;
  padding-right: 15px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#dxxfqztmav .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#dxxfqztmav .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#dxxfqztmav .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#dxxfqztmav .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 15px;
  padding-right: 15px;
  overflow-x: hidden;
}

#dxxfqztmav .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#dxxfqztmav .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#dxxfqztmav .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#dxxfqztmav .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#dxxfqztmav .gt_spanner_row {
  border-bottom-style: hidden;
}

#dxxfqztmav .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#dxxfqztmav .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#dxxfqztmav .gt_from_md > :first-child {
  margin-top: 0;
}

#dxxfqztmav .gt_from_md > :last-child {
  margin-bottom: 0;
}

#dxxfqztmav .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#dxxfqztmav .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 15px;
  padding-right: 15px;
}

#dxxfqztmav .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 15px;
  padding-right: 15px;
  vertical-align: top;
}

#dxxfqztmav .gt_row_group_first td {
  border-top-width: 2px;
}

#dxxfqztmav .gt_row_group_first th {
  border-top-width: 2px;
}

#dxxfqztmav .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
}

#dxxfqztmav .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#dxxfqztmav .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#dxxfqztmav .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#dxxfqztmav .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
}

#dxxfqztmav .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#dxxfqztmav .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#dxxfqztmav .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#dxxfqztmav .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#dxxfqztmav .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#dxxfqztmav .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 15px;
  padding-right: 15px;
}

#dxxfqztmav .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#dxxfqztmav .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 15px;
  padding-right: 15px;
}

#dxxfqztmav .gt_left {
  text-align: left;
}

#dxxfqztmav .gt_center {
  text-align: center;
}

#dxxfqztmav .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#dxxfqztmav .gt_font_normal {
  font-weight: normal;
}

#dxxfqztmav .gt_font_bold {
  font-weight: bold;
}

#dxxfqztmav .gt_font_italic {
  font-style: italic;
}

#dxxfqztmav .gt_super {
  font-size: 65%;
}

#dxxfqztmav .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#dxxfqztmav .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#dxxfqztmav .gt_indent_1 {
  text-indent: 5px;
}

#dxxfqztmav .gt_indent_2 {
  text-indent: 10px;
}

#dxxfqztmav .gt_indent_3 {
  text-indent: 15px;
}

#dxxfqztmav .gt_indent_4 {
  text-indent: 20px;
}

#dxxfqztmav .gt_indent_5 {
  text-indent: 25px;
}

#dxxfqztmav .katex-display {
  display: inline-flex !important;
  margin-bottom: 0.75em !important;
}
</style>
<table class="gt_table do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead><tr class="gt_col_headings header">
<th id="Estimand" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="font-weight: bold" scope="col">Estimand</th>
<th id="True value" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" style="font-weight: bold" scope="col">True value</th>
<th id="Estimated value" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" style="font-weight: bold" scope="col">Estimated value</th>
<th id="Interpretation" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="font-weight: bold" scope="col">Interpretation</th>
<th id="Why care?" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="font-weight: bold" scope="col">Why care?</th>
</tr></thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="estimand" style="vertical-align: top">ATE</td>
<td class="gt_row gt_center" headers="true_value" style="vertical-align: top">−15.0</td>
<td class="gt_row gt_center" headers="estimated_value" style="vertical-align: top">−14.7</td>
<td class="gt_row gt_left" headers="interpretation" style="vertical-align: top">Using a mosquito net reduces the risk of malaria by 14.7 points, on average across all people in the country</td>
<td class="gt_row gt_left" headers="why" style="vertical-align: top">Helpful for understanding the effect of creating a widely applied policy or program, like rolling out subsidized mosquito nets for everyone in the country</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="estimand" style="vertical-align: top">ATT</td>
<td class="gt_row gt_center" headers="true_value" style="vertical-align: top">−16.3</td>
<td class="gt_row gt_center" headers="estimated_value" style="vertical-align: top">−17.6</td>
<td class="gt_row gt_left" headers="interpretation" style="vertical-align: top">People who currently use mosquito nets see a malaria risk reduction of 17.6 points, on average</td>
<td class="gt_row gt_left" headers="why" style="vertical-align: top">Helpful for understanding the effect of net usage on people who actually use them; this shows what would happen if we withheld the program or took away everyone's nets</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="estimand" style="vertical-align: top">ATU</td>
<td class="gt_row gt_center" headers="true_value" style="vertical-align: top">−13.6</td>
<td class="gt_row gt_center" headers="estimated_value" style="vertical-align: top">−11.7</td>
<td class="gt_row gt_left" headers="interpretation" style="vertical-align: top">People who don't currently use mosquito nets would see a malaria risk reduction of 11.7 points, on average</td>
<td class="gt_row gt_left" headers="why" style="vertical-align: top">Helpful for understanding the effect of net usage on people who don't use them right now; this shows what would happen if we expanded the program or gave nets to people without them</td>
</tr>
</tbody>
<tfoot class="gt_sourcenotes"><tr class="odd">
<td colspan="5" class="gt_sourcenote">Here, the fact that ATT &gt; ATE &gt; ATU implies selection bias; the program works more effectively among those who use it because they know it will help them</td>
</tr></tfoot>
</table>
</div>
</div>
</div>
</figure>
</div>
</div>
</section></section><section id="what-about-other-methods" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="what-about-other-methods">What about other methods?</h2>
<p>Awesome. For me, at least, this all makes a lot more sense. The ATE is not the final goal of all causal inference methods. The ATT is also a completely good and valid and policy relevant estimand—often more important than the ATE. I’ve long been confused about what the ATT actually means, since it feels so weird—particularly in standard textbook potential outcomes tables. Finding the treatment effect just for the treated feels like we’re abandoning the idea of a control or comparison group, but we’re not! We’re using information from untreated people to achieve balance, then applying that information to only the treated people through g-computation to approximate unobservable individual-level causal effects. We can thus find more specific causal effects using observational, non-experimental data.</p>
<p>While working through all this, I discovered that I’ve actually been teaching methods that estimate the ATT without even knowing it. One super common method in econometrics and social science in general<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a> is difference-in-differences. The causal effect you find from diff-in-diff research designs is the ATT, or the effect of an intervention on only the treated people. Diff-in-diff doesn’t provide a population-level ATE.</p>
<div class="no-row-height column-margin column-container"><div id="fn7"><p><sup>7</sup>&nbsp;Though not in epidemiology, which is odd since <a href="https://doi.org/10.1007/s40471-020-00245-2">an epidemiologist essentially invented it</a> <span class="citation" data-cites="CanigliaMurray:2020">(<a href="#ref-CanigliaMurray:2020" role="doc-biblioref">Caniglia and Murray 2020</a>)</span>!</p></div></div><p>Other quasi-experimental methods like regression discontinuity and instrumental variables provide much more limited causal effects—they don’t show the ATE, or the ATT, or the ATU. Instead, they provide a local average treatment effect (LATE), or a causal effect for a much narrower segment of the population. For regression discontinuity, we find the ATE for people close to an arbitrary threshold that causes a cutoff in treatment status; for instrumental variables we find the ATE for people who comply with the program assignment.</p>


<!-- -->


</section><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-CanigliaMurray:2020" class="csl-entry" role="listitem">
Caniglia, Ellen C., and Eleanor J. Murray. 2020. <span>“Difference-in-Difference in the Time of Cholera: A Gentle Introduction for Epidemiologists.”</span> <em>Current Epidemiology Reports</em>. <a href="https://doi.org/10.1007/s40471-020-00245-2">https://doi.org/10.1007/s40471-020-00245-2</a>.
</div>
<div id="ref-Cunningham:2021" class="csl-entry" role="listitem">
Cunningham, Scott. 2021. <em>Causal inference: The mixtape</em>. New Haven London: Yale University Press. <a href="https://mixtape.scunning.com/">https://mixtape.scunning.com/</a>.
</div>
<div id="ref-GreiferStuart:2023" class="csl-entry" role="listitem">
Greifer, Noah, and Elizabeth A. Stuart. 2023. <span>“Choosing the Causal Estimand for Propensity Score Analysis of Observational Studies.”</span> arXiv. <a href="https://doi.org/10.48550/arXiv.2106.10577">https://doi.org/10.48550/arXiv.2106.10577</a>.
</div>
<div id="ref-Heiss:2021" class="csl-entry" role="listitem">
Heiss, Andrew. 2021. <span>“Causal Inference.”</span> In <em>R for Political Data Science: A Practical Guide</em>, edited by Francisco Urdinez and Andrés Cruz, 1st ed., 235–74. Boca Raton, Florida: Chapman and Hall/CRC. <a href="https://doi.org/10.1201/9781003010623">https://doi.org/10.1201/9781003010623</a>.
</div>
<div id="ref-HernanRobins:2024" class="csl-entry" role="listitem">
Hernán, Miguel A., and James M. Robins. 2024. <em>Causal Inference: What If</em>. Boca Raton, Florida: Chapman and Hall / CRC. <a href="https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/">https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/</a>.
</div>
<div id="ref-HoImaiKing:2007" class="csl-entry" role="listitem">
Ho, Daniel E., Kosuke Imai, Gary King, and Elizabeth A. Stuart. 2007. <span>“Matching as Nonparametric Preprocessing for Reducing Model Dependence in Parametric Causal Inference.”</span> <em>Political Analysis</em> 15 (3): 199–236. <a href="https://doi.org/10.1093/pan/mpl013">https://doi.org/10.1093/pan/mpl013</a>.
</div>
<div id="ref-Huntington-Klein:2021" class="csl-entry" role="listitem">
Huntington-Klein, Nick. 2021. <em>The Effect: An Introduction to Research Design and Causality</em>. Boca Raton, Florida: Chapman and Hall / CRC. <a href="https://theeffectbook.net/">https://theeffectbook.net/</a>.
</div>
<div id="ref-Huntington-Klein:2022" class="csl-entry" role="listitem">
———. 2022. <span>“Pearl Before Economists: The Book of Why and Empirical Economics.”</span> <em>Journal of Economic Methodology</em> 29 (4): 326–34. <a href="https://doi.org/10.1080/1350178X.2022.2088085">https://doi.org/10.1080/1350178X.2022.2088085</a>.
</div>
<div id="ref-McElreath:2020" class="csl-entry" role="listitem">
McElreath, Richard. 2020. <em>Statistical Rethinking: A Bayesian Course with Examples in R and Stan</em>. 2nd ed. Boca Raton, Florida: Chapman and Hall / CRC.
</div>
<div id="ref-MorganWinship:2014" class="csl-entry" role="listitem">
Morgan, Stephen L., and Christopher Winship. 2014. <em>Counterfactuals and Causal Inference: Methods and Principles for Social Research</em>. 2nd ed. Cambridge University Press. <a href="https://doi.org/10.1017/CBO9781107587991">https://doi.org/10.1017/CBO9781107587991</a>.
</div>
<div id="ref-PearlMackenzie:2020" class="csl-entry" role="listitem">
Pearl, Judea, and Dana Mackenzie. 2020. <em>The book of why: The new science of cause and effect</em>. New York: Basic Books.
</div>
</div></section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{heiss2024,
  author = {Heiss, Andrew},
  title = {Demystifying Causal Inference Estimands: {ATE,} {ATT,} and
    {ATU}},
  date = {2024-03-21},
  url = {https://www.andrewheiss.com/blog/2024/03/21/demystifying-ate-att-atu/},
  doi = {10.59350/c9z3a-rcq16},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-heiss2024" class="csl-entry quarto-appendix-citeas" role="listitem">
Heiss, Andrew. 2024. <span>“Demystifying Causal Inference Estimands:
ATE, ATT, and ATU.”</span> March 21, 2024. <a href="https://doi.org/10.59350/c9z3a-rcq16">https://doi.org/10.59350/c9z3a-rcq16</a>.
</div></div></section></div></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/www\.andrewheiss\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><script src="https://giscus.app/client.js" data-repo="andrewheiss/ath-quarto" data-repo-id="R_kgDOIg6EJQ" data-category="Blog comments" data-category-id="DIC_kwDOIg6EJc4CSz92" data-mapping="pathname" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script><input type="hidden" id="giscus-base-theme" value="light"><input type="hidden" id="giscus-alt-theme" value="dark"><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb28" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Demystifying causal inference estimands: ATE, ATT, and ATU"</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> 2024-03-21</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="an">description:</span><span class="co"> "Explore why we care about the ATE, ATT, and ATU and figure out how to calculate them with observational data"</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="an">image:</span><span class="co"> "index_files/figure-html/fig-propensity-weighted-ate-1.png"</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="an">twitter-card:</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="co">  image: "index_files/figure-html/fig-propensity-weighted-ate-1.png"</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="an">open-graph:</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="co">  image: "index_files/figure-html/fig-propensity-weighted-ate-1.png"</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="co">  - r</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a><span class="co">  - tidyverse</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a><span class="co">  - causal inference</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a><span class="co">  - DAGs</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a><span class="co">  - inverse probability weighting</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a><span class="an">resources:</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a><span class="co">  - "mosquito_nets_v2.csv"</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a><span class="an">bibliography:</span><span class="co"> references.json</span></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a><span class="an">csl:</span><span class="co"> chicago-author-date.csl</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a><span class="co">  html: </span></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a><span class="co">    shift-heading-level-by: 1</span></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a><span class="an">include-before-body:</span></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a><span class="co">  text: |</span></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a><span class="co">    &lt;style&gt;</span></span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a><span class="co">      .no-stripe .gt_table tr.odd {</span></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a><span class="co">        --bs-table-striped-bg: transparent;</span></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a><span class="co">      }</span></span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a><span class="co">      </span></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a><span class="co">      .gt_footnote {</span></span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a><span class="co">        text-align: left !important;</span></span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a><span class="co">      }</span></span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a><span class="co">    &lt;/style&gt;</span></span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a><span class="an">doi:</span><span class="co"> 10.59350/c9z3a-rcq16</span></span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a><span class="an">citation:</span><span class="co"> true</span></span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup</span></span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(</span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a>  <span class="at">fig.width =</span> <span class="dv">6</span>,</span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a>  <span class="at">fig.height =</span> <span class="dv">6</span> <span class="sc">*</span> <span class="fl">0.618</span>,</span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a>  <span class="at">fig.retina =</span> <span class="dv">3</span>,</span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a>  <span class="at">dev =</span> <span class="st">"ragg_png"</span>,</span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a>  <span class="at">fig.align =</span> <span class="st">"center"</span>,</span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a>  <span class="at">out.width =</span> <span class="st">"90%"</span>,</span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true" tabindex="-1"></a>  <span class="at">collapse =</span> <span class="cn">TRUE</span>,</span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true" tabindex="-1"></a>  <span class="at">cache.extra =</span> <span class="dv">1234</span>  <span class="co"># Change number to invalidate cache</span></span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-54"><a href="#cb28-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-55"><a href="#cb28-55" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(</span>
<span id="cb28-56"><a href="#cb28-56" aria-hidden="true" tabindex="-1"></a>  <span class="at">digits =</span> <span class="dv">4</span>,</span>
<span id="cb28-57"><a href="#cb28-57" aria-hidden="true" tabindex="-1"></a>  <span class="at">width =</span> <span class="dv">300</span>,</span>
<span id="cb28-58"><a href="#cb28-58" aria-hidden="true" tabindex="-1"></a>  <span class="at">dplyr.summarise.inform =</span> <span class="cn">FALSE</span></span>
<span id="cb28-59"><a href="#cb28-59" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-60"><a href="#cb28-60" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-61"><a href="#cb28-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-62"><a href="#cb28-62" aria-hidden="true" tabindex="-1"></a>In <span class="co">[</span><span class="ot">my causal inference class</span><span class="co">](https://evalsp24.classes.andrewheiss.com/)</span>, I spend <span class="co">[</span><span class="ot">just one week</span><span class="co">](https://evalsp24.classes.andrewheiss.com/content/05-content.html)</span> talking about the <span class="co">[</span><span class="ot">Rubin causal model</span><span class="co">](https://en.wikipedia.org/wiki/Rubin_causal_model)</span> and potential outcomes. This view of causality argues that for any kind of intervention (passing a new policy, participation in a nonprofit program, taking a specific kind of medicine, etc.), people will have one of two possible outcomes: </span>
<span id="cb28-63"><a href="#cb28-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-64"><a href="#cb28-64" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>What would happen if they receive the intervention or treatment, and </span>
<span id="cb28-65"><a href="#cb28-65" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>What would happen if they do not receive the treatment</span>
<span id="cb28-66"><a href="#cb28-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-67"><a href="#cb28-67" aria-hidden="true" tabindex="-1"></a>These two outcomes are *potential outcomes*. Both are plausible, but only one will happen in real life. These potential outcomes lead to a bunch of different causal estimands we might be interested in, like the average treatment effect.</span>
<span id="cb28-68"><a href="#cb28-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-69"><a href="#cb28-69" aria-hidden="true" tabindex="-1"></a>I give such short shrift to potential outcomes largely because the bulk of the class approaches the idea of causal inference through Judea Pearl-style DAGs instead of potential outcomes. It's a strange arrangement that I've stumbled into: the potential outcomes approach is incredibly popular and widespread in social sciences (particularly in economics), while causal models and DAGs are more popular in fields like epidemiology. For unfathomable reasons, there's a weird animosity between these two worlds. Judea Pearl regularly needles social scientists on Twitter for not using DAGs and clinging to potential outcomes, while Nobel-winning econometricians decry DAGs. It's weird.<span class="ot">[^dag-econ]</span></span>
<span id="cb28-70"><a href="#cb28-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-71"><a href="#cb28-71" aria-hidden="true" tabindex="-1"></a><span class="ot">[^dag-econ]: </span>Though <span class="co">[</span><span class="ot">this neat paper by a DAG-using economist</span><span class="co">](https://doi.org/10.1080/1350178X.2022.2088085)</span> tries to bridge that gap <span class="co">[</span><span class="ot">@Huntington-Klein:2022</span><span class="co">]</span>.</span>
<span id="cb28-72"><a href="#cb28-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-73"><a href="#cb28-73" aria-hidden="true" tabindex="-1"></a>As a social scientist myself, you'd think I'd have embraced the potential outcomes approach, but for whatever reason, it never stuck and it was always confusing to me. When I came across Judea Pearl's *The Book of Why* <span class="co">[</span><span class="ot">@PearlMackenzie:2020</span><span class="co">]</span> a few years ago, I fell in love with the world of DAGs. They made sense—far more sense than the weird decompositional algebra behind average treatment effects, average treatment on the treated effects, average treatment on the untreated effects, and so on.</span>
<span id="cb28-74"><a href="#cb28-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-75"><a href="#cb28-75" aria-hidden="true" tabindex="-1"></a>I'm not the only social science convert to DAGs. The general social science methods textbook <span class="co">[</span><span class="ot">*Counterfactuals and Causal Inference*</span><span class="co">](https://www.cambridge.org/core/books/counterfactuals-and-causal-inference/5CC81E6DF63C5E5A8B88F79D45E1D1B7)</span> <span class="co">[</span><span class="ot">@MorganWinship:2014</span><span class="co">]</span> started popularizing DAGs in 2007, two modern phenomenal econometrics textbooks—<span class="co">[</span><span class="ot">*The Effect*</span><span class="co">](https://theeffectbook.net/)</span> <span class="co">[</span><span class="ot">@Huntington-Klein:2021</span><span class="co">]</span> and <span class="co">[</span><span class="ot">*Causal Inference: The Mixtape*</span><span class="co">](https://mixtape.scunning.com/)</span> <span class="co">[</span><span class="ot">@Cunningham:2021</span><span class="co">]</span>—feature DAGs throughout (despite that discipline's weird aversion to them), and the latest version of the fantastic Bayesian <span class="co">[</span><span class="ot">*Statistical Rethinking*</span><span class="co">](https://xcelab.net/rm/statistical-rethinking/)</span> <span class="co">[</span><span class="ot">@McElreath:2020</span><span class="co">]</span> uses them extensively.</span>
<span id="cb28-76"><a href="#cb28-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-77"><a href="#cb28-77" aria-hidden="true" tabindex="-1"></a>Despite all these newer DAG-based approaches in social science, in my class, I never really revisit the potential outcomes framework after that one week. We do all sorts of causal effects estimation with DAG-based adjustment through matching and inverse probability weighting, and quasi-experimental design-based approaches like difference-in-differences, regression discontinuity, and instrumental variables, but beyond emphasizing the fact that methods like regression discontinuity and instrumental variables only return *local* average treatment effects, we don't really ever talk about ATEs and ATTs and ATUs again.</span>
<span id="cb28-78"><a href="#cb28-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-79"><a href="#cb28-79" aria-hidden="true" tabindex="-1"></a>This has always bugged me.</span>
<span id="cb28-80"><a href="#cb28-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-81"><a href="#cb28-81" aria-hidden="true" tabindex="-1"></a>Beyond introducing the idea that we can't find individual-level causal effects without a time machine, thinking about potential outcomes is neat, I guess, but not exactly relevant to all the other methods we cover. **I know that's wrong!** But that's how my mental model of these estimands has worked. All these other methods give some sort of general average causal effect, but I'm never sure which exact flavor of causal effect it is (or if the exact flavor matters).</span>
<span id="cb28-82"><a href="#cb28-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-83"><a href="#cb28-83" aria-hidden="true" tabindex="-1"></a>But <span class="co">[</span><span class="ot">a newer working paper</span><span class="co">](https://arxiv.org/abs/2106.10577)</span> by @GreiferStuart:2023 has finally helped me realize why these different estimands matter and what the subtle differences between them are.</span>
<span id="cb28-84"><a href="#cb28-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-85"><a href="#cb28-85" aria-hidden="true" tabindex="-1"></a>So in this post, I'll extend the basic standard ATE/ATT/ATU example to reflect a more realistic, larger dataset, and I'll use propensity score weighting to estimate each estimand. I'll also follow Greifer and Stuart's example and translate these estimands into policy-relevant English equivalents (they use medical terminology; I'm not that kind of doctor and I work with social science and policy interventions).</span>
<span id="cb28-86"><a href="#cb28-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-87"><a href="#cb28-87" aria-hidden="true" tabindex="-1"></a>But first, I *highly* recommend <span class="co">[</span><span class="ot">reading through their paper really quick</span><span class="co">](https://arxiv.org/abs/2106.10577)</span>. It's not too long and and it's not too mathy—it's succinct and accessible and a good primer for all these estimands.</span>
<span id="cb28-88"><a href="#cb28-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-89"><a href="#cb28-89" aria-hidden="true" tabindex="-1"></a>(And before we start, let's load some R packages.)</span>
<span id="cb28-90"><a href="#cb28-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-93"><a href="#cb28-93" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-94"><a href="#cb28-94" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: packages-functions</span></span>
<span id="cb28-95"><a href="#cb28-95" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb28-96"><a href="#cb28-96" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb28-97"><a href="#cb28-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-98"><a href="#cb28-98" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb28-99"><a href="#cb28-99" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggtext)</span>
<span id="cb28-100"><a href="#cb28-100" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggdag)</span>
<span id="cb28-101"><a href="#cb28-101" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dagitty)</span>
<span id="cb28-102"><a href="#cb28-102" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gt)</span>
<span id="cb28-103"><a href="#cb28-103" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom)</span>
<span id="cb28-104"><a href="#cb28-104" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(marginaleffects)</span>
<span id="cb28-105"><a href="#cb28-105" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(WeightIt)</span>
<span id="cb28-106"><a href="#cb28-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-107"><a href="#cb28-107" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a nice color palette from {MoMAColors}</span></span>
<span id="cb28-108"><a href="#cb28-108" aria-hidden="true" tabindex="-1"></a><span class="co"># https://github.com/BlakeRMills/MoMAColors</span></span>
<span id="cb28-109"><a href="#cb28-109" aria-hidden="true" tabindex="-1"></a>clrs <span class="ot">&lt;-</span> MoMAColors<span class="sc">::</span><span class="fu">moma.colors</span>(<span class="st">"ustwo"</span>)</span>
<span id="cb28-110"><a href="#cb28-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-111"><a href="#cb28-111" aria-hidden="true" tabindex="-1"></a><span class="co"># Download Mulish from https://fonts.google.com/specimen/Mulish</span></span>
<span id="cb28-112"><a href="#cb28-112" aria-hidden="true" tabindex="-1"></a>theme_nice <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb28-113"><a href="#cb28-113" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_family =</span> <span class="st">"Mulish"</span>) <span class="sc">+</span></span>
<span id="cb28-114"><a href="#cb28-114" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb28-115"><a href="#cb28-115" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb28-116"><a href="#cb28-116" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>),</span>
<span id="cb28-117"><a href="#cb28-117" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb28-118"><a href="#cb28-118" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb28-119"><a href="#cb28-119" aria-hidden="true" tabindex="-1"></a>      <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb28-120"><a href="#cb28-120" aria-hidden="true" tabindex="-1"></a>      <span class="at">strip.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"grey80"</span>, <span class="at">color =</span> <span class="cn">NA</span>),</span>
<span id="cb28-121"><a href="#cb28-121" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>)</span>
<span id="cb28-122"><a href="#cb28-122" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-123"><a href="#cb28-123" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-124"><a href="#cb28-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-125"><a href="#cb28-125" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_nice</span>())</span>
<span id="cb28-126"><a href="#cb28-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-127"><a href="#cb28-127" aria-hidden="true" tabindex="-1"></a><span class="fu">update_geom_defaults</span>(<span class="st">"text"</span>, <span class="fu">list</span>(<span class="at">family =</span> <span class="st">"Mulish"</span>, <span class="at">fontface =</span> <span class="st">"plain"</span>))</span>
<span id="cb28-128"><a href="#cb28-128" aria-hidden="true" tabindex="-1"></a><span class="fu">update_geom_defaults</span>(<span class="st">"label"</span>, <span class="fu">list</span>(<span class="at">family =</span> <span class="st">"Mulish"</span>, <span class="at">fontface =</span> <span class="st">"plain"</span>))</span>
<span id="cb28-129"><a href="#cb28-129" aria-hidden="true" tabindex="-1"></a><span class="fu">update_geom_defaults</span>(ggdag<span class="sc">:::</span>GeomDagText, <span class="fu">list</span>(<span class="at">family =</span> <span class="st">"Mulish"</span>, <span class="at">fontface =</span> <span class="st">"plain"</span>))</span>
<span id="cb28-130"><a href="#cb28-130" aria-hidden="true" tabindex="-1"></a><span class="fu">update_geom_defaults</span>(ggtext<span class="sc">::</span>GeomRichText, <span class="fu">list</span>(<span class="at">family =</span> <span class="st">"Mulish"</span>, <span class="at">fontface =</span> <span class="st">"plain"</span>))</span>
<span id="cb28-131"><a href="#cb28-131" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-132"><a href="#cb28-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-133"><a href="#cb28-133" aria-hidden="true" tabindex="-1"></a><span class="fu"># Quick crash course in potential outcomes</span></span>
<span id="cb28-134"><a href="#cb28-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-135"><a href="#cb28-135" aria-hidden="true" tabindex="-1"></a>Before getting into the subtle differences between the various potential outcomes-related estimands, it's helpful to get a general sense for how these things work. So let's take a super abbreviated crash course in the potential outcomes framework.</span>
<span id="cb28-136"><a href="#cb28-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-137"><a href="#cb28-137" aria-hidden="true" tabindex="-1"></a>Every causal inference textbook ever written will include a table like @tbl-basic-po to illustrate potential outcomes. To make this idea a little more mathy, we'll call the treatment or intervention $X$, the outcome that would happen if treated $Y^1$, and the outcome that would happen if not treated $Y^0$.<span class="ot">[^po-notation]</span> We'll use $\delta$ for the difference between $Y^1$ and $Y^0$, or the individual-level causal effect.</span>
<span id="cb28-138"><a href="#cb28-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-139"><a href="#cb28-139" aria-hidden="true" tabindex="-1"></a><span class="ot">[^po-notation]: </span>The notation for all this varies wildly across disciplines. Economists call the treatment $D$ for mysterious reasons; epidemiologists will often call it $A$; I've seen political science papers call it $T$ (which at least makes more sense than $D$ or $A$, since "treatment" starts with T). In my class I call it $X$, which follows what a lot of other people do (like this guide to <span class="co">[</span><span class="ot">"10 Strategies for Figuring Out if X Caused Y"</span><span class="co">](https://egap.org/resource/10-strategies-for-figuring-out-if-x-caused-y/)</span>).</span>
<span id="cb28-140"><a href="#cb28-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-143"><a href="#cb28-143" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-144"><a href="#cb28-144" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-basic-po</span></span>
<span id="cb28-145"><a href="#cb28-145" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Standard table showing potential outcomes, individual causal effects, and realized outcomes"</span></span>
<span id="cb28-146"><a href="#cb28-146" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb28-147"><a href="#cb28-147" aria-hidden="true" tabindex="-1"></a><span class="co">#| classes: no-stripe</span></span>
<span id="cb28-148"><a href="#cb28-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-149"><a href="#cb28-149" aria-hidden="true" tabindex="-1"></a>basic_po <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb28-150"><a href="#cb28-150" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>id, <span class="sc">~</span>age,    <span class="sc">~</span>treated, <span class="sc">~</span>outcome_1, <span class="sc">~</span>outcome_0,</span>
<span id="cb28-151"><a href="#cb28-151" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span>,   <span class="st">"Old"</span>,   <span class="dv">1</span>,        <span class="dv">80</span>,         <span class="dv">60</span>,</span>
<span id="cb28-152"><a href="#cb28-152" aria-hidden="true" tabindex="-1"></a>  <span class="dv">2</span>,   <span class="st">"Old"</span>,   <span class="dv">1</span>,        <span class="dv">75</span>,         <span class="dv">70</span>,</span>
<span id="cb28-153"><a href="#cb28-153" aria-hidden="true" tabindex="-1"></a>  <span class="dv">3</span>,   <span class="st">"Old"</span>,   <span class="dv">1</span>,        <span class="dv">85</span>,         <span class="dv">80</span>,</span>
<span id="cb28-154"><a href="#cb28-154" aria-hidden="true" tabindex="-1"></a>  <span class="dv">4</span>,   <span class="st">"Old"</span>,   <span class="dv">0</span>,        <span class="dv">70</span>,         <span class="dv">60</span>,</span>
<span id="cb28-155"><a href="#cb28-155" aria-hidden="true" tabindex="-1"></a>  <span class="dv">5</span>,   <span class="st">"Young"</span>, <span class="dv">1</span>,        <span class="dv">75</span>,         <span class="dv">70</span>,</span>
<span id="cb28-156"><a href="#cb28-156" aria-hidden="true" tabindex="-1"></a>  <span class="dv">6</span>,   <span class="st">"Young"</span>, <span class="dv">0</span>,        <span class="dv">80</span>,         <span class="dv">80</span>,</span>
<span id="cb28-157"><a href="#cb28-157" aria-hidden="true" tabindex="-1"></a>  <span class="dv">7</span>,   <span class="st">"Young"</span>, <span class="dv">0</span>,        <span class="dv">90</span>,         <span class="dv">100</span>,</span>
<span id="cb28-158"><a href="#cb28-158" aria-hidden="true" tabindex="-1"></a>  <span class="dv">8</span>,   <span class="st">"Young"</span>, <span class="dv">0</span>,        <span class="dv">85</span>,         <span class="dv">80</span></span>
<span id="cb28-159"><a href="#cb28-159" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb28-160"><a href="#cb28-160" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb28-161"><a href="#cb28-161" aria-hidden="true" tabindex="-1"></a>    <span class="at">ice =</span> outcome_1 <span class="sc">-</span> outcome_0,</span>
<span id="cb28-162"><a href="#cb28-162" aria-hidden="true" tabindex="-1"></a>    <span class="at">outcome =</span> <span class="fu">ifelse</span>(treated <span class="sc">==</span> <span class="dv">1</span>, outcome_1, outcome_0)</span>
<span id="cb28-163"><a href="#cb28-163" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-164"><a href="#cb28-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-165"><a href="#cb28-165" aria-hidden="true" tabindex="-1"></a>basic_po <span class="sc">|&gt;</span> </span>
<span id="cb28-166"><a href="#cb28-166" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb28-167"><a href="#cb28-167" aria-hidden="true" tabindex="-1"></a>    id, age, treated, outcome_1, outcome_0, ice, outcome</span>
<span id="cb28-168"><a href="#cb28-168" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-169"><a href="#cb28-169" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">|&gt;</span> </span>
<span id="cb28-170"><a href="#cb28-170" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sub_missing</span>(<span class="at">missing_text =</span> <span class="st">"…"</span>) <span class="sc">|&gt;</span></span>
<span id="cb28-171"><a href="#cb28-171" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(</span>
<span id="cb28-172"><a href="#cb28-172" aria-hidden="true" tabindex="-1"></a>    <span class="at">columns =</span> <span class="fu">c</span>(<span class="fu">starts_with</span>(<span class="st">"outcome"</span>), ice),</span>
<span id="cb28-173"><a href="#cb28-173" aria-hidden="true" tabindex="-1"></a>    <span class="at">decimals =</span> <span class="dv">0</span></span>
<span id="cb28-174"><a href="#cb28-174" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-175"><a href="#cb28-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-176"><a href="#cb28-176" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Column labels</span></span>
<span id="cb28-177"><a href="#cb28-177" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(</span>
<span id="cb28-178"><a href="#cb28-178" aria-hidden="true" tabindex="-1"></a>    <span class="at">id =</span> <span class="st">"ID"</span>,</span>
<span id="cb28-179"><a href="#cb28-179" aria-hidden="true" tabindex="-1"></a>    <span class="at">age =</span> <span class="fu">md</span>(<span class="st">"$Z_i$"</span>),</span>
<span id="cb28-180"><a href="#cb28-180" aria-hidden="true" tabindex="-1"></a>    <span class="at">treated =</span> <span class="fu">md</span>(<span class="st">"$X_i$"</span>),</span>
<span id="cb28-181"><a href="#cb28-181" aria-hidden="true" tabindex="-1"></a>    <span class="at">outcome_0 =</span> <span class="fu">md</span>(<span class="st">"$Y^0_i$"</span>),</span>
<span id="cb28-182"><a href="#cb28-182" aria-hidden="true" tabindex="-1"></a>    <span class="at">outcome_1 =</span> <span class="fu">md</span>(<span class="st">"$Y^1_i$"</span>),</span>
<span id="cb28-183"><a href="#cb28-183" aria-hidden="true" tabindex="-1"></a>    <span class="at">outcome =</span> <span class="fu">md</span>(<span class="st">"$Y_i$"</span>),</span>
<span id="cb28-184"><a href="#cb28-184" aria-hidden="true" tabindex="-1"></a>    <span class="at">ice =</span> <span class="fu">md</span>(<span class="st">"$Y^1_i - Y^0_i$"</span>)</span>
<span id="cb28-185"><a href="#cb28-185" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb28-186"><a href="#cb28-186" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-187"><a href="#cb28-187" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Level 1 spanner labels</span></span>
<span id="cb28-188"><a href="#cb28-188" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(</span>
<span id="cb28-189"><a href="#cb28-189" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"Age"</span>, <span class="at">columns =</span> age, </span>
<span id="cb28-190"><a href="#cb28-190" aria-hidden="true" tabindex="-1"></a>    <span class="at">level =</span> <span class="dv">1</span>, <span class="at">id =</span> <span class="st">"level1_a_po"</span></span>
<span id="cb28-191"><a href="#cb28-191" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-192"><a href="#cb28-192" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(</span>
<span id="cb28-193"><a href="#cb28-193" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"Treated"</span>, <span class="at">columns =</span> treated, </span>
<span id="cb28-194"><a href="#cb28-194" aria-hidden="true" tabindex="-1"></a>    <span class="at">level =</span> <span class="dv">1</span>, <span class="at">id =</span> <span class="st">"level1_b_po"</span></span>
<span id="cb28-195"><a href="#cb28-195" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-196"><a href="#cb28-196" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(</span>
<span id="cb28-197"><a href="#cb28-197" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"Potential outcomes"</span>,</span>
<span id="cb28-198"><a href="#cb28-198" aria-hidden="true" tabindex="-1"></a>    <span class="at">columns =</span> <span class="fu">c</span>(outcome_1, outcome_0),</span>
<span id="cb28-199"><a href="#cb28-199" aria-hidden="true" tabindex="-1"></a>    <span class="at">level =</span> <span class="dv">1</span>, <span class="at">id =</span> <span class="st">"level1_c_po"</span></span>
<span id="cb28-200"><a href="#cb28-200" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-201"><a href="#cb28-201" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(</span>
<span id="cb28-202"><a href="#cb28-202" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"ICE or </span><span class="sc">\\</span><span class="st">(</span><span class="sc">\\</span><span class="st">delta_i</span><span class="sc">\\</span><span class="st">)"</span>, <span class="at">columns =</span> ice, </span>
<span id="cb28-203"><a href="#cb28-203" aria-hidden="true" tabindex="-1"></a>    <span class="at">level =</span> <span class="dv">1</span>, <span class="at">id =</span> <span class="st">"level1_d_po"</span></span>
<span id="cb28-204"><a href="#cb28-204" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-205"><a href="#cb28-205" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(</span>
<span id="cb28-206"><a href="#cb28-206" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"Outcome"</span>, <span class="at">columns =</span> outcome, </span>
<span id="cb28-207"><a href="#cb28-207" aria-hidden="true" tabindex="-1"></a>    <span class="at">level =</span> <span class="dv">1</span>, <span class="at">id =</span> <span class="st">"level1_e_po"</span></span>
<span id="cb28-208"><a href="#cb28-208" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-209"><a href="#cb28-209" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-210"><a href="#cb28-210" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Level 2 spanner labels</span></span>
<span id="cb28-211"><a href="#cb28-211" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(</span>
<span id="cb28-212"><a href="#cb28-212" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"Confounder"</span>,</span>
<span id="cb28-213"><a href="#cb28-213" aria-hidden="true" tabindex="-1"></a>    <span class="at">columns =</span> age,</span>
<span id="cb28-214"><a href="#cb28-214" aria-hidden="true" tabindex="-1"></a>    <span class="at">level =</span> <span class="dv">2</span>, <span class="at">id =</span> <span class="st">"level2_a_po"</span></span>
<span id="cb28-215"><a href="#cb28-215" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-216"><a href="#cb28-216" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(</span>
<span id="cb28-217"><a href="#cb28-217" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"Treatment"</span>, <span class="at">columns =</span> treated, </span>
<span id="cb28-218"><a href="#cb28-218" aria-hidden="true" tabindex="-1"></a>    <span class="at">level =</span> <span class="dv">2</span>, <span class="at">id =</span> <span class="st">"level2_b_po"</span></span>
<span id="cb28-219"><a href="#cb28-219" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-220"><a href="#cb28-220" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(</span>
<span id="cb28-221"><a href="#cb28-221" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"Unobservable"</span>,</span>
<span id="cb28-222"><a href="#cb28-222" aria-hidden="true" tabindex="-1"></a>    <span class="at">columns =</span> <span class="fu">c</span>(outcome_1, outcome_0, ice), </span>
<span id="cb28-223"><a href="#cb28-223" aria-hidden="true" tabindex="-1"></a>    <span class="at">level =</span> <span class="dv">2</span>, <span class="at">id =</span> <span class="st">"level2_c_po"</span></span>
<span id="cb28-224"><a href="#cb28-224" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-225"><a href="#cb28-225" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(</span>
<span id="cb28-226"><a href="#cb28-226" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"Realized"</span>, <span class="at">columns =</span> outcome, </span>
<span id="cb28-227"><a href="#cb28-227" aria-hidden="true" tabindex="-1"></a>    <span class="at">level =</span> <span class="dv">2</span>, <span class="at">id =</span> <span class="st">"level2_d_po"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb28-228"><a href="#cb28-228" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-229"><a href="#cb28-229" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Style stuff</span></span>
<span id="cb28-230"><a href="#cb28-230" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_style</span>(</span>
<span id="cb28-231"><a href="#cb28-231" aria-hidden="true" tabindex="-1"></a>    <span class="at">style =</span> <span class="fu">cell_text</span>(<span class="at">align =</span> <span class="st">"center"</span>),</span>
<span id="cb28-232"><a href="#cb28-232" aria-hidden="true" tabindex="-1"></a>    <span class="at">locations =</span> <span class="fu">cells_column_labels</span>()</span>
<span id="cb28-233"><a href="#cb28-233" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-234"><a href="#cb28-234" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_style</span>(</span>
<span id="cb28-235"><a href="#cb28-235" aria-hidden="true" tabindex="-1"></a>    <span class="at">style =</span> <span class="fu">cell_text</span>(<span class="at">align =</span> <span class="st">"center"</span>),</span>
<span id="cb28-236"><a href="#cb28-236" aria-hidden="true" tabindex="-1"></a>    <span class="at">locations =</span> <span class="fu">cells_body</span>()</span>
<span id="cb28-237"><a href="#cb28-237" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-238"><a href="#cb28-238" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_style</span>(</span>
<span id="cb28-239"><a href="#cb28-239" aria-hidden="true" tabindex="-1"></a>    <span class="at">style =</span> <span class="fu">cell_text</span>(<span class="at">weight =</span> <span class="st">"bold"</span>),</span>
<span id="cb28-240"><a href="#cb28-240" aria-hidden="true" tabindex="-1"></a>    <span class="at">locations =</span> <span class="fu">list</span>(</span>
<span id="cb28-241"><a href="#cb28-241" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cells_column_spanners</span>(<span class="at">spanners =</span> <span class="fu">starts_with</span>(<span class="st">"level1"</span>)),</span>
<span id="cb28-242"><a href="#cb28-242" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cells_column_labels</span>(<span class="at">columns =</span> <span class="st">"id"</span>)</span>
<span id="cb28-243"><a href="#cb28-243" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-244"><a href="#cb28-244" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-245"><a href="#cb28-245" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_style</span>(</span>
<span id="cb28-246"><a href="#cb28-246" aria-hidden="true" tabindex="-1"></a>    <span class="at">style =</span> <span class="fu">cell_text</span>(<span class="at">style =</span> <span class="st">"italic"</span>),</span>
<span id="cb28-247"><a href="#cb28-247" aria-hidden="true" tabindex="-1"></a>    <span class="at">locations =</span> <span class="fu">cells_column_spanners</span>(<span class="at">spanners =</span> <span class="fu">starts_with</span>(<span class="st">"level2"</span>))</span>
<span id="cb28-248"><a href="#cb28-248" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-249"><a href="#cb28-249" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-250"><a href="#cb28-250" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_style</span>(</span>
<span id="cb28-251"><a href="#cb28-251" aria-hidden="true" tabindex="-1"></a>    <span class="at">style =</span> <span class="fu">list</span>(</span>
<span id="cb28-252"><a href="#cb28-252" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cell_fill</span>(<span class="at">color =</span> clrs[<span class="dv">4</span>], <span class="at">alpha =</span> <span class="fl">0.5</span>)</span>
<span id="cb28-253"><a href="#cb28-253" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb28-254"><a href="#cb28-254" aria-hidden="true" tabindex="-1"></a>    <span class="at">locations =</span> <span class="fu">cells_body</span>(<span class="at">rows =</span> treated <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb28-255"><a href="#cb28-255" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-256"><a href="#cb28-256" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_footnote</span>(</span>
<span id="cb28-257"><a href="#cb28-257" aria-hidden="true" tabindex="-1"></a>    <span class="at">footnote =</span> <span class="st">"ICE = individual causal effect"</span>,</span>
<span id="cb28-258"><a href="#cb28-258" aria-hidden="true" tabindex="-1"></a>    <span class="at">locations =</span> <span class="fu">cells_column_spanners</span>(<span class="at">spanners =</span> <span class="st">"level1_d_po"</span>)</span>
<span id="cb28-259"><a href="#cb28-259" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-260"><a href="#cb28-260" aria-hidden="true" tabindex="-1"></a>  <span class="fu">opt_footnote_marks</span>(<span class="at">marks =</span> <span class="st">"standard"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb28-261"><a href="#cb28-261" aria-hidden="true" tabindex="-1"></a>  <span class="fu">opt_horizontal_padding</span>(<span class="at">scale =</span> <span class="dv">3</span>) <span class="sc">|&gt;</span> </span>
<span id="cb28-262"><a href="#cb28-262" aria-hidden="true" tabindex="-1"></a>  <span class="fu">opt_table_font</span>(<span class="at">font =</span> <span class="st">"Jost"</span>)</span>
<span id="cb28-263"><a href="#cb28-263" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-264"><a href="#cb28-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-265"><a href="#cb28-265" aria-hidden="true" tabindex="-1"></a><span class="fu">## Individual-level causal effects (ICE or $\delta$)</span></span>
<span id="cb28-266"><a href="#cb28-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-267"><a href="#cb28-267" aria-hidden="true" tabindex="-1"></a>Each person in @tbl-basic-po has two potential outcomes. Person 1, for instance, would have an outcome of 80 ($Y^1$) if they receive the treatment $X$, but only an outcome of 60 ($Y^0$) if they don't. Their *individual-level causal effect* ($\delta$) is 20. This represents the effect of the treatment for just that one person, and it's only measurable with a time machine or some way to observe parallel universes.</span>
<span id="cb28-268"><a href="#cb28-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-269"><a href="#cb28-269" aria-hidden="true" tabindex="-1"></a><span class="fu">## Average treatment effects (ATE)</span></span>
<span id="cb28-270"><a href="#cb28-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-271"><a href="#cb28-271" aria-hidden="true" tabindex="-1"></a>If we could compare all these people in Universe A and Universe B and measure their individual causal effects, we could calculate the *average treatment effect* (ATE), or the effect of the intervention across the whole population. Officially, the ATE is the average of the $\delta$ column, or the average of $Y^1 - Y^0$:</span>
<span id="cb28-272"><a href="#cb28-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-273"><a href="#cb28-273" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-274"><a href="#cb28-274" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb28-275"><a href="#cb28-275" aria-hidden="true" tabindex="-1"></a>\text{ATE} &amp;= E<span class="co">[</span><span class="ot">\delta_i</span><span class="co">]</span> &amp; \text{ or} <span class="sc">\\</span></span>
<span id="cb28-276"><a href="#cb28-276" aria-hidden="true" tabindex="-1"></a>\text{ATE} &amp;= E<span class="co">[</span><span class="ot">Y^1_i - Y^0_i</span><span class="co">]</span></span>
<span id="cb28-277"><a href="#cb28-277" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb28-278"><a href="#cb28-278" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-279"><a href="#cb28-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-280"><a href="#cb28-280" aria-hidden="true" tabindex="-1"></a>Given the data in @tbl-basic-po, the ATE is 5—it's the average of the $\delta$ column:</span>
<span id="cb28-281"><a href="#cb28-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-282"><a href="#cb28-282" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-283"><a href="#cb28-283" aria-hidden="true" tabindex="-1"></a>\text{ATE} = \frac{20 + 5 + 5 + 5 + 10 + 0 + -10 + 5}{8} = 5</span>
<span id="cb28-284"><a href="#cb28-284" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-285"><a href="#cb28-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-286"><a href="#cb28-286" aria-hidden="true" tabindex="-1"></a>Neat.</span>
<span id="cb28-287"><a href="#cb28-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-288"><a href="#cb28-288" aria-hidden="true" tabindex="-1"></a><span class="fu">## Average treatment effect on the treated (ATT)</span></span>
<span id="cb28-289"><a href="#cb28-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-290"><a href="#cb28-290" aria-hidden="true" tabindex="-1"></a>There are a couple other causal effects we can measure. We might want to know how big the effect is just for those who received the treatment. This is called the *average treatment effect on the treated* (ATT), and is the average of the individual causal effects just among those who were treated. Officially, it's defined like this:</span>
<span id="cb28-291"><a href="#cb28-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-292"><a href="#cb28-292" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-293"><a href="#cb28-293" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb28-294"><a href="#cb28-294" aria-hidden="true" tabindex="-1"></a>\text{ATT} &amp;= E<span class="co">[</span><span class="ot">\delta_i \mid X_i = 1</span><span class="co">]</span> &amp; \text{or} <span class="sc">\\</span></span>
<span id="cb28-295"><a href="#cb28-295" aria-hidden="true" tabindex="-1"></a>\text{ATT} &amp;= E<span class="co">[</span><span class="ot">Y^1_i - Y^0_i \mid X_i = 1</span><span class="co">]</span></span>
<span id="cb28-296"><a href="#cb28-296" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb28-297"><a href="#cb28-297" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-298"><a href="#cb28-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-299"><a href="#cb28-299" aria-hidden="true" tabindex="-1"></a>In this case, that means we're only looking at the average $\delta$ for rows 1, 2, 3, and 5 in @tbl-basic-po:</span>
<span id="cb28-300"><a href="#cb28-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-301"><a href="#cb28-301" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-302"><a href="#cb28-302" aria-hidden="true" tabindex="-1"></a>\text{ATT} = \frac{20 + 5 + 5 + 5}{4} = 8.75</span>
<span id="cb28-303"><a href="#cb28-303" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-304"><a href="#cb28-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-305"><a href="#cb28-305" aria-hidden="true" tabindex="-1"></a><span class="fu">## Average treatment effect on the untreated (ATU)</span></span>
<span id="cb28-306"><a href="#cb28-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-307"><a href="#cb28-307" aria-hidden="true" tabindex="-1"></a>We can also calculate the *average treatment effect on the untreated* (ATU; sometimes called the ATC (for effect on the control group)) by finding the average of the individual causal effects among those who were not treated:</span>
<span id="cb28-308"><a href="#cb28-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-309"><a href="#cb28-309" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-310"><a href="#cb28-310" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb28-311"><a href="#cb28-311" aria-hidden="true" tabindex="-1"></a>\text{ATU} &amp;= E<span class="co">[</span><span class="ot">\delta_i \mid X_i = 0</span><span class="co">]</span> &amp; \text{or} <span class="sc">\\</span></span>
<span id="cb28-312"><a href="#cb28-312" aria-hidden="true" tabindex="-1"></a>\text{ATU} &amp;= E<span class="co">[</span><span class="ot">Y^1_i - Y^0_i \mid X_i = 0</span><span class="co">]</span></span>
<span id="cb28-313"><a href="#cb28-313" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb28-314"><a href="#cb28-314" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-315"><a href="#cb28-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-316"><a href="#cb28-316" aria-hidden="true" tabindex="-1"></a>Here, we're only looking at the average $\delta$ for rows 4, 6, 7, and 8 in @tbl-basic-po:</span>
<span id="cb28-317"><a href="#cb28-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-318"><a href="#cb28-318" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-319"><a href="#cb28-319" aria-hidden="true" tabindex="-1"></a>\text{ATU} = \frac{10 + 0 - 10 + 5}{4} = 1.25</span>
<span id="cb28-320"><a href="#cb28-320" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-321"><a href="#cb28-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-322"><a href="#cb28-322" aria-hidden="true" tabindex="-1"></a><span class="fu">## Selection bias</span></span>
<span id="cb28-323"><a href="#cb28-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-324"><a href="#cb28-324" aria-hidden="true" tabindex="-1"></a>There's a neat relationship between the ATE, ATT, and ATU—the ATE is technically a weighted average of the ATT added to the weighted average of the ATU (here $\pi$ means "proportion", not 3.1415):</span>
<span id="cb28-325"><a href="#cb28-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-326"><a href="#cb28-326" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-327"><a href="#cb28-327" aria-hidden="true" tabindex="-1"></a>\text{ATE} = (\pi_\text{Treated} \times \text{ATT}) + (\pi_\text{Untreated} \times \text{ATU})</span>
<span id="cb28-328"><a href="#cb28-328" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-329"><a href="#cb28-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-330"><a href="#cb28-330" aria-hidden="true" tabindex="-1"></a>Applying this to @tbl-basic-po, we can get the same ATE:</span>
<span id="cb28-331"><a href="#cb28-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-332"><a href="#cb28-332" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-333"><a href="#cb28-333" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb28-334"><a href="#cb28-334" aria-hidden="true" tabindex="-1"></a>\text{ATE} &amp;= (\frac{4}{8} \times 8.75) + (\frac{4}{8} \times 1.25) <span class="sc">\\</span></span>
<span id="cb28-335"><a href="#cb28-335" aria-hidden="true" tabindex="-1"></a>&amp;= 4.375 + 0.625 <span class="sc">\\</span></span>
<span id="cb28-336"><a href="#cb28-336" aria-hidden="true" tabindex="-1"></a>&amp;= 5</span>
<span id="cb28-337"><a href="#cb28-337" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb28-338"><a href="#cb28-338" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-339"><a href="#cb28-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-340"><a href="#cb28-340" aria-hidden="true" tabindex="-1"></a>One reason it's helpful to decompose the ATE into these two parts like this is that it shows that there's some systematic difference between the treated and untreated people. This difference is called *selection bias*. People who chose to be treated did so for reasons known only to them.<span class="ot">[^mind-reading]</span> </span>
<span id="cb28-341"><a href="#cb28-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-342"><a href="#cb28-342" aria-hidden="true" tabindex="-1"></a><span class="ot">[^mind-reading]: </span>Not only do we need a time machine for good causal inference, we also need a machine that can read minds.</span>
<span id="cb28-343"><a href="#cb28-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-344"><a href="#cb28-344" aria-hidden="true" tabindex="-1"></a>We can see the selection bias in an alternative decomposition of the ATE:</span>
<span id="cb28-345"><a href="#cb28-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-346"><a href="#cb28-346" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-347"><a href="#cb28-347" aria-hidden="true" tabindex="-1"></a>\text{ATE} = \text{ATT} + \text{Selection bias}</span>
<span id="cb28-348"><a href="#cb28-348" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-349"><a href="#cb28-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-350"><a href="#cb28-350" aria-hidden="true" tabindex="-1"></a>The fact that the ATT (8.75) is bigger than the ATE (5) here is a sign the two groups are different. This intervention, whatever it is, has a big effect on the treated people who signed up for it, likely because they somehow knew that the intervention would be helpful for them. Those who were untreated have a really low ATU (1.25)—they likely didn't sign up for the intervention because they knew that it wouldn't do much for them.</span>
<span id="cb28-351"><a href="#cb28-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-352"><a href="#cb28-352" aria-hidden="true" tabindex="-1"></a><span class="fu">## Finding the ATE from observational data</span></span>
<span id="cb28-353"><a href="#cb28-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-354"><a href="#cb28-354" aria-hidden="true" tabindex="-1"></a>This is all well and good, but we don't have time machines. This is the *fundamental problem of causal inference*—we have no idea what each person's $\delta$ is. We actually only see this in real life:</span>
<span id="cb28-355"><a href="#cb28-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-358"><a href="#cb28-358" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-359"><a href="#cb28-359" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-basic-realized</span></span>
<span id="cb28-360"><a href="#cb28-360" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Observed version of @tbl-basic-po showing only the realized outcome"</span></span>
<span id="cb28-361"><a href="#cb28-361" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb28-362"><a href="#cb28-362" aria-hidden="true" tabindex="-1"></a><span class="co">#| classes: no-stripe</span></span>
<span id="cb28-363"><a href="#cb28-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-364"><a href="#cb28-364" aria-hidden="true" tabindex="-1"></a>basic_po <span class="sc">|&gt;</span> </span>
<span id="cb28-365"><a href="#cb28-365" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb28-366"><a href="#cb28-366" aria-hidden="true" tabindex="-1"></a>    id, age, treated, outcome</span>
<span id="cb28-367"><a href="#cb28-367" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-368"><a href="#cb28-368" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">|&gt;</span> </span>
<span id="cb28-369"><a href="#cb28-369" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(</span>
<span id="cb28-370"><a href="#cb28-370" aria-hidden="true" tabindex="-1"></a>    <span class="at">columns =</span> <span class="st">"outcome"</span>,</span>
<span id="cb28-371"><a href="#cb28-371" aria-hidden="true" tabindex="-1"></a>    <span class="at">decimals =</span> <span class="dv">0</span></span>
<span id="cb28-372"><a href="#cb28-372" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-373"><a href="#cb28-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-374"><a href="#cb28-374" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Column labels</span></span>
<span id="cb28-375"><a href="#cb28-375" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(</span>
<span id="cb28-376"><a href="#cb28-376" aria-hidden="true" tabindex="-1"></a>    <span class="at">id =</span> <span class="st">"ID"</span>,</span>
<span id="cb28-377"><a href="#cb28-377" aria-hidden="true" tabindex="-1"></a>    <span class="at">age =</span> <span class="fu">md</span>(<span class="st">"$Z_i$"</span>),</span>
<span id="cb28-378"><a href="#cb28-378" aria-hidden="true" tabindex="-1"></a>    <span class="at">treated =</span> <span class="fu">md</span>(<span class="st">"$X_i$"</span>),</span>
<span id="cb28-379"><a href="#cb28-379" aria-hidden="true" tabindex="-1"></a>    <span class="at">outcome =</span> <span class="fu">md</span>(<span class="st">"$Y_i$"</span>)</span>
<span id="cb28-380"><a href="#cb28-380" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb28-381"><a href="#cb28-381" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-382"><a href="#cb28-382" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Level 1 spanner labels</span></span>
<span id="cb28-383"><a href="#cb28-383" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(</span>
<span id="cb28-384"><a href="#cb28-384" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"Age"</span>, <span class="at">columns =</span> age, </span>
<span id="cb28-385"><a href="#cb28-385" aria-hidden="true" tabindex="-1"></a>    <span class="at">level =</span> <span class="dv">1</span>, <span class="at">id =</span> <span class="st">"level1_a_po_obs"</span></span>
<span id="cb28-386"><a href="#cb28-386" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-387"><a href="#cb28-387" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(</span>
<span id="cb28-388"><a href="#cb28-388" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"Treated"</span>, <span class="at">columns =</span> treated, </span>
<span id="cb28-389"><a href="#cb28-389" aria-hidden="true" tabindex="-1"></a>    <span class="at">level =</span> <span class="dv">1</span>, <span class="at">id =</span> <span class="st">"level1_b_po_obs"</span></span>
<span id="cb28-390"><a href="#cb28-390" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-391"><a href="#cb28-391" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(</span>
<span id="cb28-392"><a href="#cb28-392" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"Outcome"</span>, <span class="at">columns =</span> outcome, </span>
<span id="cb28-393"><a href="#cb28-393" aria-hidden="true" tabindex="-1"></a>    <span class="at">level =</span> <span class="dv">1</span>, <span class="at">id =</span> <span class="st">"level1_c_po_obs"</span></span>
<span id="cb28-394"><a href="#cb28-394" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-395"><a href="#cb28-395" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-396"><a href="#cb28-396" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Level 2 spanner labels</span></span>
<span id="cb28-397"><a href="#cb28-397" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(</span>
<span id="cb28-398"><a href="#cb28-398" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"Confounder"</span>,</span>
<span id="cb28-399"><a href="#cb28-399" aria-hidden="true" tabindex="-1"></a>    <span class="at">columns =</span> age,</span>
<span id="cb28-400"><a href="#cb28-400" aria-hidden="true" tabindex="-1"></a>    <span class="at">level =</span> <span class="dv">2</span>, <span class="at">id =</span> <span class="st">"level2_a_po_obs"</span></span>
<span id="cb28-401"><a href="#cb28-401" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-402"><a href="#cb28-402" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(</span>
<span id="cb28-403"><a href="#cb28-403" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"Treatment"</span>, <span class="at">columns =</span> treated, </span>
<span id="cb28-404"><a href="#cb28-404" aria-hidden="true" tabindex="-1"></a>    <span class="at">level =</span> <span class="dv">2</span>, <span class="at">id =</span> <span class="st">"level2_b_po_obs"</span></span>
<span id="cb28-405"><a href="#cb28-405" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-406"><a href="#cb28-406" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(</span>
<span id="cb28-407"><a href="#cb28-407" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"Realized"</span>, <span class="at">columns =</span> outcome, </span>
<span id="cb28-408"><a href="#cb28-408" aria-hidden="true" tabindex="-1"></a>    <span class="at">level =</span> <span class="dv">2</span>, <span class="at">id =</span> <span class="st">"level2_c_po_obs"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb28-409"><a href="#cb28-409" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-410"><a href="#cb28-410" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Style stuff</span></span>
<span id="cb28-411"><a href="#cb28-411" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_style</span>(</span>
<span id="cb28-412"><a href="#cb28-412" aria-hidden="true" tabindex="-1"></a>    <span class="at">style =</span> <span class="fu">cell_text</span>(<span class="at">align =</span> <span class="st">"center"</span>),</span>
<span id="cb28-413"><a href="#cb28-413" aria-hidden="true" tabindex="-1"></a>    <span class="at">locations =</span> <span class="fu">cells_column_labels</span>()</span>
<span id="cb28-414"><a href="#cb28-414" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-415"><a href="#cb28-415" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_style</span>(</span>
<span id="cb28-416"><a href="#cb28-416" aria-hidden="true" tabindex="-1"></a>    <span class="at">style =</span> <span class="fu">cell_text</span>(<span class="at">align =</span> <span class="st">"center"</span>),</span>
<span id="cb28-417"><a href="#cb28-417" aria-hidden="true" tabindex="-1"></a>    <span class="at">locations =</span> <span class="fu">cells_body</span>()</span>
<span id="cb28-418"><a href="#cb28-418" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-419"><a href="#cb28-419" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_style</span>(</span>
<span id="cb28-420"><a href="#cb28-420" aria-hidden="true" tabindex="-1"></a>    <span class="at">style =</span> <span class="fu">cell_text</span>(<span class="at">weight =</span> <span class="st">"bold"</span>),</span>
<span id="cb28-421"><a href="#cb28-421" aria-hidden="true" tabindex="-1"></a>    <span class="at">locations =</span> <span class="fu">list</span>(</span>
<span id="cb28-422"><a href="#cb28-422" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cells_column_spanners</span>(<span class="at">spanners =</span> <span class="fu">starts_with</span>(<span class="st">"level1"</span>)),</span>
<span id="cb28-423"><a href="#cb28-423" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cells_column_labels</span>(<span class="at">columns =</span> <span class="st">"id"</span>)</span>
<span id="cb28-424"><a href="#cb28-424" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-425"><a href="#cb28-425" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-426"><a href="#cb28-426" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_style</span>(</span>
<span id="cb28-427"><a href="#cb28-427" aria-hidden="true" tabindex="-1"></a>    <span class="at">style =</span> <span class="fu">cell_text</span>(<span class="at">style =</span> <span class="st">"italic"</span>),</span>
<span id="cb28-428"><a href="#cb28-428" aria-hidden="true" tabindex="-1"></a>    <span class="at">locations =</span> <span class="fu">cells_column_spanners</span>(<span class="at">spanners =</span> <span class="fu">starts_with</span>(<span class="st">"level2"</span>))</span>
<span id="cb28-429"><a href="#cb28-429" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-430"><a href="#cb28-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-431"><a href="#cb28-431" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_style</span>(</span>
<span id="cb28-432"><a href="#cb28-432" aria-hidden="true" tabindex="-1"></a>    <span class="at">style =</span> <span class="fu">list</span>(</span>
<span id="cb28-433"><a href="#cb28-433" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cell_fill</span>(<span class="at">color =</span> clrs[<span class="dv">4</span>], <span class="at">alpha =</span> <span class="fl">0.5</span>)</span>
<span id="cb28-434"><a href="#cb28-434" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb28-435"><a href="#cb28-435" aria-hidden="true" tabindex="-1"></a>    <span class="at">locations =</span> <span class="fu">cells_body</span>(<span class="at">rows =</span> treated <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb28-436"><a href="#cb28-436" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-437"><a href="#cb28-437" aria-hidden="true" tabindex="-1"></a>  <span class="fu">opt_horizontal_padding</span>(<span class="at">scale =</span> <span class="dv">3</span>) <span class="sc">|&gt;</span> </span>
<span id="cb28-438"><a href="#cb28-438" aria-hidden="true" tabindex="-1"></a>  <span class="fu">opt_table_font</span>(<span class="at">font =</span> <span class="st">"Jost"</span>)</span>
<span id="cb28-439"><a href="#cb28-439" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-440"><a href="#cb28-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-441"><a href="#cb28-441" aria-hidden="true" tabindex="-1"></a>We could try to find the ATE by finding the average outcome among the treated ($\bar{Y}_\text{Treated}$) and subtracting it from the average outcome among the untreated ($\bar{Y}_\text{Untreated}$):</span>
<span id="cb28-442"><a href="#cb28-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-443"><a href="#cb28-443" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-444"><a href="#cb28-444" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb28-445"><a href="#cb28-445" aria-hidden="true" tabindex="-1"></a>\text{ATE}_\text{naive} &amp;= \bar{Y}_\text{Treated} - \bar{Y}_\text{Untreated} <span class="sc">\\</span></span>
<span id="cb28-446"><a href="#cb28-446" aria-hidden="true" tabindex="-1"></a>&amp;= \frac{80 + 75 + 85 + 75}{4} - \frac{60 + 80 + 100 + 80}{4} <span class="sc">\\</span></span>
<span id="cb28-447"><a href="#cb28-447" aria-hidden="true" tabindex="-1"></a>&amp;= 78.75 - 80 <span class="sc">\\</span></span>
<span id="cb28-448"><a href="#cb28-448" aria-hidden="true" tabindex="-1"></a>&amp;= -1.25</span>
<span id="cb28-449"><a href="#cb28-449" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb28-450"><a href="#cb28-450" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-451"><a href="#cb28-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-452"><a href="#cb28-452" aria-hidden="true" tabindex="-1"></a>But this is horribly wrong. Selection bias is distorting the causal effect here. Treated people sought out treatment because they knew it would be good for them. We can't compare the two groups directly like this because of the systematic differences between them.</span>
<span id="cb28-453"><a href="#cb28-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-454"><a href="#cb28-454" aria-hidden="true" tabindex="-1"></a>We need to somehow account for the fact that the two groups are different. We've been ignoring one column in this table all this time—age ($Z$). It looks like age is highly correlated with treatment status here. 75% of people who signed up for the treatment were old; 75% of people who didn't sign up for the treatment were young.<span class="ot">[^treatment-type]</span> In DAG terms, age seems to be a confounder—it causes both the choice to receive treatment and the ultimate value of the outcome. Age opens up a backdoor relationship between treatment and outcome and messes up the causal effect. If we can somehow statistically account for age, we'll be left with a more accurate estimate of the actual ATE.</span>
<span id="cb28-455"><a href="#cb28-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-456"><a href="#cb28-456" aria-hidden="true" tabindex="-1"></a><span class="ot">[^treatment-type]: </span>Maybe this treatment is a colonoscopy? idk—use your imagination.</span>
<span id="cb28-457"><a href="#cb28-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-460"><a href="#cb28-460" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-461"><a href="#cb28-461" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-dag-basic</span></span>
<span id="cb28-462"><a href="#cb28-462" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "DAG showing that age confounds the relationship between treatment and outcome"</span></span>
<span id="cb28-463"><a href="#cb28-463" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb28-464"><a href="#cb28-464" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 4.5</span></span>
<span id="cb28-465"><a href="#cb28-465" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 2.5</span></span>
<span id="cb28-466"><a href="#cb28-466" aria-hidden="true" tabindex="-1"></a><span class="co">#| out-width: "70%"</span></span>
<span id="cb28-467"><a href="#cb28-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-468"><a href="#cb28-468" aria-hidden="true" tabindex="-1"></a>basic_dag <span class="ot">&lt;-</span> <span class="fu">dagify</span>(</span>
<span id="cb28-469"><a href="#cb28-469" aria-hidden="true" tabindex="-1"></a>  Y <span class="sc">~</span> X <span class="sc">+</span> Z,</span>
<span id="cb28-470"><a href="#cb28-470" aria-hidden="true" tabindex="-1"></a>  X <span class="sc">~</span> Z,</span>
<span id="cb28-471"><a href="#cb28-471" aria-hidden="true" tabindex="-1"></a>  <span class="at">exposure =</span> <span class="st">"X"</span>,</span>
<span id="cb28-472"><a href="#cb28-472" aria-hidden="true" tabindex="-1"></a>  <span class="at">outcome =</span> <span class="st">"Y"</span>,</span>
<span id="cb28-473"><a href="#cb28-473" aria-hidden="true" tabindex="-1"></a>  <span class="at">coords =</span> <span class="fu">list</span>(</span>
<span id="cb28-474"><a href="#cb28-474" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">c</span>(<span class="at">X =</span> <span class="dv">1</span>, <span class="at">Y =</span> <span class="dv">3</span>, <span class="at">Z =</span> <span class="dv">2</span>),</span>
<span id="cb28-475"><a href="#cb28-475" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">c</span>(<span class="at">X =</span> <span class="dv">1</span>, <span class="at">Y =</span> <span class="dv">1</span>, <span class="at">Z =</span> <span class="dv">2</span>)</span>
<span id="cb28-476"><a href="#cb28-476" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-477"><a href="#cb28-477" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-478"><a href="#cb28-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-479"><a href="#cb28-479" aria-hidden="true" tabindex="-1"></a>basic_dag_plot <span class="ot">&lt;-</span> basic_dag <span class="sc">|&gt;</span> </span>
<span id="cb28-480"><a href="#cb28-480" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tidy_dagitty</span>() <span class="sc">|&gt;</span> </span>
<span id="cb28-481"><a href="#cb28-481" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">var_type =</span> <span class="fu">case_when</span>(</span>
<span id="cb28-482"><a href="#cb28-482" aria-hidden="true" tabindex="-1"></a>    name <span class="sc">==</span> <span class="st">"X"</span> <span class="sc">~</span> <span class="st">"Exposure"</span>,</span>
<span id="cb28-483"><a href="#cb28-483" aria-hidden="true" tabindex="-1"></a>    name <span class="sc">==</span> <span class="st">"Y"</span> <span class="sc">~</span> <span class="st">"Outcome"</span>,</span>
<span id="cb28-484"><a href="#cb28-484" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_detect</span>(name, <span class="st">"Z"</span>) <span class="sc">~</span> <span class="st">"Confounder"</span></span>
<span id="cb28-485"><a href="#cb28-485" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">|&gt;</span> </span>
<span id="cb28-486"><a href="#cb28-486" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">var_label =</span> <span class="fu">case_match</span>(name,</span>
<span id="cb28-487"><a href="#cb28-487" aria-hidden="true" tabindex="-1"></a>    <span class="st">"X"</span> <span class="sc">~</span> <span class="st">"Treatment"</span>,</span>
<span id="cb28-488"><a href="#cb28-488" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Y"</span> <span class="sc">~</span> <span class="st">"Outcome"</span>,</span>
<span id="cb28-489"><a href="#cb28-489" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Z"</span> <span class="sc">~</span> <span class="st">"Age"</span></span>
<span id="cb28-490"><a href="#cb28-490" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb28-491"><a href="#cb28-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-492"><a href="#cb28-492" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(basic_dag_plot, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">xend =</span> xend, <span class="at">yend =</span> yend)) <span class="sc">+</span></span>
<span id="cb28-493"><a href="#cb28-493" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_dag_edges</span>() <span class="sc">+</span></span>
<span id="cb28-494"><a href="#cb28-494" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_dag_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> var_type), <span class="at">size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb28-495"><a href="#cb28-495" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_richtext</span>(</span>
<span id="cb28-496"><a href="#cb28-496" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">label =</span> name), <span class="at">fontface =</span> <span class="st">"bold"</span>, <span class="at">color =</span> <span class="st">"white"</span>,</span>
<span id="cb28-497"><a href="#cb28-497" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">label.color =</span> <span class="cn">NA</span>,</span>
<span id="cb28-498"><a href="#cb28-498" aria-hidden="true" tabindex="-1"></a>    <span class="at">label.padding =</span> grid<span class="sc">::</span><span class="fu">unit</span>(<span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="st">"pt"</span>)</span>
<span id="cb28-499"><a href="#cb28-499" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb28-500"><a href="#cb28-500" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_dag_text</span>(</span>
<span id="cb28-501"><a href="#cb28-501" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">filter</span>(basic_dag_plot, var_type <span class="sc">!=</span> <span class="st">"Confounder"</span>), <span class="fu">aes</span>(<span class="at">label =</span> var_label), </span>
<span id="cb28-502"><a href="#cb28-502" aria-hidden="true" tabindex="-1"></a>    <span class="at">nudge_y =</span> <span class="sc">-</span><span class="fl">0.25</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="dv">11</span>, <span class="at">size.unit =</span> <span class="st">"pt"</span></span>
<span id="cb28-503"><a href="#cb28-503" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb28-504"><a href="#cb28-504" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_dag_text</span>(</span>
<span id="cb28-505"><a href="#cb28-505" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">filter</span>(basic_dag_plot, var_type <span class="sc">==</span> <span class="st">"Confounder"</span>), <span class="fu">aes</span>(<span class="at">label =</span> var_label), </span>
<span id="cb28-506"><a href="#cb28-506" aria-hidden="true" tabindex="-1"></a>    <span class="at">nudge_y =</span> <span class="fl">0.26</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="dv">11</span>, <span class="at">size.unit =</span> <span class="st">"pt"</span></span>
<span id="cb28-507"><a href="#cb28-507" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb28-508"><a href="#cb28-508" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> clrs[<span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">1</span>, <span class="dv">6</span>)], <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb28-509"><a href="#cb28-509" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_dag</span>()</span>
<span id="cb28-510"><a href="#cb28-510" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-511"><a href="#cb28-511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-512"><a href="#cb28-512" aria-hidden="true" tabindex="-1"></a>There are lots of ways to adjust for age here (there are whole textbooks about this; matching, inverse probability weighting, etc.). One simple way is to stratify by age and find the sum of weighted averages for old and young people, like this:</span>
<span id="cb28-513"><a href="#cb28-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-514"><a href="#cb28-514" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-515"><a href="#cb28-515" aria-hidden="true" tabindex="-1"></a>\text{ATE} = (\pi_\text{Old} \times \text{Effect}_\text{Old}) + (\pi_\text{Young} \times \text{Effect}_\text{Young})</span>
<span id="cb28-516"><a href="#cb28-516" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-517"><a href="#cb28-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-518"><a href="#cb28-518" aria-hidden="true" tabindex="-1"></a>With the data from the table, we get:</span>
<span id="cb28-519"><a href="#cb28-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-520"><a href="#cb28-520" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-521"><a href="#cb28-521" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb28-522"><a href="#cb28-522" aria-hidden="true" tabindex="-1"></a>\text{Effect}_\text{Stratified} &amp;= (\pi_\text{Treated} \times \bar{Y}_\text{Treated}) - (\pi_\text{Untreated} \times \bar{Y}_\text{Untreated}) <span class="sc">\\</span><span class="co">[</span><span class="ot">20pt</span><span class="co">]</span></span>
<span id="cb28-523"><a href="#cb28-523" aria-hidden="true" tabindex="-1"></a>\text{Effect}_\text{Old} &amp;= \frac{80 + 75 + 85}{3} - \frac{60}{1} &amp;&amp;= 20 <span class="sc">\\</span></span>
<span id="cb28-524"><a href="#cb28-524" aria-hidden="true" tabindex="-1"></a>\text{Effect}_\text{Young} &amp;= \frac{75}{1} - \frac{80 + 100 + 80}{3} &amp;&amp;= -11.667 <span class="sc">\\</span><span class="co">[</span><span class="ot">20pt</span><span class="co">]</span></span>
<span id="cb28-525"><a href="#cb28-525" aria-hidden="true" tabindex="-1"></a>\text{ATE} &amp;= (\frac{4}{8} \times 20) + (\frac{4}{8} \times -11.667) &amp;&amp;= 4.1667</span>
<span id="cb28-526"><a href="#cb28-526" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb28-527"><a href="#cb28-527" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-528"><a href="#cb28-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-529"><a href="#cb28-529" aria-hidden="true" tabindex="-1"></a>4.1667 isn't quite the true ATE of 5, but it's surprisingly close! If we had more than 8 rows of data, we'd get even closer (as long as age was really truly the only confounder).</span>
<span id="cb28-530"><a href="#cb28-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-531"><a href="#cb28-531" aria-hidden="true" tabindex="-1"></a><span class="fu"># Moving beyond the ATE</span></span>
<span id="cb28-532"><a href="#cb28-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-533"><a href="#cb28-533" aria-hidden="true" tabindex="-1"></a>Walking through a table like this is a useful exercise. It illustrates how individual causal effects are unobservable. It shows how we could theoretically find the average treatment effect of some intervention. It highlights the role selection bias and confounding play in distorting causal effects. It points to ways of accounting for confounding through statistical adjustment.</span>
<span id="cb28-534"><a href="#cb28-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-535"><a href="#cb28-535" aria-hidden="true" tabindex="-1"></a>But for me personally, that's about all the utility I've gotten out of tables like this. One aesthetic reason is that these numbers are all really generic—people get an outcome of 80 or 60 or whatever, but 80 or 60 *what*? It's left up to the reader's imagination.</span>
<span id="cb28-536"><a href="#cb28-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-537"><a href="#cb28-537" aria-hidden="true" tabindex="-1"></a>More importantly, though, I've always figured that the ATT and ATU that you calculate from these kinds of tables were extra peripheral estimands that you found on your way to calculating the ATE, and that all you should really care about is the ATE.</span>
<span id="cb28-538"><a href="#cb28-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-539"><a href="#cb28-539" aria-hidden="true" tabindex="-1"></a>**But that's wrong!**</span>
<span id="cb28-540"><a href="#cb28-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-541"><a href="#cb28-541" aria-hidden="true" tabindex="-1"></a>So to rectify this, let's explore the nuances of different flavors of treatment effects using a more involved potential outcomes dataset that's more realistic, based on a hypothetical international development intervention designed to reduce the risk of malaria through the use of anti-mosquito bed nets.<span class="ot">[^net-update]</span> The data is observational and non-experimental—people choose to use the nets or not based on personal preferences. In this case, income and health confound the net → malaria risk relationship: income influences health, and both income and health influence the choice to use a net and overall malaria risk. </span>
<span id="cb28-542"><a href="#cb28-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-545"><a href="#cb28-545" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-546"><a href="#cb28-546" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-dag-mosquito</span></span>
<span id="cb28-547"><a href="#cb28-547" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "DAG showing the relationship between mosquito net use and malaria risk, confounded by health and income"</span></span>
<span id="cb28-548"><a href="#cb28-548" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb28-549"><a href="#cb28-549" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 6</span></span>
<span id="cb28-550"><a href="#cb28-550" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 3.5</span></span>
<span id="cb28-551"><a href="#cb28-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-552"><a href="#cb28-552" aria-hidden="true" tabindex="-1"></a>mosquito_dag <span class="ot">&lt;-</span> <span class="fu">dagitty</span>(<span class="st">'</span></span>
<span id="cb28-553"><a href="#cb28-553" aria-hidden="true" tabindex="-1"></a><span class="st">dag {</span></span>
<span id="cb28-554"><a href="#cb28-554" aria-hidden="true" tabindex="-1"></a><span class="st">"X" [exposure,pos="1,1"]</span></span>
<span id="cb28-555"><a href="#cb28-555" aria-hidden="true" tabindex="-1"></a><span class="st">"Y" [outcome,pos="4,1"]</span></span>
<span id="cb28-556"><a href="#cb28-556" aria-hidden="true" tabindex="-1"></a><span class="st">"Z&lt;sub&gt;1&lt;/sub&gt;" [pos="2,2"]</span></span>
<span id="cb28-557"><a href="#cb28-557" aria-hidden="true" tabindex="-1"></a><span class="st">"Z&lt;sub&gt;2&lt;/sub&gt;" [pos="3,2"]</span></span>
<span id="cb28-558"><a href="#cb28-558" aria-hidden="true" tabindex="-1"></a><span class="st">"Z&lt;sub&gt;2&lt;/sub&gt;" -&gt; "Y"</span></span>
<span id="cb28-559"><a href="#cb28-559" aria-hidden="true" tabindex="-1"></a><span class="st">"Z&lt;sub&gt;2&lt;/sub&gt;" -&gt; "X"</span></span>
<span id="cb28-560"><a href="#cb28-560" aria-hidden="true" tabindex="-1"></a><span class="st">"Z&lt;sub&gt;1&lt;/sub&gt;" -&gt; "Y"</span></span>
<span id="cb28-561"><a href="#cb28-561" aria-hidden="true" tabindex="-1"></a><span class="st">"Z&lt;sub&gt;1&lt;/sub&gt;" -&gt; "Z&lt;sub&gt;2&lt;/sub&gt;"</span></span>
<span id="cb28-562"><a href="#cb28-562" aria-hidden="true" tabindex="-1"></a><span class="st">"Z&lt;sub&gt;1&lt;/sub&gt;" -&gt; "X"</span></span>
<span id="cb28-563"><a href="#cb28-563" aria-hidden="true" tabindex="-1"></a><span class="st">"X" -&gt; "Y"</span></span>
<span id="cb28-564"><a href="#cb28-564" aria-hidden="true" tabindex="-1"></a><span class="st">}'</span>)</span>
<span id="cb28-565"><a href="#cb28-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-566"><a href="#cb28-566" aria-hidden="true" tabindex="-1"></a>dag_plot <span class="ot">&lt;-</span> mosquito_dag <span class="sc">|&gt;</span> </span>
<span id="cb28-567"><a href="#cb28-567" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tidy_dagitty</span>() <span class="sc">|&gt;</span> </span>
<span id="cb28-568"><a href="#cb28-568" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">var_type =</span> <span class="fu">case_when</span>(</span>
<span id="cb28-569"><a href="#cb28-569" aria-hidden="true" tabindex="-1"></a>    name <span class="sc">==</span> <span class="st">"X"</span> <span class="sc">~</span> <span class="st">"Exposure"</span>,</span>
<span id="cb28-570"><a href="#cb28-570" aria-hidden="true" tabindex="-1"></a>    name <span class="sc">==</span> <span class="st">"Y"</span> <span class="sc">~</span> <span class="st">"Outcome"</span>,</span>
<span id="cb28-571"><a href="#cb28-571" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_detect</span>(name, <span class="st">"Z"</span>) <span class="sc">~</span> <span class="st">"Confounder"</span></span>
<span id="cb28-572"><a href="#cb28-572" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">|&gt;</span> </span>
<span id="cb28-573"><a href="#cb28-573" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">var_label =</span> <span class="fu">case_match</span>(name,</span>
<span id="cb28-574"><a href="#cb28-574" aria-hidden="true" tabindex="-1"></a>    <span class="st">"X"</span> <span class="sc">~</span> <span class="st">"Mosquito net"</span>,</span>
<span id="cb28-575"><a href="#cb28-575" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Y"</span> <span class="sc">~</span> <span class="st">"Malaria risk"</span>,</span>
<span id="cb28-576"><a href="#cb28-576" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Z&lt;sub&gt;1&lt;/sub&gt;"</span> <span class="sc">~</span> <span class="st">"Income"</span>,</span>
<span id="cb28-577"><a href="#cb28-577" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Z&lt;sub&gt;2&lt;/sub&gt;"</span> <span class="sc">~</span> <span class="st">"Health"</span></span>
<span id="cb28-578"><a href="#cb28-578" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb28-579"><a href="#cb28-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-580"><a href="#cb28-580" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dag_plot, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">xend =</span> xend, <span class="at">yend =</span> yend)) <span class="sc">+</span></span>
<span id="cb28-581"><a href="#cb28-581" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_dag_edges</span>() <span class="sc">+</span></span>
<span id="cb28-582"><a href="#cb28-582" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_dag_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> var_type), <span class="at">size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb28-583"><a href="#cb28-583" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_richtext</span>(</span>
<span id="cb28-584"><a href="#cb28-584" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">label =</span> name), <span class="at">fontface =</span> <span class="st">"bold"</span>, <span class="at">color =</span> <span class="st">"white"</span>,</span>
<span id="cb28-585"><a href="#cb28-585" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">label.color =</span> <span class="cn">NA</span>,</span>
<span id="cb28-586"><a href="#cb28-586" aria-hidden="true" tabindex="-1"></a>    <span class="at">label.padding =</span> grid<span class="sc">::</span><span class="fu">unit</span>(<span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="st">"pt"</span>)</span>
<span id="cb28-587"><a href="#cb28-587" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb28-588"><a href="#cb28-588" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_dag_text</span>(</span>
<span id="cb28-589"><a href="#cb28-589" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">filter</span>(dag_plot, var_type <span class="sc">!=</span> <span class="st">"Confounder"</span>), <span class="fu">aes</span>(<span class="at">label =</span> var_label), </span>
<span id="cb28-590"><a href="#cb28-590" aria-hidden="true" tabindex="-1"></a>    <span class="at">nudge_y =</span> <span class="sc">-</span><span class="fl">0.15</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="dv">11</span>, <span class="at">size.unit =</span> <span class="st">"pt"</span></span>
<span id="cb28-591"><a href="#cb28-591" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb28-592"><a href="#cb28-592" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_dag_text</span>(</span>
<span id="cb28-593"><a href="#cb28-593" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">filter</span>(dag_plot, var_type <span class="sc">==</span> <span class="st">"Confounder"</span>), <span class="fu">aes</span>(<span class="at">label =</span> var_label), </span>
<span id="cb28-594"><a href="#cb28-594" aria-hidden="true" tabindex="-1"></a>    <span class="at">nudge_y =</span> <span class="fl">0.16</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="dv">11</span>, <span class="at">size.unit =</span> <span class="st">"pt"</span></span>
<span id="cb28-595"><a href="#cb28-595" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb28-596"><a href="#cb28-596" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> clrs[<span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">1</span>, <span class="dv">6</span>)], <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb28-597"><a href="#cb28-597" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_dag</span>()</span>
<span id="cb28-598"><a href="#cb28-598" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-599"><a href="#cb28-599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-600"><a href="#cb28-600" aria-hidden="true" tabindex="-1"></a><span class="ot">[^net-update]: </span>I used a similar dataset <span class="co">[</span><span class="ot">back in this blog post</span><span class="co">](https://www.andrewheiss.com/blog/2020/12/01/ipw-binary-continuous/index.html#binary-treatments)</span>, and I use similar data in my class too; this version is new and improved though, with more explicit confounding and differences between the ATE, ATT, and ATU built in.</span>
<span id="cb28-601"><a href="#cb28-601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-602"><a href="#cb28-602" aria-hidden="true" tabindex="-1"></a>**In this dataset, the true ATE is −15.** Using a bed net causes a 15-unit decrease in malaria risk across the whole population on average.</span>
<span id="cb28-603"><a href="#cb28-603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-604"><a href="#cb28-604" aria-hidden="true" tabindex="-1"></a>In the interest of space, I've hidden the data generation code below. You can also download a CSV version of it here if you want to follow along but not run all the code:</span>
<span id="cb28-605"><a href="#cb28-605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-606"><a href="#cb28-606" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">{{&lt; fa file-csv &gt;}} `mosquito_nets_v2.csv`</span><span class="co">](mosquito_nets_v2.csv)</span></span>
<span id="cb28-607"><a href="#cb28-607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-610"><a href="#cb28-610" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-611"><a href="#cb28-611" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: generate-data</span></span>
<span id="cb28-612"><a href="#cb28-612" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb28-613"><a href="#cb28-613" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Code for generating synthetic mosquito net data"</span></span>
<span id="cb28-614"><a href="#cb28-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-615"><a href="#cb28-615" aria-hidden="true" tabindex="-1"></a>withr<span class="sc">::</span><span class="fu">with_seed</span>(<span class="dv">1234</span>, {</span>
<span id="cb28-616"><a href="#cb28-616" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="dv">1500</span></span>
<span id="cb28-617"><a href="#cb28-617" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-618"><a href="#cb28-618" aria-hidden="true" tabindex="-1"></a>  nets <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb28-619"><a href="#cb28-619" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate exogenous variables</span></span>
<span id="cb28-620"><a href="#cb28-620" aria-hidden="true" tabindex="-1"></a>    <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span>n,</span>
<span id="cb28-621"><a href="#cb28-621" aria-hidden="true" tabindex="-1"></a>    <span class="at">income =</span> <span class="fu">rnorm</span>(n, <span class="dv">500</span>, <span class="dv">100</span>)</span>
<span id="cb28-622"><a href="#cb28-622" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-623"><a href="#cb28-623" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate health, which depends on income</span></span>
<span id="cb28-624"><a href="#cb28-624" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb28-625"><a href="#cb28-625" aria-hidden="true" tabindex="-1"></a>      <span class="at">health =</span> (<span class="fl">0.1</span> <span class="sc">*</span> income) <span class="sc">+</span> <span class="fu">rnorm</span>(n, <span class="dv">0</span>, <span class="dv">10</span>),</span>
<span id="cb28-626"><a href="#cb28-626" aria-hidden="true" tabindex="-1"></a>      <span class="at">health =</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(health, <span class="dv">0</span>), <span class="dv">100</span>)  <span class="co"># Force values to 0-100 range</span></span>
<span id="cb28-627"><a href="#cb28-627" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb28-628"><a href="#cb28-628" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate net usage (treatment), which depends on health and income</span></span>
<span id="cb28-629"><a href="#cb28-629" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb28-630"><a href="#cb28-630" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Make people with high health and high income a lot more likely to</span></span>
<span id="cb28-631"><a href="#cb28-631" aria-hidden="true" tabindex="-1"></a>      <span class="co"># self-select into treatment</span></span>
<span id="cb28-632"><a href="#cb28-632" aria-hidden="true" tabindex="-1"></a>      <span class="at">income_high =</span> income <span class="sc">&gt;</span> <span class="fu">quantile</span>(income, <span class="fl">0.8</span>),</span>
<span id="cb28-633"><a href="#cb28-633" aria-hidden="true" tabindex="-1"></a>      <span class="at">health_high =</span> health <span class="sc">&gt;</span> <span class="fu">quantile</span>(health, <span class="fl">0.8</span>),</span>
<span id="cb28-634"><a href="#cb28-634" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb28-635"><a href="#cb28-635" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Create latent propensity scores based on logit formula</span></span>
<span id="cb28-636"><a href="#cb28-636" aria-hidden="true" tabindex="-1"></a>      <span class="at">net_prob =</span> <span class="fu">plogis</span>(</span>
<span id="cb28-637"><a href="#cb28-637" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span><span class="dv">3</span> <span class="sc">+</span> (income <span class="sc">/</span> <span class="dv">300</span>) <span class="sc">+</span> (health <span class="sc">/</span> <span class="dv">40</span>) <span class="sc">+</span> </span>
<span id="cb28-638"><a href="#cb28-638" aria-hidden="true" tabindex="-1"></a>          (<span class="fl">0.9</span> <span class="sc">*</span> income_high) <span class="sc">+</span> (<span class="fl">0.5</span> <span class="sc">*</span> health_high)),</span>
<span id="cb28-639"><a href="#cb28-639" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb28-640"><a href="#cb28-640" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Assign to treatment</span></span>
<span id="cb28-641"><a href="#cb28-641" aria-hidden="true" tabindex="-1"></a>      <span class="at">net =</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, </span>
<span id="cb28-642"><a href="#cb28-642" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fancy little trick---increase the latent propensity score by 5</span></span>
<span id="cb28-643"><a href="#cb28-643" aria-hidden="true" tabindex="-1"></a>        <span class="co"># percentage points for people already more likely (i.e. p &gt; 50%) to</span></span>
<span id="cb28-644"><a href="#cb28-644" aria-hidden="true" tabindex="-1"></a>        <span class="co"># receive treatment and decrease the propensity score by 8 percentage</span></span>
<span id="cb28-645"><a href="#cb28-645" aria-hidden="true" tabindex="-1"></a>        <span class="co"># points for those already less likely to receive treatment</span></span>
<span id="cb28-646"><a href="#cb28-646" aria-hidden="true" tabindex="-1"></a>        <span class="at">prob =</span> <span class="fu">ifelse</span>(</span>
<span id="cb28-647"><a href="#cb28-647" aria-hidden="true" tabindex="-1"></a>          net_prob <span class="sc">&gt;</span> <span class="fl">0.5</span>, </span>
<span id="cb28-648"><a href="#cb28-648" aria-hidden="true" tabindex="-1"></a>          <span class="fu">pmin</span>(net_prob <span class="sc">+</span> <span class="fl">0.05</span>, <span class="fl">0.98</span>), </span>
<span id="cb28-649"><a href="#cb28-649" aria-hidden="true" tabindex="-1"></a>          <span class="fu">pmax</span>(net_prob <span class="sc">-</span> <span class="fl">0.08</span>, <span class="fl">0.02</span>))</span>
<span id="cb28-650"><a href="#cb28-650" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb28-651"><a href="#cb28-651" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb28-652"><a href="#cb28-652" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate potential and actual outcomes</span></span>
<span id="cb28-653"><a href="#cb28-653" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb28-654"><a href="#cb28-654" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Individual outcomes in a world where individuals are not treated</span></span>
<span id="cb28-655"><a href="#cb28-655" aria-hidden="true" tabindex="-1"></a>      <span class="at">malaria_risk_0 =</span> <span class="dv">90</span> <span class="sc">+</span> (<span class="sc">-</span><span class="fl">0.2</span> <span class="sc">*</span> health) <span class="sc">+</span> (<span class="sc">-</span><span class="fl">0.05</span> <span class="sc">*</span> income) <span class="sc">+</span> <span class="fu">rnorm</span>(n, <span class="dv">0</span>, <span class="dv">6</span>),</span>
<span id="cb28-656"><a href="#cb28-656" aria-hidden="true" tabindex="-1"></a>      <span class="at">malaria_risk_0 =</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(malaria_risk_0, <span class="dv">0</span>), <span class="dv">100</span>),  <span class="co"># Force values to 0-100</span></span>
<span id="cb28-657"><a href="#cb28-657" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb28-658"><a href="#cb28-658" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Individual outcomes in a world where individuals are treated</span></span>
<span id="cb28-659"><a href="#cb28-659" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Basically risk_0 + a baseline treatment effect + extra treatment effect</span></span>
<span id="cb28-660"><a href="#cb28-660" aria-hidden="true" tabindex="-1"></a>      <span class="co"># boosts because of income and health</span></span>
<span id="cb28-661"><a href="#cb28-661" aria-hidden="true" tabindex="-1"></a>      <span class="at">malaria_risk_1 =</span> malaria_risk_0 <span class="sc">-</span> </span>
<span id="cb28-662"><a href="#cb28-662" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rnorm</span>(n, <span class="dv">3</span>, <span class="dv">1</span>) <span class="sc">-</span> (<span class="fl">0.015</span> <span class="sc">*</span> income) <span class="sc">-</span> (<span class="fl">0.09</span> <span class="sc">*</span> health),</span>
<span id="cb28-663"><a href="#cb28-663" aria-hidden="true" tabindex="-1"></a>      <span class="at">malaria_risk_1 =</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(malaria_risk_1, <span class="dv">0</span>), <span class="dv">100</span>),  <span class="co"># Force values to 0-100</span></span>
<span id="cb28-664"><a href="#cb28-664" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb28-665"><a href="#cb28-665" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Round stuff</span></span>
<span id="cb28-666"><a href="#cb28-666" aria-hidden="true" tabindex="-1"></a>      <span class="at">malaria_risk_0 =</span> <span class="fu">round</span>(malaria_risk_0, <span class="dv">1</span>),</span>
<span id="cb28-667"><a href="#cb28-667" aria-hidden="true" tabindex="-1"></a>      <span class="at">malaria_risk_1 =</span> <span class="fu">round</span>(malaria_risk_1, <span class="dv">1</span>),</span>
<span id="cb28-668"><a href="#cb28-668" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb28-669"><a href="#cb28-669" aria-hidden="true" tabindex="-1"></a>      <span class="at">ice =</span> malaria_risk_1 <span class="sc">-</span> malaria_risk_0,</span>
<span id="cb28-670"><a href="#cb28-670" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb28-671"><a href="#cb28-671" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Actual realized outcome</span></span>
<span id="cb28-672"><a href="#cb28-672" aria-hidden="true" tabindex="-1"></a>      <span class="at">malaria_risk =</span> <span class="fu">ifelse</span>(net <span class="sc">==</span> <span class="dv">1</span>, malaria_risk_1, malaria_risk_0)</span>
<span id="cb28-673"><a href="#cb28-673" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb28-674"><a href="#cb28-674" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Round more stuff</span></span>
<span id="cb28-675"><a href="#cb28-675" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(income, health), <span class="sc">~</span><span class="fu">round</span>(., <span class="dv">0</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb28-676"><a href="#cb28-676" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Only keep some columns</span></span>
<span id="cb28-677"><a href="#cb28-677" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(</span>
<span id="cb28-678"><a href="#cb28-678" aria-hidden="true" tabindex="-1"></a>      id, income, income_high, health, health_high, net,</span>
<span id="cb28-679"><a href="#cb28-679" aria-hidden="true" tabindex="-1"></a>      <span class="fu">starts_with</span>(<span class="st">"malaria"</span>), ice</span>
<span id="cb28-680"><a href="#cb28-680" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-681"><a href="#cb28-681" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb28-682"><a href="#cb28-682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-683"><a href="#cb28-683" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(nets, <span class="st">"mosquito_nets_v2.csv"</span>)</span>
<span id="cb28-684"><a href="#cb28-684" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-685"><a href="#cb28-685" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-686"><a href="#cb28-686" aria-hidden="true" tabindex="-1"></a>We have four main variables in this data:</span>
<span id="cb28-687"><a href="#cb28-687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-688"><a href="#cb28-688" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Net use** *(Treatment)*: Binary 0/1, TRUE/FALSE variable indicating if the person uses a bed net.</span>
<span id="cb28-689"><a href="#cb28-689" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Malaria risk** *(Outcome)*: Scale from 0–100, with higher values representing greater risk.</span>
<span id="cb28-690"><a href="#cb28-690" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Income** *(Confounder)*: Weekly income, measured in dollars. Higher income causes a higher probability of using a net; people above the 80th percentile get an extra boost in probability.</span>
<span id="cb28-691"><a href="#cb28-691" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Health** *(Confounder)*: Health status, scale from 0–100, with higher values representing better health. Better health causes a higher probability of using a net; people above the 80th percentile get an extra boost in probability.</span>
<span id="cb28-692"><a href="#cb28-692" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-693"><a href="#cb28-693" aria-hidden="true" tabindex="-1"></a>@tbl-nets-po shows a small excerpt of the data, with people using nets highlighted in yellow to mimic standard example potential outcome tables like @tbl-basic-po.</span>
<span id="cb28-694"><a href="#cb28-694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-697"><a href="#cb28-697" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-698"><a href="#cb28-698" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-nets-po</span></span>
<span id="cb28-699"><a href="#cb28-699" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Potential outcomes, individual causal effects, and realized outcomes for synthetic mosquito net data"</span></span>
<span id="cb28-700"><a href="#cb28-700" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb28-701"><a href="#cb28-701" aria-hidden="true" tabindex="-1"></a><span class="co">#| classes: no-stripe</span></span>
<span id="cb28-702"><a href="#cb28-702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-703"><a href="#cb28-703" aria-hidden="true" tabindex="-1"></a>excerpt <span class="ot">&lt;-</span> nets <span class="sc">|&gt;</span> </span>
<span id="cb28-704"><a href="#cb28-704" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">14</span>, <span class="dv">15</span>, <span class="dv">29</span>, <span class="dv">4</span>, <span class="dv">35</span>, <span class="dv">37</span>, <span class="dv">73</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb28-705"><a href="#cb28-705" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(id)</span>
<span id="cb28-706"><a href="#cb28-706" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-707"><a href="#cb28-707" aria-hidden="true" tabindex="-1"></a>excerpt <span class="sc">|&gt;</span> </span>
<span id="cb28-708"><a href="#cb28-708" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_row</span>(<span class="at">id =</span> <span class="cn">NA</span>) <span class="sc">|&gt;</span> </span>
<span id="cb28-709"><a href="#cb28-709" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb28-710"><a href="#cb28-710" aria-hidden="true" tabindex="-1"></a>    id, income, health, net, </span>
<span id="cb28-711"><a href="#cb28-711" aria-hidden="true" tabindex="-1"></a>    malaria_risk_1, malaria_risk_0, ice, malaria_risk</span>
<span id="cb28-712"><a href="#cb28-712" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-713"><a href="#cb28-713" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">|&gt;</span> </span>
<span id="cb28-714"><a href="#cb28-714" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sub_missing</span>(<span class="at">missing_text =</span> <span class="st">"…"</span>) <span class="sc">|&gt;</span></span>
<span id="cb28-715"><a href="#cb28-715" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(</span>
<span id="cb28-716"><a href="#cb28-716" aria-hidden="true" tabindex="-1"></a>    <span class="at">columns =</span> <span class="fu">c</span>(<span class="fu">starts_with</span>(<span class="st">"malaria_risk"</span>), ice),</span>
<span id="cb28-717"><a href="#cb28-717" aria-hidden="true" tabindex="-1"></a>    <span class="at">decimals =</span> <span class="dv">1</span></span>
<span id="cb28-718"><a href="#cb28-718" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-719"><a href="#cb28-719" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="fu">c</span>(income, health), <span class="at">decimals =</span> <span class="dv">0</span>) <span class="sc">|&gt;</span> </span>
<span id="cb28-720"><a href="#cb28-720" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-721"><a href="#cb28-721" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Column labels</span></span>
<span id="cb28-722"><a href="#cb28-722" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(</span>
<span id="cb28-723"><a href="#cb28-723" aria-hidden="true" tabindex="-1"></a>    <span class="at">id =</span> <span class="st">"ID"</span>,</span>
<span id="cb28-724"><a href="#cb28-724" aria-hidden="true" tabindex="-1"></a>    <span class="at">income =</span> <span class="fu">md</span>(<span class="st">"$Z_{1_i}$"</span>),</span>
<span id="cb28-725"><a href="#cb28-725" aria-hidden="true" tabindex="-1"></a>    <span class="at">health =</span> <span class="fu">md</span>(<span class="st">"$Z_{2_i}$"</span>),</span>
<span id="cb28-726"><a href="#cb28-726" aria-hidden="true" tabindex="-1"></a>    <span class="at">net =</span> <span class="fu">md</span>(<span class="st">"$X_i$"</span>),</span>
<span id="cb28-727"><a href="#cb28-727" aria-hidden="true" tabindex="-1"></a>    <span class="at">malaria_risk_0 =</span> <span class="fu">md</span>(<span class="st">"$Y^0_i$"</span>),</span>
<span id="cb28-728"><a href="#cb28-728" aria-hidden="true" tabindex="-1"></a>    <span class="at">malaria_risk_1 =</span> <span class="fu">md</span>(<span class="st">"$Y^1_i$"</span>),</span>
<span id="cb28-729"><a href="#cb28-729" aria-hidden="true" tabindex="-1"></a>    <span class="at">malaria_risk =</span> <span class="fu">md</span>(<span class="st">"$Y_i$"</span>),</span>
<span id="cb28-730"><a href="#cb28-730" aria-hidden="true" tabindex="-1"></a>    <span class="at">ice =</span> <span class="fu">md</span>(<span class="st">"$Y^1_i - Y^0_i$"</span>)</span>
<span id="cb28-731"><a href="#cb28-731" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb28-732"><a href="#cb28-732" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-733"><a href="#cb28-733" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Level 1 spanner labels</span></span>
<span id="cb28-734"><a href="#cb28-734" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(</span>
<span id="cb28-735"><a href="#cb28-735" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"Income"</span>, <span class="at">columns =</span> income, </span>
<span id="cb28-736"><a href="#cb28-736" aria-hidden="true" tabindex="-1"></a>    <span class="at">level =</span> <span class="dv">1</span>, <span class="at">id =</span> <span class="st">"level1_a"</span></span>
<span id="cb28-737"><a href="#cb28-737" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-738"><a href="#cb28-738" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(</span>
<span id="cb28-739"><a href="#cb28-739" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"Health"</span>, <span class="at">columns =</span> health, </span>
<span id="cb28-740"><a href="#cb28-740" aria-hidden="true" tabindex="-1"></a>    <span class="at">level =</span> <span class="dv">1</span>, <span class="at">id =</span> <span class="st">"level1_b"</span></span>
<span id="cb28-741"><a href="#cb28-741" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-742"><a href="#cb28-742" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(</span>
<span id="cb28-743"><a href="#cb28-743" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"Net use"</span>, <span class="at">columns =</span> net, </span>
<span id="cb28-744"><a href="#cb28-744" aria-hidden="true" tabindex="-1"></a>    <span class="at">level =</span> <span class="dv">1</span>, <span class="at">id =</span> <span class="st">"level1_c"</span></span>
<span id="cb28-745"><a href="#cb28-745" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-746"><a href="#cb28-746" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(</span>
<span id="cb28-747"><a href="#cb28-747" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"Potential outcomes"</span>,</span>
<span id="cb28-748"><a href="#cb28-748" aria-hidden="true" tabindex="-1"></a>    <span class="at">columns =</span> <span class="fu">c</span>(malaria_risk_1, malaria_risk_0),</span>
<span id="cb28-749"><a href="#cb28-749" aria-hidden="true" tabindex="-1"></a>    <span class="at">level =</span> <span class="dv">1</span>, <span class="at">id =</span> <span class="st">"level1_d"</span></span>
<span id="cb28-750"><a href="#cb28-750" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-751"><a href="#cb28-751" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(</span>
<span id="cb28-752"><a href="#cb28-752" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"ICE or </span><span class="sc">\\</span><span class="st">(</span><span class="sc">\\</span><span class="st">delta_i</span><span class="sc">\\</span><span class="st">)"</span>, <span class="at">columns =</span> ice, </span>
<span id="cb28-753"><a href="#cb28-753" aria-hidden="true" tabindex="-1"></a>    <span class="at">level =</span> <span class="dv">1</span>, <span class="at">id =</span> <span class="st">"level1_e"</span></span>
<span id="cb28-754"><a href="#cb28-754" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-755"><a href="#cb28-755" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(</span>
<span id="cb28-756"><a href="#cb28-756" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"Outcome"</span>, <span class="at">columns =</span> malaria_risk, </span>
<span id="cb28-757"><a href="#cb28-757" aria-hidden="true" tabindex="-1"></a>    <span class="at">level =</span> <span class="dv">1</span>, <span class="at">id =</span> <span class="st">"level1_f"</span></span>
<span id="cb28-758"><a href="#cb28-758" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-759"><a href="#cb28-759" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-760"><a href="#cb28-760" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Level 2 spanner labels</span></span>
<span id="cb28-761"><a href="#cb28-761" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(</span>
<span id="cb28-762"><a href="#cb28-762" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"Confounders"</span>,</span>
<span id="cb28-763"><a href="#cb28-763" aria-hidden="true" tabindex="-1"></a>    <span class="at">columns =</span> <span class="fu">c</span>(income, health),</span>
<span id="cb28-764"><a href="#cb28-764" aria-hidden="true" tabindex="-1"></a>    <span class="at">level =</span> <span class="dv">2</span>, <span class="at">id =</span> <span class="st">"level2_a"</span></span>
<span id="cb28-765"><a href="#cb28-765" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-766"><a href="#cb28-766" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(</span>
<span id="cb28-767"><a href="#cb28-767" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"Treatment"</span>, <span class="at">columns =</span> net, </span>
<span id="cb28-768"><a href="#cb28-768" aria-hidden="true" tabindex="-1"></a>    <span class="at">level =</span> <span class="dv">2</span>, <span class="at">id =</span> <span class="st">"level2_b"</span></span>
<span id="cb28-769"><a href="#cb28-769" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-770"><a href="#cb28-770" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(</span>
<span id="cb28-771"><a href="#cb28-771" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"Unobservable"</span>,</span>
<span id="cb28-772"><a href="#cb28-772" aria-hidden="true" tabindex="-1"></a>    <span class="at">columns =</span> <span class="fu">c</span>(malaria_risk_1, malaria_risk_0, ice), </span>
<span id="cb28-773"><a href="#cb28-773" aria-hidden="true" tabindex="-1"></a>    <span class="at">level =</span> <span class="dv">2</span>, <span class="at">id =</span> <span class="st">"level2_c"</span></span>
<span id="cb28-774"><a href="#cb28-774" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-775"><a href="#cb28-775" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(</span>
<span id="cb28-776"><a href="#cb28-776" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"Realized"</span>, <span class="at">columns =</span> malaria_risk, </span>
<span id="cb28-777"><a href="#cb28-777" aria-hidden="true" tabindex="-1"></a>    <span class="at">level =</span> <span class="dv">2</span>, <span class="at">id =</span> <span class="st">"level2_d"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb28-778"><a href="#cb28-778" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-779"><a href="#cb28-779" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Style stuff</span></span>
<span id="cb28-780"><a href="#cb28-780" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_style</span>(</span>
<span id="cb28-781"><a href="#cb28-781" aria-hidden="true" tabindex="-1"></a>    <span class="at">style =</span> <span class="fu">cell_text</span>(<span class="at">align =</span> <span class="st">"center"</span>),</span>
<span id="cb28-782"><a href="#cb28-782" aria-hidden="true" tabindex="-1"></a>    <span class="at">locations =</span> <span class="fu">cells_column_labels</span>()</span>
<span id="cb28-783"><a href="#cb28-783" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-784"><a href="#cb28-784" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_style</span>(</span>
<span id="cb28-785"><a href="#cb28-785" aria-hidden="true" tabindex="-1"></a>    <span class="at">style =</span> <span class="fu">cell_text</span>(<span class="at">align =</span> <span class="st">"center"</span>),</span>
<span id="cb28-786"><a href="#cb28-786" aria-hidden="true" tabindex="-1"></a>    <span class="at">locations =</span> <span class="fu">cells_body</span>()</span>
<span id="cb28-787"><a href="#cb28-787" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-788"><a href="#cb28-788" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_style</span>(</span>
<span id="cb28-789"><a href="#cb28-789" aria-hidden="true" tabindex="-1"></a>    <span class="at">style =</span> <span class="fu">cell_text</span>(<span class="at">weight =</span> <span class="st">"bold"</span>),</span>
<span id="cb28-790"><a href="#cb28-790" aria-hidden="true" tabindex="-1"></a>    <span class="at">locations =</span> <span class="fu">list</span>(</span>
<span id="cb28-791"><a href="#cb28-791" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cells_column_spanners</span>(<span class="at">spanners =</span> <span class="fu">starts_with</span>(<span class="st">"level1"</span>)),</span>
<span id="cb28-792"><a href="#cb28-792" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cells_column_labels</span>(<span class="at">columns =</span> <span class="st">"id"</span>)</span>
<span id="cb28-793"><a href="#cb28-793" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-794"><a href="#cb28-794" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-795"><a href="#cb28-795" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_style</span>(</span>
<span id="cb28-796"><a href="#cb28-796" aria-hidden="true" tabindex="-1"></a>    <span class="at">style =</span> <span class="fu">cell_text</span>(<span class="at">style =</span> <span class="st">"italic"</span>),</span>
<span id="cb28-797"><a href="#cb28-797" aria-hidden="true" tabindex="-1"></a>    <span class="at">locations =</span> <span class="fu">cells_column_spanners</span>(<span class="at">spanners =</span> <span class="fu">starts_with</span>(<span class="st">"level2"</span>))</span>
<span id="cb28-798"><a href="#cb28-798" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-799"><a href="#cb28-799" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-800"><a href="#cb28-800" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_style</span>(</span>
<span id="cb28-801"><a href="#cb28-801" aria-hidden="true" tabindex="-1"></a>    <span class="at">style =</span> <span class="fu">list</span>(</span>
<span id="cb28-802"><a href="#cb28-802" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cell_fill</span>(<span class="at">color =</span> clrs[<span class="dv">4</span>], <span class="at">alpha =</span> <span class="fl">0.5</span>)</span>
<span id="cb28-803"><a href="#cb28-803" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb28-804"><a href="#cb28-804" aria-hidden="true" tabindex="-1"></a>    <span class="at">locations =</span> <span class="fu">cells_body</span>(<span class="at">rows =</span> net <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb28-805"><a href="#cb28-805" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-806"><a href="#cb28-806" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_footnote</span>(</span>
<span id="cb28-807"><a href="#cb28-807" aria-hidden="true" tabindex="-1"></a>    <span class="at">footnote =</span> <span class="st">"ICE = individual causal effect"</span>,</span>
<span id="cb28-808"><a href="#cb28-808" aria-hidden="true" tabindex="-1"></a>    <span class="at">locations =</span> <span class="fu">cells_column_spanners</span>(<span class="at">spanners =</span> <span class="st">"level1_e"</span>)</span>
<span id="cb28-809"><a href="#cb28-809" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-810"><a href="#cb28-810" aria-hidden="true" tabindex="-1"></a>  <span class="fu">opt_footnote_marks</span>(<span class="at">marks =</span> <span class="st">"standard"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb28-811"><a href="#cb28-811" aria-hidden="true" tabindex="-1"></a>  <span class="fu">opt_horizontal_padding</span>(<span class="at">scale =</span> <span class="dv">3</span>) <span class="sc">|&gt;</span> </span>
<span id="cb28-812"><a href="#cb28-812" aria-hidden="true" tabindex="-1"></a>  <span class="fu">opt_table_font</span>(<span class="at">font =</span> <span class="st">"Jost"</span>)</span>
<span id="cb28-813"><a href="#cb28-813" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-814"><a href="#cb28-814" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-815"><a href="#cb28-815" aria-hidden="true" tabindex="-1"></a>Let's use this data to explore and calculate three different estimands from @GreiferStuart:2023: the ATE, the ATT, and the ATU. For each estimand, we'll do this:</span>
<span id="cb28-816"><a href="#cb28-816" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-817"><a href="#cb28-817" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Give a plain translation of what the estimand measures and explanation about why we would care about it</span>
<span id="cb28-818"><a href="#cb28-818" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Calculate the estimand using the true-but-unobservable individual causal effects (ICE), or $\delta$</span>
<span id="cb28-819"><a href="#cb28-819" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Calculate the estimand using propensity score-based weighting and g-computation</span>
<span id="cb28-820"><a href="#cb28-820" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-821"><a href="#cb28-821" aria-hidden="true" tabindex="-1"></a><span class="fu"># Plain translations and true values</span></span>
<span id="cb28-822"><a href="#cb28-822" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-823"><a href="#cb28-823" aria-hidden="true" tabindex="-1"></a>Here's what the synthetic <span class="in">`nets`</span> data looks like—we have columns for each of the columns in @tbl-nets-po, as well as some indicators for whether income and health are above the 80th percentile:</span>
<span id="cb28-824"><a href="#cb28-824" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-827"><a href="#cb28-827" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-828"><a href="#cb28-828" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: show-nets-initial</span></span>
<span id="cb28-829"><a href="#cb28-829" aria-hidden="true" tabindex="-1"></a>nets <span class="sc">|&gt;</span> <span class="fu">glimpse</span>()</span>
<span id="cb28-830"><a href="#cb28-830" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-831"><a href="#cb28-831" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-832"><a href="#cb28-832" aria-hidden="true" tabindex="-1"></a><span class="fu">## ATE</span></span>
<span id="cb28-833"><a href="#cb28-833" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-836"><a href="#cb28-836" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-837"><a href="#cb28-837" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: calc-ate-true-hidden</span></span>
<span id="cb28-838"><a href="#cb28-838" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb28-839"><a href="#cb28-839" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-840"><a href="#cb28-840" aria-hidden="true" tabindex="-1"></a>nice_number <span class="ot">&lt;-</span> scales<span class="sc">::</span><span class="fu">label_number</span>(<span class="at">style_negative =</span> <span class="st">"minus"</span>, <span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb28-841"><a href="#cb28-841" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-842"><a href="#cb28-842" aria-hidden="true" tabindex="-1"></a>true_ate <span class="ot">&lt;-</span> <span class="fu">mean</span>(nets<span class="sc">$</span>ice)</span>
<span id="cb28-843"><a href="#cb28-843" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-844"><a href="#cb28-844" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-845"><a href="#cb28-845" aria-hidden="true" tabindex="-1"></a>The average treatment effect (ATE) is what I've always assumed people always want to find when doing causal inference. It represents the effect of using bed nets across the whole population, even if people wouldn't ordinarily receive the treatment. It's a really broad estimand, so it's good for policies with a wide scope that might influence an entire population, like if a government is considering rolling out free or subsidized bed nets to everyone in the country.</span>
<span id="cb28-846"><a href="#cb28-846" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-847"><a href="#cb28-847" aria-hidden="true" tabindex="-1"></a>We calculate this by taking the average of all individual causal effects: </span>
<span id="cb28-848"><a href="#cb28-848" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-849"><a href="#cb28-849" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-850"><a href="#cb28-850" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb28-851"><a href="#cb28-851" aria-hidden="true" tabindex="-1"></a>\text{ATE} &amp;= E<span class="co">[</span><span class="ot">\delta_i</span><span class="co">]</span> &amp; \text{ or} <span class="sc">\\</span></span>
<span id="cb28-852"><a href="#cb28-852" aria-hidden="true" tabindex="-1"></a>\text{ATE} &amp;= E<span class="co">[</span><span class="ot">Y^1_i - Y^0_i</span><span class="co">]</span></span>
<span id="cb28-853"><a href="#cb28-853" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb28-854"><a href="#cb28-854" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-855"><a href="#cb28-855" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-856"><a href="#cb28-856" aria-hidden="true" tabindex="-1"></a>Conceptually this is the same as imagining two hypothetical worlds: in Universe A we give everyone a bed net (even if they don't need it), and in Universe B we give nobody a bed net. We then calculate the difference in individual causal effects between those worlds.</span>
<span id="cb28-857"><a href="#cb28-857" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-858"><a href="#cb28-858" aria-hidden="true" tabindex="-1"></a>If we look at just the eight rows of the bed net data in @tbl-nets-po, the ATE would be −13.36:</span>
<span id="cb28-859"><a href="#cb28-859" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-860"><a href="#cb28-860" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-861"><a href="#cb28-861" aria-hidden="true" tabindex="-1"></a>\frac{(-17.8) + (-9.8) + (-16.9) + (-16) + (-15.6) + (-10.4) + (-8.9) + (-11.5)}{8} = -13.36</span>
<span id="cb28-862"><a href="#cb28-862" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-863"><a href="#cb28-863" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-864"><a href="#cb28-864" aria-hidden="true" tabindex="-1"></a>We can calculate it with the full data by taking the average of the ICE column. It's <span class="in">`r nice_number(true_ate)`</span>, which is what I baked into the data:</span>
<span id="cb28-865"><a href="#cb28-865" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-868"><a href="#cb28-868" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-869"><a href="#cb28-869" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: calc-ate-po</span></span>
<span id="cb28-870"><a href="#cb28-870" aria-hidden="true" tabindex="-1"></a>nets <span class="sc">|&gt;</span> </span>
<span id="cb28-871"><a href="#cb28-871" aria-hidden="true" tabindex="-1"></a>  <span class="co"># I included the alternative versions here just to show that it's </span></span>
<span id="cb28-872"><a href="#cb28-872" aria-hidden="true" tabindex="-1"></a>  <span class="co"># the average of Y1 - average of Y0</span></span>
<span id="cb28-873"><a href="#cb28-873" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb28-874"><a href="#cb28-874" aria-hidden="true" tabindex="-1"></a>    <span class="at">ATE =</span> <span class="fu">mean</span>(ice),</span>
<span id="cb28-875"><a href="#cb28-875" aria-hidden="true" tabindex="-1"></a>    <span class="at">ATE_alt1 =</span> <span class="fu">mean</span>(malaria_risk_1) <span class="sc">-</span> <span class="fu">mean</span>(malaria_risk_0),</span>
<span id="cb28-876"><a href="#cb28-876" aria-hidden="true" tabindex="-1"></a>    <span class="at">ATE_alt2 =</span> <span class="fu">mean</span>(malaria_risk_1 <span class="sc">-</span> malaria_risk_0)</span>
<span id="cb28-877"><a href="#cb28-877" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-878"><a href="#cb28-878" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-879"><a href="#cb28-879" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-880"><a href="#cb28-880" aria-hidden="true" tabindex="-1"></a><span class="fu">## ATT</span></span>
<span id="cb28-881"><a href="#cb28-881" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-884"><a href="#cb28-884" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-885"><a href="#cb28-885" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: calc-att-true-hidden</span></span>
<span id="cb28-886"><a href="#cb28-886" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb28-887"><a href="#cb28-887" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-888"><a href="#cb28-888" aria-hidden="true" tabindex="-1"></a>true_att <span class="ot">&lt;-</span> nets <span class="sc">|&gt;</span> </span>
<span id="cb28-889"><a href="#cb28-889" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(net <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb28-890"><a href="#cb28-890" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">ATT =</span> <span class="fu">mean</span>(ice)) <span class="sc">|&gt;</span> </span>
<span id="cb28-891"><a href="#cb28-891" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(ATT)</span>
<span id="cb28-892"><a href="#cb28-892" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-893"><a href="#cb28-893" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-894"><a href="#cb28-894" aria-hidden="true" tabindex="-1"></a>The average treatment effect on the treated (ATT) is narrower than the ATE, but (surprisingly!) is often more useful and policy relevant! It represents the effect of using bed nets, but only for people who use bed nets. That feels weird, so here are a few other examples:</span>
<span id="cb28-895"><a href="#cb28-895" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-898"><a href="#cb28-898" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-899"><a href="#cb28-899" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-ate-vs-att</span></span>
<span id="cb28-900"><a href="#cb28-900" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Different types of causal effects that can be found as ATEs and ATTs"</span></span>
<span id="cb28-901"><a href="#cb28-901" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb28-902"><a href="#cb28-902" aria-hidden="true" tabindex="-1"></a><span class="co">#| classes: no-stripe</span></span>
<span id="cb28-903"><a href="#cb28-903" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-904"><a href="#cb28-904" aria-hidden="true" tabindex="-1"></a><span class="fu">tribble</span>(</span>
<span id="cb28-905"><a href="#cb28-905" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>ATE, <span class="sc">~</span>ATT,</span>
<span id="cb28-906"><a href="#cb28-906" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Effect of mosquito bed nets for everyone in the country"</span>, <span class="st">"Effect of mosquito bed nets for people who use bed nets"</span>,</span>
<span id="cb28-907"><a href="#cb28-907" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Effect of military service for typical applicants to the military"</span>, <span class="st">"Effect of military service for typical soldiers"</span>,</span>
<span id="cb28-908"><a href="#cb28-908" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Effect of a job training program on all residents in a state"</span>, <span class="st">"Effect of a job training program on everyone who used it"</span>,</span>
<span id="cb28-909"><a href="#cb28-909" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Effect of a new cancer medicine on everyone in the world"</span>, <span class="st">"Effect of a new cancer medicine on people with cancer"</span></span>
<span id="cb28-910"><a href="#cb28-910" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb28-911"><a href="#cb28-911" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">|&gt;</span> </span>
<span id="cb28-912"><a href="#cb28-912" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_style</span>(</span>
<span id="cb28-913"><a href="#cb28-913" aria-hidden="true" tabindex="-1"></a>    <span class="at">style =</span> <span class="fu">cell_text</span>(<span class="at">weight =</span> <span class="st">"bold"</span>),</span>
<span id="cb28-914"><a href="#cb28-914" aria-hidden="true" tabindex="-1"></a>    <span class="at">locations =</span> <span class="fu">cells_column_labels</span>()</span>
<span id="cb28-915"><a href="#cb28-915" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-916"><a href="#cb28-916" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_style</span>(</span>
<span id="cb28-917"><a href="#cb28-917" aria-hidden="true" tabindex="-1"></a>    <span class="at">style =</span> <span class="fu">cell_text</span>(<span class="at">v_align =</span> <span class="st">"top"</span>),</span>
<span id="cb28-918"><a href="#cb28-918" aria-hidden="true" tabindex="-1"></a>    <span class="at">locations =</span> <span class="fu">cells_body</span>()</span>
<span id="cb28-919"><a href="#cb28-919" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-920"><a href="#cb28-920" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_footnote</span>(</span>
<span id="cb28-921"><a href="#cb28-921" aria-hidden="true" tabindex="-1"></a>    <span class="at">footnote =</span> <span class="fu">html</span>(<span class="st">"Example via &lt;a href='https://stats.stackexchange.com/a/455012/3025'&gt;this Cross Validated response&lt;/a&gt;"</span>),</span>
<span id="cb28-922"><a href="#cb28-922" aria-hidden="true" tabindex="-1"></a>    <span class="at">locations =</span> <span class="fu">cells_body</span>(<span class="at">columns =</span> ATE, <span class="at">rows =</span> <span class="dv">2</span>)</span>
<span id="cb28-923"><a href="#cb28-923" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-924"><a href="#cb28-924" aria-hidden="true" tabindex="-1"></a>  <span class="fu">opt_footnote_marks</span>(<span class="at">marks =</span> <span class="st">"standard"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb28-925"><a href="#cb28-925" aria-hidden="true" tabindex="-1"></a>  <span class="fu">opt_horizontal_padding</span>(<span class="at">scale =</span> <span class="dv">3</span>) <span class="sc">|&gt;</span> </span>
<span id="cb28-926"><a href="#cb28-926" aria-hidden="true" tabindex="-1"></a>  <span class="fu">opt_table_font</span>(<span class="at">font =</span> <span class="st">"Jost"</span>)</span>
<span id="cb28-927"><a href="#cb28-927" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-928"><a href="#cb28-928" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-929"><a href="#cb28-929" aria-hidden="true" tabindex="-1"></a>The ATT feels a lot more useful for policy purposes. In medicine, it feels wrong to judge the effectiveness of a new drug based on the effect it would have on every person; in program evaluation, it feels wrong to judge the effectiveness of a training program on everyone, even if they wouldn't ever use it. </span>
<span id="cb28-930"><a href="#cb28-930" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-931"><a href="#cb28-931" aria-hidden="true" tabindex="-1"></a>**Both the ATE and the ATT are useful estimands for policy!**<span class="ot">[^estimands-policy]</span> </span>
<span id="cb28-932"><a href="#cb28-932" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-933"><a href="#cb28-933" aria-hidden="true" tabindex="-1"></a><span class="ot">[^estimands-policy]: </span>See @HoImaiKing:2007 <span class="co">[</span><span class="ot">p. 204</span><span class="co">]</span> and @GreiferStuart:2023.</span>
<span id="cb28-934"><a href="#cb28-934" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-935"><a href="#cb28-935" aria-hidden="true" tabindex="-1"></a>Conceptually, we can imagine two parallel worlds again: in Universe A we give everyone who's currently using a bed net a net, and in Universe B we take away those nets. We then calculate the difference between those worlds. The ATT thus represents the effect of *withholding* nets from those who would have used them <span class="co">[</span><span class="ot">@GreiferStuart:2023, p. 7</span><span class="co">]</span>.</span>
<span id="cb28-936"><a href="#cb28-936" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-937"><a href="#cb28-937" aria-hidden="true" tabindex="-1"></a>BUT(!!!), thinking about the ATT feels wrong and weird—it feels like we're abandoning the whole idea of a control group and only looking at the treated group—which is why I've always been confused about this estimand. </span>
<span id="cb28-938"><a href="#cb28-938" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-939"><a href="#cb28-939" aria-hidden="true" tabindex="-1"></a>And I'm not alone! In forums and Q&amp;A sites, people always wonder the same thing. Take <span class="co">[</span><span class="ot">this comment to this response on Cross Validated</span><span class="co">](https://stats.stackexchange.com/a/308501/3025)</span>, for instance:</span>
<span id="cb28-940"><a href="#cb28-940" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-941"><a href="#cb28-941" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; I'm a statistician, and I never have understood why someone would want to measure the ATT instead of the ATE. It's important to have a control group to account for regression to the mean effects &amp; other factors - you're missing this when you use the ATT</span></span>
<span id="cb28-942"><a href="#cb28-942" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-943"><a href="#cb28-943" aria-hidden="true" tabindex="-1"></a>It really does feel like we're only looking at treated people. Like this official formula here:</span>
<span id="cb28-944"><a href="#cb28-944" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-945"><a href="#cb28-945" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-946"><a href="#cb28-946" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb28-947"><a href="#cb28-947" aria-hidden="true" tabindex="-1"></a>\text{ATT} &amp;= E<span class="co">[</span><span class="ot">\delta_i \mid X_i = 1</span><span class="co">]</span> &amp; \text{or} <span class="sc">\\</span></span>
<span id="cb28-948"><a href="#cb28-948" aria-hidden="true" tabindex="-1"></a>\text{ATT} &amp;= E<span class="co">[</span><span class="ot">Y^1_i - Y^0_i \mid X_i = 1</span><span class="co">]</span></span>
<span id="cb28-949"><a href="#cb28-949" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb28-950"><a href="#cb28-950" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-951"><a href="#cb28-951" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-952"><a href="#cb28-952" aria-hidden="true" tabindex="-1"></a>That conditional $<span class="co">[</span><span class="ot">\dots \mid X = 1</span><span class="co">]</span>$ part says that we're only looking at treated people. And when we calculate it with hypothetical data, we really truly only look at the treated people. If we only look at the eight rows in @tbl-nets-po, the ATT would be −16.58:</span>
<span id="cb28-953"><a href="#cb28-953" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-954"><a href="#cb28-954" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-955"><a href="#cb28-955" aria-hidden="true" tabindex="-1"></a>\frac{(-17.8) + (-16.9) + (-16) + (-15.6)}{4} = -16.58</span>
<span id="cb28-956"><a href="#cb28-956" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-957"><a href="#cb28-957" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-958"><a href="#cb28-958" aria-hidden="true" tabindex="-1"></a>We can calculate it with the full data by taking the average of the ICE column after filtering the data so that we only look at people using a net. It's <span class="in">`r nice_number(true_att)`</span>, higher than the ATE (implying selection bias).</span>
<span id="cb28-959"><a href="#cb28-959" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-962"><a href="#cb28-962" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-963"><a href="#cb28-963" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: calc-att-po</span></span>
<span id="cb28-964"><a href="#cb28-964" aria-hidden="true" tabindex="-1"></a>nets <span class="sc">|&gt;</span> </span>
<span id="cb28-965"><a href="#cb28-965" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(net <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb28-966"><a href="#cb28-966" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">ATT =</span> <span class="fu">mean</span>(ice))</span>
<span id="cb28-967"><a href="#cb28-967" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-968"><a href="#cb28-968" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-969"><a href="#cb28-969" aria-hidden="true" tabindex="-1"></a>This is why the ATT is weird for me (and lots of other people). We're no longer finding the difference between treated and untreated people; we're looking only at treated people and somehow finding a causal effect, which feels wrong. </span>
<span id="cb28-970"><a href="#cb28-970" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-971"><a href="#cb28-971" aria-hidden="true" tabindex="-1"></a>I actually think that @tbl-nets-po here is making things more confusing for thinking about the ATT with observed data! Any causal effect is the difference between two numbers. Because we have time machine-based data, we're finding the difference between what would have happened in Universe A and Universe B, just for treated people. In real life, though, where we don't have a time machine, we can't find that difference. We still need to compare treated people with untreated people! We'll just do some extra statistical work to make the untreated people more comparable to the treated people.</span>
<span id="cb28-972"><a href="#cb28-972" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-973"><a href="#cb28-973" aria-hidden="true" tabindex="-1"></a>So, **with hypothetical data we compare treated people to their parallel selves and we ignore the untreated; with real data we compare treated people to untreated people** (at least, in part; as we'll see below, we use information from the untreated people to estimate possible average causal effects for just the treated people).</span>
<span id="cb28-974"><a href="#cb28-974" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-975"><a href="#cb28-975" aria-hidden="true" tabindex="-1"></a><span class="fu">## ATU</span></span>
<span id="cb28-976"><a href="#cb28-976" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-979"><a href="#cb28-979" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-980"><a href="#cb28-980" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: calc-atu-true-hidden</span></span>
<span id="cb28-981"><a href="#cb28-981" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb28-982"><a href="#cb28-982" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-983"><a href="#cb28-983" aria-hidden="true" tabindex="-1"></a>true_atu <span class="ot">&lt;-</span> nets <span class="sc">|&gt;</span> </span>
<span id="cb28-984"><a href="#cb28-984" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(net <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">|&gt;</span> </span>
<span id="cb28-985"><a href="#cb28-985" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">ATT =</span> <span class="fu">mean</span>(ice)) <span class="sc">|&gt;</span> </span>
<span id="cb28-986"><a href="#cb28-986" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(ATT)</span>
<span id="cb28-987"><a href="#cb28-987" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-988"><a href="#cb28-988" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-989"><a href="#cb28-989" aria-hidden="true" tabindex="-1"></a>The average treatment effect for the untreated (ATU) is just like the ATT, but in reverse. It represents the effect of using bed nets for people who aren't using them.</span>
<span id="cb28-990"><a href="#cb28-990" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-991"><a href="#cb28-991" aria-hidden="true" tabindex="-1"></a>Let's go back to the two parallel worlds: in Universe A we give everyone who's *not* currently using a bed net a net, and in Universe B we take away those nets. We then calculate the difference between those worlds. The ATU represents the effect of *expanding* treatment to those who did not receive it <span class="co">[</span><span class="ot">@GreiferStuart:2023, p. 7</span><span class="co">]</span>.</span>
<span id="cb28-992"><a href="#cb28-992" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-993"><a href="#cb28-993" aria-hidden="true" tabindex="-1"></a>We calculate this with hypothetical data by taking the average of the individual causal effects for untreated people:</span>
<span id="cb28-994"><a href="#cb28-994" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-995"><a href="#cb28-995" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-996"><a href="#cb28-996" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb28-997"><a href="#cb28-997" aria-hidden="true" tabindex="-1"></a>\text{ATU} &amp;= E<span class="co">[</span><span class="ot">\delta_i \mid X_i = 0</span><span class="co">]</span> &amp; \text{or} <span class="sc">\\</span></span>
<span id="cb28-998"><a href="#cb28-998" aria-hidden="true" tabindex="-1"></a>\text{ATU} &amp;= E<span class="co">[</span><span class="ot">Y^1_i - Y^0_i \mid X_i = 0</span><span class="co">]</span></span>
<span id="cb28-999"><a href="#cb28-999" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb28-1000"><a href="#cb28-1000" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-1001"><a href="#cb28-1001" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1002"><a href="#cb28-1002" aria-hidden="true" tabindex="-1"></a>If we look at just @tbl-nets-po, the ATU would be −10.15:</span>
<span id="cb28-1003"><a href="#cb28-1003" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1004"><a href="#cb28-1004" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-1005"><a href="#cb28-1005" aria-hidden="true" tabindex="-1"></a>\frac{(-9.8) + (-10.4) + (-8.9) + (-11.5)}{4} = -10.15</span>
<span id="cb28-1006"><a href="#cb28-1006" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-1007"><a href="#cb28-1007" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1008"><a href="#cb28-1008" aria-hidden="true" tabindex="-1"></a>We can calculate it with the full data by taking the average of the ICE column after filtering the data so that we only look at people *not* using a net. It's <span class="in">`r nice_number(true_atu)`</span>, lower than the ATE (again, implying selection bias).</span>
<span id="cb28-1009"><a href="#cb28-1009" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1012"><a href="#cb28-1012" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-1013"><a href="#cb28-1013" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: calc-atu-po</span></span>
<span id="cb28-1014"><a href="#cb28-1014" aria-hidden="true" tabindex="-1"></a>nets <span class="sc">|&gt;</span> </span>
<span id="cb28-1015"><a href="#cb28-1015" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(net <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">|&gt;</span> </span>
<span id="cb28-1016"><a href="#cb28-1016" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">ATU =</span> <span class="fu">mean</span>(ice))</span>
<span id="cb28-1017"><a href="#cb28-1017" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1018"><a href="#cb28-1018" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1019"><a href="#cb28-1019" aria-hidden="true" tabindex="-1"></a>Just like the ATT, with hypothetical data we compare untreated people to their parallel selves and we ignore the treated. With real data, we'll compare untreated people to treated people, with some statistical shenanigans to make the two groups comparable and remove confounding and selection bias.</span>
<span id="cb28-1020"><a href="#cb28-1020" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1021"><a href="#cb28-1021" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1022"><a href="#cb28-1022" aria-hidden="true" tabindex="-1"></a><span class="fu"># Selection bias and the ATE, ATT, and ATU</span></span>
<span id="cb28-1023"><a href="#cb28-1023" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1024"><a href="#cb28-1024" aria-hidden="true" tabindex="-1"></a>Before we calculate these different treatment effects with the realized outcomes instead of the hypothetical potential outcomes, let's look really quick at the practical difference between the true ATE, ATT, and ATU. All three estimands are useful for policymaking!</span>
<span id="cb28-1025"><a href="#cb28-1025" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1026"><a href="#cb28-1026" aria-hidden="true" tabindex="-1"></a>The ATE is −15, implying that mosquito nets cause a 15 point reduction in malaria risk for every person in the country. This includes people who live at high elevations where mosquitoes don't live, people who live near mosquito-infested swamps, people who are rich enough to buy <span class="co">[</span><span class="ot">Bill Gates's mosquito laser</span><span class="co">](https://en.wikipedia.org/wiki/Mosquito_laser)</span>, and people who can't afford a net but would really like to use one. If we worked in the Ministry of Health and wanted to know if we should make a new national program that gave everyone a free bed net, the overall reduction in risk is −15, which is probably pretty good!</span>
<span id="cb28-1027"><a href="#cb28-1027" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1028"><a href="#cb28-1028" aria-hidden="true" tabindex="-1"></a>The ATT is −16.29, which is bigger than the ATE. The effect of net usage is bigger for people who are already using the nets. This is because of underlying systematic reasons, or selection bias. Those using nets want to use them because they need them more or can access them more easily—they might live in areas more prone to mosquitoes, or they can afford to buy their own nets, or something else. They know themselves and understand some notion of their personal individual causal effect and seek out nets. If we removed access to their nets, it would have a strong effect.</span>
<span id="cb28-1029"><a href="#cb28-1029" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1030"><a href="#cb28-1030" aria-hidden="true" tabindex="-1"></a>The ATU is −13.63, which is smaller than the ATE. The effect of net usage is smaller for people who aren't using the nets. Again, this is because of selection bias. Those not using nets are likely not using them for systematic reasons—they live far away from mosquitoes, they've received a future malaria vaccine, they have some other form of mosquito abatement, or something else. Because they can read their own minds, they know that mosquito net use won't do much for them personally, so they don't seek out nets. If we expanded access to nets to them, they wouldn't benefit as much.</span>
<span id="cb28-1031"><a href="#cb28-1031" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1032"><a href="#cb28-1032" aria-hidden="true" tabindex="-1"></a>And one final note about the ATE—as we saw before, it includes both the ATT and the ATU. Because it's the average for everyone in the whole population, it's the sum of the weighted averages of these two estimands:</span>
<span id="cb28-1033"><a href="#cb28-1033" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1034"><a href="#cb28-1034" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-1035"><a href="#cb28-1035" aria-hidden="true" tabindex="-1"></a>\text{ATE} = (\pi_\text{Net users} \times \text{ATT}) + (\pi_\text{Net non-users} \times \text{ATU})</span>
<span id="cb28-1036"><a href="#cb28-1036" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-1037"><a href="#cb28-1037" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1038"><a href="#cb28-1038" aria-hidden="true" tabindex="-1"></a>We can confirm this with the data:</span>
<span id="cb28-1039"><a href="#cb28-1039" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1042"><a href="#cb28-1042" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-1043"><a href="#cb28-1043" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: calc-ate-weighted-sum</span></span>
<span id="cb28-1044"><a href="#cb28-1044" aria-hidden="true" tabindex="-1"></a>effect_types <span class="ot">&lt;-</span> nets <span class="sc">|&gt;</span> </span>
<span id="cb28-1045"><a href="#cb28-1045" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(net) <span class="sc">|&gt;</span> </span>
<span id="cb28-1046"><a href="#cb28-1046" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb28-1047"><a href="#cb28-1047" aria-hidden="true" tabindex="-1"></a>    <span class="at">effect =</span> <span class="fu">mean</span>(ice),</span>
<span id="cb28-1048"><a href="#cb28-1048" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>()</span>
<span id="cb28-1049"><a href="#cb28-1049" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-1050"><a href="#cb28-1050" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb28-1051"><a href="#cb28-1051" aria-hidden="true" tabindex="-1"></a>    <span class="at">prop =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n),</span>
<span id="cb28-1052"><a href="#cb28-1052" aria-hidden="true" tabindex="-1"></a>    <span class="at">weighted_effect =</span> effect <span class="sc">*</span> prop</span>
<span id="cb28-1053"><a href="#cb28-1053" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-1054"><a href="#cb28-1054" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">estimand =</span> <span class="fu">case_match</span>(net, <span class="dv">0</span> <span class="sc">~</span> <span class="st">"ATU"</span>, <span class="dv">1</span> <span class="sc">~</span> <span class="st">"ATT"</span>), <span class="at">.before =</span> <span class="dv">1</span>)</span>
<span id="cb28-1055"><a href="#cb28-1055" aria-hidden="true" tabindex="-1"></a>effect_types</span>
<span id="cb28-1056"><a href="#cb28-1056" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1057"><a href="#cb28-1057" aria-hidden="true" tabindex="-1"></a>effect_types <span class="sc">|&gt;</span> </span>
<span id="cb28-1058"><a href="#cb28-1058" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">ATE =</span> <span class="fu">sum</span>(weighted_effect))</span>
<span id="cb28-1059"><a href="#cb28-1059" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1060"><a href="#cb28-1060" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1061"><a href="#cb28-1061" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1062"><a href="#cb28-1062" aria-hidden="true" tabindex="-1"></a><span class="fu"># Finding these estimands with non-potential-outcome-based data</span></span>
<span id="cb28-1063"><a href="#cb28-1063" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1064"><a href="#cb28-1064" aria-hidden="true" tabindex="-1"></a>So far we've calculated the ATE, ATT, and ATU with data based on a time machine. In real life, we can only see this:</span>
<span id="cb28-1065"><a href="#cb28-1065" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1068"><a href="#cb28-1068" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-1069"><a href="#cb28-1069" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-nets-realized</span></span>
<span id="cb28-1070"><a href="#cb28-1070" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Observed version of @tbl-nets-po showing only the realized outcome"</span></span>
<span id="cb28-1071"><a href="#cb28-1071" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb28-1072"><a href="#cb28-1072" aria-hidden="true" tabindex="-1"></a><span class="co">#| classes: no-stripe</span></span>
<span id="cb28-1073"><a href="#cb28-1073" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1074"><a href="#cb28-1074" aria-hidden="true" tabindex="-1"></a>excerpt <span class="sc">|&gt;</span> </span>
<span id="cb28-1075"><a href="#cb28-1075" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_row</span>(<span class="at">id =</span> <span class="cn">NA</span>) <span class="sc">|&gt;</span> </span>
<span id="cb28-1076"><a href="#cb28-1076" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb28-1077"><a href="#cb28-1077" aria-hidden="true" tabindex="-1"></a>    id, income, health, net, malaria_risk</span>
<span id="cb28-1078"><a href="#cb28-1078" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-1079"><a href="#cb28-1079" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">|&gt;</span> </span>
<span id="cb28-1080"><a href="#cb28-1080" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sub_missing</span>(<span class="at">missing_text =</span> <span class="st">"…"</span>) <span class="sc">|&gt;</span></span>
<span id="cb28-1081"><a href="#cb28-1081" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(</span>
<span id="cb28-1082"><a href="#cb28-1082" aria-hidden="true" tabindex="-1"></a>    <span class="at">columns =</span> malaria_risk,</span>
<span id="cb28-1083"><a href="#cb28-1083" aria-hidden="true" tabindex="-1"></a>    <span class="at">decimals =</span> <span class="dv">1</span></span>
<span id="cb28-1084"><a href="#cb28-1084" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-1085"><a href="#cb28-1085" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="fu">c</span>(income, health), <span class="at">decimals =</span> <span class="dv">0</span>) <span class="sc">|&gt;</span> </span>
<span id="cb28-1086"><a href="#cb28-1086" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1087"><a href="#cb28-1087" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Column labels</span></span>
<span id="cb28-1088"><a href="#cb28-1088" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(</span>
<span id="cb28-1089"><a href="#cb28-1089" aria-hidden="true" tabindex="-1"></a>    <span class="at">id =</span> <span class="st">"ID"</span>,</span>
<span id="cb28-1090"><a href="#cb28-1090" aria-hidden="true" tabindex="-1"></a>    <span class="at">income =</span> <span class="fu">md</span>(<span class="st">"$Z_{1_i}$"</span>),</span>
<span id="cb28-1091"><a href="#cb28-1091" aria-hidden="true" tabindex="-1"></a>    <span class="at">health =</span> <span class="fu">md</span>(<span class="st">"$Z_{2_i}$"</span>),</span>
<span id="cb28-1092"><a href="#cb28-1092" aria-hidden="true" tabindex="-1"></a>    <span class="at">net =</span> <span class="fu">md</span>(<span class="st">"$X_i$"</span>),</span>
<span id="cb28-1093"><a href="#cb28-1093" aria-hidden="true" tabindex="-1"></a>    <span class="at">malaria_risk =</span> <span class="fu">md</span>(<span class="st">"$Y_i$"</span>)</span>
<span id="cb28-1094"><a href="#cb28-1094" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb28-1095"><a href="#cb28-1095" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1096"><a href="#cb28-1096" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Level 1 spanner labels</span></span>
<span id="cb28-1097"><a href="#cb28-1097" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(</span>
<span id="cb28-1098"><a href="#cb28-1098" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"Income"</span>, <span class="at">columns =</span> income, </span>
<span id="cb28-1099"><a href="#cb28-1099" aria-hidden="true" tabindex="-1"></a>    <span class="at">level =</span> <span class="dv">1</span>, <span class="at">id =</span> <span class="st">"level1_a_obs"</span></span>
<span id="cb28-1100"><a href="#cb28-1100" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-1101"><a href="#cb28-1101" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(</span>
<span id="cb28-1102"><a href="#cb28-1102" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"Health"</span>, <span class="at">columns =</span> health, </span>
<span id="cb28-1103"><a href="#cb28-1103" aria-hidden="true" tabindex="-1"></a>    <span class="at">level =</span> <span class="dv">1</span>, <span class="at">id =</span> <span class="st">"level1_b_obs"</span></span>
<span id="cb28-1104"><a href="#cb28-1104" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-1105"><a href="#cb28-1105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(</span>
<span id="cb28-1106"><a href="#cb28-1106" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"Net use"</span>, <span class="at">columns =</span> net, </span>
<span id="cb28-1107"><a href="#cb28-1107" aria-hidden="true" tabindex="-1"></a>    <span class="at">level =</span> <span class="dv">1</span>, <span class="at">id =</span> <span class="st">"level1_c_obs"</span></span>
<span id="cb28-1108"><a href="#cb28-1108" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-1109"><a href="#cb28-1109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(</span>
<span id="cb28-1110"><a href="#cb28-1110" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"Outcome"</span>, <span class="at">columns =</span> malaria_risk, </span>
<span id="cb28-1111"><a href="#cb28-1111" aria-hidden="true" tabindex="-1"></a>    <span class="at">level =</span> <span class="dv">1</span>, <span class="at">id =</span> <span class="st">"level1_d_obs"</span></span>
<span id="cb28-1112"><a href="#cb28-1112" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-1113"><a href="#cb28-1113" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1114"><a href="#cb28-1114" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Level 2 spanner labels</span></span>
<span id="cb28-1115"><a href="#cb28-1115" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(</span>
<span id="cb28-1116"><a href="#cb28-1116" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"Confounders"</span>,</span>
<span id="cb28-1117"><a href="#cb28-1117" aria-hidden="true" tabindex="-1"></a>    <span class="at">columns =</span> <span class="fu">c</span>(income, health),</span>
<span id="cb28-1118"><a href="#cb28-1118" aria-hidden="true" tabindex="-1"></a>    <span class="at">level =</span> <span class="dv">2</span>, <span class="at">id =</span> <span class="st">"level2_a_obs"</span></span>
<span id="cb28-1119"><a href="#cb28-1119" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-1120"><a href="#cb28-1120" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(</span>
<span id="cb28-1121"><a href="#cb28-1121" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"Treatment"</span>, <span class="at">columns =</span> net, </span>
<span id="cb28-1122"><a href="#cb28-1122" aria-hidden="true" tabindex="-1"></a>    <span class="at">level =</span> <span class="dv">2</span>, <span class="at">id =</span> <span class="st">"level2_b_obs"</span></span>
<span id="cb28-1123"><a href="#cb28-1123" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-1124"><a href="#cb28-1124" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(</span>
<span id="cb28-1125"><a href="#cb28-1125" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"Realized"</span>, <span class="at">columns =</span> malaria_risk, </span>
<span id="cb28-1126"><a href="#cb28-1126" aria-hidden="true" tabindex="-1"></a>    <span class="at">level =</span> <span class="dv">2</span>, <span class="at">id =</span> <span class="st">"level2_c_obs"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb28-1127"><a href="#cb28-1127" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1128"><a href="#cb28-1128" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Style stuff</span></span>
<span id="cb28-1129"><a href="#cb28-1129" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_style</span>(</span>
<span id="cb28-1130"><a href="#cb28-1130" aria-hidden="true" tabindex="-1"></a>    <span class="at">style =</span> <span class="fu">cell_text</span>(<span class="at">align =</span> <span class="st">"center"</span>),</span>
<span id="cb28-1131"><a href="#cb28-1131" aria-hidden="true" tabindex="-1"></a>    <span class="at">locations =</span> <span class="fu">cells_column_labels</span>()</span>
<span id="cb28-1132"><a href="#cb28-1132" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-1133"><a href="#cb28-1133" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_style</span>(</span>
<span id="cb28-1134"><a href="#cb28-1134" aria-hidden="true" tabindex="-1"></a>    <span class="at">style =</span> <span class="fu">cell_text</span>(<span class="at">align =</span> <span class="st">"center"</span>),</span>
<span id="cb28-1135"><a href="#cb28-1135" aria-hidden="true" tabindex="-1"></a>    <span class="at">locations =</span> <span class="fu">cells_body</span>()</span>
<span id="cb28-1136"><a href="#cb28-1136" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-1137"><a href="#cb28-1137" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_style</span>(</span>
<span id="cb28-1138"><a href="#cb28-1138" aria-hidden="true" tabindex="-1"></a>    <span class="at">style =</span> <span class="fu">cell_text</span>(<span class="at">weight =</span> <span class="st">"bold"</span>),</span>
<span id="cb28-1139"><a href="#cb28-1139" aria-hidden="true" tabindex="-1"></a>    <span class="at">locations =</span> <span class="fu">list</span>(</span>
<span id="cb28-1140"><a href="#cb28-1140" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cells_column_spanners</span>(<span class="at">spanners =</span> <span class="fu">starts_with</span>(<span class="st">"level1"</span>)),</span>
<span id="cb28-1141"><a href="#cb28-1141" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cells_column_labels</span>(<span class="at">columns =</span> <span class="st">"id"</span>)</span>
<span id="cb28-1142"><a href="#cb28-1142" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-1143"><a href="#cb28-1143" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-1144"><a href="#cb28-1144" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_style</span>(</span>
<span id="cb28-1145"><a href="#cb28-1145" aria-hidden="true" tabindex="-1"></a>    <span class="at">style =</span> <span class="fu">cell_text</span>(<span class="at">style =</span> <span class="st">"italic"</span>),</span>
<span id="cb28-1146"><a href="#cb28-1146" aria-hidden="true" tabindex="-1"></a>    <span class="at">locations =</span> <span class="fu">cells_column_spanners</span>(<span class="at">spanners =</span> <span class="fu">starts_with</span>(<span class="st">"level2"</span>))</span>
<span id="cb28-1147"><a href="#cb28-1147" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-1148"><a href="#cb28-1148" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1149"><a href="#cb28-1149" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_style</span>(</span>
<span id="cb28-1150"><a href="#cb28-1150" aria-hidden="true" tabindex="-1"></a>    <span class="at">style =</span> <span class="fu">list</span>(</span>
<span id="cb28-1151"><a href="#cb28-1151" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cell_fill</span>(<span class="at">color =</span> clrs[<span class="dv">4</span>], <span class="at">alpha =</span> <span class="fl">0.5</span>)</span>
<span id="cb28-1152"><a href="#cb28-1152" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb28-1153"><a href="#cb28-1153" aria-hidden="true" tabindex="-1"></a>    <span class="at">locations =</span> <span class="fu">cells_body</span>(<span class="at">rows =</span> net <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb28-1154"><a href="#cb28-1154" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-1155"><a href="#cb28-1155" aria-hidden="true" tabindex="-1"></a>  <span class="fu">opt_horizontal_padding</span>(<span class="at">scale =</span> <span class="dv">3</span>) <span class="sc">|&gt;</span> </span>
<span id="cb28-1156"><a href="#cb28-1156" aria-hidden="true" tabindex="-1"></a>  <span class="fu">opt_table_font</span>(<span class="at">font =</span> <span class="st">"Jost"</span>)</span>
<span id="cb28-1157"><a href="#cb28-1157" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1158"><a href="#cb28-1158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1159"><a href="#cb28-1159" aria-hidden="true" tabindex="-1"></a>$\delta_i$ is gone; we only have $Y_i$. Instead of comparing and finding the differences between individuals and their parallel selves, we need to find the differences between treated and untreated people *while removing the selection bias and confounding caused by income and health*.</span>
<span id="cb28-1160"><a href="#cb28-1160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1161"><a href="#cb28-1161" aria-hidden="true" tabindex="-1"></a>In the initial example in @tbl-basic-po, there was just one confounder (old vs. young), and we adjusted for it by stratifying by age, combining the weighted averages for old and young people. Basic stratification like that is a lot harder to do here. Both income and health are continuous—we can't just find weighted averages of rich vs. poor and sick vs. healthy people. We've got to do something fancier to make comparable comparison groups, like matching or weighting. </span>
<span id="cb28-1162"><a href="#cb28-1162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1163"><a href="#cb28-1163" aria-hidden="true" tabindex="-1"></a>Importantly, **we have to match or weight in a way that is appropriate to the estimand we care about.** The matching procedure that we follow for finding the ATE can't be used for finding the ATT; the weighting process that we use for the ATU is different from what we use for the ATE. This is the main argument in @GreiferStuart:2023—the choice of estimand determines the process of statistical adjustment.</span>
<span id="cb28-1164"><a href="#cb28-1164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1165"><a href="#cb28-1165" aria-hidden="true" tabindex="-1"></a>Noah Greifer has two incredible parallel guides to doing this adjustment with both <span class="co">[</span><span class="ot">weighting with {WeightIt}</span><span class="co">](https://ngreifer.github.io/WeightIt/articles/estimating-effects.html)</span> and <span class="co">[</span><span class="ot">matching with {MatchIt}</span><span class="co">](https://kosukeimai.github.io/MatchIt/articles/estimating-effects.html)</span>. We'll illustrate this with propensity score weighting, but the same principles apply to matching (and the code is almost identical!)</span>
<span id="cb28-1166"><a href="#cb28-1166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1167"><a href="#cb28-1167" aria-hidden="true" tabindex="-1"></a>Covering the exact mechanics of probability weighting goes beyond the scope of this blog post! Check out these resources to learn more:</span>
<span id="cb28-1168"><a href="#cb28-1168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1169"><a href="#cb28-1169" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Chapter 12 in @HernanRobins:2024</span>
<span id="cb28-1170"><a href="#cb28-1170" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Section 10.7 in @Heiss:2021</span>
<span id="cb28-1171"><a href="#cb28-1171" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Lucy D'Agostino McGowan's <span class="co">[</span><span class="ot">"Understanding propensity score weighting"</span><span class="co">](https://livefreeordichotomize.com/posts/2019-01-17-understanding-propensity-score-weighting/)</span></span>
<span id="cb28-1172"><a href="#cb28-1172" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Noah Greifer's {WeightIt} vignette, <span class="co">[</span><span class="ot">"Estimating Effects After Weighting"</span><span class="co">](https://ngreifer.github.io/WeightIt/articles/estimating-effects.html)</span></span>
<span id="cb28-1173"><a href="#cb28-1173" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>My <span class="co">[</span><span class="ot">guide to matching and inverse probability weighting</span><span class="co">](https://evalsp24.classes.andrewheiss.com/example/matching-ipw.html)</span> from my causal inference class and <span class="co">[</span><span class="ot">the corresponding lecture video</span><span class="co">](https://evalsp24.classes.andrewheiss.com/content/07-content.html)</span></span>
<span id="cb28-1174"><a href="#cb28-1174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1175"><a href="#cb28-1175" aria-hidden="true" tabindex="-1"></a>In general, with weighting we use confounders to predict the probability of choosing treatment, and then use these propensity scores to reweight the treated and untreated groups so that they resemble each other, thus removing any influence that the confounders have on the choice to select into treatment. My mental model of weighting is that we create pseudo-populations of treated and untreated people that feel like what would happen if we had randomly assigned everyone to treatment or control conditions—it's like creating fake treatment and control groups.</span>
<span id="cb28-1176"><a href="#cb28-1176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1177"><a href="#cb28-1177" aria-hidden="true" tabindex="-1"></a><span class="fu">## ATE</span></span>
<span id="cb28-1178"><a href="#cb28-1178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1179"><a href="#cb28-1179" aria-hidden="true" tabindex="-1"></a>To find the ATE, we need to adjust both the treated and untreated groups so that they are comparable. The most common way to do this is to create inverse probability weights, where all treated people get a weight of $\frac{1}{p_i}$ and all untreated people get a weight of $\frac{1}{1 - p_i}$ (where $p_i$ refers to each person's propensity scores).</span>
<span id="cb28-1180"><a href="#cb28-1180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1181"><a href="#cb28-1181" aria-hidden="true" tabindex="-1"></a>Practically speaking, this gives more weight to more unusual and unexpected observations. For instance, someone with a high predicted probability (90%) of choosing to use a net who then uses a net isn't really notable and will have a low weight ($\frac{1}{0.9}$, or 1.111). Someone else with a high probability (90% again) of choosing a net who *doesn't* use a net will have a high weight ($\frac{1}{1 - 0.9}$, or 10). This makes it so that the should-have-probably-used-a-net person is more comparable to the corresponding untreated people.</span>
<span id="cb28-1182"><a href="#cb28-1182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1183"><a href="#cb28-1183" aria-hidden="true" tabindex="-1"></a>Visualization helps a lot with this intuition!</span>
<span id="cb28-1184"><a href="#cb28-1184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1185"><a href="#cb28-1185" aria-hidden="true" tabindex="-1"></a>First, we'll use logistic regression to calculate the predicted probabilities of using a net. We'll then create inverse probability weights with this formula, which uses the fact that <span class="in">`net`</span> is stored as 0 or 1 to assign the correct treated vs. untreated weight:</span>
<span id="cb28-1186"><a href="#cb28-1186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1187"><a href="#cb28-1187" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-1188"><a href="#cb28-1188" aria-hidden="true" tabindex="-1"></a>\frac{\text{Treatment}}{\text{Propensity}} + \frac{1 - \text{Treatment}}{1 - \text{Propensity}}</span>
<span id="cb28-1189"><a href="#cb28-1189" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-1190"><a href="#cb28-1190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1193"><a href="#cb28-1193" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-1194"><a href="#cb28-1194" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: calc-wts-net-ate-manual</span></span>
<span id="cb28-1195"><a href="#cb28-1195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1196"><a href="#cb28-1196" aria-hidden="true" tabindex="-1"></a><span class="co"># Logistic regression model to predict net usage</span></span>
<span id="cb28-1197"><a href="#cb28-1197" aria-hidden="true" tabindex="-1"></a>model_treatment <span class="ot">&lt;-</span> <span class="fu">glm</span>(</span>
<span id="cb28-1198"><a href="#cb28-1198" aria-hidden="true" tabindex="-1"></a>  net <span class="sc">~</span> income <span class="sc">+</span> health, </span>
<span id="cb28-1199"><a href="#cb28-1199" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> nets, </span>
<span id="cb28-1200"><a href="#cb28-1200" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>)</span>
<span id="cb28-1201"><a href="#cb28-1201" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-1202"><a href="#cb28-1202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1203"><a href="#cb28-1203" aria-hidden="true" tabindex="-1"></a><span class="co"># Plug original data into the model to generate predicted probabilities</span></span>
<span id="cb28-1204"><a href="#cb28-1204" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb28-1205"><a href="#cb28-1205" aria-hidden="true" tabindex="-1"></a><span class="co"># (Here I'm using broom::augment_columns(), but you can also use </span></span>
<span id="cb28-1206"><a href="#cb28-1206" aria-hidden="true" tabindex="-1"></a><span class="co">#  marginaleffects::predictions() or even base R's predict())</span></span>
<span id="cb28-1207"><a href="#cb28-1207" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-1208"><a href="#cb28-1208" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a new column for the weights</span></span>
<span id="cb28-1209"><a href="#cb28-1209" aria-hidden="true" tabindex="-1"></a>nets_with_weights <span class="ot">&lt;-</span> <span class="fu">augment_columns</span>(</span>
<span id="cb28-1210"><a href="#cb28-1210" aria-hidden="true" tabindex="-1"></a>  model_treatment,</span>
<span id="cb28-1211"><a href="#cb28-1211" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> nets,</span>
<span id="cb28-1212"><a href="#cb28-1212" aria-hidden="true" tabindex="-1"></a>  <span class="at">type.predict =</span> <span class="st">"response"</span></span>
<span id="cb28-1213"><a href="#cb28-1213" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb28-1214"><a href="#cb28-1214" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">propensity =</span> .fitted) <span class="sc">|&gt;</span> </span>
<span id="cb28-1215"><a href="#cb28-1215" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">wts_ate =</span> (net <span class="sc">/</span> propensity) <span class="sc">+</span> ((<span class="dv">1</span> <span class="sc">-</span> net) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> propensity)))</span>
<span id="cb28-1216"><a href="#cb28-1216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1217"><a href="#cb28-1217" aria-hidden="true" tabindex="-1"></a><span class="co"># See if it worked</span></span>
<span id="cb28-1218"><a href="#cb28-1218" aria-hidden="true" tabindex="-1"></a>nets_with_weights <span class="sc">|&gt;</span> </span>
<span id="cb28-1219"><a href="#cb28-1219" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id, income, health, net, malaria_risk, propensity, wts_ate)</span>
<span id="cb28-1220"><a href="#cb28-1220" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1221"><a href="#cb28-1221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1222"><a href="#cb28-1222" aria-hidden="true" tabindex="-1"></a>Alternatively, we can use the {WeightIt} package to do the same thing:</span>
<span id="cb28-1223"><a href="#cb28-1223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1226"><a href="#cb28-1226" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-1227"><a href="#cb28-1227" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: calc-wts-net-ate</span></span>
<span id="cb28-1228"><a href="#cb28-1228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1229"><a href="#cb28-1229" aria-hidden="true" tabindex="-1"></a><span class="co"># Get ATE-focused weights for the treatment model</span></span>
<span id="cb28-1230"><a href="#cb28-1230" aria-hidden="true" tabindex="-1"></a>weights_ate <span class="ot">&lt;-</span> <span class="fu">weightit</span>(</span>
<span id="cb28-1231"><a href="#cb28-1231" aria-hidden="true" tabindex="-1"></a>  net <span class="sc">~</span> income <span class="sc">+</span> health, </span>
<span id="cb28-1232"><a href="#cb28-1232" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> nets, </span>
<span id="cb28-1233"><a href="#cb28-1233" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"glm"</span>, </span>
<span id="cb28-1234"><a href="#cb28-1234" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimand =</span> <span class="st">"ATE"</span></span>
<span id="cb28-1235"><a href="#cb28-1235" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-1236"><a href="#cb28-1236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1237"><a href="#cb28-1237" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the weights as a column in the data</span></span>
<span id="cb28-1238"><a href="#cb28-1238" aria-hidden="true" tabindex="-1"></a>nets_with_weights<span class="sc">$</span>wts_ate_automatic <span class="ot">&lt;-</span> weights_ate<span class="sc">$</span>weights</span>
<span id="cb28-1239"><a href="#cb28-1239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1240"><a href="#cb28-1240" aria-hidden="true" tabindex="-1"></a><span class="co"># They're the same!</span></span>
<span id="cb28-1241"><a href="#cb28-1241" aria-hidden="true" tabindex="-1"></a>nets_with_weights <span class="sc">|&gt;</span> </span>
<span id="cb28-1242"><a href="#cb28-1242" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id, wts_ate, wts_ate_automatic) <span class="sc">|&gt;</span> </span>
<span id="cb28-1243"><a href="#cb28-1243" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>()</span>
<span id="cb28-1244"><a href="#cb28-1244" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1245"><a href="#cb28-1245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1246"><a href="#cb28-1246" aria-hidden="true" tabindex="-1"></a>Let's copy <span class="co">[</span><span class="ot">Lucy D'Agostino McGowan's approach</span><span class="co">](https://livefreeordichotomize.com/posts/2019-01-17-understanding-propensity-score-weighting/)</span> and visualize the distribution of these propensity scores across treatment status:</span>
<span id="cb28-1247"><a href="#cb28-1247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1250"><a href="#cb28-1250" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-1251"><a href="#cb28-1251" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-propensity-treated-untreated</span></span>
<span id="cb28-1252"><a href="#cb28-1252" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Mirrored histogram showing the distribution of propensity scores for treated and untreated people"</span></span>
<span id="cb28-1253"><a href="#cb28-1253" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 6</span></span>
<span id="cb28-1254"><a href="#cb28-1254" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 3.75</span></span>
<span id="cb28-1255"><a href="#cb28-1255" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb28-1256"><a href="#cb28-1256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1257"><a href="#cb28-1257" aria-hidden="true" tabindex="-1"></a>plot_data_weights_ate <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb28-1258"><a href="#cb28-1258" aria-hidden="true" tabindex="-1"></a>  <span class="at">propensity =</span> weights_ate<span class="sc">$</span>ps,</span>
<span id="cb28-1259"><a href="#cb28-1259" aria-hidden="true" tabindex="-1"></a>  <span class="at">weight =</span> weights_ate<span class="sc">$</span>weights,</span>
<span id="cb28-1260"><a href="#cb28-1260" aria-hidden="true" tabindex="-1"></a>  <span class="at">treatment =</span> weights_ate<span class="sc">$</span>treat</span>
<span id="cb28-1261"><a href="#cb28-1261" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-1262"><a href="#cb28-1262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1263"><a href="#cb28-1263" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb28-1264"><a href="#cb28-1264" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">data =</span> <span class="fu">filter</span>(plot_data_weights_ate, treatment <span class="sc">==</span> <span class="dv">1</span>), </span>
<span id="cb28-1265"><a href="#cb28-1265" aria-hidden="true" tabindex="-1"></a>    <span class="at">bins =</span> <span class="dv">50</span>, <span class="fu">aes</span>(<span class="at">x =</span> propensity, <span class="at">fill =</span> <span class="st">"Treated people"</span>)) <span class="sc">+</span> </span>
<span id="cb28-1266"><a href="#cb28-1266" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">data =</span> <span class="fu">filter</span>(plot_data_weights_ate, treatment <span class="sc">==</span> <span class="dv">0</span>), </span>
<span id="cb28-1267"><a href="#cb28-1267" aria-hidden="true" tabindex="-1"></a>    <span class="at">bins =</span> <span class="dv">50</span>, <span class="fu">aes</span>(<span class="at">x =</span> propensity, <span class="at">y =</span> <span class="sc">-</span><span class="fu">after_stat</span>(count), <span class="at">fill =</span> <span class="st">"Untreated people"</span>)) <span class="sc">+</span></span>
<span id="cb28-1268"><a href="#cb28-1268" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">linewidth =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb28-1269"><a href="#cb28-1269" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_percent</span>()) <span class="sc">+</span></span>
<span id="cb28-1270"><a href="#cb28-1270" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">label =</span> abs) <span class="sc">+</span></span>
<span id="cb28-1271"><a href="#cb28-1271" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(clrs[<span class="dv">1</span>], clrs[<span class="dv">6</span>]), <span class="at">guide =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span></span>
<span id="cb28-1272"><a href="#cb28-1272" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Propensity"</span>, <span class="at">y =</span> <span class="st">"Count"</span>, <span class="at">fill =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb28-1273"><a href="#cb28-1273" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb28-1274"><a href="#cb28-1274" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"top"</span>,</span>
<span id="cb28-1275"><a href="#cb28-1275" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.key.size =</span> <span class="fu">unit</span>(<span class="fl">0.65</span>, <span class="st">"lines"</span>)</span>
<span id="cb28-1276"><a href="#cb28-1276" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-1277"><a href="#cb28-1277" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1278"><a href="#cb28-1278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1279"><a href="#cb28-1279" aria-hidden="true" tabindex="-1"></a>In general, the people who used nets had a higher probability of using them, while the people who didn't use nets had a lower probability of using them. That's to be expected.</span>
<span id="cb28-1280"><a href="#cb28-1280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1281"><a href="#cb28-1281" aria-hidden="true" tabindex="-1"></a>But there are some people who had a low probability of using nets who *did* use them, and some people who had a high probability of using nets who *did not* use them. That's curious and weird. These people are arguably very similar (i.e. with similar income and health), but for whatever reason, they didn't do what the model predicted they should do.</span>
<span id="cb28-1282"><a href="#cb28-1282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1285"><a href="#cb28-1285" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-1286"><a href="#cb28-1286" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-propensity-weird-highlight</span></span>
<span id="cb28-1287"><a href="#cb28-1287" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: 'Mirrored histogram showing "weird" parts of the population: treated people who were unlikely to be treated, and untreated people who were likely to be treated'</span></span>
<span id="cb28-1288"><a href="#cb28-1288" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 6</span></span>
<span id="cb28-1289"><a href="#cb28-1289" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 3.75</span></span>
<span id="cb28-1290"><a href="#cb28-1290" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb28-1291"><a href="#cb28-1291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1292"><a href="#cb28-1292" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb28-1293"><a href="#cb28-1293" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">data =</span> <span class="fu">filter</span>(plot_data_weights_ate, treatment <span class="sc">==</span> <span class="dv">1</span>), </span>
<span id="cb28-1294"><a href="#cb28-1294" aria-hidden="true" tabindex="-1"></a>    <span class="at">bins =</span> <span class="dv">50</span>, <span class="fu">aes</span>(<span class="at">x =</span> propensity, <span class="at">fill =</span> <span class="st">"Treated people"</span>)) <span class="sc">+</span> </span>
<span id="cb28-1295"><a href="#cb28-1295" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">data =</span> <span class="fu">filter</span>(plot_data_weights_ate, treatment <span class="sc">==</span> <span class="dv">0</span>), </span>
<span id="cb28-1296"><a href="#cb28-1296" aria-hidden="true" tabindex="-1"></a>    <span class="at">bins =</span> <span class="dv">50</span>, <span class="fu">aes</span>(<span class="at">x =</span> propensity, <span class="at">y =</span> <span class="sc">-</span><span class="fu">after_stat</span>(count), <span class="at">fill =</span> <span class="st">"Untreated people"</span>)) <span class="sc">+</span></span>
<span id="cb28-1297"><a href="#cb28-1297" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(</span>
<span id="cb28-1298"><a href="#cb28-1298" aria-hidden="true" tabindex="-1"></a>    <span class="at">geom =</span> <span class="st">"rect"</span>, <span class="at">xmin =</span> <span class="dv">0</span>, <span class="at">xmax =</span> <span class="fl">0.55</span>, <span class="at">ymin =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">ymax =</span> <span class="dv">23</span>,</span>
<span id="cb28-1299"><a href="#cb28-1299" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="fu">alpha</span>(clrs[<span class="dv">4</span>], <span class="fl">0.1</span>), <span class="at">color =</span> clrs[<span class="dv">4</span>], <span class="at">linewidth =</span> <span class="dv">1</span></span>
<span id="cb28-1300"><a href="#cb28-1300" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb28-1301"><a href="#cb28-1301" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(</span>
<span id="cb28-1302"><a href="#cb28-1302" aria-hidden="true" tabindex="-1"></a>    <span class="at">geom =</span> <span class="st">"text"</span>, <span class="at">x =</span> <span class="fl">0.01</span>, <span class="at">y =</span> <span class="fl">21.5</span>, </span>
<span id="cb28-1303"><a href="#cb28-1303" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"Treated people who were</span><span class="sc">\n</span><span class="st">unlikely to be treated.</span><span class="sc">\n</span><span class="st">Weird!"</span>,</span>
<span id="cb28-1304"><a href="#cb28-1304" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> clrs[<span class="dv">3</span>], <span class="at">fontface =</span> <span class="st">"bold"</span>, <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">vjust =</span> <span class="dv">1</span>, <span class="at">lineheight =</span> <span class="dv">1</span></span>
<span id="cb28-1305"><a href="#cb28-1305" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb28-1306"><a href="#cb28-1306" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(</span>
<span id="cb28-1307"><a href="#cb28-1307" aria-hidden="true" tabindex="-1"></a>    <span class="at">geom =</span> <span class="st">"rect"</span>, <span class="at">xmin =</span> <span class="fl">0.58</span>, <span class="at">xmax =</span> <span class="dv">1</span>, <span class="at">ymin =</span> <span class="dv">1</span>, <span class="at">ymax =</span> <span class="sc">-</span><span class="fl">27.5</span>,</span>
<span id="cb28-1308"><a href="#cb28-1308" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="fu">alpha</span>(clrs[<span class="dv">4</span>], <span class="fl">0.1</span>), <span class="at">color =</span> clrs[<span class="dv">4</span>], <span class="at">linewidth =</span> <span class="dv">1</span></span>
<span id="cb28-1309"><a href="#cb28-1309" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb28-1310"><a href="#cb28-1310" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(</span>
<span id="cb28-1311"><a href="#cb28-1311" aria-hidden="true" tabindex="-1"></a>    <span class="at">geom =</span> <span class="st">"text"</span>, <span class="at">x =</span> <span class="fl">0.99</span>, <span class="at">y =</span> <span class="sc">-</span><span class="dv">26</span>, </span>
<span id="cb28-1312"><a href="#cb28-1312" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"Weird!</span><span class="sc">\n</span><span class="st">Untreated people who</span><span class="sc">\n</span><span class="st">were likely to be treated."</span>,</span>
<span id="cb28-1313"><a href="#cb28-1313" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> clrs[<span class="dv">3</span>], <span class="at">fontface =</span> <span class="st">"bold"</span>, <span class="at">hjust =</span> <span class="dv">1</span>, <span class="at">vjust =</span> <span class="dv">0</span>, <span class="at">lineheight =</span> <span class="dv">1</span></span>
<span id="cb28-1314"><a href="#cb28-1314" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb28-1315"><a href="#cb28-1315" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">linewidth =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb28-1316"><a href="#cb28-1316" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_percent</span>()) <span class="sc">+</span></span>
<span id="cb28-1317"><a href="#cb28-1317" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">label =</span> abs) <span class="sc">+</span></span>
<span id="cb28-1318"><a href="#cb28-1318" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(clrs[<span class="dv">1</span>], clrs[<span class="dv">6</span>]), <span class="at">guide =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span></span>
<span id="cb28-1319"><a href="#cb28-1319" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Propensity"</span>, <span class="at">y =</span> <span class="st">"Count"</span>, <span class="at">fill =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb28-1320"><a href="#cb28-1320" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb28-1321"><a href="#cb28-1321" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"top"</span>,</span>
<span id="cb28-1322"><a href="#cb28-1322" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.key.size =</span> <span class="fu">unit</span>(<span class="fl">0.65</span>, <span class="st">"lines"</span>)</span>
<span id="cb28-1323"><a href="#cb28-1323" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-1324"><a href="#cb28-1324" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1325"><a href="#cb28-1325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1326"><a href="#cb28-1326" aria-hidden="true" tabindex="-1"></a>If we scale everyone's importance according to their inverse probability weights, we can give more importance to these "weird" untreated-but-should-have-been-treated and treated-but-shouldn't-have-been-treated people, making them more balanced compared to their treated-and-should-have-been-treated and untreated-and-should-have-been-untreated counterparts. The fainter histogram here represents the adjusted and reweighted pseudo-populations of net users and non-net users. These two pseudo-populations are now free of the confounding coming from health and income and are arguably more comparable, acting more like randomized treatment and control groups.</span>
<span id="cb28-1327"><a href="#cb28-1327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1330"><a href="#cb28-1330" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-1331"><a href="#cb28-1331" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-propensity-weighted-ate</span></span>
<span id="cb28-1332"><a href="#cb28-1332" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Mirrored histogram showing pseudo-populations of treated and untreated people that have been reweighted to be more comparable and unconfounded"</span></span>
<span id="cb28-1333"><a href="#cb28-1333" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 6</span></span>
<span id="cb28-1334"><a href="#cb28-1334" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 4.5</span></span>
<span id="cb28-1335"><a href="#cb28-1335" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb28-1336"><a href="#cb28-1336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1337"><a href="#cb28-1337" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb28-1338"><a href="#cb28-1338" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">data =</span> <span class="fu">filter</span>(plot_data_weights_ate, treatment <span class="sc">==</span> <span class="dv">1</span>), </span>
<span id="cb28-1339"><a href="#cb28-1339" aria-hidden="true" tabindex="-1"></a>    <span class="at">bins =</span> <span class="dv">50</span>, <span class="fu">aes</span>(<span class="at">x =</span> propensity, <span class="at">weight =</span> weight, <span class="at">fill =</span> <span class="st">"Treated pseudo-population"</span>)) <span class="sc">+</span> </span>
<span id="cb28-1340"><a href="#cb28-1340" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">data =</span> <span class="fu">filter</span>(plot_data_weights_ate, treatment <span class="sc">==</span> <span class="dv">0</span>), </span>
<span id="cb28-1341"><a href="#cb28-1341" aria-hidden="true" tabindex="-1"></a>    <span class="at">bins =</span> <span class="dv">50</span>, <span class="fu">aes</span>(<span class="at">x =</span> propensity, <span class="at">weight =</span> weight, <span class="at">y =</span> <span class="sc">-</span><span class="fu">after_stat</span>(count), <span class="at">fill =</span> <span class="st">"Untreated psuedo-population"</span>)) <span class="sc">+</span></span>
<span id="cb28-1342"><a href="#cb28-1342" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">data =</span> <span class="fu">filter</span>(plot_data_weights_ate, treatment <span class="sc">==</span> <span class="dv">1</span>), </span>
<span id="cb28-1343"><a href="#cb28-1343" aria-hidden="true" tabindex="-1"></a>    <span class="at">bins =</span> <span class="dv">50</span>, <span class="fu">aes</span>(<span class="at">x =</span> propensity, <span class="at">fill =</span> <span class="st">"Treated people"</span>)) <span class="sc">+</span> </span>
<span id="cb28-1344"><a href="#cb28-1344" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">data =</span> <span class="fu">filter</span>(plot_data_weights_ate, treatment <span class="sc">==</span> <span class="dv">0</span>), </span>
<span id="cb28-1345"><a href="#cb28-1345" aria-hidden="true" tabindex="-1"></a>    <span class="at">bins =</span> <span class="dv">50</span>, <span class="fu">aes</span>(<span class="at">x =</span> propensity, <span class="at">y =</span> <span class="sc">-</span><span class="fu">after_stat</span>(count), <span class="at">fill =</span> <span class="st">"Untreated people"</span>)) <span class="sc">+</span></span>
<span id="cb28-1346"><a href="#cb28-1346" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(</span>
<span id="cb28-1347"><a href="#cb28-1347" aria-hidden="true" tabindex="-1"></a>    <span class="at">geom =</span> <span class="st">"text"</span>, <span class="at">x =</span> <span class="fl">0.5</span>, <span class="at">y =</span> <span class="dv">60</span>, <span class="at">label =</span> <span class="st">"More weight here"</span>, </span>
<span id="cb28-1348"><a href="#cb28-1348" aria-hidden="true" tabindex="-1"></a>    <span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>, <span class="at">color =</span> clrs[<span class="dv">3</span>]</span>
<span id="cb28-1349"><a href="#cb28-1349" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb28-1350"><a href="#cb28-1350" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(</span>
<span id="cb28-1351"><a href="#cb28-1351" aria-hidden="true" tabindex="-1"></a>    <span class="at">geom =</span> <span class="st">"segment"</span>, <span class="at">x =</span> <span class="fl">0.48</span>, <span class="at">xend =</span> <span class="fl">0.17</span>, <span class="at">y =</span> <span class="dv">55</span>, <span class="at">yend =</span> <span class="dv">25</span>, <span class="at">color =</span> <span class="st">"white"</span>, </span>
<span id="cb28-1352"><a href="#cb28-1352" aria-hidden="true" tabindex="-1"></a>    <span class="at">arrow =</span> <span class="fu">arrow</span>(<span class="at">angle =</span> <span class="dv">15</span>, <span class="at">length =</span> <span class="fu">unit</span>(<span class="fl">0.5</span>, <span class="st">"lines"</span>)), <span class="at">linewidth =</span> <span class="fl">2.5</span></span>
<span id="cb28-1353"><a href="#cb28-1353" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb28-1354"><a href="#cb28-1354" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(</span>
<span id="cb28-1355"><a href="#cb28-1355" aria-hidden="true" tabindex="-1"></a>    <span class="at">geom =</span> <span class="st">"segment"</span>, <span class="at">x =</span> <span class="fl">0.48</span>, <span class="at">xend =</span> <span class="fl">0.17</span>, <span class="at">y =</span> <span class="dv">55</span>, <span class="at">yend =</span> <span class="dv">25</span>, <span class="at">color =</span> clrs[<span class="dv">3</span>], </span>
<span id="cb28-1356"><a href="#cb28-1356" aria-hidden="true" tabindex="-1"></a>    <span class="at">arrow =</span> <span class="fu">arrow</span>(<span class="at">angle =</span> <span class="dv">15</span>, <span class="at">length =</span> <span class="fu">unit</span>(<span class="fl">0.5</span>, <span class="st">"lines"</span>)), <span class="at">linewidth =</span> <span class="fl">0.5</span></span>
<span id="cb28-1357"><a href="#cb28-1357" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb28-1358"><a href="#cb28-1358" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(</span>
<span id="cb28-1359"><a href="#cb28-1359" aria-hidden="true" tabindex="-1"></a>    <span class="at">geom =</span> <span class="st">"segment"</span>, <span class="at">x =</span> <span class="fl">0.52</span>, <span class="at">xend =</span> <span class="fl">0.8</span>, <span class="at">y =</span> <span class="dv">55</span>, <span class="at">yend =</span> <span class="sc">-</span><span class="dv">20</span>, <span class="at">color =</span> <span class="st">"white"</span>, </span>
<span id="cb28-1360"><a href="#cb28-1360" aria-hidden="true" tabindex="-1"></a>    <span class="at">arrow =</span> <span class="fu">arrow</span>(<span class="at">angle =</span> <span class="dv">15</span>, <span class="at">length =</span> <span class="fu">unit</span>(<span class="fl">0.5</span>, <span class="st">"lines"</span>)), <span class="at">linewidth =</span> <span class="fl">2.5</span></span>
<span id="cb28-1361"><a href="#cb28-1361" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb28-1362"><a href="#cb28-1362" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(</span>
<span id="cb28-1363"><a href="#cb28-1363" aria-hidden="true" tabindex="-1"></a>    <span class="at">geom =</span> <span class="st">"segment"</span>, <span class="at">x =</span> <span class="fl">0.52</span>, <span class="at">xend =</span> <span class="fl">0.8</span>, <span class="at">y =</span> <span class="dv">55</span>, <span class="at">yend =</span> <span class="sc">-</span><span class="dv">20</span>, <span class="at">color =</span> clrs[<span class="dv">3</span>], </span>
<span id="cb28-1364"><a href="#cb28-1364" aria-hidden="true" tabindex="-1"></a>    <span class="at">arrow =</span> <span class="fu">arrow</span>(<span class="at">angle =</span> <span class="dv">15</span>, <span class="at">length =</span> <span class="fu">unit</span>(<span class="fl">0.5</span>, <span class="st">"lines"</span>)), <span class="at">linewidth =</span> <span class="fl">0.5</span></span>
<span id="cb28-1365"><a href="#cb28-1365" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb28-1366"><a href="#cb28-1366" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">linewidth =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb28-1367"><a href="#cb28-1367" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_percent</span>()) <span class="sc">+</span></span>
<span id="cb28-1368"><a href="#cb28-1368" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">label =</span> abs) <span class="sc">+</span></span>
<span id="cb28-1369"><a href="#cb28-1369" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(</span>
<span id="cb28-1370"><a href="#cb28-1370" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(clrs[<span class="dv">1</span>], colorspace<span class="sc">::</span><span class="fu">lighten</span>(clrs[<span class="dv">1</span>], <span class="fl">0.5</span>), clrs[<span class="dv">6</span>], colorspace<span class="sc">::</span><span class="fu">lighten</span>(clrs[<span class="dv">6</span>], <span class="fl">0.65</span>)), </span>
<span id="cb28-1371"><a href="#cb28-1371" aria-hidden="true" tabindex="-1"></a>    <span class="at">guide =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">FALSE</span>, <span class="at">nrow =</span> <span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb28-1372"><a href="#cb28-1372" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Propensity"</span>, <span class="at">y =</span> <span class="st">"Count"</span>, <span class="at">fill =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb28-1373"><a href="#cb28-1373" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb28-1374"><a href="#cb28-1374" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"top"</span>,</span>
<span id="cb28-1375"><a href="#cb28-1375" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.key.size =</span> <span class="fu">unit</span>(<span class="fl">0.65</span>, <span class="st">"lines"</span>)</span>
<span id="cb28-1376"><a href="#cb28-1376" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-1377"><a href="#cb28-1377" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1378"><a href="#cb28-1378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1379"><a href="#cb28-1379" aria-hidden="true" tabindex="-1"></a>To find the ATE using these weights, we can fit a regression model for the outcome. We'll then use an approach called <span class="co">[</span><span class="ot">*g-computation*</span><span class="co">](https://ngreifer.github.io/WeightIt/articles/estimating-effects.html#g-computation)</span> to find the marginal causal effect (i.e. the causal effect of flipping net from "no" to "yes"). G-computation is a neat approach that feels more like the original potential outcomes framework we looked at earlier. It involves a few steps:</span>
<span id="cb28-1380"><a href="#cb28-1380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1381"><a href="#cb28-1381" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Fit a regression model predicting the outcome, like <span class="in">`lm(malaria_risk ~ net, weights = w_ate, ...)`</span></span>
<span id="cb28-1382"><a href="#cb28-1382" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Use the model to generate a set of predictions where we pretend that every person used a net (i.e. set <span class="in">`net = 1`</span>)</span>
<span id="cb28-1383"><a href="#cb28-1383" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Use the model to generate a set of predictions where we pretend that every person did not use a net (i.e. set <span class="in">`net = 0`</span>)</span>
<span id="cb28-1384"><a href="#cb28-1384" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>Calculate the difference in the two sets of predictions to create a sort of predicted individual causal effect, then find the average of *that*. This is the ATE.</span>
<span id="cb28-1385"><a href="#cb28-1385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1386"><a href="#cb28-1386" aria-hidden="true" tabindex="-1"></a>That looks really complicated and involved and feels like a lot of coding work, but {marignaleffects} makes this incredibly easy (there's even <span class="co">[</span><span class="ot">a chapter dedicated to it in the documentation</span><span class="co">](https://marginaleffects.com/vignettes/gcomputation.html)</span>). Basically, all we have to do is use <span class="in">`avg_comparisons(model_outcome, variables = list(net = 0:1))`</span>, or even more simply <span class="in">`avg_comparisons(model_outcome, variables = "net")`</span>. This will do all the work of setting everyone's treatment to 0, to 1, and finding the difference. We can do fancier things with it too, like finding robust and/or clustered standard errors, or <span class="co">[</span><span class="ot">bootstrapping the standard errors</span><span class="co">](https://ngreifer.github.io/WeightIt/articles/estimating-effects.html#using-bootstrapping-to-estimate-confidence-intervals)</span>.</span>
<span id="cb28-1387"><a href="#cb28-1387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1390"><a href="#cb28-1390" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-1391"><a href="#cb28-1391" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: calc-net-ate</span></span>
<span id="cb28-1392"><a href="#cb28-1392" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit an outcome model using the inverse probability weights</span></span>
<span id="cb28-1393"><a href="#cb28-1393" aria-hidden="true" tabindex="-1"></a>model_outcome_ate <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb28-1394"><a href="#cb28-1394" aria-hidden="true" tabindex="-1"></a>  malaria_risk <span class="sc">~</span> net, </span>
<span id="cb28-1395"><a href="#cb28-1395" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> nets_with_weights, </span>
<span id="cb28-1396"><a href="#cb28-1396" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> wts_ate_automatic</span>
<span id="cb28-1397"><a href="#cb28-1397" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-1398"><a href="#cb28-1398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1399"><a href="#cb28-1399" aria-hidden="true" tabindex="-1"></a><span class="co"># Automatic g-computation with {marginaleffects}! This sets the "net" column to</span></span>
<span id="cb28-1400"><a href="#cb28-1400" aria-hidden="true" tabindex="-1"></a><span class="co"># each possible value of net (0 and 1) for the whole dataset, then calculates</span></span>
<span id="cb28-1401"><a href="#cb28-1401" aria-hidden="true" tabindex="-1"></a><span class="co"># the difference between the two sets of predictions</span></span>
<span id="cb28-1402"><a href="#cb28-1402" aria-hidden="true" tabindex="-1"></a><span class="fu">avg_comparisons</span>(model_outcome_ate, <span class="at">variables =</span> <span class="st">"net"</span>)</span>
<span id="cb28-1403"><a href="#cb28-1403" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1404"><a href="#cb28-1404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1407"><a href="#cb28-1407" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-1408"><a href="#cb28-1408" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: calc-ate-hidden</span></span>
<span id="cb28-1409"><a href="#cb28-1409" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb28-1410"><a href="#cb28-1410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1411"><a href="#cb28-1411" aria-hidden="true" tabindex="-1"></a>estimated_ate <span class="ot">&lt;-</span> <span class="fu">avg_comparisons</span>(model_outcome_ate, <span class="at">variables =</span> <span class="st">"net"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb28-1412"><a href="#cb28-1412" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(estimate)</span>
<span id="cb28-1413"><a href="#cb28-1413" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1414"><a href="#cb28-1414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1415"><a href="#cb28-1415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1416"><a href="#cb28-1416" aria-hidden="true" tabindex="-1"></a>Based on our inverse probability weighting approach, the ATE from observational data (i.e. not using the unknowable individual potential outcomes) is <span class="in">`r nice_number(estimated_ate)`</span>, which is super close to the true ATE of <span class="in">`r nice_number(true_ate)`</span>!</span>
<span id="cb28-1417"><a href="#cb28-1417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1418"><a href="#cb28-1418" aria-hidden="true" tabindex="-1"></a><span class="fu">## ATT</span></span>
<span id="cb28-1419"><a href="#cb28-1419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1420"><a href="#cb28-1420" aria-hidden="true" tabindex="-1"></a>That ATE shows the effect of the net program for *everyone*, even people who have no need for a net. If we're interested in making this a universal program, the ATE is useful. If we're interested in what the program is currently doing for people using it, or what would happen if we expanded it to just those not using it, we'd need to find the ATT or ATU instead.</span>
<span id="cb28-1421"><a href="#cb28-1421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1422"><a href="#cb28-1422" aria-hidden="true" tabindex="-1"></a>We can do this with matching and weighting, but *we cannot use the same matching and weighting that we used to find the ATE.* When reweighting the data for estimating the ATT, we should not do anything that messes with the weights of the treated group. Since we're interested in the effect of the program on just the treated people, we need to create a pseudo-control group that looks like the treated group. There are lots of different ways to do this (and @GreiferStuart:2023 cover them). One common way is to give a weight of 1 to all the treated people and a weight of $\frac{p_i}{1 - p_i}$ for all the untreated people.</span>
<span id="cb28-1423"><a href="#cb28-1423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1424"><a href="#cb28-1424" aria-hidden="true" tabindex="-1"></a>The process is the same—fit a model that predicts if people use a net, use those predictions to generate weights, then fit an outcome model using those weights. With the ATT-specific weights, we'll create an untreated pseudo-population that is statistically comparable (and unconfounded) in relation to the actually treated population. </span>
<span id="cb28-1425"><a href="#cb28-1425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1428"><a href="#cb28-1428" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-1429"><a href="#cb28-1429" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: calc-wts-net-att</span></span>
<span id="cb28-1430"><a href="#cb28-1430" aria-hidden="true" tabindex="-1"></a><span class="co"># Get ATT-focused weights for the treatment model</span></span>
<span id="cb28-1431"><a href="#cb28-1431" aria-hidden="true" tabindex="-1"></a>weights_att <span class="ot">&lt;-</span> <span class="fu">weightit</span>(</span>
<span id="cb28-1432"><a href="#cb28-1432" aria-hidden="true" tabindex="-1"></a>  net <span class="sc">~</span> income <span class="sc">+</span> health, </span>
<span id="cb28-1433"><a href="#cb28-1433" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> nets, </span>
<span id="cb28-1434"><a href="#cb28-1434" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"glm"</span>, </span>
<span id="cb28-1435"><a href="#cb28-1435" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimand =</span> <span class="st">"ATT"</span></span>
<span id="cb28-1436"><a href="#cb28-1436" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-1437"><a href="#cb28-1437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1438"><a href="#cb28-1438" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the weights as a column in the data</span></span>
<span id="cb28-1439"><a href="#cb28-1439" aria-hidden="true" tabindex="-1"></a>nets_with_weights<span class="sc">$</span>wts_att <span class="ot">&lt;-</span> weights_att<span class="sc">$</span>weights</span>
<span id="cb28-1440"><a href="#cb28-1440" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1441"><a href="#cb28-1441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1442"><a href="#cb28-1442" aria-hidden="true" tabindex="-1"></a>Our fancy weighted histogram looks like this:</span>
<span id="cb28-1443"><a href="#cb28-1443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1446"><a href="#cb28-1446" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-1447"><a href="#cb28-1447" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-propensity-weighted-att</span></span>
<span id="cb28-1448"><a href="#cb28-1448" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Mirrored histogram comparing the distribution of treated people with the reweighted pseudo-population of untreated people; because this is for the ATT, treated people were not reweighted"</span></span>
<span id="cb28-1449"><a href="#cb28-1449" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 6</span></span>
<span id="cb28-1450"><a href="#cb28-1450" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 3.75</span></span>
<span id="cb28-1451"><a href="#cb28-1451" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb28-1452"><a href="#cb28-1452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1453"><a href="#cb28-1453" aria-hidden="true" tabindex="-1"></a>plot_data_weights_att <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb28-1454"><a href="#cb28-1454" aria-hidden="true" tabindex="-1"></a>  <span class="at">propensity =</span> weights_att<span class="sc">$</span>ps,</span>
<span id="cb28-1455"><a href="#cb28-1455" aria-hidden="true" tabindex="-1"></a>  <span class="at">weight =</span> weights_att<span class="sc">$</span>weights,</span>
<span id="cb28-1456"><a href="#cb28-1456" aria-hidden="true" tabindex="-1"></a>  <span class="at">treatment =</span> weights_att<span class="sc">$</span>treat</span>
<span id="cb28-1457"><a href="#cb28-1457" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-1458"><a href="#cb28-1458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1459"><a href="#cb28-1459" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb28-1460"><a href="#cb28-1460" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">data =</span> <span class="fu">filter</span>(plot_data_weights_att, treatment <span class="sc">==</span> <span class="dv">0</span>), </span>
<span id="cb28-1461"><a href="#cb28-1461" aria-hidden="true" tabindex="-1"></a>    <span class="at">bins =</span> <span class="dv">50</span>, <span class="fu">aes</span>(<span class="at">x =</span> propensity, <span class="at">weight =</span> weight, <span class="at">y =</span> <span class="sc">-</span><span class="fu">after_stat</span>(count), <span class="at">fill =</span> <span class="st">"Untreated psuedo-population"</span>)) <span class="sc">+</span></span>
<span id="cb28-1462"><a href="#cb28-1462" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">data =</span> <span class="fu">filter</span>(plot_data_weights_att, treatment <span class="sc">==</span> <span class="dv">1</span>), </span>
<span id="cb28-1463"><a href="#cb28-1463" aria-hidden="true" tabindex="-1"></a>    <span class="at">bins =</span> <span class="dv">50</span>, <span class="fu">aes</span>(<span class="at">x =</span> propensity, <span class="at">fill =</span> <span class="st">"Treated people"</span>)) <span class="sc">+</span> </span>
<span id="cb28-1464"><a href="#cb28-1464" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">data =</span> <span class="fu">filter</span>(plot_data_weights_att, treatment <span class="sc">==</span> <span class="dv">0</span>), </span>
<span id="cb28-1465"><a href="#cb28-1465" aria-hidden="true" tabindex="-1"></a>    <span class="at">bins =</span> <span class="dv">50</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>, </span>
<span id="cb28-1466"><a href="#cb28-1466" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> propensity, <span class="at">y =</span> <span class="sc">-</span><span class="fu">after_stat</span>(count), <span class="at">fill =</span> <span class="st">"Untreated people"</span>)) <span class="sc">+</span></span>
<span id="cb28-1467"><a href="#cb28-1467" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">linewidth =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb28-1468"><a href="#cb28-1468" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_percent</span>()) <span class="sc">+</span></span>
<span id="cb28-1469"><a href="#cb28-1469" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">label =</span> abs) <span class="sc">+</span></span>
<span id="cb28-1470"><a href="#cb28-1470" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(</span>
<span id="cb28-1471"><a href="#cb28-1471" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(clrs[<span class="dv">1</span>], <span class="st">"grey50"</span>, colorspace<span class="sc">::</span><span class="fu">lighten</span>(clrs[<span class="dv">6</span>], <span class="fl">0.65</span>)), </span>
<span id="cb28-1472"><a href="#cb28-1472" aria-hidden="true" tabindex="-1"></a>    <span class="at">guide =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">FALSE</span>, <span class="at">nrow =</span> <span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb28-1473"><a href="#cb28-1473" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Propensity"</span>, <span class="at">y =</span> <span class="st">"Count"</span>, <span class="at">fill =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb28-1474"><a href="#cb28-1474" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb28-1475"><a href="#cb28-1475" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"top"</span>,</span>
<span id="cb28-1476"><a href="#cb28-1476" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.key.size =</span> <span class="fu">unit</span>(<span class="fl">0.65</span>, <span class="st">"lines"</span>)</span>
<span id="cb28-1477"><a href="#cb28-1477" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-1478"><a href="#cb28-1478" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1479"><a href="#cb28-1479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1480"><a href="#cb28-1480" aria-hidden="true" tabindex="-1"></a>The treated people are untouched—they all have a weight of 1, and we don't mess with them. Untreated people with high probability of using a net are given more weight to make them look more like the treated people. </span>
<span id="cb28-1481"><a href="#cb28-1481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1482"><a href="#cb28-1482" aria-hidden="true" tabindex="-1"></a>Fitting the outcome model is the same as finding the ATE—we'll just use the special ATT weights:</span>
<span id="cb28-1483"><a href="#cb28-1483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1486"><a href="#cb28-1486" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-1487"><a href="#cb28-1487" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: calc-outcome-att</span></span>
<span id="cb28-1488"><a href="#cb28-1488" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit an outcome model using the ATT weights</span></span>
<span id="cb28-1489"><a href="#cb28-1489" aria-hidden="true" tabindex="-1"></a>model_outcome_att <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb28-1490"><a href="#cb28-1490" aria-hidden="true" tabindex="-1"></a>  malaria_risk <span class="sc">~</span> net, </span>
<span id="cb28-1491"><a href="#cb28-1491" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> nets_with_weights, </span>
<span id="cb28-1492"><a href="#cb28-1492" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> wts_att</span>
<span id="cb28-1493"><a href="#cb28-1493" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-1494"><a href="#cb28-1494" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1495"><a href="#cb28-1495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1496"><a href="#cb28-1496" aria-hidden="true" tabindex="-1"></a>The main difference is that when we do the g-computation, we *only look at treated people*. Using only this part of the population, we'll set all their values to 1, then set all their values to 0, and then find the difference.</span>
<span id="cb28-1497"><a href="#cb28-1497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1498"><a href="#cb28-1498" aria-hidden="true" tabindex="-1"></a>**This is the key to finding the effect of the program only in the treated part of the population!** Remember how when we had access to everyone's individual causal effects, we were able to find the ATT by looking at the average of all the treated peoples' $\delta$ column? G-computation lets us essentially recreate that process. Here's how it works:</span>
<span id="cb28-1499"><a href="#cb28-1499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1502"><a href="#cb28-1502" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-1503"><a href="#cb28-1503" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: calc-comparisons-att</span></span>
<span id="cb28-1504"><a href="#cb28-1504" aria-hidden="true" tabindex="-1"></a><span class="co"># Do g-computation *only* on treated observations</span></span>
<span id="cb28-1505"><a href="#cb28-1505" aria-hidden="true" tabindex="-1"></a><span class="fu">avg_comparisons</span>(</span>
<span id="cb28-1506"><a href="#cb28-1506" aria-hidden="true" tabindex="-1"></a>  model_outcome_att, </span>
<span id="cb28-1507"><a href="#cb28-1507" aria-hidden="true" tabindex="-1"></a>  <span class="at">variables =</span> <span class="st">"net"</span>, </span>
<span id="cb28-1508"><a href="#cb28-1508" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata =</span> <span class="fu">filter</span>(nets, net <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb28-1509"><a href="#cb28-1509" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-1510"><a href="#cb28-1510" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1511"><a href="#cb28-1511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1514"><a href="#cb28-1514" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-1515"><a href="#cb28-1515" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: calc-att-hidden</span></span>
<span id="cb28-1516"><a href="#cb28-1516" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb28-1517"><a href="#cb28-1517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1518"><a href="#cb28-1518" aria-hidden="true" tabindex="-1"></a>estimated_att <span class="ot">&lt;-</span> <span class="fu">avg_comparisons</span>(</span>
<span id="cb28-1519"><a href="#cb28-1519" aria-hidden="true" tabindex="-1"></a>  model_outcome_att, </span>
<span id="cb28-1520"><a href="#cb28-1520" aria-hidden="true" tabindex="-1"></a>  <span class="at">variables =</span> <span class="st">"net"</span>, </span>
<span id="cb28-1521"><a href="#cb28-1521" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata =</span> <span class="fu">filter</span>(nets, net <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb28-1522"><a href="#cb28-1522" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb28-1523"><a href="#cb28-1523" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(estimate)</span>
<span id="cb28-1524"><a href="#cb28-1524" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1525"><a href="#cb28-1525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1526"><a href="#cb28-1526" aria-hidden="true" tabindex="-1"></a>The estimated observational ATT is <span class="in">`r nice_number(estimated_att)`</span>, which is (1) bigger than the ATE, as expected, and (2) close-ish to the true ATT of <span class="in">`r nice_number(true_att)`</span>!</span>
<span id="cb28-1527"><a href="#cb28-1527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1528"><a href="#cb28-1528" aria-hidden="true" tabindex="-1"></a><span class="fu">## ATU</span></span>
<span id="cb28-1529"><a href="#cb28-1529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1530"><a href="#cb28-1530" aria-hidden="true" tabindex="-1"></a>If we're interested in what would happen if we expanded the program to people not using it, we can find the ATU. The process is the same as the ATT, just in reverse. We'll create a pseudo-population of net users by giving a weight of 1 to all untreated people and giving a weight of $\frac{1-p_i}{p_i}$ to all treated people.</span>
<span id="cb28-1531"><a href="#cb28-1531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1534"><a href="#cb28-1534" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-1535"><a href="#cb28-1535" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: calc-wts-net-atu</span></span>
<span id="cb28-1536"><a href="#cb28-1536" aria-hidden="true" tabindex="-1"></a><span class="co"># Get ATU-focused weights for the treatment model</span></span>
<span id="cb28-1537"><a href="#cb28-1537" aria-hidden="true" tabindex="-1"></a>weights_atu <span class="ot">&lt;-</span> <span class="fu">weightit</span>(</span>
<span id="cb28-1538"><a href="#cb28-1538" aria-hidden="true" tabindex="-1"></a>  net <span class="sc">~</span> income <span class="sc">+</span> health, </span>
<span id="cb28-1539"><a href="#cb28-1539" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> nets, </span>
<span id="cb28-1540"><a href="#cb28-1540" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"glm"</span>, </span>
<span id="cb28-1541"><a href="#cb28-1541" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimand =</span> <span class="st">"ATC"</span>  <span class="co"># WeightIt calls this ATC instead of ATU</span></span>
<span id="cb28-1542"><a href="#cb28-1542" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-1543"><a href="#cb28-1543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1544"><a href="#cb28-1544" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the weights as a column in the data</span></span>
<span id="cb28-1545"><a href="#cb28-1545" aria-hidden="true" tabindex="-1"></a>nets_with_weights<span class="sc">$</span>wts_atu <span class="ot">&lt;-</span> weights_atu<span class="sc">$</span>weights</span>
<span id="cb28-1546"><a href="#cb28-1546" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1547"><a href="#cb28-1547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1548"><a href="#cb28-1548" aria-hidden="true" tabindex="-1"></a>Here's what that looks like as a weighted histogram:</span>
<span id="cb28-1549"><a href="#cb28-1549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1552"><a href="#cb28-1552" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-1553"><a href="#cb28-1553" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-propensity-weighted-atu</span></span>
<span id="cb28-1554"><a href="#cb28-1554" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Mirrored histogram comparing the distribution of untreated people with the reweighted pseudo-population of treated people; because this is for the ATU, untreated people were not reweighted"</span></span>
<span id="cb28-1555"><a href="#cb28-1555" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 6</span></span>
<span id="cb28-1556"><a href="#cb28-1556" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 3.75</span></span>
<span id="cb28-1557"><a href="#cb28-1557" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb28-1558"><a href="#cb28-1558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1559"><a href="#cb28-1559" aria-hidden="true" tabindex="-1"></a>plot_data_weights_atu <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb28-1560"><a href="#cb28-1560" aria-hidden="true" tabindex="-1"></a>  <span class="at">propensity =</span> weights_atu<span class="sc">$</span>ps,</span>
<span id="cb28-1561"><a href="#cb28-1561" aria-hidden="true" tabindex="-1"></a>  <span class="at">weight =</span> weights_atu<span class="sc">$</span>weights,</span>
<span id="cb28-1562"><a href="#cb28-1562" aria-hidden="true" tabindex="-1"></a>  <span class="at">treatment =</span> weights_atu<span class="sc">$</span>treat</span>
<span id="cb28-1563"><a href="#cb28-1563" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-1564"><a href="#cb28-1564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1565"><a href="#cb28-1565" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb28-1566"><a href="#cb28-1566" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">data =</span> <span class="fu">filter</span>(plot_data_weights_atu, treatment <span class="sc">==</span> <span class="dv">1</span>), </span>
<span id="cb28-1567"><a href="#cb28-1567" aria-hidden="true" tabindex="-1"></a>    <span class="at">bins =</span> <span class="dv">50</span>, <span class="fu">aes</span>(<span class="at">x =</span> propensity, <span class="at">weight =</span> weight, <span class="at">fill =</span> <span class="st">"Treated pseudo-population"</span>)) <span class="sc">+</span> </span>
<span id="cb28-1568"><a href="#cb28-1568" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">data =</span> <span class="fu">filter</span>(plot_data_weights_atu, treatment <span class="sc">==</span> <span class="dv">1</span>), </span>
<span id="cb28-1569"><a href="#cb28-1569" aria-hidden="true" tabindex="-1"></a>    <span class="at">bins =</span> <span class="dv">50</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="fu">aes</span>(<span class="at">x =</span> propensity, <span class="at">fill =</span> <span class="st">"Treated people"</span>)) <span class="sc">+</span> </span>
<span id="cb28-1570"><a href="#cb28-1570" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">data =</span> <span class="fu">filter</span>(plot_data_weights_atu, treatment <span class="sc">==</span> <span class="dv">0</span>), </span>
<span id="cb28-1571"><a href="#cb28-1571" aria-hidden="true" tabindex="-1"></a>    <span class="at">bins =</span> <span class="dv">50</span>, <span class="fu">aes</span>(<span class="at">x =</span> propensity, <span class="at">y =</span> <span class="sc">-</span><span class="fu">after_stat</span>(count), <span class="at">fill =</span> <span class="st">"Untreated people"</span>)) <span class="sc">+</span></span>
<span id="cb28-1572"><a href="#cb28-1572" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">linewidth =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb28-1573"><a href="#cb28-1573" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_percent</span>()) <span class="sc">+</span></span>
<span id="cb28-1574"><a href="#cb28-1574" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">label =</span> abs) <span class="sc">+</span></span>
<span id="cb28-1575"><a href="#cb28-1575" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(</span>
<span id="cb28-1576"><a href="#cb28-1576" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"grey50"</span>, colorspace<span class="sc">::</span><span class="fu">lighten</span>(clrs[<span class="dv">1</span>], <span class="fl">0.5</span>), clrs[<span class="dv">6</span>], colorspace<span class="sc">::</span><span class="fu">lighten</span>(clrs[<span class="dv">6</span>], <span class="fl">0.65</span>)), </span>
<span id="cb28-1577"><a href="#cb28-1577" aria-hidden="true" tabindex="-1"></a>    <span class="at">guide =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">FALSE</span>, <span class="at">nrow =</span> <span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb28-1578"><a href="#cb28-1578" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Propensity"</span>, <span class="at">y =</span> <span class="st">"Count"</span>, <span class="at">fill =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb28-1579"><a href="#cb28-1579" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb28-1580"><a href="#cb28-1580" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"top"</span>,</span>
<span id="cb28-1581"><a href="#cb28-1581" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.key.size =</span> <span class="fu">unit</span>(<span class="fl">0.65</span>, <span class="st">"lines"</span>)</span>
<span id="cb28-1582"><a href="#cb28-1582" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-1583"><a href="#cb28-1583" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1584"><a href="#cb28-1584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1585"><a href="#cb28-1585" aria-hidden="true" tabindex="-1"></a>The low-probability net users get a lot more weight so that they're comparable to the untreated group.</span>
<span id="cb28-1586"><a href="#cb28-1586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1587"><a href="#cb28-1587" aria-hidden="true" tabindex="-1"></a>The outcome model process is the same as before—we just use the ATU-specific weights. When doing the g-computation, we *only use untreated people*.</span>
<span id="cb28-1588"><a href="#cb28-1588" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1591"><a href="#cb28-1591" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-1592"><a href="#cb28-1592" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: calc-net-atu</span></span>
<span id="cb28-1593"><a href="#cb28-1593" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit an outcome model using the ATU weights</span></span>
<span id="cb28-1594"><a href="#cb28-1594" aria-hidden="true" tabindex="-1"></a>model_outcome_atu <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb28-1595"><a href="#cb28-1595" aria-hidden="true" tabindex="-1"></a>  malaria_risk <span class="sc">~</span> net, </span>
<span id="cb28-1596"><a href="#cb28-1596" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> nets_with_weights, </span>
<span id="cb28-1597"><a href="#cb28-1597" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> wts_atu</span>
<span id="cb28-1598"><a href="#cb28-1598" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-1599"><a href="#cb28-1599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1600"><a href="#cb28-1600" aria-hidden="true" tabindex="-1"></a><span class="co"># Do g-computation *only* on untreated observations</span></span>
<span id="cb28-1601"><a href="#cb28-1601" aria-hidden="true" tabindex="-1"></a><span class="fu">avg_comparisons</span>(</span>
<span id="cb28-1602"><a href="#cb28-1602" aria-hidden="true" tabindex="-1"></a>  model_outcome_atu, </span>
<span id="cb28-1603"><a href="#cb28-1603" aria-hidden="true" tabindex="-1"></a>  <span class="at">variables =</span> <span class="st">"net"</span>, </span>
<span id="cb28-1604"><a href="#cb28-1604" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata =</span> <span class="fu">filter</span>(nets, net <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb28-1605"><a href="#cb28-1605" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-1606"><a href="#cb28-1606" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1607"><a href="#cb28-1607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1610"><a href="#cb28-1610" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-1611"><a href="#cb28-1611" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: calc-atu-hidden</span></span>
<span id="cb28-1612"><a href="#cb28-1612" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb28-1613"><a href="#cb28-1613" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1614"><a href="#cb28-1614" aria-hidden="true" tabindex="-1"></a>estimated_atu <span class="ot">&lt;-</span> <span class="fu">avg_comparisons</span>(</span>
<span id="cb28-1615"><a href="#cb28-1615" aria-hidden="true" tabindex="-1"></a>  model_outcome_atu, </span>
<span id="cb28-1616"><a href="#cb28-1616" aria-hidden="true" tabindex="-1"></a>  <span class="at">variables =</span> <span class="st">"net"</span>, </span>
<span id="cb28-1617"><a href="#cb28-1617" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata =</span> <span class="fu">filter</span>(nets, net <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb28-1618"><a href="#cb28-1618" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb28-1619"><a href="#cb28-1619" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(estimate)</span>
<span id="cb28-1620"><a href="#cb28-1620" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1621"><a href="#cb28-1621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1622"><a href="#cb28-1622" aria-hidden="true" tabindex="-1"></a>The estimated observational ATU is <span class="in">`r nice_number(estimated_atu)`</span>, which is (1) smaller than the ATE, as expected, and (2) close-ish to the true ATU of <span class="in">`r nice_number(true_atu)`</span>!</span>
<span id="cb28-1623"><a href="#cb28-1623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1624"><a href="#cb28-1624" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary</span></span>
<span id="cb28-1625"><a href="#cb28-1625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1626"><a href="#cb28-1626" aria-hidden="true" tabindex="-1"></a>Finally, let's show these estimands all together, with some basic interpretation of what they all mean:</span>
<span id="cb28-1627"><a href="#cb28-1627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1630"><a href="#cb28-1630" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-1631"><a href="#cb28-1631" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-summary</span></span>
<span id="cb28-1632"><a href="#cb28-1632" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Summary of the three main estimands"</span></span>
<span id="cb28-1633"><a href="#cb28-1633" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb28-1634"><a href="#cb28-1634" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1635"><a href="#cb28-1635" aria-hidden="true" tabindex="-1"></a>interpretation_ate <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(</span>
<span id="cb28-1636"><a href="#cb28-1636" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Using a mosquito net reduces the risk of malaria by {nice_number(abs(estimated_ate))} points, on average across all people in the country"</span></span>
<span id="cb28-1637"><a href="#cb28-1637" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-1638"><a href="#cb28-1638" aria-hidden="true" tabindex="-1"></a>why_ate <span class="ot">&lt;-</span> <span class="st">"Helpful for understanding the effect of creating a widely applied policy or program, like rolling out subsidized mosquito nets for everyone in the country"</span></span>
<span id="cb28-1639"><a href="#cb28-1639" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1640"><a href="#cb28-1640" aria-hidden="true" tabindex="-1"></a>interpretation_att <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(</span>
<span id="cb28-1641"><a href="#cb28-1641" aria-hidden="true" tabindex="-1"></a>  <span class="st">"People who currently use mosquito nets see a malaria risk reduction of {nice_number(abs(estimated_att))} points, on average"</span></span>
<span id="cb28-1642"><a href="#cb28-1642" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-1643"><a href="#cb28-1643" aria-hidden="true" tabindex="-1"></a>why_att <span class="ot">&lt;-</span> <span class="st">"Helpful for understanding the effect of net usage on people who actually use them; this shows what would happen if we withheld the program or took away everyone's nets"</span></span>
<span id="cb28-1644"><a href="#cb28-1644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1645"><a href="#cb28-1645" aria-hidden="true" tabindex="-1"></a>interpretation_atu <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(</span>
<span id="cb28-1646"><a href="#cb28-1646" aria-hidden="true" tabindex="-1"></a>  <span class="st">"People who don't currently use mosquito nets would see a malaria risk reduction of {nice_number(abs(estimated_atu))} points, on average"</span></span>
<span id="cb28-1647"><a href="#cb28-1647" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-1648"><a href="#cb28-1648" aria-hidden="true" tabindex="-1"></a>why_atu <span class="ot">&lt;-</span> <span class="st">"Helpful for understanding the effect of net usage on people who don't use them right now; this shows what would happen if we expanded the program or gave nets to people without them"</span></span>
<span id="cb28-1649"><a href="#cb28-1649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1650"><a href="#cb28-1650" aria-hidden="true" tabindex="-1"></a><span class="fu">tribble</span>(</span>
<span id="cb28-1651"><a href="#cb28-1651" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>estimand, <span class="sc">~</span>true_value, <span class="sc">~</span>estimated_value, <span class="sc">~</span>interpretation,    <span class="sc">~</span>why,</span>
<span id="cb28-1652"><a href="#cb28-1652" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ATE"</span>,     true_ate,    estimated_ate,    interpretation_ate, why_ate,</span>
<span id="cb28-1653"><a href="#cb28-1653" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ATT"</span>,     true_att,    estimated_att,    interpretation_att, why_att,</span>
<span id="cb28-1654"><a href="#cb28-1654" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ATU"</span>,     true_atu,    estimated_atu,    interpretation_atu, why_atu</span>
<span id="cb28-1655"><a href="#cb28-1655" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb28-1656"><a href="#cb28-1656" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">|&gt;</span> </span>
<span id="cb28-1657"><a href="#cb28-1657" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(</span>
<span id="cb28-1658"><a href="#cb28-1658" aria-hidden="true" tabindex="-1"></a>    <span class="at">estimand =</span> <span class="st">"Estimand"</span>,</span>
<span id="cb28-1659"><a href="#cb28-1659" aria-hidden="true" tabindex="-1"></a>    <span class="at">true_value =</span> <span class="st">"True value"</span>,</span>
<span id="cb28-1660"><a href="#cb28-1660" aria-hidden="true" tabindex="-1"></a>    <span class="at">estimated_value =</span> <span class="st">"Estimated value"</span>,</span>
<span id="cb28-1661"><a href="#cb28-1661" aria-hidden="true" tabindex="-1"></a>    <span class="at">interpretation =</span> <span class="st">"Interpretation"</span>,</span>
<span id="cb28-1662"><a href="#cb28-1662" aria-hidden="true" tabindex="-1"></a>    <span class="at">why =</span> <span class="st">"Why care?"</span></span>
<span id="cb28-1663"><a href="#cb28-1663" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-1664"><a href="#cb28-1664" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_align</span>(</span>
<span id="cb28-1665"><a href="#cb28-1665" aria-hidden="true" tabindex="-1"></a>    <span class="at">align =</span> <span class="st">"left"</span>,</span>
<span id="cb28-1666"><a href="#cb28-1666" aria-hidden="true" tabindex="-1"></a>    <span class="at">columns =</span> <span class="fu">c</span>(estimand, interpretation, why)</span>
<span id="cb28-1667"><a href="#cb28-1667" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-1668"><a href="#cb28-1668" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_align</span>(</span>
<span id="cb28-1669"><a href="#cb28-1669" aria-hidden="true" tabindex="-1"></a>    <span class="at">align =</span> <span class="st">"center"</span>,</span>
<span id="cb28-1670"><a href="#cb28-1670" aria-hidden="true" tabindex="-1"></a>    <span class="at">columns =</span> <span class="fu">c</span>(true_value, estimated_value)</span>
<span id="cb28-1671"><a href="#cb28-1671" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-1672"><a href="#cb28-1672" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(</span>
<span id="cb28-1673"><a href="#cb28-1673" aria-hidden="true" tabindex="-1"></a>    <span class="at">columns =</span> <span class="fu">c</span>(true_value, estimated_value),</span>
<span id="cb28-1674"><a href="#cb28-1674" aria-hidden="true" tabindex="-1"></a>    <span class="at">decimals =</span> <span class="dv">1</span></span>
<span id="cb28-1675"><a href="#cb28-1675" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-1676"><a href="#cb28-1676" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_style</span>(</span>
<span id="cb28-1677"><a href="#cb28-1677" aria-hidden="true" tabindex="-1"></a>    <span class="at">style =</span> <span class="fu">cell_text</span>(<span class="at">weight =</span> <span class="st">"bold"</span>),</span>
<span id="cb28-1678"><a href="#cb28-1678" aria-hidden="true" tabindex="-1"></a>    <span class="at">locations =</span> <span class="fu">cells_column_labels</span>()</span>
<span id="cb28-1679"><a href="#cb28-1679" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-1680"><a href="#cb28-1680" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_style</span>(</span>
<span id="cb28-1681"><a href="#cb28-1681" aria-hidden="true" tabindex="-1"></a>    <span class="at">style =</span> <span class="fu">cell_text</span>(<span class="at">v_align =</span> <span class="st">"top"</span>),</span>
<span id="cb28-1682"><a href="#cb28-1682" aria-hidden="true" tabindex="-1"></a>    <span class="at">locations =</span> <span class="fu">cells_body</span>()</span>
<span id="cb28-1683"><a href="#cb28-1683" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-1684"><a href="#cb28-1684" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_source_note</span>(<span class="at">source_note =</span> <span class="st">"Here, the fact that ATT &gt; ATE &gt; ATU implies selection bias; the program works more effectively among those who use it because they know it will help them"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb28-1685"><a href="#cb28-1685" aria-hidden="true" tabindex="-1"></a>  <span class="fu">opt_horizontal_padding</span>(<span class="at">scale =</span> <span class="dv">3</span>) <span class="sc">|&gt;</span> </span>
<span id="cb28-1686"><a href="#cb28-1686" aria-hidden="true" tabindex="-1"></a>  <span class="fu">opt_table_font</span>(<span class="at">font =</span> <span class="st">"Jost"</span>)</span>
<span id="cb28-1687"><a href="#cb28-1687" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1688"><a href="#cb28-1688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1689"><a href="#cb28-1689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1690"><a href="#cb28-1690" aria-hidden="true" tabindex="-1"></a><span class="fu"># What about other methods?</span></span>
<span id="cb28-1691"><a href="#cb28-1691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1692"><a href="#cb28-1692" aria-hidden="true" tabindex="-1"></a>Awesome. For me, at least, this all makes a lot more sense. The ATE is not the final goal of all causal inference methods. The ATT is also a completely good and valid and policy relevant estimand—often more important than the ATE. I've long been confused about what the ATT actually means, since it feels so weird—particularly in standard textbook potential outcomes tables. Finding the treatment effect just for the treated feels like we're abandoning the idea of a control or comparison group, but we're not! We're using information from untreated people to achieve balance, then applying that information to only the treated people through g-computation to approximate unobservable individual-level causal effects. We can thus find more specific causal effects using observational, non-experimental data.</span>
<span id="cb28-1693"><a href="#cb28-1693" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1694"><a href="#cb28-1694" aria-hidden="true" tabindex="-1"></a>While working through all this, I discovered that I've actually been teaching methods that estimate the ATT without even knowing it. One super common method in econometrics and social science in general<span class="ot">[^epi-diff-diff]</span> is difference-in-differences. The causal effect you find from diff-in-diff research designs is the ATT, or the effect of an intervention on only the treated people. Diff-in-diff doesn't provide a population-level ATE.</span>
<span id="cb28-1695"><a href="#cb28-1695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1696"><a href="#cb28-1696" aria-hidden="true" tabindex="-1"></a><span class="ot">[^epi-diff-diff]: </span>Though not in epidemiology, which is odd since <span class="co">[</span><span class="ot">an epidemiologist essentially invented it</span><span class="co">](https://doi.org/10.1007/s40471-020-00245-2)</span> <span class="co">[</span><span class="ot">@CanigliaMurray:2020</span><span class="co">]</span>!</span>
<span id="cb28-1697"><a href="#cb28-1697" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1698"><a href="#cb28-1698" aria-hidden="true" tabindex="-1"></a>Other quasi-experimental methods like regression discontinuity and instrumental variables provide much more limited causal effects—they don't show the ATE, or the ATT, or the ATU. Instead, they provide a local average treatment effect (LATE), or a causal effect for a much narrower segment of the population. For regression discontinuity, we find the ATE for people close to an arbitrary threshold that causes a cutoff in treatment status; for instrumental variables we find the ATE for people who comply with the program assignment.</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
<p><span class="faux-block"><i class="fa-brands fa-creative-commons" aria-label="creative-commons"></i> 2007–2024 Andrew Heiss</span> <span class="faux-block">All content licensed under<br><a href="https://creativecommons.org/licenses/by/4.0/"><i class="fa-brands fa-creative-commons" aria-label="creative-commons"></i> <i class="fa-brands fa-creative-commons-by" aria-label="creative-commons-by"></i> Creative Commons CC BY 4.0</a></span></p>
</div>   
    <div class="nav-footer-center">
<p><span class="faux-block"><i class="fa-brands fa-orcid" aria-label="orcid"></i> <strong>ORCID</strong> <a href="https://orcid.org/0000-0002-3948-3914">0000-0002-3948-3914</a></span> <span class="faux-block"><i class="fa-solid fa-key" aria-label="key"></i> <a href="../../../../../pgp_ath.asc.txt">PGP public key</a>   <i class="fa-solid fa-fingerprint" aria-label="fingerprint"></i> Fingerprint:<br><span class="fingerprint">4AA2 FA83 A8B2 05A4 E30F<br> 610D 1382 6216 9178 36AB</span></span></p>
</div>
    <div class="nav-footer-right">
<p><span class="faux-block">Made with <i class="fa-brands fa-r-project" aria-label="r-project"></i> and <a href="https://quarto.org/">Quarto</a></span> <span class="faux-block"><a href="https://github.com/andrewheiss/ath-quarto">View the source at <i class="fa-brands fa-github" aria-label="github"></i> GitHub</a></span></p>
</div>
  </div>
</footer>


</body></html>