<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Hong T.M. Chu">
<meta name="description" content="Use R to close backdoor confounding by generating and using inverse probability weights for both binary and continuous treatments">
<title>Generating inverse probability weights for both binary and continuous treatments | Hong T.M. Chu – Hong T.M. Chu</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="../../../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../../../">
<link href="../../../../..//files/favicon-512.png" rel="icon" type="image/png">
<script src="../../../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../../../site_libs/quarto-html/quarto-syntax-highlighting-17c909d5fd25ae21b861c0c7a49b2096.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../../../site_libs/bootstrap/bootstrap-5cd0811f461c8271ae6bab49df9501be.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<link href="../../../../../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../../../../../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<script src="../../../../../site_libs/quarto-contrib/iconify-2.0.0/iconify-icon.min.js"></script><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script type="text/javascript">

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-527449-5', 'auto');

ga('send', {
  hitType: 'pageview',
  'anonymizeIp': true,
});
</script><style>

      .quarto-title-block .quarto-title-banner {
        background: #170C3A;
      }
</style>
<script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
<meta property="og:title" content="Generating inverse probability weights for both binary and continuous treatments | Hong T.M. Chu">
<meta property="og:description" content="Use R to close backdoor confounding by generating and using inverse probability weights for both binary and continuous treatments">
<meta property="og:image" content="https://www.andrewheiss.com/blog/2020/12/01/ipw-binary-continuous/index_files/figure-html/dag-binary-1.png">
<meta property="og:site_name" content="Hong T.M. Chu">
<meta property="og:locale" content="en_US">
<meta property="og:image:height" content="1067">
<meta property="og:image:width" content="1728">
<meta name="twitter:title" content="Generating inverse probability weights for both binary and continuous treatments | Hong T.M. Chu">
<meta name="twitter:description" content="Use R to close backdoor confounding by generating and using inverse probability weights for both binary and continuous treatments">
<meta name="twitter:image" content="https://www.andrewheiss.com/blog/2020/12/01/ipw-binary-continuous/index_files/figure-html/dag-binary-1.png">
<meta name="twitter:creator" content="@andrewheiss">
<meta name="twitter:site" content="@andrewheiss">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image-height" content="1067">
<meta name="twitter:image-width" content="1728">
</head>
<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../../../index.html">
    <span class="navbar-title">Hong T.M. Chu</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link" href="../../../../../index.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../cv/index.html"> 
<span class="menu-text">CV</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../research/index.html"> 
<span class="menu-text">Research</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../teaching/index.html"> 
<span class="menu-text">Teaching</span></a>
  </li>  
</ul>
<ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item">
    <a class="nav-link" href="mailto:hong.ctm@vinuni.edu.vn"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:envelope" style="font-size: 1.1em;" aria-label="Icon envelope from bi Iconify.design set." title="E-mail"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/andrewheiss" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:github" style="font-size: 1.1em;" aria-label="Icon github from bi Iconify.design set." title="GitHub"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.linkedin.com/in/hongtmchu" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:linkedin" style="font-size: 1.1em;" aria-label="Icon linkedin from bi Iconify.design set." title="LinkedIn"></iconify-icon></span></a>
  </li>  
</ul>
</div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><header id="title-block-header" class="quarto-title-block default blog-post page-columns page-full"><div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">Generating inverse probability weights for both binary and continuous treatments</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
                  <div>
        <div class="description">
          Use R to close backdoor confounding by generating and using inverse probability weights for both binary and continuous treatments
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">r</div>
                <div class="quarto-category">tidyverse</div>
                <div class="quarto-category">causal inference</div>
                <div class="quarto-category">DAGs</div>
                <div class="quarto-category">do calculus</div>
                <div class="quarto-category">inverse probability weighting</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p><a href="https://www.andrewheiss.com/">Andrew Heiss</a> <a href="https://orcid.org/0000-0002-3948-3914" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">Tuesday, December 1, 2020</p>
      </div>
    </div>
    
      
      <div>
      <div class="quarto-title-meta-heading">Doi</div>
      <div class="quarto-title-meta-contents">
        <p class="doi">
          <a href="https://doi.org/10.59350/1svkc-rkv91">10.59350/1svkc-rkv91</a>
        </p>
      </div>
    </div>
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Contents</h2>
   
  <ul>
<li>
<a href="#binary-treatments" id="toc-binary-treatments" class="nav-link active" data-scroll-target="#binary-treatments">Binary treatments</a>
  <ul class="collapse">
<li><a href="#example-data" id="toc-example-data" class="nav-link" data-scroll-target="#example-data">Example data</a></li>
  <li><a href="#ipw-manually-binary-treatment" id="toc-ipw-manually-binary-treatment" class="nav-link" data-scroll-target="#ipw-manually-binary-treatment">IPW manually, binary treatment</a></li>
  <li><a href="#ipw-with-the-ipw-package-binary-treatment" id="toc-ipw-with-the-ipw-package-binary-treatment" class="nav-link" data-scroll-target="#ipw-with-the-ipw-package-binary-treatment">IPW with the <strong>ipw</strong> package, binary treatment</a></li>
  <li><a href="#ipw-with-the-weightit-package-binary-treatment" id="toc-ipw-with-the-weightit-package-binary-treatment" class="nav-link" data-scroll-target="#ipw-with-the-weightit-package-binary-treatment">IPW with the <strong>WeightIt</strong> package, binary treatment</a></li>
  </ul>
</li>
  <li>
<a href="#continuous-treatments" id="toc-continuous-treatments" class="nav-link" data-scroll-target="#continuous-treatments">Continuous treatments</a>
  <ul class="collapse">
<li><a href="#example-data-1" id="toc-example-data-1" class="nav-link" data-scroll-target="#example-data-1">Example data</a></li>
  <li><a href="#ipw-manually-continuous-treatment" id="toc-ipw-manually-continuous-treatment" class="nav-link" data-scroll-target="#ipw-manually-continuous-treatment">IPW manually, continuous treatment</a></li>
  <li><a href="#ipw-with-the-ipw-package-continuous-treatment" id="toc-ipw-with-the-ipw-package-continuous-treatment" class="nav-link" data-scroll-target="#ipw-with-the-ipw-package-continuous-treatment">IPW with the <strong>ipw</strong> package, continuous treatment</a></li>
  <li><a href="#ipw-with-the-weightit-package-continuous-treatment" id="toc-ipw-with-the-weightit-package-continuous-treatment" class="nav-link" data-scroll-target="#ipw-with-the-weightit-package-continuous-treatment">IPW with the <strong>WeightIt</strong> package, continuous treatment</a></li>
  </ul>
</li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul></nav>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content"><p>My <a href="https://evalf20.classes.andrewheiss.com/">program evaluation class</a> is basically a fun wrapper around topics in causal inference and econometrics. I’m a big fan of Judea Pearl-style <a href="https://bigthink.com/errors-we-live-by/judea-pearls-the-book-of-why-brings-news-of-a-new-science-of-causes">“causal revolution”</a> causal graphs (or <a href="https://cran.r-project.org/web/packages/ggdag/vignettes/intro-to-dags.html">DAGs</a>), and they’ve made it easier for both me and my students to understand econometric approaches like diff-in-diff, regression discontinuity, and instrumental variables.</p>
<p>DAGs are also incredibly helpful for doing causal inference with observational data <em>without</em> needing a specific quasi-experimental situation. As I show <a href="../../../../../blog/2020/02/25/closing-backdoors-dags/">in this blog post</a> (and in <a href="../../../../../research/chapters/heiss-causal-inference-2021/">this new textbook chapter!</a>), you can use DAGs to identify confounders that distort the relationship (i.e.&nbsp;open up backdoors) between treatment and outcome. You can then use statistical methods to close those backdoors and adjust for the confounding. In both that blog post and the chapter, I show how to do this with matching and with inverse probability weighting (IPW).</p>
<p>However, those examples assume that the treatment is binary. This is fine—lots of social programs <em>are</em> binary (used program/didn’t use program), and the math for creating inverse probability weights with binary treatment variables is fairly straightforward. However, treatment variables are also often <em>not</em> binary, especially outside of program evaluation.</p>
<p>In my own research, I’m working on a couple projects right now where the “treatment” is a count of anti-NGO legal restrictions in a country. I want to be able to use DAGs and inverse probability weighting to adjust for confounders, but I can’t use the IPW stuff I’ve been teaching because that variable isn’t binary! This research project gets even more complicated because it involves time-series cross-sectional (TSCS) data with both time-varying and time-invarying confounders, which opens up a whole other can of worms that I’ll figure out soon following <span class="citation" data-cites="BlackwellGlynn:2018">Blackwell and Glynn (<a href="#ref-BlackwellGlynn:2018" role="doc-biblioref">2018</a>)</span>.</p>
<p>So I had to teach myself how to do IPW with continuous variables. This post shows how to calculate IPWs for both binary and continuous treatments, both manually and with a couple different R packages (<a href="https://cran.r-project.org/package=ipw"><strong>ipw</strong></a> and <a href="https://github.com/ngreifer/WeightIt"><strong>WeightIt</strong></a>).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://broom.tidymodels.org/">broom</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://scales.r-lib.org">scales</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-causal/ggdag">ggdag</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://www.dagitty.net">dagitty</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/olafmersmann/truncnorm">truncnorm</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">ipw</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ngreifer.github.io/WeightIt/">WeightIt</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="binary-treatments" class="level2"><h2 class="anchored" data-anchor-id="binary-treatments">Binary treatments</h2>
<section id="example-data" class="level3"><h3 class="anchored" data-anchor-id="example-data">Example data</h3>
<p>For this example, we’ll generate a DAG for a hypothetical program where bed net use causes a reduction in malaria risk. That relationship is confounded by both income and health, and income influences health. Income and health both increase the probability of net usage.</p>
<p>The treatment here is binary: either people use nets or they don’t.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mosquito_dag</span> <span class="op">&lt;-</span> <span class="fu">dagify</span><span class="op">(</span><span class="va">mal</span> <span class="op">~</span> <span class="va">net</span> <span class="op">+</span> <span class="va">inc</span> <span class="op">+</span> <span class="va">hlth</span>,</span>
<span>                       <span class="va">net</span> <span class="op">~</span> <span class="va">inc</span> <span class="op">+</span> <span class="va">hlth</span>,</span>
<span>                       <span class="va">hlth</span> <span class="op">~</span> <span class="va">inc</span>,</span>
<span>                       coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>mal <span class="op">=</span> <span class="fl">4</span>, net <span class="op">=</span> <span class="fl">1</span>, inc <span class="op">=</span> <span class="fl">2</span>, hlth <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>                                     y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>mal <span class="op">=</span> <span class="fl">1</span>, net <span class="op">=</span> <span class="fl">1</span>, inc <span class="op">=</span> <span class="fl">2</span>, hlth <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                       exposure <span class="op">=</span> <span class="st">"net"</span>,</span>
<span>                       outcome <span class="op">=</span> <span class="st">"mal"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggdag_status</span><span class="op">(</span><span class="va">mosquito_dag</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_dag</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/dag-binary-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>We’ll measure these nodes like so:</p>
<ul>
<li>
<strong>Malaria risk</strong>: scale from 0–100, mostly around 40, but ranging from 10ish to 80ish. Best to use a Beta distribution.</li>
<li>
<strong>Net use</strong>: binary 0/1, TRUE/FALSE variable, where 50% of people use nets. Best to use a binomial distribution. However, since we want to use other variables that increase the likelihood of using a net, we’ll generate a latent continuous variable, rescale it to 0–1, and then use it as probabilities in <code><a href="https://rdrr.io/r/stats/Binomial.html">rbinom()</a></code> and assign people to treatment based on those probabilities.</li>
<li>
<strong>Income</strong>: weekly income, measured in dollars, mostly around 500 ± 300. Best to use a normal distribution.</li>
<li>
<strong>Health</strong>: scale from 0–100, mostly around 70, but ranging from 50ish to 100. Best to use a Beta distribution.</li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Make this randomness consistent</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Simulate 1138 people (just for fun)</span></span>
<span><span class="va">n_people</span> <span class="op">&lt;-</span> <span class="fl">1138</span></span>
<span></span>
<span><span class="va">net_data</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span></span>
<span>  <span class="co"># Make an ID column (not necessary, but nice to have)</span></span>
<span>  id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_people</span>,</span>
<span>  <span class="co"># Generate income variable: normal, 500 ± 300</span></span>
<span>  income <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n_people</span>, mean <span class="op">=</span> <span class="fl">500</span>, sd <span class="op">=</span> <span class="fl">75</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Generate health variable: beta, centered around 70ish</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>health_base <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html">rbeta</a></span><span class="op">(</span><span class="va">n_people</span>, shape1 <span class="op">=</span> <span class="fl">7</span>, shape2 <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>,</span>
<span>         <span class="co"># Health increases by 0.02 for every dollar in income</span></span>
<span>         health_income_effect <span class="op">=</span> <span class="va">income</span> <span class="op">*</span> <span class="fl">0.02</span>,</span>
<span>         <span class="co"># Make the final health score and add some noise</span></span>
<span>         health <span class="op">=</span> <span class="va">health_base</span> <span class="op">+</span> <span class="va">health_income_effect</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n_people</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>         <span class="co"># Rescale so it doesn't go above 100</span></span>
<span>         health <span class="op">=</span> <span class="fu">rescale</span><span class="op">(</span><span class="va">health</span>, to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">health</span><span class="op">)</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Generate net variable based on income, health, and random noise</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>net_score <span class="op">=</span> <span class="op">(</span><span class="fl">0.5</span> <span class="op">*</span> <span class="va">income</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1.5</span> <span class="op">*</span> <span class="va">health</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n_people</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">15</span><span class="op">)</span>,</span>
<span>         <span class="co"># Scale net score down to 0.05 to 0.95 to create a probability of using a net</span></span>
<span>         net_probability <span class="op">=</span> <span class="fu">rescale</span><span class="op">(</span><span class="va">net_score</span>, to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.05</span>, <span class="fl">0.95</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         <span class="co"># Randomly generate a 0/1 variable using that probability</span></span>
<span>         net <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">n_people</span>, <span class="fl">1</span>, <span class="va">net_probability</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Finally generate a malaria risk variable based on income, health, net use,</span></span>
<span>  <span class="co"># and random noise</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>malaria_risk_base <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html">rbeta</a></span><span class="op">(</span><span class="va">n_people</span>, shape1 <span class="op">=</span> <span class="fl">4</span>, shape2 <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>,</span>
<span>         <span class="co"># Risk goes down by 10 when using a net. Because we rescale things,</span></span>
<span>         <span class="co"># though, we have to make the effect a lot bigger here so it scales</span></span>
<span>         <span class="co"># down to -10. Risk also decreases as health and income go up. I played</span></span>
<span>         <span class="co"># with these numbers until they created reasonable coefficients.</span></span>
<span>         malaria_effect <span class="op">=</span> <span class="op">(</span><span class="op">-</span><span class="fl">30</span> <span class="op">*</span> <span class="va">net</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="op">-</span><span class="fl">1.9</span> <span class="op">*</span> <span class="va">health</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="op">-</span><span class="fl">0.1</span> <span class="op">*</span> <span class="va">income</span><span class="op">)</span>,</span>
<span>         <span class="co"># Make the final malaria risk score and add some noise</span></span>
<span>         malaria_risk <span class="op">=</span> <span class="va">malaria_risk_base</span> <span class="op">+</span> <span class="va">malaria_effect</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n_people</span>, <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>         <span class="co"># Rescale so it doesn't go below 0,</span></span>
<span>         malaria_risk <span class="op">=</span> <span class="fu">rescale</span><span class="op">(</span><span class="va">malaria_risk</span>, to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">70</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">health_base</span>, <span class="va">health_income_effect</span>, <span class="va">net_score</span>, <span class="va">net_probability</span>, </span>
<span>            <span class="va">malaria_risk_base</span>, <span class="va">malaria_effect</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">net_data</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 6 × 5</span></span>
<span><span class="co">##      id income health   net malaria_risk</span></span>
<span><span class="co">##   &lt;int&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;int&gt;        &lt;dbl&gt;</span></span>
<span><span class="co">## 1     1   409.   63.1     0         45.1</span></span>
<span><span class="co">## 2     2   521.   83.5     1         23.4</span></span>
<span><span class="co">## 3     3   581.   73.0     0         36.5</span></span>
<span><span class="co">## 4     4   324.   60.6     0         58.7</span></span>
<span><span class="co">## 5     5   532.   73.4     1         32.7</span></span>
<span><span class="co">## 6     6   538.   42.6     0         52.5</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="ipw-manually-binary-treatment" class="level3"><h3 class="anchored" data-anchor-id="ipw-manually-binary-treatment">IPW manually, binary treatment</h3>
<p>If we just look at the effect of nets on malaria risk without any statistical adjustment, we see that nets cause a decrease of 13 points in malaria risk. This is wrong though because there’s confounding.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Wrong correlation-is-not-causation effect</span></span>
<span><span class="va">model_net_naive</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">malaria_risk</span> <span class="op">~</span> <span class="va">net</span>, data <span class="op">=</span> <span class="va">net_data</span><span class="op">)</span></span>
<span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_net_naive</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 2 × 5</span></span>
<span><span class="co">##   term        estimate std.error statistic   p.value</span></span>
<span><span class="co">##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 (Intercept)     41.9     0.413     102.  0        </span></span>
<span><span class="co">## 2 net            -13.6     0.572     -23.7 2.90e-101</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>According to <em>do</em>-calculus logic, we need to adjust for both income and health:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">adjustmentSets</span><span class="op">(</span><span class="va">mosquito_dag</span><span class="op">)</span></span>
<span><span class="co">## { hlth, inc }</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’ll do that with inverse probability weighting. First we’ll use the health and income confounders to predict the treatment, or net use, and then we’ll generate propensity scores. We’ll then use those propensity scores to generate inverse probability weights following this formula:</p>
<p><span class="math display">\[
\frac{\text{Treatment}}{\text{Propensity}} + \frac{1 - \text{Treatment}}{1 - \text{Propensity}}
\]</span></p>
<p>This formula will calculate weights for the average treatment effect (ATE). <a href="https://livefreeordichotomize.com/2019/01/17/understanding-propensity-score-weighting/#how-do-we-incorporate-a-propensity-score-in-a-weight">Lucy D’Agostino McGowan has formulas for a bunch of different IPWs</a>, including the average treatment on the treated (ATT), average treatment among the controls (ATC), and other effects.</p>
<p>Here’s how we do that with R:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Logit model to predict net use</span></span>
<span><span class="va">model_predict_net</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span><span class="va">net</span> <span class="op">~</span> <span class="va">income</span> <span class="op">+</span> <span class="va">health</span>,</span>
<span>                         family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">binomial</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"logit"</span><span class="op">)</span>,</span>
<span>                         data <span class="op">=</span> <span class="va">net_data</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate propensity scores and IPWs</span></span>
<span><span class="va">net_data_ipw</span> <span class="op">&lt;-</span> <span class="fu">augment_columns</span><span class="op">(</span><span class="va">model_predict_net</span>, <span class="va">net_data</span>,</span>
<span>                                type.predict <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">rename</span><span class="op">(</span>propensity <span class="op">=</span> <span class="va">.fitted</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>ipw <span class="op">=</span> <span class="op">(</span><span class="va">net</span> <span class="op">/</span> <span class="va">propensity</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">net</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">propensity</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">net_data_ipw</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">id</span>, <span class="va">income</span>, <span class="va">health</span>, <span class="va">net</span>, <span class="va">malaria_risk</span>, <span class="va">propensity</span>, <span class="va">ipw</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 6 × 7</span></span>
<span><span class="co">##      id income health   net malaria_risk propensity   ipw</span></span>
<span><span class="co">##   &lt;int&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;int&gt;        &lt;dbl&gt;      &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">## 1     1   409.   63.1     0         45.1      0.380  1.61</span></span>
<span><span class="co">## 2     2   521.   83.5     1         23.4      0.628  1.59</span></span>
<span><span class="co">## 3     3   581.   73.0     0         36.5      0.659  2.93</span></span>
<span><span class="co">## 4     4   324.   60.6     0         58.7      0.266  1.36</span></span>
<span><span class="co">## 5     5   532.   73.4     1         32.7      0.597  1.68</span></span>
<span><span class="co">## 6     6   538.   42.6     0         52.5      0.459  1.85</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally we’ll use those weights in a regression model to find the ATE. After adjusting for confounding and closing the backdoor paths opened by income and health, <strong>the effect of nets is -10.5</strong>, which is more accurate than the naive estimate we found before. Yay!</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_net_ipw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">malaria_risk</span> <span class="op">~</span> <span class="va">net</span>, data <span class="op">=</span> <span class="va">net_data_ipw</span>, weights <span class="op">=</span> <span class="va">ipw</span><span class="op">)</span></span>
<span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_net_ipw</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 2 × 5</span></span>
<span><span class="co">##   term        estimate std.error statistic  p.value</span></span>
<span><span class="co">##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">## 1 (Intercept)     40.4     0.409      98.8 0       </span></span>
<span><span class="co">## 2 net            -10.5     0.578     -18.3 1.83e-65</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="ipw-with-the-ipw-package-binary-treatment" class="level3"><h3 class="anchored" data-anchor-id="ipw-with-the-ipw-package-binary-treatment">IPW with the <strong>ipw</strong> package, binary treatment</h3>
<p>Instead of running a logistic regression model and generating propensity scores by hand, we can use the <strong>ipw</strong> package to generate that <code>ipw</code> column automatically. Specify the confounders in the <code>denominator</code> argument. There’s a <code>numerator</code> argument too that we can use for generating stabilized weights, but we’ll skip that for now.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># ipwpoint() can't handle tibbles! Force net_data to be a data.frame</span></span>
<span><span class="va">weights_ipwpoint</span> <span class="op">&lt;-</span> <span class="fu">ipwpoint</span><span class="op">(</span></span>
<span>  exposure <span class="op">=</span> <span class="va">net</span>,</span>
<span>  family <span class="op">=</span> <span class="st">"binomial"</span>,  <span class="co"># The treatment is binary</span></span>
<span>  link <span class="op">=</span> <span class="st">"logit"</span>,</span>
<span>  denominator <span class="op">=</span> <span class="op">~</span> <span class="va">income</span> <span class="op">+</span> <span class="va">health</span>,</span>
<span>  data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">net_data</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># They're the same!</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">weights_ipwpoint</span><span class="op">$</span><span class="va">ipw.weights</span><span class="op">)</span></span>
<span><span class="co">## [1] 1.61 1.59 2.93 1.36 1.68 1.85</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">net_data_ipw</span><span class="op">$</span><span class="va">ipw</span><span class="op">)</span></span>
<span><span class="co">## [1] 1.61 1.59 2.93 1.36 1.68 1.85</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The resulting <code>weights</code> object here is a standalone object, and you can do other things with it like <code><a href="https://rdrr.io/r/base/summary.html">summary()</a></code>. We can add the weights back into the main data and then fit the final model (<em>technically</em> we don’t need to—we could just say <code>weights = weights_ipwpoint$ipw.weights</code> and it would work just fine, but I don’t like working with standalone vectors and prefer to have them be columns, just so everything is all together in one place).</p>
<p>We get the same ATE of -10.5.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">net_data_ipwpoint</span> <span class="op">&lt;-</span> <span class="va">net_data</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>ipw <span class="op">=</span> <span class="va">weights_ipwpoint</span><span class="op">$</span><span class="va">ipw.weights</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_net_ipwpoint</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">malaria_risk</span> <span class="op">~</span> <span class="va">net</span>, </span>
<span>                         data <span class="op">=</span> <span class="va">net_data_ipwpoint</span>, weights <span class="op">=</span> <span class="va">ipw</span><span class="op">)</span></span>
<span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_net_ipwpoint</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 2 × 5</span></span>
<span><span class="co">##   term        estimate std.error statistic  p.value</span></span>
<span><span class="co">##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">## 1 (Intercept)     40.4     0.409      98.8 0       </span></span>
<span><span class="co">## 2 net            -10.5     0.578     -18.3 1.83e-65</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="ipw-with-the-weightit-package-binary-treatment" class="level3"><h3 class="anchored" data-anchor-id="ipw-with-the-weightit-package-binary-treatment">IPW with the <strong>WeightIt</strong> package, binary treatment</h3>
<p>We can also use <a href="https://ngreifer.github.io/WeightIt/articles/WeightIt.html">the <strong>WeightIt</strong> package</a> to generate weights. It has slightly different syntax and can find all sorts of different estimands beyond the ATE (like <a href="https://livefreeordichotomize.com/2019/01/17/understanding-propensity-score-weighting/#how-do-we-incorporate-a-propensity-score-in-a-weight">most of the ones Lucy has listed</a>). It can also handle a bunch of different methods beyond propensity scores. <strong>WeightIt</strong> can also handle tibbles, which is nice. It <em>also</em> provides a bunch of other summary information (if you use <code><a href="https://rdrr.io/r/base/summary.html">summary()</a></code>), like effective sample sizes (ESS) in the treated/untreated groups and covariate balance.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">weights_weightit</span> <span class="op">&lt;-</span> <span class="fu">weightit</span><span class="op">(</span><span class="va">net</span> <span class="op">~</span> <span class="va">income</span> <span class="op">+</span> <span class="va">health</span>,  <span class="co"># Model net use with confounders</span></span>
<span>                             data <span class="op">=</span> <span class="va">net_data</span>, </span>
<span>                             estimand <span class="op">=</span> <span class="st">"ATE"</span>,  <span class="co"># Find the ATE</span></span>
<span>                             method <span class="op">=</span> <span class="st">"ps"</span><span class="op">)</span>  <span class="co"># Build weights with propensity scores</span></span>
<span><span class="va">weights_weightit</span></span>
<span><span class="co">## A weightit object</span></span>
<span><span class="co">##  - method: "glm" (propensity score weighting with GLM)</span></span>
<span><span class="co">##  - number of obs.: 1138</span></span>
<span><span class="co">##  - sampling weights: none</span></span>
<span><span class="co">##  - treatment: 2-category</span></span>
<span><span class="co">##  - estimand: ATE</span></span>
<span><span class="co">##  - covariates: income, health</span></span>
<span></span>
<span><span class="co"># See even more details here</span></span>
<span><span class="co"># summary(weights_weightit)</span></span>
<span></span>
<span><span class="co"># Same as the other methods!</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">weights_weightit</span><span class="op">$</span><span class="va">weights</span><span class="op">)</span></span>
<span><span class="co">## [1] 1.61 1.59 2.93 1.36 1.68 1.85</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As with <strong>ipw</strong>, we can add the weights to the dataset and run the model to find the same -10.5 ATE:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">net_data_weightit</span> <span class="op">&lt;-</span> <span class="va">net_data</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>ipw <span class="op">=</span> <span class="va">weights_weightit</span><span class="op">$</span><span class="va">weights</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_net_weightit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">malaria_risk</span> <span class="op">~</span> <span class="va">net</span>, </span>
<span>                         data <span class="op">=</span> <span class="va">net_data_weightit</span>, weights <span class="op">=</span> <span class="va">ipw</span><span class="op">)</span></span>
<span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_net_weightit</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 2 × 5</span></span>
<span><span class="co">##   term        estimate std.error statistic  p.value</span></span>
<span><span class="co">##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">## 1 (Intercept)     40.4     0.409      98.8 0       </span></span>
<span><span class="co">## 2 net            -10.5     0.578     -18.3 1.83e-65</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="continuous-treatments" class="level2"><h2 class="anchored" data-anchor-id="continuous-treatments">Continuous treatments</h2>
<section id="example-data-1" class="level3"><h3 class="anchored" data-anchor-id="example-data-1">Example data</h3>
<p>Inverse probability weights work with continuous treatment variables too, but the math is a <del>little</del> lot trickier. For this example, we’ll generate a DAG for a hypothetical program where poorer families are given cash grants that they can spend on malaria prevention supplies, like mosquito nets, chemical treatments, and medication. It’s a voluntary program—people self select into it, and we’ll assume that people with lower health scores and lower income will sign up. The amount of the grant depends on income.</p>
<p>The treatment here is continuous: people get different amounts of anti-malaria grant money. For the sake of simplicity here, everyone gets some grant money. I’m not even going to try multilevel zero-inflated models or anything (<a href="https://vuorre.netlify.app/post/2019/02/18/analyze-analog-scale-ratings-with-zero-one-inflated-beta-models/">though those are cool!</a>).</p>
<p>The DAG looks the same as before (since we’re trying to keep things super simple here):</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">grant_dag</span> <span class="op">&lt;-</span> <span class="fu">dagify</span><span class="op">(</span><span class="va">mal</span> <span class="op">~</span> <span class="va">grant</span> <span class="op">+</span> <span class="va">inc</span> <span class="op">+</span> <span class="va">hlth</span>,</span>
<span>                    <span class="va">grant</span> <span class="op">~</span> <span class="va">inc</span> <span class="op">+</span> <span class="va">hlth</span>,</span>
<span>                    <span class="va">hlth</span> <span class="op">~</span> <span class="va">inc</span>,</span>
<span>                    coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>mal <span class="op">=</span> <span class="fl">4</span>, grant <span class="op">=</span> <span class="fl">1</span>, inc <span class="op">=</span> <span class="fl">2</span>, hlth <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>                                  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>mal <span class="op">=</span> <span class="fl">1</span>, grant <span class="op">=</span> <span class="fl">1</span>, inc <span class="op">=</span> <span class="fl">2</span>, hlth <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                    exposure <span class="op">=</span> <span class="st">"grant"</span>,</span>
<span>                    outcome <span class="op">=</span> <span class="st">"mal"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggdag_status</span><span class="op">(</span><span class="va">grant_dag</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_dag</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/dag-continuous-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>We’ll measure these nodes like so:</p>
<ul>
<li>
<strong>Malaria risk</strong>: scale from 0–100, mostly around 40, but ranging from 10ish to 80ish. Best to use a Beta distribution.</li>
<li>
<strong>Grant</strong>: amount between 5 and 40, centered around 20ish.</li>
<li>
<strong>Income</strong>: weekly income, measured in dollars, mostly around 500 ± 300. Best to use a normal distribution.</li>
<li>
<strong>Health</strong>: scale from 0–100, mostly around 70, but ranging from 50ish to 100. Best to use a Beta distribution.</li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Make this randomness consistent</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Simulate 1504 people</span></span>
<span><span class="va">n_people</span> <span class="op">&lt;-</span> <span class="fl">1504</span></span>
<span></span>
<span><span class="va">grant_data</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span></span>
<span>  <span class="co"># Make an ID column (not necessary, but nice to have)</span></span>
<span>  id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_people</span>,</span>
<span>  <span class="co"># Generate income variable: normal, 500 ± 300</span></span>
<span>  income <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n_people</span>, mean <span class="op">=</span> <span class="fl">500</span>, sd <span class="op">=</span> <span class="fl">75</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co"># Generate health variable: beta, centered around 70ish</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>health_base <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html">rbeta</a></span><span class="op">(</span><span class="va">n_people</span>, shape1 <span class="op">=</span> <span class="fl">7</span>, shape2 <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>,</span>
<span>         <span class="co"># Health increases by 0.02 for every dollar in income</span></span>
<span>         health_income_effect <span class="op">=</span> <span class="va">income</span> <span class="op">*</span> <span class="fl">0.02</span>,</span>
<span>         <span class="co"># Make the final health score and add some noise</span></span>
<span>         health <span class="op">=</span> <span class="va">health_base</span> <span class="op">+</span> <span class="va">health_income_effect</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n_people</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>         <span class="co"># Rescale so it doesn't go above 100</span></span>
<span>         health <span class="op">=</span> <span class="fu">rescale</span><span class="op">(</span><span class="va">health</span>, to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">health</span><span class="op">)</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Generate grant variable</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>grant_base <span class="op">=</span> <span class="fu">rtruncnorm</span><span class="op">(</span><span class="va">n_people</span>, mean <span class="op">=</span> <span class="fl">18</span>, sd <span class="op">=</span> <span class="fl">10</span>, a <span class="op">=</span> <span class="fl">5</span>, b <span class="op">=</span> <span class="fl">40</span><span class="op">)</span>,</span>
<span>         <span class="co"># Grants are higher for people with lower incomes; higher for people with lower health</span></span>
<span>         grant_effect <span class="op">=</span> <span class="op">(</span><span class="va">income</span> <span class="op">*</span> <span class="op">-</span><span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">health</span> <span class="op">*</span> <span class="op">-</span><span class="fl">0.5</span><span class="op">)</span>,</span>
<span>         <span class="co"># Make the final grant amount + noise + rescale it back down</span></span>
<span>         grant <span class="op">=</span> <span class="va">grant_base</span> <span class="op">+</span> <span class="va">grant_effect</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n_people</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">8</span><span class="op">)</span>,</span>
<span>         grant <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu">rescale</span><span class="op">(</span><span class="va">grant</span>, to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">40</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Finally generate a malaria risk variable based on income, health, grant amount,</span></span>
<span>  <span class="co"># and random noise</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>malaria_risk_base <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html">rbeta</a></span><span class="op">(</span><span class="va">n_people</span>, shape1 <span class="op">=</span> <span class="fl">4</span>, shape2 <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>,</span>
<span>         <span class="co"># Risk goes down as grant money goes up. I played with these numbers</span></span>
<span>         <span class="co"># until they created reasonable coefficients.</span></span>
<span>         malaria_effect <span class="op">=</span> <span class="op">(</span><span class="op">-</span><span class="fl">40</span> <span class="op">*</span> <span class="va">grant</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="op">-</span><span class="fl">25</span> <span class="op">*</span> <span class="va">health</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="op">-</span><span class="fl">0.05</span> <span class="op">*</span> <span class="va">income</span><span class="op">)</span>,</span>
<span>         <span class="co"># Make the final malaria risk score and add some noise</span></span>
<span>         malaria_risk <span class="op">=</span> <span class="va">malaria_risk_base</span> <span class="op">+</span> <span class="va">malaria_effect</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n_people</span>, <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>         <span class="co"># Rescale so it doesn't go below 0,</span></span>
<span>         malaria_risk <span class="op">=</span> <span class="fu">rescale</span><span class="op">(</span><span class="va">malaria_risk</span>, to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">70</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">health_base</span>, <span class="va">health_income_effect</span>, <span class="va">grant_base</span>, <span class="va">grant_effect</span>, </span>
<span>            <span class="va">malaria_risk_base</span>, <span class="va">malaria_effect</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">grant_data</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 6 × 5</span></span>
<span><span class="co">##      id income health grant malaria_risk</span></span>
<span><span class="co">##   &lt;int&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;        &lt;dbl&gt;</span></span>
<span><span class="co">## 1     1   409.   70.2    27         26.3</span></span>
<span><span class="co">## 2     2   521.   75.3    18         33.3</span></span>
<span><span class="co">## 3     3   581.   62.6    20         42.3</span></span>
<span><span class="co">## 4     4   324.   83.9    28         11.8</span></span>
<span><span class="co">## 5     5   532.   74.3    20         31.8</span></span>
<span><span class="co">## 6     6   538.   75.9    15         36.2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="ipw-manually-continuous-treatment" class="level3"><h3 class="anchored" data-anchor-id="ipw-manually-continuous-treatment">IPW manually, continuous treatment</h3>
<p>If we just look at the effect of grants on malaria risk without any adjustment, every extra grant dollar causes a drop of 0.4 malaria risk points. Once again, though, this is wrong because of confounding.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Wrong correlation-is-not-causation effect</span></span>
<span><span class="va">model_grant_naive</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">malaria_risk</span> <span class="op">~</span> <span class="va">grant</span>, data <span class="op">=</span> <span class="va">grant_data</span><span class="op">)</span></span>
<span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_grant_naive</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 2 × 5</span></span>
<span><span class="co">##   term        estimate std.error statistic   p.value</span></span>
<span><span class="co">##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 (Intercept)   44.2      1.35       32.8  2.56e-178</span></span>
<span><span class="co">## 2 grant         -0.417    0.0615     -6.78 1.69e- 11</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>According to <em>do</em>-calculus logic, we again need to adjust for both income and health:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">adjustmentSets</span><span class="op">(</span><span class="va">grant_dag</span><span class="op">)</span></span>
<span><span class="co">## { hlth, inc }</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here’s where the math gets tricky. When we worked with a binary treatment, we calculated the propensity score for each observation and then used this formula to generate inverse probability weights:</p>
<p><span class="math display">\[
\frac{\text{Treatment}}{\text{Propensity}} + \frac{1 - \text{Treatment}}{1 - \text{Propensity}}
\]</span></p>
<p>We can’t do that with continuous treatment variables, though, since we don’t really have propensity scores. Instead, we use this hairy-but-not-too-scary formula (from <span class="citation" data-cites="NaimiMoodieAuger:2014">Naimi et al. (<a href="#ref-NaimiMoodieAuger:2014" role="doc-biblioref">2014</a>)</span>; <a href="http://www.jayskaufman.com/uploads/3/0/8/9/30891283/naimi_constructing_ipw_for_continuous_exposures_epidemiology_2014.pdf">ungated version here</a>; also <a href="https://meghapsimatrix.com/post/continuous-r-rmarkdown/">see this for another R example</a>):</p>
<p><span class="math display">\[
\text{IPW} = \frac{f_X (X; \mu_1, \sigma^2_1)}{f_{X | C} (X | C = c; \mu_2, \sigma^2_2)}
\]</span></p>
<p>Phew. That’s a lot of math, but it’s not too bad if we take it apart:</p>
<ul>
<li>
<span class="math inline">\(X\)</span> stands for the continuous exposure or treatment variable</li>
<li>
<span class="math inline">\(C\)</span> stands for the confounders</li>
<li>The <span class="math inline">\(f_\cdot (\cdot)\)</span> function in both the numerator and denominator stands for a probability density function with a mean of <span class="math inline">\(\mu\)</span> and a variance of <span class="math inline">\(\sigma^2\)</span>
</li>
<li>The numerator <span class="math inline">\(f_X (X; \mu_1, \sigma^2_1)\)</span> refers to the probability distribution of just the treatment variable (technically you could just use 1 as the numerator, but that can lead to unstable weights—using the probability distribution of the treatment helps stabilize the weights)</li>
<li>The denominator <span class="math inline">\(f_{X | C} (X | C = c; \mu_2, \sigma^2_2)\)</span> refers to the probability distribution of the treatment variable explained by the confounders</li>
</ul>
<p>(Fun fact: I’m like 85% sure that the <span class="math inline">\(\frac{\text{Treatment}}{\text{Propensity}} + \frac{1 - \text{Treatment}}{1 - \text{Propensity}}\)</span> formula is just an algebraically rearranged and simplified version of this fancier equation)</p>
<p>We can calculate each element of this fraction and then generate the inverse probability weights. Here’s how to do that with R:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># The numerator is the probability distribution of just the treatment variable.</span></span>
<span><span class="co"># We'll use a normal distribution for it (hence dnorm()). We need to feed</span></span>
<span><span class="co"># dnorm() the grant amount for each person, the predicted value from a simple</span></span>
<span><span class="co"># grant ~ 1 model, and the sd of the residuals from that model</span></span>
<span><span class="va">model_num</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">grant</span> <span class="op">~</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">grant_data</span><span class="op">)</span></span>
<span><span class="va">num</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">grant_data</span><span class="op">$</span><span class="va">grant</span>,</span>
<span>             <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">model_num</span><span class="op">)</span>,</span>
<span>             <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">model_num</span><span class="op">$</span><span class="va">residuals</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># The denominator is the probability distribution of the treatment variable</span></span>
<span><span class="co"># explained by the confounders. We'll again use a normal distribution for it.</span></span>
<span><span class="co"># We'll feed dnorm() the grant amount, the predicted value from a model that</span></span>
<span><span class="co"># includes the confounders, and the sd of the residuals from that model</span></span>
<span><span class="va">model_den</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">grant</span> <span class="op">~</span> <span class="va">health</span> <span class="op">+</span> <span class="va">income</span>, data <span class="op">=</span> <span class="va">grant_data</span><span class="op">)</span></span>
<span><span class="va">den</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">grant_data</span><span class="op">$</span><span class="va">grant</span>,</span>
<span>             <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">model_den</span><span class="op">)</span>,</span>
<span>             <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">model_den</span><span class="op">$</span><span class="va">residuals</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Finally, we make actual IPW weights by building the fraction</span></span>
<span><span class="va">grant_data_ipw</span> <span class="op">&lt;-</span> <span class="va">grant_data</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>ipw <span class="op">=</span> <span class="va">num</span> <span class="op">/</span> <span class="va">den</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">grant_data_ipw</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 6 × 6</span></span>
<span><span class="co">##      id income health grant malaria_risk   ipw</span></span>
<span><span class="co">##   &lt;int&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;        &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">## 1     1   409.   70.2    27         26.3 0.288</span></span>
<span><span class="co">## 2     2   521.   75.3    18         33.3 0.492</span></span>
<span><span class="co">## 3     3   581.   62.6    20         42.3 0.687</span></span>
<span><span class="co">## 4     4   324.   83.9    28         11.8 0.177</span></span>
<span><span class="co">## 5     5   532.   74.3    20         31.8 0.499</span></span>
<span><span class="co">## 6     6   538.   75.9    15         36.2 0.748</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can use the weights to find the ATE just like we did with the binary treatment:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_grant_ipw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">malaria_risk</span> <span class="op">~</span> <span class="va">grant</span>, data <span class="op">=</span> <span class="va">grant_data_ipw</span>, weights <span class="op">=</span> <span class="va">ipw</span><span class="op">)</span></span>
<span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_grant_ipw</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 2 × 5</span></span>
<span><span class="co">##   term        estimate std.error statistic   p.value</span></span>
<span><span class="co">##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 (Intercept)    58.4     1.79        32.6 1.95e-176</span></span>
<span><span class="co">## 2 grant          -1.11    0.0806     -13.7 1.45e- 40</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Each dollar of grant money thus <strong>causes a drop of -1.1 malaria risk points</strong>. Neato!</p>
</section><section id="ipw-with-the-ipw-package-continuous-treatment" class="level3"><h3 class="anchored" data-anchor-id="ipw-with-the-ipw-package-continuous-treatment">IPW with the <strong>ipw</strong> package, continuous treatment</h3>
<p>Manually creating the numerator and denominator can get tedious though. We can use the <code>ipwpoint()</code> function from <strong>ipw</strong> to generate continuous weights in one step. Instead of specifying a binomial treatment like we did before, we’ll use a Gaussian (normal) family. We also specify both the numerator and denominator. It will generate identical weights.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">weights_continuous_ipwpoint</span> <span class="op">&lt;-</span> <span class="fu">ipwpoint</span><span class="op">(</span></span>
<span>  exposure <span class="op">=</span> <span class="va">grant</span>,</span>
<span>  family <span class="op">=</span> <span class="st">"gaussian"</span>,</span>
<span>  numerator <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>  denominator <span class="op">=</span> <span class="op">~</span> <span class="va">health</span> <span class="op">+</span> <span class="va">income</span>,</span>
<span>  data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">grant_data</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Same values!</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">grant_data_ipw</span><span class="op">$</span><span class="va">ipw</span><span class="op">)</span></span>
<span><span class="co">## [1] 0.288 0.492 0.687 0.177 0.499 0.748</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">weights_continuous_ipwpoint</span><span class="op">$</span><span class="va">ipw.weights</span><span class="op">)</span></span>
<span><span class="co">## [1] 0.288 0.492 0.687 0.177 0.499 0.748</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can then put those weights into the dataset and run a model with them. We get the same ATE of -1.1:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">grant_data_ipwpoint</span> <span class="op">&lt;-</span> <span class="va">grant_data</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>ipw <span class="op">=</span> <span class="va">weights_continuous_ipwpoint</span><span class="op">$</span><span class="va">ipw.weights</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_grant_ipwpoint</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">malaria_risk</span> <span class="op">~</span> <span class="va">grant</span>, </span>
<span>                           data <span class="op">=</span> <span class="va">grant_data_ipwpoint</span>, weights <span class="op">=</span> <span class="va">ipw</span><span class="op">)</span></span>
<span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_grant_ipwpoint</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 2 × 5</span></span>
<span><span class="co">##   term        estimate std.error statistic   p.value</span></span>
<span><span class="co">##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 (Intercept)    58.4     1.79        32.6 1.95e-176</span></span>
<span><span class="co">## 2 grant          -1.11    0.0806     -13.7 1.45e- 40</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="ipw-with-the-weightit-package-continuous-treatment" class="level3"><h3 class="anchored" data-anchor-id="ipw-with-the-weightit-package-continuous-treatment">IPW with the <strong>WeightIt</strong> package, continuous treatment</h3>
<p>The <strong>WeightIt</strong> package also handles continuous weights. The syntax is a lot simpler—there’s no need to worry about numerators and denominators.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">weights_weightit</span> <span class="op">&lt;-</span> <span class="fu">weightit</span><span class="op">(</span><span class="va">grant</span> <span class="op">~</span> <span class="va">income</span> <span class="op">+</span> <span class="va">health</span>,  <span class="co"># Model grant amount with confounders</span></span>
<span>                             data <span class="op">=</span> <span class="va">grant_data</span>, </span>
<span>                             stabilize <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">weights_weightit</span></span>
<span><span class="co">## A weightit object</span></span>
<span><span class="co">##  - method: "glm" (propensity score weighting with GLM)</span></span>
<span><span class="co">##  - number of obs.: 1504</span></span>
<span><span class="co">##  - sampling weights: none</span></span>
<span><span class="co">##  - treatment: continuous</span></span>
<span><span class="co">##  - covariates: income, health</span></span>
<span></span>
<span><span class="co"># See even more details here</span></span>
<span><span class="co"># summary(weights_weightit)</span></span>
<span></span>
<span><span class="co"># Not the same as the other methods :(</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">weights_weightit</span><span class="op">$</span><span class="va">weights</span><span class="op">)</span></span>
<span><span class="co">## [1] 0.580 0.990 1.384 0.356 1.005 1.506</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>However(!), for mathy reasons I don’t understand, the weights it generates are not the same as what we get when doing it by hand or with <code>ipwpoint()</code>. In fact, they’re almost exactly twice as large as the manual and <code>ipwpoint()</code> weights:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Manual weights</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">grant_data_ipw</span><span class="op">$</span><span class="va">ipw</span><span class="op">)</span></span>
<span><span class="co">## [1] 0.288 0.492 0.687 0.177 0.499 0.748</span></span>
<span></span>
<span><span class="co"># weightit() weights / 2</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">weights_weightit</span><span class="op">$</span><span class="va">weights</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span></span>
<span><span class="co">## [1] 0.290 0.495 0.692 0.178 0.502 0.753</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Surely there’s an argument to <code>weightit()</code> that I’m missing somewhere.</p>
<p>Regardless, for more mathy reasons I don’t understand, the ATE is identical even though the weights are roughly doubled:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">grant_data_weightit</span> <span class="op">&lt;-</span> <span class="va">grant_data</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>ipw <span class="op">=</span> <span class="va">weights_weightit</span><span class="op">$</span><span class="va">weights</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_grant_weightit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">malaria_risk</span> <span class="op">~</span> <span class="va">grant</span>, </span>
<span>                           data <span class="op">=</span> <span class="va">grant_data_weightit</span>, weights <span class="op">=</span> <span class="va">ipw</span><span class="op">)</span></span>
<span><span class="fu">tidy</span><span class="op">(</span><span class="va">model_grant_weightit</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 2 × 5</span></span>
<span><span class="co">##   term        estimate std.error statistic   p.value</span></span>
<span><span class="co">##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 (Intercept)    58.4     1.79        32.6 1.95e-176</span></span>
<span><span class="co">## 2 grant          -1.11    0.0806     -13.7 1.45e- 40</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="references" class="level2">


<!-- -->


</section><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-BlackwellGlynn:2018" class="csl-entry" role="listitem">
Blackwell, Matthew, and Adam N. Glynn. 2018. <span>“How to Make Causal Inferences with Time-Series Cross-Sectional Data Under Selection on Observables.”</span> <em>American Political Science Review</em> 112 (4): 1067–82. <a href="https://doi.org/10.1017/s0003055418000357">https://doi.org/10.1017/s0003055418000357</a>.
</div>
<div id="ref-NaimiMoodieAuger:2014" class="csl-entry" role="listitem">
Naimi, Ashley I., Erica E. M. Moodie, Nathalie Auger, and Jay S. Kaufman. 2014. <span>“Constructing Inverse Probability Weights for Continuous Exposures; a Comparison of Methods.”</span> <em>Epidemiology</em> 25 (2): 292–99. <a href="https://doi.org/10.1097/eDe.0000000000000053">https://doi.org/10.1097/eDe.0000000000000053</a>.
</div>
</div></section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{heiss2020,
  author = {Heiss, Andrew},
  title = {Generating Inverse Probability Weights for Both Binary and
    Continuous Treatments},
  date = {2020-12-01},
  url = {https://www.andrewheiss.com/blog/2020/12/01/ipw-binary-continuous/},
  doi = {10.59350/1svkc-rkv91},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-heiss2020" class="csl-entry quarto-appendix-citeas" role="listitem">
Heiss, Andrew. 2020. <span>“Generating Inverse Probability Weights for
Both Binary and Continuous Treatments.”</span> December 1, 2020. <a href="https://doi.org/10.59350/1svkc-rkv91">https://doi.org/10.59350/1svkc-rkv91</a>.
</div></div></section></div></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/www\.andrewheiss\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><script src="https://giscus.app/client.js" data-repo="andrewheiss/ath-quarto" data-repo-id="R_kgDOIg6EJQ" data-category="Blog comments" data-category-id="DIC_kwDOIg6EJc4CSz92" data-mapping="pathname" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script><input type="hidden" id="giscus-base-theme" value="light"><input type="hidden" id="giscus-alt-theme" value="dark"><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb23" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Generating inverse probability weights for both binary and continuous treatments"</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> 2020-12-01</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="an">description:</span><span class="co"> "Use R to close backdoor confounding by generating and using inverse probability weights for both binary and continuous treatments"</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span><span class="co"> </span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="co">  - r</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="co">  - tidyverse</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="co">  - causal inference</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="co">  - DAGs</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="co">  - do calculus</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="co">  - inverse probability weighting</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="an">image:</span><span class="co"> index_files/figure-html/dag-binary-1.png</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="an">doi:</span><span class="co"> 10.59350/1svkc-rkv91</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a><span class="an">citation:</span><span class="co"> true</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, include=FALSE}</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::opts_chunk$set(fig.width = 6, fig.asp = 0.618, fig.align = "center", </span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a><span class="in">                      fig.retina = 3, out.width = "90%", collapse = TRUE)</span></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a><span class="in">options(digits = 3, width = 90)</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a><span class="in">options(dplyr.summarise.inform = FALSE)</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>My <span class="co">[</span><span class="ot">program evaluation class</span><span class="co">](https://evalf20.classes.andrewheiss.com/)</span> is basically a fun wrapper around topics in causal inference and econometrics. I'm a big fan of Judea Pearl-style <span class="co">[</span><span class="ot">"causal revolution"</span><span class="co">](https://bigthink.com/errors-we-live-by/judea-pearls-the-book-of-why-brings-news-of-a-new-science-of-causes)</span> causal graphs (or <span class="co">[</span><span class="ot">DAGs</span><span class="co">](https://cran.r-project.org/web/packages/ggdag/vignettes/intro-to-dags.html)</span>), and they've made it easier for both me and my students to understand econometric approaches like diff-in-diff, regression discontinuity, and instrumental variables. </span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>DAGs are also incredibly helpful for doing causal inference with observational data *without* needing a specific quasi-experimental situation. As I show <span class="co">[</span><span class="ot">in this blog post</span><span class="co">](/blog/2020/02/25/closing-backdoors-dags/)</span> (and in <span class="co">[</span><span class="ot">this new textbook chapter!</span><span class="co">](/research/chapters/heiss-causal-inference-2021/)</span>), you can use DAGs to identify confounders that distort the relationship (i.e. open up backdoors) between treatment and outcome. You can then use statistical methods to close those backdoors and adjust for the confounding. In both that blog post and the chapter, I show how to do this with matching and with inverse probability weighting (IPW).</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>However, those examples assume that the treatment is binary. This is fine—lots of social programs *are* binary (used program/didn't use program), and the math for creating inverse probability weights with binary treatment variables is fairly straightforward. However, treatment variables are also often *not* binary, especially outside of program evaluation. </span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>In my own research, I'm working on a couple projects right now where the "treatment" is a count of anti-NGO legal restrictions in a country. I want to be able to use DAGs and inverse probability weighting to adjust for confounders, but I can't use the IPW stuff I've been teaching because that variable isn't binary! This research project gets even more complicated because it involves time-series cross-sectional (TSCS) data with both time-varying and time-invarying confounders, which opens up a whole other can of worms that I'll figure out soon following @BlackwellGlynn:2018.</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>So I had to teach myself how to do IPW with continuous variables. This post shows how to calculate IPWs for both binary and continuous treatments, both manually and with a couple different R packages (<span class="co">[</span><span class="ot">**ipw**</span><span class="co">](https://cran.r-project.org/package=ipw)</span> and <span class="co">[</span><span class="ot">**WeightIt**</span><span class="co">](https://github.com/ngreifer/WeightIt)</span>). </span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setup, warning=FALSE, message=FALSE}</span></span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidyverse)</span></span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a><span class="in">library(broom)</span></span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a><span class="in">library(scales)</span></span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggdag)</span></span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a><span class="in">library(dagitty)</span></span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a><span class="in">library(truncnorm)</span></span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a><span class="in">library(ipw)</span></span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a><span class="in">library(WeightIt)</span></span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a><span class="fu">## Binary treatments</span></span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a><span class="fu">### Example data</span></span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a>For this example, we'll generate a DAG for a hypothetical program where bed net use causes a reduction in malaria risk. That relationship is confounded by both income and health, and income influences health. Income and health both increase the probability of net usage.</span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a>The treatment here is binary: either people use nets or they don't.</span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-53"><a href="#cb23-53" aria-hidden="true" tabindex="-1"></a><span class="in">```{r dag-binary, fig.width=6}</span></span>
<span id="cb23-54"><a href="#cb23-54" aria-hidden="true" tabindex="-1"></a><span class="in">mosquito_dag &lt;- dagify(mal ~ net + inc + hlth,</span></span>
<span id="cb23-55"><a href="#cb23-55" aria-hidden="true" tabindex="-1"></a><span class="in">                       net ~ inc + hlth,</span></span>
<span id="cb23-56"><a href="#cb23-56" aria-hidden="true" tabindex="-1"></a><span class="in">                       hlth ~ inc,</span></span>
<span id="cb23-57"><a href="#cb23-57" aria-hidden="true" tabindex="-1"></a><span class="in">                       coords = list(x = c(mal = 4, net = 1, inc = 2, hlth = 3),</span></span>
<span id="cb23-58"><a href="#cb23-58" aria-hidden="true" tabindex="-1"></a><span class="in">                                     y = c(mal = 1, net = 1, inc = 2, hlth = 2)),</span></span>
<span id="cb23-59"><a href="#cb23-59" aria-hidden="true" tabindex="-1"></a><span class="in">                       exposure = "net",</span></span>
<span id="cb23-60"><a href="#cb23-60" aria-hidden="true" tabindex="-1"></a><span class="in">                       outcome = "mal")</span></span>
<span id="cb23-61"><a href="#cb23-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-62"><a href="#cb23-62" aria-hidden="true" tabindex="-1"></a><span class="in">ggdag_status(mosquito_dag) +</span></span>
<span id="cb23-63"><a href="#cb23-63" aria-hidden="true" tabindex="-1"></a><span class="in">  guides(color = "none") +</span></span>
<span id="cb23-64"><a href="#cb23-64" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_dag()</span></span>
<span id="cb23-65"><a href="#cb23-65" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-66"><a href="#cb23-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-67"><a href="#cb23-67" aria-hidden="true" tabindex="-1"></a>We'll measure these nodes like so:</span>
<span id="cb23-68"><a href="#cb23-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-69"><a href="#cb23-69" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Malaria risk**: scale from 0–100, mostly around 40, but ranging from 10ish to 80ish. Best to use a Beta distribution.</span>
<span id="cb23-70"><a href="#cb23-70" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Net use**: binary 0/1, TRUE/FALSE variable, where 50% of people use nets. Best to use a binomial distribution. However, since we want to use other variables that increase the likelihood of using a net, we'll generate a latent continuous variable, rescale it to 0–1, and then use it as probabilities in <span class="in">`rbinom()`</span> and assign people to treatment based on those probabilities.</span>
<span id="cb23-71"><a href="#cb23-71" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Income**: weekly income, measured in dollars, mostly around 500 ± 300. Best to use a normal distribution.</span>
<span id="cb23-72"><a href="#cb23-72" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Health**: scale from 0–100, mostly around 70, but ranging from 50ish to 100. Best to use a Beta distribution.</span>
<span id="cb23-73"><a href="#cb23-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-74"><a href="#cb23-74" aria-hidden="true" tabindex="-1"></a><span class="in">```{r make-binary-treatment-data}</span></span>
<span id="cb23-75"><a href="#cb23-75" aria-hidden="true" tabindex="-1"></a><span class="in"># Make this randomness consistent</span></span>
<span id="cb23-76"><a href="#cb23-76" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(1234)</span></span>
<span id="cb23-77"><a href="#cb23-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-78"><a href="#cb23-78" aria-hidden="true" tabindex="-1"></a><span class="in"># Simulate 1138 people (just for fun)</span></span>
<span id="cb23-79"><a href="#cb23-79" aria-hidden="true" tabindex="-1"></a><span class="in">n_people &lt;- 1138</span></span>
<span id="cb23-80"><a href="#cb23-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-81"><a href="#cb23-81" aria-hidden="true" tabindex="-1"></a><span class="in">net_data &lt;- tibble(</span></span>
<span id="cb23-82"><a href="#cb23-82" aria-hidden="true" tabindex="-1"></a><span class="in">  # Make an ID column (not necessary, but nice to have)</span></span>
<span id="cb23-83"><a href="#cb23-83" aria-hidden="true" tabindex="-1"></a><span class="in">  id = 1:n_people,</span></span>
<span id="cb23-84"><a href="#cb23-84" aria-hidden="true" tabindex="-1"></a><span class="in">  # Generate income variable: normal, 500 ± 300</span></span>
<span id="cb23-85"><a href="#cb23-85" aria-hidden="true" tabindex="-1"></a><span class="in">  income = rnorm(n_people, mean = 500, sd = 75)</span></span>
<span id="cb23-86"><a href="#cb23-86" aria-hidden="true" tabindex="-1"></a><span class="in">) %&gt;% </span></span>
<span id="cb23-87"><a href="#cb23-87" aria-hidden="true" tabindex="-1"></a><span class="in">  # Generate health variable: beta, centered around 70ish</span></span>
<span id="cb23-88"><a href="#cb23-88" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(health_base = rbeta(n_people, shape1 = 7, shape2 = 4) * 100,</span></span>
<span id="cb23-89"><a href="#cb23-89" aria-hidden="true" tabindex="-1"></a><span class="in">         # Health increases by 0.02 for every dollar in income</span></span>
<span id="cb23-90"><a href="#cb23-90" aria-hidden="true" tabindex="-1"></a><span class="in">         health_income_effect = income * 0.02,</span></span>
<span id="cb23-91"><a href="#cb23-91" aria-hidden="true" tabindex="-1"></a><span class="in">         # Make the final health score and add some noise</span></span>
<span id="cb23-92"><a href="#cb23-92" aria-hidden="true" tabindex="-1"></a><span class="in">         health = health_base + health_income_effect + rnorm(n_people, mean = 0, sd = 3),</span></span>
<span id="cb23-93"><a href="#cb23-93" aria-hidden="true" tabindex="-1"></a><span class="in">         # Rescale so it doesn't go above 100</span></span>
<span id="cb23-94"><a href="#cb23-94" aria-hidden="true" tabindex="-1"></a><span class="in">         health = rescale(health, to = c(min(health), 100))) %&gt;% </span></span>
<span id="cb23-95"><a href="#cb23-95" aria-hidden="true" tabindex="-1"></a><span class="in">  # Generate net variable based on income, health, and random noise</span></span>
<span id="cb23-96"><a href="#cb23-96" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(net_score = (0.5 * income) + (1.5 * health) + rnorm(n_people, mean = 0, sd = 15),</span></span>
<span id="cb23-97"><a href="#cb23-97" aria-hidden="true" tabindex="-1"></a><span class="in">         # Scale net score down to 0.05 to 0.95 to create a probability of using a net</span></span>
<span id="cb23-98"><a href="#cb23-98" aria-hidden="true" tabindex="-1"></a><span class="in">         net_probability = rescale(net_score, to = c(0.05, 0.95)),</span></span>
<span id="cb23-99"><a href="#cb23-99" aria-hidden="true" tabindex="-1"></a><span class="in">         # Randomly generate a 0/1 variable using that probability</span></span>
<span id="cb23-100"><a href="#cb23-100" aria-hidden="true" tabindex="-1"></a><span class="in">         net = rbinom(n_people, 1, net_probability)) %&gt;% </span></span>
<span id="cb23-101"><a href="#cb23-101" aria-hidden="true" tabindex="-1"></a><span class="in">  # Finally generate a malaria risk variable based on income, health, net use,</span></span>
<span id="cb23-102"><a href="#cb23-102" aria-hidden="true" tabindex="-1"></a><span class="in">  # and random noise</span></span>
<span id="cb23-103"><a href="#cb23-103" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(malaria_risk_base = rbeta(n_people, shape1 = 4, shape2 = 5) * 100,</span></span>
<span id="cb23-104"><a href="#cb23-104" aria-hidden="true" tabindex="-1"></a><span class="in">         # Risk goes down by 10 when using a net. Because we rescale things,</span></span>
<span id="cb23-105"><a href="#cb23-105" aria-hidden="true" tabindex="-1"></a><span class="in">         # though, we have to make the effect a lot bigger here so it scales</span></span>
<span id="cb23-106"><a href="#cb23-106" aria-hidden="true" tabindex="-1"></a><span class="in">         # down to -10. Risk also decreases as health and income go up. I played</span></span>
<span id="cb23-107"><a href="#cb23-107" aria-hidden="true" tabindex="-1"></a><span class="in">         # with these numbers until they created reasonable coefficients.</span></span>
<span id="cb23-108"><a href="#cb23-108" aria-hidden="true" tabindex="-1"></a><span class="in">         malaria_effect = (-30 * net) + (-1.9 * health) + (-0.1 * income),</span></span>
<span id="cb23-109"><a href="#cb23-109" aria-hidden="true" tabindex="-1"></a><span class="in">         # Make the final malaria risk score and add some noise</span></span>
<span id="cb23-110"><a href="#cb23-110" aria-hidden="true" tabindex="-1"></a><span class="in">         malaria_risk = malaria_risk_base + malaria_effect + rnorm(n_people, 0, sd = 3),</span></span>
<span id="cb23-111"><a href="#cb23-111" aria-hidden="true" tabindex="-1"></a><span class="in">         # Rescale so it doesn't go below 0,</span></span>
<span id="cb23-112"><a href="#cb23-112" aria-hidden="true" tabindex="-1"></a><span class="in">         malaria_risk = rescale(malaria_risk, to = c(5, 70))) %&gt;% </span></span>
<span id="cb23-113"><a href="#cb23-113" aria-hidden="true" tabindex="-1"></a><span class="in">  select(-c(health_base, health_income_effect, net_score, net_probability, </span></span>
<span id="cb23-114"><a href="#cb23-114" aria-hidden="true" tabindex="-1"></a><span class="in">            malaria_risk_base, malaria_effect))</span></span>
<span id="cb23-115"><a href="#cb23-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-116"><a href="#cb23-116" aria-hidden="true" tabindex="-1"></a><span class="in">head(net_data)</span></span>
<span id="cb23-117"><a href="#cb23-117" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-118"><a href="#cb23-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-119"><a href="#cb23-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-120"><a href="#cb23-120" aria-hidden="true" tabindex="-1"></a><span class="fu">### IPW manually, binary treatment</span></span>
<span id="cb23-121"><a href="#cb23-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-122"><a href="#cb23-122" aria-hidden="true" tabindex="-1"></a>If we just look at the effect of nets on malaria risk without any statistical adjustment, we see that nets cause a decrease of 13 points in malaria risk. This is wrong though because there's confounding.</span>
<span id="cb23-123"><a href="#cb23-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-124"><a href="#cb23-124" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-net-naive}</span></span>
<span id="cb23-125"><a href="#cb23-125" aria-hidden="true" tabindex="-1"></a><span class="in"># Wrong correlation-is-not-causation effect</span></span>
<span id="cb23-126"><a href="#cb23-126" aria-hidden="true" tabindex="-1"></a><span class="in">model_net_naive &lt;- lm(malaria_risk ~ net, data = net_data)</span></span>
<span id="cb23-127"><a href="#cb23-127" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_net_naive)</span></span>
<span id="cb23-128"><a href="#cb23-128" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-129"><a href="#cb23-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-130"><a href="#cb23-130" aria-hidden="true" tabindex="-1"></a>According to *do*-calculus logic, we need to adjust for both income and health:</span>
<span id="cb23-131"><a href="#cb23-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-132"><a href="#cb23-132" aria-hidden="true" tabindex="-1"></a><span class="in">```{r find-adjustment-net}</span></span>
<span id="cb23-133"><a href="#cb23-133" aria-hidden="true" tabindex="-1"></a><span class="in">adjustmentSets(mosquito_dag)</span></span>
<span id="cb23-134"><a href="#cb23-134" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-135"><a href="#cb23-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-136"><a href="#cb23-136" aria-hidden="true" tabindex="-1"></a>We'll do that with inverse probability weighting. First we'll use the health and income confounders to predict the treatment, or net use, and then we'll generate propensity scores. We'll then use those propensity scores to generate inverse probability weights following this formula:</span>
<span id="cb23-137"><a href="#cb23-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-138"><a href="#cb23-138" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb23-139"><a href="#cb23-139" aria-hidden="true" tabindex="-1"></a>\frac{\text{Treatment}}{\text{Propensity}} + \frac{1 - \text{Treatment}}{1 - \text{Propensity}}</span>
<span id="cb23-140"><a href="#cb23-140" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb23-141"><a href="#cb23-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-142"><a href="#cb23-142" aria-hidden="true" tabindex="-1"></a>This formula will calculate weights for the average treatment effect (ATE). <span class="co">[</span><span class="ot">Lucy D'Agostino McGowan has formulas for a bunch of different IPWs</span><span class="co">](https://livefreeordichotomize.com/2019/01/17/understanding-propensity-score-weighting/#how-do-we-incorporate-a-propensity-score-in-a-weight)</span>, including the average treatment on the treated (ATT), average treatment among the controls (ATC), and other effects.</span>
<span id="cb23-143"><a href="#cb23-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-144"><a href="#cb23-144" aria-hidden="true" tabindex="-1"></a>Here's how we do that with R:</span>
<span id="cb23-145"><a href="#cb23-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-146"><a href="#cb23-146" aria-hidden="true" tabindex="-1"></a><span class="in">```{r create-net-ipw}</span></span>
<span id="cb23-147"><a href="#cb23-147" aria-hidden="true" tabindex="-1"></a><span class="in"># Logit model to predict net use</span></span>
<span id="cb23-148"><a href="#cb23-148" aria-hidden="true" tabindex="-1"></a><span class="in">model_predict_net &lt;- glm(net ~ income + health,</span></span>
<span id="cb23-149"><a href="#cb23-149" aria-hidden="true" tabindex="-1"></a><span class="in">                         family = binomial(link = "logit"),</span></span>
<span id="cb23-150"><a href="#cb23-150" aria-hidden="true" tabindex="-1"></a><span class="in">                         data = net_data)</span></span>
<span id="cb23-151"><a href="#cb23-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-152"><a href="#cb23-152" aria-hidden="true" tabindex="-1"></a><span class="in"># Generate propensity scores and IPWs</span></span>
<span id="cb23-153"><a href="#cb23-153" aria-hidden="true" tabindex="-1"></a><span class="in">net_data_ipw &lt;- augment_columns(model_predict_net, net_data,</span></span>
<span id="cb23-154"><a href="#cb23-154" aria-hidden="true" tabindex="-1"></a><span class="in">                                type.predict = "response") %&gt;% </span></span>
<span id="cb23-155"><a href="#cb23-155" aria-hidden="true" tabindex="-1"></a><span class="in">  rename(propensity = .fitted) %&gt;% </span></span>
<span id="cb23-156"><a href="#cb23-156" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(ipw = (net / propensity) + ((1 - net) / (1 - propensity)))</span></span>
<span id="cb23-157"><a href="#cb23-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-158"><a href="#cb23-158" aria-hidden="true" tabindex="-1"></a><span class="in">net_data_ipw %&gt;% </span></span>
<span id="cb23-159"><a href="#cb23-159" aria-hidden="true" tabindex="-1"></a><span class="in">  select(id, income, health, net, malaria_risk, propensity, ipw) %&gt;% </span></span>
<span id="cb23-160"><a href="#cb23-160" aria-hidden="true" tabindex="-1"></a><span class="in">  head()</span></span>
<span id="cb23-161"><a href="#cb23-161" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-162"><a href="#cb23-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-163"><a href="#cb23-163" aria-hidden="true" tabindex="-1"></a>Finally we'll use those weights in a regression model to find the ATE. After adjusting for confounding and closing the backdoor paths opened by income and health, **the effect of nets is -10.5**, which is more accurate than the naive estimate we found before. Yay!</span>
<span id="cb23-164"><a href="#cb23-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-165"><a href="#cb23-165" aria-hidden="true" tabindex="-1"></a><span class="in">```{r find-ate-net}</span></span>
<span id="cb23-166"><a href="#cb23-166" aria-hidden="true" tabindex="-1"></a><span class="in">model_net_ipw &lt;- lm(malaria_risk ~ net, data = net_data_ipw, weights = ipw)</span></span>
<span id="cb23-167"><a href="#cb23-167" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_net_ipw)</span></span>
<span id="cb23-168"><a href="#cb23-168" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-169"><a href="#cb23-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-170"><a href="#cb23-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-171"><a href="#cb23-171" aria-hidden="true" tabindex="-1"></a><span class="fu">### IPW with the **ipw** package, binary treatment</span></span>
<span id="cb23-172"><a href="#cb23-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-173"><a href="#cb23-173" aria-hidden="true" tabindex="-1"></a>Instead of running a logistic regression model and generating propensity scores by hand, we can use the **ipw** package to generate that <span class="in">`ipw`</span> column automatically. Specify the confounders in the <span class="in">`denominator`</span> argument. There's a <span class="in">`numerator`</span> argument too that we can use for generating stabilized weights, but we'll skip that for now.</span>
<span id="cb23-174"><a href="#cb23-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-175"><a href="#cb23-175" aria-hidden="true" tabindex="-1"></a><span class="in">```{r weights-binary-ipwpoint}</span></span>
<span id="cb23-176"><a href="#cb23-176" aria-hidden="true" tabindex="-1"></a><span class="in"># ipwpoint() can't handle tibbles! Force net_data to be a data.frame</span></span>
<span id="cb23-177"><a href="#cb23-177" aria-hidden="true" tabindex="-1"></a><span class="in">weights_ipwpoint &lt;- ipwpoint(</span></span>
<span id="cb23-178"><a href="#cb23-178" aria-hidden="true" tabindex="-1"></a><span class="in">  exposure = net,</span></span>
<span id="cb23-179"><a href="#cb23-179" aria-hidden="true" tabindex="-1"></a><span class="in">  family = "binomial",  # The treatment is binary</span></span>
<span id="cb23-180"><a href="#cb23-180" aria-hidden="true" tabindex="-1"></a><span class="in">  link = "logit",</span></span>
<span id="cb23-181"><a href="#cb23-181" aria-hidden="true" tabindex="-1"></a><span class="in">  denominator = ~ income + health,</span></span>
<span id="cb23-182"><a href="#cb23-182" aria-hidden="true" tabindex="-1"></a><span class="in">  data = as.data.frame(net_data)</span></span>
<span id="cb23-183"><a href="#cb23-183" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb23-184"><a href="#cb23-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-185"><a href="#cb23-185" aria-hidden="true" tabindex="-1"></a><span class="in"># They're the same!</span></span>
<span id="cb23-186"><a href="#cb23-186" aria-hidden="true" tabindex="-1"></a><span class="in">head(weights_ipwpoint$ipw.weights)</span></span>
<span id="cb23-187"><a href="#cb23-187" aria-hidden="true" tabindex="-1"></a><span class="in">head(net_data_ipw$ipw)</span></span>
<span id="cb23-188"><a href="#cb23-188" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-189"><a href="#cb23-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-190"><a href="#cb23-190" aria-hidden="true" tabindex="-1"></a>The resulting <span class="in">`weights`</span> object here is a standalone object, and you can do other things with it like <span class="in">`summary()`</span>. We can add the weights back into the main data and then fit the final model (*technically* we don't need to—we could just say <span class="in">`weights = weights_ipwpoint$ipw.weights`</span> and it would work just fine, but I don't like working with standalone vectors and prefer to have them be columns, just so everything is all together in one place). </span>
<span id="cb23-191"><a href="#cb23-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-192"><a href="#cb23-192" aria-hidden="true" tabindex="-1"></a>We get the same ATE of -10.5.</span>
<span id="cb23-193"><a href="#cb23-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-194"><a href="#cb23-194" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-weights-binary-ipwpoint}</span></span>
<span id="cb23-195"><a href="#cb23-195" aria-hidden="true" tabindex="-1"></a><span class="in">net_data_ipwpoint &lt;- net_data %&gt;% </span></span>
<span id="cb23-196"><a href="#cb23-196" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(ipw = weights_ipwpoint$ipw.weights)</span></span>
<span id="cb23-197"><a href="#cb23-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-198"><a href="#cb23-198" aria-hidden="true" tabindex="-1"></a><span class="in">model_net_ipwpoint &lt;- lm(malaria_risk ~ net, </span></span>
<span id="cb23-199"><a href="#cb23-199" aria-hidden="true" tabindex="-1"></a><span class="in">                         data = net_data_ipwpoint, weights = ipw)</span></span>
<span id="cb23-200"><a href="#cb23-200" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_net_ipwpoint)</span></span>
<span id="cb23-201"><a href="#cb23-201" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-202"><a href="#cb23-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-203"><a href="#cb23-203" aria-hidden="true" tabindex="-1"></a><span class="fu">### IPW with the **WeightIt** package, binary treatment</span></span>
<span id="cb23-204"><a href="#cb23-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-205"><a href="#cb23-205" aria-hidden="true" tabindex="-1"></a>We can also use <span class="co">[</span><span class="ot">the **WeightIt** package</span><span class="co">](https://ngreifer.github.io/WeightIt/articles/WeightIt.html)</span> to generate weights. It has slightly different syntax and can find all sorts of different estimands beyond the ATE (like <span class="co">[</span><span class="ot">most of the ones Lucy has listed</span><span class="co">](https://livefreeordichotomize.com/2019/01/17/understanding-propensity-score-weighting/#how-do-we-incorporate-a-propensity-score-in-a-weight)</span>). It can also handle a bunch of different methods beyond propensity scores. **WeightIt** can also handle tibbles, which is nice. It *also* provides a bunch of other summary information (if you use <span class="in">`summary()`</span>), like effective sample sizes (ESS) in the treated/untreated groups and covariate balance.</span>
<span id="cb23-206"><a href="#cb23-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-207"><a href="#cb23-207" aria-hidden="true" tabindex="-1"></a><span class="in">```{r weights-binary-weightit}</span></span>
<span id="cb23-208"><a href="#cb23-208" aria-hidden="true" tabindex="-1"></a><span class="in">weights_weightit &lt;- weightit(net ~ income + health,  # Model net use with confounders</span></span>
<span id="cb23-209"><a href="#cb23-209" aria-hidden="true" tabindex="-1"></a><span class="in">                             data = net_data, </span></span>
<span id="cb23-210"><a href="#cb23-210" aria-hidden="true" tabindex="-1"></a><span class="in">                             estimand = "ATE",  # Find the ATE</span></span>
<span id="cb23-211"><a href="#cb23-211" aria-hidden="true" tabindex="-1"></a><span class="in">                             method = "ps")  # Build weights with propensity scores</span></span>
<span id="cb23-212"><a href="#cb23-212" aria-hidden="true" tabindex="-1"></a><span class="in">weights_weightit</span></span>
<span id="cb23-213"><a href="#cb23-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-214"><a href="#cb23-214" aria-hidden="true" tabindex="-1"></a><span class="in"># See even more details here</span></span>
<span id="cb23-215"><a href="#cb23-215" aria-hidden="true" tabindex="-1"></a><span class="in"># summary(weights_weightit)</span></span>
<span id="cb23-216"><a href="#cb23-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-217"><a href="#cb23-217" aria-hidden="true" tabindex="-1"></a><span class="in"># Same as the other methods!</span></span>
<span id="cb23-218"><a href="#cb23-218" aria-hidden="true" tabindex="-1"></a><span class="in">head(weights_weightit$weights)</span></span>
<span id="cb23-219"><a href="#cb23-219" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-220"><a href="#cb23-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-221"><a href="#cb23-221" aria-hidden="true" tabindex="-1"></a>As with **ipw**, we can add the weights to the dataset and run the model to find the same -10.5 ATE:</span>
<span id="cb23-222"><a href="#cb23-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-223"><a href="#cb23-223" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-weights-binary-weightit}</span></span>
<span id="cb23-224"><a href="#cb23-224" aria-hidden="true" tabindex="-1"></a><span class="in">net_data_weightit &lt;- net_data %&gt;% </span></span>
<span id="cb23-225"><a href="#cb23-225" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(ipw = weights_weightit$weights)</span></span>
<span id="cb23-226"><a href="#cb23-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-227"><a href="#cb23-227" aria-hidden="true" tabindex="-1"></a><span class="in">model_net_weightit &lt;- lm(malaria_risk ~ net, </span></span>
<span id="cb23-228"><a href="#cb23-228" aria-hidden="true" tabindex="-1"></a><span class="in">                         data = net_data_weightit, weights = ipw)</span></span>
<span id="cb23-229"><a href="#cb23-229" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_net_weightit)</span></span>
<span id="cb23-230"><a href="#cb23-230" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-231"><a href="#cb23-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-232"><a href="#cb23-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-233"><a href="#cb23-233" aria-hidden="true" tabindex="-1"></a><span class="fu">## Continuous treatments</span></span>
<span id="cb23-234"><a href="#cb23-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-235"><a href="#cb23-235" aria-hidden="true" tabindex="-1"></a><span class="fu">### Example data</span></span>
<span id="cb23-236"><a href="#cb23-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-237"><a href="#cb23-237" aria-hidden="true" tabindex="-1"></a>Inverse probability weights work with continuous treatment variables too, but the math is a ~~little~~ lot trickier. For this example, we'll generate a DAG for a hypothetical program where poorer families are given cash grants that they can spend on malaria prevention supplies, like mosquito nets, chemical treatments, and medication. It's a voluntary program—people self select into it, and we'll assume that people with lower health scores and lower income will sign up. The amount of the grant depends on income.</span>
<span id="cb23-238"><a href="#cb23-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-239"><a href="#cb23-239" aria-hidden="true" tabindex="-1"></a>The treatment here is continuous: people get different amounts of anti-malaria grant money. For the sake of simplicity here, everyone gets some grant money. I'm not even going to try multilevel zero-inflated models or anything (<span class="co">[</span><span class="ot">though those are cool!</span><span class="co">](https://vuorre.netlify.app/post/2019/02/18/analyze-analog-scale-ratings-with-zero-one-inflated-beta-models/)</span>).</span>
<span id="cb23-240"><a href="#cb23-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-241"><a href="#cb23-241" aria-hidden="true" tabindex="-1"></a>The DAG looks the same as before (since we're trying to keep things super simple here):</span>
<span id="cb23-242"><a href="#cb23-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-243"><a href="#cb23-243" aria-hidden="true" tabindex="-1"></a><span class="in">```{r dag-continuous, fig.width=6}</span></span>
<span id="cb23-244"><a href="#cb23-244" aria-hidden="true" tabindex="-1"></a><span class="in">grant_dag &lt;- dagify(mal ~ grant + inc + hlth,</span></span>
<span id="cb23-245"><a href="#cb23-245" aria-hidden="true" tabindex="-1"></a><span class="in">                    grant ~ inc + hlth,</span></span>
<span id="cb23-246"><a href="#cb23-246" aria-hidden="true" tabindex="-1"></a><span class="in">                    hlth ~ inc,</span></span>
<span id="cb23-247"><a href="#cb23-247" aria-hidden="true" tabindex="-1"></a><span class="in">                    coords = list(x = c(mal = 4, grant = 1, inc = 2, hlth = 3),</span></span>
<span id="cb23-248"><a href="#cb23-248" aria-hidden="true" tabindex="-1"></a><span class="in">                                  y = c(mal = 1, grant = 1, inc = 2, hlth = 2)),</span></span>
<span id="cb23-249"><a href="#cb23-249" aria-hidden="true" tabindex="-1"></a><span class="in">                    exposure = "grant",</span></span>
<span id="cb23-250"><a href="#cb23-250" aria-hidden="true" tabindex="-1"></a><span class="in">                    outcome = "mal")</span></span>
<span id="cb23-251"><a href="#cb23-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-252"><a href="#cb23-252" aria-hidden="true" tabindex="-1"></a><span class="in">ggdag_status(grant_dag) +</span></span>
<span id="cb23-253"><a href="#cb23-253" aria-hidden="true" tabindex="-1"></a><span class="in">  guides(color = "none") +</span></span>
<span id="cb23-254"><a href="#cb23-254" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_dag()</span></span>
<span id="cb23-255"><a href="#cb23-255" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-256"><a href="#cb23-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-257"><a href="#cb23-257" aria-hidden="true" tabindex="-1"></a>We'll measure these nodes like so:</span>
<span id="cb23-258"><a href="#cb23-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-259"><a href="#cb23-259" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Malaria risk**: scale from 0–100, mostly around 40, but ranging from 10ish to 80ish. Best to use a Beta distribution.</span>
<span id="cb23-260"><a href="#cb23-260" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Grant**: amount between 5 and 40, centered around 20ish.</span>
<span id="cb23-261"><a href="#cb23-261" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Income**: weekly income, measured in dollars, mostly around 500 ± 300. Best to use a normal distribution.</span>
<span id="cb23-262"><a href="#cb23-262" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Health**: scale from 0–100, mostly around 70, but ranging from 50ish to 100. Best to use a Beta distribution.</span>
<span id="cb23-263"><a href="#cb23-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-264"><a href="#cb23-264" aria-hidden="true" tabindex="-1"></a><span class="in">```{r make-continuous-treatment-data}</span></span>
<span id="cb23-265"><a href="#cb23-265" aria-hidden="true" tabindex="-1"></a><span class="in"># Make this randomness consistent</span></span>
<span id="cb23-266"><a href="#cb23-266" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(1234)</span></span>
<span id="cb23-267"><a href="#cb23-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-268"><a href="#cb23-268" aria-hidden="true" tabindex="-1"></a><span class="in"># Simulate 1504 people</span></span>
<span id="cb23-269"><a href="#cb23-269" aria-hidden="true" tabindex="-1"></a><span class="in">n_people &lt;- 1504</span></span>
<span id="cb23-270"><a href="#cb23-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-271"><a href="#cb23-271" aria-hidden="true" tabindex="-1"></a><span class="in">grant_data &lt;- tibble(</span></span>
<span id="cb23-272"><a href="#cb23-272" aria-hidden="true" tabindex="-1"></a><span class="in">  # Make an ID column (not necessary, but nice to have)</span></span>
<span id="cb23-273"><a href="#cb23-273" aria-hidden="true" tabindex="-1"></a><span class="in">  id = 1:n_people,</span></span>
<span id="cb23-274"><a href="#cb23-274" aria-hidden="true" tabindex="-1"></a><span class="in">  # Generate income variable: normal, 500 ± 300</span></span>
<span id="cb23-275"><a href="#cb23-275" aria-hidden="true" tabindex="-1"></a><span class="in">  income = rnorm(n_people, mean = 500, sd = 75)</span></span>
<span id="cb23-276"><a href="#cb23-276" aria-hidden="true" tabindex="-1"></a><span class="in">) %&gt;%</span></span>
<span id="cb23-277"><a href="#cb23-277" aria-hidden="true" tabindex="-1"></a><span class="in">  # Generate health variable: beta, centered around 70ish</span></span>
<span id="cb23-278"><a href="#cb23-278" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(health_base = rbeta(n_people, shape1 = 7, shape2 = 4) * 100,</span></span>
<span id="cb23-279"><a href="#cb23-279" aria-hidden="true" tabindex="-1"></a><span class="in">         # Health increases by 0.02 for every dollar in income</span></span>
<span id="cb23-280"><a href="#cb23-280" aria-hidden="true" tabindex="-1"></a><span class="in">         health_income_effect = income * 0.02,</span></span>
<span id="cb23-281"><a href="#cb23-281" aria-hidden="true" tabindex="-1"></a><span class="in">         # Make the final health score and add some noise</span></span>
<span id="cb23-282"><a href="#cb23-282" aria-hidden="true" tabindex="-1"></a><span class="in">         health = health_base + health_income_effect + rnorm(n_people, mean = 0, sd = 3),</span></span>
<span id="cb23-283"><a href="#cb23-283" aria-hidden="true" tabindex="-1"></a><span class="in">         # Rescale so it doesn't go above 100</span></span>
<span id="cb23-284"><a href="#cb23-284" aria-hidden="true" tabindex="-1"></a><span class="in">         health = rescale(health, to = c(min(health), 100))) %&gt;% </span></span>
<span id="cb23-285"><a href="#cb23-285" aria-hidden="true" tabindex="-1"></a><span class="in">  # Generate grant variable</span></span>
<span id="cb23-286"><a href="#cb23-286" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(grant_base = rtruncnorm(n_people, mean = 18, sd = 10, a = 5, b = 40),</span></span>
<span id="cb23-287"><a href="#cb23-287" aria-hidden="true" tabindex="-1"></a><span class="in">         # Grants are higher for people with lower incomes; higher for people with lower health</span></span>
<span id="cb23-288"><a href="#cb23-288" aria-hidden="true" tabindex="-1"></a><span class="in">         grant_effect = (income * -0.25) + (health * -0.5),</span></span>
<span id="cb23-289"><a href="#cb23-289" aria-hidden="true" tabindex="-1"></a><span class="in">         # Make the final grant amount + noise + rescale it back down</span></span>
<span id="cb23-290"><a href="#cb23-290" aria-hidden="true" tabindex="-1"></a><span class="in">         grant = grant_base + grant_effect + rnorm(n_people, mean = 0, sd = 8),</span></span>
<span id="cb23-291"><a href="#cb23-291" aria-hidden="true" tabindex="-1"></a><span class="in">         grant = round(rescale(grant, to = c(5, 40)), 0)) %&gt;% </span></span>
<span id="cb23-292"><a href="#cb23-292" aria-hidden="true" tabindex="-1"></a><span class="in">  # Finally generate a malaria risk variable based on income, health, grant amount,</span></span>
<span id="cb23-293"><a href="#cb23-293" aria-hidden="true" tabindex="-1"></a><span class="in">  # and random noise</span></span>
<span id="cb23-294"><a href="#cb23-294" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(malaria_risk_base = rbeta(n_people, shape1 = 4, shape2 = 5) * 100,</span></span>
<span id="cb23-295"><a href="#cb23-295" aria-hidden="true" tabindex="-1"></a><span class="in">         # Risk goes down as grant money goes up. I played with these numbers</span></span>
<span id="cb23-296"><a href="#cb23-296" aria-hidden="true" tabindex="-1"></a><span class="in">         # until they created reasonable coefficients.</span></span>
<span id="cb23-297"><a href="#cb23-297" aria-hidden="true" tabindex="-1"></a><span class="in">         malaria_effect = (-40 * grant) + (-25 * health) + (-0.05 * income),</span></span>
<span id="cb23-298"><a href="#cb23-298" aria-hidden="true" tabindex="-1"></a><span class="in">         # Make the final malaria risk score and add some noise</span></span>
<span id="cb23-299"><a href="#cb23-299" aria-hidden="true" tabindex="-1"></a><span class="in">         malaria_risk = malaria_risk_base + malaria_effect + rnorm(n_people, 0, sd = 3),</span></span>
<span id="cb23-300"><a href="#cb23-300" aria-hidden="true" tabindex="-1"></a><span class="in">         # Rescale so it doesn't go below 0,</span></span>
<span id="cb23-301"><a href="#cb23-301" aria-hidden="true" tabindex="-1"></a><span class="in">         malaria_risk = rescale(malaria_risk, to = c(5, 70))) %&gt;% </span></span>
<span id="cb23-302"><a href="#cb23-302" aria-hidden="true" tabindex="-1"></a><span class="in">  select(-c(health_base, health_income_effect, grant_base, grant_effect, </span></span>
<span id="cb23-303"><a href="#cb23-303" aria-hidden="true" tabindex="-1"></a><span class="in">            malaria_risk_base, malaria_effect))</span></span>
<span id="cb23-304"><a href="#cb23-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-305"><a href="#cb23-305" aria-hidden="true" tabindex="-1"></a><span class="in">head(grant_data)</span></span>
<span id="cb23-306"><a href="#cb23-306" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-307"><a href="#cb23-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-308"><a href="#cb23-308" aria-hidden="true" tabindex="-1"></a><span class="fu">### IPW manually, continuous treatment</span></span>
<span id="cb23-309"><a href="#cb23-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-310"><a href="#cb23-310" aria-hidden="true" tabindex="-1"></a>If we just look at the effect of grants on malaria risk without any adjustment, every extra grant dollar causes a drop of 0.4 malaria risk points. Once again, though, this is wrong because of confounding.</span>
<span id="cb23-311"><a href="#cb23-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-312"><a href="#cb23-312" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-grant-naive}</span></span>
<span id="cb23-313"><a href="#cb23-313" aria-hidden="true" tabindex="-1"></a><span class="in"># Wrong correlation-is-not-causation effect</span></span>
<span id="cb23-314"><a href="#cb23-314" aria-hidden="true" tabindex="-1"></a><span class="in">model_grant_naive &lt;- lm(malaria_risk ~ grant, data = grant_data)</span></span>
<span id="cb23-315"><a href="#cb23-315" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_grant_naive)</span></span>
<span id="cb23-316"><a href="#cb23-316" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-317"><a href="#cb23-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-318"><a href="#cb23-318" aria-hidden="true" tabindex="-1"></a>According to *do*-calculus logic, we again need to adjust for both income and health:</span>
<span id="cb23-319"><a href="#cb23-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-320"><a href="#cb23-320" aria-hidden="true" tabindex="-1"></a><span class="in">```{r find-adjustment-net-grants}</span></span>
<span id="cb23-321"><a href="#cb23-321" aria-hidden="true" tabindex="-1"></a><span class="in">adjustmentSets(grant_dag)</span></span>
<span id="cb23-322"><a href="#cb23-322" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-323"><a href="#cb23-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-324"><a href="#cb23-324" aria-hidden="true" tabindex="-1"></a>Here's where the math gets tricky. When we worked with a binary treatment, we calculated the propensity score for each observation and then used this formula to generate inverse probability weights:</span>
<span id="cb23-325"><a href="#cb23-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-326"><a href="#cb23-326" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb23-327"><a href="#cb23-327" aria-hidden="true" tabindex="-1"></a>\frac{\text{Treatment}}{\text{Propensity}} + \frac{1 - \text{Treatment}}{1 - \text{Propensity}}</span>
<span id="cb23-328"><a href="#cb23-328" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb23-329"><a href="#cb23-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-330"><a href="#cb23-330" aria-hidden="true" tabindex="-1"></a>We can't do that with continuous treatment variables, though, since we don't really have propensity scores. Instead, we use this hairy-but-not-too-scary formula (from @NaimiMoodieAuger:2014; <span class="co">[</span><span class="ot">ungated version here</span><span class="co">](http://www.jayskaufman.com/uploads/3/0/8/9/30891283/naimi_constructing_ipw_for_continuous_exposures_epidemiology_2014.pdf)</span>; also <span class="co">[</span><span class="ot">see this for another R example</span><span class="co">](https://meghapsimatrix.com/post/continuous-r-rmarkdown/)</span>):</span>
<span id="cb23-331"><a href="#cb23-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-332"><a href="#cb23-332" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb23-333"><a href="#cb23-333" aria-hidden="true" tabindex="-1"></a>\text{IPW} = \frac{f_X (X; \mu_1, \sigma^2_1)}{f_{X | C} (X | C = c; \mu_2, \sigma^2_2)}</span>
<span id="cb23-334"><a href="#cb23-334" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb23-335"><a href="#cb23-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-336"><a href="#cb23-336" aria-hidden="true" tabindex="-1"></a>Phew. That's a lot of math, but it's not too bad if we take it apart:</span>
<span id="cb23-337"><a href="#cb23-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-338"><a href="#cb23-338" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$X$ stands for the continuous exposure or treatment variable</span>
<span id="cb23-339"><a href="#cb23-339" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$C$ stands for the confounders</span>
<span id="cb23-340"><a href="#cb23-340" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The $f_\cdot (\cdot)$ function in both the numerator and denominator stands for a probability density function with a mean of $\mu$ and a variance of $\sigma^2$</span>
<span id="cb23-341"><a href="#cb23-341" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The numerator $f_X (X; \mu_1, \sigma^2_1)$ refers to the probability distribution of just the treatment variable (technically you could just use 1 as the numerator, but that can lead to unstable weights—using the probability distribution of the treatment helps stabilize the weights)</span>
<span id="cb23-342"><a href="#cb23-342" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The denominator $f_{X | C} (X | C = c; \mu_2, \sigma^2_2)$ refers to the probability distribution of the treatment variable explained by the confounders</span>
<span id="cb23-343"><a href="#cb23-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-344"><a href="#cb23-344" aria-hidden="true" tabindex="-1"></a>(Fun fact: I'm like 85% sure that the $\frac{\text{Treatment}}{\text{Propensity}} + \frac{1 - \text{Treatment}}{1 - \text{Propensity}}$ formula is just an algebraically rearranged and simplified version of this fancier equation)</span>
<span id="cb23-345"><a href="#cb23-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-346"><a href="#cb23-346" aria-hidden="true" tabindex="-1"></a>We can calculate each element of this fraction and then generate the inverse probability weights. Here's how to do that with R:</span>
<span id="cb23-347"><a href="#cb23-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-348"><a href="#cb23-348" aria-hidden="true" tabindex="-1"></a><span class="in">```{r manual-continuous-weights}</span></span>
<span id="cb23-349"><a href="#cb23-349" aria-hidden="true" tabindex="-1"></a><span class="in"># The numerator is the probability distribution of just the treatment variable.</span></span>
<span id="cb23-350"><a href="#cb23-350" aria-hidden="true" tabindex="-1"></a><span class="in"># We'll use a normal distribution for it (hence dnorm()). We need to feed</span></span>
<span id="cb23-351"><a href="#cb23-351" aria-hidden="true" tabindex="-1"></a><span class="in"># dnorm() the grant amount for each person, the predicted value from a simple</span></span>
<span id="cb23-352"><a href="#cb23-352" aria-hidden="true" tabindex="-1"></a><span class="in"># grant ~ 1 model, and the sd of the residuals from that model</span></span>
<span id="cb23-353"><a href="#cb23-353" aria-hidden="true" tabindex="-1"></a><span class="in">model_num &lt;- lm(grant ~ 1, data = grant_data)</span></span>
<span id="cb23-354"><a href="#cb23-354" aria-hidden="true" tabindex="-1"></a><span class="in">num &lt;- dnorm(grant_data$grant,</span></span>
<span id="cb23-355"><a href="#cb23-355" aria-hidden="true" tabindex="-1"></a><span class="in">             predict(model_num),</span></span>
<span id="cb23-356"><a href="#cb23-356" aria-hidden="true" tabindex="-1"></a><span class="in">             sd(model_num$residuals))</span></span>
<span id="cb23-357"><a href="#cb23-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-358"><a href="#cb23-358" aria-hidden="true" tabindex="-1"></a><span class="in"># The denominator is the probability distribution of the treatment variable</span></span>
<span id="cb23-359"><a href="#cb23-359" aria-hidden="true" tabindex="-1"></a><span class="in"># explained by the confounders. We'll again use a normal distribution for it.</span></span>
<span id="cb23-360"><a href="#cb23-360" aria-hidden="true" tabindex="-1"></a><span class="in"># We'll feed dnorm() the grant amount, the predicted value from a model that</span></span>
<span id="cb23-361"><a href="#cb23-361" aria-hidden="true" tabindex="-1"></a><span class="in"># includes the confounders, and the sd of the residuals from that model</span></span>
<span id="cb23-362"><a href="#cb23-362" aria-hidden="true" tabindex="-1"></a><span class="in">model_den &lt;- lm(grant ~ health + income, data = grant_data)</span></span>
<span id="cb23-363"><a href="#cb23-363" aria-hidden="true" tabindex="-1"></a><span class="in">den &lt;- dnorm(grant_data$grant,</span></span>
<span id="cb23-364"><a href="#cb23-364" aria-hidden="true" tabindex="-1"></a><span class="in">             predict(model_den),</span></span>
<span id="cb23-365"><a href="#cb23-365" aria-hidden="true" tabindex="-1"></a><span class="in">             sd(model_den$residuals))</span></span>
<span id="cb23-366"><a href="#cb23-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-367"><a href="#cb23-367" aria-hidden="true" tabindex="-1"></a><span class="in"># Finally, we make actual IPW weights by building the fraction</span></span>
<span id="cb23-368"><a href="#cb23-368" aria-hidden="true" tabindex="-1"></a><span class="in">grant_data_ipw &lt;- grant_data %&gt;% </span></span>
<span id="cb23-369"><a href="#cb23-369" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(ipw = num / den)</span></span>
<span id="cb23-370"><a href="#cb23-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-371"><a href="#cb23-371" aria-hidden="true" tabindex="-1"></a><span class="in">head(grant_data_ipw)</span></span>
<span id="cb23-372"><a href="#cb23-372" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-373"><a href="#cb23-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-374"><a href="#cb23-374" aria-hidden="true" tabindex="-1"></a>Now we can use the weights to find the ATE just like we did with the binary treatment:</span>
<span id="cb23-375"><a href="#cb23-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-376"><a href="#cb23-376" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-grant-ipw}</span></span>
<span id="cb23-377"><a href="#cb23-377" aria-hidden="true" tabindex="-1"></a><span class="in">model_grant_ipw &lt;- lm(malaria_risk ~ grant, data = grant_data_ipw, weights = ipw)</span></span>
<span id="cb23-378"><a href="#cb23-378" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_grant_ipw)</span></span>
<span id="cb23-379"><a href="#cb23-379" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-380"><a href="#cb23-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-381"><a href="#cb23-381" aria-hidden="true" tabindex="-1"></a>Each dollar of grant money thus **causes a drop of -1.1 malaria risk points**. Neato!</span>
<span id="cb23-382"><a href="#cb23-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-383"><a href="#cb23-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-384"><a href="#cb23-384" aria-hidden="true" tabindex="-1"></a><span class="fu">### IPW with the **ipw** package, continuous treatment</span></span>
<span id="cb23-385"><a href="#cb23-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-386"><a href="#cb23-386" aria-hidden="true" tabindex="-1"></a>Manually creating the numerator and denominator can get tedious though. We can use the <span class="in">`ipwpoint()`</span> function from **ipw** to generate continuous weights in one step. Instead of specifying a binomial treatment like we did before, we'll use a Gaussian (normal) family. We also specify both the numerator and denominator. It will generate identical weights.</span>
<span id="cb23-387"><a href="#cb23-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-388"><a href="#cb23-388" aria-hidden="true" tabindex="-1"></a><span class="in">```{r weights-continuous-ipwpoint}</span></span>
<span id="cb23-389"><a href="#cb23-389" aria-hidden="true" tabindex="-1"></a><span class="in">weights_continuous_ipwpoint &lt;- ipwpoint(</span></span>
<span id="cb23-390"><a href="#cb23-390" aria-hidden="true" tabindex="-1"></a><span class="in">  exposure = grant,</span></span>
<span id="cb23-391"><a href="#cb23-391" aria-hidden="true" tabindex="-1"></a><span class="in">  family = "gaussian",</span></span>
<span id="cb23-392"><a href="#cb23-392" aria-hidden="true" tabindex="-1"></a><span class="in">  numerator = ~ 1,</span></span>
<span id="cb23-393"><a href="#cb23-393" aria-hidden="true" tabindex="-1"></a><span class="in">  denominator = ~ health + income,</span></span>
<span id="cb23-394"><a href="#cb23-394" aria-hidden="true" tabindex="-1"></a><span class="in">  data = as.data.frame(grant_data)</span></span>
<span id="cb23-395"><a href="#cb23-395" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb23-396"><a href="#cb23-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-397"><a href="#cb23-397" aria-hidden="true" tabindex="-1"></a><span class="in"># Same values!</span></span>
<span id="cb23-398"><a href="#cb23-398" aria-hidden="true" tabindex="-1"></a><span class="in">head(grant_data_ipw$ipw)</span></span>
<span id="cb23-399"><a href="#cb23-399" aria-hidden="true" tabindex="-1"></a><span class="in">head(weights_continuous_ipwpoint$ipw.weights)</span></span>
<span id="cb23-400"><a href="#cb23-400" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-401"><a href="#cb23-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-402"><a href="#cb23-402" aria-hidden="true" tabindex="-1"></a>We can then put those weights into the dataset and run a model with them. We get the same ATE of -1.1:</span>
<span id="cb23-403"><a href="#cb23-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-404"><a href="#cb23-404" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-weights-continuous-ipwpoint}</span></span>
<span id="cb23-405"><a href="#cb23-405" aria-hidden="true" tabindex="-1"></a><span class="in">grant_data_ipwpoint &lt;- grant_data %&gt;% </span></span>
<span id="cb23-406"><a href="#cb23-406" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(ipw = weights_continuous_ipwpoint$ipw.weights)</span></span>
<span id="cb23-407"><a href="#cb23-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-408"><a href="#cb23-408" aria-hidden="true" tabindex="-1"></a><span class="in">model_grant_ipwpoint &lt;- lm(malaria_risk ~ grant, </span></span>
<span id="cb23-409"><a href="#cb23-409" aria-hidden="true" tabindex="-1"></a><span class="in">                           data = grant_data_ipwpoint, weights = ipw)</span></span>
<span id="cb23-410"><a href="#cb23-410" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_grant_ipwpoint)</span></span>
<span id="cb23-411"><a href="#cb23-411" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-412"><a href="#cb23-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-413"><a href="#cb23-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-414"><a href="#cb23-414" aria-hidden="true" tabindex="-1"></a><span class="fu">### IPW with the **WeightIt** package, continuous treatment</span></span>
<span id="cb23-415"><a href="#cb23-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-416"><a href="#cb23-416" aria-hidden="true" tabindex="-1"></a>The **WeightIt** package also handles continuous weights. The syntax is a lot simpler—there's no need to worry about numerators and denominators.</span>
<span id="cb23-417"><a href="#cb23-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-418"><a href="#cb23-418" aria-hidden="true" tabindex="-1"></a><span class="in">```{r weights-continuous-weightit}</span></span>
<span id="cb23-419"><a href="#cb23-419" aria-hidden="true" tabindex="-1"></a><span class="in">weights_weightit &lt;- weightit(grant ~ income + health,  # Model grant amount with confounders</span></span>
<span id="cb23-420"><a href="#cb23-420" aria-hidden="true" tabindex="-1"></a><span class="in">                             data = grant_data, </span></span>
<span id="cb23-421"><a href="#cb23-421" aria-hidden="true" tabindex="-1"></a><span class="in">                             stabilize = TRUE)</span></span>
<span id="cb23-422"><a href="#cb23-422" aria-hidden="true" tabindex="-1"></a><span class="in">weights_weightit</span></span>
<span id="cb23-423"><a href="#cb23-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-424"><a href="#cb23-424" aria-hidden="true" tabindex="-1"></a><span class="in"># See even more details here</span></span>
<span id="cb23-425"><a href="#cb23-425" aria-hidden="true" tabindex="-1"></a><span class="in"># summary(weights_weightit)</span></span>
<span id="cb23-426"><a href="#cb23-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-427"><a href="#cb23-427" aria-hidden="true" tabindex="-1"></a><span class="in"># Not the same as the other methods :(</span></span>
<span id="cb23-428"><a href="#cb23-428" aria-hidden="true" tabindex="-1"></a><span class="in">head(weights_weightit$weights)</span></span>
<span id="cb23-429"><a href="#cb23-429" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-430"><a href="#cb23-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-431"><a href="#cb23-431" aria-hidden="true" tabindex="-1"></a>However(!), for mathy reasons I don't understand, the weights it generates are not the same as what we get when doing it by hand or with <span class="in">`ipwpoint()`</span>. In fact, they're almost exactly twice as large as the manual and <span class="in">`ipwpoint()`</span> weights:</span>
<span id="cb23-432"><a href="#cb23-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-435"><a href="#cb23-435" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-436"><a href="#cb23-436" aria-hidden="true" tabindex="-1"></a><span class="co"># Manual weights</span></span>
<span id="cb23-437"><a href="#cb23-437" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(grant_data_ipw<span class="sc">$</span>ipw)</span>
<span id="cb23-438"><a href="#cb23-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-439"><a href="#cb23-439" aria-hidden="true" tabindex="-1"></a><span class="co"># weightit() weights / 2</span></span>
<span id="cb23-440"><a href="#cb23-440" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(weights_weightit<span class="sc">$</span>weights) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb23-441"><a href="#cb23-441" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-442"><a href="#cb23-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-443"><a href="#cb23-443" aria-hidden="true" tabindex="-1"></a>Surely there's an argument to <span class="in">`weightit()`</span> that I'm missing somewhere.</span>
<span id="cb23-444"><a href="#cb23-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-445"><a href="#cb23-445" aria-hidden="true" tabindex="-1"></a>Regardless, for more mathy reasons I don't understand, the ATE is identical even though the weights are roughly doubled:</span>
<span id="cb23-446"><a href="#cb23-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-447"><a href="#cb23-447" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model-weights-continuous-weightit}</span></span>
<span id="cb23-448"><a href="#cb23-448" aria-hidden="true" tabindex="-1"></a><span class="in">grant_data_weightit &lt;- grant_data %&gt;% </span></span>
<span id="cb23-449"><a href="#cb23-449" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(ipw = weights_weightit$weights)</span></span>
<span id="cb23-450"><a href="#cb23-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-451"><a href="#cb23-451" aria-hidden="true" tabindex="-1"></a><span class="in">model_grant_weightit &lt;- lm(malaria_risk ~ grant, </span></span>
<span id="cb23-452"><a href="#cb23-452" aria-hidden="true" tabindex="-1"></a><span class="in">                           data = grant_data_weightit, weights = ipw)</span></span>
<span id="cb23-453"><a href="#cb23-453" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(model_grant_weightit)</span></span>
<span id="cb23-454"><a href="#cb23-454" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-455"><a href="#cb23-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-456"><a href="#cb23-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-457"><a href="#cb23-457" aria-hidden="true" tabindex="-1"></a><span class="fu">## References</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p><span class="faux-block">Forked from <a href="https://www.andrewheiss.com/">Andrew Heiss</a></span> # <span class="faux-block"><a href="https://github.com/andrewheiss/ath-quarto">View the source at <i class="fa-brands fa-github" aria-label="github"></i> GitHub</a></span></p>
</div>
  </div>
</footer>


</body></html>