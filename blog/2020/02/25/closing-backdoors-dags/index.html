<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Andrew Heiss">
<meta name="description" content="Use regression, inverse probability weighting, and matching to close confounding backdoors and find causation in observational data">

<title>Ways to close backdoors in DAGs | Andrew Heiss – Andrew Heiss</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../../../">
<link href="../../../../..//files/favicon-512.png" rel="icon" type="image/png">
<script src="../../../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../../../site_libs/quarto-html/quarto-syntax-highlighting-17c909d5fd25ae21b861c0c7a49b2096.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../../../site_libs/bootstrap/bootstrap-5cd0811f461c8271ae6bab49df9501be.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<link href="../../../../../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../../../../../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<script src="../../../../../site_libs/quarto-contrib/iconify-2.0.0/iconify-icon.min.js"></script>
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

<script type="text/javascript">

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-527449-5', 'auto');

ga('send', {
  hitType: 'pageview',
  'anonymizeIp': true,
});
</script>
<style>

      .quarto-title-block .quarto-title-banner {
        background: #170C3A;
      }
</style>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<meta property="og:title" content="Ways to close backdoors in DAGs | Andrew Heiss">
<meta property="og:description" content="Use regression, inverse probability weighting, and matching to close confounding backdoors and find causation in observational data">
<meta property="og:image" content="https://www.andrewheiss.com/blog/2020/02/25/closing-backdoors-dags/load-libraries-make-dag-1.png">
<meta property="og:site_name" content="Andrew Heiss">
<meta property="og:locale" content="en_US">
<meta property="og:image:height" content="816">
<meta property="og:image:width" content="1344">
<meta name="twitter:title" content="Ways to close backdoors in DAGs | Andrew Heiss">
<meta name="twitter:description" content="Use regression, inverse probability weighting, and matching to close confounding backdoors and find causation in observational data">
<meta name="twitter:image" content="https://www.andrewheiss.com/blog/2020/02/25/closing-backdoors-dags/load-libraries-make-dag-1.png">
<meta name="twitter:creator" content="@andrewheiss">
<meta name="twitter:site" content="@andrewheiss">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image-height" content="816">
<meta name="twitter:image-width" content="1344">
</head>

<body class="floating nav-fixed slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../../../index.html">
    <span class="navbar-title">Andrew Heiss</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../../../index.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../cv/index.html"> 
<span class="menu-text">CV</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../blog/index.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../research/index.html"> 
<span class="menu-text">Research</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../teaching/index.html"> 
<span class="menu-text">Teaching</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../talks/index.html"> 
<span class="menu-text">Talks</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../now/index.html"> 
<span class="menu-text">Now</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../uses/index.html"> 
<span class="menu-text">Uses</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../../../atom.xml"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:rss" style="font-size: 1.1em;" aria-label="Icon rss from bi Iconify.design set." title="RSS"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="mailto:aheiss@gsu.edu"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:envelope" style="font-size: 1.1em;" aria-label="Icon envelope from bi Iconify.design set." title="E-mail"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://bsky.app/profile/andrew.heiss.phd" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="fa6-brands:bluesky" style="font-size: 1.1em;" aria-label="Icon bluesky from fa6-brands Iconify.design set." title="Bluesky"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://fediscience.org/users/andrew/" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:mastodon" style="font-size: 1.1em;" aria-label="Icon mastodon from bi Iconify.design set." title="Mastodon"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/andrewheiss" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:github" style="font-size: 1.1em;" aria-label="Icon github from bi Iconify.design set." title="GitHub"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.youtube.com/andrewheiss" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:youtube" style="font-size: 1.1em;" aria-label="Icon youtube from bi Iconify.design set." title="YouTube"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.heissatopia.com/"> 
<span class="menu-text"><iconify-icon inline="" icon="fa6-brands:blogger" style="font-size: 1.15em;" aria-label="Icon blogger from fa6-brands Iconify.design set." title="Blogger"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.linkedin.com/in/andrewheiss" rel="me"> 
<span class="menu-text"><iconify-icon inline="" icon="bi:linkedin" style="font-size: 1.1em;" aria-label="Icon linkedin from bi Iconify.design set." title="LinkedIn"></iconify-icon></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default blog-post page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">Ways to close backdoors in DAGs</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
                  <div>
        <div class="description">
          Use regression, inverse probability weighting, and matching to close confounding backdoors and find causation in observational data
        </div>
      </div>
                </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p><a href="https://www.andrewheiss.com/">Andrew Heiss</a> <a href="https://orcid.org/0000-0002-3948-3914" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">Tuesday, February 25, 2020</p>
      </div>
    </div>
    
      
      <div>
      <div class="quarto-title-meta-heading">Doi</div>
      <div class="quarto-title-meta-contents">
        <p class="doi">
          <a href="https://doi.org/10.59350/z5y4e-jgk85">10.59350/z5y4e-jgk85</a>
        </p>
      </div>
    </div>
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Contents</h2>
   
  <ul>
  <li><a href="#example-program" id="toc-example-program" class="nav-link active" data-scroll-target="#example-program">Example program</a></li>
  <li><a href="#simulated-data" id="toc-simulated-data" class="nav-link" data-scroll-target="#simulated-data">Simulated data</a></li>
  <li><a href="#incorrect-correlation-is-not-causation-estimate" id="toc-incorrect-correlation-is-not-causation-estimate" class="nav-link" data-scroll-target="#incorrect-correlation-is-not-causation-estimate">Incorrect “correlation is not causation” estimate</a></li>
  <li><a href="#adjustment-using-forbidden-unmeasured-variable" id="toc-adjustment-using-forbidden-unmeasured-variable" class="nav-link" data-scroll-target="#adjustment-using-forbidden-unmeasured-variable">Adjustment using forbidden unmeasured variable</a></li>
  <li><a href="#adjustment-using-educated-guess-based-naive-matching" id="toc-adjustment-using-educated-guess-based-naive-matching" class="nav-link" data-scroll-target="#adjustment-using-educated-guess-based-naive-matching">Adjustment using educated-guess-based naive matching</a></li>
  <li><a href="#brief-interlude-matching-slightly-simpler-dag" id="toc-brief-interlude-matching-slightly-simpler-dag" class="nav-link" data-scroll-target="#brief-interlude-matching-slightly-simpler-dag">Brief interlude: Matching + slightly simpler DAG</a></li>
  <li><a href="#adjustment-using-inverse-probability-weighting-ipw" id="toc-adjustment-using-inverse-probability-weighting-ipw" class="nav-link" data-scroll-target="#adjustment-using-inverse-probability-weighting-ipw">Adjustment using inverse probability weighting (IPW)</a></li>
  <li><a href="#adjustment-using-matching-with-mahalanobis-distance" id="toc-adjustment-using-matching-with-mahalanobis-distance" class="nav-link" data-scroll-target="#adjustment-using-matching-with-mahalanobis-distance">Adjustment using matching (with Mahalanobis distance)</a></li>
  <li><a href="#someday-when-im-smarter-do-calculus" id="toc-someday-when-im-smarter-do-calculus" class="nav-link" data-scroll-target="#someday-when-im-smarter-do-calculus">Someday when I’m smarter: <em>do</em>-calculus</a></li>
  <li><a href="#comparison-of-all-methods" id="toc-comparison-of-all-methods" class="nav-link" data-scroll-target="#comparison-of-all-methods">Comparison of all methods</a></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">





<p><span class="small">(<a href="https://github.com/andrewheiss/closing-backdoors-dags">See this notebook on GitHub</a>)</span></p>
<hr>
<p>I’ve been teaching <a href="https://evalsp20.classes.andrewheiss.com/">program evaluation</a> in the MPA/MPP program at GSU for the past semester and a half, and since I was given free rein over how to teach it, I decided to make it as modern and cutting edge as possible. To do this, I’ve infused the class with modern causal inference techniques (commonly known as the <a href="https://bigthink.com/errors-we-live-by/judea-pearls-the-book-of-why-brings-news-of-a-new-science-of-causes">“causal revolution”</a>), focused on the language of <a href="https://cran.r-project.org/web/packages/ggdag/vignettes/intro-to-dags.html">directed acyclic graphs (DAGs)</a>, <a href="https://www.inference.vc/untitled/">do-calculus</a>, confounding, colliding, and the rest of Judea Pearl’s world of finding causation in observational data.</p>
<p>However, I was never taught this approach in any of my doctoral classes, and I’m entirely self-taught. I read <a href="https://www.amazon.com/Book-Why-Science-Cause-Effect/dp/046509760X/"><em>The Book of Why</em></a> in March 2019, and I’ve thrown myself into every possible journal article, blog post, and online course I’ve come across in order to understand how to isolate and identify causal effects. It’s been hard, but thanks to an incredibly welcoming community of economists, epidemiologists, and political scientists on Twitter, I’m getting it! (And so are my students!)</p>
<p>The purpose of this post isn’t to introduce causal models and DAGs and confounders vs.&nbsp;colliders and all that. For that kind of introduction, consult any (or all!) of these resources:</p>
<ul>
<li>Nick Huntington-Klein’s <a href="http://www.nickchk.com/econ305.html">ECON 305: Economics, Causality, and Analytics course</a> (especially lectures 13–18)</li>
<li>Julia M. Rohrer, “Thinking Clearly About Correlations and Causation: Graphical Causal Models for Observational Data,” Advances in Methods and Practices in <em>Psychological Science</em> 1, no. 1 (March 2018): 27–42, doi: <a href="https://doi.org/10.1177/2515245917745629">10.1177/2515245917745629</a></li>
<li>Miguel A. Hernán and James M. Robbins, <em>Causal Inference: What If</em> (CRC Press, 2020), <a href="https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/" class="uri">https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/</a></li>
<li>Paul Hünermund and Elias Bareinboim, “Causal Inference and Data-Fusion in Econometrics,” December 19, 2019, arXiv: 1912.09104 [econ.EM], <a href="https://arxiv.org/abs/1912.09104" class="uri">https://arxiv.org/abs/1912.09104</a></li>
<li>Felix Elwert, “Graphical Causal Models,” chap.&nbsp;13 in <em>Handbook of Causal Analysis for Social Research</em>, ed.&nbsp;Stephen L. Morgan (New York: Springer, 2013), 245–273, doi: <a href="https://doi.org/10.1007/978-94-007-6094-3_13">10.1007/978-94-007-6094-3_13</a></li>
<li>Julian Schuessler and Peter Selb, “Graphical Causal Models for Survey Inference” (December 17, 2019), doi: <a href="https://doi.org/10.31235/osf.io/hbg3m">10.31235/osf.io/hbg3m</a>, <a href="https://osf.io/preprints/socarxiv/hbg3m/" class="uri">https://osf.io/preprints/socarxiv/hbg3m/</a></li>
<li>Scott Cunningham, “Directed acyclical graphs” in <em>Causal Inference: The Mixtape</em> (2018), <a href="https://www.scunning.com/mixtape.html" class="uri">https://www.scunning.com/mixtape.html</a></li>
<li>Paul Hünermund, “Causal Inference with Directed Acyclic Graphs,” <a href="https://www.udemy.com/course/causal-data-science/?referralCode=4FB57D92601437BEB794">Udemy</a></li>
<li>Jason A. Roy, “A Crash Course in Causality: Inferring Causal Effects from Observational Data,” <a href="https://www.coursera.org/learn/crash-course-in-causality/home/welcome">Coursera</a></li>
</ul>
<p>Instead, this post is a practical example of how exactly you can isolate causal effects by closing backdoor paths and adjusting for confounders in observational data. At its core, DAG-based causal inference involves isolating relationships—if some variable causes both your treatment and your outcome (thus confounding it), you can deal with that common cause in some statistical way and isolate the treatment–outcome effect. There’s no one right way to statistically deal with confounding, so here I show a few different ways to do it.</p>
<p>To make this more concrete and practical, I use simulated data from a hypothetical program, but I use actual variable names rather than the <span class="math inline">\(x\)</span>, <span class="math inline">\(y\)</span>, and <span class="math inline">\(z\)</span> variables that are common in tutorials and articles about DAGs. Here, our outcome <span class="math inline">\(y\)</span> is a final grade, <span class="math inline">\(x\)</span> is a special math camp, and <span class="math inline">\(z\)</span> is all the possible confounders of the effect of the math camp on the grade.</p>
<p>Like <a href="https://www.andrewheiss.com/blog/2019/01/29/diff-means-half-dozen-ways/">my post showing a bunch of different ways to test differences in means</a>, this is mostly a resource to my students and to future me. <a href="https://github.com/andrewheiss/closing-backdoors-dags/issues">Please feel free to comment and make corrections or additions at GitHub!</a></p>
<p>Here’s a tl;dr table of contents since this is a little long:</p>
<ul>
<li><a href="#example-program">Example program</a></li>
<li><a href="#simulated-data">Simulated data</a></li>
<li><a href="#incorrect-correlation-is-not-causation-estimate">Incorrect “correlation is not causation” estimate</a></li>
<li><a href="#adjustment-using-forbidden-unmeasured-variable">Adjustment using forbidden unmeasured variable</a></li>
<li><a href="#adjustment-using-educated-guess-based-naive-matching">Adjustment using educated-guess-based naive matching</a></li>
<li><a href="#brief-interlude-matching--slightly-simpler-dag">Brief interlude: Matching + slightly simpler DAG</a></li>
<li><a href="#adjustment-using-inverse-probability-weighting-ipw">Adjustment using inverse probability weighting (IPW)</a></li>
<li><a href="#adjustment-using-matching-with-mahalanobis-distance">Adjustment using matching (with Mahalanobis distance)</a></li>
<li><a href="#someday-when-im-smarter-do-calculus">Someday when I’m smarter: <em>do</em>-calculus</a></li>
<li><a href="#comparison-of-all-methods">Comparison of all methods</a></li>
</ul>
<section id="example-program" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="example-program">Example program</h2>
<p>We’ll refer to a hypothetical math camp program throughout all these examples. Many policy schools offer a brief math camp in the weeks before students begin their graduate degrees, with the hope that it will help students be more prepared in math-heavy classes like statistics and microeconomics. For these examples, we’re interested in answering one question: what is the causal effect of attending math camp on final student outcomes?</p>
<p>We can use <a href="https://cran.r-project.org/web/packages/ggdag/vignettes/intro-to-ggdag.html"><strong>ggdag</strong></a> to draw a simplified causal model that explains what causes final student outcomes (it’s probably wrong, but whatever). I added all the fancy bells and whistles to the graph object here just for the sake of reference. In reality, you don’t need labels or coordinates or the individual <code>geom_dag_*()</code> layers and you can just do <code>ggdag(math_camp_dag)</code> to get a basic graph, but for fun I’ve included everything you need for a publication-worthy graph.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)  <span class="co"># ggplot, dplyr, %&gt;%, and friends</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggdag)  <span class="co"># Make DAGs with ggplot</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dagitty)  <span class="co"># Do basic DAG math</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom)  <span class="co"># For converting model output to data frames</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>node_details <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>name, <span class="sc">~</span>label, <span class="sc">~</span>x, <span class="sc">~</span>y,</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"math_camp"</span>, <span class="st">"Math camp"</span>, <span class="dv">2</span>, <span class="dv">1</span>,</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"final_grade"</span>, <span class="st">"Final grade"</span>, <span class="dv">4</span>, <span class="dv">1</span>,</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"needs_camp"</span>, <span class="st">"Needs camp"</span>, <span class="dv">1</span>, <span class="dv">2</span>,</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"gre_quant"</span>, <span class="st">"GRE quantitative"</span>, <span class="fl">2.5</span>, <span class="dv">2</span>,</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"gre_verbal"</span>, <span class="st">"GRE verbal"</span>, <span class="dv">5</span>, <span class="dv">2</span>,</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">"background"</span>, <span class="st">"Background"</span>, <span class="dv">2</span>, <span class="dv">3</span>,</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">"undergraduate_gpa"</span>, <span class="st">"Undergraduate GPA"</span>, <span class="dv">4</span>, <span class="dv">3</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>node_labels <span class="ot">&lt;-</span> node_details<span class="sc">$</span>label</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(node_labels) <span class="ot">&lt;-</span> node_details<span class="sc">$</span>name</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>math_camp_dag <span class="ot">&lt;-</span> <span class="fu">dagify</span>(final_grade <span class="sc">~</span> math_camp <span class="sc">+</span> gre_quant <span class="sc">+</span> gre_verbal <span class="sc">+</span> </span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>                          undergraduate_gpa <span class="sc">+</span> background,</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>                        math_camp <span class="sc">~</span> needs_camp, </span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>                        needs_camp <span class="sc">~</span> background <span class="sc">+</span> undergraduate_gpa <span class="sc">+</span> gre_quant,</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>                        gre_quant <span class="sc">~</span> background <span class="sc">+</span> undergraduate_gpa,</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>                        gre_verbal <span class="sc">~</span> background <span class="sc">+</span> undergraduate_gpa,</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>                        undergraduate_gpa <span class="sc">~</span> background,</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>                        <span class="at">exposure =</span> <span class="st">"math_camp"</span>,</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>                        <span class="at">outcome =</span> <span class="st">"final_grade"</span>,</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>                        <span class="at">latent =</span> <span class="st">"background"</span>,</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>                        <span class="at">coords =</span> node_details,</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>                        <span class="at">labels =</span> node_labels)</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Turn DAG into a tidy data frame for plotting</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>math_camp_dag_tidy <span class="ot">&lt;-</span> math_camp_dag <span class="sc">%&gt;%</span> </span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tidy_dagitty</span>() <span class="sc">%&gt;%</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">node_status</span>()   <span class="co"># Add column for exposure/outcome/latent</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>status_colors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">exposure =</span> <span class="st">"#0074D9"</span>, <span class="at">outcome =</span> <span class="st">"#FF4136"</span>, <span class="at">latent =</span> <span class="st">"grey50"</span>)</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Fancier graph</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(math_camp_dag_tidy, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">xend =</span> xend, <span class="at">yend =</span> yend)) <span class="sc">+</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_dag_edges</span>() <span class="sc">+</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_dag_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> status)) <span class="sc">+</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_dag_label_repel</span>(<span class="fu">aes</span>(<span class="at">label =</span> label, <span class="at">fill =</span> status), <span class="at">seed =</span> <span class="dv">1234</span>,</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>                       <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> status_colors, <span class="at">na.value =</span> <span class="st">"grey20"</span>) <span class="sc">+</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> status_colors, <span class="at">na.value =</span> <span class="st">"grey20"</span>) <span class="sc">+</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="cn">FALSE</span>, <span class="at">fill =</span> <span class="cn">FALSE</span>) <span class="sc">+</span> </span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_dag</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="load-libraries-make-dag-1.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">DAG for math camp example</figcaption>
</figure>
</div>
<p>We can tell a fairly complex story using this graph. Your final grade in the program is caused by a host of things, including your quantitative and verbal GRE scores (<a href="https://www.sciencemag.org/careers/2017/06/gres-dont-predict-grad-school-success-what-does">PROBABLY DEFINITELY NOT in real life</a>, but go with it), your undergraduate GPA, and your unmeasured background factors (age, parental income, math anxiety, level of interest in the program, etc.). Your undergraduate GPA is determined by your background, and your GRE scores are determined by both your undergraduate GPA and your background. Because this math camp program is open to anyone, there is self-selection in who chooses to do it. We can pretend that this is decided by your undergraduate GPA, your quantitative GRE score, and your background. If the program was need-based and only offered to people with low GRE scores, we could draw an arrow from GRE quantitative to math camp, but we don’t. Finally, needing the math camp causes people to do it.</p>
<p>There is a direct path between our treatment and outcome (math camp → final grade), but there is also some possible backdoor confounding. Both GRE quantitative and undergraduate GPA have arrows pointing to final grade and math camp (through “needs camp”), which means they’re a common cause, and background is both a confounder <em>and</em> unmeasurable. But we don’t need to give up! If we adjust or control for “needs camp,” we can block the association between background, GRE quantitative, and undergraduate GPA. With this backdoor closed, we’ve isolated the math camp → final grade relationship and can find the causal effect.</p>
<p>However, we don’t really have a measure for needing math camp—we can’t read peoples’ minds and see if they need the program—so while it’d be great to just include a <code>needs_camp</code> variable in a regression model, we’ll have to use other techniques to close the backdoor.</p>
<p>You can find the backdoors automatically with Dagitty (draw the DAG there and notice red arrows between the unblocked confounders), or with functions in the <a href="https://cran.r-project.org/package=dagitty"><strong>dagitty</strong> R package</a>. If you run <code>paths(math_camp_dag)</code>, you can see that the only node pointing back into <code>math_camp</code> is <code>needs_camp</code>, and if you run <code>adjustmentSets(math_camp_dag)</code>, you’ll see that <code>needs_camp</code> is the only required adjustment set:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">paths</span>(math_camp_dag)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="do">## $paths</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="do">##  [1] "math_camp -&gt; final_grade"</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="do">##  [2] "math_camp &lt;- needs_camp &lt;- background -&gt; final_grade"</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="do">##  [3] "math_camp &lt;- needs_camp &lt;- background -&gt; gre_quant -&gt; final_grade"</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="do">##  [4] "math_camp &lt;- needs_camp &lt;- background -&gt; gre_quant &lt;- undergraduate_gpa -&gt; final_grade"</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="do">##  [5] "math_camp &lt;- needs_camp &lt;- background -&gt; gre_quant &lt;- undergraduate_gpa -&gt; gre_verbal -&gt; final_grade"</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="do">##  [6] "math_camp &lt;- needs_camp &lt;- background -&gt; gre_verbal -&gt; final_grade"</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="do">##  ...</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="do">##</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="do">## $open</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="do">##  [1]  TRUE  TRUE  TRUE FALSE FALSE  TRUE FALSE FALSE  TRUE  TRUE  TRUE</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="do">## [12]  TRUE  TRUE  TRUE FALSE  TRUE  TRUE  TRUE  TRUE FALSE  TRUE  TRUE</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="do">## [23]  TRUE  TRUE FALSE FALSE  TRUE FALSE FALSE  TRUE  TRUE  TRUE</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="fu">adjustmentSets</span>(math_camp_dag)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="do">##  { needs_camp }</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="simulated-data" class="level2">
<h2 class="anchored" data-anchor-id="simulated-data">Simulated data</h2>
<p>Assuming this causal graph is correct (it’s probably not, but again, go with it), we can simulate data that reflects these causal relationships. There are a host of R packages for simulating data (like <a href="https://github.com/trinker/wakefield"><strong>wakefield</strong></a>, <a href="https://www.rdatagen.net/page/simstudy/"><strong>simstudy</strong></a>, and <a href="https://declaredesign.org/r/fabricatr/"><strong>fabricatr</strong></a>), but here I do it a little more manually using <code>MASS::mvrnorm()</code> to use a <a href="https://stats.stackexchange.com/a/164476/3025">multivariate normal distribution to generate continuous variables that have a specific mean, standard deviation, and relationship with other variables</a>.</p>
<p>Because data generation is beyond the scope of this post, the code below is heavily annotated. Importantly, the various <code>mutate()</code> commands that create the <code>math_camp</code> data below create relationships between the confounders, treatment, and outcome. We also create a <code>needs_camp</code> variable that is true if <strong>both</strong> a student’s quantitative GRE score is less than the average <em>and</em> if their undergraduate GPA is less than the average. We also build in some noncompliance: 80% of those who need math camp do it; 20% of those who don’t need it do it.</p>
<p>For the sake of simplicity, the outcome here (<code>final_grade</code>) isn’t GPA or anything—it’s an arbitrary number between 120 and 160 (though we could rescale it to something else).</p>
<p><strong>Most importantly</strong>, we force the math camp program to cause a <strong>10 point increase</strong> in students’ final grades. This is our baseline average treatment effect that we want to be able to find using different backdoor adjustment techniques.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make these random draws the same every time</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create 2,000 rows</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>num <span class="ot">&lt;-</span> <span class="dv">2000</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create confounder variables that are related to each other</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">undergrad_gpa =</span> <span class="dv">3</span>, <span class="at">gre_verbal =</span> <span class="dv">160</span>, <span class="at">gre_quant =</span> <span class="dv">145</span>)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>stddev <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">undergrad_gpa =</span> <span class="fl">0.5</span>, <span class="at">gre_verbal =</span> <span class="dv">10</span>, <span class="at">gre_quant =</span> <span class="dv">5</span>)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Correlation matrix: undergrad GPA and verbal GRE have a correlation of 0.8;</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="co"># undergrad GPA and quantitative GRE have a correlation of 0.6, and verbal GRE</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co"># and quantitative GRE have a correlation of 0.4</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>cor_matrix <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="fl">1.0</span>, <span class="fl">0.8</span>, <span class="fl">0.6</span>,</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>                       <span class="fl">0.8</span>, <span class="fl">1.0</span>, <span class="fl">0.4</span>,</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>                       <span class="fl">0.6</span>, <span class="fl">0.4</span>, <span class="fl">1.0</span>),</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>                     <span class="at">ncol =</span> <span class="dv">3</span>)</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert correlation matrix to covariance matrix using fancy math</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>cov_matrix <span class="ot">&lt;-</span> stddev <span class="sc">%*%</span> <span class="fu">t</span>(stddev) <span class="sc">*</span> cor_matrix</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Draw random numbers</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>confounders <span class="ot">&lt;-</span> MASS<span class="sc">::</span><span class="fu">mvrnorm</span>(<span class="at">n =</span> num, <span class="at">mu =</span> mu, <span class="at">Sigma =</span> cov_matrix, <span class="at">empirical =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Truncate values so they're within 130-170 range for GRE and less than 4.0 for GPA</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_at</span>(<span class="fu">vars</span>(gre_verbal, gre_quant),</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>            <span class="sc">~</span><span class="fu">case_when</span>(</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>              . <span class="sc">&gt;</span> <span class="dv">170</span> <span class="sc">~</span> <span class="dv">170</span>,</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>              . <span class="sc">&lt;</span> <span class="dv">130</span> <span class="sc">~</span> <span class="dv">130</span>,</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>              <span class="cn">TRUE</span> <span class="sc">~</span> .</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>            )) <span class="sc">%&gt;%</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">undergrad_gpa =</span> <span class="fu">ifelse</span>(undergrad_gpa <span class="sc">&gt;</span> <span class="dv">4</span>, <span class="dv">4</span>, undergrad_gpa))</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Make official dataset of simulated values</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>math_camp <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span>num) <span class="sc">%&gt;%</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(confounders) <span class="sc">%&gt;%</span>  <span class="co"># Bring in confounders</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># People need math camp if their GRE and GPA is lower than the average</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">needs_camp =</span> gre_quant <span class="sc">&lt;</span> <span class="fu">mean</span>(gre_quant) <span class="sc">&amp;</span> </span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>           undergrad_gpa <span class="sc">&lt;</span> <span class="fu">mean</span>(undergrad_gpa)) <span class="sc">%&gt;%</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Build in some noncompliance: 80% of those who need math camp do it; 20% of</span></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># those who don't need it do it.</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">math_camp =</span> <span class="fu">case_when</span>(</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>    needs_camp <span class="sc">==</span> <span class="cn">TRUE</span> <span class="sc">~</span> <span class="fu">rbinom</span>(<span class="fu">n</span>(), <span class="dv">1</span>, <span class="fl">0.8</span>),</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>    needs_camp <span class="sc">==</span> <span class="cn">FALSE</span> <span class="sc">~</span> <span class="fu">rbinom</span>(<span class="fu">n</span>(), <span class="dv">1</span>, <span class="fl">0.2</span>)</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create random error in grades</span></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">grade_noise =</span> <span class="fu">rnorm</span>(num, <span class="dv">15</span>, <span class="dv">5</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create final grade based on all the arrows going into the node in the DAG.</span></span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>  <span class="co"># There's a 10 point causal effect</span></span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">final_grade =</span> (<span class="fl">0.3</span> <span class="sc">*</span> gre_verbal) <span class="sc">+</span> (<span class="fl">0.5</span> <span class="sc">*</span> gre_quant) <span class="sc">+</span> </span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>           (<span class="fl">0.4</span> <span class="sc">*</span> undergrad_gpa) <span class="sc">+</span> (<span class="dv">10</span> <span class="sc">*</span> math_camp) <span class="sc">+</span> grade_noise) <span class="sc">%&gt;%</span></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">math_camp =</span> <span class="fu">as.logical</span>(math_camp))  <span class="co"># Make true/false</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Phew. That’s a lot of code to make fake data, but it worked! We can look at the first few rows:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(math_camp)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 6 x 8</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="do">##      id undergrad_gpa gre_verbal gre_quant needs_camp math_camp grade_noise</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="do">##   &lt;int&gt;         &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt; &lt;lgl&gt;      &lt;lgl&gt;           &lt;dbl&gt;</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="do">## 1     1          3.90       170       151. FALSE      FALSE            13.5</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="do">## 2     2          3.20       163.      143. FALSE      FALSE            13.2</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="do">## 3     3          2.83       162.      140. TRUE       TRUE             10.4</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="do">## 4     4          2.63       144.      154. FALSE      FALSE            17.0</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="do">## 5     5          3.24       170       148. FALSE      FALSE            16.4</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="do">## 6     6          2.95       167.      146. FALSE      FALSE            19.0</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="do">## # … with 1 more variable: final_grade &lt;dbl&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>About 40% of the students participated in math camp:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>math_camp <span class="sc">%&gt;%</span> </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(math_camp) <span class="sc">%&gt;%</span> </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prop =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n))</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 2 x 3</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="do">##   math_camp     n  prop</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="do">##   &lt;lgl&gt;     &lt;int&gt; &lt;dbl&gt;</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 FALSE      1182 0.591</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 TRUE        818 0.409</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="incorrect-correlation-is-not-causation-estimate" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="incorrect-correlation-is-not-causation-estimate">Incorrect “correlation is not causation” estimate</h2>
<p>We can take an initial stab at finding the causal effect of the program by comparing the average final grades for those who did math camp and those who didn’t. At first glance, it looks like math camp participants have a higher grade!</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>math_camp <span class="sc">%&gt;%</span> </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(math_camp) <span class="sc">%&gt;%</span> </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">avg =</span> <span class="fu">mean</span>(final_grade))</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 2 x 2</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="do">##   math_camp   avg</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="do">##   &lt;lgl&gt;     &lt;dbl&gt;</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 FALSE      138.</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 TRUE       144.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The distribution of scores is higher for those who did the program:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(math_camp, <span class="fu">aes</span>(<span class="at">x =</span> final_grade, <span class="at">fill =</span> math_camp)) <span class="sc">+</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="dv">2</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span> </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(math_camp), <span class="at">ncol =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_light</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="plot-distributions-wrong-1.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">Naive, wrong distributions</figcaption>
</figure>
</div>
<p>We can run a simple linear regression model to estimate the exact effect:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>model_wrong <span class="ot">&lt;-</span> <span class="fu">lm</span>(final_grade <span class="sc">~</span> math_camp, <span class="at">data =</span> math_camp)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(model_wrong)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 2 x 5</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="do">##   term          estimate std.error statistic   p.value</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="do">##   &lt;chr&gt;            &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 (Intercept)     138.       0.185     744.  0.       </span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 math_campTRUE     6.54     0.290      22.6 8.48e-101</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Based on this model, participating in the program is associated with 6.5 more points in your final grade. Neat.</p>
<p>This is wrong, though, since there are confounders at play that cause both attendance at math camp and final grade. We need to adjust for those to get the actual causal effect.</p>
</section>
<section id="adjustment-using-forbidden-unmeasured-variable" class="level2">
<h2 class="anchored" data-anchor-id="adjustment-using-forbidden-unmeasured-variable">Adjustment using forbidden unmeasured variable</h2>
<p>The backdoor confounder we have to worry about is <code>needs_camp</code>. We created this variable when we generated the data, so for fun, we can include it in the regression model as a control variable to adjust for it:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>model_adj_needs_camp <span class="ot">&lt;-</span> <span class="fu">lm</span>(final_grade <span class="sc">~</span> math_camp <span class="sc">+</span> needs_camp, <span class="at">data =</span> math_camp)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(model_adj_needs_camp)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 3 x 5</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="do">##   term           estimate std.error statistic   p.value</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="do">##   &lt;chr&gt;             &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 (Intercept)      139.       0.174     798.  0.       </span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 math_campTRUE     10.2      0.320      31.9 2.79e-181</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="do">## 3 needs_campTRUE    -6.69     0.329     -20.3 1.28e- 83</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The coefficient for <code>math_campTRUE</code> is now ≈10, which is what it should be! Adjusting for needing math camp isolated the causal effect.</p>
<p>But we can’t do that in real life. We don’t know what needing math camp looks like in actual data, so we need to use other techniques.</p>
</section>
<section id="adjustment-using-educated-guess-based-naive-matching" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="adjustment-using-educated-guess-based-naive-matching">Adjustment using educated-guess-based naive matching</h2>
<p>One possible approach to guessing the need for math camp is to create groups of students based on what we think might be driving the need for camp. We know from the causal model that quantitative GRE scores and undergraduate GPAs partially cause needing the program. We can assume that people with lower test scores or lower GPAs need the camp and create our own guess about what the threshold might be.</p>
<p>Let’s look at the distribution of GRE scores and see if there’s any pattern about why people may have chosen to do the program:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(math_camp, <span class="fu">aes</span>(<span class="at">x =</span> gre_quant, <span class="at">fill =</span> math_camp)) <span class="sc">+</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="dv">2</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span> </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(math_camp), <span class="at">ncol =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_light</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="gre-math-camp-1.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">Quantitative GRE score across math camp participation</figcaption>
</figure>
</div>
<p>There’s a pretty noticable break in the distribution of GRE scores for those who did the program: lots of people who scored under 145ish did the program, while not a lot of people who scored over 145 did. Without knowing anything about what completely causes math camp need, we can pretend that 145 is some sort of threshold of need and use that as our confounder:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>math_camp_guessed_need <span class="ot">&lt;-</span> math_camp <span class="sc">%&gt;%</span> </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">maybe_needs_camp =</span> gre_quant <span class="sc">&lt;</span> <span class="dv">145</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>model_adj_needs_camp_guess <span class="ot">&lt;-</span> <span class="fu">lm</span>(final_grade <span class="sc">~</span> math_camp <span class="sc">+</span> maybe_needs_camp, </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">data =</span> math_camp_guessed_need)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(model_adj_needs_camp_guess)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 3 x 5</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="do">##   term                 estimate std.error statistic   p.value</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="do">##   &lt;chr&gt;                   &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 (Intercept)            140.       0.197     708.  0.       </span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 math_campTRUE            8.70     0.292      29.8 4.41e-162</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="do">## 3 maybe_needs_campTRUE    -5.33     0.287     -18.6 2.36e- 71</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>After adjusting for our possible needing camp confounder, the causal effect is now 8.7, which is closer to 10! It’s still not entirely correct, but we’re getting closer.</p>
</section>
<section id="brief-interlude-matching-slightly-simpler-dag" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="brief-interlude-matching-slightly-simpler-dag">Brief interlude: Matching + slightly simpler DAG</h2>
<p>We just attempted to guess what the “needs camp” node might be based on the nodes flowing into it. If you notice, though, the “needs camp” node is an intermediate node on the path between GPA and GRE scores and actually participating in the math camp program. If we can guess what causes people to enroll in the program, that’s roughly the same as predicting their need for the camp.</p>
<p>Additionally, predicting enrollment in the program directly (rather than the desire to enroll) lets us use better matching techniques. Our guess of needing camp was pretty naive—it’d be more accurate if we incorporated other variables (like GPA and background) into our manual grouping. But the intuition of trying to group manually was correct—we looked at the factors that caused needing math camp and guessed that some things make it more likely. We can make this process more formal by building an actual model that predicts the likelihood of treatment.</p>
<p>To do this, we can remove the “needs camp” node, since it wasn’t doing much in the model and since we can use confounders like GPA and quantitative GRE to estimate the probability of enrollment in math camp directly. Here’s a slightly simpler version without “needs camp” and “background”:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>node_details_simpler <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>name, <span class="sc">~</span>label, <span class="sc">~</span>x, <span class="sc">~</span>y,</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"math_camp"</span>, <span class="st">"Math camp"</span>, <span class="dv">2</span>, <span class="dv">1</span>,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"final_grade"</span>, <span class="st">"Final grade"</span>, <span class="dv">4</span>, <span class="dv">1</span>,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"gre_quant"</span>, <span class="st">"GRE quantitative"</span>, <span class="fl">2.5</span>, <span class="dv">2</span>,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"gre_verbal"</span>, <span class="st">"GRE verbal"</span>, <span class="dv">5</span>, <span class="dv">2</span>,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"undergraduate_gpa"</span>, <span class="st">"Undergraduate GPA"</span>, <span class="dv">4</span>, <span class="dv">3</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>node_labels_simpler <span class="ot">&lt;-</span> node_details_simpler<span class="sc">$</span>label</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(node_labels_simpler) <span class="ot">&lt;-</span> node_details_simpler<span class="sc">$</span>name</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>math_camp_dag_simpler <span class="ot">&lt;-</span> <span class="fu">dagify</span>(final_grade <span class="sc">~</span> math_camp <span class="sc">+</span> gre_quant <span class="sc">+</span> gre_verbal <span class="sc">+</span> </span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>                                  undergraduate_gpa,</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>                                math_camp <span class="sc">~</span> undergraduate_gpa <span class="sc">+</span> gre_quant,</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>                                gre_quant <span class="sc">~</span> undergraduate_gpa,</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>                                gre_verbal <span class="sc">~</span> undergraduate_gpa,</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>                                <span class="at">exposure =</span> <span class="st">"math_camp"</span>,</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>                                <span class="at">outcome =</span> <span class="st">"final_grade"</span>,</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>                                <span class="at">coords =</span> node_details,</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>                                <span class="at">labels =</span> node_labels)</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Turn DAG into a tidy data frame for plotting</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>math_camp_dag_simpler_tidy <span class="ot">&lt;-</span> math_camp_dag_simpler <span class="sc">%&gt;%</span> </span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tidy_dagitty</span>() <span class="sc">%&gt;%</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">node_status</span>()   <span class="co"># Add column for exposure/outcome</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>status_colors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">exposure =</span> <span class="st">"#0074D9"</span>, <span class="at">outcome =</span> <span class="st">"#FF4136"</span>, <span class="at">latent =</span> <span class="st">"grey50"</span>)</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Fancier graph</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(math_camp_dag_simpler_tidy, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">xend =</span> xend, <span class="at">yend =</span> yend)) <span class="sc">+</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_dag_edges</span>() <span class="sc">+</span></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_dag_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> status)) <span class="sc">+</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_dag_label_repel</span>(<span class="fu">aes</span>(<span class="at">label =</span> label, <span class="at">fill =</span> status), <span class="at">seed =</span> <span class="dv">1234</span>,</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>                       <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> status_colors, <span class="at">na.value =</span> <span class="st">"grey20"</span>) <span class="sc">+</span></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> status_colors, <span class="at">na.value =</span> <span class="st">"grey20"</span>) <span class="sc">+</span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="cn">FALSE</span>, <span class="at">fill =</span> <span class="cn">FALSE</span>) <span class="sc">+</span> </span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_dag</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="simpler-dag-1.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">Simpler math camp DAG</figcaption>
</figure>
</div>
</section>
<section id="adjustment-using-inverse-probability-weighting-ipw" class="level2">
<h2 class="anchored" data-anchor-id="adjustment-using-inverse-probability-weighting-ipw">Adjustment using inverse probability weighting (IPW)</h2>
<p>One common method for matching the assignment to treatment based on confounders that is quite popular in epidemiology is to use inverse probability weighting (IPW). To estimate causal effects with IPW, we follow a two-step process. In the first step, we use the confounders to estimate propensity scores for each observation, or the probability of that observation going to math camp given other characteristics.</p>
<p>A common way to generate propensity scores is to use logistic regression. Here we build a model estimating participation in math camp based on undergraduate GPA and quantitative GRE scores. We then use <code>augment()</code> to plug the GPA and GRE values for each observation into the model and generate a predicted probability:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>needs_camp_model <span class="ot">&lt;-</span> <span class="fu">glm</span>(math_camp <span class="sc">~</span> undergrad_gpa <span class="sc">+</span> gre_quant, <span class="at">data =</span> math_camp, </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>                        <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>math_camp_propensities <span class="ot">&lt;-</span> <span class="fu">augment</span>(needs_camp_model, math_camp, <span class="at">type.predict =</span> <span class="st">"response"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p_camp =</span> .fitted)  <span class="co"># Rename column</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>math_camp_propensities <span class="sc">%&gt;%</span> </span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id, undergrad_gpa, gre_quant, math_camp, p_camp) <span class="sc">%&gt;%</span> </span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>()</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 6 x 5</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="do">##      id undergrad_gpa gre_quant math_camp p_camp</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="do">##   &lt;int&gt;         &lt;dbl&gt;     &lt;dbl&gt; &lt;lgl&gt;      &lt;dbl&gt;</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="do">## 1     1          3.90      151. FALSE     0.0969</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="do">## 2     2          3.20      143. FALSE     0.371 </span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="do">## 3     3          2.83      140. TRUE      0.554 </span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a><span class="do">## 4     4          2.63      154. FALSE     0.291 </span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="do">## 5     5          3.24      148. FALSE     0.258 </span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="do">## 6     6          2.95      146. FALSE     0.371</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We have a new column <code>p_camp</code> that shows the probability of going to camp based on grades and test scores. Our first person has a high GPA and high GRE score, so they have a 9% chance of going to math camp, while person 3 has a low GPA and low test score, so they’re more likely to need it.</p>
<p>In the second step, we incorporate these predicted probabilities into our causal effect estimation by converting them into weights, which creates a pseduo-population of observations (i.e.&nbsp;some student observations are more important than others for estimating the causal effect). What this means practically is that people with a low likelihood of attending math camp who <em>do</em> attend it anyway should be treated as more important than those who follow expectations, since those with higher weights are more likely to influence the overall causal effect.</p>
<p>There are a whole bunch of different weighting techniques, and <a href="https://livefreeordichotomize.com/">Lucy D’Agostino McGowan</a> covers them in depth <a href="https://livefreeordichotomize.com/2019/01/17/understanding-propensity-score-weighting/">in her excellent blog post here</a> (see also <a href="https://www.rdatagen.net/post/potential-outcomes-confounding/">this</a>). For the sake of this example, we’ll calculate weights that are appropriate for estimating two different causal quantities. Here, <span class="math inline">\(i\)</span> represents an individual student, <span class="math inline">\(e_i\)</span> represents the propensity score for an individual needing/participating in math camp, or the treatment <span class="math inline">\(Z_i\)</span>:</p>
<ul>
<li>Average treatment effect (ATE): overall average effect, or the difference in potential outcomes when the Z = 1 and Z = 0. Formula for weights: <span class="math inline">\(\frac{Z_i}{e_i} + \frac{1 - Z_i}{1 - e_i}\)</span></li>
<li>Average treatment effect among the overlap population (ATO): effect of math camp across observations that overlap (i.e.&nbsp;those who are both likely and unlikely to need math camp). Formula for weights: <span class="math inline">\((1-e_i)Z_i + e_i(1-Z_i)\)</span></li>
</ul>
<!-- end list -->
<div class="sourceCode" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>math_camp_propensities <span class="ot">&lt;-</span> math_camp_propensities <span class="sc">%&gt;%</span> </span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">w_ate =</span> (math_camp <span class="sc">/</span> p_camp) <span class="sc">+</span> ((<span class="dv">1</span> <span class="sc">-</span> math_camp) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> p_camp)),</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">w_ato =</span> (<span class="dv">1</span> <span class="sc">-</span> p_camp) <span class="sc">*</span> math_camp <span class="sc">+</span> p_camp <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> math_camp))</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>math_camp_propensities <span class="sc">%&gt;%</span> </span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id, p_camp, w_ate, w_ato) <span class="sc">%&gt;%</span> </span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>()</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 6 x 4</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="do">##      id p_camp w_ate  w_ato</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="do">##   &lt;int&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="do">## 1     1 0.0969  1.11 0.0969</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="do">## 2     2 0.371   1.59 0.371 </span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="do">## 3     3 0.554   1.80 0.446 </span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="do">## 4     4 0.291   1.41 0.291 </span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="do">## 5     5 0.258   1.35 0.258 </span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="do">## 6     6 0.371   1.59 0.371</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Finally, we can incorporate these weights into a regression model. Note how we’re using <code>math_camp</code> as the only explanatory variable. Because we used undergraduate GPA and quantitative GRE scores to estimate the propensity scores for needing camp (and receiving the program), including the weights should be enough to close the “needs camp” back door:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>model_ipw_ate <span class="ot">&lt;-</span> <span class="fu">lm</span>(final_grade <span class="sc">~</span> math_camp, </span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> math_camp_propensities, <span class="at">weights =</span> w_ate)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(model_ipw_ate)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 2 x 5</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="do">##   term          estimate std.error statistic   p.value</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="do">##   &lt;chr&gt;            &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 (Intercept)      137.      0.222     614.  0.       </span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 math_campTRUE     10.9     0.308      35.3 8.75e-213</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>model_ipw_ato <span class="ot">&lt;-</span> <span class="fu">lm</span>(final_grade <span class="sc">~</span> math_camp, </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> math_camp_propensities, <span class="at">weights =</span> w_ato)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(model_ipw_ato)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 2 x 5</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="do">##   term          estimate std.error statistic   p.value</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="do">##   &lt;chr&gt;            &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 (Intercept)      136.      0.203     672.  0.       </span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 math_campTRUE     10.0     0.286      35.0 1.02e-209</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Both of these causal estimates are pretty spot on, with the ATO providing an answer incredibly close to the true value of 10. Neat!</p>
<p>If we had other backdoors to adjust for, we could include them in the propensity score model as well. We can do all our backdoor adjustment in the logit model, generate propensity scores, generate inverse probability weights, and then use the weights in a simple regression model to find the actual causal effect.</p>
</section>
<section id="adjustment-using-matching-with-mahalanobis-distance" class="level2">
<h2 class="anchored" data-anchor-id="adjustment-using-matching-with-mahalanobis-distance">Adjustment using matching (with Mahalanobis distance)</h2>
<p>We can use other methods to find matches in the data to estimate the probability of attending math camp. There’s a whole world of other statistical methods for creating matches; inverse probability weights are just one method.</p>
<p>While matching based on propensity scores (i.e.&nbsp;building some model to generate predicted probabilities for the likelihood of treatment and matching observations that have similar propensities) is popular, it can cause problems when you use it for causal identification. Following <a href="https://www.youtube.com/watch?v=rBv39pK1iEs">Gary King’s suggestions</a>, we can match with other techniques. (Again, covering what all these do goes beyond the scope of this post, but there are some excellent resources out there, like <a href="https://www.youtube.com/watch?v=rBv39pK1iEs">this highly accessible video by Gary King</a>.)</p>
<p>One popular technique in political science is to match based on <a href="https://en.wikipedia.org/wiki/Mahalanobis_distance">Mahalanobis</a> (or <a href="https://en.wikipedia.org/wiki/Euclidean_distance">Euclidean</a>) distance. We can use <code>matchit()</code> from the <strong>MatchIt</strong> library to group students with similar needs. Instead of creating a new grouping variable like we did before for <code>needs_camp</code>, because we know that undergrad GPA and quantitative GRE scores cause needing math camp, and that needing math camp is the only path into actually doing the program, we can model the probability of treatment by using undergrad GPA and quantitative GRE.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MatchIt)  <span class="co"># For matching stuff</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>matched <span class="ot">&lt;-</span> <span class="fu">matchit</span>(math_camp <span class="sc">~</span> undergrad_gpa <span class="sc">+</span> gre_quant, <span class="at">data =</span> math_camp,</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>                   <span class="at">method =</span> <span class="st">"nearest"</span>, <span class="at">distance =</span> <span class="st">"mahalanobis"</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>matched</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="do">## Call: </span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="do">## matchit(formula = math_camp ~ undergrad_gpa + gre_quant, data = math_camp, </span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="do">##     method = "nearest", distance = "mahalanobis", replace = TRUE)</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="do">## Sample sizes:</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="do">##           Control Treated</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="do">## All          1182     818</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="do">## Matched       366     818</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="do">## Unmatched     816       0</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a><span class="do">## Discarded       0       0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>By matching this way, we found 366 people who didn’t do math camp who look similar to those who did, which means we can arguably say that those who didn’t do it didn’t need to. If we want, we can see which observations were matched:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(matched<span class="sc">$</span>match.matrix)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="do">##    1     </span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="do">## 3  "1864"</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="do">## 7  "646" </span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="do">## 9  "586" </span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="do">## 12 "83"  </span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="do">## 15 "244" </span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="do">## 20 "1815"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>And we can extract the details from the match:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>math_camp_matched <span class="ot">&lt;-</span> <span class="fu">match.data</span>(matched)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(math_camp_matched)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="do">##    id undergrad_gpa gre_verbal gre_quant needs_camp math_camp grade_noise</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="do">## 3   3      2.828828   161.6843  140.4169       TRUE      TRUE    10.37564</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="do">## 5   5      3.244684   170.0000  147.9607      FALSE     FALSE    16.40707</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="do">## 7   7      3.757950   170.0000  151.4425      FALSE      TRUE    24.01470</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="do">## 9   9      3.085583   162.4533  149.3013      FALSE      TRUE    21.00359</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="do">## 12 12      3.300517   167.0163  152.7640      FALSE      TRUE    15.10616</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="do">## 15 15      3.809366   170.0000  141.3918      FALSE      TRUE    12.68628</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="do">##    final_grade distance   weights</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="do">## 3     140.2209       NA 1.0000000</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="do">## 5     142.6853       NA 0.4474328</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="do">## 7     162.2392       NA 1.0000000</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="do">## 9     155.6245       NA 1.0000000</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="do">## 12    152.9133       NA 1.0000000</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="do">## 15    145.9059       NA 1.0000000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We have one new column in this data: <code>weights</code>. Observations are now weighted differently based on how distant they are from their matches—observations who attended math camp that are similar to those who didn’t have a higher weight. This weighting creates a pseudo-population of students (i.e.&nbsp;some student observations are more important than others for estimating the causal effect), just like we did with IPW.</p>
<p>We can incorporate these weights into a regression model. Note how we’re using <code>math_camp</code> as the only explanatory variable. Because we used matching to guess the likelihood of needing camp (and receiving the program), including the weights should be enough to close the “needs camp” back door:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>model_matched <span class="ot">&lt;-</span> <span class="fu">lm</span>(final_grade <span class="sc">~</span> math_camp, <span class="at">data =</span> math_camp_matched, <span class="at">weights =</span> weights)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(model_matched)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 2 x 5</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="do">##   term          estimate std.error statistic   p.value</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="do">##   &lt;chr&gt;            &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 (Intercept)      134.      0.338     398.  0.       </span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 math_campTRUE     10.0     0.407      24.7 7.68e-109</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>And look at that! The coefficient for <code>math_campTRUE</code> is 10, which is what the true causal effect is.</p>
<p>Matching with Mahalanobis distance isn’t the only technique available—depending on the context of your actual data (and how complicated you want to get), you could use other algorithms like coarsened exact matching (CEM), optimal matching, or other techniques included in the <strong>MatchIt</strong> package.</p>
<p>One potential downside to matching is that it throws away data. Notice how there are only 1,184 rows in the <code>math_camp_matched</code> dataset, while using inverse probability weights let us use the full 2,000 rows in the original data.</p>
</section>
<section id="someday-when-im-smarter-do-calculus" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="someday-when-im-smarter-do-calculus">Someday when I’m smarter: <em>do</em>-calculus</h2>
<p>Finally, Judea Pearl’s most important contribution to the world of causal inference is a <a href="https://plato.stanford.edu/entries/causal-models/do-calculus.html">complete set of three axioms</a> (or rules) that allow us to convert equations with a <span class="math inline">\(do(\cdot)\)</span> operator into something estimatable with observational data.</p>
<p><em>Very</em> briefly, the <em>do</em> operator lets us define interventions (like programs and policies) in mathematical formulas. For instance, in our ongoing example, we’re interested in <span class="math inline">\(Pr(\text{Grade} | do(\text{Math camp}))\)</span>, or the probability distribution of final grades given that someone <em>does</em> math camp. Math camp is an intervention, and in a randomized controlled trial, we’d be able to control who got to <em>do</em> it, and thereby estimate the causal effect.</p>
<p>Given observational data, though, we’re left only with the ability to calculate <span class="math inline">\(Pr(\text{Grade} | \text{Math camp})\)</span>, or the probability distribution of final grades given math camp. Because there’s no <span class="math inline">\(do(\cdot)\)</span> here, we can’t isolate the effect entirely if there are confounders like GRE and GPA. We tried that earlier in the “correlation isn’t causation” section and found an incorrect program effect.</p>
<p>The three rules of Pearl’s <em>do</em>-calculus allows us to chop up causal diagrams in systematic ways that can remove the <span class="math inline">\(do(\cdot)\)</span>. The reason closing backdoors by adjusting for confounders works is because the approach follows one of the <em>do</em>-calculus rules that removes <span class="math inline">\(do(\cdot)\)</span> from <span class="math inline">\(Pr(\text{Grade} | do(\text{Math camp}))\)</span>. For instance (and apologies for using X, Y, and Z instead of actual variables!), in a DAG with one confounder (Z)…</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>backdoor_dag <span class="ot">&lt;-</span> <span class="fu">dagify</span>(Y <span class="sc">~</span> X <span class="sc">+</span> Z,</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>                       X <span class="sc">~</span> Z,</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">exposure =</span> <span class="st">"X"</span>,</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">outcome =</span> <span class="st">"Y"</span>,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">coords =</span> <span class="fu">list</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="at">X =</span> <span class="dv">1</span>, <span class="at">Y =</span> <span class="dv">3</span>, <span class="at">Z =</span> <span class="dv">2</span>),</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">y =</span> <span class="fu">c</span>(<span class="at">X =</span> <span class="dv">1</span>, <span class="at">Y =</span> <span class="dv">1</span>, <span class="at">Z =</span> <span class="dv">2</span>)))</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggdag</span>(backdoor_dag) <span class="sc">+</span> </span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_dag</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="do-calculus-tiny-dag-1.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">Tiny XYZ DAG</figcaption>
</figure>
</div>
<p>…the <em>do</em>-calculus version of backdoor adjustment is:</p>
<p><span class="math display">\[
P(Y | do(X)) = \sum_Z P(Y | X, Z) \times P(Z)
\]</span></p>
<p>In other words, we can remove the <span class="math inline">\(do(\cdot)\)</span> if we multiply the probability distribution of Y given both X and Z by the probability distribution of Z, and then add all those values up for every value of Z. If X, Y, and Z were all binary, we’d be able to write the <span class="math inline">\(do\)</span>-free version of the causal effect like this:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># P(y|do(x=1)) = P(y|x=1, z=1)*P(z=1) + P(y|x=1, z=0)*P(z=0)</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(y[x <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> z <span class="sc">==</span> <span class="dv">1</span>]) <span class="sc">*</span> <span class="fu">mean</span>(z <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">+</span> <span class="fu">mean</span>(y[x <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> z <span class="sc">==</span> <span class="dv">0</span>]) <span class="sc">*</span> <span class="fu">mean</span>(z <span class="sc">==</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>There are fancy algorithms that can determine the exact adjustment formula for a given DAG, and the <strong>causaleffect</strong> package lets you use these algorithms in R. Here’s the <em>do</em>-calculus version of our math camp example. Unfortunately we have to rewrite the DAG with a different syntax for it to work:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(causaleffect)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(igraph)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>math_dag <span class="ot">&lt;-</span> <span class="fu">graph.formula</span>(grade <span class="sc">+-</span> undergradGPA, </span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>                          grade <span class="sc">+-</span> GREquant, </span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>                          grade <span class="sc">+-</span> GREverbal,</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>                          grade <span class="sc">+-</span> mathcamp,</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>                          mathcamp <span class="sc">+-</span> GREquant,</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>                          mathcamp <span class="sc">+-</span> undergradGPA,</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>                          GREquant <span class="sc">+-</span> undergradGPA,</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>                          GREverbal <span class="sc">+-</span> undergradGPA,</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>                      <span class="at">simplify =</span> <span class="cn">FALSE</span>)</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="co"># plot(math_dag)  # Plot this</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a><span class="co"># expr returns a LaTeX formula; simp simplifies the formula through repeated</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="co"># application of the rules of do-calculus</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>do_calc_formula <span class="ot">&lt;-</span> <span class="fu">causal.effect</span>(<span class="at">y =</span> <span class="st">"grade"</span>, <span class="at">x =</span> <span class="st">"mathcamp"</span>,</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">G =</span> math_dag, <span class="at">expr =</span> <span class="cn">TRUE</span>, <span class="at">simp =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This produces the following <em>do</em>-calculus-based adjustment formula:</p>
<div style="font-size: 60%;">
<p><span class="math display">\[
\sum_{GREquant,undergradGPA}P(grade|undergradGPA,GREquant,mathcamp)P(GREquant|undergradGPA)P(undergradGPA)
\]</span></p>
</div>
<p>Neat! We still need to adjust for GRE quantitative scores and undergrad GPA, and if we somehow multiply the three probability distributions (final grade given GPA, GRE, and mathcamp, GRE given GPA, and GPA), we’ll have a <span class="math inline">\(do(\cdot)\)</span>-free version of the causal effect.</p>
<p><strong>Unfortunately I have absolutely no idea how to do this with R.</strong> Continuous variables blow up the math in <em>do</em>-calculus equations and I don’t know how to deal with that.</p>
</section>
<section id="comparison-of-all-methods" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="comparison-of-all-methods">Comparison of all methods</h2>
<p>Phew. We just used naive matching, inverse probability weighting, and Mahalanobis matching to estimate the causal effect of a hypothetical math camp program on final grades using only observational data. How’d we do?!</p>
<p>Here are all the estimates we have, along with a blue dotted line for the truth. Adjusting for backdoor confounders allows us to get far more accurate and identified causal results than when we leave things unadjusted, and we get the most accurate results when we explicitly attempt to match treated and untreated observations (as with do with the IPW ATO and with Mahalanobis matching). That’s likely not always the case—lots of these methods depend on the relationships between the different nodes in the graph, and it’s possible that they don’t work when there are non-linear relationships.</p>
<p>But in this case, at least, we can prove causation with observational data, which is really neat!</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggstance)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>all_models <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>method, <span class="sc">~</span>model,</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Wrong correlation-not-causation"</span>, model_wrong,</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Forbidden needs camp"</span>, model_adj_needs_camp,</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Educated guess needs camp"</span>, model_adj_needs_camp_guess,</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Inverse probability weighting ATE"</span>, model_ipw_ate,</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Inverse probability weighting ATO"</span>, model_ipw_ato,</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Mahalanobis matching"</span>, model_matched</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract coefficient for math_camp from each model</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tidied =</span> <span class="fu">map</span>(model, <span class="sc">~</span><span class="fu">tidy</span>(., <span class="at">conf.int =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>         <span class="at">effect =</span> <span class="fu">map</span>(tidied, <span class="sc">~</span><span class="fu">filter</span>(., term <span class="sc">==</span> <span class="st">"math_campTRUE"</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(effect) <span class="sc">%&gt;%</span> </span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>model, <span class="sc">-</span>tidied) <span class="sc">%&gt;%</span> </span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">method =</span> <span class="fu">fct_inorder</span>(method))</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(all_models, <span class="fu">aes</span>(<span class="at">x =</span> estimate, <span class="at">y =</span> <span class="fu">fct_rev</span>(method), <span class="at">color =</span> method)) <span class="sc">+</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">10</span>, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"#0074D9"</span>) <span class="sc">+</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_pointrangeh</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> conf.low, <span class="at">xmax =</span> conf.high), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>(<span class="at">option =</span> <span class="st">"plasma"</span>, <span class="at">end =</span> <span class="fl">0.9</span>, <span class="at">guide =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Causal effect"</span>, <span class="at">y =</span> <span class="cn">NULL</span>, <span class="at">caption =</span> <span class="st">"Dotted line shows true effect"</span>) <span class="sc">+</span></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_light</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="compare-everything-1.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">Comparison of all causal effects</figcaption>
</figure>
</div>


<!-- -->

</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{heiss2020,
  author = {Heiss, Andrew},
  title = {Ways to Close Backdoors in {DAGs}},
  date = {2020-02-25},
  url = {https://www.andrewheiss.com/blog/2020/02/25/closing-backdoors-dags/},
  doi = {10.59350/z5y4e-jgk85},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-heiss2020" class="csl-entry quarto-appendix-citeas" role="listitem">
Heiss, Andrew. 2020. <span>“Ways to Close Backdoors in DAGs.”</span>
February 25, 2020. <a href="https://doi.org/10.59350/z5y4e-jgk85">https://doi.org/10.59350/z5y4e-jgk85</a>.
</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/www\.andrewheiss\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://giscus.app/client.js" data-repo="andrewheiss/ath-quarto" data-repo-id="R_kgDOIg6EJQ" data-category="Blog comments" data-category-id="DIC_kwDOIg6EJc4CSz92" data-mapping="pathname" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script>
<input type="hidden" id="giscus-base-theme" value="light">
<input type="hidden" id="giscus-alt-theme" value="dark"><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb25" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> Ways to close backdoors in DAGs</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> 2020-02-25</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="an">description:</span><span class="co"> Use regression, inverse probability weighting, and matching to close confounding backdoors and find causation in observational data</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="an">image:</span><span class="co"> load-libraries-make-dag-1.png</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="an">tags:</span><span class="co"> </span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="co">  - r</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="co">  - ggplot</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="co">  - tidyverse</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="co">  - DAGs</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="co">  - causal inference</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="co">  - do calculus</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="an">doi:</span><span class="co"> 10.59350/z5y4e-jgk85</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a><span class="an">citation:</span><span class="co"> true</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>&lt;span class="small"&gt;(<span class="co">[</span><span class="ot">See this notebook on GitHub</span><span class="co">](https://github.com/andrewheiss/closing-backdoors-dags)</span>)&lt;/span&gt;</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>I’ve been teaching <span class="co">[</span><span class="ot">program evaluation</span><span class="co">](https://evalsp20.classes.andrewheiss.com/)</span> in the MPA/MPP program at GSU for the past semester and a half, and since I was given free rein over how to teach it, I decided to make it as modern and cutting edge as possible. To do this, I’ve infused the class with modern causal inference techniques (commonly known as the <span class="co">[</span><span class="ot">“causal revolution”</span><span class="co">](https://bigthink.com/errors-we-live-by/judea-pearls-the-book-of-why-brings-news-of-a-new-science-of-causes)</span>), focused on the language of <span class="co">[</span><span class="ot">directed acyclic graphs (DAGs)</span><span class="co">](https://cran.r-project.org/web/packages/ggdag/vignettes/intro-to-dags.html)</span>, <span class="co">[</span><span class="ot">do-calculus</span><span class="co">](https://www.inference.vc/untitled/)</span>, confounding, colliding, and the rest of Judea Pearl’s world of finding causation in observational data.</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>However, I was never taught this approach in any of my doctoral classes, and I’m entirely self-taught. I read <span class="co">[</span><span class="ot">*The Book of Why*</span><span class="co">](https://www.amazon.com/Book-Why-Science-Cause-Effect/dp/046509760X/)</span> in March 2019, and I’ve thrown myself into every possible journal article, blog post, and online course I’ve come across in order to understand how to isolate and identify causal effects. It’s been hard, but thanks to an incredibly welcoming community of economists, epidemiologists, and political scientists on Twitter, I’m getting it! (And so are my students!)</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>The purpose of this post isn’t to introduce causal models and DAGs and confounders vs.&nbsp;colliders and all that. For that kind of introduction, consult any (or all!) of these resources:</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Nick Huntington-Klein's <span class="co">[</span><span class="ot">ECON 305: Economics, Causality, and Analytics course</span><span class="co">](http://www.nickchk.com/econ305.html)</span> (especially lectures 13–18)</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Julia M. Rohrer, “Thinking Clearly About Correlations and Causation: Graphical Causal Models for Observational Data,” Advances in Methods and Practices in *Psychological Science* 1, no. 1 (March 2018): 27–42, doi: <span class="co">[</span><span class="ot">10.1177/2515245917745629</span><span class="co">](https://doi.org/10.1177/2515245917745629)</span></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Miguel A. Hernán and James M. Robbins, *Causal Inference: What If* (CRC Press, 2020), <span class="ot">&lt;https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/&gt;</span></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Paul Hünermund and Elias Bareinboim, “Causal Inference and Data-Fusion in Econometrics,” December 19, 2019, arXiv: 1912.09104 <span class="sc">\[</span>econ.EM<span class="sc">\]</span>, <span class="ot">&lt;https://arxiv.org/abs/1912.09104&gt;</span></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Felix Elwert, “Graphical Causal Models,” chap.&nbsp;13 in *Handbook of Causal Analysis for Social Research*, ed.&nbsp;Stephen L. Morgan (New York: Springer, 2013), 245–273, doi: <span class="co">[</span><span class="ot">10.1007/978-94-007-6094-3\_13</span><span class="co">](https://doi.org/10.1007/978-94-007-6094-3_13)</span></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Julian Schuessler and Peter Selb, “Graphical Causal Models for Survey Inference” (December 17, 2019), doi: <span class="co">[</span><span class="ot">10.31235/osf.io/hbg3m</span><span class="co">](https://doi.org/10.31235/osf.io/hbg3m)</span>, <span class="ot">&lt;https://osf.io/preprints/socarxiv/hbg3m/&gt;</span></span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Scott Cunningham, “Directed acyclical graphs” in *Causal Inference: The Mixtape* (2018), <span class="ot">&lt;https://www.scunning.com/mixtape.html&gt;</span></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Paul Hünermund, “Causal Inference with Directed Acyclic Graphs,” <span class="co">[</span><span class="ot">Udemy</span><span class="co">](https://www.udemy.com/course/causal-data-science/?referralCode=4FB57D92601437BEB794)</span></span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Jason A. Roy, “A Crash Course in Causality: Inferring Causal Effects from Observational Data,” <span class="co">[</span><span class="ot">Coursera</span><span class="co">](https://www.coursera.org/learn/crash-course-in-causality/home/welcome)</span></span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>Instead, this post is a practical example of how exactly you can isolate causal effects by closing backdoor paths and adjusting for confounders in observational data. At its core, DAG-based causal inference involves isolating relationships—if some variable causes both your treatment and your outcome (thus confounding it), you can deal with that common cause in some statistical way and isolate the treatment–outcome effect. There’s no one right way to statistically deal with confounding, so here I show a few different ways to do it.</span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>To make this more concrete and practical, I use simulated data from a hypothetical program, but I use actual variable names rather than the $x$, $y$, and $z$ variables that are common in tutorials and articles about DAGs. Here, our outcome $y$ is a final grade, $x$ is a special math camp, and $z$ is all the possible confounders of the effect of the math camp on the grade.</span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>Like <span class="co">[</span><span class="ot">my post showing a bunch of different ways to test differences in means</span><span class="co">](https://www.andrewheiss.com/blog/2019/01/29/diff-means-half-dozen-ways/)</span>, this is mostly a resource to my students and to future me. <span class="co">[</span><span class="ot">Please feel free to comment and make corrections or additions at GitHub\!</span><span class="co">](https://github.com/andrewheiss/closing-backdoors-dags/issues)</span></span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>Here’s a tl;dr table of contents since this is a little long:</span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Example program</span><span class="co">](#example-program)</span></span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Simulated data</span><span class="co">](#simulated-data)</span></span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Incorrect “correlation is not causation” estimate</span><span class="co">](#incorrect-correlation-is-not-causation-estimate)</span></span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Adjustment using forbidden unmeasured variable</span><span class="co">](#adjustment-using-forbidden-unmeasured-variable)</span></span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Adjustment using educated-guess-based naive matching</span><span class="co">](#adjustment-using-educated-guess-based-naive-matching)</span></span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Brief interlude: Matching + slightly simpler DAG</span><span class="co">](#brief-interlude-matching--slightly-simpler-dag)</span></span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Adjustment using inverse probability weighting (IPW)</span><span class="co">](#adjustment-using-inverse-probability-weighting-ipw)</span></span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Adjustment using matching (with Mahalanobis distance)</span><span class="co">](#adjustment-using-matching-with-mahalanobis-distance)</span></span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Someday when I’m smarter: *do*-calculus</span><span class="co">](#someday-when-im-smarter-do-calculus)</span></span>
<span id="cb25-54"><a href="#cb25-54" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Comparison of all methods</span><span class="co">](#comparison-of-all-methods)</span></span>
<span id="cb25-55"><a href="#cb25-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-56"><a href="#cb25-56" aria-hidden="true" tabindex="-1"></a><span class="fu">## Example program</span></span>
<span id="cb25-57"><a href="#cb25-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-58"><a href="#cb25-58" aria-hidden="true" tabindex="-1"></a>We’ll refer to a hypothetical math camp program throughout all these examples. Many policy schools offer a brief math camp in the weeks before students begin their graduate degrees, with the hope that it will help students be more prepared in math-heavy classes like statistics and microeconomics. For these examples, we’re interested in answering one question: what is the causal effect of attending math camp on final student outcomes?</span>
<span id="cb25-59"><a href="#cb25-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-60"><a href="#cb25-60" aria-hidden="true" tabindex="-1"></a>We can use <span class="co">[</span><span class="ot">**ggdag**</span><span class="co">](https://cran.r-project.org/web/packages/ggdag/vignettes/intro-to-ggdag.html)</span> to draw a simplified causal model that explains what causes final student outcomes (it’s probably wrong, but whatever). I added all the fancy bells and whistles to the graph object here just for the sake of reference. In reality, you don’t need labels or coordinates or the individual <span class="in">`geom_dag_*()`</span> layers and you can just do <span class="in">`ggdag(math_camp_dag)`</span> to get a basic graph, but for fun I’ve included everything you need for a publication-worthy graph.</span>
<span id="cb25-61"><a href="#cb25-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-62"><a href="#cb25-62" aria-hidden="true" tabindex="-1"></a><span class="in">``` r</span></span>
<span id="cb25-63"><a href="#cb25-63" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)  <span class="co"># ggplot, dplyr, %&gt;%, and friends</span></span>
<span id="cb25-64"><a href="#cb25-64" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggdag)  <span class="co"># Make DAGs with ggplot</span></span>
<span id="cb25-65"><a href="#cb25-65" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dagitty)  <span class="co"># Do basic DAG math</span></span>
<span id="cb25-66"><a href="#cb25-66" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom)  <span class="co"># For converting model output to data frames</span></span>
<span id="cb25-67"><a href="#cb25-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-68"><a href="#cb25-68" aria-hidden="true" tabindex="-1"></a>node_details <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb25-69"><a href="#cb25-69" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>name, <span class="sc">~</span>label, <span class="sc">~</span>x, <span class="sc">~</span>y,</span>
<span id="cb25-70"><a href="#cb25-70" aria-hidden="true" tabindex="-1"></a>  <span class="st">"math_camp"</span>, <span class="st">"Math camp"</span>, <span class="dv">2</span>, <span class="dv">1</span>,</span>
<span id="cb25-71"><a href="#cb25-71" aria-hidden="true" tabindex="-1"></a>  <span class="st">"final_grade"</span>, <span class="st">"Final grade"</span>, <span class="dv">4</span>, <span class="dv">1</span>,</span>
<span id="cb25-72"><a href="#cb25-72" aria-hidden="true" tabindex="-1"></a>  <span class="st">"needs_camp"</span>, <span class="st">"Needs camp"</span>, <span class="dv">1</span>, <span class="dv">2</span>,</span>
<span id="cb25-73"><a href="#cb25-73" aria-hidden="true" tabindex="-1"></a>  <span class="st">"gre_quant"</span>, <span class="st">"GRE quantitative"</span>, <span class="fl">2.5</span>, <span class="dv">2</span>,</span>
<span id="cb25-74"><a href="#cb25-74" aria-hidden="true" tabindex="-1"></a>  <span class="st">"gre_verbal"</span>, <span class="st">"GRE verbal"</span>, <span class="dv">5</span>, <span class="dv">2</span>,</span>
<span id="cb25-75"><a href="#cb25-75" aria-hidden="true" tabindex="-1"></a>  <span class="st">"background"</span>, <span class="st">"Background"</span>, <span class="dv">2</span>, <span class="dv">3</span>,</span>
<span id="cb25-76"><a href="#cb25-76" aria-hidden="true" tabindex="-1"></a>  <span class="st">"undergraduate_gpa"</span>, <span class="st">"Undergraduate GPA"</span>, <span class="dv">4</span>, <span class="dv">3</span></span>
<span id="cb25-77"><a href="#cb25-77" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-78"><a href="#cb25-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-79"><a href="#cb25-79" aria-hidden="true" tabindex="-1"></a>node_labels <span class="ot">&lt;-</span> node_details<span class="sc">$</span>label</span>
<span id="cb25-80"><a href="#cb25-80" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(node_labels) <span class="ot">&lt;-</span> node_details<span class="sc">$</span>name</span>
<span id="cb25-81"><a href="#cb25-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-82"><a href="#cb25-82" aria-hidden="true" tabindex="-1"></a>math_camp_dag <span class="ot">&lt;-</span> <span class="fu">dagify</span>(final_grade <span class="sc">~</span> math_camp <span class="sc">+</span> gre_quant <span class="sc">+</span> gre_verbal <span class="sc">+</span> </span>
<span id="cb25-83"><a href="#cb25-83" aria-hidden="true" tabindex="-1"></a>                          undergraduate_gpa <span class="sc">+</span> background,</span>
<span id="cb25-84"><a href="#cb25-84" aria-hidden="true" tabindex="-1"></a>                        math_camp <span class="sc">~</span> needs_camp, </span>
<span id="cb25-85"><a href="#cb25-85" aria-hidden="true" tabindex="-1"></a>                        needs_camp <span class="sc">~</span> background <span class="sc">+</span> undergraduate_gpa <span class="sc">+</span> gre_quant,</span>
<span id="cb25-86"><a href="#cb25-86" aria-hidden="true" tabindex="-1"></a>                        gre_quant <span class="sc">~</span> background <span class="sc">+</span> undergraduate_gpa,</span>
<span id="cb25-87"><a href="#cb25-87" aria-hidden="true" tabindex="-1"></a>                        gre_verbal <span class="sc">~</span> background <span class="sc">+</span> undergraduate_gpa,</span>
<span id="cb25-88"><a href="#cb25-88" aria-hidden="true" tabindex="-1"></a>                        undergraduate_gpa <span class="sc">~</span> background,</span>
<span id="cb25-89"><a href="#cb25-89" aria-hidden="true" tabindex="-1"></a>                        <span class="at">exposure =</span> <span class="st">"math_camp"</span>,</span>
<span id="cb25-90"><a href="#cb25-90" aria-hidden="true" tabindex="-1"></a>                        <span class="at">outcome =</span> <span class="st">"final_grade"</span>,</span>
<span id="cb25-91"><a href="#cb25-91" aria-hidden="true" tabindex="-1"></a>                        <span class="at">latent =</span> <span class="st">"background"</span>,</span>
<span id="cb25-92"><a href="#cb25-92" aria-hidden="true" tabindex="-1"></a>                        <span class="at">coords =</span> node_details,</span>
<span id="cb25-93"><a href="#cb25-93" aria-hidden="true" tabindex="-1"></a>                        <span class="at">labels =</span> node_labels)</span>
<span id="cb25-94"><a href="#cb25-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-95"><a href="#cb25-95" aria-hidden="true" tabindex="-1"></a><span class="co"># Turn DAG into a tidy data frame for plotting</span></span>
<span id="cb25-96"><a href="#cb25-96" aria-hidden="true" tabindex="-1"></a>math_camp_dag_tidy <span class="ot">&lt;-</span> math_camp_dag <span class="sc">%&gt;%</span> </span>
<span id="cb25-97"><a href="#cb25-97" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tidy_dagitty</span>() <span class="sc">%&gt;%</span></span>
<span id="cb25-98"><a href="#cb25-98" aria-hidden="true" tabindex="-1"></a>  <span class="fu">node_status</span>()   <span class="co"># Add column for exposure/outcome/latent</span></span>
<span id="cb25-99"><a href="#cb25-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-100"><a href="#cb25-100" aria-hidden="true" tabindex="-1"></a>status_colors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">exposure =</span> <span class="st">"#0074D9"</span>, <span class="at">outcome =</span> <span class="st">"#FF4136"</span>, <span class="at">latent =</span> <span class="st">"grey50"</span>)</span>
<span id="cb25-101"><a href="#cb25-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-102"><a href="#cb25-102" aria-hidden="true" tabindex="-1"></a><span class="co"># Fancier graph</span></span>
<span id="cb25-103"><a href="#cb25-103" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(math_camp_dag_tidy, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">xend =</span> xend, <span class="at">yend =</span> yend)) <span class="sc">+</span></span>
<span id="cb25-104"><a href="#cb25-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_dag_edges</span>() <span class="sc">+</span></span>
<span id="cb25-105"><a href="#cb25-105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_dag_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> status)) <span class="sc">+</span></span>
<span id="cb25-106"><a href="#cb25-106" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_dag_label_repel</span>(<span class="fu">aes</span>(<span class="at">label =</span> label, <span class="at">fill =</span> status), <span class="at">seed =</span> <span class="dv">1234</span>,</span>
<span id="cb25-107"><a href="#cb25-107" aria-hidden="true" tabindex="-1"></a>                       <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb25-108"><a href="#cb25-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> status_colors, <span class="at">na.value =</span> <span class="st">"grey20"</span>) <span class="sc">+</span></span>
<span id="cb25-109"><a href="#cb25-109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> status_colors, <span class="at">na.value =</span> <span class="st">"grey20"</span>) <span class="sc">+</span></span>
<span id="cb25-110"><a href="#cb25-110" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="cn">FALSE</span>, <span class="at">fill =</span> <span class="cn">FALSE</span>) <span class="sc">+</span> </span>
<span id="cb25-111"><a href="#cb25-111" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_dag</span>()</span>
<span id="cb25-112"><a href="#cb25-112" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-113"><a href="#cb25-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-114"><a href="#cb25-114" aria-hidden="true" tabindex="-1"></a><span class="al">![DAG for math camp example](load-libraries-make-dag-1.png)</span></span>
<span id="cb25-115"><a href="#cb25-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-116"><a href="#cb25-116" aria-hidden="true" tabindex="-1"></a>We can tell a fairly complex story using this graph. Your final grade in the program is caused by a host of things, including your quantitative and verbal GRE scores (<span class="co">[</span><span class="ot">PROBABLY DEFINITELY NOT in real life</span><span class="co">](https://www.sciencemag.org/careers/2017/06/gres-dont-predict-grad-school-success-what-does)</span>, but go with it), your undergraduate GPA, and your unmeasured background factors (age, parental income, math anxiety, level of interest in the program, etc.). Your undergraduate GPA is determined by your background, and your GRE scores are determined by both your undergraduate GPA and your background. Because this math camp program is open to anyone, there is self-selection in who chooses to do it. We can pretend that this is decided by your undergraduate GPA, your quantitative GRE score, and your background. If the program was need-based and only offered to people with low GRE scores, we could draw an arrow from GRE quantitative to math camp, but we don’t. Finally, needing the math camp causes people to do it.</span>
<span id="cb25-117"><a href="#cb25-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-118"><a href="#cb25-118" aria-hidden="true" tabindex="-1"></a>There is a direct path between our treatment and outcome (math camp → final grade), but there is also some possible backdoor confounding. Both GRE quantitative and undergraduate GPA have arrows pointing to final grade and math camp (through “needs camp”), which means they’re a common cause, and background is both a confounder *and* unmeasurable. But we don’t need to give up<span class="sc">\!</span> If we adjust or control for “needs camp,” we can block the association between background, GRE quantitative, and undergraduate GPA. With this backdoor closed, we’ve isolated the math camp → final grade relationship and can find the causal effect.</span>
<span id="cb25-119"><a href="#cb25-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-120"><a href="#cb25-120" aria-hidden="true" tabindex="-1"></a>However, we don’t really have a measure for needing math camp—we can’t read peoples’ minds and see if they need the program—so while it’d be great to just include a <span class="in">`needs_camp`</span> variable in a regression model, we’ll have to use other techniques to close the backdoor.</span>
<span id="cb25-121"><a href="#cb25-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-122"><a href="#cb25-122" aria-hidden="true" tabindex="-1"></a>You can find the backdoors automatically with Dagitty (draw the DAG there and notice red arrows between the unblocked confounders), or with functions in the <span class="co">[</span><span class="ot">**dagitty** R package</span><span class="co">](https://cran.r-project.org/package=dagitty)</span>. If you run <span class="in">`paths(math_camp_dag)`</span>, you can see that the only node pointing back into <span class="in">`math_camp`</span> is <span class="in">`needs_camp`</span>, and if you run <span class="in">`adjustmentSets(math_camp_dag)`</span>, you’ll see that <span class="in">`needs_camp`</span> is the only required adjustment set:</span>
<span id="cb25-123"><a href="#cb25-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-124"><a href="#cb25-124" aria-hidden="true" tabindex="-1"></a><span class="in">``` r</span></span>
<span id="cb25-125"><a href="#cb25-125" aria-hidden="true" tabindex="-1"></a><span class="fu">paths</span>(math_camp_dag)</span>
<span id="cb25-126"><a href="#cb25-126" aria-hidden="true" tabindex="-1"></a><span class="do">## $paths</span></span>
<span id="cb25-127"><a href="#cb25-127" aria-hidden="true" tabindex="-1"></a><span class="do">##  [1] "math_camp -&gt; final_grade"</span></span>
<span id="cb25-128"><a href="#cb25-128" aria-hidden="true" tabindex="-1"></a><span class="do">##  [2] "math_camp &lt;- needs_camp &lt;- background -&gt; final_grade"</span></span>
<span id="cb25-129"><a href="#cb25-129" aria-hidden="true" tabindex="-1"></a><span class="do">##  [3] "math_camp &lt;- needs_camp &lt;- background -&gt; gre_quant -&gt; final_grade"</span></span>
<span id="cb25-130"><a href="#cb25-130" aria-hidden="true" tabindex="-1"></a><span class="do">##  [4] "math_camp &lt;- needs_camp &lt;- background -&gt; gre_quant &lt;- undergraduate_gpa -&gt; final_grade"</span></span>
<span id="cb25-131"><a href="#cb25-131" aria-hidden="true" tabindex="-1"></a><span class="do">##  [5] "math_camp &lt;- needs_camp &lt;- background -&gt; gre_quant &lt;- undergraduate_gpa -&gt; gre_verbal -&gt; final_grade"</span></span>
<span id="cb25-132"><a href="#cb25-132" aria-hidden="true" tabindex="-1"></a><span class="do">##  [6] "math_camp &lt;- needs_camp &lt;- background -&gt; gre_verbal -&gt; final_grade"</span></span>
<span id="cb25-133"><a href="#cb25-133" aria-hidden="true" tabindex="-1"></a><span class="do">##  ...</span></span>
<span id="cb25-134"><a href="#cb25-134" aria-hidden="true" tabindex="-1"></a><span class="do">##</span></span>
<span id="cb25-135"><a href="#cb25-135" aria-hidden="true" tabindex="-1"></a><span class="do">## $open</span></span>
<span id="cb25-136"><a href="#cb25-136" aria-hidden="true" tabindex="-1"></a><span class="do">##  [1]  TRUE  TRUE  TRUE FALSE FALSE  TRUE FALSE FALSE  TRUE  TRUE  TRUE</span></span>
<span id="cb25-137"><a href="#cb25-137" aria-hidden="true" tabindex="-1"></a><span class="do">## [12]  TRUE  TRUE  TRUE FALSE  TRUE  TRUE  TRUE  TRUE FALSE  TRUE  TRUE</span></span>
<span id="cb25-138"><a href="#cb25-138" aria-hidden="true" tabindex="-1"></a><span class="do">## [23]  TRUE  TRUE FALSE FALSE  TRUE FALSE FALSE  TRUE  TRUE  TRUE</span></span>
<span id="cb25-139"><a href="#cb25-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-140"><a href="#cb25-140" aria-hidden="true" tabindex="-1"></a><span class="fu">adjustmentSets</span>(math_camp_dag)</span>
<span id="cb25-141"><a href="#cb25-141" aria-hidden="true" tabindex="-1"></a><span class="do">##  { needs_camp }</span></span>
<span id="cb25-142"><a href="#cb25-142" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-143"><a href="#cb25-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-144"><a href="#cb25-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-145"><a href="#cb25-145" aria-hidden="true" tabindex="-1"></a><span class="fu">## Simulated data</span></span>
<span id="cb25-146"><a href="#cb25-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-147"><a href="#cb25-147" aria-hidden="true" tabindex="-1"></a>Assuming this causal graph is correct (it’s probably not, but again, go with it), we can simulate data that reflects these causal relationships. There are a host of R packages for simulating data (like <span class="co">[</span><span class="ot">**wakefield**</span><span class="co">](https://github.com/trinker/wakefield)</span>, <span class="co">[</span><span class="ot">**simstudy**</span><span class="co">](https://www.rdatagen.net/page/simstudy/)</span>, and <span class="co">[</span><span class="ot">**fabricatr**</span><span class="co">](https://declaredesign.org/r/fabricatr/)</span>), but here I do it a little more manually using <span class="in">`MASS::mvrnorm()`</span> to use a <span class="co">[</span><span class="ot">multivariate normal distribution to generate continuous variables that have a specific mean, standard deviation, and relationship with other variables</span><span class="co">](https://stats.stackexchange.com/a/164476/3025)</span>.</span>
<span id="cb25-148"><a href="#cb25-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-149"><a href="#cb25-149" aria-hidden="true" tabindex="-1"></a>Because data generation is beyond the scope of this post, the code below is heavily annotated. Importantly, the various <span class="in">`mutate()`</span> commands that create the <span class="in">`math_camp`</span> data below create relationships between the confounders, treatment, and outcome. We also create a <span class="in">`needs_camp`</span> variable that is true if **both** a student’s quantitative GRE score is less than the average *and* if their undergraduate GPA is less than the average. We also build in some noncompliance: 80% of those who need math camp do it; 20% of those who don’t need it do it.</span>
<span id="cb25-150"><a href="#cb25-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-151"><a href="#cb25-151" aria-hidden="true" tabindex="-1"></a>For the sake of simplicity, the outcome here (<span class="in">`final_grade`</span>) isn’t GPA or anything—it’s an arbitrary number between 120 and 160 (though we could rescale it to something else).</span>
<span id="cb25-152"><a href="#cb25-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-153"><a href="#cb25-153" aria-hidden="true" tabindex="-1"></a>**Most importantly**, we force the math camp program to cause a **10 point increase** in students’ final grades. This is our baseline average treatment effect that we want to be able to find using different backdoor adjustment techniques.</span>
<span id="cb25-154"><a href="#cb25-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-155"><a href="#cb25-155" aria-hidden="true" tabindex="-1"></a><span class="in">``` r</span></span>
<span id="cb25-156"><a href="#cb25-156" aria-hidden="true" tabindex="-1"></a><span class="co"># Make these random draws the same every time</span></span>
<span id="cb25-157"><a href="#cb25-157" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb25-158"><a href="#cb25-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-159"><a href="#cb25-159" aria-hidden="true" tabindex="-1"></a><span class="co"># Create 2,000 rows</span></span>
<span id="cb25-160"><a href="#cb25-160" aria-hidden="true" tabindex="-1"></a>num <span class="ot">&lt;-</span> <span class="dv">2000</span></span>
<span id="cb25-161"><a href="#cb25-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-162"><a href="#cb25-162" aria-hidden="true" tabindex="-1"></a><span class="co"># Create confounder variables that are related to each other</span></span>
<span id="cb25-163"><a href="#cb25-163" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">undergrad_gpa =</span> <span class="dv">3</span>, <span class="at">gre_verbal =</span> <span class="dv">160</span>, <span class="at">gre_quant =</span> <span class="dv">145</span>)</span>
<span id="cb25-164"><a href="#cb25-164" aria-hidden="true" tabindex="-1"></a>stddev <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">undergrad_gpa =</span> <span class="fl">0.5</span>, <span class="at">gre_verbal =</span> <span class="dv">10</span>, <span class="at">gre_quant =</span> <span class="dv">5</span>)</span>
<span id="cb25-165"><a href="#cb25-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-166"><a href="#cb25-166" aria-hidden="true" tabindex="-1"></a><span class="co"># Correlation matrix: undergrad GPA and verbal GRE have a correlation of 0.8;</span></span>
<span id="cb25-167"><a href="#cb25-167" aria-hidden="true" tabindex="-1"></a><span class="co"># undergrad GPA and quantitative GRE have a correlation of 0.6, and verbal GRE</span></span>
<span id="cb25-168"><a href="#cb25-168" aria-hidden="true" tabindex="-1"></a><span class="co"># and quantitative GRE have a correlation of 0.4</span></span>
<span id="cb25-169"><a href="#cb25-169" aria-hidden="true" tabindex="-1"></a>cor_matrix <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="fl">1.0</span>, <span class="fl">0.8</span>, <span class="fl">0.6</span>,</span>
<span id="cb25-170"><a href="#cb25-170" aria-hidden="true" tabindex="-1"></a>                       <span class="fl">0.8</span>, <span class="fl">1.0</span>, <span class="fl">0.4</span>,</span>
<span id="cb25-171"><a href="#cb25-171" aria-hidden="true" tabindex="-1"></a>                       <span class="fl">0.6</span>, <span class="fl">0.4</span>, <span class="fl">1.0</span>),</span>
<span id="cb25-172"><a href="#cb25-172" aria-hidden="true" tabindex="-1"></a>                     <span class="at">ncol =</span> <span class="dv">3</span>)</span>
<span id="cb25-173"><a href="#cb25-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-174"><a href="#cb25-174" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert correlation matrix to covariance matrix using fancy math</span></span>
<span id="cb25-175"><a href="#cb25-175" aria-hidden="true" tabindex="-1"></a>cov_matrix <span class="ot">&lt;-</span> stddev <span class="sc">%*%</span> <span class="fu">t</span>(stddev) <span class="sc">*</span> cor_matrix</span>
<span id="cb25-176"><a href="#cb25-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-177"><a href="#cb25-177" aria-hidden="true" tabindex="-1"></a><span class="co"># Draw random numbers</span></span>
<span id="cb25-178"><a href="#cb25-178" aria-hidden="true" tabindex="-1"></a>confounders <span class="ot">&lt;-</span> MASS<span class="sc">::</span><span class="fu">mvrnorm</span>(<span class="at">n =</span> num, <span class="at">mu =</span> mu, <span class="at">Sigma =</span> cov_matrix, <span class="at">empirical =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-179"><a href="#cb25-179" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb25-180"><a href="#cb25-180" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Truncate values so they're within 130-170 range for GRE and less than 4.0 for GPA</span></span>
<span id="cb25-181"><a href="#cb25-181" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_at</span>(<span class="fu">vars</span>(gre_verbal, gre_quant),</span>
<span id="cb25-182"><a href="#cb25-182" aria-hidden="true" tabindex="-1"></a>            <span class="sc">~</span><span class="fu">case_when</span>(</span>
<span id="cb25-183"><a href="#cb25-183" aria-hidden="true" tabindex="-1"></a>              . <span class="sc">&gt;</span> <span class="dv">170</span> <span class="sc">~</span> <span class="dv">170</span>,</span>
<span id="cb25-184"><a href="#cb25-184" aria-hidden="true" tabindex="-1"></a>              . <span class="sc">&lt;</span> <span class="dv">130</span> <span class="sc">~</span> <span class="dv">130</span>,</span>
<span id="cb25-185"><a href="#cb25-185" aria-hidden="true" tabindex="-1"></a>              <span class="cn">TRUE</span> <span class="sc">~</span> .</span>
<span id="cb25-186"><a href="#cb25-186" aria-hidden="true" tabindex="-1"></a>            )) <span class="sc">%&gt;%</span></span>
<span id="cb25-187"><a href="#cb25-187" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">undergrad_gpa =</span> <span class="fu">ifelse</span>(undergrad_gpa <span class="sc">&gt;</span> <span class="dv">4</span>, <span class="dv">4</span>, undergrad_gpa))</span>
<span id="cb25-188"><a href="#cb25-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-189"><a href="#cb25-189" aria-hidden="true" tabindex="-1"></a><span class="co"># Make official dataset of simulated values</span></span>
<span id="cb25-190"><a href="#cb25-190" aria-hidden="true" tabindex="-1"></a>math_camp <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span>num) <span class="sc">%&gt;%</span></span>
<span id="cb25-191"><a href="#cb25-191" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(confounders) <span class="sc">%&gt;%</span>  <span class="co"># Bring in confounders</span></span>
<span id="cb25-192"><a href="#cb25-192" aria-hidden="true" tabindex="-1"></a>  <span class="co"># People need math camp if their GRE and GPA is lower than the average</span></span>
<span id="cb25-193"><a href="#cb25-193" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">needs_camp =</span> gre_quant <span class="sc">&lt;</span> <span class="fu">mean</span>(gre_quant) <span class="sc">&amp;</span> </span>
<span id="cb25-194"><a href="#cb25-194" aria-hidden="true" tabindex="-1"></a>           undergrad_gpa <span class="sc">&lt;</span> <span class="fu">mean</span>(undergrad_gpa)) <span class="sc">%&gt;%</span></span>
<span id="cb25-195"><a href="#cb25-195" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Build in some noncompliance: 80% of those who need math camp do it; 20% of</span></span>
<span id="cb25-196"><a href="#cb25-196" aria-hidden="true" tabindex="-1"></a>  <span class="co"># those who don't need it do it.</span></span>
<span id="cb25-197"><a href="#cb25-197" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">math_camp =</span> <span class="fu">case_when</span>(</span>
<span id="cb25-198"><a href="#cb25-198" aria-hidden="true" tabindex="-1"></a>    needs_camp <span class="sc">==</span> <span class="cn">TRUE</span> <span class="sc">~</span> <span class="fu">rbinom</span>(<span class="fu">n</span>(), <span class="dv">1</span>, <span class="fl">0.8</span>),</span>
<span id="cb25-199"><a href="#cb25-199" aria-hidden="true" tabindex="-1"></a>    needs_camp <span class="sc">==</span> <span class="cn">FALSE</span> <span class="sc">~</span> <span class="fu">rbinom</span>(<span class="fu">n</span>(), <span class="dv">1</span>, <span class="fl">0.2</span>)</span>
<span id="cb25-200"><a href="#cb25-200" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb25-201"><a href="#cb25-201" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create random error in grades</span></span>
<span id="cb25-202"><a href="#cb25-202" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">grade_noise =</span> <span class="fu">rnorm</span>(num, <span class="dv">15</span>, <span class="dv">5</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb25-203"><a href="#cb25-203" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create final grade based on all the arrows going into the node in the DAG.</span></span>
<span id="cb25-204"><a href="#cb25-204" aria-hidden="true" tabindex="-1"></a>  <span class="co"># There's a 10 point causal effect</span></span>
<span id="cb25-205"><a href="#cb25-205" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">final_grade =</span> (<span class="fl">0.3</span> <span class="sc">*</span> gre_verbal) <span class="sc">+</span> (<span class="fl">0.5</span> <span class="sc">*</span> gre_quant) <span class="sc">+</span> </span>
<span id="cb25-206"><a href="#cb25-206" aria-hidden="true" tabindex="-1"></a>           (<span class="fl">0.4</span> <span class="sc">*</span> undergrad_gpa) <span class="sc">+</span> (<span class="dv">10</span> <span class="sc">*</span> math_camp) <span class="sc">+</span> grade_noise) <span class="sc">%&gt;%</span></span>
<span id="cb25-207"><a href="#cb25-207" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">math_camp =</span> <span class="fu">as.logical</span>(math_camp))  <span class="co"># Make true/false</span></span>
<span id="cb25-208"><a href="#cb25-208" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-209"><a href="#cb25-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-210"><a href="#cb25-210" aria-hidden="true" tabindex="-1"></a>Phew. That’s a lot of code to make fake data, but it worked<span class="sc">\!</span> We can look at the first few rows:</span>
<span id="cb25-211"><a href="#cb25-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-212"><a href="#cb25-212" aria-hidden="true" tabindex="-1"></a><span class="in">``` r</span></span>
<span id="cb25-213"><a href="#cb25-213" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(math_camp)</span>
<span id="cb25-214"><a href="#cb25-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-215"><a href="#cb25-215" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 6 x 8</span></span>
<span id="cb25-216"><a href="#cb25-216" aria-hidden="true" tabindex="-1"></a><span class="do">##      id undergrad_gpa gre_verbal gre_quant needs_camp math_camp grade_noise</span></span>
<span id="cb25-217"><a href="#cb25-217" aria-hidden="true" tabindex="-1"></a><span class="do">##   &lt;int&gt;         &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt; &lt;lgl&gt;      &lt;lgl&gt;           &lt;dbl&gt;</span></span>
<span id="cb25-218"><a href="#cb25-218" aria-hidden="true" tabindex="-1"></a><span class="do">## 1     1          3.90       170       151. FALSE      FALSE            13.5</span></span>
<span id="cb25-219"><a href="#cb25-219" aria-hidden="true" tabindex="-1"></a><span class="do">## 2     2          3.20       163.      143. FALSE      FALSE            13.2</span></span>
<span id="cb25-220"><a href="#cb25-220" aria-hidden="true" tabindex="-1"></a><span class="do">## 3     3          2.83       162.      140. TRUE       TRUE             10.4</span></span>
<span id="cb25-221"><a href="#cb25-221" aria-hidden="true" tabindex="-1"></a><span class="do">## 4     4          2.63       144.      154. FALSE      FALSE            17.0</span></span>
<span id="cb25-222"><a href="#cb25-222" aria-hidden="true" tabindex="-1"></a><span class="do">## 5     5          3.24       170       148. FALSE      FALSE            16.4</span></span>
<span id="cb25-223"><a href="#cb25-223" aria-hidden="true" tabindex="-1"></a><span class="do">## 6     6          2.95       167.      146. FALSE      FALSE            19.0</span></span>
<span id="cb25-224"><a href="#cb25-224" aria-hidden="true" tabindex="-1"></a><span class="do">## # … with 1 more variable: final_grade &lt;dbl&gt;</span></span>
<span id="cb25-225"><a href="#cb25-225" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-226"><a href="#cb25-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-227"><a href="#cb25-227" aria-hidden="true" tabindex="-1"></a>About 40% of the students participated in math camp:</span>
<span id="cb25-228"><a href="#cb25-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-229"><a href="#cb25-229" aria-hidden="true" tabindex="-1"></a><span class="in">``` r</span></span>
<span id="cb25-230"><a href="#cb25-230" aria-hidden="true" tabindex="-1"></a>math_camp <span class="sc">%&gt;%</span> </span>
<span id="cb25-231"><a href="#cb25-231" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(math_camp) <span class="sc">%&gt;%</span> </span>
<span id="cb25-232"><a href="#cb25-232" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prop =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n))</span>
<span id="cb25-233"><a href="#cb25-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-234"><a href="#cb25-234" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 2 x 3</span></span>
<span id="cb25-235"><a href="#cb25-235" aria-hidden="true" tabindex="-1"></a><span class="do">##   math_camp     n  prop</span></span>
<span id="cb25-236"><a href="#cb25-236" aria-hidden="true" tabindex="-1"></a><span class="do">##   &lt;lgl&gt;     &lt;int&gt; &lt;dbl&gt;</span></span>
<span id="cb25-237"><a href="#cb25-237" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 FALSE      1182 0.591</span></span>
<span id="cb25-238"><a href="#cb25-238" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 TRUE        818 0.409</span></span>
<span id="cb25-239"><a href="#cb25-239" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-240"><a href="#cb25-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-241"><a href="#cb25-241" aria-hidden="true" tabindex="-1"></a><span class="fu">## Incorrect “correlation is not causation” estimate</span></span>
<span id="cb25-242"><a href="#cb25-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-243"><a href="#cb25-243" aria-hidden="true" tabindex="-1"></a>We can take an initial stab at finding the causal effect of the program by comparing the average final grades for those who did math camp and those who didn’t. At first glance, it looks like math camp participants have a higher grade<span class="sc">\!</span></span>
<span id="cb25-244"><a href="#cb25-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-245"><a href="#cb25-245" aria-hidden="true" tabindex="-1"></a><span class="in">``` r</span></span>
<span id="cb25-246"><a href="#cb25-246" aria-hidden="true" tabindex="-1"></a>math_camp <span class="sc">%&gt;%</span> </span>
<span id="cb25-247"><a href="#cb25-247" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(math_camp) <span class="sc">%&gt;%</span> </span>
<span id="cb25-248"><a href="#cb25-248" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">avg =</span> <span class="fu">mean</span>(final_grade))</span>
<span id="cb25-249"><a href="#cb25-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-250"><a href="#cb25-250" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 2 x 2</span></span>
<span id="cb25-251"><a href="#cb25-251" aria-hidden="true" tabindex="-1"></a><span class="do">##   math_camp   avg</span></span>
<span id="cb25-252"><a href="#cb25-252" aria-hidden="true" tabindex="-1"></a><span class="do">##   &lt;lgl&gt;     &lt;dbl&gt;</span></span>
<span id="cb25-253"><a href="#cb25-253" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 FALSE      138.</span></span>
<span id="cb25-254"><a href="#cb25-254" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 TRUE       144.</span></span>
<span id="cb25-255"><a href="#cb25-255" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-256"><a href="#cb25-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-257"><a href="#cb25-257" aria-hidden="true" tabindex="-1"></a>The distribution of scores is higher for those who did the program:</span>
<span id="cb25-258"><a href="#cb25-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-259"><a href="#cb25-259" aria-hidden="true" tabindex="-1"></a><span class="in">``` r</span></span>
<span id="cb25-260"><a href="#cb25-260" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(math_camp, <span class="fu">aes</span>(<span class="at">x =</span> final_grade, <span class="at">fill =</span> math_camp)) <span class="sc">+</span></span>
<span id="cb25-261"><a href="#cb25-261" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="dv">2</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span> </span>
<span id="cb25-262"><a href="#cb25-262" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb25-263"><a href="#cb25-263" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(math_camp), <span class="at">ncol =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb25-264"><a href="#cb25-264" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_light</span>()</span>
<span id="cb25-265"><a href="#cb25-265" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-266"><a href="#cb25-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-267"><a href="#cb25-267" aria-hidden="true" tabindex="-1"></a><span class="al">![Naive, wrong distributions](plot-distributions-wrong-1.png)</span></span>
<span id="cb25-268"><a href="#cb25-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-269"><a href="#cb25-269" aria-hidden="true" tabindex="-1"></a>We can run a simple linear regression model to estimate the exact effect:</span>
<span id="cb25-270"><a href="#cb25-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-271"><a href="#cb25-271" aria-hidden="true" tabindex="-1"></a><span class="in">``` r</span></span>
<span id="cb25-272"><a href="#cb25-272" aria-hidden="true" tabindex="-1"></a>model_wrong <span class="ot">&lt;-</span> <span class="fu">lm</span>(final_grade <span class="sc">~</span> math_camp, <span class="at">data =</span> math_camp)</span>
<span id="cb25-273"><a href="#cb25-273" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(model_wrong)</span>
<span id="cb25-274"><a href="#cb25-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-275"><a href="#cb25-275" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 2 x 5</span></span>
<span id="cb25-276"><a href="#cb25-276" aria-hidden="true" tabindex="-1"></a><span class="do">##   term          estimate std.error statistic   p.value</span></span>
<span id="cb25-277"><a href="#cb25-277" aria-hidden="true" tabindex="-1"></a><span class="do">##   &lt;chr&gt;            &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span id="cb25-278"><a href="#cb25-278" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 (Intercept)     138.       0.185     744.  0.       </span></span>
<span id="cb25-279"><a href="#cb25-279" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 math_campTRUE     6.54     0.290      22.6 8.48e-101</span></span>
<span id="cb25-280"><a href="#cb25-280" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-281"><a href="#cb25-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-282"><a href="#cb25-282" aria-hidden="true" tabindex="-1"></a>Based on this model, participating in the program is associated with 6.5 more points in your final grade. Neat.</span>
<span id="cb25-283"><a href="#cb25-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-284"><a href="#cb25-284" aria-hidden="true" tabindex="-1"></a>This is wrong, though, since there are confounders at play that cause both attendance at math camp and final grade. We need to adjust for those to get the actual causal effect.</span>
<span id="cb25-285"><a href="#cb25-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-286"><a href="#cb25-286" aria-hidden="true" tabindex="-1"></a><span class="fu">## Adjustment using forbidden unmeasured variable</span></span>
<span id="cb25-287"><a href="#cb25-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-288"><a href="#cb25-288" aria-hidden="true" tabindex="-1"></a>The backdoor confounder we have to worry about is <span class="in">`needs_camp`</span>. We created this variable when we generated the data, so for fun, we can include it in the regression model as a control variable to adjust for it:</span>
<span id="cb25-289"><a href="#cb25-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-290"><a href="#cb25-290" aria-hidden="true" tabindex="-1"></a><span class="in">``` r</span></span>
<span id="cb25-291"><a href="#cb25-291" aria-hidden="true" tabindex="-1"></a>model_adj_needs_camp <span class="ot">&lt;-</span> <span class="fu">lm</span>(final_grade <span class="sc">~</span> math_camp <span class="sc">+</span> needs_camp, <span class="at">data =</span> math_camp)</span>
<span id="cb25-292"><a href="#cb25-292" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(model_adj_needs_camp)</span>
<span id="cb25-293"><a href="#cb25-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-294"><a href="#cb25-294" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 3 x 5</span></span>
<span id="cb25-295"><a href="#cb25-295" aria-hidden="true" tabindex="-1"></a><span class="do">##   term           estimate std.error statistic   p.value</span></span>
<span id="cb25-296"><a href="#cb25-296" aria-hidden="true" tabindex="-1"></a><span class="do">##   &lt;chr&gt;             &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span id="cb25-297"><a href="#cb25-297" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 (Intercept)      139.       0.174     798.  0.       </span></span>
<span id="cb25-298"><a href="#cb25-298" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 math_campTRUE     10.2      0.320      31.9 2.79e-181</span></span>
<span id="cb25-299"><a href="#cb25-299" aria-hidden="true" tabindex="-1"></a><span class="do">## 3 needs_campTRUE    -6.69     0.329     -20.3 1.28e- 83</span></span>
<span id="cb25-300"><a href="#cb25-300" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-301"><a href="#cb25-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-302"><a href="#cb25-302" aria-hidden="true" tabindex="-1"></a>The coefficient for <span class="in">`math_campTRUE`</span> is now ≈10, which is what it should be<span class="sc">\!</span> Adjusting for needing math camp isolated the causal effect.</span>
<span id="cb25-303"><a href="#cb25-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-304"><a href="#cb25-304" aria-hidden="true" tabindex="-1"></a>But we can’t do that in real life. We don’t know what needing math camp looks like in actual data, so we need to use other techniques.</span>
<span id="cb25-305"><a href="#cb25-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-306"><a href="#cb25-306" aria-hidden="true" tabindex="-1"></a><span class="fu">## Adjustment using educated-guess-based naive matching</span></span>
<span id="cb25-307"><a href="#cb25-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-308"><a href="#cb25-308" aria-hidden="true" tabindex="-1"></a>One possible approach to guessing the need for math camp is to create groups of students based on what we think might be driving the need for camp. We know from the causal model that quantitative GRE scores and undergraduate GPAs partially cause needing the program. We can assume that people with lower test scores or lower GPAs need the camp and create our own guess about what the threshold might be.</span>
<span id="cb25-309"><a href="#cb25-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-310"><a href="#cb25-310" aria-hidden="true" tabindex="-1"></a>Let’s look at the distribution of GRE scores and see if there’s any pattern about why people may have chosen to do the program:</span>
<span id="cb25-311"><a href="#cb25-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-312"><a href="#cb25-312" aria-hidden="true" tabindex="-1"></a><span class="in">``` r</span></span>
<span id="cb25-313"><a href="#cb25-313" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(math_camp, <span class="fu">aes</span>(<span class="at">x =</span> gre_quant, <span class="at">fill =</span> math_camp)) <span class="sc">+</span></span>
<span id="cb25-314"><a href="#cb25-314" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="dv">2</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span> </span>
<span id="cb25-315"><a href="#cb25-315" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb25-316"><a href="#cb25-316" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(math_camp), <span class="at">ncol =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb25-317"><a href="#cb25-317" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_light</span>()</span>
<span id="cb25-318"><a href="#cb25-318" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-319"><a href="#cb25-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-320"><a href="#cb25-320" aria-hidden="true" tabindex="-1"></a><span class="al">![Quantitative GRE score across math camp participation](gre-math-camp-1.png)</span></span>
<span id="cb25-321"><a href="#cb25-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-322"><a href="#cb25-322" aria-hidden="true" tabindex="-1"></a>There’s a pretty noticable break in the distribution of GRE scores for those who did the program: lots of people who scored under 145ish did the program, while not a lot of people who scored over 145 did. Without knowing anything about what completely causes math camp need, we can pretend that 145 is some sort of threshold of need and use that as our confounder:</span>
<span id="cb25-323"><a href="#cb25-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-324"><a href="#cb25-324" aria-hidden="true" tabindex="-1"></a><span class="in">``` r</span></span>
<span id="cb25-325"><a href="#cb25-325" aria-hidden="true" tabindex="-1"></a>math_camp_guessed_need <span class="ot">&lt;-</span> math_camp <span class="sc">%&gt;%</span> </span>
<span id="cb25-326"><a href="#cb25-326" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">maybe_needs_camp =</span> gre_quant <span class="sc">&lt;</span> <span class="dv">145</span>)</span>
<span id="cb25-327"><a href="#cb25-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-328"><a href="#cb25-328" aria-hidden="true" tabindex="-1"></a>model_adj_needs_camp_guess <span class="ot">&lt;-</span> <span class="fu">lm</span>(final_grade <span class="sc">~</span> math_camp <span class="sc">+</span> maybe_needs_camp, </span>
<span id="cb25-329"><a href="#cb25-329" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">data =</span> math_camp_guessed_need)</span>
<span id="cb25-330"><a href="#cb25-330" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(model_adj_needs_camp_guess)</span>
<span id="cb25-331"><a href="#cb25-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-332"><a href="#cb25-332" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 3 x 5</span></span>
<span id="cb25-333"><a href="#cb25-333" aria-hidden="true" tabindex="-1"></a><span class="do">##   term                 estimate std.error statistic   p.value</span></span>
<span id="cb25-334"><a href="#cb25-334" aria-hidden="true" tabindex="-1"></a><span class="do">##   &lt;chr&gt;                   &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span id="cb25-335"><a href="#cb25-335" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 (Intercept)            140.       0.197     708.  0.       </span></span>
<span id="cb25-336"><a href="#cb25-336" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 math_campTRUE            8.70     0.292      29.8 4.41e-162</span></span>
<span id="cb25-337"><a href="#cb25-337" aria-hidden="true" tabindex="-1"></a><span class="do">## 3 maybe_needs_campTRUE    -5.33     0.287     -18.6 2.36e- 71</span></span>
<span id="cb25-338"><a href="#cb25-338" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-339"><a href="#cb25-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-340"><a href="#cb25-340" aria-hidden="true" tabindex="-1"></a>After adjusting for our possible needing camp confounder, the causal effect is now 8.7, which is closer to 10<span class="sc">\!</span> It’s still not entirely correct, but we’re getting closer.</span>
<span id="cb25-341"><a href="#cb25-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-342"><a href="#cb25-342" aria-hidden="true" tabindex="-1"></a><span class="fu">## Brief interlude: Matching + slightly simpler DAG</span></span>
<span id="cb25-343"><a href="#cb25-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-344"><a href="#cb25-344" aria-hidden="true" tabindex="-1"></a>We just attempted to guess what the “needs camp” node might be based on the nodes flowing into it. If you notice, though, the “needs camp” node is an intermediate node on the path between GPA and GRE scores and actually participating in the math camp program. If we can guess what causes people to enroll in the program, that’s roughly the same as predicting their need for the camp.</span>
<span id="cb25-345"><a href="#cb25-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-346"><a href="#cb25-346" aria-hidden="true" tabindex="-1"></a>Additionally, predicting enrollment in the program directly (rather than the desire to enroll) lets us use better matching techniques. Our guess of needing camp was pretty naive—it’d be more accurate if we incorporated other variables (like GPA and background) into our manual grouping. But the intuition of trying to group manually was correct—we looked at the factors that caused needing math camp and guessed that some things make it more likely. We can make this process more formal by building an actual model that predicts the likelihood of treatment.</span>
<span id="cb25-347"><a href="#cb25-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-348"><a href="#cb25-348" aria-hidden="true" tabindex="-1"></a>To do this, we can remove the “needs camp” node, since it wasn’t doing much in the model and since we can use confounders like GPA and quantitative GRE to estimate the probability of enrollment in math camp directly. Here’s a slightly simpler version without “needs camp” and “background”:</span>
<span id="cb25-349"><a href="#cb25-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-350"><a href="#cb25-350" aria-hidden="true" tabindex="-1"></a><span class="in">``` r</span></span>
<span id="cb25-351"><a href="#cb25-351" aria-hidden="true" tabindex="-1"></a>node_details_simpler <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb25-352"><a href="#cb25-352" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>name, <span class="sc">~</span>label, <span class="sc">~</span>x, <span class="sc">~</span>y,</span>
<span id="cb25-353"><a href="#cb25-353" aria-hidden="true" tabindex="-1"></a>  <span class="st">"math_camp"</span>, <span class="st">"Math camp"</span>, <span class="dv">2</span>, <span class="dv">1</span>,</span>
<span id="cb25-354"><a href="#cb25-354" aria-hidden="true" tabindex="-1"></a>  <span class="st">"final_grade"</span>, <span class="st">"Final grade"</span>, <span class="dv">4</span>, <span class="dv">1</span>,</span>
<span id="cb25-355"><a href="#cb25-355" aria-hidden="true" tabindex="-1"></a>  <span class="st">"gre_quant"</span>, <span class="st">"GRE quantitative"</span>, <span class="fl">2.5</span>, <span class="dv">2</span>,</span>
<span id="cb25-356"><a href="#cb25-356" aria-hidden="true" tabindex="-1"></a>  <span class="st">"gre_verbal"</span>, <span class="st">"GRE verbal"</span>, <span class="dv">5</span>, <span class="dv">2</span>,</span>
<span id="cb25-357"><a href="#cb25-357" aria-hidden="true" tabindex="-1"></a>  <span class="st">"undergraduate_gpa"</span>, <span class="st">"Undergraduate GPA"</span>, <span class="dv">4</span>, <span class="dv">3</span></span>
<span id="cb25-358"><a href="#cb25-358" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-359"><a href="#cb25-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-360"><a href="#cb25-360" aria-hidden="true" tabindex="-1"></a>node_labels_simpler <span class="ot">&lt;-</span> node_details_simpler<span class="sc">$</span>label</span>
<span id="cb25-361"><a href="#cb25-361" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(node_labels_simpler) <span class="ot">&lt;-</span> node_details_simpler<span class="sc">$</span>name</span>
<span id="cb25-362"><a href="#cb25-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-363"><a href="#cb25-363" aria-hidden="true" tabindex="-1"></a>math_camp_dag_simpler <span class="ot">&lt;-</span> <span class="fu">dagify</span>(final_grade <span class="sc">~</span> math_camp <span class="sc">+</span> gre_quant <span class="sc">+</span> gre_verbal <span class="sc">+</span> </span>
<span id="cb25-364"><a href="#cb25-364" aria-hidden="true" tabindex="-1"></a>                                  undergraduate_gpa,</span>
<span id="cb25-365"><a href="#cb25-365" aria-hidden="true" tabindex="-1"></a>                                math_camp <span class="sc">~</span> undergraduate_gpa <span class="sc">+</span> gre_quant,</span>
<span id="cb25-366"><a href="#cb25-366" aria-hidden="true" tabindex="-1"></a>                                gre_quant <span class="sc">~</span> undergraduate_gpa,</span>
<span id="cb25-367"><a href="#cb25-367" aria-hidden="true" tabindex="-1"></a>                                gre_verbal <span class="sc">~</span> undergraduate_gpa,</span>
<span id="cb25-368"><a href="#cb25-368" aria-hidden="true" tabindex="-1"></a>                                <span class="at">exposure =</span> <span class="st">"math_camp"</span>,</span>
<span id="cb25-369"><a href="#cb25-369" aria-hidden="true" tabindex="-1"></a>                                <span class="at">outcome =</span> <span class="st">"final_grade"</span>,</span>
<span id="cb25-370"><a href="#cb25-370" aria-hidden="true" tabindex="-1"></a>                                <span class="at">coords =</span> node_details,</span>
<span id="cb25-371"><a href="#cb25-371" aria-hidden="true" tabindex="-1"></a>                                <span class="at">labels =</span> node_labels)</span>
<span id="cb25-372"><a href="#cb25-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-373"><a href="#cb25-373" aria-hidden="true" tabindex="-1"></a><span class="co"># Turn DAG into a tidy data frame for plotting</span></span>
<span id="cb25-374"><a href="#cb25-374" aria-hidden="true" tabindex="-1"></a>math_camp_dag_simpler_tidy <span class="ot">&lt;-</span> math_camp_dag_simpler <span class="sc">%&gt;%</span> </span>
<span id="cb25-375"><a href="#cb25-375" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tidy_dagitty</span>() <span class="sc">%&gt;%</span></span>
<span id="cb25-376"><a href="#cb25-376" aria-hidden="true" tabindex="-1"></a>  <span class="fu">node_status</span>()   <span class="co"># Add column for exposure/outcome</span></span>
<span id="cb25-377"><a href="#cb25-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-378"><a href="#cb25-378" aria-hidden="true" tabindex="-1"></a>status_colors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">exposure =</span> <span class="st">"#0074D9"</span>, <span class="at">outcome =</span> <span class="st">"#FF4136"</span>, <span class="at">latent =</span> <span class="st">"grey50"</span>)</span>
<span id="cb25-379"><a href="#cb25-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-380"><a href="#cb25-380" aria-hidden="true" tabindex="-1"></a><span class="co"># Fancier graph</span></span>
<span id="cb25-381"><a href="#cb25-381" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(math_camp_dag_simpler_tidy, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">xend =</span> xend, <span class="at">yend =</span> yend)) <span class="sc">+</span></span>
<span id="cb25-382"><a href="#cb25-382" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_dag_edges</span>() <span class="sc">+</span></span>
<span id="cb25-383"><a href="#cb25-383" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_dag_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> status)) <span class="sc">+</span></span>
<span id="cb25-384"><a href="#cb25-384" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_dag_label_repel</span>(<span class="fu">aes</span>(<span class="at">label =</span> label, <span class="at">fill =</span> status), <span class="at">seed =</span> <span class="dv">1234</span>,</span>
<span id="cb25-385"><a href="#cb25-385" aria-hidden="true" tabindex="-1"></a>                       <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb25-386"><a href="#cb25-386" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> status_colors, <span class="at">na.value =</span> <span class="st">"grey20"</span>) <span class="sc">+</span></span>
<span id="cb25-387"><a href="#cb25-387" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> status_colors, <span class="at">na.value =</span> <span class="st">"grey20"</span>) <span class="sc">+</span></span>
<span id="cb25-388"><a href="#cb25-388" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="cn">FALSE</span>, <span class="at">fill =</span> <span class="cn">FALSE</span>) <span class="sc">+</span> </span>
<span id="cb25-389"><a href="#cb25-389" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_dag</span>()</span>
<span id="cb25-390"><a href="#cb25-390" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-391"><a href="#cb25-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-392"><a href="#cb25-392" aria-hidden="true" tabindex="-1"></a><span class="al">![Simpler math camp DAG](simpler-dag-1.png)</span></span>
<span id="cb25-393"><a href="#cb25-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-394"><a href="#cb25-394" aria-hidden="true" tabindex="-1"></a><span class="fu">## Adjustment using inverse probability weighting (IPW)</span></span>
<span id="cb25-395"><a href="#cb25-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-396"><a href="#cb25-396" aria-hidden="true" tabindex="-1"></a>One common method for matching the assignment to treatment based on confounders that is quite popular in epidemiology is to use inverse probability weighting (IPW). To estimate causal effects with IPW, we follow a two-step process. In the first step, we use the confounders to estimate propensity scores for each observation, or the probability of that observation going to math camp given other characteristics.</span>
<span id="cb25-397"><a href="#cb25-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-398"><a href="#cb25-398" aria-hidden="true" tabindex="-1"></a>A common way to generate propensity scores is to use logistic regression. Here we build a model estimating participation in math camp based on undergraduate GPA and quantitative GRE scores. We then use <span class="in">`augment()`</span> to plug the GPA and GRE values for each observation into the model and generate a predicted probability:</span>
<span id="cb25-399"><a href="#cb25-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-400"><a href="#cb25-400" aria-hidden="true" tabindex="-1"></a><span class="in">``` r</span></span>
<span id="cb25-401"><a href="#cb25-401" aria-hidden="true" tabindex="-1"></a>needs_camp_model <span class="ot">&lt;-</span> <span class="fu">glm</span>(math_camp <span class="sc">~</span> undergrad_gpa <span class="sc">+</span> gre_quant, <span class="at">data =</span> math_camp, </span>
<span id="cb25-402"><a href="#cb25-402" aria-hidden="true" tabindex="-1"></a>                        <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span>
<span id="cb25-403"><a href="#cb25-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-404"><a href="#cb25-404" aria-hidden="true" tabindex="-1"></a>math_camp_propensities <span class="ot">&lt;-</span> <span class="fu">augment</span>(needs_camp_model, math_camp, <span class="at">type.predict =</span> <span class="st">"response"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-405"><a href="#cb25-405" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p_camp =</span> .fitted)  <span class="co"># Rename column</span></span>
<span id="cb25-406"><a href="#cb25-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-407"><a href="#cb25-407" aria-hidden="true" tabindex="-1"></a>math_camp_propensities <span class="sc">%&gt;%</span> </span>
<span id="cb25-408"><a href="#cb25-408" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id, undergrad_gpa, gre_quant, math_camp, p_camp) <span class="sc">%&gt;%</span> </span>
<span id="cb25-409"><a href="#cb25-409" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>()</span>
<span id="cb25-410"><a href="#cb25-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-411"><a href="#cb25-411" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 6 x 5</span></span>
<span id="cb25-412"><a href="#cb25-412" aria-hidden="true" tabindex="-1"></a><span class="do">##      id undergrad_gpa gre_quant math_camp p_camp</span></span>
<span id="cb25-413"><a href="#cb25-413" aria-hidden="true" tabindex="-1"></a><span class="do">##   &lt;int&gt;         &lt;dbl&gt;     &lt;dbl&gt; &lt;lgl&gt;      &lt;dbl&gt;</span></span>
<span id="cb25-414"><a href="#cb25-414" aria-hidden="true" tabindex="-1"></a><span class="do">## 1     1          3.90      151. FALSE     0.0969</span></span>
<span id="cb25-415"><a href="#cb25-415" aria-hidden="true" tabindex="-1"></a><span class="do">## 2     2          3.20      143. FALSE     0.371 </span></span>
<span id="cb25-416"><a href="#cb25-416" aria-hidden="true" tabindex="-1"></a><span class="do">## 3     3          2.83      140. TRUE      0.554 </span></span>
<span id="cb25-417"><a href="#cb25-417" aria-hidden="true" tabindex="-1"></a><span class="do">## 4     4          2.63      154. FALSE     0.291 </span></span>
<span id="cb25-418"><a href="#cb25-418" aria-hidden="true" tabindex="-1"></a><span class="do">## 5     5          3.24      148. FALSE     0.258 </span></span>
<span id="cb25-419"><a href="#cb25-419" aria-hidden="true" tabindex="-1"></a><span class="do">## 6     6          2.95      146. FALSE     0.371</span></span>
<span id="cb25-420"><a href="#cb25-420" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-421"><a href="#cb25-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-422"><a href="#cb25-422" aria-hidden="true" tabindex="-1"></a>We have a new column <span class="in">`p_camp`</span> that shows the probability of going to camp based on grades and test scores. Our first person has a high GPA and high GRE score, so they have a 9% chance of going to math camp, while person 3 has a low GPA and low test score, so they’re more likely to need it.</span>
<span id="cb25-423"><a href="#cb25-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-424"><a href="#cb25-424" aria-hidden="true" tabindex="-1"></a>In the second step, we incorporate these predicted probabilities into our causal effect estimation by converting them into weights, which creates a pseduo-population of observations (i.e.&nbsp;some student observations are more important than others for estimating the causal effect). What this means practically is that people with a low likelihood of attending math camp who *do* attend it anyway should be treated as more important than those who follow expectations, since those with higher weights are more likely to influence the overall causal effect.</span>
<span id="cb25-425"><a href="#cb25-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-426"><a href="#cb25-426" aria-hidden="true" tabindex="-1"></a>There are a whole bunch of different weighting techniques, and <span class="co">[</span><span class="ot">Lucy D’Agostino McGowan</span><span class="co">](https://livefreeordichotomize.com/)</span> covers them in depth <span class="co">[</span><span class="ot">in her excellent blog post here</span><span class="co">](https://livefreeordichotomize.com/2019/01/17/understanding-propensity-score-weighting/)</span> (see also <span class="co">[</span><span class="ot">this</span><span class="co">](https://www.rdatagen.net/post/potential-outcomes-confounding/)</span>). For the sake of this example, we’ll calculate weights that are appropriate for estimating two different causal quantities. Here, $i$ represents an individual student, $e_i$ represents the propensity score for an individual needing/participating in math camp, or the treatment $Z_i$:</span>
<span id="cb25-427"><a href="#cb25-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-428"><a href="#cb25-428" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Average treatment effect (ATE): overall average effect, or the difference in potential outcomes when the Z = 1 and Z = 0. Formula for weights: $\frac{Z_i}{e_i} + \frac{1 - Z_i}{1 - e_i}$</span>
<span id="cb25-429"><a href="#cb25-429" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Average treatment effect among the overlap population (ATO): effect of math camp across observations that overlap (i.e.&nbsp;those who are both likely and unlikely to need math camp). Formula for weights: $(1-e_i)Z_i + e_i(1-Z_i)$</span>
<span id="cb25-430"><a href="#cb25-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-431"><a href="#cb25-431" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- end list --&gt;</span></span>
<span id="cb25-432"><a href="#cb25-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-433"><a href="#cb25-433" aria-hidden="true" tabindex="-1"></a><span class="in">``` r</span></span>
<span id="cb25-434"><a href="#cb25-434" aria-hidden="true" tabindex="-1"></a>math_camp_propensities <span class="ot">&lt;-</span> math_camp_propensities <span class="sc">%&gt;%</span> </span>
<span id="cb25-435"><a href="#cb25-435" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">w_ate =</span> (math_camp <span class="sc">/</span> p_camp) <span class="sc">+</span> ((<span class="dv">1</span> <span class="sc">-</span> math_camp) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> p_camp)),</span>
<span id="cb25-436"><a href="#cb25-436" aria-hidden="true" tabindex="-1"></a>         <span class="at">w_ato =</span> (<span class="dv">1</span> <span class="sc">-</span> p_camp) <span class="sc">*</span> math_camp <span class="sc">+</span> p_camp <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> math_camp))</span>
<span id="cb25-437"><a href="#cb25-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-438"><a href="#cb25-438" aria-hidden="true" tabindex="-1"></a>math_camp_propensities <span class="sc">%&gt;%</span> </span>
<span id="cb25-439"><a href="#cb25-439" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id, p_camp, w_ate, w_ato) <span class="sc">%&gt;%</span> </span>
<span id="cb25-440"><a href="#cb25-440" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>()</span>
<span id="cb25-441"><a href="#cb25-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-442"><a href="#cb25-442" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 6 x 4</span></span>
<span id="cb25-443"><a href="#cb25-443" aria-hidden="true" tabindex="-1"></a><span class="do">##      id p_camp w_ate  w_ato</span></span>
<span id="cb25-444"><a href="#cb25-444" aria-hidden="true" tabindex="-1"></a><span class="do">##   &lt;int&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span id="cb25-445"><a href="#cb25-445" aria-hidden="true" tabindex="-1"></a><span class="do">## 1     1 0.0969  1.11 0.0969</span></span>
<span id="cb25-446"><a href="#cb25-446" aria-hidden="true" tabindex="-1"></a><span class="do">## 2     2 0.371   1.59 0.371 </span></span>
<span id="cb25-447"><a href="#cb25-447" aria-hidden="true" tabindex="-1"></a><span class="do">## 3     3 0.554   1.80 0.446 </span></span>
<span id="cb25-448"><a href="#cb25-448" aria-hidden="true" tabindex="-1"></a><span class="do">## 4     4 0.291   1.41 0.291 </span></span>
<span id="cb25-449"><a href="#cb25-449" aria-hidden="true" tabindex="-1"></a><span class="do">## 5     5 0.258   1.35 0.258 </span></span>
<span id="cb25-450"><a href="#cb25-450" aria-hidden="true" tabindex="-1"></a><span class="do">## 6     6 0.371   1.59 0.371</span></span>
<span id="cb25-451"><a href="#cb25-451" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-452"><a href="#cb25-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-453"><a href="#cb25-453" aria-hidden="true" tabindex="-1"></a>Finally, we can incorporate these weights into a regression model. Note how we’re using <span class="in">`math_camp`</span> as the only explanatory variable. Because we used undergraduate GPA and quantitative GRE scores to estimate the propensity scores for needing camp (and receiving the program), including the weights should be enough to close the “needs camp” back door:</span>
<span id="cb25-454"><a href="#cb25-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-455"><a href="#cb25-455" aria-hidden="true" tabindex="-1"></a><span class="in">``` r</span></span>
<span id="cb25-456"><a href="#cb25-456" aria-hidden="true" tabindex="-1"></a>model_ipw_ate <span class="ot">&lt;-</span> <span class="fu">lm</span>(final_grade <span class="sc">~</span> math_camp, </span>
<span id="cb25-457"><a href="#cb25-457" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> math_camp_propensities, <span class="at">weights =</span> w_ate)</span>
<span id="cb25-458"><a href="#cb25-458" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(model_ipw_ate)</span>
<span id="cb25-459"><a href="#cb25-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-460"><a href="#cb25-460" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 2 x 5</span></span>
<span id="cb25-461"><a href="#cb25-461" aria-hidden="true" tabindex="-1"></a><span class="do">##   term          estimate std.error statistic   p.value</span></span>
<span id="cb25-462"><a href="#cb25-462" aria-hidden="true" tabindex="-1"></a><span class="do">##   &lt;chr&gt;            &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span id="cb25-463"><a href="#cb25-463" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 (Intercept)      137.      0.222     614.  0.       </span></span>
<span id="cb25-464"><a href="#cb25-464" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 math_campTRUE     10.9     0.308      35.3 8.75e-213</span></span>
<span id="cb25-465"><a href="#cb25-465" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-466"><a href="#cb25-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-467"><a href="#cb25-467" aria-hidden="true" tabindex="-1"></a><span class="in">``` r</span></span>
<span id="cb25-468"><a href="#cb25-468" aria-hidden="true" tabindex="-1"></a>model_ipw_ato <span class="ot">&lt;-</span> <span class="fu">lm</span>(final_grade <span class="sc">~</span> math_camp, </span>
<span id="cb25-469"><a href="#cb25-469" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> math_camp_propensities, <span class="at">weights =</span> w_ato)</span>
<span id="cb25-470"><a href="#cb25-470" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(model_ipw_ato)</span>
<span id="cb25-471"><a href="#cb25-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-472"><a href="#cb25-472" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 2 x 5</span></span>
<span id="cb25-473"><a href="#cb25-473" aria-hidden="true" tabindex="-1"></a><span class="do">##   term          estimate std.error statistic   p.value</span></span>
<span id="cb25-474"><a href="#cb25-474" aria-hidden="true" tabindex="-1"></a><span class="do">##   &lt;chr&gt;            &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span id="cb25-475"><a href="#cb25-475" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 (Intercept)      136.      0.203     672.  0.       </span></span>
<span id="cb25-476"><a href="#cb25-476" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 math_campTRUE     10.0     0.286      35.0 1.02e-209</span></span>
<span id="cb25-477"><a href="#cb25-477" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-478"><a href="#cb25-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-479"><a href="#cb25-479" aria-hidden="true" tabindex="-1"></a>Both of these causal estimates are pretty spot on, with the ATO providing an answer incredibly close to the true value of 10. Neat<span class="sc">\!</span></span>
<span id="cb25-480"><a href="#cb25-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-481"><a href="#cb25-481" aria-hidden="true" tabindex="-1"></a>If we had other backdoors to adjust for, we could include them in the propensity score model as well. We can do all our backdoor adjustment in the logit model, generate propensity scores, generate inverse probability weights, and then use the weights in a simple regression model to find the actual causal effect.</span>
<span id="cb25-482"><a href="#cb25-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-483"><a href="#cb25-483" aria-hidden="true" tabindex="-1"></a><span class="fu">## Adjustment using matching (with Mahalanobis distance)</span></span>
<span id="cb25-484"><a href="#cb25-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-485"><a href="#cb25-485" aria-hidden="true" tabindex="-1"></a>We can use other methods to find matches in the data to estimate the probability of attending math camp. There’s a whole world of other statistical methods for creating matches; inverse probability weights are just one method.</span>
<span id="cb25-486"><a href="#cb25-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-487"><a href="#cb25-487" aria-hidden="true" tabindex="-1"></a>While matching based on propensity scores (i.e.&nbsp;building some model to generate predicted probabilities for the likelihood of treatment and matching observations that have similar propensities) is popular, it can cause problems when you use it for causal identification. Following <span class="co">[</span><span class="ot">Gary King’s suggestions</span><span class="co">](https://www.youtube.com/watch?v=rBv39pK1iEs)</span>, we can match with other techniques. (Again, covering what all these do goes beyond the scope of this post, but there are some excellent resources out there, like <span class="co">[</span><span class="ot">this highly accessible video by Gary King</span><span class="co">](https://www.youtube.com/watch?v=rBv39pK1iEs)</span>.)</span>
<span id="cb25-488"><a href="#cb25-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-489"><a href="#cb25-489" aria-hidden="true" tabindex="-1"></a>One popular technique in political science is to match based on <span class="co">[</span><span class="ot">Mahalanobis</span><span class="co">](https://en.wikipedia.org/wiki/Mahalanobis_distance)</span> (or <span class="co">[</span><span class="ot">Euclidean</span><span class="co">](https://en.wikipedia.org/wiki/Euclidean_distance)</span>) distance. We can use <span class="in">`matchit()`</span> from the **MatchIt** library to group students with similar needs. Instead of creating a new grouping variable like we did before for <span class="in">`needs_camp`</span>, because we know that undergrad GPA and quantitative GRE scores cause needing math camp, and that needing math camp is the only path into actually doing the program, we can model the probability of treatment by using undergrad GPA and quantitative GRE.</span>
<span id="cb25-490"><a href="#cb25-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-491"><a href="#cb25-491" aria-hidden="true" tabindex="-1"></a><span class="in">``` r</span></span>
<span id="cb25-492"><a href="#cb25-492" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MatchIt)  <span class="co"># For matching stuff</span></span>
<span id="cb25-493"><a href="#cb25-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-494"><a href="#cb25-494" aria-hidden="true" tabindex="-1"></a>matched <span class="ot">&lt;-</span> <span class="fu">matchit</span>(math_camp <span class="sc">~</span> undergrad_gpa <span class="sc">+</span> gre_quant, <span class="at">data =</span> math_camp,</span>
<span id="cb25-495"><a href="#cb25-495" aria-hidden="true" tabindex="-1"></a>                   <span class="at">method =</span> <span class="st">"nearest"</span>, <span class="at">distance =</span> <span class="st">"mahalanobis"</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb25-496"><a href="#cb25-496" aria-hidden="true" tabindex="-1"></a>matched</span>
<span id="cb25-497"><a href="#cb25-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-498"><a href="#cb25-498" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb25-499"><a href="#cb25-499" aria-hidden="true" tabindex="-1"></a><span class="do">## Call: </span></span>
<span id="cb25-500"><a href="#cb25-500" aria-hidden="true" tabindex="-1"></a><span class="do">## matchit(formula = math_camp ~ undergrad_gpa + gre_quant, data = math_camp, </span></span>
<span id="cb25-501"><a href="#cb25-501" aria-hidden="true" tabindex="-1"></a><span class="do">##     method = "nearest", distance = "mahalanobis", replace = TRUE)</span></span>
<span id="cb25-502"><a href="#cb25-502" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb25-503"><a href="#cb25-503" aria-hidden="true" tabindex="-1"></a><span class="do">## Sample sizes:</span></span>
<span id="cb25-504"><a href="#cb25-504" aria-hidden="true" tabindex="-1"></a><span class="do">##           Control Treated</span></span>
<span id="cb25-505"><a href="#cb25-505" aria-hidden="true" tabindex="-1"></a><span class="do">## All          1182     818</span></span>
<span id="cb25-506"><a href="#cb25-506" aria-hidden="true" tabindex="-1"></a><span class="do">## Matched       366     818</span></span>
<span id="cb25-507"><a href="#cb25-507" aria-hidden="true" tabindex="-1"></a><span class="do">## Unmatched     816       0</span></span>
<span id="cb25-508"><a href="#cb25-508" aria-hidden="true" tabindex="-1"></a><span class="do">## Discarded       0       0</span></span>
<span id="cb25-509"><a href="#cb25-509" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-510"><a href="#cb25-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-511"><a href="#cb25-511" aria-hidden="true" tabindex="-1"></a>By matching this way, we found 366 people who didn’t do math camp who look similar to those who did, which means we can arguably say that those who didn’t do it didn’t need to. If we want, we can see which observations were matched:</span>
<span id="cb25-512"><a href="#cb25-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-513"><a href="#cb25-513" aria-hidden="true" tabindex="-1"></a><span class="in">``` r</span></span>
<span id="cb25-514"><a href="#cb25-514" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(matched<span class="sc">$</span>match.matrix)</span>
<span id="cb25-515"><a href="#cb25-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-516"><a href="#cb25-516" aria-hidden="true" tabindex="-1"></a><span class="do">##    1     </span></span>
<span id="cb25-517"><a href="#cb25-517" aria-hidden="true" tabindex="-1"></a><span class="do">## 3  "1864"</span></span>
<span id="cb25-518"><a href="#cb25-518" aria-hidden="true" tabindex="-1"></a><span class="do">## 7  "646" </span></span>
<span id="cb25-519"><a href="#cb25-519" aria-hidden="true" tabindex="-1"></a><span class="do">## 9  "586" </span></span>
<span id="cb25-520"><a href="#cb25-520" aria-hidden="true" tabindex="-1"></a><span class="do">## 12 "83"  </span></span>
<span id="cb25-521"><a href="#cb25-521" aria-hidden="true" tabindex="-1"></a><span class="do">## 15 "244" </span></span>
<span id="cb25-522"><a href="#cb25-522" aria-hidden="true" tabindex="-1"></a><span class="do">## 20 "1815"</span></span>
<span id="cb25-523"><a href="#cb25-523" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-524"><a href="#cb25-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-525"><a href="#cb25-525" aria-hidden="true" tabindex="-1"></a>And we can extract the details from the match:</span>
<span id="cb25-526"><a href="#cb25-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-527"><a href="#cb25-527" aria-hidden="true" tabindex="-1"></a><span class="in">``` r</span></span>
<span id="cb25-528"><a href="#cb25-528" aria-hidden="true" tabindex="-1"></a>math_camp_matched <span class="ot">&lt;-</span> <span class="fu">match.data</span>(matched)</span>
<span id="cb25-529"><a href="#cb25-529" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(math_camp_matched)</span>
<span id="cb25-530"><a href="#cb25-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-531"><a href="#cb25-531" aria-hidden="true" tabindex="-1"></a><span class="do">##    id undergrad_gpa gre_verbal gre_quant needs_camp math_camp grade_noise</span></span>
<span id="cb25-532"><a href="#cb25-532" aria-hidden="true" tabindex="-1"></a><span class="do">## 3   3      2.828828   161.6843  140.4169       TRUE      TRUE    10.37564</span></span>
<span id="cb25-533"><a href="#cb25-533" aria-hidden="true" tabindex="-1"></a><span class="do">## 5   5      3.244684   170.0000  147.9607      FALSE     FALSE    16.40707</span></span>
<span id="cb25-534"><a href="#cb25-534" aria-hidden="true" tabindex="-1"></a><span class="do">## 7   7      3.757950   170.0000  151.4425      FALSE      TRUE    24.01470</span></span>
<span id="cb25-535"><a href="#cb25-535" aria-hidden="true" tabindex="-1"></a><span class="do">## 9   9      3.085583   162.4533  149.3013      FALSE      TRUE    21.00359</span></span>
<span id="cb25-536"><a href="#cb25-536" aria-hidden="true" tabindex="-1"></a><span class="do">## 12 12      3.300517   167.0163  152.7640      FALSE      TRUE    15.10616</span></span>
<span id="cb25-537"><a href="#cb25-537" aria-hidden="true" tabindex="-1"></a><span class="do">## 15 15      3.809366   170.0000  141.3918      FALSE      TRUE    12.68628</span></span>
<span id="cb25-538"><a href="#cb25-538" aria-hidden="true" tabindex="-1"></a><span class="do">##    final_grade distance   weights</span></span>
<span id="cb25-539"><a href="#cb25-539" aria-hidden="true" tabindex="-1"></a><span class="do">## 3     140.2209       NA 1.0000000</span></span>
<span id="cb25-540"><a href="#cb25-540" aria-hidden="true" tabindex="-1"></a><span class="do">## 5     142.6853       NA 0.4474328</span></span>
<span id="cb25-541"><a href="#cb25-541" aria-hidden="true" tabindex="-1"></a><span class="do">## 7     162.2392       NA 1.0000000</span></span>
<span id="cb25-542"><a href="#cb25-542" aria-hidden="true" tabindex="-1"></a><span class="do">## 9     155.6245       NA 1.0000000</span></span>
<span id="cb25-543"><a href="#cb25-543" aria-hidden="true" tabindex="-1"></a><span class="do">## 12    152.9133       NA 1.0000000</span></span>
<span id="cb25-544"><a href="#cb25-544" aria-hidden="true" tabindex="-1"></a><span class="do">## 15    145.9059       NA 1.0000000</span></span>
<span id="cb25-545"><a href="#cb25-545" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-546"><a href="#cb25-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-547"><a href="#cb25-547" aria-hidden="true" tabindex="-1"></a>We have one new column in this data: <span class="in">`weights`</span>. Observations are now weighted differently based on how distant they are from their matches—observations who attended math camp that are similar to those who didn’t have a higher weight. This weighting creates a pseudo-population of students (i.e.&nbsp;some student observations are more important than others for estimating the causal effect), just like we did with IPW.</span>
<span id="cb25-548"><a href="#cb25-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-549"><a href="#cb25-549" aria-hidden="true" tabindex="-1"></a>We can incorporate these weights into a regression model. Note how we’re using <span class="in">`math_camp`</span> as the only explanatory variable. Because we used matching to guess the likelihood of needing camp (and receiving the program), including the weights should be enough to close the “needs camp” back door:</span>
<span id="cb25-550"><a href="#cb25-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-551"><a href="#cb25-551" aria-hidden="true" tabindex="-1"></a><span class="in">``` r</span></span>
<span id="cb25-552"><a href="#cb25-552" aria-hidden="true" tabindex="-1"></a>model_matched <span class="ot">&lt;-</span> <span class="fu">lm</span>(final_grade <span class="sc">~</span> math_camp, <span class="at">data =</span> math_camp_matched, <span class="at">weights =</span> weights)</span>
<span id="cb25-553"><a href="#cb25-553" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(model_matched)</span>
<span id="cb25-554"><a href="#cb25-554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-555"><a href="#cb25-555" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 2 x 5</span></span>
<span id="cb25-556"><a href="#cb25-556" aria-hidden="true" tabindex="-1"></a><span class="do">##   term          estimate std.error statistic   p.value</span></span>
<span id="cb25-557"><a href="#cb25-557" aria-hidden="true" tabindex="-1"></a><span class="do">##   &lt;chr&gt;            &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span id="cb25-558"><a href="#cb25-558" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 (Intercept)      134.      0.338     398.  0.       </span></span>
<span id="cb25-559"><a href="#cb25-559" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 math_campTRUE     10.0     0.407      24.7 7.68e-109</span></span>
<span id="cb25-560"><a href="#cb25-560" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-561"><a href="#cb25-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-562"><a href="#cb25-562" aria-hidden="true" tabindex="-1"></a>And look at that<span class="sc">\!</span> The coefficient for <span class="in">`math_campTRUE`</span> is 10, which is what the true causal effect is.</span>
<span id="cb25-563"><a href="#cb25-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-564"><a href="#cb25-564" aria-hidden="true" tabindex="-1"></a>Matching with Mahalanobis distance isn’t the only technique available—depending on the context of your actual data (and how complicated you want to get), you could use other algorithms like coarsened exact matching (CEM), optimal matching, or other techniques included in the **MatchIt** package.</span>
<span id="cb25-565"><a href="#cb25-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-566"><a href="#cb25-566" aria-hidden="true" tabindex="-1"></a>One potential downside to matching is that it throws away data. Notice how there are only 1,184 rows in the <span class="in">`math_camp_matched`</span> dataset, while using inverse probability weights let us use the full 2,000 rows in the original data.</span>
<span id="cb25-567"><a href="#cb25-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-568"><a href="#cb25-568" aria-hidden="true" tabindex="-1"></a><span class="fu">## Someday when I’m smarter: *do*-calculus</span></span>
<span id="cb25-569"><a href="#cb25-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-570"><a href="#cb25-570" aria-hidden="true" tabindex="-1"></a>Finally, Judea Pearl’s most important contribution to the world of causal inference is a <span class="co">[</span><span class="ot">complete set of three axioms</span><span class="co">](https://plato.stanford.edu/entries/causal-models/do-calculus.html)</span> (or rules) that allow us to convert equations with a $do(\cdot)$ operator into something estimatable with observational data.</span>
<span id="cb25-571"><a href="#cb25-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-572"><a href="#cb25-572" aria-hidden="true" tabindex="-1"></a>*Very* briefly, the *do* operator lets us define interventions (like programs and policies) in mathematical formulas. For instance, in our ongoing example, we’re interested in $Pr(\text{Grade} | do(\text{Math camp}))$, or the probability distribution of final grades given that someone *does* math camp. Math camp is an intervention, and in a randomized controlled trial, we’d be able to control who got to *do* it, and thereby estimate the causal effect.</span>
<span id="cb25-573"><a href="#cb25-573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-574"><a href="#cb25-574" aria-hidden="true" tabindex="-1"></a>Given observational data, though, we’re left only with the ability to calculate $Pr(\text{Grade} | \text{Math camp})$, or the probability distribution of final grades given math camp. Because there’s no $do(\cdot)$ here, we can’t isolate the effect entirely if there are confounders like GRE and GPA. We tried that earlier in the “correlation isn’t causation” section and found an incorrect program effect.</span>
<span id="cb25-575"><a href="#cb25-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-576"><a href="#cb25-576" aria-hidden="true" tabindex="-1"></a>The three rules of Pearl’s *do*-calculus allows us to chop up causal diagrams in systematic ways that can remove the $do(\cdot)$. The reason closing backdoors by adjusting for confounders works is because the approach follows one of the *do*-calculus rules that removes $do(\cdot)$ from $Pr(\text{Grade} | do(\text{Math camp}))$. For instance (and apologies for using X, Y, and Z instead of actual variables<span class="sc">\!</span>), in a DAG with one confounder (Z)…</span>
<span id="cb25-577"><a href="#cb25-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-578"><a href="#cb25-578" aria-hidden="true" tabindex="-1"></a><span class="in">``` r</span></span>
<span id="cb25-579"><a href="#cb25-579" aria-hidden="true" tabindex="-1"></a>backdoor_dag <span class="ot">&lt;-</span> <span class="fu">dagify</span>(Y <span class="sc">~</span> X <span class="sc">+</span> Z,</span>
<span id="cb25-580"><a href="#cb25-580" aria-hidden="true" tabindex="-1"></a>                       X <span class="sc">~</span> Z,</span>
<span id="cb25-581"><a href="#cb25-581" aria-hidden="true" tabindex="-1"></a>                       <span class="at">exposure =</span> <span class="st">"X"</span>,</span>
<span id="cb25-582"><a href="#cb25-582" aria-hidden="true" tabindex="-1"></a>                       <span class="at">outcome =</span> <span class="st">"Y"</span>,</span>
<span id="cb25-583"><a href="#cb25-583" aria-hidden="true" tabindex="-1"></a>                       <span class="at">coords =</span> <span class="fu">list</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="at">X =</span> <span class="dv">1</span>, <span class="at">Y =</span> <span class="dv">3</span>, <span class="at">Z =</span> <span class="dv">2</span>),</span>
<span id="cb25-584"><a href="#cb25-584" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">y =</span> <span class="fu">c</span>(<span class="at">X =</span> <span class="dv">1</span>, <span class="at">Y =</span> <span class="dv">1</span>, <span class="at">Z =</span> <span class="dv">2</span>)))</span>
<span id="cb25-585"><a href="#cb25-585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-586"><a href="#cb25-586" aria-hidden="true" tabindex="-1"></a><span class="fu">ggdag</span>(backdoor_dag) <span class="sc">+</span> </span>
<span id="cb25-587"><a href="#cb25-587" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_dag</span>()</span>
<span id="cb25-588"><a href="#cb25-588" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-589"><a href="#cb25-589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-590"><a href="#cb25-590" aria-hidden="true" tabindex="-1"></a><span class="al">![Tiny XYZ DAG](do-calculus-tiny-dag-1.png)</span></span>
<span id="cb25-591"><a href="#cb25-591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-592"><a href="#cb25-592" aria-hidden="true" tabindex="-1"></a>…the *do*-calculus version of backdoor adjustment is:</span>
<span id="cb25-593"><a href="#cb25-593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-594"><a href="#cb25-594" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb25-595"><a href="#cb25-595" aria-hidden="true" tabindex="-1"></a>P(Y | do(X)) = \sum_Z P(Y | X, Z) \times P(Z)</span>
<span id="cb25-596"><a href="#cb25-596" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb25-597"><a href="#cb25-597" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-598"><a href="#cb25-598" aria-hidden="true" tabindex="-1"></a>In other words, we can remove the $do(\cdot)$ if we multiply the probability distribution of Y given both X and Z by the probability distribution of Z, and then add all those values up for every value of Z. If X, Y, and Z were all binary, we’d be able to write the $do$-free version of the causal effect like this:</span>
<span id="cb25-599"><a href="#cb25-599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-600"><a href="#cb25-600" aria-hidden="true" tabindex="-1"></a><span class="in">``` r</span></span>
<span id="cb25-601"><a href="#cb25-601" aria-hidden="true" tabindex="-1"></a><span class="co"># P(y|do(x=1)) = P(y|x=1, z=1)*P(z=1) + P(y|x=1, z=0)*P(z=0)</span></span>
<span id="cb25-602"><a href="#cb25-602" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(y[x <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> z <span class="sc">==</span> <span class="dv">1</span>]) <span class="sc">*</span> <span class="fu">mean</span>(z <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">+</span> <span class="fu">mean</span>(y[x <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> z <span class="sc">==</span> <span class="dv">0</span>]) <span class="sc">*</span> <span class="fu">mean</span>(z <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb25-603"><a href="#cb25-603" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-604"><a href="#cb25-604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-605"><a href="#cb25-605" aria-hidden="true" tabindex="-1"></a>There are fancy algorithms that can determine the exact adjustment formula for a given DAG, and the **causaleffect** package lets you use these algorithms in R. Here’s the *do*-calculus version of our math camp example. Unfortunately we have to rewrite the DAG with a different syntax for it to work:</span>
<span id="cb25-606"><a href="#cb25-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-607"><a href="#cb25-607" aria-hidden="true" tabindex="-1"></a><span class="in">``` r</span></span>
<span id="cb25-608"><a href="#cb25-608" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(causaleffect)</span>
<span id="cb25-609"><a href="#cb25-609" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(igraph)</span>
<span id="cb25-610"><a href="#cb25-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-611"><a href="#cb25-611" aria-hidden="true" tabindex="-1"></a>math_dag <span class="ot">&lt;-</span> <span class="fu">graph.formula</span>(grade <span class="sc">+-</span> undergradGPA, </span>
<span id="cb25-612"><a href="#cb25-612" aria-hidden="true" tabindex="-1"></a>                          grade <span class="sc">+-</span> GREquant, </span>
<span id="cb25-613"><a href="#cb25-613" aria-hidden="true" tabindex="-1"></a>                          grade <span class="sc">+-</span> GREverbal,</span>
<span id="cb25-614"><a href="#cb25-614" aria-hidden="true" tabindex="-1"></a>                          grade <span class="sc">+-</span> mathcamp,</span>
<span id="cb25-615"><a href="#cb25-615" aria-hidden="true" tabindex="-1"></a>                          mathcamp <span class="sc">+-</span> GREquant,</span>
<span id="cb25-616"><a href="#cb25-616" aria-hidden="true" tabindex="-1"></a>                          mathcamp <span class="sc">+-</span> undergradGPA,</span>
<span id="cb25-617"><a href="#cb25-617" aria-hidden="true" tabindex="-1"></a>                          GREquant <span class="sc">+-</span> undergradGPA,</span>
<span id="cb25-618"><a href="#cb25-618" aria-hidden="true" tabindex="-1"></a>                          GREverbal <span class="sc">+-</span> undergradGPA,</span>
<span id="cb25-619"><a href="#cb25-619" aria-hidden="true" tabindex="-1"></a>                      <span class="at">simplify =</span> <span class="cn">FALSE</span>)</span>
<span id="cb25-620"><a href="#cb25-620" aria-hidden="true" tabindex="-1"></a><span class="co"># plot(math_dag)  # Plot this</span></span>
<span id="cb25-621"><a href="#cb25-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-622"><a href="#cb25-622" aria-hidden="true" tabindex="-1"></a><span class="co"># expr returns a LaTeX formula; simp simplifies the formula through repeated</span></span>
<span id="cb25-623"><a href="#cb25-623" aria-hidden="true" tabindex="-1"></a><span class="co"># application of the rules of do-calculus</span></span>
<span id="cb25-624"><a href="#cb25-624" aria-hidden="true" tabindex="-1"></a>do_calc_formula <span class="ot">&lt;-</span> <span class="fu">causal.effect</span>(<span class="at">y =</span> <span class="st">"grade"</span>, <span class="at">x =</span> <span class="st">"mathcamp"</span>,</span>
<span id="cb25-625"><a href="#cb25-625" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">G =</span> math_dag, <span class="at">expr =</span> <span class="cn">TRUE</span>, <span class="at">simp =</span> <span class="cn">TRUE</span>)</span>
<span id="cb25-626"><a href="#cb25-626" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-627"><a href="#cb25-627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-628"><a href="#cb25-628" aria-hidden="true" tabindex="-1"></a>This produces the following *do*-calculus-based adjustment formula:</span>
<span id="cb25-629"><a href="#cb25-629" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-630"><a href="#cb25-630" aria-hidden="true" tabindex="-1"></a>&lt;div style="font-size: 60%;"&gt;</span>
<span id="cb25-631"><a href="#cb25-631" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb25-632"><a href="#cb25-632" aria-hidden="true" tabindex="-1"></a>\sum_{GREquant,undergradGPA}P(grade|undergradGPA,GREquant,mathcamp)P(GREquant|undergradGPA)P(undergradGPA)</span>
<span id="cb25-633"><a href="#cb25-633" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb25-634"><a href="#cb25-634" aria-hidden="true" tabindex="-1"></a>&lt;/div&gt;</span>
<span id="cb25-635"><a href="#cb25-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-636"><a href="#cb25-636" aria-hidden="true" tabindex="-1"></a>Neat<span class="sc">\!</span> We still need to adjust for GRE quantitative scores and undergrad GPA, and if we somehow multiply the three probability distributions (final grade given GPA, GRE, and mathcamp, GRE given GPA, and GPA), we’ll have a $do(\cdot)$-free version of the causal effect.</span>
<span id="cb25-637"><a href="#cb25-637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-638"><a href="#cb25-638" aria-hidden="true" tabindex="-1"></a>**Unfortunately I have absolutely no idea how to do this with R.** Continuous variables blow up the math in *do*-calculus equations and I don't know how to deal with that.</span>
<span id="cb25-639"><a href="#cb25-639" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-640"><a href="#cb25-640" aria-hidden="true" tabindex="-1"></a><span class="fu">## Comparison of all methods</span></span>
<span id="cb25-641"><a href="#cb25-641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-642"><a href="#cb25-642" aria-hidden="true" tabindex="-1"></a>Phew. We just used naive matching, inverse probability weighting, and Mahalanobis matching to estimate the causal effect of a hypothetical math camp program on final grades using only observational data. How’d we do?<span class="sc">\!</span></span>
<span id="cb25-643"><a href="#cb25-643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-644"><a href="#cb25-644" aria-hidden="true" tabindex="-1"></a>Here are all the estimates we have, along with a blue dotted line for the truth. Adjusting for backdoor confounders allows us to get far more accurate and identified causal results than when we leave things unadjusted, and we get the most accurate results when we explicitly attempt to match treated and untreated observations (as with do with the IPW ATO and with Mahalanobis matching). That’s likely not always the case—lots of these methods depend on the relationships between the different nodes in the graph, and it’s possible that they don’t work when there are non-linear relationships.</span>
<span id="cb25-645"><a href="#cb25-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-646"><a href="#cb25-646" aria-hidden="true" tabindex="-1"></a>But in this case, at least, we can prove causation with observational data, which is really neat<span class="sc">\!</span></span>
<span id="cb25-647"><a href="#cb25-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-648"><a href="#cb25-648" aria-hidden="true" tabindex="-1"></a><span class="in">``` r</span></span>
<span id="cb25-649"><a href="#cb25-649" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggstance)</span>
<span id="cb25-650"><a href="#cb25-650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-651"><a href="#cb25-651" aria-hidden="true" tabindex="-1"></a>all_models <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb25-652"><a href="#cb25-652" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>method, <span class="sc">~</span>model,</span>
<span id="cb25-653"><a href="#cb25-653" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Wrong correlation-not-causation"</span>, model_wrong,</span>
<span id="cb25-654"><a href="#cb25-654" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Forbidden needs camp"</span>, model_adj_needs_camp,</span>
<span id="cb25-655"><a href="#cb25-655" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Educated guess needs camp"</span>, model_adj_needs_camp_guess,</span>
<span id="cb25-656"><a href="#cb25-656" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Inverse probability weighting ATE"</span>, model_ipw_ate,</span>
<span id="cb25-657"><a href="#cb25-657" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Inverse probability weighting ATO"</span>, model_ipw_ato,</span>
<span id="cb25-658"><a href="#cb25-658" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Mahalanobis matching"</span>, model_matched</span>
<span id="cb25-659"><a href="#cb25-659" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb25-660"><a href="#cb25-660" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract coefficient for math_camp from each model</span></span>
<span id="cb25-661"><a href="#cb25-661" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tidied =</span> <span class="fu">map</span>(model, <span class="sc">~</span><span class="fu">tidy</span>(., <span class="at">conf.int =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb25-662"><a href="#cb25-662" aria-hidden="true" tabindex="-1"></a>         <span class="at">effect =</span> <span class="fu">map</span>(tidied, <span class="sc">~</span><span class="fu">filter</span>(., term <span class="sc">==</span> <span class="st">"math_campTRUE"</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb25-663"><a href="#cb25-663" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(effect) <span class="sc">%&gt;%</span> </span>
<span id="cb25-664"><a href="#cb25-664" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>model, <span class="sc">-</span>tidied) <span class="sc">%&gt;%</span> </span>
<span id="cb25-665"><a href="#cb25-665" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">method =</span> <span class="fu">fct_inorder</span>(method))</span>
<span id="cb25-666"><a href="#cb25-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-667"><a href="#cb25-667" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(all_models, <span class="fu">aes</span>(<span class="at">x =</span> estimate, <span class="at">y =</span> <span class="fu">fct_rev</span>(method), <span class="at">color =</span> method)) <span class="sc">+</span></span>
<span id="cb25-668"><a href="#cb25-668" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">10</span>, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"#0074D9"</span>) <span class="sc">+</span></span>
<span id="cb25-669"><a href="#cb25-669" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_pointrangeh</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> conf.low, <span class="at">xmax =</span> conf.high), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb25-670"><a href="#cb25-670" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>(<span class="at">option =</span> <span class="st">"plasma"</span>, <span class="at">end =</span> <span class="fl">0.9</span>, <span class="at">guide =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb25-671"><a href="#cb25-671" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Causal effect"</span>, <span class="at">y =</span> <span class="cn">NULL</span>, <span class="at">caption =</span> <span class="st">"Dotted line shows true effect"</span>) <span class="sc">+</span></span>
<span id="cb25-672"><a href="#cb25-672" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_light</span>()</span>
<span id="cb25-673"><a href="#cb25-673" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-674"><a href="#cb25-674" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-675"><a href="#cb25-675" aria-hidden="true" tabindex="-1"></a><span class="al">![Comparison of all causal effects](compare-everything-1.png)</span></span></code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p><span class="faux-block"><i class="fa-brands fa-creative-commons" aria-label="creative-commons"></i> 2007–2024 Andrew Heiss</span> <span class="faux-block">All content licensed under<br><a href="https://creativecommons.org/licenses/by/4.0/"><i class="fa-brands fa-creative-commons" aria-label="creative-commons"></i> <i class="fa-brands fa-creative-commons-by" aria-label="creative-commons-by"></i> Creative Commons CC BY 4.0</a></span></p>
</div>   
    <div class="nav-footer-center">
<p><span class="faux-block"><i class="fa-brands fa-orcid" aria-label="orcid"></i> <strong>ORCID</strong> <a href="https://orcid.org/0000-0002-3948-3914">0000-0002-3948-3914</a></span> <span class="faux-block"><i class="fa-solid fa-key" aria-label="key"></i> <a href="../../../../../pgp_ath.asc.txt">PGP public key</a>   <i class="fa-solid fa-fingerprint" aria-label="fingerprint"></i> Fingerprint:<br><span class="fingerprint">4AA2 FA83 A8B2 05A4 E30F<br> 610D 1382 6216 9178 36AB</span></span></p>
</div>
    <div class="nav-footer-right">
<p><span class="faux-block">Made with <i class="fa-brands fa-r-project" aria-label="r-project"></i> and <a href="https://quarto.org/">Quarto</a></span> <span class="faux-block"><a href="https://github.com/andrewheiss/ath-quarto">View the source at <i class="fa-brands fa-github" aria-label="github"></i> GitHub</a></span></p>
</div>
  </div>
</footer>




</body></html>